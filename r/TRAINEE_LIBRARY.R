# ==================================================================================================
# TRAINEE_LIBRARY.R 2024-10-21 14:27
# ==================================================================================================

# ==================================================================================================
DBL_DOWNLOAD_YAH_OHLC_INTRADAY_MAX = function(pCodesource="^VIX", pInterval="5m", pNbdays = 60, ToKable=T, Hour_adjust = 0) {
  # ------------------------------------------------------------------------------------------------
  # pCodesource="^GSPC"; pInterval="5m"; ToKable=T; Hour_adjust = -4
  MyURL       = paste0("https://query1.finance.yahoo.com/v8/finance/chart/", pCodesource, "?region=US&lang=en-US&includePrePost=false&interval=", 
                       pInterval, "&range=",pNbdays,"d&corsDomain=finance.yahoo.com&.tsrc=finance")
  rm(dt_json)
  x.combined  = data.table()
  dt_json  = jsonlite::fromJSON(MyURL)
  
  if (exists("dt_json"))
  {
    x = as.data.table(dt_json[[1]]$result$meta)
    hour_adjust = dt_json[[1]]$result$meta$gmtoffset/3600
    if (nchar (hour_adjust > 0)) {
      Hour_adjust = hour_adjust
    }
    # str(x)
    rCodesource = x[1]$symbol
    DATACENTER_LINE_BORDER(rCodesource)
    xtr = data.table(field = names(x), t(x))
    # My.Kable(xtr, Nb=nrow(xtr), HeadOnly = T)
    
    x = as.data.table(dt_json[[1]]$result$meta)
    
    x.timestamp  = as.data.table(dt_json[[1]]$result$timestamp)
    x.timestamp[, ID:=seq.int(1, nrow(x.timestamp))]
    
    if ("V1" %in% colnames(x.timestamp)) {setnames(x.timestamp, "V1", "timestamp")}
    
    x.quote      = dt_json[[1]]$result$indicators$quote
    # x.quote[[1]]$open
    
    x.open       = as.data.table(x.quote[[1]]$open)
    if (nrow(x.open)>2)
    {
      x.open[, ID:=seq.int(1, nrow(x.open))]
      setnames(x.open, "V1", "open")
      
      x.high       = as.data.table(x.quote[[1]]$high)
      x.high[, ID:=seq.int(1, nrow(x.high))]
      setnames(x.high, "V1", "high")
      
      x.low       = as.data.table(x.quote[[1]]$low)
      x.low[, ID:=seq.int(1, nrow(x.low))]
      setnames(x.low, "V1", "low")
      
      x.close       = as.data.table(x.quote[[1]]$close)
      x.close[, ID:=seq.int(1, nrow(x.close))]
      setnames(x.close, "V1", "close")
      
      x.closeadj  = as.data.table(unlist(dt_json[[1]]$result$indicators$adjclose))
      x.closeadj[, ID:=seq.int(1, nrow(x.closeadj))]
      if ("V1" %in% names(x.closeadj))
      {
        setnames(x.closeadj, "V1", "close_adj")
      }else{
        x.closeadj[, close_adj:=as.numeric(NA)]
      }
      
      x.volume       = as.data.table(x.quote[[1]]$volume)
      x.volume[, ID:=seq.int(1, nrow(x.volume))]
      setnames(x.volume, "V1", "volume")
      
      # x.merge     = merge(x.timestamp, x.close, by="ID")
      # My.Kable(x.merge)
      
      x.combined = cbind(x.timestamp, x.open[, .(open)],  x.high[, .(high)],  x.low[, .(low)], x.close[, .(close)], x.closeadj[, .(close_adj)], x.volume[, .(volume)])
      # My.Kable(x.combined)
      x.combined[, datetime:=as.POSIXct(as.numeric(as.character(timestamp)),origin="1970-01-01",tz="GMT")]
      x.combined <- x.combined %>%   select("datetime", everything())
      x.combined[, codesource:=rCodesource]
      x.combined[, source:="YAH"]
      x.combined <- x.combined %>%   select("codesource", everything())
      
      DBL_RELOAD_INSREF ()
      insyah_ref = ins_ref[!is.na(yah)]
      x.combined = transform(x.combined, code=insyah_ref$code[match(codesource, insyah_ref$yah)])
      # x.combined = DBL_UPDATE_TRANSFORM(x.combined, "YAH")
      x.combined = DBL_MERGE_DATASRC_CODE_BYCODESOURCE (pSource='YAH', x.combined)
      x.combined[, date:=as.Date(datetime)]
      x.combined = x.combined[, -c("timestamp", "ID")]
      x.combined = DBL_MERGE_DATASTD_BYCODE(x.combined, 'ADVANCED')[!is.na(close)]
      # x.combined[, ':='(timestamp=as.character(datetime), datetime=as.character(datetime))]
      x.combined[, timestamp_loc := datetime + Hour_adjust*60*60]
      x.combined[, timestamp_vn := datetime + 7*60*60]
      x.combined[, datetime := timestamp_loc]
      x.combined[, timestamp := timestamp_loc]
      x.combined[, date:=as.Date(datetime)]
      x.combined[, timestamp_loc := NULL]
      if (pInterval=="1d") { x.combined = unique(x.combined[order(timestamp)], by = "date") }
      if (ToKable) { My.Kable.MaxCols(x.combined)}
    }
  }
  return(x.combined)
}

# ==================================================================================================
DBL_INTEGRATION_INDEX = function(pData = data.table(),
                                 Folder_Fr = '', File_Fr = '',
                                 Folder_To, File_To,
                                 IncludedOnly = F, pSleep = 5,
                                 Fields_Index_Std = c('provider', 'monitor', 'category', 'coverage', 'prtr', 'wgtg', 'cur', 'country', 'continent',
                                                      'name', 'short_name', 'code_mother',
                                                      'factor', 'type', 'fcat', 'scat', 'code', 'code_und', 'ticker', 'symbol', 'date', 
                                                      'timestamp', 'timestamp_loc', 'timestamp_vn',
                                                      'close', 'close_adj', 'rt', 'lnrt', 'change', 'var', 'varpc', 'updated'))
{
  # pData = data.table() ; Folder_To = UData; File_To = 'download_ifrc_ind_history.rds' ; Folder_Fr = 'S:/STKVN/INDEX_2024/'; File_Fr = 'dbl_indfeargreed_history.rds'
  if (nrow(pData)==0)
  {
    if (nchar(Folder_Fr) * nchar(File_Fr) > 0)
    {
      pData = DBL_CCPR_READRDS(Folder_Fr, File_Fr, ToKable = T, ToRestore = T)
      if (nrow(pData)>0) { pData = pData[nchar(as.character(date))==10] ;  pData[, date:=as.Date(date)]}
    }
  }
  
  if (nrow(pData)> 0)
  {
    pData = pData[nchar(as.character(date))==10] ;  pData[, date:=as.Date(date)]
    if (nchar(Folder_To) * nchar(File_To) > 0)
    {
      Data_Old = DBL_CCPR_READRDS(Folder_To, File_To, ToKable = T, ToRestore = T)
      if (nrow(Data_Old)>0) { Data_Old = Data_Old[nchar(as.character(date))==10] ;  Data_Old[, date:=as.Date(date)]}
      My.Kable.Index(Data_Old[order(date)])
      Data_Old = Data_Old[!is.na(date) & !is.na(close) & !is.na(code)]
      Data_Old = Data_Old[!is.na(date) & nchar(as.character(date))==10]
      if (IncludedOnly & nrow(pData)>0)
      {
        pData = pData[code %in% Data_Old$code]
      }
      Data_Old = rbind(Data_Old, pData, fill=T)
      Data_Old = unique(Data_Old, by=c('code', 'date'), fromLast = T)
      
      Fields_Common = intersect(names(Data_Old), Fields_Index_Std)
      Final_Data = Data_Old[, ..Fields_Common]
      Final_Data = UPDATE_UPDATED(Final_Data)
      Final_Data[, date:=as.Date(date)]
      Final_Data = Final_Data[!is.na(date) & nchar(as.character(date))==10]
      Final_Data = Final_Data[(!is.na(date) & !is.na(close) & !is.na(code))]
      Final_Data = DBL_IND_CALCULATE_RT_VAR_CHANGE(Final_Data)
      
      Final_Data[, type:=substr(code,1,3)]
      Final_Data = Final_Data[type=='IND']
      if (all(c('name', 'short_name') %in% names(Final_Data)))
      {
        Final_Data[is.na(name) & !is.na(short_name), name:=short_name]
      }
      My.Kable.Index(Final_Data)
      My.Kable.Index(Final_Data[order(date)])
      # str(Final_Data)
      # min(Final_Data$date)
      
      DBL_CCPR_SAVERDS(Final_Data, Folder_To, File_To, ToSummary = T, SaveOneDrive = T)
      IFRC_SLEEP(pSleep)
    }
  }
}

# ===================================================================================================
CCPR_RESTORERDS = function(Folder_Fr, File_Fr, Folder_To, File_To, From = 'ONEDRIVE', ToCalculateChange = F, pSleep = 5) {
  # ------------------------------------------------------------------------------------------------
  # Folder_To   = UData
  # File_To     = 'download_ifrc_ind_history.rds'
  # switch (object,
  #   case = action
  # )
  switch(From,
         'ONEDRIVE' = {
           Folder_Fr   = paste0(ODDrive, gsub('[:]', '', Folder_To))
           File_Fr     = File_To
         },
         {
           Folder_Fr   = paste0(ODDrive, gsub('[:]', '', Folder_To))
           File_Fr     = File_To
         }
  )
  File_Full   = paste0(Folder_Fr, File_Fr)
  CATln_Border(File_Full)
  
  if (file.exists(File_Full))
  {
    x = CHECK_CLASS(try(DBL_CCPR_READRDS(Folder_Fr, File_Fr)))
    if (nrow(x)>0)
    {
      x = UPDATE_UPDATED(x)[!is.na(code) & !is.na(date)]
      if (ToCalculateChange)
      {
        x = CALCULATE_CHANGE_RT_VARPC(x)[!is.na(change)]
      }
      My.Kable.Index(x[order(date, code)])
      if (nrow(x)>0)
      {
        try(DBL_CCPR_SAVERDS(x, Folder_To, File_To, ToSummary = T, SaveOneDrive = T))
      }
    }
  }
  IFRC_SLEEP(pSleep)
}


# ==================================================================================================
DOWNLOAD_TDV_SNAPSHOT = function ( pCode = '') {
  # ------------------------------------------------------------------------------------------------
  
  pURL = paste0('https://www.tradingview.com/symbols/', pCode,'/')
  x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp = paste0('c:/temp/','tdv_index.txt') , ToDeleteTemp = F)
  # x = fread (paste0('c:/temp/','_index.txt') )
  if (grepl('data-symbol', x[1])) { y = str.extract(x[1], '<div class="tv-react-category-header">', '<div class="tv-react-category-header__tabs">') }
  
  if (nchar (y) >0)
  {
    if (grepl('data-symbol', y)) { symbol = gsub ('\\','',str.extract(y, 'data-symbol=\"', '\" data-symbol-type'), fixed = T) }
    if (grepl('data-symbol-type', y)) { type = gsub ('\\','',str.extract(y, 'data-symbol-type=\"', '\"><div'), fixed = T) }
    if (grepl('item-JLr4OyLc', y)) { codesource = gsub ('\\','',str.extract(y, '<span class="item-JLr4OyLc">', '</span>'), fixed = T) }
    if (grepl('symbol-last', y)) { last = gsub ('\\','',str.extract(y, 'js-symbol-last\"><span>', '</span>'), fixed = T) }
    if (grepl('js-symbol-change', y))
    {
      change = gsub ('\\','',str.extract(y, 'js-symbol-change-direction', '</span>'), fixed = T)
      change = unlist(str_split(change, "<span>")) [2]
      change = gsub ('−', '-', change)
      
    }
    if (grepl('js-symbol-currency', y))
    {
      cur = gsub ('\\','',str.extract(y, 'js-symbol-currency', '</span>'), fixed = T)
      cur = unlist(str_split(cur, ">")) [2]
      
      
    }
    if (grepl('js-symbol-change-pt', y)) { 
      varpc = gsub ('%','',str.extract(y, '"js-symbol-change-pt\">', '</span>'), fixed = T)
      varpc = gsub ('−', '-', varpc)
    }
    if (grepl('js-symbol-lp-time', y)) { datetime = gsub ('\\','',str.extract(y, '<span class="js-symbol-lp-time">', '</span>'), fixed = T) }
    date = as.Date(NA)
    if (grepl ('today', datetime)) {date = Sys.Date()}
    if (grepl ('yesterday', datetime)) {date = Sys.Date() - 1}
    if (grepl ('At close', datetime)) {date = Sys.Date()}
    if (grepl ('Last update', datetime)) {date = Sys.Date()}
    if (grepl('event-time', y)) { datetime = gsub ('\\','',str.extract(y, '<span class="js-symbol-lp-time">', '</span>'), fixed = T) }
    
    xData = data.table (source = 'TDV', type, symbol,  codesource,cur, date, hhmm = str_sub(datetime, -11,-6)  ,
                        last = as.numeric (gsub(',','',last)), change = as.numeric(gsub(',','',change)), varpc = as.numeric (varpc), tz = str_sub(datetime, -5,-1)  )
  }
  
  
  My.Kable(xData)
  return (xData)
}

# ==================================================================================================
FINAL_DOWNLOAD_INV_BY_CODESOURCE_BY_HTML = function(Folder_File = "S:/DOWNLOADS/", File_name = "FTSE_ASEAN.html", pCodesource = "indices/nikkei-volatility" ) {
  # max = 5000
  content    = try(rvest::read_html(paste0(Folder_File, File_name)))
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    xData      = TRAINEE_SELECT_TABLE_WITH_FIELD(tables=tables, pField='price', pContent = '', like = F)
    if (nrow(xData)>0)
    {
      # xData      = as.data.table(tables[[2]])
      # xData      = CLEAN_COLNAMES(xData)
      # My.Kable.TB(xData)
      Final_Data = xData[, .(source='INV', codesource=pCodesource, date=as.Date(date, "%B %d, %Y"), 
                             open  = as.numeric(gsub(',','',open)), 
                             high  = as.numeric(gsub(',','',high)), 
                             low   = as.numeric(gsub(',','',low)), 
                             close  = as.numeric(gsub(',','',price)), 
                             varpc=as.numeric(gsub('%','',changepercent_)))]
      Final_Data = MERGE_DATASRC_CODE_BYCODESOURCE('INV', Final_Data)
      Final_Data = MERGE_DATASTD_BYCODE(Final_Data, ToKable = F)
      Final_Data = Final_Data[order(date)]
      Final_Data[, rt:=(close/shift(close))-1]
      Final_Data$capiusd = NULL
      My.Kable.TB(Final_Data)
    }
  }
  return(Final_Data)
}

#===================================================================================================
DBL_INSREF_UPDATE_FROM_DUO_XLSX = function (Option = "CNBC") {
  # ------------------------------------------------------------------------------------------------
  switch(
    Option,
    "CNBC" = {
      ins_ref    = CHECK_CLASS(try(CCPR_READRDS_INSREF  ( Folder_INSREF = UData, File_INSREF ='EFRC_INS_REF.rds', Nb_repeat = 3, 
                                                          ToRestore = F, ToSave = T,  pSleep = 10)))
      
      list_codes = setDT(read.xlsx(paste0(ODDrive,"/DBL/RD_BATCH_MANAGEMENT.xlsx"), sheet = 'DUO'))
      # sort(names(list_codes))
      
      list_codes = list_codes[!is.na(CNBC_PRODUCT)][,.(PRODUCT,PRODUCT_NAME,CNBC_PRODUCT)]
      My.Kable(list_codes)
      miss = list()
      for (k in 1:nrow(list_codes))
      {
        #k=2
        miss_listk = list(c(list_codes[k]$CNBC_PRODUCT,list_codes[k]$PRODUCT))
        miss = union(miss,miss_listk)
      }
      
      for ( k in 1:length(miss))
      {
        #k = 1
        My.Kable.INSREF(ins_ref[code == miss[[k]][2]])
        ins_ref[code == miss[[k]][2],cnbc:= miss[[k]][1]]
        My.Kable.INSREF(ins_ref[code == miss[[k]][2]])
      }
      My.Kable.INSREF(ins_ref[!is.na(cnbc)])
      DBL_CCPR_SAVERDS(ins_ref,UData,"EFRC_INS_REF.rds",ToSummary = T, SaveOneDrive = T)
      DBL_CCPR_SAVERDS(ins_ref,SData,"DBL_INS_REF.rds",ToSummary = T, SaveOneDrive = T)
      
      DBL_RELOAD_INSREF(ToForce = T)
      My.Kable.INSREF(ins_ref[!is.na(cnbc)])
    },
    "CBOE" = {
      ins_ref    = CHECK_CLASS(try(CCPR_READRDS_INSREF  ( Folder_INSREF = UData, File_INSREF ='EFRC_INS_REF.rds', Nb_repeat = 3, 
                                                          ToRestore = F, ToSave = T,  pSleep = 10)))
      list_codes = setDT(read.xlsx(paste0(ODDrive,"/DBL/RD_BATCH_MANAGEMENT.xlsx"), sheet = 'DUO'))
      # sort(names(list_codes))
      
      list_codes1 = list_codes[!is.na(CBOE_PRODUCT)][,.(PRODUCT,PRODUCT_NAME,CBOE_PRODUCT)]
      list_codes2 = list_codes[!is.na(CBOE_DUO)][,.(DUO,DUO_NAME,CBOE_DUO)]
      
      list_codes12 = rbind(list_codes1[,.(code=PRODUCT,name = PRODUCT_NAME, cboe = trimws(CBOE_PRODUCT))],
                           list_codes2[,.(code=DUO,name = DUO_NAME, cboe = trimws(CBOE_DUO))])
      list_codes12 = unique(list_codes12[!is.na(cboe) & nchar(trimws(cboe)) > 0 & !is.na(code) & nchar(trimws(code)) > 0], by = "cboe")
      list_codes = list_codes12[nchar(trimws(cboe)) > 0 & nchar(trimws(code)) > 3 ]
      My.Kable.All(list_codes)
      miss = list()
      for (k in 1:nrow(list_codes))
      {
        #k=1
        miss_listk = list(c(list_codes[k]$cboe,list_codes[k]$code))
        miss = union(miss,miss_listk)
      }
      
      for ( k in 1:length(miss))
      {
        #k = 1
        My.Kable.INSREF(ins_ref[code == miss[[k]][2]])
        ins_ref[code == miss[[k]][2],cboe:= miss[[k]][1]]
        My.Kable.INSREF(ins_ref[code == miss[[k]][2]])
      }
      My.Kable.All(ins_ref[!is.na(cboe)][,.(code,name,cboe)])
      DBL_CCPR_SAVERDS(ins_ref,UData,"EFRC_INS_REF.rds",ToSummary = T, SaveOneDrive = T)
      DBL_CCPR_SAVERDS(ins_ref,SData,"DBL_INS_REF.rds",ToSummary = T, SaveOneDrive = T)
      
      DBL_RELOAD_INSREF(ToForce = T)
      My.Kable.INSREF(ins_ref[!is.na(cboe)])
    }
  )
  
}
# ==================================================================================================
DBL_SAVE_INSREF = function(ins_ref, ToReload=T) {
  # ------------------------------------------------------------------------------------------------
  Start.time = Sys.time()
  try(DBL_CCPR_SAVERDS(ins_ref, UData, 'EFRC_INS_REF.rds', ToSummary = T, SaveOneDrive = T, Nb_repeat = 3))
  try(DBL_CCPR_SAVERDS(ins_ref, SData, 'DBL_INS_REF.rds', ToSummary = T, SaveOneDrive = T, Nb_repeat = 5))
  if (ToReload)
  {
    DBL_RELOAD_INSREF(ToForce = T)
  }
  DBL_DURATION(Start.time)
}

# ==================================================================================================
DBL_REPAIR_INSREF = function(Option='SIMPLE', EveryHours = 12, ToSave = T) {
  # ------------------------------------------------------------------------------------------------
  # DBL_REPAIR_INSREF(Option='SIMPLE', EveryHours = 0, ToSave = T)
  Start.time = Sys.time()
  Modified   = F
  ins_ref    = CHECK_CLASS(try(CCPR_READRDS_INSREF  ( Folder_INSREF = UData, File_INSREF ='EFRC_INS_REF.rds', Nb_repeat = 3, 
                                                      ToRestore = F, ToSave = T,  pSleep = 10)))
  sort(names(ins_ref))
  
  switch(Option,
         
         'SIMPLE' = {
           TO_DO = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste('DBL_REPAIR_INSREF >', Option), pAction="COMPARE", NbSeconds=EveryHours*60*60, ToPrint=T)
           if (TO_DO)
           {
             Modified = T
             
             # My.Kable.INSREF(ins_ref[yah=='GC=F'])
             # My.Kable.INSREF(ins_ref[yah=='CL=F'])
             # My.Kable.INSREF(ins_ref[yah=='BTC-USD'])
             # My.Kable.INSREF(ins_ref[yah=='ETH-USD'])
             # My.Kable.INSREF(ins_ref[rts=='.DJI'])
             # My.Kable.INSREF(ins_ref[rts=='.VXD'])
             
             # My.Kable.INSREF(ins_ref[type=="FUT" & grepl("VIX", name)])
             # My.Kable.INSREF(ins_ref[type=="FUT" & grepl("500", name)] , pNb=20)
             # My.Kable.INSREF(ins_ref[code=='FUTSTKSPC1'])
             
             # My.Kable.INSREF(ins_ref[as.Date(updated)==Sys.Date()])
             
             if (!'cnbc' %in% names(ins_ref)) { ins_ref[, cnbc:=as.character(NA)] }
             if (!'tradingview' %in% names(ins_ref)) { ins_ref[, tradingview:=as.character(NA)] }
             if (!'cboe' %in% names(ins_ref)) { ins_ref[, cboe:=as.character(NA)] }
             
             ins_ref[code=='CMDGOLD',    ':='(cnbc='@GC.1', updated=SYS.TIME())]
             ins_ref[code=='FUTCMDCLC1', ':='(cnbc='@CL.1', updated=SYS.TIME())]
             ins_ref[code=='CURBTCUSD',  ':='(cnbc='BTC=', updated=SYS.TIME())]
             ins_ref[code=='CURCRYETH',  ':='(cnbc='ETH=', updated=SYS.TIME())]
             
             ins_ref[code=='FUTVXC1',  ':='(cnbc='@VX.1', updated=SYS.TIME())]
             ins_ref[code=='FUTSTKSPC1',  ':='(cnbc='@SP.1', updated=SYS.TIME())]
             
             ins_ref[code=='INDDJI', ':='(cnbc='.DJI', updated=SYS.TIME())]
             ins_ref[code=='INDVXD', ':='(cnbc='.VXD', updated=SYS.TIME())]
             ins_ref[code=='INDVIX', ':='(cnbc='.VIX', updated=SYS.TIME())]
             ins_ref[code=='INDSPX', ':='(cnbc='.SPX', updated=SYS.TIME())]
             ins_ref[code=='INDNDX', ':='(cnbc='.NDX', updated=SYS.TIME())]
             ins_ref[type=='STK' & iso2=='VN' & is.na(yah) & nchar(code)==8, ':='(yah=gsub('STKVN','', code), updated=SYS.TIME())]
             My.Kable.INSREF(ins_ref[order(-updated)][!is.na(cboe)])
             My.Kable.INSREF(ins_ref[order(-updated)])
           }
         },
         
         'ADD' = {
           
         },
         
         'MODIFY' = {
           
         },
         
         'ALL' = {
           try(DBL_REPAIR_INSREF(Option='SIMPLE', EveryHours = 12, ToSave = F))
           TO_DO = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste('DBL_REPAIR_INSREF >', 'SIMPLE'), pAction="COMPARE", NbSeconds=EveryHours*60*60, ToPrint=T)
           
           try(DBL_REPAIR_INSREF(Option='ADD', EveryHours = 12, ToSave = F))
           try(DBL_REPAIR_INSREF(Option='MODIFY', EveryHours = 12, ToSave = F))
           
           ToSave = T
         })
  
  if (ToSave & Modified)
  {
    try(DBL_SAVE_INSREF(ins_ref=ins_ref, ToReload=T))
    TO_DO = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste('DBL_REPAIR_INSREF >', Option), pAction="SAVE", NbSeconds=EveryHours*60*60, ToPrint=T)
  }
  DBL_DURATION(Start.time)
}

# ==================================================================================================
DBL_INSREF_MODIFICATION = function() {
  INSREF_LIST = CHECK_CLASS(try(setDT(fread("S:/CCPR/DATA/LIST/LIST_INSREF_MODIFICATION.txt"))))
  My.Kable.All(INSREF_LIST)
  Modified    = F
  if (nrow(INSREF_LIST)>0)
  {
    INSREF_LIST = INSREF_LIST[active==1]
  }
  
  if (nrow(INSREF_LIST)>0)
  {
    # DBL_RELOAD_INSREF(ToForce = T)
    ins_ref    = CHECK_CLASS(try(CCPR_READRDS_INSREF  ( Folder_INSREF = UData, File_INSREF ='EFRC_INS_REF.rds', Nb_repeat = 3, 
                                                        ToRestore = F, ToSave = T,  pSleep = 10)))
    
    My.Kable.INSREF(ins_ref[order(-updated)])
    for (k in 1:nrow(INSREF_LIST))
    {
      #k = 3
      INSREF_LIST1 = INSREF_LIST[k]
      My.Kable.All(INSREF_LIST1)
      pCondition   = paste0(INSREF_LIST1$field,' :="',INSREF_LIST1$value,'"')
      pFilter      = paste0('code =="',INSREF_LIST1$code,'"')
      CATln_Border(paste('FILTER    = ', pFilter))
      CATln_Border(paste('CONDITION = ', pCondition))
      
      ins_ref1 = ins_ref[eval(parse(text = pFilter))]
      My.Kable.INSREF(ins_ref1)
      ins_ref1[eval(parse(text = pFilter)),eval(parse(text = pCondition))]
      if (nrow(ins_ref1)>0)
      {
        Modified = T
        ins_ref1[, updated:=SYS.TIME()]
        ins_ref1[, date:=Sys.Date()]
        ins_ref = rbind(ins_ref[!code %in% ins_ref1$code],ins_ref1,fill = T)
      }
    }
    
    if (Modified)
    {
      My.Kable.INSREF(ins_ref[date==Sys.Date()])
      DBL_SAVE_INSREF(ins_ref, ToReload=T)
      #   
      # DBL_CCPR_SAVERDS(ins_ref, SData, 'DBL_INS_REF.rds', ToSummary = T, SaveOneDrive = T)
      # DBL_RELOAD_INSREF(ToForce = T)
      My.Kable.INSREF(ins_ref[date==Sys.Date()])
    }
  }
}

# ==================================================================================================
DOWNLOAD_CBOE_YAH_INTRADAY = function(pCode = "VIX", CODE = 'INDVIX',yCode = '^VIX') {
  # ------------------------------------------------------------------------------------------------
  # pCode = "A"; CODE = 'B'; yCode = 'C'
  # pCode = "VXN"; CODE = 'INDVXN'; yCode = '^VXN'
  # pCode = "VXN"; CODE = 'INDVXN'; yCode = '^GSPC'
  # yCode = '^VIX'
  # pCode = "VIX"
  # CODE = 'INDVIX'
  # pCode = 'VX_U4'
  Start.time = Sys.time()
  final_data_last = data.table()
  final_data      = data.table()
  
  pURL = paste0('https://www.cboe.com/indices/data/?symbol=', pCode, '&timeline=intraday')
  datetime = gsub('-| |:|\\.', '',as.character(Sys.time()))
  x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp = paste0('c:/temp/',datetime, '.txt') , ToDeleteTemp = T)
  if (grepl('<pre>', x[1])) { x = str.extract(x[1], '<pre>', '</pre>') }
  data = jsonlite::fromJSON(x)
  xData      = try(as.data.table(data))
  
  if (all(class(xData) !='try-error') & nrow(xData) > 0)
  {
    
    My.Kable(xData)
    xData = xData %>%
      separate(data.V1, into = c("date", "timestamp"), sep = "T")
    xData = as.data.table(xData)
    xData [, date := as.Date(date)]
    xData [, timestamp := as.POSIXct(paste0(date, ' ', timestamp))]
    xData [, timestamp := as.POSIXct(timestamp) - 5*3600 ]
    xData [, timestamp_vn := as.POSIXct(timestamp) + (12*3600)]
    xData [order(-timestamp)]
    min(xData$data.V4)
    setnames(xData, old = c('data.V2','data.V3', 'data.V4', 'data.V5'), new = c('open', 'high', 'low', 'close'))
    xData[, code := CODE]
    xData[, source := 'CBOE']
    xData[, datetime := timestamp]
    xData = xData[order(timestamp_vn)]
    xData = MERGE_DATASTD_BYCODE(xData)
    xData = UPDATE_UPDATED(xData)
    xData = CLEAN_TIMESTAMP(xData)
    My.Kable(xData)
    
    # index_cboe_date = paste0('https://www.cboe.com/indices/data/?symbol=', pCode, '&timeline=intraday')
    # index_cboe_date = jsonlite::fromJSON(index_cboe_date)
    # 
    # index_cboe_date = as.data.table(index_cboe_date)
    # index_cboe_date = unique(index_cboe_date[, date := as.Date(data.V1)], by = 'date')
    # index_cboe_date[, pDate := shift(date)]
    # index_cboe_date = index_cboe_date[!is.na(pDate)][,.(date, pDate)]
    
    index_cboe_day = CHECK_CLASS(try(DOWNLOAD_CBOE_VIX_DAY_BY_CODE(pCode , CODE)))
    
    
    index_yah_data = CHECK_CLASS(try(DBL_DOWNLOAD_YAH_OHLC_INTRADAY( pCodesource = yCode, pInterval = '1d', Hour_adjust = -5)))
    index_yah_date = index_yah_data[,.(date)]
    index_yah_date = rbind(index_yah_date, index_cboe_day[!date %in% index_yah_date$date][, .(date)])
    index_yah_date = index_yah_date[order(date)]
    index_yah_date[, pdate := shift(date)]
    index_yah_date = index_yah_date[!is.na(pdate)]
    xData = merge(xData[, -c('pdate')], index_yah_date, by = 'date', all.x = T)
    
    
    index_cboe_day = CHECK_CLASS(try(DOWNLOAD_CBOE_VIX_DAY_BY_CODE(pCode , CODE)))
    My.Kable(index_cboe_day)
    index_cboe_day = index_cboe_day[order(date)]
    
    
    index_cboe_day[, pclose := shift(close)]
    index_cboe_day[, varpc := 100*((close/shift(close))-1)]
    My.Kable(index_cboe_day[, .(code, date, close,pclose, varpc)])
    
    xData = merge(xData[, -c('pclose')], index_cboe_day[, .(pdate = date, pclose = close)], all.x = T, by = "pdate")
    
    final_data = xData[, .(code, name, date, timestamp, timestamp_vn, open = as.numeric(open), high = as.numeric(high),
                           low = as.numeric(low), close = as.numeric(close), pclose = as.numeric(pclose))]
    final_data[, varpc := 100*((close/pclose)-1)]
    final_data[, change := (close-pclose)]
    final_data = UPDATE_UPDATED(final_data)
    My.Kable(final_data)
    final_data_last = unique(final_data[order(date, -timestamp)], by='code')
    My.Kable.Index(final_data_last)
  }
  DBL_DURATION(Start.time)
  return (list(final_data, final_data_last ))
}
# ==================================================================================================
REPORT_FILES_INTRADAY_UPDATED = function() {
  # ----------------------------------------------------------------------------
  OD_XLSX = setDT(openxlsx::read.xlsx(paste0(ODDrive, 'DBL/', 'RD_BATCH_MANAGEMENT.xlsx'), sheet='FILES_LABEL'))
  OD_XLSX = OD_XLSX[!is.na(FOLDER) & !is.na(NAME) & !is.na(LABEL)]
  My.Kable.All(OD_XLSX)
  
  xList = list()
  for (k in 1:min(200,nrow(OD_XLSX)))
  {
    #k      = 2
    File1       = OD_XLSX[k]$NAME
    Save_Folder = OD_XLSX[k]$FOLDER
    Column1     = OD_XLSX[k]$LABEL
    Data1   = CHECK_CLASS(try(DBL_CCPR_READRDS(Save_Folder, File1)))
    if (nrow(Data1)>0)
    {
      Data1 = CLEAN_TIMESTAMP(Data1)
      My.Kable.Min(Data1)
      if (all(c('timestamp', 'name') %in% names(Data1)))
      {
        Summary = Data1[,.(folder=Save_Folder, filename = File1,column = Column1, name=name[1], start=timestamp[1], end = timestamp[.N], records = .N), by='code']
        My.Kable.All(Summary[!is.na(code)][order(end)])
        REPORT = Summary[!is.na(code),.(code,column,end)]
        xList[[k]] = REPORT
      }
    }
  }
  ALL_REPORT = rbindlist(xList,fill = T)
  My.Kable(ALL_REPORT)
  FINAL_REPORT = setDT(spread(ALL_REPORT,key = "column",value = "end"))
  FINAL_REPORT = merge(FINAL_REPORT[,-c("name")],ins_ref[,.(code,name)], by = c("code"),all.x = T)
  FINAL_REPORT = FINAL_REPORT %>% dplyr::select('name', everything())
  My.Kable(FINAL_REPORT)
  MAXDATE = as.Date("1900-01-01")
  
  for (k in 3:ncol(FINAL_REPORT))
  {
    # k = 3
    colname   = names(FINAL_REPORT)[k]
    x1        = FINAL_REPORT[,..colname]
    names(x1) = "date"
    maxdate   = max(as.Date(x1$date),na.rm = T)
    if(maxdate > MAXDATE)
    {
      MAXDATE = maxdate
    }
  }
  MAXTIME = as_datetime("1900-01-01 00:00:00")
  for (k in 3:ncol(FINAL_REPORT))
  {
    # k = 3
    colname   = names(FINAL_REPORT)[k]
    x1        = FINAL_REPORT[,..colname]
    names(x1) = "time"
    maxtime   = max(x1$time,na.rm = T)
    if(maxtime > MAXTIME)
    {
      MAXTIME = maxtime
    }
  }
  FINAL_REPORT[, ":="(date = MAXDATE, datetime = MAXTIME)]
  FINAL_REPORT = FINAL_REPORT %>% dplyr::select('name','code','date','datetime', everything())
  
  
  FINAL_REPORT[, (5:ncol(FINAL_REPORT)) := lapply(.SD, trimws), .SDcols = (5:ncol(FINAL_REPORT))]
  FINAL_REPORT[, (5:ncol(FINAL_REPORT)) := lapply(.SD, gsub, pattern = date, replacement = ""), .SDcols = (5:ncol(FINAL_REPORT))]
  
  FINAL_REPORT[, (5:ncol(FINAL_REPORT)) := lapply(.SD, function(x) ifelse(nchar(trimws(x)) == 8, substr(trimws(x), 1, 5), x)), .SDcols = (5:ncol(FINAL_REPORT))]
  
  openxlsx::write.xlsx(FINAL_REPORT, paste0(ODDrive, 'DBL/', 'REPORT_FILES_INTRADAY_UPDATED.xlsx'))
  
}

# ==================================================================================================
CCPR_WRITE_SUMMARY_UPDATE_ALL = function(pData=x, pFileName, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T) {
  # ----------------------------------------------------------------------------
  # xs = WRITE_SUMMARY(UData, "efrc_indexp_history.rds")
  # ToPrompt=T
  # pData = ins_ref
  if (nrow(pData)>0)
  {
    x.rds = pData
  } else {
    x.rds     = try(readRDS(pFileName))
  }
  
  if (all(class(x.rds)!='try-error') && nrow(x.rds)>0)
  {
    if (ToPrompt) {My.Kable.Min(x.rds)}
    if (ToPrompt) {str(x.rds)}
    if (!"codesource" %in% colnames(x.rds) & "ticker" %in% colnames(x.rds)) { 
      x.rds[, codesource:=as.character(ticker)]} 
    if (!"codesource" %in% colnames(x.rds)) { x.rds[, codesource:=NA]} else{ x.rds[, codesource:=as.character(codesource)]}
    if (!"source" %in% colnames(x.rds)) { x.rds[, source:=NA]} else{ x.rds[, source:=as.character(source)]}
    if (!"close" %in% colnames(x.rds)) { x.rds[, close:=as.numeric(NA)]}
    if ("code" %in% colnames(x.rds) & "codesource" %in% colnames(x.rds) & nrow(x.rds[!is.na(code)])==0) { 
      x.rds[, code:=as.character(codesource)]} 
    if (!"updated" %in% colnames(x.rds)) { 
      x.rds[, updated:=SYS.TIME()]} else {
        if (nrow (x.rds [!is.na (updated)]) ==0 ){x.rds [, updated := SYS.TIME()]} else {
          x.rds [is.na(updated), updated := SYS.TIME()]
        }
      }
    # My.Kable (x.rds [!is.na(updated),.(code, date, name, updated)])
    # My.Kable (x.rds [is.na(updated),.(code, date, name, updated)])
    
    # setkey(x.rds, code, date)
    setkey(x.rds, code, updated)
    
    # my.data[,":="(nbdays=append(NA,diff(date))),by=list(code)]
    if (ToExclude)
    {  
      my.summary = x.rds[date<=Sys.Date(),.( 
        start=date[1],date=date[.N], starttime =timestamp_vn[1],    endtime=timestamp_vn[.N], nb=.N, 
        last=close[.N], nbdays=as.numeric(NA), source=source[.N],
        name="", type="", codesource=codesource[.N],updated = updated[.N]), by='code']
    } else {
      # my.summary = my.data[,.( 
      #   start=date[1], date=date[.N], nb=.N, datelast=date[.N], 
      #   last=close[.N], nbdays=as.numeric(NA), source=source[.N],
      #   name="", type="", codesource=codesource[.N],updated = updated[.N]), by='code']
      my.summary = x.rds[,.( 
        start=date[1],date=date[.N], starttime =timestamp_vn[1],    endtime=timestamp_vn[.N], nb=.N, 
        last=close[.N], nbdays=as.numeric(NA), source=source[.N],
        name="", type="", codesource=codesource[.N],updated = updated[.N]), by='code']
    }
    DBL_RELOAD_INSREF()
    my.summary = merge(my.summary[, -c('type', 'name', 'fcat','iso2','country','continent')], ins_ref[, .(code, type, name=short_name, fcat, iso2 , country, continent)], all.x=T, by='code')
    my.summary = my.summary[order(-date, code)]
    if (ToPrompt) {My.Kable.TB(my.summary)}
    
    my.FileTXT  = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
    CATln(my.FileTXT)
    my.summary = my.summary[order(-date)]
    # my.summary = merge(my.summary[, -c("name", "type", "fcat")], ins_ref[, .(code, name=short_name, type, fcat)], by='code', all.x=T)
    # my.summary = transform(my.summary, type=ins_ref$type[match(code, ins_ref$code)])
    
    # if (AddName) { 
    #   my.summary = transform(my.summary, name=ins_ref$short_name[match(code, ins_ref$code)])
    #   }
    if (ToPrompt) {My.Kable.TB(my.summary)}
    if (ToRemoveCodeNA) { my.summary= my.summary[!is.na(code)] }
    my.summary = my.summary %>% select ('iso2','country', 'continent','type','code','name','source','codesource',
                                        'start', 'starttime', 'endtime', 'nb','updated', everything() )
    fwrite(my.summary, my.FileTXT, col.names = T, sep="\t", quote = F)
    
    DATACENTER_LINE_BORDER(paste(my.FileTXT, ":", 
                                 min(my.summary[!is.na(start)]$start), 'to', max(my.summary[!is.na(date)]$date),
                                 ">>>", trimws(FormatNS(nrow(my.summary),0,12,"")), "/", 
                                 trimws(FormatNS(sum(my.summary$nb),0,16,"")), " = at", substr(as.character(Sys.time()),12,16)))
    return(my.summary)
  }
} 

#===================================================================================================
DOWNLOAD_CBOE_YAH_INTRADAY_OLD = function(pCode = "VIX", CODE = 'INDVIX',yCode = '^VIX')  {
  # ------------------------------------------------------------------------------------------------
  # pCode = "A"; CODE = 'B'; yCode = 'C'
  # pCode = "VXN"; CODE = 'INDVXN'; yCode = '^VXN'
  # pCode = "VXN"; CODE = 'INDVXN'; yCode = '^GSPC'
  # yCode = '^VIX'
  # pCode = "VIX"
  # CODE = 'INDVIX'
  
  final_data_last = data.table()
  final_data      = data.table()
  
  pURL = paste0('https://www.cboe.com/indices/data/?symbol=', pCode, '&timeline=intraday')
  # datetime = gsub('-| |:|\\.', '',as.character(Sys.time()))
  # x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp = paste0('c:/temp/',datetime, '.txt') , ToDeleteTemp = T)
  data = jsonlite::fromJSON(pURL)
  # if (grepl('<pre>', x[1])) { x = str.extract(x[1], '<pre>', '</pre>') }
  # data = jsonlite::fromJSON(x)
  xData      = try(as.data.table(data))
  
  if (all(class(xData) !='try-error') & nrow(xData) > 0)
  {
    
    My.Kable(xData)
    xData = xData %>%
      separate(data.V1, into = c("date", "timestamp"), sep = "T")
    xData = as.data.table(xData)
    xData [, date := as.Date(date)]
    xData [, timestamp := as.POSIXct(paste0(date, ' ', timestamp))]
    xData [, timestamp := as.POSIXct(timestamp) - 5*3600 ]
    xData [, timestamp_vn := as.POSIXct(timestamp) + (12*3600)]
    xData [order(-timestamp)]
    min(xData$data.V4)
    setnames(xData, old = c('data.V2','data.V3', 'data.V4', 'data.V5'), new = c('open', 'high', 'low', 'close'))
    xData[, code := CODE]
    xData[, source := 'CBOE']
    xData[, datetime := timestamp]
    xData = xData[order(timestamp_vn)]
    xData = MERGE_DATASTD_BYCODE(xData)
    xData = UPDATE_UPDATED(xData)
    xData = CLEAN_TIMESTAMP(xData)
    My.Kable(xData)
    
    # index_cboe_date = paste0('https://www.cboe.com/indices/data/?symbol=', pCode, '&timeline=intraday')
    # index_cboe_date = jsonlite::fromJSON(index_cboe_date)
    # 
    # index_cboe_date = as.data.table(index_cboe_date)
    # index_cboe_date = unique(index_cboe_date[, date := as.Date(data.V1)], by = 'date')
    # index_cboe_date[, pDate := shift(date)]
    # index_cboe_date = index_cboe_date[!is.na(pDate)][,.(date, pDate)]
    
    index_yah_date = CHECK_CLASS(try(DBL_DOWNLOAD_YAH_OHLC_INTRADAY( pCodesource = yCode, pInterval = '1d', Hour_adjust = -5)))
    index_yah_date = index_yah_date[,.(date)]
    index_yah_date[, pdate := shift(date)]
    index_yah_date = index_yah_date[!is.na(pdate)]
    xData = merge(xData[, -c('pdate')], index_yah_date, by = 'date', all.x = T)
    
    
    index_cboe_day = CHECK_CLASS(try(DOWNLOAD_CBOE_VIX_DAY_BY_CODE(pCode , CODE)))
    
    My.Kable(index_cboe_day)
    index_cboe_day = index_cboe_day[order(date)]
    index_cboe_day[, pclose := shift(close)]
    index_cboe_day[, varpc := 100*((close/shift(close))-1)]
    My.Kable(index_cboe_day[, .(code, date, close,pclose, varpc)])
    
    xData = merge(xData[, -c('pclose')], index_cboe_day[, .(pdate = date, pclose = close)], all.x = T, by = "pdate")
    
    final_data = xData[, .(code, name, date, timestamp, timestamp_vn, open = as.numeric(open), high = as.numeric(high),
                           low = as.numeric(low), close = as.numeric(close), pclose = as.numeric(pclose))]
    final_data[, varpc := 100*((close/pclose)-1)]
    final_data[, change := (close-pclose)]
    final_data = UPDATE_UPDATED(final_data)
    My.Kable(final_data)
    final_data_last = unique(final_data[order(date, -timestamp)], by='code')
    My.Kable(final_data_last)
  }
  return (list(final_data, final_data_last ))
}
# ==================================================================================================
DOWNLOAD_CBOE_VIX = function (Save_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/',
                              Save_File   = 'DBL_DOWNLOAD_CBOE_VIX_INTRADAY.rds')
{
  VIX = try(DOWNLOAD_CBOE_YAH_INTRADAY (pCode = "VIX", CODE = 'INDVIX', yCode = '^VIX'))
  #My.Kable.All(VIX[[2]])
  # VXN = try(DOWNLOAD_CBOE_YAH_INTRADAY (pCode = "VXN", CODE = 'INDVXN', yCode = '^VXN'))
  #My.Kable.All(VXN[[2]])
  # VXD = try(DOWNLOAD_CBOE_YAH_INTRADAY (pCode = "VXD", CODE = 'INDVXD', yCode = '^VXD'))
  #My.Kable.All(VXD[[2]])
  DATA_ALL = data.table()
  # DATA_ALL = rbind(VIX[[1]], VXN[[1]], VXD[[1]], fill = T)
  DATA_ALL = VIX[[1]]
  
  # My.Kable(DATA_ALL[code == 'INDVIX'])
  # My.Kable(VIX[[1]][code == 'INDVIX'])
  DATA_OLD = CHECK_CLASS(try(DBL_CCPR_READRDS(Save_Folder, Save_File, ToKable = T)))
  
  DATA_OLD = rbind(DATA_OLD, DATA_ALL, fill = T)
  if(nrow(DATA_OLD) > 0)
  {
    DATA_OLD = unique(DATA_OLD, by = c('code', 'timestamp'), fromLast = T)
    My.Kable.All(DATA_OLD)
    if((nchar(Save_Folder) * nchar(Save_File) > 0) & (nrow(DATA_OLD) > 0) )
    {
      DATA_OLD = UPDATE_UPDATED(DATA_OLD)
      My.Kable(DATA_OLD)
      try(DBL_CCPR_SAVERDS(DATA_OLD, Save_Folder, Save_File, ToSummary = T, SaveOneDrive = T))
    }
  }
  return(DATA_OLD)
}
# ==================================================================================================
DOWNLOAD_CBOE_VIX_DAY_BY_CODE = function(pCode = 'RVX', CODE =  "INDRVX")
{
  data = try(setDT(fread(paste0('https://cdn.cboe.com/api/global/us_indices/daily_prices/', pCode, '_History.csv'))))
  if(nrow(data) > 0)
  {
    setnames(data, new = tolower(names(data)))
    data[, date :=  as.Date(date, format = "%m/%d/%Y")]
    data[, code := CODE]
    data = MERGE_DATASTD_BYCODE(data)
    data = DBL_IND_CALCULATE_RT_VAR_CHANGE(data)
  }
  return(data)
}

# ==================================================================================================
DBL_REFERENCES = function ( ) {
  
  # ------------------------------------------------------------------------------------------------
  
  #STOCK >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  x = setDT (fread('S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_stk_history.txt'))
  x = x [active ==1]
  my_summary = list()
  for (i in 1:nrow (x))
  {
    # i = 1
    pFolder = x[i]$folder
    pFile   =  x[i]$filename
    coverage = x [i]$country
    if (coverage == 'VIETNAM') { sub_category = 'STKVN'} else { sub_category = 'STKIN'}
    data = try( DBL_CCPR_READRDS ( FileFolder =  pFolder ,FileName =  pFile, Nb_repeat = 3, 
                                   ToRestore = F, ToSave = F,  pSleep = 10))
    if (all(c('close', 'sharesout') %in% names (data)) )
    {
      y = data [ date == max(date)] [, market_cap := close * sharesout] 
    } else { y = data [ date == max(date)] [, market_cap := as.numeric (NA)]  }
    if (nrow(data) >0) {
      summary  = try(CCPR_WRITE_SUMMARY_CURRENT(pData=data, pFileName='', ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) 
      ref = ins_ref [ code %in% summary$code,.(code, sector = gics_sector_name, industry = gics_ind_name, iso2, country, continent)]
      summary = merge (summary, ref, all.x = T, by = 'code')
      summary = merge (summary, y [,.(code, market_cap)], all.x = T, by = 'code')
      my_summary [[i]] = summary[,.(type, provider = as.character(NA), code, name, short_name = name, sector, industry, 
                                    iso2 , country, continent, start, end = datelast, records = nb,market_cap, periodicity = 'DAY',
                                    coverage = coverage, sub_category = sub_category)]
    } else { my_summary [[i]] = data.table()}
  }
  MY_STK = rbindlist (my_summary, fill = T)
  
  My.Kable (MY_STK)
  #INDEX >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  x = setDT (fread('S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_ind_history.txt'))
  x = x [active ==1]
  my_summary = list()
  for (i in 1:nrow (x))
  {
    # i = 1
    pFolder = x[i]$folder
    pFile   =  x[i]$filename
    coverage = x [i]$country
    if (coverage == 'VIETNAM') { sub_category = 'INDVN'} else { sub_category = 'INDVN'}
    data = try( DBL_CCPR_READRDS ( FileFolder =  pFolder ,FileName =  pFile, Nb_repeat = 3, 
                                   ToRestore = T, ToSave = F,  pSleep = 10))
    if (nrow(data) >0) {
      summary  = try(CCPR_WRITE_SUMMARY_CURRENT(pData=data, pFileName='', ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) 
      ref = ins_ref [ code %in% summary$code,.(code,  iso2, country, continent)]
      summary = merge (summary, ref, all.x = T, by = 'code')
      my_summary [[i]] = summary[,.(type = 'IND', provider = as.character('BEQ/IFRC'), code, name, short_name = name,  
                                    iso2 , country, continent, start, end = datelast, records = nb, periodicity = 'DAY',
                                    coverage = coverage, sub_category = sub_category)]
    } else { my_summary [[i]] = data.table()}
    
  }
  MY_IND = rbindlist (my_summary, fill = T)
  MY_IND = unique (MY_IND [!is.na(records) & records >0 ], by = 'code')
  
  #VOLAT >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  x = setDT (fread('S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_volatility_history.txt'))
  x = x [active ==1]
  my_summary = list()
  for (i in 1:nrow (x))
  {
    # i = 1
    pFolder = x[i]$folder
    pFile   =  x[i]$filename
    coverage = x [i]$country
    data = try( DBL_CCPR_READRDS ( FileFolder =  pFolder ,FileName =  pFile, Nb_repeat = 3, 
                                   ToRestore = F, ToSave = F,  pSleep = 10))
    if (!'name' %in% names (data)) { data [, name := short_name]}
    if (nrow(data) >0) {
      summary  = try(CCPR_WRITE_SUMMARY_CURRENT(pData=data, pFileName='', ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) 
      ref = ins_ref [ code %in% summary$code,.(code,  iso2, country, continent)]
      summary = merge (summary, ref, all.x = T, by = 'code')
      summary = merge (summary [, -c('name')], unique (data [,.(code, name)], by  = c('code')), all.x = T, by = 'code')
      my_summary [[i]] = summary[,.(type = 'IND', provider = as.character('BEQ/IFRC'), code, name, short_name = name,  
                                    iso2 , country, continent, start, end = datelast, records = nb, periodicity = 'INTRADAY',
                                    coverage = coverage, sub_category = sub_category)]
    } else { my_summary [[i]] = data.table()}
  }
  MY_VOLAT = rbindlist (my_summary, fill = T)
  MY_VOLAT [grepl ('VIX', name), sub_category := 'VIX']
  MY_VOLAT = unique (MY_VOLAT [!is.na(records) & records >0 ], by = 'code')
  
  MY_DATA = rbind (MY_STK, MY_IND, MY_VOLAT, fill = T)
  MY_DATA [, ':=' (date = Sys.Date(), updated = SYS.TIME())]
  MY_DATA [grepl ('VIX', name), sub_category := 'VIX']
  DBL_CCPR_SAVERDS (MY_DATA, "S:/CCPR/DATA/DASHBOARD_LIVE/","dbl_references.rds")
  library(fst)
  write_fst(MY_DATA, "S:/SHINY/REPORT/DBL_REFERENCES/dbl_references.fst")
  
  return (MY_DATA)
  
}

# ==================================================================================================
DBL_CCPR_READRDS = function ( FileFolder = 'S:/STKVN/INDEX_2024/', FileName ='dbl_indfgd_history.rds', Nb_repeat = 3, 
                              ToRestore = F, ToSave = F,  pSleep = 10, ToKable=F, ToPrompt=F)  {
  # ------------------------------------------------------------------------------------------------
  # SData
  # Folder = 'S:/STKVN/INDEX_2024/'; File ='dbl_indfgd_history.rds'; Nb_repeat = 3; ToRestore = F; pSleep = 10
  if(file.exists(paste0(FileFolder, FileName)))
  {
    Nb_try = 0
    OK = F 
    DATA_DBL = data.table()
    
    while (Nb_try <= Nb_repeat & !OK)
    {
      DATA_DBL = CHECK_CLASS(try(CCPR_READRDS(FileFolder, FileName, ToKable = T, ToRestore = F)))
      if (nrow (DATA_DBL) >0) { OK = T} else { IFRC_SLEEP(pSleep)}
      Nb_try = Nb_try + 1
    }
    UPDATED_INSREF = ''
    if (nrow (DATA_DBL) > 0)
    {
      UPDATED_INSREF = DBL_SUMMARY_UPDATED(paste0(FileFolder, FileName))
    }
    
    CATln_Border(paste ( 'NB_TRY = ',Nb_try, ', NROW DATA = ', Format.Number(nrow(DATA_DBL),0), '|', UPDATED_INSREF))
    
    if (nrow (DATA_DBL) == 0)
    {
      list_file = as.data.table (list.files(FileFolder,'*.rds'))
      list_file = list_file [grepl(paste0(gsub('.rds','',FileName),'_2'),V1, ignore.case = T) & nchar (V1) == nchar(FileName ) + 9] [order (-V1)]
      
      My.Kable (list_file)
      if (nrow (list_file) >0)
      {
        File_ToRestore = list_file [1] $V1
        CATln_Border(File_ToRestore)
        Data_ToRestore = CHECK_CLASS(try(CCPR_READRDS (FileFolder, File_ToRestore) ))
        if (nrow (Data_ToRestore) >0)
        {
          DATA_DBL = copy(Data_ToRestore)
        } else {
          DATA_DBL = CHECK_CLASS(try(CCPR_READRDS(Folder,FileName, ToKable = T, ToRestore = T)))
        }
        My.Kable.INSREF (DATA_DBL)
        
        if (ToSave & nrow (DATA_DBL) >0)
        {
          CCPR_SAVERDS (DATA_DBL, FileFolder,FileName, ToSummary = T, SaveOneDrive = T)
        }
      } else {
        DATA_DBL = CHECK_CLASS(try(CCPR_READRDS(FileFolder,FileName, ToKable = T, ToRestore = T)))
      }
    }
  }else{
    DATA_DBL = data.table()
  }
  
  return (DATA_DBL)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_PRICES_ALL_BY_CODE = function (pCode='OCC.BK', NB_Day = 100000, Dividend = F, Capi = T, Sharesout = F) {
  
  # pCode = 'BTC-USD'
  # NB_Day = 10
  xData          = data.table()
  xData_shares   = data.table()
  xData_dividend = data.table()
  
  xData_prices   = CHECK_CLASS(try(DOWNLOAD_YAH_INS_PRICES_UNADJ(p_nbdays_back= NB_Day, tickers=pCode, freq.data='daily', p_saveto="", NbTry=15)))
  if (Sharesout){
    xData_shares   = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_SHARES (pCode=pCode)))
  }
  if (Dividend){
    xData_dividend = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_DIVIDEND  ( pCode = pCode,  Nbdays = NB_Day,
                                                                      silent = T, ToKable = T)))
    str(xData_dividend)
  }
  
  if (nrow(xData_prices) > 0 & nrow(xData_shares)> 0 ) 
  {
    xData = merge(xData_prices, xData_shares[,. (codesource, market_cap, share_outstanding, float)], by = c ('codesource'), all.x = T)
    names(xData)[names(xData) == "name"] <- "company_name"
    if (nrow(xData_dividend) > 0) 
    {
      xData = merge(xData, xData_dividend[,. (date=ref_date, codesource, dividend)], by = c("codesource", "date"), all.x = T)
    }else{
      xData[, dividend := NA]
    }
  } else {
    xData = xData_prices
  }
  
  pURL = paste0("https://finance.yahoo.com/quote/",pCode,"/")
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/','yahoo_stat.txt'), ToDeleteTemp = F)
  content    = try(rvest::read_html(xweb))
  xData[, close_unadj := close]
  cur_text = html_nodes(content, 
                        xpath = '//*[@id="nimbus-app"]/section/section/section/article/section[1]/div[1]/span/span[2]')
  xData[, cur := xml_text(cur_text)]
  if (Capi){
    if (!'market_cap' %in% names(xData) | all(is.na(xData$market_cap))){
      capi_value = html_nodes(content, 
                              xpath = '//*[@id="nimbus-app"]/section/section/section/article/div[2]/ul/li[9]/span[2]')
      value = xml_text(capi_value)
      if (length(value) > 0){
        capi1Day = TRAINEE_CONVERT_NUMBER(as.vector(value))
        xData[, market_cap := capi1Day]
      } else {
        capi_value = html_nodes(content, 
                                xpath = '//*[@id="nimbus-app"]/section/section/section/article/div[3]/ul/li[7]/span[2]/fin-streamer/span')
        value = trimws(xml_text(capi_value))
        if (length(value) > 0){
          capi1Day = TRAINEE_CONVERT_NUMBER(as.vector(value))
          xData[, market_cap := capi1Day]
        } else {
          pURL = paste0("https://au.finance.yahoo.com/quote/",pCode,"/")
          # xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/','yahoo_stat.txt'), ToDeleteTemp = F)
          content    = try(rvest::read_html(pURL))
          capi_value = html_nodes(content, 
                                  xpath = '//*[@id="quote-summary"]/div[2]/table/tbody/tr[1]/td[2]')
          value = xml_text(capi_value)
          if (length(value) > 0){
            capi1Day = TRAINEE_CONVERT_NUMBER(as.vector(value))
            xData[, market_cap := capi1Day]
          }
        }
      }
    }
    xData = xData[order(codesource, date)]
    xData[is.na(rt), rt := 0, by = "codesource"]
    xData[, rt_1:= 1 + rt]
    xData[, cumul := rt_1[1] * cumprod(rt_1), by = "codesource"]
    xData[, capi := market_cap[.N] * cumul / cumul[.N], by = "codesource"]
    xData[, ':=' (rt_1 = NULL, cumul = NULL)]
    xData[cur == 'USD', capiusd := capi]
  }
  
  DATA_ALL = xData
  #download_all_board <- readRDS("S:/R/DATA/BOARD/download_all_board.rds")
  #DATA_ALL = merge(DATA_ALL, download_all_board[,. (codesource, name, title, first_name, last_name, ceo, cob, gender)], by = 'codesource', all.x = T)
  if (nrow(DATA_ALL)>0) 
  {
    DATA_ALL = MERGE_DATASTD_BYCODE(DATA_ALL, pOption = 'FINAL')
    My.Kable.TB(DATA_ALL)
  }
  return(DATA_ALL)
}

# ==================================================================================================
DBL_INS_REF_ADD_MODIFY_NEW = function(pOption="MODIFY") {
  # ------------------------------------------------------------------------------------------------
  # DBL_INS_REF_ADD_MODIFY(pOption="ADD")
  switch(pOption,
         "MODIFY" = {
           # MODIFY
           #"S:/CCPR/DATA/dbl_ins_ref.rds"
           ins_ref  = CCPR_READRDS('S:/CCPR/DATA/', "dbl_ins_ref.rds")
           ins_ref [yah == '^990100-USD-STRD']
           ins_ref_short = ins_ref[, .(w=world, type, scat, sub_menu, code, fcat, eik, blg, inv, qdl, 
                                       enx, yah, inv, short_name, iso3, country, continent, provider, enddate, last)]
           
           ins_ref_mod = setDT(openxlsx::read.xlsx(paste0(UData, "efrc_ins_ref_add.xlsx"), sheet=2))
           colnames(ins_ref_mod) = tolower(colnames(ins_ref_mod))
           My.Kable(ins_ref_mod[, 6:15], HeadOnly = T, Nb=100)
           ins_ref_mod = ins_ref_mod[selection==1]
           ins_ref_mod$selection=NULL
           # ins_ref_todo = ins_ref_mod
           My.Kable(ins_ref_mod[, 1:15])
           
           if (nrow(ins_ref_mod) > 0 )
           {
             for (irow in 1:nrow(ins_ref_mod))
             {
               # irow = 1
               one_row     = ins_ref_mod[irow, ]
               DATACENTER_LINE_BORDER(paste("INSREF_MODIFY :", irow, "/", nrow(ins_ref_mod), "-", one_row[1]$code))
               
               one_row
               oth_field   = setdiff(colnames(ins_ref_mod), "code")
               
               ins_ref_tmp = copy(ins_ref)
               if (nrow(ins_ref_tmp[code==one_row$code])==1) 
               {
                 ins_ref[code==one_row$code, .(type, scat, menu, sub_menu, fcat, code, eik, blg, cur, 
                                               inv, qdl, enx, name, iso2, iso3, country, continent, provider, enddate, last)]
               }
               nr.row = which(ins_ref$code==one_row$code)
               nr.row
               for (i.field in 1:ncol(one_row))
               {
                 # i.field = 13
                 # print(colnames(one_row)[i.field])
                 # if (is.na(one_row[1, ..i.field])) {print(paste(colnames(one_row)[i.field], "SKIP"))} else {print(paste(colnames(one_row)[i.field], ">"))}
                 if (is.na(one_row[1, ..i.field])) {} else {
                   print(paste(colnames(one_row)[i.field], ">", one_row[1, ..i.field]))
                   set(ins_ref, nr.row, colnames(one_row)[i.field], value=one_row[1, ..i.field])
                 }
               }
               ins_ref[code==one_row$code, .(world, type, scat, sub_menu, code, eik, blg, inv, qdl, enx, 
                                             name, iso2, iso3, country, continent, provider, enddate, last)]
             }
             
             CATln("INSREF_MODIFY : END.")
             ins_ref[is.na(short_name), short_name:=trimws(toupper(name))]
             ins_ref[, code:=toupper(trimws(code))]
             # My.Kable(ins_ref[grepl("UPCOM", name), .(type, scat, menu, sub_menu, fcat, code, eik, blg, inv, qdl, enx, name, iso2, iso3, cur, price, country, continent, provider)], 
             #          HeadOnly = T, Nb=10)
             str(ins_ref)
             ind_ref = ins_ref[type=="IND"]
             My.Kable(ins_ref[type=='STK' & grepl('BNP', code), .(code, type, fcat, blg, eik, yah, qdl, 
                                                                  inv, yah, enddate, last)][order(-enddate)])
             
             # SAVE .............................................................................................
             try(DBL_CCPR_SAVERDS (pData = ins_ref,  'S:/CCPR/DATA/',  "dbl_ins_ref.rds", Nb_repeat = 3, SaveOneDrive = T, ToSave = T,  pSleep = 10))
             try(CPPR_SAVERDS(ins_ref, "S:/CCPR/DATA/", "dbl_ins_ref.rds"))
             #DATACENTER_SAVEDTRDS(ins_ref[type=="IND"], paste0("S:/CCPR/DATA/", "dbl_ins_ref.rds"))
             # SAVE .............................................................................................
             
             # MAINTENANCE_DAILY_INSREF()
             # rm(ins_ref); LOAD_INSREF_INDREF(l_option="DAY", ToReload=T)
             
             My.Kable(ins_ref[type=='STK' & grepl('APPLE', name), 
                              .(code, type, fcat, blg, eik, yah, qdl, inv, yah, enddate, last)][order(-enddate)])
             My.Kable(ins_ref[type=='STK' & grepl('SAMSUNG', name), 
                              .(name, code, type, fcat, blg, eik, yah, qdl, inv, yah, enddate, last)][order(-enddate)])
             My.Kable(ins_ref[type=='STK' & grepl('ACCOR', name), 
                              .(name, code, type, fcat, blg, eik, yah, qdl, inv, yah, enddate, last)][order(-enddate)])
             My.Kable(ins_ref[type=='STK' & grepl('SONY', name), 
                              .(name, code, type, fcat, blg, eik, yah, qdl, inv, yah, enddate, last)][order(-enddate)])
             My.Kable(ins_ref[type=='STK' & grepl('VINHOME', name), 
                              .(name, code, type, fcat, blg, eik, yah, qdl, inv, enddate, last)][order(-enddate)])
           }else{
             CATln("INSREF_MODIFY : END.")
           }
           
         },
         "ADD" = {
           # ADD INS REF
           #RELOAD_INSREF(ToForce = T)
           ins_ref     = CCPR_READRDS("S:/CCPR/DATA/", "dbl_ins_ref.rds")
           ins_ref     = ins_ref[!is.na(code)]
           country_ref = CCPR_READRDS(UData, "efrc_country_ref.rds")
           # ind_ref     = ins_ref[type=="IND"]
           
           # ins_ref     = ins_ref[!(code %in% list("BNDJGBUS40Y",  "BNDUSTRLT", "BNDUSHQMC"))]
           ins_ref_add = setDT(openxlsx::read.xlsx(paste0(UData, "efrc_ins_ref_add.xlsx"), sheet=1))
           colnames(ins_ref_add) = tolower(colnames(ins_ref_add))
           ins_ref_add = ins_ref_add[selection==1]
           str(ins_ref_add)
           
           My.Kable(ins_ref_add[, 1:18], HeadOnly = T, Nb=20)
           
           ins_ref_add$selection=NULL
           
           ins_ref_add = transform(ins_ref_add, country = country_ref$name[match(toupper(iso2), toupper(country_ref$iso2))])
           ins_ref_add[, name:=toupper(name)]
           ins_ref_add[, qdl:=toupper(qdl)]
           ins_ref_add = ins_ref_add[!(code %in% ins_ref$code)]  # New codes only
           
           ncol1 = ncol(ins_ref); ncol1
           nrow1 = nrow(ins_ref_add); nrow1
           
           My.Kable(ins_ref_add[, 1:15])
           
           if (nrow1>0)
           {
             ins_ref = rbind(ins_ref, ins_ref_add, fill=T)
             ins_ref = ins_ref[!is.na(code)]
             ncol2   = ncol(ins_ref)
             if (ncol1==ncol2)   
             {
               print(" EQUAL COLUMNS")
               CCPR_SAVERDS(ins_ref, 'S:/CCPR/DATA/', "dbl_ins_ref.rds", ToSummary=T, SaveOneDrive = T)
               #CCPR_SAVERDS(ins_ref, 'S:/CCPR/DATA/', "dbl_ins_ref.rds", ToSummary=T, SaveOneDrive = T)
               RELOAD_INSREF(ToForce = T)
             }
           }
         }
  )
}

# ==================================================================================================
INSREF_ADD_MSCI_FRONTIER_PRICE_USD_NEW = function() {
  # ------------------------------------------------------------------------------------------------
  # INSREF_ADD_MSCI_FRONTIER_PRICE_USD()
  DBL_RELOAD_INSREF(ToForce = T)
  My.Kable.INSREF(ins_ref[type=='IND' & grepl('MSCI FRONTIER', name) & !grepl('IFRC', short_name)][order(name)])
  My.Kable.INSREF(ins_ref[code=='INDMSCIFRONTIER'])
  INSREF_ONE   = ins_ref[code=='INDMXWO']
  INSREF_FINAL = INSREF_ONE[, .(type, fcat, scat, active=1, iso2, iso3, code='INDMSCIFRONTIER', yah='^700023-USD-STRD', prtr='PR', cur='USD',
                                name = 'MSCI FRONTIER PR (USD)', short_name='MSCI FRONTIER PR (USD)')]
  
  if (nrow(ins_ref[code=='INDMSCIFRONTIER'])==0)
  {
    ins_ref = rbind(ins_ref[!code %in% INSREF_FINAL$code], INSREF_FINAL, fill=T)
    My.Kable.INSREF(ins_ref)
    
    CCPR_SAVERDS(ins_ref, 'S:/CCPR/DATA/', "dbl_ins_ref.rds", ToSummary = T, SaveOneDrive = T)
    #CCPR_SAVERDS(ins_ref, 'S:/R/DATA/', 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    DBL_RELOAD_INSREF(ToForce = T)
  }
}

# ==================================================================================================
INSREF_ADD_MSCI_WORLD_PRICE_USD_NEW = function() {
  # ------------------------------------------------------------------------------------------------
  # INSREF_ADD_MSCI_WORLD_PRICE_USD()
  DBL_RELOAD_INSREF(ToForce = T)
  My.Kable.INSREF(ins_ref[type=='IND' & grepl('MSCI WORLD', name) & !grepl('IFRC', short_name)][order(name)])
  My.Kable.INSREF(ins_ref[code=='INDMSCIWORLD'])
  INSREF_ONE   = ins_ref[code=='INDMXWO']
  INSREF_FINAL = INSREF_ONE[, .(type, fcat, scat, active=1, iso2, iso3, code='INDMSCIWORLD', yah='^990100-USD-STRD', prtr='PR', cur='USD',
                                name = 'MSCI WORLD PR (USD)', short_name='MSCI WORLD PR (USD)')]
  if (nrow(ins_ref[code=='INDMSCIWORLD'])==0)
  {
    ins_ref = rbind(ins_ref[!code %in% INSREF_FINAL$code], INSREF_FINAL, fill=T)
    My.Kable.INSREF(ins_ref)
    # ins_ref = rbind(ins_ref, INSREF_FINAL, fill=T)
    # DBL_CCPR_SAVERDS(ins_ref, UData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    
    DBL_CCPR_SAVERDS (pData = ins_ref,'S:/CCPR/DATA/',  "dbl_ins_ref.rds", Nb_repeat = 3, SaveOneDrive = T, ToSave = T,  pSleep = 10)
    DBL_RELOAD_INSREF(ToForce = T)
  }
}





# x = REPORT_OVERVIEW_DASHBOARD(option = 'DASHBOARD')
# MERGE_HSX_HNX_UPC_TO_EXC(Prefix= 'PRICESBOARD')
# MERGE_HSX_HNX_UPC_TO_EXC(Prefix= 'SNAPSHOT')
# 
# # ==================================================================================================
# CLEAN_TIMESTAMP = function (data) {
#   # ------------------------------------------------------------------------------------------------
#   if (nrow (data) >0)
#   {
#     if ('timestamp' %in% names (data)) { data[, timestamp := substr(as.character (timestamp), 1, 19)]}
#     if ('datetime' %in% names (data)) { data[, datetime := substr(as.character (datetime), 1, 19)]}
#     if ('timestamp_vn' %in% names (data)) { data[, timestamp_vn := substr(as.character (timestamp_vn), 1, 19)]}
#     if ('timestamp_loc' %in% names (data)) { data[, timestamp_loc := substr(as.character (timestamp_loc), 1, 19)]}
#   }
#   return (data)
# }
# 
# 
# # ==================================================================================================
# DBL_INTEGRATE_INTRADAY = function (data = data.table(),
#                                    Fr_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', Fr_File = 'dbl_yah_ind_intraday_day.rds',
#                                    To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'dbl_yah_intraday_history.rds')  {
#   # ------------------------------------------------------------------------------------------------
#   if (nchar (Fr_Folder) * nchar (Fr_File) >0)
#   {
#     data =CHECK_CLASS(try( CCPR_READRDS (Fr_Folder, Fr_File, ToRestore = T, ToKable = T) ))
#     data = CLEAN_TIMESTAMP(data)
#   }
#   data = CLEAN_TIMESTAMP(data)
#   if (nchar (To_Folder) * nchar (To_File) >0 & nrow (data) >0)
#   {
#     DATA_OLD = CHECK_CLASS (try (CCPR_READRDS (To_Folder, To_File, ToKable = T, ToRestore = T) ) )
#     DATA_OLD = CLEAN_TIMESTAMP (DATA_OLD)
#     DATA_OLD = rbind (DATA_OLD, data, fill = T)
#     if (nrow (DATA_OLD) >0)
#     {
#       DATA_OLD = unique (DATA_OLD, by = c('code', 'date', 'timestamp')) [!is.na(code) & !is.na(close) & !is.na(date)& !is.na(timestamp)]
#       DATA_OLD = CLEAN_TIMESTAMP (DATA_OLD)
#       CCPR_SAVERDS ( DATA_OLD, To_Folder, To_File, ToSummary = T, SaveOneDrive = F)
#     }
#   }
#   
# }
# 
# # ==================================================================================================
# DBL_INTRADAY_VOLATILITY_LOOP = function ( pOption = 'YAH', pMinutes = 120) {
#   # ------------------------------------------------------------------------------------------------
#   rm(LIST_CODES)
#   switch (pOption,
#           'YAH' = {
#             LIST_CODES = setDT(fread ('S:/CCPR/DATA/LIST/LIST_INTRADAY_VOLATILITY.txt'))
#             LIST_CODES = LIST_CODES [ACTIVE == 1 & SOURCE =='YAH']
#             
#             LIST_DOWNLOADED = setDT(fread ('S:/CCPR/DATA/DASHBOARD_LIVE/dbl_indbeq_volatility_intraday_history_summary.txt'))
#             NOT_DOWNLOAD = setdiff (LIST_CODES$SYMBOL, LIST_DOWNLOADED$codesource)
#             
#             x = SUMMARY_UPDATED(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indbeq_volatility_intraday_history.rds'))
#             difference = difftime(Sys.time(), x, units='mins')
#             ToDownload = F
#             if (difference > pMinutes)
#             {            LIST_CODES = setDT(fread ('S:/CCPR/DATA/LIST/LIST_INTRADAY_VOLATILITY.txt'))
#             LIST_CODES = LIST_CODES [ACTIVE == 1 & SOURCE =='YAH']
#             ToDownload = T
#             }
#             if (difference < pMinutes & length (NOT_DOWNLOAD) >0)
#             {
#               LIST_CODES = LIST_CODES [SYMBOL %in% NOT_DOWNLOAD]
#               ToDownload = T
#             }
#             if (nrow (LIST_CODES) >0 & ToDownload) 
#             {
#               MY_DATA = list()
#               for (i in 1:nrow(LIST_CODES))
#               {
#                 # i = 1
#                 my_code = LIST_CODES[i]$SYMBOL
#                 pHour   = LIST_CODES[i]$HOUR_ADJUST
#                 
#                 index = CHECK_CLASS(try(DBL_DOWNLOAD_YAH_OHLC_INTRADAY( pCodesource = my_code, pInterval = '5m', Hour_adjust = pHour)))
#                 if (nrow (index) >0)
#                 {
#                   index[, timestamp_IND:= datetime]
#                   index = DBL_CALCULATE_INTRADAY_VOLATILITY ( pSource = 'YAH', index)
#                   index [, codesource := my_code]
#                   MY_DATA [[i]] = index
#                 } 
#                 
#                 Sys.sleep(10)
#               }
#               data = rbindlist (MY_DATA, fill =T)
#               data [, datetime := as.character (datetime)]
#               ToIntegrate = T
#               Folder_To = 'S:/CCPR/DATA/DASHBOARD_LIVE/' 
#               File_Day  = 'dbl_indbeq_volatility_intraday_day.rds' 
#               File_History  = 'dbl_indbeq_volatility_intraday_history.rds'
#               
#               if (ToIntegrate & (nchar(Folder_To)* nchar( File_Day)) >0 & nrow (data) >0) 
#               {
#                 DATA_OLD = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_Day)))
#                 DATA_OLD [, datetime := as.character (datetime)]
#                 DATA_NEW = rbind (DATA_OLD, data, fill = T)
#                 DATA_NEW = unique (DATA_NEW, fromLast = T, by = c('code','date','timestamp'))
#                 DATA_NEW = DATA_NEW [!is.na(code_und)]
#                 # DATA_NEW [code_und == 'STKVNTCB']
#                 CCPR_SAVERDS (DATA_NEW, Folder_To, File_Day, ToSummary = T, SaveOneDrive = T)
#                 if (nchar (File_History) > 0) { 
#                   DATA_HISTORY = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_History)))
#                   DATA_HISTORY [, datetime := as.character (datetime)]
#                   DATA_NEW = rbind (DATA_HISTORY,  data, fill = T)
#                   DATA_NEW = unique (DATA_NEW, fromLast = T, by = c('code','date','timestamp'))
#                   CCPR_SAVERDS (DATA_NEW, Folder_To, File_History, ToSummary = T, SaveOneDrive = T)
#                 }
#               }
#             }else { CATln_Border('ALL INDEXES ARE UPDATED...')}
#           },
#           'DNSE' = {
#             
#             LIST_CODES = setDT(fread ('S:/CCPR/DATA/LIST/LIST_INTRADAY_VOLATILITY.txt'))
#             LIST_CODES = LIST_CODES [ACTIVE == 1 & SOURCE == 'DNSE']
#             
#             LIST_DOWNLOADED = setDT(fread ('S:/CCPR/DATA/DASHBOARD_LIVE/dbl_indbeq_volatility_intraday_history_summary.txt'))
#             NOT_DOWNLOAD = setdiff (LIST_CODES$SYMBOL, LIST_DOWNLOADED$codesource)
#             
#             x = SUMMARY_UPDATED(  paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indbeq_volatility_intraday_history.rds'))
#             difference = difftime(Sys.time(), x, units='mins')
#             ToIntegrate = T
#             Folder_To = 'S:/CCPR/DATA/DASHBOARD_LIVE/' 
#             File_Day  = 'dbl_indbeq_volatility_intraday_day.rds' 
#             File_History  = 'dbl_indbeq_volatility_intraday_history.rds'
#             ToDownload = F
#             if (difference > pMinutes)
#             {
#               LIST_CODES = setDT(fread ('S:/CCPR/DATA/LIST/LIST_INTRADAY_VOLATILITY.txt'))
#               LIST_CODES = LIST_CODES [ACTIVE == 1 & SOURCE == 'DNSE']
#               ToDownload = T
#             }
#             if (difference < pMinutes & length (NOT_DOWNLOAD) >0)
#             {
#               LIST_CODES = LIST_CODES [SYMBOL %in% NOT_DOWNLOAD]
#               ToDownload = T
#             }
#             if (nrow (LIST_CODES) >0 & ToDownload ) 
#             {
#               # file.remove(paste0(Folder_To,File_Day))
#               # file.remove(paste0(Folder_To,File_History))
#               
#               MY_DATA = list()
#               if (nrow (LIST_CODES) > 0) 
#               {
#                 for (i in 1:nrow(LIST_CODES))
#                 {
#                   # i = 2
#                   my_code = LIST_CODES[i]$SYMBOL
#                   pType  = LIST_CODES[i]$TYPE
#                   pCode  = LIST_CODES[i]$CODE
#                   
#                   index = DOWNLOAD_ENTRADE_INDEX_INTRADAY (type = pType,codesource = my_code, code = pCode, NbMinutes   = 11*365*24*60, OffsetDays  = 0,
#                                                            Save_folder = '', Save_file = '',
#                                                            Save_history = '',
#                                                            pInterval = '5')
#                   if (nrow (index) >0)
#                   {
#                     index [, timestamp_loc := timestamp_vn]
#                   }
#                   if (nchar (pCode) >0) {
#                     index [, code := pCode]
#                   }
#                   index [, timestamp_IND := timestamp_loc]
#                   index [, datetime := timestamp_loc]
#                   index [,.(code, date, timestamp_IND, close,datetime)]
#                   index = DBL_CALCULATE_INTRADAY_VOLATILITY  ( pSource = 'DNSE', index)
#                   index [, codesource := my_code]
#                   MY_DATA [[i]] = index
#                   
#                   Sys.sleep(10)
#                 }
#                 data = rbindlist (MY_DATA, fill =T)
#                 
#                 # file.remove(paste0(Folder_To,File_Day))
#                 # file.remove(paste0(Folder_To,File_History))
#                 
#                 if (ToIntegrate & (nchar(Folder_To)* nchar( File_Day)) >0 & nrow (data) >0) 
#                 {
#                   DATA_OLD = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_Day)))
#                   DATA_OLD [, datetime := as.character (datetime)]
#                   DATA_NEW = rbind (DATA_OLD, data, fill = T)
#                   DATA_NEW = unique (DATA_NEW, fromLast = T, by = c('code','date','timestamp'))
#                   DATA_NEW = DATA_NEW [!is.na(timestamp)]
#                   # DATA_NEW [code_und == 'STKVNTCB']
#                   CCPR_SAVERDS (DATA_NEW, Folder_To, File_Day, ToSummary = T, SaveOneDrive = T)
#                   if (nchar (File_History) > 0) { 
#                     DATA_HISTORY = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_History)))
#                     DATA_HISTORY [, datetime := as.character (datetime)]
#                     DATA_NEW = rbind (DATA_HISTORY, data, data, fill = T)
#                     DATA_NEW = unique (DATA_NEW, fromLast = T, by = c('code','date','timestamp'))
#                     CCPR_SAVERDS (DATA_NEW, Folder_To, File_History, ToSummary = T, SaveOneDrive = T)
#                   }
#                 }
#                 
#               }else { CATln_Border('ALL INDEXES ARE UPDATED...')}
#             }
#           },
#           ''
#   )
#   
#   x = DBL_SUMMARY_UPDATED(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_volatility_intraday_performance.rds'))
#   difference = difftime(Sys.time(), x, units='mins')
#   if ( difference > 10)
#   {
#     x= CHECK_CLASS(try(CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/','dbl_indbeq_volatility_intraday_history.rds')))
#     x = x [code != 'INDVLINA']
#     if (nrow (x)>0)
#     {
#       
#       y = setDT(x %>% group_by(code) %>% filter(date < (max(date)) ))
#       # y = unique (y [order (-timestamp)] , by = 'code')
#       y = y [!is.na (close) & !is.na (close_und)]
#       y = unique (y [order (-timestamp)] , by = 'code')
#       
#       y [, reference := close]
#       y [, last := close_und]
#       xx = unique (x [order (-timestamp)], by = 'code')
#       my_data =merge ( xx , y [,.(code, reference, last)], all.x = T, by = 'code')
#       my_data[grepl('STK',code), type := 'STK']
#       my_data [is.na(type), type := 'IND']
#       my_data [, volat_pc := (close/reference - 1)*100]
#       my_data [, und_pc := (close_und/last - 1)*100]
#       unique (my_data[!is.na (close) & !is.na (close_und)], by = 'code') 
#       CCPR_SAVERDS(my_data[!is.na(country)], 'S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_volatility_intraday_performance.rds', ToSummary = T)
#     }
#   }
#   try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste0('DBL_YAH_INTRADAY_LOOP>',pOption), pAction="SAVE", NbSeconds=1, ToPrint=F))
# }
# 
# # ==================================================================================================
# DBL_CALCULATE_INTRADAY_VOLATILITY = function (index = data.table(), LIST_CODES = list(),
#                                               Fr_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', Fr_File = 'dbl_source_ind_intraday_day.rds',
#                                               To_Folder = 'S:/CCPR/DATA/DASSHBOARD_LIVE/', To_File = 'dbl_indbeq_intraday_volatility_day.rds')  {
#   # ------------------------------------------------------------------------------------------------
#   
#   # pSource = 'DNSE'
#   start = Sys.time()
#   
#   if (nrow (index) ==0)
#   { 
#     index = try(CCPR_READRDS (Fr_Folder, Fr_File, ToKable = T))
#     index = CLEAN_TIMESTAMP(index)
#     # My.Kable (index [order (-timestamp)])
#   }
#   
#   data = data.table ()
#   if (nrow (index) >0)
#   {
#     index = index [!is.na(code) & !is.na(close)& close != 0]
#     if (length (LIST_CODES) >0)
#     {
#       index = index [code %in% LIST_CODES]
#       index = CLEAN_TIMESTAMP(index)
#     }
#     # My.Kable.Min (index [order (-timestamp)])
#   }
#   if (all((nrow (index) >0 & c('code', 'date', 'timestamp', 'close') %in% names (index) ) ) )
#   {
#     index [,timestamp_IND := timestamp ]
#     data = index[, .(code, date, timestamp_IND, close,timestamp, timestamp_vn)][order(code, date,timestamp_IND)]
#     # My.Kable.Min (data [order (-timestamp)])
#     # My.Kable (data [order (close)])
#     data = data [order (code, date, -timestamp)]
#     # data = data [close != 0]
#     data[ , ":="(rt = close/shift(close) - 1, lnrt = log(close/shift(close))), by = c("code", "date")]
#     data = data[!is.na(lnrt)]
#     max_tick = max(data[, .(n = .N), by = 'date']$n)
#     
#     # My.Kable(data)
#     
#     tick_by_day = round(24*60/5,0)
#     adjust = 250*tick_by_day
#     data = data[order(timestamp_IND)]
#     data = data [!is.na(lnrt)][order(date, timestamp_IND)]
#     # data [order (lnrt)]
#     data[, volatility := 100*sqrt(adjust)*roll_sd(lnrt, width = max_tick, min_obs = max_tick - 2 )]
#     data [, close_und := close]
#     data [, code_und := code]
#     data [, close  := volatility]
#     data [, code := paste0('INDVLI',code_und)]
#     data [, timestamp := NULL]
#     setnames (data , 'timestamp_IND', 'timestamp')
#     data [, volatility := NULL]
#     data [, rt := NULL]
#     data [, lnrt := NULL]
#     data = data [!is.na (close) & !is.na (timestamp)]
#     # My.Kable(data [order (-timestamp)], Nb = 10)
#     
#     DBL_RELOAD_INSREF()
#     data = merge (data [, -c('iso2','iso3','country','continent','name_und')],ins_ref [,.(code_und = code, iso2, iso3, country, continent, name_und = name)], all.x = T, by = 'code_und' ) 
#     data [, ':=' (type = 'IND', fcat = 'INDVLI')]
#     data [, name:=  paste ('IFRC/BEQ INTRADAY VOLATILITY', name_und)]
#     data [, hhmm := substr(timestamp, 12, 16)]
#     data = CLEAN_TIMESTAMP (data)
#     
#     data[, updated := SYS.TIME()]
#     data = CLEAN_TIMESTAMP(data)
#     data = data %>% select ('code', 'name', 'code_und', 'name_und', 'iso2','iso3', 'country', 'continent', 'date','timestamp', 'hhmm','close','close_und', everything())
#     # My.Kable(data [order (timestamp)] [,-c('iso2','iso3','continent', 'type','fcat')], Nb = 10)
#     My.Kable(unique(data [order (code,-timestamp)] [,-c('iso2','iso3','continent', 'type','fcat','name_und')], by = 'code') [order(-timestamp_vn)], Nb = 10)
#     
#     # if (nchar (To_Folder) * nchar (To_File) >0)
#     # {
#     #   DATA_OLD = CHECK_CLASS (try (CCPR_READRDS (To_Folder, To_File, ToKable = T) ) )
#     #   DATA_OLD = CLEAN_TIMESTAMP (DATA_OLD)
#     #   DATA_OLD = rbind (DATA_OLD, data, fill = T)
#     #   if (nrow (DATA_OLD) >0)
#     #   {
#     #     DATA_OLD = unique (DATA_OLD, by = c('code', 'date', 'timestamp')) [!is.na(code) & !is.na(close) & !is.na(date)& !is.na(timestamp)]
#     #     DATA_OLD = CLEAN_TIMESTAMP (DATA_OLD)
#     #     CCPR_SAVERDS ( DATA_OLD, To_Folder, To_File, ToSummary = T, SaveOneDrive = T)
#     #   }
#     # }
#     
#     DBL_INTEGRATE_INTRADAY  (data = data,
#                              Fr_Folder = '', Fr_File = '',
#                              To_Folder = Fr_Folder, To_File = To_File)
#     
#     if (runif (1,1,100) > 75)
#     {
#       DBL_INTEGRATE_INTRADAY  (data = data,
#                                Fr_Folder = '', Fr_File = '',
#                                To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = gsub ('.rds','_history.rds', To_File) )
#     }
#   }
#   
#   end = Sys.time ()
#   CATln_Border( paste('DURATION = ', Format.Number (difftime (end, start, units = 'secs'), 0) ) )
#   return(data)
# }

# ==================================================================================================
CHECK_LAST_CHANGE_ZERO = function(pData, ToRecaculate = F){
  # ------------------------------------------------------------------------------------------------
  # ToRecaculate = T
  if (ToRecaculate){
    pData = CALCULATE_CHANGE_RT_VARPC(pData)
  }
  pData = unique(pData, by = c('code','date'))[order(code,-date)]
  pData[, seq := seq.int(1, .N), by = 'code']
  pData$ToDelete = 0
  pData[seq == 1 & change == 0, ToDelete := 1]
  pData = pData[ToDelete == 0]
  pData$ToDelete = NULL
  pData$seq = NULL
  pData = unique(pData, by = c('code','date'))[order(code,date)]
  # My.Kable.Index(pData[order(date,code)])
  return(pData)
}
# ==================================================================================================
My.Kable.Index = function(pData, MinFields = c( 'type', 'fcacountry', 'iso2', 'source', 'codesource', 
                                                'code', 'name', 'date', 'timestamp_vn', 
                                                'close', 'pclose', 'rt','change','varpc'), Nb=5, Option='TB') {
  # ------------------------------------------------------------------------------------------------
  # pData = CCPR_READRDS(UData, 'download_ifrc_indvli_history.rds')
  # pData = CCPR_READRDS(UData, 'download_rts_stkhome_history.rds')
  CommonFields = intersect(MinFields,names(pData))
  switch(Option,
         'TB'  = {   My.Kable.TB(pData[, ..CommonFields], Nb=Nb) },
         'ALL' = {   My.Kable.All(pData[, ..CommonFields]) },
         'MIN' = {   My.Kable.Min(pData[, ..CommonFields]) }
  )
  
}

# # ==================================================================================================
# DBL_CCPR_SAVERDS = function (pData = data.table(), FileFolder = SData, FileName ='', Nb_repeat = 3, 
#                              SaveOneDrive = F, ToSave = F,  pSleep = 1,ToKable=F, ToSummary=F, ToPrompt=T)  {
#   # ------------------------------------------------------------------------------------------------
#   # SaveOneDrive=T, ToKable=F, ToSummary=F, ToPrompt=T
#   # pData=My_Data, FileFolder=SData, FileName='download_ssi_stkvn_ref_history.rds' , 
#   # SaveOneDrive=T, ToKable=F, ToSummary=F, ToPrompt=T
#   # SData
#   # Folder_INSREF = UData; File_INSREF ='EFRC_INS_REF.rds'; Nb_repeat = 3; ToRestore = F; pSleep = 10
#   Nb_try = 0
#   OK = F 
#   DATA_SAVE = data.table(pData)
#   UPDATED_DATA = ''
#   while (Nb_try <= Nb_repeat & !OK)
#   {
#     new_updated = SYS.TIME()
#     if ('updated' %in% names (DATA_SAVE)) {
#       DATA_SAVE[ updated == max (updated), updated := new_updated]
#     } else { DATA_SAVE[ , updated := new_updated] }
#     
#     DATA_INSREF = try(CCPR_SAVERDS(DATA_SAVE,FileFolder, FileName, ToSummary = T,   SaveOneDrive = SaveOneDrive))
#     IFRC_SLEEP(5)
#     UPDATED_DATA = DBL_SUMMARY_UPDATED(paste0(FileFolder, FileName))
#     
#     if (UPDATED_DATA == new_updated) { OK = T} else { IFRC_SLEEP(pSleep)}
#     Nb_try = Nb_try + 1
#   }
#   
#   
#   
#   CATln_Border(paste ( 'NB_TRY = ',Nb_try, ', NROW DATA = ', Format.Number(nrow(DATA_SAVE),0), '|', UPDATED_DATA))
#   
# }

# ==================================================================================================
DBL_CCPR_SAVERDS = function (pData = data.table(), FileFolder = SData, FileName ='', Nb_repeat = 3, 
                             SaveOneDrive = F, ToSave = F,  pSleep = 5,ToKable=F, ToSummary=T, ToPrompt=T,
                             ToSaveDate = (runif(1,1,100) < 0), SaveDate_Folder="S:/CCPR/DATA/DASHBOARD_LIVE/BACKUP/")  {
  # ------------------------------------------------------------------------------------------------
  # SaveOneDrive=T, ToKable=F, ToSummary=F, ToPrompt=T
  # pData=My_Data, FileFolder=SData, FileName='download_ssi_stkvn_ref_history.rds' , 
  # SaveOneDrive=T, ToKable=F, ToSummary=F, ToPrompt=T
  # SData
  # Folder_INSREF = UData; File_INSREF ='EFRC_INS_REF.rds'; Nb_repeat = 3; ToRestore = F; pSleep = 10
  Nb_try = 0
  OK = F 
  UPDATED_DATA = ''
  
  if (all(class(pData)!="try-error"))
  {
    DATA_SAVE = data.table(pData)
    if (nrow(DATA_SAVE)>0)
    {
      while (Nb_try <= Nb_repeat & !OK)
      {
        new_updated = SYS.TIME()
        if ('updated' %in% names (DATA_SAVE)) {
          new_updated = max (DATA_SAVE [!is.na(updated)]$updated )
          # DATA_SAVE[ updated == max (updated), updated := new_updated]
        } else { DATA_SAVE[ , updated := new_updated] }
        
        try(CCPR_SAVERDS(DATA_SAVE,FileFolder, FileName, ToSummary = ToSummary,   SaveOneDrive = SaveOneDrive))
        IFRC_SLEEP(pSleep)
        UPDATED_DATA = DBL_SUMMARY_UPDATED(paste0(FileFolder, FileName))
        
        if (UPDATED_DATA == new_updated) { OK = T} else { IFRC_SLEEP(pSleep)}
        Nb_try = Nb_try + 1
      }
      
      if (ToSaveDate)
      {
        FileName_Random = paste0(gsub(".rds","",FileName),'_',gsub("-","",Sys.Date()),"_",gsub(":","",substr(Sys.time(),12,16)),".rds")
        try(CCPR_SAVERDS(DATA_SAVE,SaveDate_Folder, FileName_Random, ToSummary = ToSummary,   SaveOneDrive = SaveOneDrive))
      }
    }else{ CATln_Border(paste ('NO DATA TO SAVE!!!')) }
  }else{ CATln_Border(paste ('ERROR DATA!!!')) }
  CATln_Border(paste ( 'NB_TRY = ',Nb_try, ', NROW DATA = ', Format.Number(nrow(DATA_SAVE),0), '|', UPDATED_DATA))
  
}

# ==================================================================================================
CCPR_READRDS_INSREF = function ( Folder_INSREF = SData, File_INSREF ='DBL_INS_REF.rds', Nb_repeat = 3, 
                                 ToRestore = F, ToSave = F,  pSleep = 10)  {
  # ------------------------------------------------------------------------------------------------
  # SData
  # Folder_INSREF = UData; File_INSREF ='EFRC_INS_REF.rds'; Nb_repeat = 3; ToRestore = F; pSleep = 10
  Nb_try = 0
  OK = F 
  DATA_INSREF = data.table()
  
  while (Nb_try <= Nb_repeat & !OK)
  {
    DATA_INSREF = CHECK_CLASS(try(CCPR_READRDS(Folder_INSREF, File_INSREF, ToKable = T, ToRestore = F)))
    if (nrow (DATA_INSREF) >0) { OK = T} else { IFRC_SLEEP(pSleep)}
    Nb_try = Nb_try + 1
  }
  UPDATED_INSREF = ''
  if (nrow (DATA_INSREF) > 0)
  {
    UPDATED_INSREF = DBL_SUMMARY_UPDATED(paste0(Folder_INSREF, File_INSREF))
  }
  
  CATln_Border(paste ( 'NB_TRY = ',Nb_try, ', NROW DATA = ', Format.Number(nrow(DATA_INSREF),0), '|', UPDATED_INSREF))
  
  if (nrow (DATA_INSREF) == 0)
  {
    list_file = as.data.table (list.files(Folder_INSREF,'*.rds'))
    list_file = list_file [grepl(paste0(gsub('.rds','',File_INSREF),'_2'),V1, ignore.case = T) & nchar (V1) == nchar(File_INSREF ) + 9] [order (-V1)]
    
    My.Kable (list_file)
    if (nrow (list_file) >0)
    {
      File_ToRestore = list_file [1] $V1
      CATln_Border(File_ToRestore)
      Data_ToRestore = CHECK_CLASS(try(CCPR_READRDS (Folder_INSREF, File_ToRestore) ))
      if (nrow (Data_ToRestore) >0)
      {
        DATA_INSREF = copy(Data_ToRestore)
      } else {
        DATA_INSREF = CHECK_CLASS(try(CCPR_READRDS(Folder_INSREF,File_INSREF, ToKable = T, ToRestore = T)))
      }
      My.Kable.INSREF (DATA_INSREF)
      
      if (ToSave & nrow (DATA_INSREF) >0)
      {
        CCPR_SAVERDS (DATA_INSREF, Folder_INSREF,File_INSREF, ToSummary = T, SaveOneDrive = T)
      }
    }
  }
  return (DATA_INSREF)
}

# ==================================================================================================
DBL_RELOAD_INSREF = function ( silent=T, ToForce=F, Nb_repeat =3) {
  # ------------------------------------------------------------------------------------------------
  # 2023-09-14
  # if (file.exists("U:/EFRC/DATA/")) { UData = "U:/EFRC/DATA/" } else { UData = 'S:/CCPR/DATA/' }
  # silent=T; ToForce=F; DBL = T
  
  if (ToForce)
  {
    if (file.exists(SData)) 
    { 
      CATln('Loading ..')
      # ins.ref = CCPR_READRDS(SData, 'DBL_INS_REF.rds', ToKable = T, ToRestore = F) 
      ins.ref = CCPR_READRDS_INSREF  ( Folder_INSREF = SData, File_INSREF ='DBL_INS_REF.rds', Nb_repeat = Nb_repeat, 
                                       ToRestore = F, ToSave = T,  pSleep = 10)
    }   else {
      CATln('Loading ..')
      # ins.ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = F) 
      ins.ref = CCPR_READRDS_INSREF  ( Folder_INSREF = UData, File_INSREF ='EFRC_INS_REF.rds', Nb_repeat = Nb_repeat, 
                                       ToRestore = F, ToSave = T,  pSleep = 10)
    }
    if (nrow (ins.ref) >0)
    {
      ins_ref = copy (ins.ref)
      assign("ins_ref", ins_ref, envir = .GlobalEnv)
    }
    
  } else {
    if (exists("ins_ref")) 
    { 
      if (!silent) 
      { CATln("INS_REF ALREADY LOADED") }
    } else { 
      # UData = SData
      CATln('Loading ..')
      if (file.exists(SData)) 
      { 
        # ins.ref = CCPR_READRDS(SData, 'DBL_INS_REF.rds', ToKable = T, ToRestore = F)
        ins.ref = CCPR_READRDS_INSREF  ( Folder_INSREF = SData, File_INSREF ='DBL_INS_REF.rds', Nb_repeat = Nb_repeat, 
                                         ToRestore = F, ToSave = T,  pSleep = 10)
      } else {
        # ins.ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = F)
        ins.ref = CCPR_READRDS_INSREF  ( Folder_INSREF = UData, File_INSREF ='EFRC_INS_REF.rds', Nb_repeat = Nb_repeat, 
                                         ToRestore = F, ToSave = T,  pSleep = 10)
      }
      if (nrow (ins.ref)>0)
      {
        ins_ref = copy(ins.ref)
        assign("ins_ref", ins_ref, envir = .GlobalEnv)
      }
      
    }
  }
  
}

# ==================================================================================================
CCPR_WRITE_SUMMARY_UPDATED = function(pData=data.table(ins_ref), pFileName, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T) {
  # ------------------------------------------------------------------------------------------------
  # xs = WRITE_SUMMARY(UData, "efrc_indexp_history.rds")
  # ToPrompt=T
  # pData = ins_ref
  if (nrow(pData)>0)
  {
    x.rds = pData
  } else {
    x.rds     = try(readRDS(pFileName))
  }
  
  if (all(class(x.rds)!='try-error') && nrow(x.rds)>0)
  {
    if (ToPrompt) {My.Kable.Min(x.rds)}
    if (ToPrompt) {str(x.rds)}
    if (!"codesource" %in% colnames(x.rds) & "ticker" %in% colnames(x.rds)) { 
      x.rds[, codesource:=as.character(ticker)]} 
    if (!"codesource" %in% colnames(x.rds)) { x.rds[, codesource:=NA]} else{ x.rds[, codesource:=as.character(codesource)]}
    if (!"source" %in% colnames(x.rds)) { x.rds[, source:=NA]} else{ x.rds[, source:=as.character(source)]}
    if (!"close" %in% colnames(x.rds)) { x.rds[, close:=as.numeric(NA)]}
    if ("code" %in% colnames(x.rds) & "codesource" %in% colnames(x.rds) & nrow(x.rds[!is.na(code)])==0) { 
      x.rds[, code:=as.character(codesource)]} 
    if (!"updated" %in% colnames(x.rds)) { 
      x.rds[, updated:=SYS.TIME()]} else {
        if (nrow (x.rds [!is.na (updated)]) ==0 ){x.rds [, updated := SYS.TIME()]} else {
          x.rds [is.na(updated), updated := SYS.TIME()]
        }
        x.rds [is.na(updated), updated := SYS.TIME()]
      }
    # My.Kable (x.rds [!is.na(updated),.(code, date, name, updated)])
    # My.Kable (x.rds [is.na(updated),.(code, date, name, updated)])
    
    setkey(x.rds, code, date)
    
    # my.data[,":="(nbdays=append(NA,diff(date))),by=list(code)]
    if (ToExclude)
    {  
      my.summary = x.rds[date<=Sys.Date(),.(start=date[1], date=date[.N], nb=.N, datelast=date[.N], last=close[.N], 
                                            nbdays=as.numeric(NA), source=source[.N], name="", type="", 
                                            codesource=codesource[.N], updated = updated[.N]), by='code']
    } else {
      my.summary = x.rds[,.( 
        start=date[1], date=date[.N], nb=.N, datelast=date[.N], 
        last=close[.N], nbdays=as.numeric(NA), source=source[.N],
        name="", type="", codesource=codesource[.N],updated = updated[.N]), by='code']
    }
    DBL_RELOAD_INSREF()
    my.summary = merge(my.summary[, -c('type', 'name', 'fcat')], ins_ref[, .(code, type, name=short_name, fcat)], all.x=T, by='code')
    my.summary = my.summary[order(-date, code)]
    if (ToPrompt) {My.Kable.TB(my.summary)}
    
    my.FileTXT  = gsub(".rds", "_updated_summary.txt", pFileName, ignore.case=T)
    CATln(my.FileTXT)
    my.summary = my.summary[order(-date)]
    if (ToPrompt) {My.Kable.TB(my.summary)}
    if (ToRemoveCodeNA) { my.summary= my.summary[!is.na(code)] }
    my.summary = unique (my.summary [ !is.na(updated) & !is.na(date)][ updated == max (updated)], by = c('date', 'updated') )
    fwrite(my.summary, my.FileTXT, col.names = T, sep="\t", quote = F)
    
    DATACENTER_LINE_BORDER(paste(my.FileTXT, ":", 
                                 min(my.summary[!is.na(start)]$start), 'to', max(my.summary[!is.na(date)]$date),
                                 ">>>", trimws(FormatNS(nrow(my.summary),0,12,"")), "/", 
                                 trimws(FormatNS(sum(my.summary$nb),0,16,"")), " = at", substr(as.character(Sys.time()),12,16)))
    return(my.summary)
  }
}

# ==================================================================================================
DBL_SUMMARY_UPDATED = function(pFileName = 'S:/CCPR/DATA/EFRS_INS_REF.rds', pOption ='MAX', ToBrowse=T, DateOnly=F)  {
  # ------------------------------------------------------------------------------------------------
  # pFileName = paste0(FileFolder, FileName)
  # pFileName = paste0(SData, "EFRC_INS_REF.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_ref.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_history.rds")
  # pFileName = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indbeq_volatility_intraday_history.rds')
  
  File_Summary = gsub(".rds", "_updated_summary.txt", pFileName, ignore.case=T)
  if (!file.exists(File_Summary))
  {
    File_Summary = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
  }
  datemax      = as.Date("1900-01-01")
  xDate        = datemax
  xUPDATED = "1900-01-01 00:00:00"
  if (file.exists(File_Summary))
  {
    Start.time = Sys.time()
    x = try(setDT(fread(File_Summary, sep='\t', fill=T)))
    End.time1  = Sys.time()
    difftime(End.time1, Start.time, units = 'secs')
    if (all(class(x)!='try-error') && nrow(x)>0)
    {
      # str(x)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="numeric", List_Fields=list("last", "nbdays", "nb", 'sample', 'home'), ToConvertSeparator=F)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list("type", "code", "source", "codesource",'updated'), ToConvertSeparator=F)
      if ("type" %in% names(x)) { x[, type:=as.character(type)]}
      
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="date", List_Fields=list("start", "end", "date", "datelast"), ToConvertSeparator=F)
      # x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list('updated'), ToConvertSeparator=F)
      if (DateOnly){ x[nchar(as.character(date))>10, date:=as.character(substr(date,1,10))]}
      x = x[nchar(as.character(date))==10][, date:=as.Date(date)]
      if ('updated' %in% names (x))
      {
        switch (pOption,
                'MAX' = {      xUPDATED = max(x[!is.na(updated)]$updated)},
                'MIN' = {      xUPDATED = min(x[!is.na(updated)]$updated)},
                {      xUPDATED = max(x[!is.na(updated)]$updated)}
        )
      } 
      
      End.time1  = Sys.time()
      difftime(End.time1, Start.time, units = 'secs')
    }
    
    # str(x)
  }
  # x = SUMMARY_DATE(gsub(".rds", "_summary.txt", pFileName, ignore.case=T))
  if (ToBrowse)
  {
    CATln(paste(FormatSS(pFileName, 85), FormatSS(xUPDATED, 12)))
    catrep('-',100)
  }
  return(xUPDATED)
}

# ==================================================================================================
SUMMARY_UPDATED = function(pFileName, pOption ='MAX', ToBrowse=T, DateOnly=T)  {
  # ------------------------------------------------------------------------------------------------
  # pFileName = paste0(UData, "download_EXC_stk_history.rds")
  # pFileName = paste0(UData, "download_EXC_stk_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_ref.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_history.rds")
  # pFileName = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indbeq_volatility_intraday_history.rds')
  
  File_Summary = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
  datemax      = as.Date("1900-01-01")
  xDate        = datemax
  
  if (file.exists(File_Summary))
  {
    x = try(setDT(fread(File_Summary, sep='\t', fill=T)))
    if (all(class(x)!='try-error') && nrow(x)>0)
    {
      # str(x)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="numeric", List_Fields=list("last", "nbdays", "nb", 'sample', 'home'), ToConvertSeparator=F)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list("type", "code", "source", "codesource",'updated'), ToConvertSeparator=F)
      if ("type" %in% names(x)) { x[, type:=as.character(type)]}
      
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="date", List_Fields=list("start", "end", "date", "datelast"), ToConvertSeparator=F)
      # x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list('updated'), ToConvertSeparator=F)
      if (DateOnly){ x[nchar(as.character(date))>10, date:=as.character(substr(date,1,10))]}
      x = x[nchar(as.character(date))==10][, date:=as.Date(date)]
      switch (pOption,
              'MAX' = {      xUPDATED = max(x[!is.na(updated)]$updated)},
              'MIN' = {      xUPDATED = min(x[!is.na(updated)]$updated)},
              {      xUPDATED = max(x[!is.na(updated)]$updated)}
      )
      
    }
    
    # str(x)
  }
  # x = SUMMARY_DATE(gsub(".rds", "_summary.txt", pFileName, ignore.case=T))
  if (ToBrowse)
  {
    CATln(paste(FormatSS(pFileName, 85), FormatSS(xUPDATED, 12)))
    catrep('-',100)
  }
  return(as.POSIXct(xUPDATED))
}

# ==================================================================================================
DBL_CALCULATE_INTRADAY_VOLATILITY_FROM_YAH = function (pCodesource = 'IBM', pInterval = '5m',  CODE = '', 
                                                       ToIntegrate = F, Folder_To = 'S:/CCPR/DATA/DASHBOARD_LIVE/', 
                                                       File_Day  = 'dbl_indbeq_volatility_intraday_day.rds', 
                                                       File_History  = 'dbl_indbeq_volatility_intraday_history.rds',
                                                       Hour_adjust = -4) {
  # ------------------------------------------------------------------------------------------------
  # My.Kable (index [[2]])
  # index = index [[2]]
  # data = VNI[, .(code, date, timestamp_vn, close)] [code == 'VNINDEX']
  
  
  index = DBL_DOWNLOAD_YAH_OHLC_INTRADAY( pCodesource = pCodesource, pInterval = pInterval, Hour_adjust = Hour_adjust)
  
  # switch(TZ,
  #        'VN' = {
  #          index[, timestamp_IND:= as.character(as.POSIXct(timestamp_loc , "%Y-%m-%d %H:%M:%S"))] 
  #        },
  #        'US' = {
  index[, timestamp_IND:= timestamp_loc]
  # })
  if (nchar (CODE) >0) { index [, code := CODE]} else { 
    DBL_RELOAD_INSREF()
    index = DBL_MERGE_DATASRC_CODE_BYCODESOURCE(pSource = 'YAH', index)
    ref1 = ins_ref [code == index[1]$code]
    My.Kable.INSREF (ref1)
    i.iso2 = ref1$iso2
    i.iso3 = ref1$iso3
    i.country = ref1$country
    i.continent = ref1$continent
    i.name = ref1$short_name
    i.type = 'IND'
    i.fcat = 'INDVLI'
  }
  data = index[, .(code, date, timestamp_IND, close,datetime)][order(code, date,timestamp_IND)]
  My.Kable (data [order (close)])
  
  data[ , ":="(rt = close/shift(close) - 1, lnrt = log(close/shift(close))), by = c("code", "date")]
  data = data[!is.na(lnrt)]
  max_tick = max(data[, .(n = .N), by = 'date']$n)
  # data [!is.finite(lnrt)] = as.numeric( NA)
  My.Kable(data)
  
  tick_by_day = round(24*60/5,0)
  adjust = 250*tick_by_day
  data = data[order(timestamp_IND)]
  data = data [!is.na(lnrt)][order(date, timestamp_IND)]
  data[, volatility := 100*sqrt(adjust)*roll_sd(lnrt, width = max_tick, min_obs = max_tick - 2 )]
  # data = data[order(code, -timestamp_IND)]
  data [, close_und := close]
  data [, code_und := code]
  data [, close  := volatility]
  data [, code := paste0('INDVLI',code_und)]
  # setnames (data, 'volatility', 'close')
  setnames (data, 'timestamp_IND', 'timestamp')
  data [, volatility := NULL]
  data [, rt := NULL]
  data [, lnrt := NULL]
  data = data [!is.na (close) & !is.na (timestamp)]
  My.Kable(data [order (-timestamp)], Nb = 10)
  data[, ':=' (iso2 = i.iso2, iso3 = i.iso3, country = i.country, continent = i.continent,timestamp=as.character(timestamp), fcat = i.fcat, name= paste ('IFRC/BEQ INTRADAY VOLATILITY', i.name))]
  data [, hhmm := substr(timestamp, 12, 16)]
  
  My.Kable(data [order (-timestamp)], Nb = 10)
  data[, updated := SYS.TIME()]
  
  if (ToIntegrate & (nchar(Folder_To)* nchar( File_Day)) >0 & nrow (data) >0) 
  {
    # file.remove (paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'IFRC_CCPR_INTRADAY_VOLATILITY_FROM_YAH_HISTORY.rds'))
    DATA_OLD = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_Day)))
    DATA_NEW = rbind (DATA_OLD, data, fill = T)
    DATA_NEW = unique (DATA_NEW, fromLast = T, by = c('code','date','timestamp'))
    # CCPR_SAVERDS (DATA_OLD, 'S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indbeq_volatility_day.rds')
    CCPR_SAVERDS (DATA_NEW, Folder_To, File_Day, ToSummary = T, SaveOneDrive = T)
    if (nchar (File_History) > 0) { 
      DATA_HISTORY = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_History)))
      DATA_DAY = CHECK_CLASS (try(CCPR_READRDS(Folder_To, File_Day)))
      DATA_NEW = rbind (DATA_HISTORY, DATA_DAY, data, fill = T)
      DATA_NEW = unique (DATA_NEW, fromLast = T, by = c('code','date','timestamp'))
      CCPR_SAVERDS (DATA_NEW, Folder_To, File_History, ToSummary = T, SaveOneDrive = T)
    }
    
  }
  
  return (data )
}

# ==================================================================================================
DBL_MERGE_DATASTD_BYCODE = function(pData, pOption='STD', ToKable=F) {
  # ------------------------------------------------------------------------------------------------
  # CATln("Merging STD ...")
  DBL_RELOAD_INSREF()
  switch(pOption,
         "SHORT" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat)], all.x=T, by='code', ignore.case=T)
         },
         "STD" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'indhome', 'stkhome', 'indsample', 'stksample', 'capiusd')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, indhome=as.numeric(indhome), 
                                     stkhome, indsample, stksample, capiusd)], all.x=T, by='code', ignore.case=T)
         },
         "FINAL" = {
           pData = merge(pData[, -c('provider', 'iso2', 'country', 'continent', 'name', 'type', 'fcat', 'scat', 'home', 'sample', 'isin')], 
                         ins_ref[, .(provider, code, iso2, country, continent, name=short_name, type, fcat, scat, home=as.numeric(home), sample=as.numeric(sample), isin)], 
                         all.x=T, by='code', ignore.case=T)
         },
         "CAPIUSD" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'indhome', 'stkhome', 'indsample', 'stksample', 'capiusd')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, indhome=as.numeric(indhome), 
                                     stkhome, indsample, stksample, capiusd)], all.x=T, by='code', ignore.case=T)
         },
         "ADVANCED" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'indhome', 'stkhome', "isin", 'symbol', 'provider', 'cur', 'capiusd', 
                                    'indsample', 'stksample')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, indhome=as.numeric(indhome), 
                                     stkhome, indsample, stksample, isin, symbol, provider, cur, capiusd)], all.x=T, by='code', ignore.case=T)
         }
  )
  # str(pData)
  pData[, name:=trimws(toupper(name))]
  pData = UPDATE_FIELD_HOME(pData)
  # library(data.table)
  # pData = as.data.table(pData)
  if ('provider' %in% names(pData)) {
    pData = pData %>% dplyr::select('provider', 'iso2', 'country', 'continent', 'type', 'name', 'code', 'date', everything())
  } else {
    pData = pData %>% dplyr::select('iso2', 'country', 'continent', 'type', 'name', 'code', 'date', everything())
  }
  if (ToKable) {  My.Kable.MaxCols(pData) }
  return(pData)
}

# ==================================================================================================
DBL_MERGE_DATASRC_CODE_BYCODESOURCE = function(pSource='BLG', pData) {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  xData = pData
  ParseFilter = paste0('!is.na(', tolower(pSource),')')
  ParseFields = paste0('.(codesource=', tolower(pSource), ',code)') 
  # dt_extract = dt_raw[eval(parse(text=pCondition))]
  xRef = ins_ref[eval(parse(text=ParseFilter)), eval(parse(text=ParseFields))]
  xData = merge(xData[, -('code')], xRef, all.x=T, by='codesource')
  return(xData)
}

# ==================================================================================================
DBL_DOWNLOAD_YAH_OHLC_INTRADAY = function(pCodesource="^VIX", pInterval="15m", ToKable=T, Hour_adjust = 0) {
  # ------------------------------------------------------------------------------------------------
  # pCodesource="^GSPC"; pInterval="5m"; ToKable=T; Hour_adjust = -4
  MyURL       = paste0("https://query1.finance.yahoo.com/v8/finance/chart/", pCodesource, "?region=US&lang=en-US&includePrePost=false&interval=", 
                       pInterval, "&range=5d&corsDomain=finance.yahoo.com&.tsrc=finance")
  rm(dt_json)
  x.combined  = data.table()
  dt_json  = jsonlite::fromJSON(MyURL)
  
  if (exists("dt_json"))
  {
    x = as.data.table(dt_json[[1]]$result$meta)
    hour_adjust = dt_json[[1]]$result$meta$gmtoffset/3600
    if (nchar (hour_adjust > 0)) {
      Hour_adjust = hour_adjust
    }
    # str(x)
    rCodesource = x[1]$symbol
    DATACENTER_LINE_BORDER(rCodesource)
    xtr = data.table(field = names(x), t(x))
    # My.Kable(xtr, Nb=nrow(xtr), HeadOnly = T)
    
    x = as.data.table(dt_json[[1]]$result$meta)
    
    x.timestamp  = as.data.table(dt_json[[1]]$result$timestamp)
    x.timestamp[, ID:=seq.int(1, nrow(x.timestamp))]
    
    if ("V1" %in% colnames(x.timestamp)) {setnames(x.timestamp, "V1", "timestamp")}
    
    x.quote      = dt_json[[1]]$result$indicators$quote
    # x.quote[[1]]$open
    
    x.open       = as.data.table(x.quote[[1]]$open)
    if (nrow(x.open)>2)
    {
      x.open[, ID:=seq.int(1, nrow(x.open))]
      setnames(x.open, "V1", "open")
      
      x.high       = as.data.table(x.quote[[1]]$high)
      x.high[, ID:=seq.int(1, nrow(x.high))]
      setnames(x.high, "V1", "high")
      
      x.low       = as.data.table(x.quote[[1]]$low)
      x.low[, ID:=seq.int(1, nrow(x.low))]
      setnames(x.low, "V1", "low")
      
      x.close       = as.data.table(x.quote[[1]]$close)
      x.close[, ID:=seq.int(1, nrow(x.close))]
      setnames(x.close, "V1", "close")
      
      # x.merge     = merge(x.timestamp, x.close, by="ID")
      # My.Kable(x.merge)
      
      x.combined = cbind(x.timestamp, x.open[, .(open)],  x.high[, .(high)],  x.low[, .(low)], x.close[, .(close)])
      # My.Kable(x.combined)
      x.combined[, datetime:=as.POSIXct(as.numeric(as.character(timestamp)),origin="1970-01-01",tz="GMT")]
      x.combined <- x.combined %>%   select("datetime", everything())
      x.combined[, codesource:=rCodesource]
      x.combined[, source:="YAH"]
      x.combined <- x.combined %>%   select("codesource", everything())
      
      DBL_RELOAD_INSREF ()
      insyah_ref = ins_ref[!is.na(yah)]
      x.combined = transform(x.combined, code=insyah_ref$code[match(codesource, insyah_ref$yah)])
      # x.combined = DBL_UPDATE_TRANSFORM(x.combined, "YAH")
      x.combined = DBL_MERGE_DATASRC_CODE_BYCODESOURCE (pSource='YAH', x.combined)
      x.combined[, date:=as.Date(datetime)]
      x.combined = x.combined[, -c("timestamp", "ID")]
      x.combined = DBL_MERGE_DATASTD_BYCODE(x.combined, 'ADVANCED')[!is.na(close)]
      # x.combined[, ':='(timestamp=as.character(datetime), datetime=as.character(datetime))]
      x.combined[, timestamp_loc := datetime + Hour_adjust*60*60]
      x.combined[, timestamp_vn := datetime + 7*60*60]
      x.combined[, datetime := timestamp_loc]
      x.combined[, timestamp := timestamp_loc]
      x.combined[, date:=as.Date(datetime)]
      x.combined[, timestamp_loc := NULL]
      if (pInterval=="1d") { x.combined = unique(x.combined[order(timestamp)], by = "date") }
      if (ToKable) { My.Kable.MaxCols(x.combined)}
    }
  }
  return(x.combined)
}

# ==============================================================================
DBL_MERGE_DATASRC_CODE_BYCODESOURCE = function(pSource='BLG', pData) {
  # ----------------------------------------------------------------------------
  xData = pData
  ParseFilter = paste0('!is.na(', tolower(pSource),')')
  ParseFields = paste0('.(codesource=', tolower(pSource), ',code)') 
  # dt_extract = dt_raw[eval(parse(text=pCondition))]
  xRef = ins_ref[eval(parse(text=ParseFilter)), eval(parse(text=ParseFields))]
  xData = merge(xData[, -('code')], xRef, all.x=T, by='codesource')
  return(xData)
}

# ==================================================================================================
CCPR_SAVE_INSREF = function(ins_ref, NbMinutes = 120) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_SAVE_INSREF(ins_ref, NbMinutes = 120)
  
  CATln_Border(paste('CCPR_SAVE_INSREF : ', NbMinutes))
  DBL_RELOAD_INSREF(ToForce = F)
  My.Kable.INSREF(ins_ref)
  
  TO_DO = CCPR_MONITOR_EXECUTION_SUMMARY(pOption='CCPR_SAVE_INSREF', pAction="COMPARE", NbSeconds=NbMinutes*60, ToPrint=T)
  if (TO_DO)
  {
    DBL_RELOAD_INSREF(ToForce = T)
    CCPR_SAVERDS(ins_ref, UData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    CCPR_SAVERDS(ins_ref, 'S:/R/DATA/', 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    TO_SAVE = CCPR_MONITOR_EXECUTION_SUMMARY(pOption='CCPR_SAVE_INSREF', pAction="SAVE", NbSeconds=0*60, ToPrint=T)
  } else {
    CATln_Border(paste('CCPR_SAVE_INSREF : ', NbMinutes, ' = ', 'SKIP'))
  }
}

# ==================================================================================================
TRAINEE.IFRC.UPLOAD.RDS.2023.OLD = function(l.host = "ifrc.vn", l.tablename, l.filepath, CheckField=T, ToPrint = F,
                                            ToForceUpload=F, ToForceStructure=F, AutoUpload = T)  {
  # ------------------------------------------------------------------------------------------------
  # l.host = "strategy.vnefrc.com"; l.tablename = "efrc_str_ifrclab_last"; l.filepath = paste0(UData,"strategy/efrc_str_ifrclab_last.rds")
  # l.host = "ccpr.vn"; l.tablename = "ccpr_indals_history"; l.filepath = paste0(UData,"ccpr_indals_history.rds")
  # l.host = "ccpr.vn"; l.tablename = "ccpr_indcur_history"; l.filepath = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ifrc_ccpr_investment_history.rds')
  
  # CheckField=T; ToPrint = T;  ToForceUpload=T; ToForceStructure=T
  # ToPrint = T
  if (AutoUpload){
    source(paste0(SDLibrary, "TRAINEE_INTRO.R"), echo=F)
    
    if (l.host %in% list('dashboard_live_dev','dashboard_live','dashboard_live_bat' ))
    {
      switch( DBL_Upload, 
              'DEV' = {Final_host = 'dashboard_live_dev' } ,
              'PRD' = {
                if (l.host == 'dashboard_live_bat')
                {  Final_host = 'dashboard_live_bat'} else {Final_host = 'dashboard_live'} 
              },
              {    Final_host = l.host  })
      
    } else {  Final_host = l.host}
    
  } else {  Final_host = l.host}
  CATln_Border(Final_host)
  # DBL_Upload
  
  DATACENTER_LINE_BORDER(paste('IFRC.UPLOAD.RDS = ', Final_host, ' >>>', l.tablename))
  if (ToForceUpload) { ToUploadAll=T } else { source("T:/R/CONFIG/UPLOAD_ALL.R", echo = F) }
  if (ToUploadAll)
  {
    ToUploadAll = T
    t1 = Sys.time()
    CATrp("Connecting...")
    conn = try(TRAINEE.IFRC.CONNEXTION.2023(Final_host),silent = T)
    # print(conn)
    if (all(class(conn)!="try-error"))
    {
      l.data = readRDS(l.filepath)
      if (!'updated' %in% names (l.data)) { l.data [, updated := SYS.TIME()]}
      # l.data = DBL_IND_EXCLUDE(l.data)
      check_table_exist = setDT(dbGetQuery(conn,statement = paste0('SHOW TABLES LIKE "',l.tablename, '"')))
      dbDisconnect(conn)
      
      if (nrow(check_table_exist)>0)
      {
        colnames(check_table_exist) = c("tablename")
        check_table_exist = check_table_exist[tablename == l.tablename]
      }
      nb = nrow(check_table_exist)
      CATln(paste('nb = ', nb))
      
      # try(dbDisconnect(conn),silent = T)
      if (nb == 1) 
      {
        if (ToForceStructure) { UPLOAD_STRUCTURE_RDS_TO_SQL.2023(FileRDS="", DataRDS=l.data, TableSQL=l.tablename, host=Final_host, ToForce=T) }
        if (CheckField)
        {
          conn = try(TRAINEE.IFRC.CONNEXTION.2023(Final_host),silent = T)
          CATrp("Read Table...")
          host_dt = dbReadTable(conn,l.tablename)
          host_dt = setDT(host_dt)
          ncols0  = colnames(host_dt)
          ncols   = setdiff(ncols0, "id")
          ncols   = (l.data[,colnames(l.data)[which(gsub(" ","\\.",colnames(l.data)) %in% ncols)]])
          l.data  = l.data[, ..ncols]
          try(dbDisconnect(conn),silent = T)
          CATln("Close connexion.")
          # My.Kable(l.data)
        }
        
        # if (nrow(l.data [!is.na(timestamp)])>0)
        # {
        #   l.data = l.data [!is.na(timestamp)]
        # }
        My.Kable.MaxCols(l.data)
        str(l.data)
        UPDATE_UPDATED (l.data)
        # if ('updated' %in% names(l.data)) { l.data[, updated:=as.character(updated)] }
        # if ('ord' %in% names(l.data)) { l.data[, ord:=as.numeric(ord)] }
        # # My_Data
        # LIST_NAME =  CCPR_LOAD_SQL_HOST (lhost = 'dashboard_live', pTableSQL = 'dbl_ind_mother', ToDisconnect=T, ToKable=T)
        # 
        # if ( 'name' %in% names (l.data))  {
        #   na.name   = l.data [is.na(name)] [order (code)] $code 
        #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
        # {l.data [is.na(name)] [order (code)] $name = LIST_NAME [code %in% na.name] [order (code)] $name }
        # }
        # 
        # if ( 'short_name' %in% names (l.data))  {
        #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
        #   {l.data [is.na(short_name)] [order (code)] $short_name = LIST_NAME [code %in% na.name] [order (code)] $short_name}
        #     
        # }
        
        x = IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023(Final_host, l.tablename, l.data)
        
      } else if (nb == 0) {
        conn = try(TRAINEE.IFRC.CONNEXTION.2023(Final_host),silent = T)
        LIST_NAME =  CCPR_LOAD_SQL_HOST (lhost = 'dashboard_live', pTableSQL = 'dbl_ind_mother', ToDisconnect=T, ToKable=T)
        # na.name   = l.data [is.na(name)] [order (code)] $code 
        # l.data [is.na(name)] [order (code)] $name = LIST_NAME [code %in% na.name] [order (code)] $name
        # if ( 'short_name' %in% names (l.data))  {
        #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
        #   {l.data [is.na(short_name)] [order (code)] $short_name = LIST_NAME [code %in% na.name] [order (code)] $short_name} 
        # }
        try(UPLOAD_STRUCTURE_RDS_TO_SQL.2023(FileRDS="", DataRDS=l.data, TableSQL=l.tablename, host=Final_host, ToForce=T)     )   
        x = IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023(Final_host, l.tablename, l.data)
        try(dbDisconnect(conn),silent = T)
        CATln("Close connexion.")
        
      }
      print(paste("IFRC.UPLOAD.RDS >>> path :", l.filepath, "| OK"))
    } else {
      # print(paste("IFRC.UPLOAD.RDS >>> path :", l.filepath, "| NOT OK"))
      CATln(paste0("CONNEXION NOT AVAILABLE"))
      try(dbDisconnect(conn),silent = T) 
    }
    printrep('.',100)
    if(ToPrint) {
      efrc.print.time("Elapsed time = ", t1)
    }
    try(dbDisconnect(conn),silent = T) 
  }
  try(dbDisconnect(conn),silent = T) 
  # try( dbDisconnect(dbListConnections(MySQL()) [[1]]) )
  x = dbListConnections(MySQL())
  if (length (x) > 1) { try( dbDisconnect(dbListConnections(MySQL()) [[1]]) )}
  
}

# ==================================================================================================
EPOCH_TO_DATE = function(xEpoch=1651671000, ConvertTo='CHARACTER')  {
  # ------------------------------------------------------------------------------------------------
  switch( ConvertTo,
          'CHARACTER' = {xRES = as.character(as.POSIXct(as.numeric(xEpoch), origin = "1970-01-01"))} ,
          'DATETIME'  = {xRES = as.POSIXct(as.numeric(xEpoch), origin = "1970-01-01")},
          'DATE'      = {xRES = as.Date(as.POSIXct(as.numeric(xEpoch), origin = "1970-01-01"))}
  )
  # if (ToPrint) { print(xRES)}
  return(xRES)
}

# ==================================================================================================
INSREF_ADD_MSCI_FRONTIER_PRICE_USD = function() {
  # ------------------------------------------------------------------------------------------------
  # INSREF_ADD_MSCI_FRONTIER_PRICE_USD()
  DBL_RELOAD_INSREF(ToForce = T)
  My.Kable.INSREF(ins_ref[type=='IND' & grepl('MSCI FRONTIER', name) & !grepl('IFRC', short_name)][order(name)])
  My.Kable.INSREF(ins_ref[code=='INDMSCIFRONTIER'])
  INSREF_ONE   = ins_ref[code=='INDMXWO']
  INSREF_FINAL = INSREF_ONE[, .(type, fcat, scat, active=1, iso2, iso3, code='INDMSCIFRONTIER', yah='^700023-USD-STRD', prtr='PR', cur='USD',
                                name = 'MSCI FRONTIER PR (USD)', short_name='MSCI FRONTIER PR (USD)')]
  
  if (nrow(ins_ref[code=='INDMSCIFRONTIER'])==0)
  {
    ins_ref = rbind(ins_ref[!code %in% INSREF_FINAL$code], INSREF_FINAL, fill=T)
    My.Kable.INSREF(ins_ref)
    
    CCPR_SAVERDS(ins_ref, UData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    CCPR_SAVERDS(ins_ref, 'S:/R/DATA/', 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    DBL_RELOAD_INSREF(ToForce = T)
  }
}

# ==================================================================================================
INSREF_ADD_MSCI_WORLD_PRICE_USD = function() {
  # ------------------------------------------------------------------------------------------------
  # INSREF_ADD_MSCI_WORLD_PRICE_USD()
  DBL_RELOAD_INSREF(ToForce = T)
  My.Kable.INSREF(ins_ref[type=='IND' & grepl('MSCI WORLD', name) & !grepl('IFRC', short_name)][order(name)])
  My.Kable.INSREF(ins_ref[code=='INDMSCIWORLD'])
  INSREF_ONE   = ins_ref[code=='INDMXWO']
  INSREF_FINAL = INSREF_ONE[, .(type, fcat, scat, active=1, iso2, iso3, code='INDMSCIWORLD', yah='^990100-USD-STRD', prtr='PR', cur='USD',
                                name = 'MSCI WORLD PR (USD)', short_name='MSCI WORLD PR (USD)')]
  if (nrow(ins_ref[code=='INDMSCIWORLD'])==0)
  {
    ins_ref = rbind(ins_ref[!code %in% INSREF_FINAL$code], INSREF_FINAL, fill=T)
    My.Kable.INSREF(ins_ref)
    # ins_ref = rbind(ins_ref, INSREF_FINAL, fill=T)
    # DBL_CCPR_SAVERDS(ins_ref, UData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    
    DBL_CCPR_SAVERDS (pData = ins_ref,  UData, 'efrc_ins_ref.rds', Nb_repeat = 3, SaveOneDrive = T, ToSave = T,  pSleep = 10)
    DBL_CCPR_SAVERDS (pData = ins_ref, 'S:/R/DATA/', 'efrc_ins_ref.rds', Nb_repeat = 3, SaveOneDrive = T, ToSave = T,  pSleep = 10)
    DBL_CCPR_SAVERDS (pData = ins_ref, 'S:/CCPR/DATA/', 'efrc_ins_ref.rds', Nb_repeat = 3, SaveOneDrive = T, ToSave = T,  pSleep = 10)
    
    # DBL_CCPR_SAVERDS(ins_ref, 'S:/R/DATA/', 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    # DBL_CCPR_SAVERDS(ins_ref, 'S:/CCPR/DATA/', 'DBL_INS_REF.rds', ToSummary = T, SaveOneDrive = T)
    DBL_RELOAD_INSREF(ToForce = T)
  }
}

# ====================================================================================================
DOWNLOAD_ENTRADE_INDEX_INTRADAY = function(type = "index",codesource = 'VN30', code = 'INDVN30', NbMinutes   = 11*365*24*60, OffsetDays  = 0,
                                           Save_folder = 'S:/STKVN/INDEX_2024/', Save_file = 'DOWNLOAD_ENT_VN30_INTRADAY_PRICES.RDS',
                                           Save_history = 'DOWNLOAD_ENT_INDVN_INTRADAY_HISTORY.RDS',
                                           pInterval = '1') {
  # ------------------------------------------------------------------------------------------------
  # updated = 2024-08-13 09:10
  # 1 = 1MIN; 5 = 5MIN; 1D = DAILY
  
  End.time  = round(as.numeric(as.POSIXct(Sys.time())),0) - (OffsetDays*24*60*60 - 1)
  EPOCH_TO_DATE(xEpoch=End.time, ConvertTo='CHARACTER')
  
  Start.time    = round(End.time -  NbMinutes*60, 0)
  EPOCH_TO_DATE(xEpoch=Start.time, ConvertTo='CHARACTER')
  
  pURL =  paste0('https://services.entrade.com.vn/chart-api/v2/ohlcs/',type,'?from=', Start.time, '&to=', End.time, '&symbol=',codesource,'&resolution=',pInterval)
  CATln_Border(pURL)
  rm(x)
  x = jsonlite::fromJSON(pURL)
  xData = as.data.table(x)
  My.Kable(xData)
  
  if (nrow(xData)>1)
  {
    Final_Data = xData [, .(timestamp_vn=7*60*60 + as.POSIXct(as.numeric(t) , "%Y-%m-%d %H:%M:%S"),
                            open=o,
                            high=h,
                            low=l,
                            close=c,
                            volume = v
    )]
    Final_Data[ , hhmmss := substr(as.character(timestamp_vn),11, 16)]
    Final_Data[ , date := as.Date(timestamp_vn)]
    Final_Data[ , source := 'ENTRADE']
    Final_Data[, code := code]
    Final_Data[, codesource := codesource]
    Final_Data[, ticker := codesource]
    if (type == 'index') {    Final_Data [, type := 'IND']} else  {    Final_Data [, type := 'STK']} 
    
    Final_Data [, timestamp := as.character (timestamp_vn)]
    Final_Data [, timestamp_vn := as.character (timestamp_vn)]
    My.Kable(Final_Data[order(date, hhmmss)])
    ref1 = ins_ref [code == Final_Data[1]$code]
    My.Kable.INSREF (ref1)
    i.iso2 = ref1$iso2
    i.iso3 = ref1$iso3
    i.country = ref1$country
    i.continent = ref1$continent
    i.name = ref1$name
    i.fcat = ref1$fcat
    Final_Data[, ':=' (iso2 = i.iso2, iso3 = i.iso3, country = i.country, continent = i.continent,timestamp=as.character(timestamp_vn), fcat = i.fcat, name=  i.name)]
    
    if (nchar(Save_folder)*nchar(Save_file)>0)
    {
      CCPR_SAVERDS(Final_Data, Save_folder, Save_file, ToSummary = T)
      if(nchar(Save_history)>0)
      {
        data_history = CCPR_READRDS(Save_folder, Save_history, ToKable = T)
        data_history = rbind(data_history,Final_Data,fill = T)
        data_history = unique(data_history, by = c("code","timestamp_vn"))
        CCPR_SAVERDS(data_history, Save_folder, Save_history, ToSummary = T, SaveOneDrive = T)
      }
    }
    
    
  }
  return(Final_Data)
  
}

# ====================================================================================================
DOWNLOAD_ENTRADE_INDEX_DAY = function(type = "index",codesource = 'VN30', code = 'INDVN30', NbMinutes   = 100*365*24*60, OffsetDays  = 0,
                                      Save_folder = 'S:/STKVN/INDEX_2024/', Save_file = 'DOWNLOAD_ENT_VN30_DAY_PRICES.RDS',
                                      Save_history = 'DOWNLOAD_ENT_INDVN_DAY_HISTORY.RDS'){
  # ------------------------------------------------------------------------------------------------
  
  
  End.time  = round(as.numeric(as.POSIXct(Sys.time())),0) - (OffsetDays*24*60*60 - 1)
  EPOCH_TO_DATE(xEpoch=End.time, ConvertTo='CHARACTER')
  
  Start.time    = round(End.time -  NbMinutes*60, 0)
  EPOCH_TO_DATE(xEpoch=Start.time, ConvertTo='CHARACTER')
  
  pURL =  paste0('https://services.entrade.com.vn/chart-api/v2/ohlcs/',type,'?from=', Start.time, '&to=', End.time, '&symbol=',codesource,'&resolution=1D')
  CATln_Border(pURL)
  rm(x)
  x = jsonlite::fromJSON(pURL)
  xData = as.data.table(x)
  My.Kable(xData)
  
  if (nrow(xData)>1)
  {
    Final_Data = xData [, .(timestamp_vn=7*60*60 + as.POSIXct(as.numeric(t) , "%Y-%m-%d %H:%M:%S"),
                            open=o,
                            high=h,
                            low=l,
                            close=c,
                            volume = v
    )]
    # Final_Data[ , hhmmss := substr(as.character(timestamp_vn),11, 16)]
    Final_Data[ , date := as.Date(timestamp_vn)]
    Final_Data[ , source := 'ENTRADE']
    Final_Data[, code := code]
    Final_Data[, codesource := codesource]
    Final_Data[, ticker := codesource]
    Final_Data$timestamp_vn = NULL
    My.Kable(Final_Data[order(date)])
    
    if (nchar(Save_folder)*nchar(Save_file)>0)
    {
      CCPR_SAVERDS(Final_Data, Save_folder, Save_file, ToSummary = T)
      if(nchar(Save_history)>0)
      {
        data_history = CCPR_READRDS(Save_folder, Save_history, ToKable = T)
        data_history = rbind(data_history,Final_Data,fill = T)
        data_history = unique(data_history, by = c("code","date"))
        CCPR_SAVERDS(data_history, Save_folder, Save_history, ToSummary = T, SaveOneDrive = T)
      }
    }
    
    
  }
  return(Final_Data)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VND_VIETNAM_INDEX_BY_CODE = function(pCode = 'VNINDEX', CodeInt='INDVNINDEX'){
  # ------------------------------------------------------------------------------------------------
  Data_List = list()
  ToContinu = T
  k = 1
  while (ToContinu)
  {
    pURLk = paste0('https://finfo-api.vndirect.com.vn/v4/vnmarket_prices?sort=date&q=code:',pCode,'~date:gte:2000-07-29~date:lte:',Sys.Date(),'&size=100&page=',k)
    CATrp(pURLk)
    x = try(jsonlite::fromJSON(pURLk))
    if (length(x$data)>0)
    {
      XData = try(as.data.table(x$data))
      if (all(class(XData)!='try-error'))
      {
        XData = CLEAN_COLNAMES(XData)
        Final_Data = XData[, .(source='VND', codesource=pCode, ticker=pCode,
                               date      = as.Date(date), 
                               open      = as.numeric(open),
                               high      = as.numeric(high),
                               low       = as.numeric(low),
                               close_adj = as.numeric(close),
                               close=as.numeric(close),
                               change=as.numeric(change ),
                               varpc=as.numeric(pctchange),
                               volume=as.numeric(nmvolume),
                               turnover=as.numeric(nmvalue)
        )]
        My.Kable.TB(Final_Data)
        Data_List[[k]] = Final_Data
      } else {
        ToContinu = F
      }
    } else {
      ToContinu = F
    }
    k = k+1
  }  
  CATln(pURLk); CATln('')
  Data_All = rbindlist(Data_List, fill=T)
  if (nrow(Data_All)>0)
  {
    Data_All = Data_All[order(date)]
    Data_All[, reference:=close-change]
    Data_All[, rt:=change/reference]
    Data_All[, codesource:=toupper(codesource)]
    Data_All[, code:=toupper(CodeInt)]
    My.Kable.TB(Data_All)
  } else {
    Data_All = data.table()
  }
  return(Data_All)
}


# ==================================================================================================
DOWNLOAD_STB_INDEX = function(codesource = "HOSTC",  code = "INDVNINDEX", pagemax = 10, Save_folder = 'S:/STKVN/INDEX_2024/', Save_file = 'DOWNLOAD_STB_VNI_PRICES.RDS')  {
  # ------------------------------------------------------------------------------------------------
  ok = TRUE
  # pagemax = 10
  mindate = Sys.Date()
  all.data = data.table()
  nr = 0
  while (ok)
  {
    nr = nr + 1
    CATln_Border(nr)
    xdate = format(mindate,'%m/%d/%Y')
    # pURL = 'http://en.stockbiz.vn/HistoricalIndices.aspx?Symbol=HOSTC&Date=8/25/2000'
    pURL = paste0('http://en.stockbiz.vn/HistoricalIndices.aspx?Symbol=',codesource,'&Date=',xdate)
    content  = rvest::read_html(pURL)
    tables   = content %>% html_table(fill = TRUE)
    # x = setDT (tables [[35]]),
    if (length(tables)>= 35)
    {
      x = setDT (tables [[35]])
      
      x1 = x[1, ]
      x.data = x[-1,]
      
      final.data = x.data[, .(date = as.Date(X1, '%m/%d/%Y'), close = as.numeric(gsub(',', '', X2)),
                              change = as.numeric(word(X3, 1,1, '[(]')),
                              varpc = as.numeric(gsub('[%)]', '', word(X3, 2,2, '[(]'))))][!is.na(date)]
      final.data[close == change, ':=' (change = as.numeric(NA), varpc = as.numeric(NA))]
      
      My.Kable(final.data)
      all.data = rbind(all.data,final.data,fill = T)
      mindate = min(final.data$date)
      if(nrow(final.data)==1)
      {
        ok = F
      }
      if(nr > pagemax)
      {
        ok = F
      }
    } else {
      
      ok = F
    }
  }
  
  # xdate = format(mindate,'%m/%d/%Y')
  all.data[, code := code]
  all.data[, source := 'STB']
  all.data[, codesource := codesource]
  
  all.data = CALCULATE_CHANGE_RT_VARPC(all.data)
  
  CATln_Border('FINAL')
  all.data = MERGE_DATASTD_BYCODE(all.data, pOption='FINAL')
  My.Kable(all.data[order(date)])
  
  if (nchar(Save_folder)*nchar(Save_file)>0)
  {
    CCPR_SAVERDS(all.data, Save_folder, Save_file, ToSummary = T)
  }
  return(all.data)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_INDVN_BY_SOURCE = function(source = 'CAF', Save_Folder = 'S:/STKVN/INDEX_2024/', ToIntergrate = F){
  # ------------------------------------------------------------------------------------------------
  # pCode = 'hnx-index'
  switch (source,
          'CAF' = {
            list_index = list('VNINDEX', 'HNX-INDEX', 'VN30INDEX', 'HNX30-INDEX')
            xList = list()
            for (i in 1:length(list_index)){
              pCode = list_index[[i]]
              switch(pCode,
                     'HNX-INDEX'   = {code = 'INDVHINDEX'},
                     'HNX30-INDEX' = {code = 'INDHNX30'},
                     'VN30INDEX'   = {code = 'INDVN30'},
                     {code = paste0('IND',pCode)})
              CAF = TRAINEE_DOWNLOAD_CAF_INDVN_PRICES_BY_CODE(pCodesource = pCode, CodeInt = code) 
              if (all(class(CAF) != 'try-error')){
                xList[[i]] = CAF
              }
            }
            Final_Data = rbindlist(xList, fill = T)
            DATA_OLD = CCPR_READRDS(UData, 'DOWNLOAD_CAF_INDVN_PRICES_HISTORY.rds', ToKable = T)
            Final_Data = unique(rbind(DATA_OLD[code %in% list('INDVHINDEX','INDHNX30','INDVN30','VNINDEX')], Final_Data, fill=T), by=c('code', 'date'), fromLast = T)
          },
          'FANT' = {
            list_index = list('VNINDEX', 'HNXINDEX', 'VN30', 'HNX30')
            # pCode = 'HNXINDEX'
            xList = list()
            for (i in 1:length(list_index)){
              pCode = list_index[[i]]
              switch(pCode,
                     'HNXINDEX'   = {code = 'INDVHINDEX'},
                     {code = paste0('IND', pCode)})
              FANT = TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE (pCodesource = pCode, Starttime=8, STOCK = F, CodeInt=code,  merge_ins_ref = F)
              if (all(class(FANT) != 'try-error')){
                xList[[i]] = FANT
              }
            }
            Final_Data = rbindlist(xList, fill = T)
          },
          'VND' = {
            list_index = list('VNINDEX', 'HNX-INDEX', 'VN30', 'HNX30-INDEX')
            # pCode = 'HNXINDEX'
            xList = list()
            for (i in 1:length(list_index)){
              pCode = list_index[[i]]
              switch(pCode,
                     'HNX-INDEX'   = {code = 'INDVHINDEX'},
                     'HNX30-INDEX' = {code = 'INDHNX30'},
                     'VN30'   = {code = 'INDVN30'},
                     {code = paste0('IND',pCode)})
              VND = TRAINEE_DOWNLOAD_VND_VIETNAM_INDEX_BY_CODE (pCode = pCode, CodeInt = code)
              if (all(class(FANT) != 'try-error')){
                xList[[i]] = VND
              }
            }
            Final_Data = rbindlist(xList, fill = T)
          },
          'STB' = {
            Mydata = DOWNLOAD_STB_INDEX(codesource = "HOSTC",  code = "INDVNINDEX", pagemax = 50000, Save_folder = 'S:/STKVN/INDEX_2024/', Save_file = 'DOWNLOAD_STB_VNI_PRICES.RDS')
            Mydata = DOWNLOAD_STB_INDEX(codesource = "HASTC",  code = "INDVHINDEX", pagemax = 50000, Save_folder = 'S:/STKVN/INDEX_2024/', Save_file = 'DOWNLOAD_STB_HNX_PRICES.RDS')
            
            try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = Save_Folder, File_Fr     = 'DOWNLOAD_STB_VNI_PRICES.RDS',
                                                                      Folder_To   = Save_Folder, File_To     = 'DOWNLOAD_STB_INDVN_PRICES.RDS',
                                                                      pCondition  = '',
                                                                      RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>50)))
            
            try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = Save_Folder, File_Fr     = 'DOWNLOAD_STB_HNX_PRICES.RDS',
                                                                      Folder_To   = Save_Folder, File_To     = 'DOWNLOAD_STB_INDVN_PRICES.RDS',
                                                                      pCondition  = '',
                                                                      RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>50)))
            
          }
  )
  if (source != 'STB'){
    Final_Data = UPDATE_UPDATED(Final_Data)
    CCPR_SAVERDS(Final_Data, Save_Folder ,paste0('DOWNLOAD_',source,'_INDVN_PRICES.rds'), ToSummary = T, SaveOneDrive = T)
    if (CHECK_TIMEBETWEEN('17:00', '23:00') | ToIntergrate){
      if (file.exists(paste0(Save_Folder, paste0('DOWNLOAD_',source,'_INDVN_PRICES_HISTORY.rds')))){
        DATA_OLD = CCPR_READRDS(Save_Folder, paste0('DOWNLOAD_',source,'_INDVN_PRICES_HISTORY.rds'), ToKable = T, ToRestore = T)
        DATA_DAY = CCPR_READRDS(Save_Folder, paste0('DOWNLOAD_',source,'_INDVN_PRICES.rds'), ToKable = T, ToRestore = T)
        
        DATA_OLD = unique(rbind(DATA_OLD, DATA_DAY, fill=T), by=c('code', 'date'), fromLast = T)
        CCPR_SAVERDS(DATA_OLD, Save_Folder ,paste0('DOWNLOAD_',source,'_INDVN_PRICES_HISTORY.rds'), ToSummary = T, SaveOneDrive = T)
      } else {
        CCPR_SAVERDS(Final_Data, Save_Folder ,paste0('DOWNLOAD_',source,'_INDVN_PRICES_HISTORY.rds'), ToSummary = T, SaveOneDrive = T)
      }
    }
  }
}

# ==================================================================================================
CALCULATE_CHANGE_RT_VARPC = function(data.all) { 
  # ------------------------------------------------------------------------------------------------
  data.all = unique(data.all, by = c('code','date'))
  data.all = data.all[order(code, date)]
  data.all[substr(code,1,3) != 'STK', close_adj := close]
  if ('close_adj' %in% names(data.all)){
    data.all[, change := close_adj - shift(close_adj), by = 'code']
    data.all[, rt := close_adj / shift(close_adj) - 1, by = 'code']
    data.all[, varpc:= 100*rt]
  } 
  # else {
  #   data.all[, change := close - shift(close), by = 'code']
  #   data.all[, rt := close / shift(close) - 1, by = 'code']
  #   data.all[, varpc:= 100*rt]
  # }
  
  return(data.all)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_C68_STKVN_PRICES_INTRADAY_BY_CODE = function(pCode = 'VND'){
  # ------------------------------------------------------------------------------------------------
  try(DBL_RELOAD_INSREF())
  Final_Data = data.table()
  pURL       = paste0('https://www.cophieu68.vn/quote/summary.php?id=', tolower(pCode))
  CATln(''); CATln_Border(pURL)
  content    = try(rvest::read_html(pURL))
  
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    if (length(tables)>=4)
    {
      LastTrading = CCPR_LAST_TRADING_DAY_VN(max(9,hour(Sys.time())), ToPrompt = T)
      xData       = as.data.table(tables[[4]])
      # My.Kable(xData)
      Final_Data = xData[, .(source='C68', codesource=pCode, code=paste0('STKVN', pCode),
                             date         = LastTrading, timestamp=paste0(X1,':00'), 
                             last         = 1000*as.numeric(gsub(',','', X2)),
                             change       = 1000*as.numeric(gsub(',','', X3)),
                             last_volume  = 1000*as.numeric(gsub(',','', X4)),
                             cumul_volume = 1000*as.numeric(gsub(',','', X5))
      )][!is.na(last)]
      My.Kable.TB(Final_Data)
    }
  }
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_PRICES_INTRADAY_BY_CODE = function(pCode="VIC", pDate=gsub ('/', '%2F', format.Date(as.Date(SYSDATETIME(9)-1), '%d/%m/%Y')), CreateBlank=T) {
  # ------------------------------------------------------------------------------------------------
  # x = DOWNLOAD_CAF_STKVN_INTRADAY_DAY(pCode="VIC", pDate=format.Date(as.Date(SYSDATETIME(9)), '%d/%m/%Y'), CreateBlank=T)
  # pDate    = format.Date(as.Date(Sys.Date()-250), '%d/%m/%Y')
  
  # pURL     = 'https://s.cafef.vn/ajax/khoplenh.aspx?order=time&dir=up&symbol=VNM&date=27%2F06%2F2023'
  Final_Data = data.table()
  pURL     = paste0('https://s.cafef.vn/ajax/khoplenh.aspx?order=time&dir=up&symbol=', pCode, '&date=',pDate)
  CATln_Border(pURL)
  content  = rvest::read_html(pURL)
  tables   = content %>% html_table(fill = TRUE)
  xData    = as.data.table(tables[[1]])
  if (ncol(xData)==5 && nrow(xData)>0)
  {
    xData    = CLEAN_COLNAMES(xData)
    Final_Data = xData[, .(codesource=pCode, code=paste0('STKVN', pCode), source='CAF', 
                           date=as.Date(gsub('%2F','/',pDate), '%d/%m/%Y'), time=x1, volume=x3, volume_total=as.numeric(gsub(',','', x4)),
                           last=1000*as.numeric(gsub(',','', word(x2, 1, 1))), 
                           change=1000*as.numeric(gsub(',','', word(x2, 2, 2))), 
                           varpc=as.numeric(gsub(',','', gsub('\\(|)|%','', word(x2, 3, 3)))) )]
    My.Kable.TB(Final_Data)
  } else { 
    if (CreateBlank) {
      Final_Data = data.table[, .(codesource=pCode, code=paste0('STKVN', pCode), source='CAF', 
                                  date=as.Date(pDate, '%d/%m/%Y'))]
      My.Kable.TB(Final_Data)
    }
  }
  return(Final_Data)
}

# ==================================================================================================
TELEGRAM_DOWNLOAD_BY_CODE = function(pCode = '^GSPC', RemoveNA = T, IntergrateHistory=F) {
  # ------------------------------------------------------------------------------------------------
  x = try(FINAL_QUICK_DOWNLOAD_YAH_INTRADAY_BY_CODE(pCode=pCode, xInterval="1m", xRange="5d"))
  x.Intraday = x[[2]]
  x.Intraday[, timestamp_utc:=as.character(ymd_hms(timestampvn) - 7*60*60)]
  x.Intraday[, timestamp_cdt:=as.character(ymd_hms(timestamp_utc) - 5*60*60)]
  x.Intraday[, date:=as.Date(timestamp_cdt)]
  x.Intraday = x.Intraday[!is.na(date)]
  MaxDate = max(x.Intraday[!is.na(date)]$date)
  xDay = unique(x.Intraday[order(date, -timestamp_cdt)], by=c('codesource', 'date'))
  xDay[, pclose:=shift(close)]
  xDay[, varpc:=100*(close/shift(close)-1)]
  # My.Kable.All(xDay[, .(code, date, close, pclose, varpc)])
  x.Intraday = merge(x.Intraday[, -c('pclose')], xDay[, .(date, pclose)], all.x = T, by='date')
  x.Intraday[, ":="(change=close-pclose,varpc=100*(close/pclose-1))]
  x.Intraday = UPDATE_UPDATED(x.Intraday)
  My.Kable(x.Intraday[, .(codesource, name, date, timestampvn, timestamp_utc, timestamp_cdt, close, pclose, varpc)][!is.na(pclose)])
  if (RemoveNA)
  {
    x.Intraday = x.Intraday[!is.na(pclose)]
  }
  # My.Kable.All(x.Intraday[date==MaxDate][, .(code, codesource, name, date, timestampvn, timestamp_utc, timestamp_cdt, close, pclose, varpc, updated)])
  
  if (IntergrateHistory)
  {
    File_Name = 'TELEGRAM_INTRADAY_HISTORY.rds'
    Data_Old  = DBL_CCPR_READRDS('S:/TELEGRAM/', File_Name, ToKable = T, ToRestore = T)
    Data_Old  = rbind(Data_Old, x.Intraday, fill=T)
    Data_Old  = unique(Data_Old, by=c('codesource', 'timestamp_utc'))
    if (RemoveNA)
    {
      Data_Old = Data_Old[!is.na(pclose)]
    }
    # My.Kable.TB(Data_Old[, .(code, codesource, name, date, timestampvn, timestamp_utc, timestamp_cdt, close, pclose, varpc, updated)][order(timestamp_utc)])
    DBL_CCPR_SAVERDS(Data_Old, 'S:/TELEGRAM/', File_Name, ToSummary = T, SaveOneDrive = T)
  }
  
  Data_Day  = DBL_CCPR_READRDS('S:/TELEGRAM/', "TELEGRAM_INTRADAY_DAY.rds", ToKable = T, ToRestore = T)
  Data_Day  = rbind(Data_Day[!codesource %in% x.Intraday$codesource], x.Intraday, fill=T)
  Data_Day  = unique(Data_Day, by=c('codesource', 'timestamp_utc'))
  if (RemoveNA)
  {
    Data_Day = Data_Day[!is.na(pclose)]
  }
  DBL_CCPR_SAVERDS(Data_Day, 'S:/TELEGRAM/', "TELEGRAM_INTRADAY_DAY.rds", ToSummary = T, SaveOneDrive = T)
  
  DBL_CCPR_SAVERDS(unique(Data_Day[!is.na(close),.(code,codesource,name,timestamp,timestamp_loc,timestampvn,pclose,close,change,varpc,updated)][order(-timestampvn)],by="codesource"),
                   paste0("S:/TELEGRAM/"), "TELEGRAM_LAST.rds")
  # CCPR_SAVERDS(unique(Data_Old[,.(code,name,timestamp_cdt,timestampvn,pclose,close,change,varpc)][order(-timestampvn)],by="code"),
  #              paste0("S:/SHINY/REPORT/TELEGRAM_INTRADAY/"), "TELEGRAM_INTRADAY.rds")
  # try(TRAINEE_CONVERT_FILE_RDS_TO_FST(pData = data.table(), File_Folder = paste0("S:/SHINY/REPORT/TELEGRAM_INTRADAY/"),
  #                                     File_Name =  "TELEGRAM_INTRADAY.rds", FST_Folder = ''))
  
  return (x.Intraday)
}

# ==================================================================================================
FINAL_QUICK_DOWNLOAD_YAH_INTRADAY_BY_CODE = function(pCode='^GSPC', xInterval="5m", xRange="1d") {
  # DOWNLOAD_YAH_INS_INTRADAY_LAST
  # pCode='^N225' ; xInterval="5m"; xRange="5d"
  # xFrequency: 1m, 2m, 5m, 15m, 30m, 60m, 90m, 1h, 1d, 5d, 1wk, 1mo, 3mo
  # Range: !dm %d
  
  # -----------------------------------------------------------------------------------------
  # 0	"1d"
  # 1	"5d"
  # 2	"1mo"
  # 3	"3mo"
  # 4	"6mo"
  # 5	"1y"
  # 6	"2y"
  # 7	"5y"
  # 8	"10y"
  # 9	"ytd"
  # 10	"max"
  
  DATACENTER_LINE_BORDER(paste('QUICK_DOWNLOAD_YAH_INTRADAY_BY_CODE : ', pCode, '-', Sys.time()))
  
  YAH_JSON      = paste0("https://query1.finance.yahoo.com/v7/finance/spark?symbols=", pCode, 
                         "&range=", xRange, "&interval=", xInterval, 
                         "&indicators=close&includeTimestamps=false&includePrePost=false&corsDomain=finance.yahoo.com&.tsrc=finance")
  print(YAH_JSON, quote = F)
  YAH_res       = jsonlite::fromJSON(YAH_JSON)
  YAH_datas     = YAH_res$spark$result
  
  YAH_Symbol    = YAH_datas$symbol
  
  YAH_Response  = as.data.table(YAH_datas$response)
  
  YAH_Last      = data.table(codesource=YAH_Response$meta.symbol, source='YAH', exchange=YAH_Response$meta.exchangeName, type=YAH_Response$meta.instrumentType, 
                             cur=YAH_Response$meta.currency, timestamp=as.character(anytime(YAH_Response$meta.regularMarketTime)),
                             timezone=YAH_Response$meta.timezone, gmtoffset=YAH_Response$meta.gmtoffset,
                             last=YAH_Response$meta.regularMarketPrice, pclose=YAH_Response$meta.chartPreviousClose)
  YAH_Last[, ":="(change=last-pclose, var=(last/pclose)-1)]
  # data_history[, datetimevn:=as.character(as.POSIXct(strptime(substr(timestamp,1,19) , "%Y-%m-%d %H:%M:%S"))+(7*60*60))]
  YAH_Last[, timestampvn:=timestamp]
  YAH_Last[, timestamp_utc:=as.character(as.POSIXct(timestampvn , format="%Y-%m-%d %H:%M:%S")-(7*60*60))]
  YAH_Last[, timestamp_loc:=as.character(as.POSIXct(timestamp_utc , format="%Y-%m-%d %H:%M:%S")+(gmtoffset))]
  
  YAH_Last[, date:=as.Date(substr(timestamp_loc,1,10))]         
  
  YAH_Last = merge(YAH_Last[, -c('code')], ins_ref[!is.na(yah)][, .(codesource=yah, code)], all.x=T, by='codesource')
  YAH_Last = MERGE_DATASTD_BYCODE(YAH_Last, "ADVANCED")
  
  YAH_Last = YAH_Last %>% select(source, code, codesource, codesource,name, date, timestamp, everything())
  # YAH_Last[, timestamp_utc:=as.character(as.POSIXct(strptime(substr(timestamp,1,19) , "%Y-%m-%d %H:%M:%S"))-(gmtoffset))]
  My.Kable.All(YAH_Last[, -c('fcat', 'type', 'provider', 'symbol', 'isin', 'timestamp_utc', 'source', 'country', 'continent', 'indhome')])
  
  # str(YAH_Response)
  YAH_TimeStamp = as.vector(YAH_Response$timestamp[[1]])
  YAH_Quote     = as.vector(unlist(YAH_Response$indicators.quote))
  YAH_Values    = as.data.table(cbind(YAH_TimeStamp, YAH_Quote))
  colnames(YAH_Values) = c('timestamp_num', 'last')
  YAH_Values[, timestamp:=anytime(timestamp_num)]
  # str(YAH_Values)
  
  YAH_Intraday     = YAH_Values[, .(codesource=YAH_Symbol, source='YAH', date=as.Date(as.character(timestamp)), timestampvn=as.character(timestamp), close=last)]
  YAH_Intraday[, timestamp_utc:=as.character(as.POSIXct(timestampvn , format="%Y-%m-%d %H:%M:%S")-(7*60*60))]
  YAH_Intraday[, timestamp_loc:=as.character(as.POSIXct(timestamp_utc , format="%Y-%m-%d %H:%M:%S")+(YAH_Last$gmtoffset))]
  YAH_Intraday[, timestamp:=timestamp_utc]
  YAH_Intraday[, code:=YAH_Last$code]
  YAH_Intraday = MERGE_DATASTD_BYCODE(YAH_Intraday, "ADVANCED")
  
  YAH_Daily_Pclose    = unique(YAH_Intraday[order(code, -timestamp_loc)], by='date')
  YAH_Daily_Pclose    = YAH_Daily_Pclose[order(date)]
  
  YAH_Daily_Pclose[, pclose:=shift(close)]
  
  YAH_Daily_Open     = unique(YAH_Intraday[order(code, timestamp_loc)], by='date')
  
  YAH_Intraday = merge(YAH_Intraday[, -c('pclose')], YAH_Last[, .(date, pclose=pclose)], all.x=T, by='date')
  YAH_Intraday[, ':='(change=close-pclose, var=(close/pclose)-1)]
  # YAH_Intraday = merge(YAH_Intraday[, -c('open')],   YAH_Daily_Open[, .(date, open=close)], all.x=T, by='date')
  YAH_Intraday = MERGE_DATASTD_BYCODE(YAH_Intraday, "ADVANCED")
  YAH_Intraday = YAH_Intraday %>% select(source, code, codesource, codesource, name, date, timestamp, timestampvn, close, change, var, everything())
  
  My.Kable.TB(YAH_Intraday[, -c('fcat', 'type', 'provider', 'symbol', 'isin', 'timestamp_utc', 'source', 'country', 'continent', 'indhome')])
  # 
  # My.Kable.TB(YAH_Intraday)
  
  return(list(YAH_Last, YAH_Intraday))
}

# ==================================================================================================
TRAINEE_DBL_IND_COMPO = function (pOPTION = 'COMPO', StartDate = '2023-07-01', EndDate = Sys.Date (),
                                  ToSave = F, ToIntegrate = F , ToUpload = F) {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  switch(pOPTION,
         'COMPO' = {
           mNB_TOP = 1000;
           mWgtLimit  = 20;
           FOLDER_COMPO = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; FILE_COMPO ='dbl_ind_compo.rds'
           FILE_LIST = 'dbl_ind_compo_new_mother.rds'
           # FOLDER_COMPO = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; FILE_COMPO ='dbl_ind_compo_new.rds'
         },
         'TOP_COMPO' = {
           mNB_TOP = 10;
           mWgtLimit  = 20;
           FOLDER_COMPO = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; FILE_COMPO ='dbl_ind_compo_top.rds'
           FILE_LIST = 'dbl_ind_compo_new_mother.rds'
         })
  MY_INDEX_COMPO = CCPR_READRDS (FOLDER_COMPO, FILE_LIST)
  index_list = unique (MY_INDEX_COMPO$code_mother)
  # STKVN_4COMPO = CCPR_READRDS ( UData,  'ifrc_beq_stkvn_4index.rds',ToRestore = T, ToKable = T)
  STKVN_4COMPO = CCPR_READRDS ( 'S:/STKVN/PRICES/FINAL/',  'ifrc_ccpr_stkvn_for_dashboard.rds',ToRestore = T, ToKable = T)
  STKVN_4COMPO = merge (STKVN_4COMPO, ins_ref[ type =='STK' & iso2 =='VN',.(code, name)], all.x = T, by = 'code')
  MY_MOTHER = CCPR_READRDS ( 'S:/CCPR/DATA/DASHBOARD_LIVE/',  'dbl_ind_mother.rds',ToRestore = T, ToKable = T)
  FREEFLOAT =  CCPR_READRDS ("S:/STKVN/PRICES/FINAL/","FINAL_STKVN_FREEFLOAT_4INDEX_HISTORY.rds",ToRestore = T, ToKable = T)
  
  data = list ()
  DATA_FINAL = data.table ()
  # for (i in 1: 11)
  for (i in 1: length  (index_list))
  {
    # i = 10
    NB_TOP = mNB_TOP
    WgtLimit  = mWgtLimit
    idx_code = index_list [[i]]
    # idx_code = 'INDVNXSECLOGCWPRVND'
    if (grepl ('EW',idx_code)) { WGTG = 'EW' } else {  WGTG = 'CW' }
    if (grepl ('CW',idx_code)) { WGTG = 'CW' }
    
    COMPO = MY_INDEX_COMPO [ code_mother == index_list [[i]] ]
    idx_name = MY_MOTHER [ code == index_list [[i]] ][1] $name
    
    # COMPO  = setDT( read_xlsx ( paste0('S:/STKVN/INDEX_2024/COMPO_VNXSEC',toupper(pSector), '.xlsx'))  )
    IND = STKVN_4COMPO
    IND = IND [ market %in% c('HSX', 'HNX')]
    IND = IND [code %in% COMPO$code]
    str (IND)
    unique (IND, by = 'code')
    ffl = FREEFLOAT
    IND = merge (IND [,-c('freefloat')], ffl [,.(code, date, freefloat = freefloat/100)], all.x = T, by = c('code', 'date'))
    My.Kable(IND[, .(code, date,name, market, sharesout, freefloat, close)])
    # My.Kable(IND [,.(code, name)])
    # str(IND)
    idx_date = max(IND[, date:=as.Date(date)]$date)
    My.Kable(IND[is.na(sharesout) | is.na(close)][, .(code, date,name, market, sharesout, freefloat, close)])
    My.Kable(IND[, .(code, date, market, sharesout, freefloat, close)])
    IND[, capivnd:=sharesout*close]
    # LIQUIDITY = CCPR_READRDS(UData, 'download_caf_stkvn_history.rds', ToKable = T, ToRestore = T)
    # LIQUIDITY = MERGE_DATASTD_BYCODE(LIQUIDITY, pOption='FINAL')
    # My.Kable.Min(LIQUIDITY[order(date, code)])
    IND [, turnover:=volume*close_unadj]
    IND [, volume := as.numeric(volume)]
    LIQUIDITY = IND
    LIQUIDITY_REVIEW = LIQUIDITY[date<=EndDate & date>=StartDate]
    
    My.Kable(LIQUIDITY_REVIEW[order(date, code)][, .(name, code, date, close, volume, turnover)])
    LIQUIDITY_REVIEW = unique( LIQUIDITY_REVIEW , by = c('code', 'date'))
    LIQUIDITY_REVIEW_TRADES = LIQUIDITY_REVIEW[, .( nb_trades=.N), by='code']
    
    
    LIQUIDITY_REVIEW_STATS = LIQUIDITY_REVIEW[, .(name=name[1], n=.N, avg_turnover=mean(turnover, na.rm=T)), by='code']
    LIQUIDITY_REVIEW_STATS = merge (LIQUIDITY_REVIEW_STATS,LIQUIDITY_REVIEW_TRADES, all.x = T, by = 'code' )
    LIQUIDITY_REVIEW_STATS
    MaxDays = max(LIQUIDITY_REVIEW_STATS$n)
    LIQUIDITY_REVIEW_STATS[, trading_ratio:=100* nb_trades/MaxDays]
    LIQUIDITY_REVIEW_STATS[trading_ratio>=95, included:=1]
    LIQUIDITY_REVIEW_STATS_ELIGIBLE = LIQUIDITY_REVIEW_STATS[included==1][order(-avg_turnover)][, ranking:=seq.int(1, .N)][order(ranking)]
    
    My.Kable(LIQUIDITY_REVIEW_STATS[order(trading_ratio)], Nb=10)
    
    My.Kable(LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)], Nb=10)
    NB_MAX = nrow (LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)])
    
    IND_REVIEW = IND[, .(code,date, name, market, sharesout, freefloat, close, capivnd)]
    IND_REVIEW = IND_REVIEW [code %in% LIQUIDITY_REVIEW_STATS_ELIGIBLE$code]
    IND_REVIEW[freefloat<0, freefloat:=1]
    IND_REVIEW[,capiff:=capivnd*freefloat]
    IND_REVIEW = unique ( IND_REVIEW[order(-date,-capiff)], by = 'code')
    IND_REVIEW[, rnk_capiff:=seq.int(1, .N)]
    IND_REVIEW = merge(IND_REVIEW, LIQUIDITY_REVIEW_STATS_ELIGIBLE[, .(code, avg_turnover)], all.x=T, by='code')
    IND_REVIEW = IND_REVIEW[order(-avg_turnover)][!is.na(avg_turnover) & avg_turnover >0][, rnk_turnover:=seq.int(1, .N)]
    IND_REVIEW[, ranking:=(51*rnk_capiff + 49*rnk_turnover)/100]
    IND_REVIEW = IND_REVIEW[order(ranking)][, rnk_nr:=seq.int(1, .N)]
    My.Kable(IND_REVIEW)
    
    # Capping ...
    # NB_TOP = 1000
    # NB_MAX = 56
    
    NB_TOP = min (NB_MAX, mNB_TOP)
    if (NB_MAX < 10| NB_TOP > 10)
    {
      WgtLimit = 100
      ToCap = F
    } else { ToCap = T}
    # NB_MAX = min ()
    IND_REVIEW_TOP = IND_REVIEW[rnk_nr<=NB_TOP][, -c('avg_turnover')][order(-capiff)]
    IND_REVIEW_TOP = IND_REVIEW_TOP [!is.na (sharesout)]
    if (WGTG == 'EW')
    {
      IND_REVIEW_TOP[, wgt:=100/nrow (IND_REVIEW_TOP)]
      
      if (pOPTION == 'COMPO') {
        IdxCapi  = sum(IND_REVIEW_TOP$capivnd)
        IND_REVIEW_TOP[, wgtk:=wgt]
        IND_REVIEW_TOP[, capi_effective:=capivnd]
        IND_REVIEW_TOP[, CAPI_IDX:=sum(capivnd)]
      }
      if (pOPTION == 'TOP_COMPO') {
        IdxCapi  = sum(IND_REVIEW_TOP$capiff)
        IND_REVIEW_TOP[, wgtk:=wgt]
        IND_REVIEW_TOP[, capi_effective:=capiff]
        IND_REVIEW_TOP[, CAPI_IDX:=sum(capi_effective)]
      }
    } else {
      if (WGTG == 'CW') {
        if (pOPTION == 'COMPO') {IND_REVIEW_TOP[, wgt:=100*capivnd/sum(capivnd)] 
          IdxCapi  = sum(IND_REVIEW_TOP$capivnd)
          IND_REVIEW_TOP[, wgtk:=wgt]
          IND_REVIEW_TOP[, capi_effective:=capivnd]
          IND_REVIEW_TOP[, CAPI_IDX:=sum(capivnd)]
        }
        if (pOPTION == 'TOP_COMPO') {IND_REVIEW_TOP[, wgt:=100*capiff/sum(capiff)] 
          IdxCapi  = sum(IND_REVIEW_TOP$capiff)
          IND_REVIEW_TOP[, wgtk:=wgt]
          IND_REVIEW_TOP[, capi_effective:=capiff]
          IND_REVIEW_TOP[, CAPI_IDX:=sum(capi_effective)] }
      } else { 
        if (pOPTION == 'COMPO') {IND_REVIEW_TOP[, wgt:=100*capivnd/sum(capivnd)]
          IdxCapi  = sum(IND_REVIEW_TOP$capivnd)
          IND_REVIEW_TOP[, wgtk:=wgt]
          IND_REVIEW_TOP[, capi_effective:=capivnd]
          IND_REVIEW_TOP[, CAPI_IDX:=sum(capivnd)]}
        if (pOPTION == 'TOP_COMPO') {IND_REVIEW_TOP[, wgt:=100*capiff/sum(capiff)] 
          IdxCapi  = sum(IND_REVIEW_TOP$capiff)
          IND_REVIEW_TOP[, wgtk:=wgt]
          IND_REVIEW_TOP[, capi_effective:=capiff]
          IND_REVIEW_TOP[, CAPI_IDX:=sum(capi_effective)]}
      }
    }
    
    My.Kable.All(IND_REVIEW_TOP[, -c('freefloat')])
    
    
    if (WGTG == 'EW')
    {
      # IND_REVIEW_TOP[, wgt:=100/nrow (IND_REVIEW_TOP)]
      IND_REVIEW_TOP[, WGT_IDX:=100/nrow (IND_REVIEW_TOP)]
    } else {
      if (WGTG == 'CW') { 
        if (pOPTION == 'COMPO') {IND_REVIEW_TOP[, WGT_IDX:=100*capivnd/CAPI_IDX]}
        if (pOPTION == 'TOP_COMPO') {IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]}
      } else { 
        if (pOPTION == 'COMPO') {IND_REVIEW_TOP[, WGT_IDX:=100*capivnd/CAPI_IDX]}
        if (pOPTION == 'TOP_COMPO') {IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]} 
      }
    }
    My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close')])
    
    if (ToCap)
    {
      NK = 0
      
      IND_REVIEW_TOP[, K:=NK]
      
      # Loop
      while (nrow(IND_REVIEW_TOP[WGT_IDX>WgtLimit])>0)
      {
        NK = 1+NK
        
        # IND_REVIEW_TOP10[, capi_effective:=capiff]
        # IND_REVIEW_TOP10[, wgti_eff:=100*capi_effective/sum(capi_effective)]
        My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
        
        IdxCapiInit    = sum(IND_REVIEW_TOP$capi_effective)
        IND_REVIEW_TOP$capped=0
        IND_REVIEW_TOP[, factor:=1]
        IND_REVIEW_TOP[WGT_IDX>=WgtLimit, capped:=1]
        IND_REVIEW_TOP[WGT_IDX>=WgtLimit, wgtk:=WgtLimit]
        
        IdxWgtCapped   = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$wgtk)
        IdxCapiCapped  = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$capi_effective)
        IdxCapiRemain  = sum(IND_REVIEW_TOP[WGT_IDX<WgtLimit]$capi_effective)
        IdxCapiTotal   = 100*IdxCapiRemain/(100-IdxWgtCapped)
        IdxCapiRemain/IdxCapiTotal
        
        CATln(paste(Format.Number(IdxCapiInit,0), ' / ', Format.Number(IdxCapiCapped,0), ' / ', Format.Number(IdxCapiCapped/IdxCapiTotal,2)))
        IdxCapiTotal/IND_REVIEW_TOP[1]$CAPI_IDX
        IdxCapiRemain/IdxCapiTotal
        
        # IND_REVIEW_TOP[capped>0, factor:=wgtk/wgt]
        
        IND_REVIEW_TOP[, wgti:=100*capi_effective/IdxCapiTotal]
        IND_REVIEW_TOP[capped==1, wgti:=WgtLimit]
        sum(IND_REVIEW_TOP$wgti)
        My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
        
        # IND_REVIEW_TOP[, capi_effective:=capiff*factor]
        IND_REVIEW_TOP[capped==1, capi_effective:=wgti*IdxCapiTotal/100]
        IND_REVIEW_TOP[, CAPI_IDX:=IdxCapiTotal]
        # IND_REVIEW_TOP[capped!=,  capi_effective:=wgti*wgti/100]
        
        IND_REVIEW_TOP[, wgti_eff:=100*capi_effective/sum(capi_effective)]
        CATln(Format.Number(sum(IND_REVIEW_TOP$wgti),2))
        CATln(Format.Number(sum(IND_REVIEW_TOP$wgti_eff),2))
        # IND_REVIEW_TOP[, capi_effective:=(wgti/100)*CAPI_IDX]
        IND_REVIEW_TOP[, K:=NK]
        
        # IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]
        IND_REVIEW_TOP[, WGT_IDX:=wgti]
        My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'sharesout')])
        
        CATln(Format.Number(sum(IND_REVIEW_TOP$WGT_IDX),2))
        
        
        My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'code', 'K', 'factor')])
      }
      
      FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP[, .(K, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                                SHARES=sharesout,
                                                CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX)]
      FINAL_IND_REVIEW_TOP[, CAPPING:=CAPI_STK/CAPIFF]
      FINAL_IND_REVIEW_TOP[, idx_code:=idx_code ]
      FINAL_IND_REVIEW_TOP[, idx_name:=idx_name ]
      FINAL_IND_REVIEW_TOP[, date:=idx_date]
      # capi_stk
    } else {
      
      if (WGTG == 'EW')
      {
        FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP [, .(K = 1, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                                   SHARES=sharesout,
                                                   CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=CAPI_IDX/nrow(IND_REVIEW_TOP) ) ]
      } else {
        if (WGTG == 'CW') {        
          FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP [, .(K = 1, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                                     SHARES=sharesout,CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX) ] 
        } else {
          FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP [, .(K = 1, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                                     SHARES=sharesout,CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX) ] }
      }
      
      FINAL_IND_REVIEW_TOP[, idx_code:=idx_code ]
      FINAL_IND_REVIEW_TOP[, idx_name:=idx_name ]
      FINAL_IND_REVIEW_TOP[, date:=idx_date]
    }
    
    My.Kable.All (FINAL_IND_REVIEW_TOP)
    data [[i]] =  FINAL_IND_REVIEW_TOP
  }
  
  MY_DATA = rbindlist (data, fill = T)
  # MY_DATA [idx_code == 'INDGI1FFIEWPRVND']
  # unique (MY_DATA$idx_code)
  DATA_FINAL = CLEAN_COLNAMES(MY_DATA)
  DATA_FINAL [ grepl (' EW',name), wgtg := 'EW']
  DATA_FINAL [ grepl (' CW',name), wgtg := 'CW']
  DATA_FINAL [ grepl ('CW',idx_code), wgtg := 'CW']
  DATA_FINAL [ grepl ('EW',idx_code), wgtg := 'EW']
  DATA_FINAL [is.na (wgtg), wgtg := 'CW']
  DATA_FINAL [grepl('VND',idx_code), coverage := 'VIETNAM']
  DATA_FINAL[,c5:=substr(idx_code,1,nchar(idx_code)-ifelse(grepl("CW|EW|FW|VW",idx_code),7,ifelse(grepl("EPR|ETR",idx_code) & wgtg=="EW",6,5)))]
  
  DATA_FINAL[, index_compo:=paste0(c5,ifelse(grepl("CW|EW|FW|VW",idx_code),wgtg,
                                             ifelse(grepl("EPR|ETR",idx_code) & wgtg=="EW","E","")),
                                   "PR",ifelse(coverage=="VIETNAM","VND","USD"))]
  
  # DATA_FINAL [, code_mother_old:= code_mother]
  DATA_FINAL [, code_mother := index_compo]
  # DATA_FINAL [ code_mother == 'INDVNXSECLOGCWPRVND']
  my_ref = ins_ref[type == 'STK' & code %in% unique (DATA_FINAL$code),. (code,industry = toupper(gics_ind_name), sector = toupper(gics_sector_name) )]
  DATA_FINAL = merge (DATA_FINAL, my_ref, all.x = T, by = 'code')
  if (pOPTION == 'COMPO') {  DATA_FINAL [,capibnvnd := capi/1000000000] }
  if (pOPTION == 'TOP_COMPO') {  DATA_FINAL [,capibnvnd := capi_stk/1000000000] }
  DATA_FINAL [,capibnvnd_wgt := capi_idx*wgt_idx/100000000000]
  # FILE_COMPO = 'dbl_ind_compo_top_new_mother.rds'
  if (ToIntegrate)
  {
    # x = CHECK_CLASS (try( CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_ind_compo_top.rds', ToKable = T) ))
    x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
    if (nrow (x) >0)
    {
      if (pOPTION == 'COMPO') {
        
        x = x [!is.na (wgt_pc)]
        y = rbind (x, (DATA_FINAL[,.(code,date,code_mother = idx_code, ticker,name,short_name = name, market,close,capibnvnd = capi/1000000000 ,updated = SYS.TIME(),sector, industry,shares, symbol = ticker,
                                     index_name = idx_name,wgt_pc = wgt_idx,capibnvnd_wgt, capi_stk)]), fill = T)
        y = unique (y, by = c('code_mother', 'code'), fromLast = T)
        # y [is.na (index_code), index_code := code_mother]
        y [, sector := toupper (sector)]
        y [, industry := toupper (industry)]
        My.Kable (y [!is.na(code_mother)])
        if (ToSave) {
          CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') )
          CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_pc)],FOLDER_COMPO, FILE_COMPO )        }
        
      }
      
      if (pOPTION == 'TOP_COMPO') {
        x = x [!is.na (wgt_idx), capibnvnd := capi_stk/1000000000]
        y = rbind (x, DATA_FINAL, fill = T)
        y [,capibnvnd := capi_stk/1000000000]
        y = unique (y, by = c('code_mother', 'code'), fromLast = T)
        y [, sector := toupper (sector)]
        y [, industry := toupper (industry)]
        My.Kable (y [!is.na(code_mother)])
        if (ToSave) {
          CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') )
          CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_idx)],FOLDER_COMPO, FILE_COMPO ) }
      }
      
    }
  } else {
    if (pOPTION == 'COMPO')
    {
      
      y = (DATA_FINAL[,.(code,date,code_mother = idx_code, ticker,name,short_name = name, market,close,capibnvnd = capi/1000000000 ,updated = SYS.TIME(),sector, industry,shares, symbol = ticker,
                         index_name = idx_name,wgt_pc = wgt_idx,capibnvnd_wgt, capi_stk)])
      y = unique (y, by = c('code_mother', 'code'), fromLast = T)
      # y [is.na (index_code), index_code := code_mother]
      y [, sector := toupper (sector)]
      y [, industry := toupper (industry)]
      My.Kable (y [!is.na(code_mother)])
      if (ToSave) {
        x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
        CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') )
        CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_pc)],FOLDER_COMPO, FILE_COMPO ) }
    }
    if (pOPTION == 'TOP_COMPO')
    {
      y = DATA_FINAL [!is.na (wgt_idx), capibnvnd := capi_stk/1000000000]
      y = unique (y, by = c('code_mother', 'code'), fromLast = T)
      y [, sector := toupper (sector)]
      y [, industry := toupper (industry)]
      My.Kable (y [!is.na(code_mother)])
      if (ToSave) {
        x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
        CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') )
        CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_idx)],FOLDER_COMPO, FILE_COMPO ) }
    }
    
  }
  
  if (ToUpload)
  {
    
    x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
    if (nrow (x) >0) {
      try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= tolower(gsub('.rds','', FILE_COMPO)),
                                       l.filepath= tolower(paste0(FOLDER_COMPO, FILE_COMPO)),
                                       CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    }
    
  }
  
  return (DATA_FINAL)
}

# ==================================================================================================
# TRAINEE_DBL_IND_COMPO = function (pOPTION = 'COMPO', StartDate = '2023-07-01', EndDate = Sys.Date (),
#                                   ToSave = T, ToIntegrate = F , ToUpload = T) { 
#   
#   RELOAD_INSREF()
#   switch(pOPTION, 
#          'COMPO' = {
#            mNB_TOP = 1000; 
#            mWgtLimit  = 20;
#            FOLDER_COMPO = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; FILE_COMPO ='dbl_ind_compo_new_mother.rds'
#            FILE_LIST = 'dbl_ind_compo_new_mother.rds'
#            # FOLDER_COMPO = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; FILE_COMPO ='dbl_ind_compo_new.rds'
#          },
#          'TOP_COMPO' = {
#            mNB_TOP = 10; 
#            mWgtLimit  = 20;
#            FOLDER_COMPO = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; FILE_COMPO ='dbl_ind_compo_top_new_mother.rds'
#            FILE_LIST = 'dbl_ind_compo_new_mother.rds'
#          })
#   MY_INDEX_COMPO = CCPR_READRDS (FOLDER_COMPO, FILE_LIST)
#   index_list = unique (MY_INDEX_COMPO$code_mother) 
#   STKVN_4COMPO = CCPR_READRDS ( UData,  'ifrc_beq_stkvn_4index.rds',ToRestore = T, ToKable = T)
#   MY_MOTHER = CCPR_READRDS ( 'S:/CCPR/DATA/DASHBOARD_LIVE/',  'dbl_ind_mother.rds',ToRestore = T, ToKable = T)
#   FREEFLOAT =  CCPR_READRDS ("S:/STKVN/PRICES/FINAL/","FINAL_STKVN_FREEFLOAT_4INDEX_HISTORY.rds",ToRestore = T, ToKable = T)
#   
#   data = list ()
#   DATA_FINAL = data.table ()
#   # for (i in 1: 11)
#   for (i in 1: length  (index_list))
#   {
#     # i = 10
#     NB_TOP = mNB_TOP
#     WgtLimit  = mWgtLimit
#     idx_code = index_list [[i]]
#     # idx_code = 'INDVNXSECLOGCWPRVND'
#     if (grepl ('EW',idx_code)) { WGTG = 'EW' } else {  WGTG = 'CW' }
#     if (grepl ('CW',idx_code)) { WGTG = 'CW' }
#     
#     COMPO = MY_INDEX_COMPO [ code_mother == index_list [[i]] ]
#     idx_name = MY_MOTHER [ code == index_list [[i]] ][1] $name
#     
#     # COMPO  = setDT( read_xlsx ( paste0('S:/STKVN/INDEX_2024/COMPO_VNXSEC',toupper(pSector), '.xlsx'))  )
#     IND = STKVN_4COMPO
#     IND = IND [ market %in% c('HSX', 'HNX')]
#     IND = IND [code %in% COMPO$code]
#     str (IND)
#     unique (IND, by = 'code')
#     ffl = FREEFLOAT
#     IND = merge (IND [,-c('freefloat')], ffl [,.(code, date, freefloat = freefloat/100)], all.x = T, by = c('code', 'date'))
#     My.Kable(IND[, .(code, date,name, market, sharesout, freefloat, close)])
#     # My.Kable(IND [,.(code, name)])
#     # str(IND)
#     idx_date = max(IND[, date:=as.Date(date)]$date)
#     My.Kable(IND[is.na(sharesout) | is.na(close)][, .(code, date,name, market, sharesout, freefloat, close)])
#     My.Kable(IND[, .(code, date, market, sharesout, freefloat, close)])
#     IND[, capivnd:=sharesout*close]
#     # LIQUIDITY = CCPR_READRDS(UData, 'download_caf_stkvn_history.rds', ToKable = T, ToRestore = T)
#     # LIQUIDITY = MERGE_DATASTD_BYCODE(LIQUIDITY, pOption='FINAL')
#     # My.Kable.Min(LIQUIDITY[order(date, code)])
#     IND [, turnover:=volume*close_unadj]
#     IND [, volume := as.numeric(volume)]
#     LIQUIDITY = IND
#     LIQUIDITY_REVIEW = LIQUIDITY[date<=EndDate & date>=StartDate]
#     
#     My.Kable(LIQUIDITY_REVIEW[order(date, code)][, .(name, code, date, close, volume, turnover)])
#     LIQUIDITY_REVIEW = unique( LIQUIDITY_REVIEW , by = c('code', 'date'))
#     LIQUIDITY_REVIEW_TRADES = LIQUIDITY_REVIEW[, .( nb_trades=.N), by='code']
#     
#     
#     LIQUIDITY_REVIEW_STATS = LIQUIDITY_REVIEW[, .(name=name[1], n=.N, avg_turnover=mean(turnover, na.rm=T)), by='code']
#     LIQUIDITY_REVIEW_STATS = merge (LIQUIDITY_REVIEW_STATS,LIQUIDITY_REVIEW_TRADES, all.x = T, by = 'code' )
#     LIQUIDITY_REVIEW_STATS
#     MaxDays = max(LIQUIDITY_REVIEW_STATS$n)
#     LIQUIDITY_REVIEW_STATS[, trading_ratio:=100* nb_trades/MaxDays]
#     LIQUIDITY_REVIEW_STATS[trading_ratio>=95, included:=1]
#     LIQUIDITY_REVIEW_STATS_ELIGIBLE = LIQUIDITY_REVIEW_STATS[included==1][order(-avg_turnover)][, ranking:=seq.int(1, .N)][order(ranking)]
#     
#     My.Kable(LIQUIDITY_REVIEW_STATS[order(trading_ratio)], Nb=10)
#     
#     My.Kable(LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)], Nb=10)
#     NB_MAX = nrow (LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)])
#     
#     IND_REVIEW = IND[, .(code,date, name, market, sharesout, freefloat, close, capivnd)] 
#     IND_REVIEW = IND_REVIEW [code %in% LIQUIDITY_REVIEW_STATS_ELIGIBLE$code]
#     IND_REVIEW[freefloat<0, freefloat:=1]
#     IND_REVIEW[,capiff:=capivnd*freefloat]
#     IND_REVIEW = unique ( IND_REVIEW[order(-date,-capiff)], by = 'code')
#     IND_REVIEW[, rnk_capiff:=seq.int(1, .N)]
#     IND_REVIEW = merge(IND_REVIEW, LIQUIDITY_REVIEW_STATS_ELIGIBLE[, .(code, avg_turnover)], all.x=T, by='code')
#     IND_REVIEW = IND_REVIEW[order(-avg_turnover)][!is.na(avg_turnover) & avg_turnover >0][, rnk_turnover:=seq.int(1, .N)]
#     IND_REVIEW[, ranking:=(51*rnk_capiff + 49*rnk_turnover)/100]
#     IND_REVIEW = IND_REVIEW[order(ranking)][, rnk_nr:=seq.int(1, .N)]
#     My.Kable(IND_REVIEW)
#     
#     # Capping ...
#     # NB_TOP = 1000
#     # NB_MAX = 56
#     NB_TOP = min (NB_MAX, NB_TOP)
#     if (NB_MAX < 10| NB_TOP > 10) 
#     {
#       WgtLimit = 100
#       ToCap = F
#     } else { ToCap = T}
#     # NB_MAX = min ()
#     IND_REVIEW_TOP = IND_REVIEW[rnk_nr<=NB_TOP][, -c('avg_turnover')][order(-capiff)]
#     IND_REVIEW_TOP = IND_REVIEW_TOP [!is.na (sharesout)]
#     if (WGTG == 'EW') 
#     { 
#       IND_REVIEW_TOP[, wgt:=100/nrow (IND_REVIEW_TOP)] 
#     } else {
#       if (WGTG == 'CW') { IND_REVIEW_TOP[, wgt:=100*capiff/sum(capiff)] } else { IND_REVIEW_TOP[, wgt:=100*capiff/sum(capiff)] }
#     }
#     
#     My.Kable.All(IND_REVIEW_TOP[, -c('freefloat')])
#     
#     IdxCapi  = sum(IND_REVIEW_TOP$capiff)
#     IND_REVIEW_TOP[, wgtk:=wgt]
#     IND_REVIEW_TOP[, capi_effective:=capiff]
#     IND_REVIEW_TOP[, CAPI_IDX:=sum(capi_effective)]
#     
#     if (WGTG == 'EW') 
#     { 
#       # IND_REVIEW_TOP[, wgt:=100/nrow (IND_REVIEW_TOP)] 
#       IND_REVIEW_TOP[, WGT_IDX:=100/nrow (IND_REVIEW_TOP)]
#     } else {
#       if (WGTG == 'CW') {  IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX] } else {  IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX] }
#     }
#     My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close')])
#     
#     if (ToCap)
#     {
#       NK = 0
#       
#       IND_REVIEW_TOP[, K:=NK]
#       
#       # Loop
#       while (nrow(IND_REVIEW_TOP[WGT_IDX>WgtLimit])>0)
#       {
#         NK = 1+NK
#         
#         # IND_REVIEW_TOP10[, capi_effective:=capiff]
#         # IND_REVIEW_TOP10[, wgti_eff:=100*capi_effective/sum(capi_effective)]
#         My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
#         
#         IdxCapiInit    = sum(IND_REVIEW_TOP$capi_effective)
#         IND_REVIEW_TOP$capped=0
#         IND_REVIEW_TOP[, factor:=1]
#         IND_REVIEW_TOP[WGT_IDX>=WgtLimit, capped:=1]
#         IND_REVIEW_TOP[WGT_IDX>=WgtLimit, wgtk:=WgtLimit]
#         
#         IdxWgtCapped   = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$wgtk)
#         IdxCapiCapped  = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$capi_effective)
#         IdxCapiRemain  = sum(IND_REVIEW_TOP[WGT_IDX<WgtLimit]$capi_effective)
#         IdxCapiTotal   = 100*IdxCapiRemain/(100-IdxWgtCapped)
#         IdxCapiRemain/IdxCapiTotal
#         
#         CATln(paste(Format.Number(IdxCapiInit,0), ' / ', Format.Number(IdxCapiCapped,0), ' / ', Format.Number(IdxCapiCapped/IdxCapiTotal,2)))
#         IdxCapiTotal/IND_REVIEW_TOP[1]$CAPI_IDX
#         IdxCapiRemain/IdxCapiTotal
#         
#         # IND_REVIEW_TOP[capped>0, factor:=wgtk/wgt]
#         
#         IND_REVIEW_TOP[, wgti:=100*capi_effective/IdxCapiTotal]
#         IND_REVIEW_TOP[capped==1, wgti:=WgtLimit]
#         sum(IND_REVIEW_TOP$wgti)
#         My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
#         
#         # IND_REVIEW_TOP[, capi_effective:=capiff*factor]
#         IND_REVIEW_TOP[capped==1, capi_effective:=wgti*IdxCapiTotal/100]
#         IND_REVIEW_TOP[, CAPI_IDX:=IdxCapiTotal]
#         # IND_REVIEW_TOP[capped!=,  capi_effective:=wgti*wgti/100]
#         
#         IND_REVIEW_TOP[, wgti_eff:=100*capi_effective/sum(capi_effective)]
#         CATln(Format.Number(sum(IND_REVIEW_TOP$wgti),2))
#         CATln(Format.Number(sum(IND_REVIEW_TOP$wgti_eff),2))
#         # IND_REVIEW_TOP[, capi_effective:=(wgti/100)*CAPI_IDX]
#         IND_REVIEW_TOP[, K:=NK]
#         
#         # IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]
#         IND_REVIEW_TOP[, WGT_IDX:=wgti]
#         My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'sharesout')])
#         
#         CATln(Format.Number(sum(IND_REVIEW_TOP$WGT_IDX),2))
#         
#         
#         My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'code', 'K', 'factor')])
#       }
#       
#       FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP[, .(K, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
#                                                 SHARES=sharesout,
#                                                 CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX)]
#       FINAL_IND_REVIEW_TOP[, CAPPING:=CAPI_STK/CAPIFF]
#       FINAL_IND_REVIEW_TOP[, idx_code:=index_list [[i]] ]
#       FINAL_IND_REVIEW_TOP[, idx_name:=idx_name]
#       FINAL_IND_REVIEW_TOP[, date:=idx_date]
#       # capi_stk
#     } else {
#       FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP [, .(K = 1, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
#                                                  SHARES=sharesout,
#                                                  CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=CAPI_IDX/nrow(IND_REVIEW_TOP)) ] 
#       FINAL_IND_REVIEW_TOP[, idx_code:=index_list [[i]] ]
#       FINAL_IND_REVIEW_TOP[, idx_name:=idx_name ]
#       FINAL_IND_REVIEW_TOP[, date:=idx_date]
#     }
#     
#     My.Kable.All (FINAL_IND_REVIEW_TOP)
#     data [[i]] =  FINAL_IND_REVIEW_TOP
#   }
#   
#   MY_DATA = rbindlist (data, fill = T)
#   # MY_DATA [idx_code == 'INDGI1FFIEWPRVND']
#   # unique (MY_DATA$idx_code)
#   DATA_FINAL = CLEAN_COLNAMES(MY_DATA)
#   DATA_FINAL [ grepl (' EW',name), wgtg := 'EW']
#   DATA_FINAL [ grepl (' CW',name), wgtg := 'CW']
#   DATA_FINAL [ grepl ('CW',idx_code), wgtg := 'CW']
#   DATA_FINAL [ grepl ('EW',idx_code), wgtg := 'EW']
#   DATA_FINAL [is.na (wgtg), wgtg := 'CW']
#   DATA_FINAL [grepl('VND',idx_code), coverage := 'VIETNAM']
#   DATA_FINAL[,c5:=substr(idx_code,1,nchar(idx_code)-ifelse(grepl("CW|EW|FW|VW",idx_code),7,ifelse(grepl("EPR|ETR",idx_code) & wgtg=="EW",6,5)))]
#   
#   DATA_FINAL[, index_compo:=paste0(c5,ifelse(grepl("CW|EW|FW|VW",idx_code),wgtg,
#                                              ifelse(grepl("EPR|ETR",idx_code) & wgtg=="EW","E","")),
#                                    "PR",ifelse(coverage=="VIETNAM","VND","USD"))]
#   
#   # DATA_FINAL [, code_mother_old:= code_mother]
#   DATA_FINAL [, code_mother := index_compo]
#   # DATA_FINAL [ code_mother == 'INDVNXSECLOGCWPRVND']
#   my_ref = ins_ref[type == 'STK' & code %in% unique (DATA_FINAL$code),. (code,industry = toupper(gics_ind_name), sector = toupper(gics_sector_name) )]
#   DATA_FINAL = merge (DATA_FINAL, my_ref, all.x = T, by = 'code')
#   # FILE_COMPO = 'dbl_ind_compo_top_new_mother.rds'
#   if (ToIntegrate)
#   {
#     # x = CHECK_CLASS (try( CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_ind_compo_top.rds', ToKable = T) ))
#     x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
#     if (nrow (x) >0)
#     {
#       if (pOPTION == 'COMPO') {
#         
#         x = x [!is.na (wgt_idx), capibnvnd := capi_stk/1000000000]
#         y = rbind (x, (DATA_FINAL[,.(code,date,code_mother = idx_code, ticker,name,short_name = name, market,close,
#                                      capibnvnd = capi_stk/1000000000 ,updated = SYS.TIME(),sector, industry,shares,
#                                      symbol = ticker, index_name = idx_name,wgt_pc = wgt_idx)]), fill = T)
#         y = unique (y, by = c('code_mother', 'code'), fromLast = T)
#         # y [is.na (index_code), index_code := code_mother]
#         y [, sector := toupper (sector)]
#         y [, industry := toupper (industry)]
#         My.Kable (y [!is.na(code_mother)])
#         if (ToSave) {        
#           CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') ) 
#           CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_pc)],FOLDER_COMPO, FILE_COMPO )        }
#         
#       }
#       
#       if (pOPTION == 'TOP_COMPO') {
#         x = x [!is.na (wgt_idx), capibnvnd := capi_stk/1000000000]
#         DATA_FINAL = DATA_FINAL [!is.na (wgt_idx), capibnvnd := capi_stk/1000000000]
#         y = rbind (x, DATA_FINAL, fill = T)
#         y = unique (y, by = c('code_mother', 'code'), fromLast = T)
#         y [, sector := toupper (sector)]
#         y [, industry := toupper (industry)]
#         My.Kable (y [!is.na(code_mother)])
#         if (ToSave) {  
#           CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') ) 
#           CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_idx)],FOLDER_COMPO, FILE_COMPO ) }
#       }
#       
#     }
#   } else {
#     if (pOPTION == 'COMPO') 
#     {
#       
#       y = (DATA_FINAL[,.(code,date,code_mother = idx_code, ticker,name,short_name = name, market,close,capibnvnd = capi_stk/1000000000 ,updated = SYS.TIME(),sector, industry,shares, symbol = ticker,
#                          index_name = idx_name,wgt_pc = wgt_idx)])
#       y = unique (y, by = c('code_mother', 'code'), fromLast = T)
#       # y [is.na (index_code), index_code := code_mother]
#       y [, sector := toupper (sector)]
#       y [, industry := toupper (industry)]
#       My.Kable (y [!is.na(code_mother)])
#       if (ToSave) {  
#         x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
#         CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') ) 
#         CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_pc)],FOLDER_COMPO, FILE_COMPO ) }
#     }
#     if (pOPTION == 'TOP_COMPO') 
#     {
#       y = DATA_FINAL [!is.na (wgt_idx), capibnvnd := capi_stk/1000000000]
#       y = unique (y, by = c('code_mother', 'code'), fromLast = T)
#       y [, sector := toupper (sector)]
#       y [, industry := toupper (industry)]
#       My.Kable (y [!is.na(code_mother)])
#       if (ToSave) {   
#         x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
#         CCPR_SAVERDS (x,FOLDER_COMPO, paste0( gsub('.rds','',FILE_COMPO), '_old.rds') )
#         CCPR_SAVERDS (y [!is.na(code_mother) & !is.na(wgt_idx)],FOLDER_COMPO, FILE_COMPO ) }
#     }
#     
#   }
#   
#   if (ToUpload) 
#   {
#     
#     x = CHECK_CLASS (try( CCPR_READRDS (FOLDER_COMPO, FILE_COMPO, ToKable = T) ))
#     if (nrow (x) >0) {
#       try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live_bat', l.tablename= tolower(gsub('_new_mother.rds','', FILE_COMPO)),
#                                        l.filepath= tolower(paste0(FOLDER_COMPO, FILE_COMPO)),
#                                        CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
#     }
#     
#   }
#   
#   return (DATA_FINAL)
# }

# ==================================================================================================
TRAINEE_DOWNLOAD_PRICES_DAY_CNBC = function(timeRange = "1D", pCode = "@VX.1") {
  # ------------------------------------------------------------------------------------------------
  
  #pCode = "XXXY"
  #pCode = "@VX.1"
  #Choose one out of the following types: 1D, 5D, 1M, 3M, 6M, YTD, 1Y, 5Y, ALL
  initial_url = paste0("https://webql-redesign.cnbcfm.com/graphql?operationName=getQuoteChartData&variables=%7B%22symbol%22%3A%22", pCode,"%22%2C%22timeRange%22%3A%22", timeRange,"%22%7D&extensions=%7B%22persistedQuery%22%3A%7B%22version%22%3A1%2C%22sha256Hash%22%3A%2261b6376df0a948ce77f977c69531a4a8ed6788c5ebcdd5edd29dd878ce879c8d%22%7D%7D")
  
  # SOLUTION 1 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  response = GET(initial_url, add_headers(
    `User-Agent` = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36 Edg/126.0.0.0",
    `Accept-Language` = "en-US,en;q=0.9,vi;q=0.8"
  ))
  xweb         = content(response, as = "text", encoding = "UTF-8")
  json_data    = fromJSON(xweb)
  results      = json_data$data$chartData$symbol
  #SOLUTION 2 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  # xweb1       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(initial_url, paste0('c:/temp/', paste0('TRAINEE_DOWNLOAD_PRICES_DAY_CNBC.txt')), ToDeleteTemp = T, pSleep = 1)
  # if (grepl('<pre>', xweb1[1])) { xweb2 = str.extract(xweb1[1], '<pre>', '</pre>') }
  # json_data    = jsonlite::fromJSON(xweb2)
  # results      = json_data$data$chartData$symbol
  
  priceBars_dt = data.table()
  Final_Data = data.table()
  if(!is.null(results))
  {
    chartData = json_data$data$chartData
    priceBars = chartData$priceBars
    
    priceBars_dt = as.data.table(priceBars)
    if (nrow (priceBars_dt) >0)
    {
      priceBars_dt[, codesource := chartData$symbol]
      priceBars_dt[, name := chartData$allSymbols$name]
      priceBars_dt[, short_name := chartData$allSymbols$shortName]
      priceBars_dt[, source := 'CNBC']
      priceBars_dt[, timeRange := chartData$timeRange]
      priceBars_dt[, open := as.numeric(open)]
      priceBars_dt[, high := as.numeric(high)]
      priceBars_dt[, low := as.numeric(low)]
      priceBars_dt[, close := as.numeric(close)]
      priceBars_dt[, volume := as.numeric(volume)]
      priceBars_dt[, tradeTime := as.POSIXct(tradeTime, format="%Y%m%d%H%M%S", tz="UTC")]
      priceBars_dt[, tradeTimeinMills := NULL]
      Final_Data = CLEAN_COLNAMES(priceBars_dt)
      names (Final_Data) = gsub ('__','',  names (priceBars_dt))
      Final_Data = Final_Data %>% select ( codesource , name , short_name , source, everything() )
      
      My.Kable(Final_Data)
    } else { Final_Data = data.table (codesource = chartData$symbol, 
                                      name = chartData$allSymbols$name,
                                      short_name = chartData$allSymbols$shortName, source = 'CNBC', timerange = '1D')}
    CATln_Border(pCode)
    My.Kable(Final_Data)
  } else {
    CATln_Border(paste(pCode, '=', 'NOT AVAILABLE') )
  }
  
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_CALCULATE_CLOSE_ADJ = function (DATA = data.table(), Folder_File = "S:/STKVN/PRICES/FINAL/", 
                                        File_Name = "IFRC_CCPR_STKVN_FOR_DASHBOARD.rds",
                                        ToSave = F) {
  # ------------------------------------------------------------------------------------------------
  
  if(nrow(DATA) == 0 )
  {
    DATA = CHECK_CLASS(try(CCPR_READRDS(Folder_File, File_Name)))
  }
  if(nrow(DATA) > 0)
  {
    if (all(c('code', 'close') %in% names(DATA)))
    {
      DATA = DBL_IND_CALCULATE_RT_VAR_CHANGE(DATA)
      DATA = DATA[order(code, -date)]
      DATA = unique(DATA, by = c('code', 'date'))
      DATA[, prt := 1 + rt]
      DATA[, close_adj := close]
      DATA[.I < .N, close_adj := shift(close) / shift(prt), by = 'code']
      DATA = DATA[order(code, date)]
      DATA[, rt_adj := (close / shift(close_adj)) - 1, by = 'code']
    }else{
      if (all(c('codesource', 'close') %in% names(DATA)))
      {
        DATA = DBL_IND_CALCULATE_RT_VAR_CHANGE(DATA)
        DATA = DATA[order(codesource, -date)]
        DATA = unique(DATA, by = c('codesource', 'date'))
        DATA[, prt := 1 + rt]
        DATA[, close_adj := close]
        DATA[.I < .N, close_adj := shift(close) / shift(prt), by = 'codesource']
        DATA = DATA[order(codesource, date)]
        DATA[, rt_adj := (close / shift(close_adj)) - 1, by = 'codesource']
      }
    }
    if ( ToSave)
    {
      try(CCPR_SAVERDS(DATA, Folder_File, File_Name, ToSummary = T, SaveOneDrive = T))
    }
  }
  return(DATA)
  
}


# ==================================================================================================
DBL_DURATION = function (start_time)  {
  # ------------------------------------------------------------------------------------------------
  duration = Format.Number(difftime(Sys.time(), start_time, units = 'secs'), 2)
  CATln_Border(paste0('DURATION = ', duration))
}

# ==================================================================================================
SYSDATETIME_DELAY = function(l.hour, WeekDateTime=T, delay = 0) {
  # ------------------------------------------------------------------------------------------------
  # print(SYSDATETIME(15))
  # l.hour = 17
  #  delay = 1
  #Today = as.Date('2024-08-19')
  if (hour(Sys.time())>=l.hour) 
  {
    l.res= Sys.Date() - delay
  } else
  {l.res = Sys.Date() - 1 - delay}
  if (WeekDateTime)
  {
    while ( weekdays(l.res) %in% c("Saturday", "Sunday")) {
      l.res = l.res - 1 
    }
  }
  return(l.res)
}


# ==================================================================================================
READ_SUMMARY_DATE_TXT = function (File_RDS = paste0('S:/STKVN/INDEX_2024/', 'dbl_index_vietnam_updated.rds')) {
  # ------------------------------------------------------------------------------------------------
  File_TXT = gsub('.rds', '_summary.txt', ignore.case = T, File_RDS)
  CATln_Border(File_TXT)
  summary = try(setDT(fread(File_TXT, sep = '\t')))
  My.Kable(summary)
  result = summary[,.(
    file_folder = dirname(File_RDS),
    file_name   = basename(File_RDS),
    start_date  = min(start),
    end_date    = max(date) ,
    num_codes   = .N,
    total_record= sum(nb),
    na_records  = as.numeric(NA),
    non_na_records = as.numeric(NA),
    quality_percentage = as.numeric(NA)
  )]
  My.Kable(result)
  return(result)
}


# ==================================================================================================
DEV_DBL_CHECK_QUALITY_FILE = function (list_files   = "S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_ind_history.txt",
                                       pFilter      = 'PRVND$',
                                       ToUpload     = F,
                                       SaveFolder   = "S:/CCPR/DATA/DASHBOARD_LIVE/REPORT/",
                                       SaveFile     = "REPORT_FILES_DBL.rds",
                                       Option       = 'SUMMARY' ) {
  # ------------------------------------------------------------------------------------------------
  start_time = Sys.time()
  REPORT      = data.table()
  list_report = list()
  list.files  = try(setDT(fread(list_files, sep = '\t')))
  My.Kable(list.files)
  if(all(class(list.files) != 'try-error' | nrow(list.files) > 0 ))
  {
    if ('active' %in% names(list.files))
    {
      list.files   = list.files[active==1]
    }
    
    if (nchar(pFilter) > 0 &  'filter' %in% names(list.files))
    {
      list.files = list.files[pFilter == filter]
      
    }
    
    if (nrow(list.files) > 0 )
    {
      for (k in 1:nrow(list.files))
      {
        # k = 1
        if ('delay' %in% names(list.files))
        {
          xDelay = list.files[k]$delay
        }else{
          xDelay = 0
        }
        if ('type' %in% names(list.files))
        {
          xType = list.files[k]$type
        }else{
          xType = ''
        }
        
        switch(Option,
               'QUALITY' = {
                 x = CHECK_CLASS (try (DBL_CHECK_QUALITY_DATA (Fields = list('close'), File_name = list.files[k]$filename , File_Folder = list.files[k]$folder , ToPrompt = F, ToKable = T) ))
               },
               'SUMMARY' = {
                 x = CHECK_CLASS(try (READ_SUMMARY_DATE_TXT(File_RDS = paste0(list.files[k]$folder, list.files[k]$filename))))
               })
        
        
        if (nrow(x) > 0 )
        {
          My.Kable(x)
          if (xDelay == 0)
          {
            LastTrading  = CCPR_LAST_TRADING_DAY_VN(max(17, as.numeric(substr(Sys.time(),12,13))), ToPrompt = T)
            x[, LastTrading := LastTrading ] 
          }else{
            LastTrading  = SYSDATETIME_DELAY(23, WeekDateTime = T, delay = xDelay)
            x[, LastTrading := LastTrading ] 
          }
          x[, type := xType]
          list_report [[k]] = x
        }
      }
      REPORT = rbindlist(list_report, fill = T)
      REPORT = UPDATE_UPDATED(REPORT)
      
      REPORT[, status:='']
      REPORT[end_date<LastTrading, status:='***']  
      REPORT = REPORT [order(-status)]
      My.Kable.All(REPORT)
      if (nchar(SaveFolder) > 0 & nchar(SaveFile) > 0 )
      {
        CCPR_SAVERDS(REPORT,SaveFolder, SaveFile, ToKable = T, SaveOneDrive = T)
      }
    }
  }
  if (ToUpload) {
    UPLOAD_RDS_TABLE(pName = "intranet_dev",
                     pHost = "192.168.1.105",
                     pUser = "intranet_admin",
                     pPass = "admin@123456",
                     folder_name = SaveFolder,
                     file_name = SaveFile,
                     table_name = "report_files_dbl",
                     key_column = "id")
  }
  My.Kable.All(REPORT)
  DBL_DURATION(start_time)
  return (REPORT)
}



# ==================================================================================================
DBL_CHECK_QUALITY_DATA = function (Fields     = list('volume', 'sharesout'), File_Folder = 'S:/STKVN/PRICES/FINAL/', 
                                   File_name  = 'DOWNLOAD_SOURCES_STKVN_VOLUME_4INDEX_TODAY.rds', ToPrompt = F, ToKable = F) {
  # ------------------------------------------------------------------------------------------------
  CATln_Border(paste('CHECK_QUALITY_DATA = ', paste0(File_Folder, File_name)))
  mandatory_columns = c('code', 'date')
  data              = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_name, ToKable = ToPrompt)))
  
  fields_present = intersect(Fields, names(data))
  col            = as.character(unique(c(mandatory_columns, fields_present)))
  data           = data[, ..col]
  fields_present = as.character(fields_present)
  data[, final := get(fields_present)]
  
  if (identical(col, mandatory_columns)) {
    return(data.table(
      file_name = File_name,
      message = "No additional fields present, skipping further processing"
    ))
  }
  
  start_date = min(data$date, na.rm = TRUE)
  end_date   = max(data$date, na.rm = TRUE)
  
  num_codes          = length(unique(data$code))
  total_records      = nrow(data)
  na_records         = sum(is.na(data$final))
  non_na_records     = sum(!is.na(data$final))
  quality_percentage = (non_na_records / total_records) * 100
  non_integer_values = data.table()
  if (class(data$final) != "character") 
  {
    non_integer_values       = data.table()
    non_integer_final_values = data[!is.na(final) & (final %% 1 != 0)]
    non_integer_values       = rbind(non_integer_values, non_integer_final_values, fill = TRUE)
  }
  
  data_not_ok = data[order(date)][is.na(final)]
  if (ToPrompt)
  {
    data_error_tradable = My.Kable(idx_calendar.vn[date < Sys.Date() & (!date %in% unique(data, by = 'date')$date)])
  }
  result_table = data.table( file_folder        = File_Folder,
                             file_name          = File_name,
                             start_date         = start_date,
                             end_date           = end_date,
                             num_codes          = num_codes,
                             total_records      = total_records,
                             na_records         = na_records,
                             non_na_records     = non_na_records,
                             quality_percentage = quality_percentage,
                             non_integer_count  = nrow(non_integer_values)
  )
  
  if (ToKable) { My.Kable.All(result_table)}
  return(result_table)
}







# ==================================================================================================
TRAINEE_DOWNLOAD_VND_FINANCIAL_RATIOS = function(pCode = 'VNM'){
  # ------------------------------------------------------------------------------------------------
  current_year = year(Sys.Date())
  pURL = paste0('https://finfo-api.vndirect.com.vn/v4/ratios/latest?order=reportDate&where=code:',pCode,'~reportDate:gte:',current_year,'-01-01&filter=ratioCode:NET_SALES_YD_GRYOY,NET_PROFIT_YD_GRYOY,OPERATING_EBIT_YD_GRYOY,GROSS_MARGIN_YD,ROAA_TR_AVG5Q,ROAE_TR_AVG5Q,DEBT_TO_EQUITY_AQ,DIVIDEND_YIELD,CFO_TO_SALES_YD,INTEREST_COVERAGE_TR,CPS_AQ')
  
  x = jsonlite::fromJSON(pURL)
  data = as.data.table(x$data)
  data = CLEAN_COLNAMES(data) 
  
  year_past = current_year - 1
  dataList = list()
  while (year_past > 2000){
    data_past = data.table()
    pURL = paste0('https://finfo-api.vndirect.com.vn/v4/ratios?q=code:',pCode,'~ratioCode:NET_SALES_TR_GRYOY,NET_PROFIT_TR_GRYOY,OPERATING_EBIT_TR_GRYOY,GROSS_MARGIN_TR,ROAA_TR_AVG5Q,ROAE_TR_AVG5Q,DEBT_TO_EQUITY_AQ,DIVIDEND_YIELD,CFO_TO_SALES_TR,INTEREST_COVERAGE_TR,CPS_AQ~reportDate:',year_past,'-12-31')
    x = jsonlite::fromJSON(pURL)
    data_past = as.data.table(x$data)
    data_past = CLEAN_COLNAMES(data_past)
    
    if (nrow(data_past) > 0){
      dataList[[year_past]] = data_past
      My.Kable.All(data_past)
    }
    year_past = year_past - 1
  }
  data_value = rbindlist(dataList, fill = T)
  
  data = rbind(data, data_value, fill = T)
  final_data = data[, .(source = 'VND', dataset = 'FINANCIAL RATIOS', category = 'FINANCIAL STATEMENTS', ticker = code, code = paste0('STKVN', code), itemcode, ratiocode, itemvnname = itemname, year = year(reportdate),
                        fiscaldate = reportdate, value)]
  final_data = final_data[order(fiscaldate)]
  final_data = UPDATE_UPDATED(final_data)
  My.Kable(final_data)
  # My.Kable(final_data[grepl('Loss', itemenname, ignore.case = T)])
  
  return(final_data)
}
# ==================================================================================================
TRAINEE_MERGE_STKALL = function ( ToUpload = F)  {
  # ------------------------------------------------------------------------------------------------
  STKVN = CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_stkvn.rds')  [, ':=' (coverage = 'VIETNAM')]
  
  STKVN [ size == 'LARGE', category := 'LARGE CAPS']
  STKVN [ size == 'MID', category := 'MID CAPS']
  STKVN [ size == 'SMALL', category := 'SMALL CAPS']
  
  YAH_STK = CCPR_READRDS (UData, 'ifrc_beq_stkin_history.rds')
  # CCPR_SAVERDS (YAH_STK, UData, 'ifrc_beq_stkin_history.rds')
  OVERVIEW = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_STOCKS', Fr_Data = YAH_STK,  Fr_Folder = '', 
                                                            Fr_File = '',
                                                            To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_stkin.rds'), 
                                                            DateLimit = Sys.Date()  ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                            ToSave = T, ToUpload = F , pHost = 'dashboard_live_bat') )
  STKIN = OVERVIEW  [, ':=' (coverage = 'INTERNATIONAL', category = 'LARGE CAPS')]
  STKIN [, market := sub(".*\\.", "", codesource)]
  STKIN [,':='(sector = toupper(sector), industry = toupper (industry))]
  MY_DATA = unique ( rbind (STKVN, STKIN, fill = T) , by = c('code', 'date') )
  
  pData = MY_DATA %>% dplyr::select(names (STKVN))
  str (pData)
  
  CCPR_SAVERDS (pData, 'S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_stkall.rds')
  
  if (ToUpload)  {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live_bat', l.tablename= tolower( 'dbl_stk_performance'),
                                     l.filepath= tolower(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/' , 'ccpi_dashboard_stkall.rds')),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
  }
}

# ==================================================================================================
REVIEW_TRADABLE_INDEX = function( NB_TOP    = 10, File_folder = UData, File_name = 'ifrc_beq_stkvn_4index.rds',
                                  WgtLimit  = 20, pSector = 'log' , 
                                  StartDate = '2023-07-01', EndDate = Sys.Date (), idx_code = 'INDVNXWM10PRVND', idx_name = 'IFRC VNX TOP 10 WOMEN CEO')
{
  # ---------------------
  IND = CCPR_READRDS(File_folder, File_name, ToKable = T) 
  COMPO  = setDT( read_xlsx ( paste0('S:/STKVN/INDEX_2024/COMPO_VNXSEC',toupper(pSector), '.xlsx'))  )
  IND = IND [ market %in% c('HSX', 'HNX')]
  IND = IND [code %in% COMPO$code]
  str (IND)
  unique (IND, by = 'code')
  ffl = CCPR_READRDS ("S:/STKVN/PRICES/FINAL/","FINAL_STKVN_FREEFLOAT_4INDEX_HISTORY.rds")
  IND = merge (IND [,-c('freefloat')], ffl [,.(code, date, freefloat = freefloat/100)], all.x = T, by = c('code', 'date'))
  My.Kable(IND[, .(code, date,name, market, sharesout, freefloat, close)])
  # My.Kable(IND [,.(code, name)])
  # str(IND)
  idx_date = max(IND[, date:=as.Date(date)]$date)
  My.Kable(IND[is.na(sharesout) | is.na(close)][, .(code, date,name, market, sharesout, freefloat, close)])
  My.Kable(IND[, .(code, date, market, sharesout, freefloat, close)])
  IND[, capivnd:=sharesout*close]
  # LIQUIDITY = CCPR_READRDS(UData, 'download_caf_stkvn_history.rds', ToKable = T, ToRestore = T)
  # LIQUIDITY = MERGE_DATASTD_BYCODE(LIQUIDITY, pOption='FINAL')
  # My.Kable.Min(LIQUIDITY[order(date, code)])
  IND [, turnover:=volume*close_unadj]
  IND [, volume := as.numeric(volume)]
  LIQUIDITY = IND
  LIQUIDITY_REVIEW = LIQUIDITY[date<=EndDate & date>=StartDate]
  
  My.Kable(LIQUIDITY_REVIEW[order(date, code)][, .(name, code, date, close, volume, turnover)])
  LIQUIDITY_REVIEW = unique( LIQUIDITY_REVIEW , by = c('code', 'date'))
  LIQUIDITY_REVIEW_TRADES = LIQUIDITY_REVIEW[, .( nb_trades=.N), by='code']
  
  
  LIQUIDITY_REVIEW_STATS = LIQUIDITY_REVIEW[, .(name=name[1], n=.N, avg_turnover=mean(turnover, na.rm=T)), by='code']
  LIQUIDITY_REVIEW_STATS = merge (LIQUIDITY_REVIEW_STATS,LIQUIDITY_REVIEW_TRADES, all.x = T, by = 'code' )
  LIQUIDITY_REVIEW_STATS
  MaxDays = max(LIQUIDITY_REVIEW_STATS$n)
  LIQUIDITY_REVIEW_STATS[, trading_ratio:=100* nb_trades/MaxDays]
  LIQUIDITY_REVIEW_STATS[trading_ratio>=95, included:=1]
  LIQUIDITY_REVIEW_STATS_ELIGIBLE = LIQUIDITY_REVIEW_STATS[included==1][order(-avg_turnover)][, ranking:=seq.int(1, .N)][order(ranking)]
  
  My.Kable(LIQUIDITY_REVIEW_STATS[order(trading_ratio)], Nb=10)
  
  My.Kable(LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)], Nb=10)
  NB_MAX = nrow (LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)])
  
  IND_REVIEW = IND[, .(code,date, name, market, sharesout, freefloat, close, capivnd)] 
  IND_REVIEW = IND_REVIEW [code %in% LIQUIDITY_REVIEW_STATS_ELIGIBLE$code]
  IND_REVIEW[freefloat<0, freefloat:=1]
  IND_REVIEW[,capiff:=capivnd*freefloat]
  IND_REVIEW = unique ( IND_REVIEW[order(-date,-capiff)], by = 'code')
  IND_REVIEW[, rnk_capiff:=seq.int(1, .N)]
  IND_REVIEW = merge(IND_REVIEW, LIQUIDITY_REVIEW_STATS_ELIGIBLE[, .(code, avg_turnover)], all.x=T, by='code')
  IND_REVIEW = IND_REVIEW[order(-avg_turnover)][!is.na(avg_turnover) & avg_turnover >0][, rnk_turnover:=seq.int(1, .N)]
  IND_REVIEW[, ranking:=(51*rnk_capiff + 49*rnk_turnover)/100]
  IND_REVIEW = IND_REVIEW[order(ranking)][, rnk_nr:=seq.int(1, .N)]
  My.Kable(IND_REVIEW)
  
  # Capping ...
  # NB_TOP = 10
  NB_TOP = min (NB_MAX, NB_TOP)
  if (NB_MAX < 10) 
  {
    WgtLimit = 100
    ToCap = F
  } else { ToCap = T}
  # NB_MAX = min ()
  IND_REVIEW_TOP = IND_REVIEW[rnk_nr<=NB_TOP][, -c('avg_turnover')][order(-capiff)]
  IND_REVIEW_TOP[, wgt:=100*capiff/sum(capiff)]
  My.Kable.All(IND_REVIEW_TOP[, -c('freefloat')])
  
  IdxCapi  = sum(IND_REVIEW_TOP$capiff)
  IND_REVIEW_TOP[, wgtk:=wgt]
  IND_REVIEW_TOP[, capi_effective:=capiff]
  IND_REVIEW_TOP[, CAPI_IDX:=sum(capi_effective)]
  IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]
  My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close')])
  
  if (ToCap)
  {
    NK = 0
    
    IND_REVIEW_TOP[, K:=NK]
    
    # Loop
    while (nrow(IND_REVIEW_TOP[WGT_IDX>WgtLimit])>0)
    {
      NK = 1+NK
      
      # IND_REVIEW_TOP10[, capi_effective:=capiff]
      # IND_REVIEW_TOP10[, wgti_eff:=100*capi_effective/sum(capi_effective)]
      My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
      
      IdxCapiInit    = sum(IND_REVIEW_TOP$capi_effective)
      IND_REVIEW_TOP$capped=0
      IND_REVIEW_TOP[, factor:=1]
      IND_REVIEW_TOP[WGT_IDX>=WgtLimit, capped:=1]
      IND_REVIEW_TOP[WGT_IDX>=WgtLimit, wgtk:=WgtLimit]
      
      IdxWgtCapped   = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$wgtk)
      IdxCapiCapped  = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$capi_effective)
      IdxCapiRemain  = sum(IND_REVIEW_TOP[WGT_IDX<WgtLimit]$capi_effective)
      IdxCapiTotal   = 100*IdxCapiRemain/(100-IdxWgtCapped)
      IdxCapiRemain/IdxCapiTotal
      
      CATln(paste(Format.Number(IdxCapiInit,0), ' / ', Format.Number(IdxCapiCapped,0), ' / ', Format.Number(IdxCapiCapped/IdxCapiTotal,2)))
      IdxCapiTotal/IND_REVIEW_TOP[1]$CAPI_IDX
      IdxCapiRemain/IdxCapiTotal
      
      # IND_REVIEW_TOP[capped>0, factor:=wgtk/wgt]
      
      IND_REVIEW_TOP[, wgti:=100*capi_effective/IdxCapiTotal]
      IND_REVIEW_TOP[capped==1, wgti:=WgtLimit]
      sum(IND_REVIEW_TOP$wgti)
      My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
      
      # IND_REVIEW_TOP[, capi_effective:=capiff*factor]
      IND_REVIEW_TOP[capped==1, capi_effective:=wgti*IdxCapiTotal/100]
      IND_REVIEW_TOP[, CAPI_IDX:=IdxCapiTotal]
      # IND_REVIEW_TOP[capped!=,  capi_effective:=wgti*wgti/100]
      
      IND_REVIEW_TOP[, wgti_eff:=100*capi_effective/sum(capi_effective)]
      CATln(Format.Number(sum(IND_REVIEW_TOP$wgti),2))
      CATln(Format.Number(sum(IND_REVIEW_TOP$wgti_eff),2))
      # IND_REVIEW_TOP[, capi_effective:=(wgti/100)*CAPI_IDX]
      IND_REVIEW_TOP[, K:=NK]
      
      # IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]
      IND_REVIEW_TOP[, WGT_IDX:=wgti]
      My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'sharesout')])
      
      CATln(Format.Number(sum(IND_REVIEW_TOP$WGT_IDX),2))
      
      
      My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'code', 'K', 'factor')])
    }
    
    FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP[, .(K, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                              SHARES=sharesout,
                                              CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX)]
    FINAL_IND_REVIEW_TOP[, CAPPING:=CAPI_STK/CAPIFF]
    FINAL_IND_REVIEW_TOP[, idx_code:=idx_code]
    FINAL_IND_REVIEW_TOP[, idx_name:=idx_name]
    FINAL_IND_REVIEW_TOP[, date:=idx_date]
    
  } else {
    FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP [, .(K = 1, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                               SHARES=sharesout,
                                               CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX) ] 
    FINAL_IND_REVIEW_TOP[, idx_code:=idx_code]
    FINAL_IND_REVIEW_TOP[, idx_name:=idx_name]
    FINAL_IND_REVIEW_TOP[, date:=idx_date]
  }
  My.Kable.All (FINAL_IND_REVIEW_TOP)
  return (FINAL_IND_REVIEW_TOP )
}

# ==================================================================================================
DOWNLOAD_VND_STKVN_PRICESDAY_BY_CODE = function(pCodesource = 'VNM', start_date = '1962-01-01')  {
  # ------------------------------------------------------------------------------------------------
  # pCode = 'XYZ'
  # pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=30/12/2022&EndDate=30/12/2023&PageIndex=3&PageSize=20')
  # NbPagesBack = 20
  # pCode     = pCodesource
  Data_List = list()
  ToContinu = T
  k = 1
  while (ToContinu)
  {
    pURLk = paste0('https://finfo-api.vndirect.com.vn/v4/stock_prices?sort=date&q=code:',pCode,'~date:gte:',start_date,'~date:lte:',Sys.Date(),'&size=100&page=',k)
    CATrp(pURLk)
    x = try(jsonlite::fromJSON(pURLk))
    if (length(x$data)>0)
    {
      XData = try(as.data.table(x$data))
      if (all(class(XData)!='try-error'))
      {
        XData = CLEAN_COLNAMES(XData)
        Final_Data = XData[, .(source='VND', codesource=pCode, ticker=pCode, code=paste0('STKVN', pCode),
                               date      = as.Date(date), 
                               open      = 1000*as.numeric(open),
                               high      = 1000*as.numeric(high),
                               low       = 1000*as.numeric(low),
                               close_adj = 1000*as.numeric(adclose),
                               close     = 1000*as.numeric(close),
                               change    = 1000*as.numeric(change),
                               varpc     = as.numeric(change),
                               volume    = as.numeric(nmvolume),
                               reference = 1000*as.numeric(basicprice),
                               ceil      = 1000*as.numeric(ceilingprice),
                               floor     = 1000*as.numeric(floorprice),
                               turnover  = as.numeric(nmvalue))]
        My.Kable.TB(Final_Data)
        Data_List[[k]] = Final_Data
      } else {
        ToContinu = F
      }
    } else {
      ToContinu = F
    }
    k = k+1
  }
  CATln(pURLk); CATln('')
  Data_All = rbindlist(Data_List, fill=T)
  if (nrow(Data_All)>0)
  {
    Data_All = Data_All[order(date)]
    Data_All[, close_unadj := close]
    
    # Data_All[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
    # Data_All[!is.na(reference) & volume == 0, last := reference]
    # Data_All[volume == 0, close := last]
    # Data_All[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
    
    # Data_All[, reference:=close-change]
    Data_All[, rt:= close_adj/shift(close_adj) - 1]
    Data_All = STKVN_CLEAN_DATASETS(pData = Data_All)
    Data_All[!is.na(change) & !is.na(reference) & reference != 0, rt := change/reference]
    My.Kable(Data_All) 
    CATln_Border('CHECK ABNOMALIES')
    My.Kable(Data_All[is.na(rt) | is.na(reference) | is.na(close) | is.na(close_adj) | is.na(close_unadj) | is.na(volume)])
    
  } else {
    Data_All = data.table()
  }
  return(Data_All)
}
# ==================================================================================================
STKVN_CLEAN_DATASETS = function(pData){
  # ------------------------------------------------------------------------------------------------
  
  pData = Data_All
  pData[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
  pData[!is.na(reference) & is.na(volume), volume := 0]
  pData[reference == 0 & volume == 0 & !is.na(close_unadj), ':=' (reference = close_unadj)]
  pData[reference == 0 & volume == 0 & !is.na(close_unadj), ':=' (floor = close_unadj, ceil = close_unadj)]
  
  pData[reference == 0 & change == 0 & !is.na(close_unadj), reference := close_unadj]
  
  # pData[!is.na(reference) & reference != 0 & volume == 0, last := reference]
  if ('last' %in% names(pData)){
    pData[volume == 0, close := last]
  }
  My.Kable.TB(pData[reference == 0])
  return(pData)
  
}

# ==================================================================================================
INDEXES_UPDATE_VND_FROM_HISTORY = function(Folder       = UData, File_VND = 'DOWNLOAD_IFRC_INDPRVVND_HISTORY.rds', 
                                           File_History = 'DOWNLOAD_IFRC_INDPRV_HISTORY.rds', ToCheckDate = T) {
  # ------------------------------------------------------------------------------------------------
  
  DATA_OLD = data.table()
  if (file.exists(paste0(Folder, File_VND)))
  {
    if (!ToCheckDate | SUMMARY_DATE(paste0(Folder, File_VND)) < SUMMARY_DATE(paste0(Folder, File_History)))
    {
      x = CHECK_CLASS(try(CCPR_READRDS(Folder, File_History, ToKable = T, ToRestore = T)))
      if (nrow(x)>0)
      {
        VND = x[grepl('VND$', code)]
        My.Kable.Min(VND[order(date, code)])
        DATA_OLD = copy(VND)
        My.Kable.Min(DATA_OLD[order(date, code)])
        try(CCPR_SAVERDS(DATA_OLD, Folder, File_VND, ToSummary = T, SaveOneDrive = T))
      }
    }
  } else {
    x = CHECK_CLASS(try(CCPR_READRDS(Folder, File_History, ToKable = T, ToRestore = T)))
    if (nrow(x)>0)
    {
      VND = x[grepl('VND$', code)]
      My.Kable.Min(VND[order(date, code)])
      DATA_OLD = copy(VND)
      My.Kable.Min(DATA_OLD[order(date, code)])
      try(CCPR_SAVERDS(DATA_OLD, Folder, File_VND, ToSummary = T, SaveOneDrive = T))
    }
  }
  return(DATA_OLD)
}
# ==================================================================================================
My.Kable.INSREF = function(dt, pNb=3, pOption="CODES")  {
  # ----------------------------------------------------------------------------
  # My.Kable.INSREF(ins_ref[type=="FUT" & !is.na(yah)], pOption="ALL")
  switch (pOption,
          "CAPIUSD" = { My.Kable.TB(dt[, .(iso2, symbol, isin, code, eik, rts, blg, yah, inv, gog, nsd,  mwh, short_name, capiusd, enddate, last)], Nb=pNb) },
          "CODES"   = { My.Kable.TB(dt[, .(iso2, symbol, code, rts, blg, yah, inv, gog, bin, nsd, cnm, cnd,  mwh, cnbc, cboe, short_name, updated)], Nb=pNb) },
          "TB"      = { My.Kable.TB(dt[, .(ord,type, fcat, scat, symbol, isin, code, eik, rts, blg, yah, inv, bin, qdl, stx, gog,  
                                           mwh, short_name, country, continent, enddate, last)], Nb=pNb) },
          "SHORT"   = { My.Kable.TB(dt[, .(provider, ord, type, fcat, scat, symbol, isin, code, eik, rts, blg, yah, gog,  mwh, inv,short_name, country, continent, enddate, last)], Nb=pNb) },
          "ALL"     = { My.Kable.All(dt[, .(ord,type, fcat, scat, symbol, code, eik, rts, blg, yah, inv, bin, qdl,  stx, gog,  mwh, short_name, country, continent, enddate, last, cur)])},
          if (pNb==1 | nrow(dt)==1)
          {
            My.Kable.All(dt[, .(ord,type, fcat, scat, symbol, code, eik, rts, blg, yah, inv, bin, qdl, stx, gog,  mwh, short_name, country, continent, enddate, last, cur, provider)])
          } else {
            My.Kable(dt[, .(ord,type, fcat, scat, symbol, code, eik, rts, blg, yah, inv, bin, qdl, stx, gog, mwh, short_name, country, continent, enddate, last, cur, provider)], Nb=pNb)
          }
  )
}

# ==================================================================================================
DOWNLOAD_WEXC_IND_MYANPIX_HISTORY = function(ToIntegrate = T)
{
  if (SUMMARY_DATE(paste0(UData, 'DOWNLOAD_WEXC_IND_MYANPIX_HISTORY.rds')) < SYSDATETIME(23))
  {
    DBL_RELOAD_INSREF()
    Final_Data = data.table()
    My.Kable.INSREF(ins_ref[type=='IND' & country=='MYANMAR'])
    
    CODE_INDEX = 'INDMYANPIX'
    pURL = 'https://www.ktzrh.com/myanpix/'
    response   = GET(pURL, add_headers(
      `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
      ,`Accept-Language`= "en-US,en;q=0.5"
    ))
    xweb       = content(response, as="text")
    content    = try(rvest::read_html(xweb))
    # dataTXT    = content(response, as="text")
    
    tables     = content %>% html_table(fill = TRUE)
    
    xData      = as.data.table(tables[[2]])
    if (nrow(xData)>0)
    {
      xData      = CLEAN_COLNAMES(xData)
      
      xData[, date:=gsub('th','', date)]
      xData[, date:=gsub('st','', date)]
      xData[, date:=gsub('rd','', date)]
      xData[, date:=gsub('nd','', date)]
      xData[, date:=gsub('[.]','', date)]
      xData[, date:=gsub('Augu','Aug', date)]
      xData[, date:=gsub('Januray','Jan', date)]
      xData[, date:=gsub('Jay','Jan', date)]
      xData[, date:=gsub('Augts','Aug', date)]
      xData[, date:=gsub('Octboer','Oct', date)]
      xData[, date:=gsub('Augu','Aug', date)]
      setnames(xData, 'tradingvolume(shares)', 'tradingvolume')
      setnames(xData, 'tradingvalue(mmk)', 'tradingvalue')
      setnames(xData, 'date', 'datestr')
      xData[, date := as.Date(datestr, '%d %B %Y')]
      My.Kable(xData)  
      My.Kable(xData[is.na(date)])  
      
      Final_Data = xData[, .(source='WEXC', code=CODE_INDEX,
                             datestr,
                             date = as.Date(datestr, '%d %B %Y'), 
                             open=as.numeric(gsub(',','', open)),
                             high=as.numeric(gsub(',','', high)),
                             low=as.numeric(gsub(',','', low)),
                             close=as.numeric(gsub(',','', close)),
                             nb_companies=as.numeric(gsub(',','', no_oflistedcompanies)),
                             volume=as.numeric(gsub(',','', tradingvolume)),
                             turnover=as.numeric(gsub(',','', tradingvalue))
      )]
      
      Final_Data = Final_Data[order(date)]
      My.Kable(Final_Data[is.na(date)])  
      
      My.Kable(Final_Data)  
      
      Final_Data[, ':='(change = close- shift(close), rt=(close/shift(close) ) -1)]
      Final_Data[, ':='(varpc = 100 * rt)]
      Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption = 'FINAL')
      Final_Data = Final_Data[order(date)]
      Final_Data$datestr = NULL
      My.Kable.Min(Final_Data)
      
      if (ToIntegrate)
      {
        try(CCPR_SAVERDS(Final_Data, UData, 'DOWNLOAD_WEXC_IND_MYANPIX_PRICES_TODAY.rds', ToSummary = T))
        try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = UData, File_Fr     = 'DOWNLOAD_WEXC_IND_MYANPIX_PRICES_TODAY.rds', 
                                                                  Folder_To   = UData, File_To     = 'DOWNLOAD_WEXC_IND_MYANPIX_HISTORY.rds', 
                                                                  pCondition  = 'type=="IND"', 
                                                                  RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
        
        try(CCPR_SAVERDS(Final_Data, UData, 'DOWNLOAD_WEXC_IND_PRICES_TODAY.rds', ToSummary = T))
        try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = UData, File_Fr     = 'DOWNLOAD_WEXC_IND_PRICES_TODAY.rds', 
                                                                  Folder_To   = UData, File_To     = 'DOWNLOAD_WEXC_IND_HISTORY.rds', 
                                                                  pCondition  = 'type=="IND"', 
                                                                  RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
        
      }
    }
  }
  return(Final_Data)
}

# ==================================================================================================
DOWNLOAD_WEXC_IND_LAOS_HISTORY = function(FromDate, ToDate, ToIntegrate = T)  {
  # ------------------------------------------------------------------------------------------------
  fromDate = gsub('-','', FromDate)
  toDate = gsub('-','', ToDate)
  pURL <- paste0('http://www.lsx.com.la/market/index/daily.do?lang=en&indexGroupCode=001&fromDate=', fromDate, '&toDate=', toDate, '#')
  response <- GET(pURL, add_headers(
    `User-Agent` = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0",
    `Accept-Language` = "en-US,en;q=0.5"
  ))
  status_code(response)
  xweb <- content(response, as="text")
  content <- try(rvest::read_html(xweb))
  
  tables <- content %>% html_table(fill = TRUE)
  xData <- as.data.table(tables[[3]])
  xData <- CLEAN_COLNAMES(xData)
  
  # xData[, `:=`(
  #   date = as.Date(date, format = "%Y/%m/%d"),
  #   open = convert_to_numeric(opening_index),
  #   close = convert_to_numeric(closing_index),
  #   high = convert_to_numeric(high),
  #   low = convert_to_numeric(low),
  #   volume = convert_to_numeric(trading_volumeshr),
  #   turnover = convert_to_numeric(trading_valuelak)
  # )]
  Final_Data =xData[, .(code = CODE_INDEX, source = 'WEXC',
                        date = as.Date(date, format = "%Y/%m/%d"),
                        open = convert_to_numeric(opening_index),
                        high = convert_to_numeric(high),
                        low = convert_to_numeric(low),
                        close = convert_to_numeric(closing_index),
                        volume = convert_to_numeric(trading_volumeshr),
                        turnover = convert_to_numeric(trading_valuelak)
  )
  ][order(date)]
  Final_Data[, ':='(change = close- shift(close), rt=(close/shift(close) ) -1)]
  Final_Data[, ':='(varpc = 100 * rt)]
  Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption = 'FINAL')
  if (nrow(Final_Data)>0)
  {
    My.Kable(Final_Data)
    if (ToIntegrate)
    {
      try(CCPR_SAVERDS(Final_Data, UData, 'DOWNLOAD_WEXC_IND_PRICES_TODAY.rds', ToSummary = T))
      try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = UData, File_Fr     = 'DOWNLOAD_WEXC_IND_PRICES_TODAY.rds', 
                                                                Folder_To   = UData, File_To     = 'DOWNLOAD_WEXC_IND_HISTORY.rds', 
                                                                pCondition  = 'type=="IND"', 
                                                                RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
      
    }
  }
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_MERGE_TOP_COMPO = function ( LIST_SEC = c('log','brk','pet','rst','rtl','bnk','hlc','eny','fin','ari'), 
                                     SaveFolder = '', ToUpload = F, pDate = Sys.Date()) {
  # ------------------------------------------------------------------------------------------------
  
  if (length (LIST_SEC) >0) {
    TEST_LOG = list()
    for (i in 1: length (LIST_SEC))
    {
      # i = 10
      sec = LIST_SEC [i]
      switch (sec,
              'log' = {
                sname  = 'LOGISTICS'
              },
              'brk' = {
                sname  = 'BROKERAGE'
              },
              'pet' = {
                sname  = 'PETROLIMEX'
              },
              'rst' = {
                sname  = 'REALESTATE'
              },
              'rtl' = {
                sname  = 'RETAIL'
              },
              'bnk' = {
                sname  = 'BANK'
              },
              'hlc' = {
                sname  = 'HEALTHCARE'
              },
              'eny' = {
                sname  = 'ENERGY'
              },
              'fin' = {
                sname  = 'FINANCE'
              },
              'ari' = {
                sname  = toupper( 'Artificial intelligence' )
              }
      )
      
      # INDVNXSECRTLEWPRVND
      compo1  = REVIEW_TRADABLE_INDEX ( NB_TOP    = 10, File_folder = UData, File_name = 'ifrc_beq_stkvn_4index.rds',
                                        WgtLimit  = 20, pSector = toupper(sec ), 
                                        StartDate = '2023-07-01', EndDate = pDate, idx_code = paste0('INDVNXSEC',toupper(sec ),'EWPRVND'), idx_name = paste0('IFRC VNX SECTOR ',sname,'EW TOP 10')  )
      Sys.sleep (2)
      compo2  = REVIEW_TRADABLE_INDEX ( NB_TOP    = 10, File_folder = UData, File_name = 'ifrc_beq_stkvn_4index.rds',
                                        WgtLimit  = 20, pSector = toupper(sec ), 
                                        StartDate = '2023-07-01', EndDate = pDate, idx_code = paste0('INDVNXSEC',toupper(sec ),'CWPRVND'), idx_name = paste0('IFRC VNX SECTOR ',sname,'CW TOP 10')  )
      Sys.sleep (2)
      
      DATA = rbind (compo1, compo2, fill = T)
      TEST_LOG [[i]] = DATA
    }
    
    TOP_COMPO = rbindlist (TEST_LOG, fill = T)
    TOP_COMPO [, idx_code := toupper (idx_code)]
    TOP_COMPO [CAPI_STK<1 ]
    x = CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_ind_compo.rds')
    sector = unique (x, by = 'code')
    TOP_COMPO = merge (TOP_COMPO, sector[,. (CODE = code, SECTOR = toupper (sector), INDUSTRY = toupper (industry))], all.x = T, by = 'CODE')
    TOP_COMPO [, CATEGORY := substr (idx_code,10,12)]
    TOP_COMPO [, code_mother := idx_code]
    TOP_COMPO = CLEAN_COLNAMES (TOP_COMPO)
    TOP_COMPO[, updated := SYS.TIME()]
    TOP_COMPO[, capibn_stk := capi_stk/1000000000]
    
    My.Kable.All (TOP_COMPO)
    if (nchar (SaveFolder ) > 0)
      
    {
      CCPR_SAVERDS(TOP_COMPO[capi_stk>1 ], SaveFolder, 'dbl_ind_compo_top.rds')
    } 
  }
  
  if (ToUpload) {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = "dashboard_live", l.tablename = "dbl_ind_compo_top",
                                     l.filepath= tolower(paste0(SaveFolder , "dbl_ind_compo_top.rds")),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
  }
  
  return (TOP_COMPO[capi_stk>1 ])
}

# ==================================================================================================
DOWNLOAD_INDEX_CROBEX_BY_DATE_RANGE = function(start_date = SYSDATETIME(hour(Sys.time())), CodeInt = 'INDCRO10') {
  # ------------------------------------------------------------------------------------------------
  pURL = paste0('https://zse.hr/json/indexHistory/HRZB00ICBE11/', start_date-31, '/-/hr?restAPI=https://rest.zse.hr/web/Bvt9fe2peQ7pwpyYqODM/')
  x = jsonlite::fromJSON(pURL)
  # x
  xData = CHECK_CLASS(try(as.data.table(x$rows)))
  
  if (nrow(xData)>0)
  {
    xData = CLEAN_COLNAMES(xData)
    # My.Kable.TB(xData)
    Final_Data = xData[, .(source  = 'WEXC', code = CodeInt, 
                           date    = as.Date(substr(date,1,10), '%d.%m.%Y'), 
                           open    = as.numeric(gsub(',', '.', gsub('[.]','', open_value))),
                           high    = as.numeric(gsub(',', '.', gsub('[.]','', high_value))),
                           low     = as.numeric(gsub(',', '.', gsub('[.]','', low_value))),
                           close   = as.numeric(gsub(',', '.', gsub('[.]','', last_value))),
                           turnover = as.numeric(gsub(',', '.', gsub('[.]','', turnover)))
    )
    ]
    My.Kable.TB(Final_Data)
  } else { Final_Data = data.table()}
  return(Final_Data)
}
# ==================================================================================================
INDEXES_UPDATE_VND_FROM_HISTORY_OLD = function(Folder       = UData, File_VND = 'DOWNLOAD_IFRC_INDPRVVND_HISTORY.rds', 
                                               File_History = 'DOWNLOAD_IFRC_INDPRV_HISTORY.rds', ToCheckDate = T) {
  # ------------------------------------------------------------------------------------------------
  
  DATA_OLD = data.table()
  if (!ToCheckDate | SUMMARY_DATE(paste0(Folder, File_VND)) < SUMMARY_DATE(paste0(Folder, File_History)))
  {
    x = CHECK_CLASS(try(CCPR_READRDS(Folder, File_History, ToKable = T, ToRestore = T)))
    if (nrow(x)>0)
    {
      VND = x[grepl('VND$', code)]
      My.Kable.Min(VND[order(date, code)])
      DATA_OLD = CCPR_READRDS(Folder, File_VND, ToKable = T, ToRestore = T)
      DATA_OLD = rbind(DATA_OLD[!code %in% VND$code], VND, fill=T)
      My.Kable.Min(DATA_OLD[order(date, code)])
      try(CCPR_SAVERDS(DATA_OLD, Folder, File_History, ToSummary = T, SaveOneDrive = T))
    }
  }
  return(DATA_OLD)
}

# ==================================================================================================
TRAINEE_STKVN_WCEO_DAILY_REPORT = function(pDate = "2024-06-14",pFolder = "S:/STKVN/BOARD/WOMAN_CEO/",
                                           pFile = "data_stkvn_ceo_day.rds"){
  # ------------------------------------------------------------------------------------------------
  dt_wceo = CCPR_READRDS(pFolder,paste0("ccpr_stkvn_board_",gsub("-","",pDate),".rds"))
  
  # My_Data =  TRAINEE_CALCULATE_FILE_PERFORMANCE  (pData = data.table(), pFolder =  'S:/STKVN/PRICES/FINAL/',
  #                                                 pFile   = 'IFRC_CCPR_STKVN_FOR_DASHBOARD.RDS', EndDate  = pDate ) 
  
  dt_stkvn = CCPR_READRDS("S:/STKVN/PRICES/FINAL/DAY/",paste0("final_stkvn_4index_day_",gsub("-","",pDate),".rds"))
  
  dt_wceo = merge(dt_wceo[code %in% dt_stkvn$code,.(code,date,company_name=name,ceo=people_name,gender)],
                  dt_stkvn[,.(code,market,sharesout,close,rt,capibvnd=capivnd/1000000000)], by="code", all.x=T)
  
  icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
  dt_wceo = merge(dt_wceo, icb[,.(code, sector=icb1_name, industry=icb2_name)],by="code",all.x=T)
  
  dt_wceo = dt_wceo[order(-capibvnd)]
  dt_wceo[, sum_capi:=sum(capibvnd), by='date']
  dt_wceo[, cum_capi:=cumsum(capibvnd), by='date']
  dt_wceo[, pc_capi:=100*cum_capi/sum_capi, by='date']
  dt_wceo[pc_capi<=85, size:='LARGE']
  dt_wceo[pc_capi>85 & pc_capi<=95, size:='MID']
  dt_wceo[pc_capi>95, size:='SMALL']
  dt_wceo$pc_capi = NULL
  dt_wceo$cum_capi = NULL
  dt_wceo$sum_capi = NULL
  
  My.Kable(dt_wceo[order(-capibvnd)])
  CCPR_SAVERDS(dt_wceo[order(-capibvnd)], pFolder,pFile)
  CCPR_SAVERDS(dt_wceo[order(-capibvnd)], pFolder,gsub("day.rds",paste0(gsub("-","",pDate),".rds"),pFile))
  
  CCPR_SAVERDS(dt_wceo[order(-capibvnd)], paste0("S:/SHINY/STKVN/CEO/"), pFile)
  try(TRAINEE_CONVERT_FILE_RDS_TO_FST(pData = data.table(), File_Folder = paste0("S:/SHINY/STKVN/CEO/"), File_Name = pFile, FST_Folder = ''))
  
  # ceo_hist = CCPR_READRDS(pFolder, gsub("day.rds","history.rds",pFile))
  # CCPR_SAVERDS(dt_wceo, pFolder,"data_stkvn_ceo_day.rds")
  
  
  CCPR_SAVERDS(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)], pFolder,gsub("ceo","wceo",pFile))
  CCPR_SAVERDS(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)], pFolder,gsub("day.rds",paste0(gsub("-","",pDate),".rds"),gsub("ceo","wceo",pFile)))
  CCPR_SAVERDS(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)], paste0("S:/SHINY/STKVN/WCEO/"),gsub("ceo","wceo",pFile))
  try(TRAINEE_CONVERT_FILE_RDS_TO_FST(pData = data.table(), File_Folder = paste0("S:/SHINY/STKVN/WCEO/"), File_Name = gsub("ceo","wceo",pFile), FST_Folder = ''))
  My.Kable(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)])
  return(dt_wceo)
}

# ==================================================================================================
TRAINEE_MERGE_STKVN_BOARD_DAY = function  (  Fr_Folder =  paste0('S:/STKVN/BOARD/WOMAN_CEO/') ,
                                             pFolder =   paste0('S:/STKVN/BOARD/WOMAN_CEO/'),
                                             LIST_SOURCES = list('CAF','VST','VND'),
                                             pPrefix = 'ccpr',  
                                             CheckDate = '2024-06-14' ,
                                             ToIntegrateHistory = F) {
  # ------------------------------------------------------------------------------------------------
  
  # MERGE CEO 
  LastTrading = CCPR_LAST_TRADING_DAY_VN(09, ToPrompt = T)
  # LIST_SOURCES = list( 'VND', 'CAF', 'VST')
  DATA_MERGE = data.table()
  pData = list ()
  for (k in 1:length(LIST_SOURCES))
  {
    # k =3
    pSource     = LIST_SOURCES[[k]]
    File_Folder = Fr_Folder
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    
    if ( nrow (File_Data) > 0) 
    {
      if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'ceo', 'source') %in% names(File_Data) ) )
      {
        switch (pSource,
                'VND' = {
                  xData = File_Data[ceo==1, .(code, date, source,gender, value=as.character(people_name))] 
                } ,
                'CAF' = {
                  xData = File_Data[ceo==1, .(code, date, source,gender, value=as.character(people_name))] 
                },
                'VST' = {
                  File_Data[,since:=as.Date(since,"%m/%d/%Y")]
                  File_Data[,maxsince:=max(since),by="code"]
                  xData = File_Data[ceo==1 & since==maxsince, .(code, date, source,gender, value=as.character(fullname_lc))] 
                }
        )
        
        pData [[k]] = xData
        My.Kable( pData [[k]] )
        Sys.sleep(2)
      }
    }
    
  }
  DATA_MERGE = rbindlist(pData, fill=T)
  DATA_MERGE [, source := as.character (source)]
  
  My.Kable(DATA_MERGE[order(-date, code)])
  
  
  DATA_ALL = unique(DATA_MERGE, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
  unique(DATA_ALL, by = 'source')
  MaxDate   = max(DATA_ALL [!is.na(date)]$date)
  DATA_ALL  = DATA_ALL[date==MaxDate]
  xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_ALL = unique (DATA_ALL, by = c('code','source','value'))
  
  DATA_SPD = TRAINEE_FINAL_SOURCES_DATASET(pData=copy(DATA_ALL[,. (source, date, code, value)]),
                                           Dataset="CEO", KeySpread="source", ValueSpread="value",
                                           ExcludeCols = c("code","date"))
  
  My.Kable.TB(DATA_SPD[order(date, code)])
  DATA_SPD [, ':='(people_name = final)]
  
  
  # MERGE GENDER --------------------------------------------
  
  CEO_LIST = DATA_SPD [,.(code, people_name = final)]
  CEO_LIST [, name_clean := decodeVN(people_name, from='Unicode', to='Unicode', diacritics=F)]
  DATA_MERGE = CEO_LIST
  File_Data = setDT (read.xlsx('S:/R/DATA/BOARD/LIST/name_with_gender.xlsx'))
  xData = File_Data [,. (name_clean = pname, gender )]
  DATA_MERGE = unique ( merge (DATA_MERGE,xData , all.x = T, by = 'name_clean'), by = 'name_clean' ) [, source := 'EXCEL']
  
  Data = list()
  for (i in 1:length(LIST_SOURCES))
  {
    # i = 1
    pSource     = LIST_SOURCES[[i]]
    File_Folder = Fr_Folder
    
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    File_Data [, gender := trimws(gender)]
    File_Data [gender == 'FEMALE', gender := 'F']
    File_Data [gender == 'MALE', gender := 'M']
    File_Data = File_Data [nchar (code) == 8]
    
    if ( nrow (File_Data) > 0) 
    {
      switch (pSource,
              'VND' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name & ceo==1] [,.( code,source, people_name,  gender)] 
              } ,
              'CAF' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name & ceo==1] [,.(code, source, people_name,  gender)] 
              },
              'VST' = {
                File_Data[,since:=as.Date(since,"%m/%d/%Y")]
                File_Data[,maxsince:=max(since),by="code"]
                xData = File_Data [fullname_lc %in% CEO_LIST$people_name & ceo==1 & since==maxsince] [,.(code,source, people_name = fullname_lc,  gender)] 
              }
      )
      Data [[i]] = xData
    }
    
  }
  
  DATA_ALL = rbindlist (Data, fill = T)
  DATA_MERGE = rbind (DATA_MERGE[!is.na(people_name)] [,.(people_name, code, gender, source)], DATA_ALL, fill =T)
  DATA_MERGE = DATA_MERGE[!is.na(people_name)]
  xCOUNT = DATA_MERGE[!is.na(people_name)][, .(n=.N), by=c('code', 'gender')][!is.na(gender)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_MERGE = unique( DATA_MERGE[!is.na(gender)] , by = c('code', 'source' , 'people_name') )
  
  DATA_SPDg = TRAINEE_FINAL_SOURCES_DATASET(pData=copy(DATA_MERGE[,. (source, code, people_name, gender)]),
                                            Dataset="GENDER", KeySpread="source", ValueSpread="gender",
                                            ExcludeCols = c("code","people_name"))
  DATA_SPD = merge (DATA_SPD [,.(code,date,people_name, dataset)], DATA_SPDg [,. (people_name, gender = final)], all.x = T, by = 'people_name')
  DATA_SPD [!is.na(people_name)]
  
  market   = CCPR_READRDS("S:/STKVN/PRICES/FINAL/","final_stkvn_market_4index_day.rds")
  DATA_SPD = merge (DATA_SPD, market [,.(code, market)], all.x = T, by ='code')
  DATA_SPD = unique (DATA_SPD , by = c ('code', 'people_name'))
  DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
  
  DATA_SPD [gender == 'F', gender := 'FEMALE']
  DATA_SPD [gender == 'M', gender := 'MALE']
  
  My.Kable.TB ( DATA_SPD[order(date, code)])
  My.Kable.TB ( DATA_SPD[order(date, code)][is.na(people_name)])
  
  FileBoard = paste0 (  pPrefix, "_stkvn_board_", gsub('-','',CheckDate),".rds")
  FileWCEO  = paste0 (  pPrefix, "_stkvn_wceo_", gsub('-','',CheckDate),".rds")
  
  saveRDS  (DATA_SPD, paste0 (  pFolder,FileBoard  ) )
  CATln_Border( paste ('SAVED: ',paste0 (  pFolder,FileBoard  ) ) )
  
  DATA_WCEO = DATA_SPD [gender == 'FEMALE' & market!="UPC"] 
  if (nrow (DATA_WCEO >0))
  {
    My.Kable (DATA_WCEO)
    saveRDS  (DATA_WCEO ,paste0 (  pFolder, FileWCEO ) )
    CATln_Border( paste ('SAVED: ',paste0 (  pFolder, FileWCEO )  ) )
  }
  
  if (ToIntegrateHistory) 
  {
    if (nrow (DATA_SPD) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileBoard, ToKable = T, ToRestore = T)
      Data_All = unique(rbind(Data_Old, DATA_SPD, fill=T), by=c('code', 'date'))
      Data_All = MERGE_DATASTD_BYCODE(Data_All, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_All[order(date, code)][, .( code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_All, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileBoard),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
    if (nrow (DATA_WCEO) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileWCEO, ToKable = T, ToRestore = T)
      Data_WCEO = unique(rbind(Data_Old, DATA_WCEO, fill=T), by=c('code', 'date'))
      Data_WCEO = MERGE_DATASTD_BYCODE(Data_WCEO, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_WCEO[order(date, code)][, .( code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_WCEO, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileWCEO),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
  }
  return (DATA_SPD)
}

DBL_MERGE_DATA_IND_BY_LIST = function( Index_Folder = '', Index_File = '', 
                                       IndFolder="S:/CCPR/DATA/DASHBOARD_LIVE/", IndFile="ccpi_dashboard_indbeq_all_history.rds",
                                       ToFilter = T, Check_Empty = T,min_nb_files = 2000,
                                       SaveFolder="S:/CCPR/DATA/DASHBOARD_LIVE/", SaveFile="ccpi_dashboard_indbeq_all_history.rds",
                                       UploadTable="dbl_ind_day_chart") {
  # ------------------------------------------------------------------------------------------------
  # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_INDALS_history.rds'
  # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_INDCURCRY_history.rds'
  # Index_Folder = 'S:/WCEO_INDEXES/'; Index_File = 'ifrc_ccpr_indwceo_all_history.rds'
  # Index_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; Index_File = 'ifrc_ccpr_investment_history.rds'
  # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_indgrp_history.rds'
  
  # Index_Folder = ''
  # Index_File = ''
  # min_nb_files = 2
  
  DBL_RELOAD_INSREF(ToForce = (runif(1,1,100) > 70))
  To_Continue = T
  list_todo = data.table()
  selection = data.table()
  selection_All = data.table()
  
  selection_fields = c("short_name","name","code","date","close","close_adj","rt","change","varpc","code_mother",
                       "iso2","country","continent","type","coverage","category")
  
  
  if (nchar(Index_Folder) > 0 & nchar(Index_File) > 0 & file.exists(paste0(Index_Folder,Index_File))){
    data = CHECK_CLASS(try(CCPR_READRDS(Index_Folder, Index_File, ToKable = T, ToRestore = T)))
    if ( nrow(data) > 0 )
    {
      list_todo = data.table(active = 1, folder = Index_Folder, filename = Index_File, filter = as.character(NA))
      
    }else{
      To_Continue = F
    }
  }else{
    #selection = CHECK_CLASS(try(CCPR_READRDS(IndFolder,IndFile)))
    list_files = setDT(fread("S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_ind_history.txt"))
    list_files = list_files[active==1]
    if (nrow(list_files) >= min_nb_files)
    {
      list_todo = list_files[1:min_nb_files,]
    }else{
      list_todo = copy(list_files)
    }
    
  }
  # My.Kable(list_todo)
  if (To_Continue & nrow(list_todo) > 0)
  {
    selection_All = CHECK_CLASS(try(CCPR_READRDS(IndFolder,IndFile, ToKable = T, ToRestore = T)))
    # My.Kable(selection_All)
    if ( nrow(selection_All) > 0)
    {
      selection_All = selection_All[,..selection_fields]
      # My.Kable(selection_All)
      # My.Kable.All(unique(selection_All[order(code,-date)],by="code")[,-c("short_name")])
    }
    dt_list = list()
    codemother = CHECK_CLASS(try(CCPR_READRDS("S:/CCPR/DATA/DASHBOARD_LIVE/","dbl_ind_mother.rds", ToKable = T, ToRestore = T)))
    
    for (ifile in 1:nrow(list_todo) ) 
    {
      # ifile=1
      x = CHECK_CLASS(try(CCPR_READRDS(list_todo[ifile]$folder, list_todo[ifile]$filename)))
      if (nrow(x)>0)
      {
        x = merge(x[,-c("new_name","new_short_name")], codemother[,.(code,new_name=name,new_short_name=short_name)],
                  by="code",all.x=T)
        
        no_name = x[is.na(new_name)]
        
        if (nrow(no_name) > 0){
          no_name = merge(no_name[,-c("new_name","new_short_name")], ins_ref[,.(code,new_name=name,new_short_name=short_name)],
                          by="code",all.x=T)
          
          x = rbind(x[!code %in% no_name$code], no_name, fill = T)
        }
        rm(no_name)
        
        
        
        # My.Kable(x)
        if (Index_File == 'download_ifrc_INDCURCRY_history.rds')
        {
          x[, cur := 'USD']
          x[, prtr := 'PR']
          x[, wgtg := substr(code, nchar(code) - 1, nchar(code))]
          x[, coverage := 'INTERNATIONAL']
          x[grepl('TOP', name), category := 'TRADABLE']
          x[!grepl('TOP', name), category := 'BENCHMARK']
          
          
        }
        if (!"name" %in% names(x)) { x[, name:=new_name] }
        if (!"short_name" %in% names(x)) { x[, short_name:=new_short_name] }
        x[is.na(name) & !is.na(new_name), name:=new_name]
        x[is.na(short_name) & !is.na(new_short_name), short_name:=new_short_name]
        x[is.na(short_name) & !is.na(name), short_name:=name]
        x[!is.na(short_name) & is.na(name), name:=short_name]
        # My.Kable(x)
        if (ToFilter)
        {
          if (grepl(",",list_todo[ifile]$filter))
          {
            x = x[code %in% unlist(str_split(list_todo[ifile]$filter, ","))]
          }else{
            if(!is.na(list_todo[ifile]$filter))
            {
              x = x[grepl(list_todo[ifile]$filter,code)]
            }
            
            # My.Kable(x)
          }
        }
        x_selection = intersect(names(x),selection_fields)
        # My.Kable(x)
        x = x[,..x_selection]
        x = x[close!=0 & !is.na(close) & !is.na(date)]
        dt_list[[ifile]] = x[!is.na(name)]
        # My.Kable.Min(x)
        rm(x)
      }
    }
    GC_SILENT()
    
    # HISTORY FILTERS
    dtlist = rbindlist(dt_list, fill=T)
    if (nrow(dtlist) > 0 & all(c("code", "date") %in% names(dtlist)) )
    {
      dtlist = unique(dtlist[order(code,date)],by=c("code","date"))
    }
    rm(dt_list)
    GC_SILENT()
    length(intersect(names(dtlist),selection_fields))==length(selection_fields)
    if (nrow(selection_All) > 0)
    {
      selection = selection_All[,date:=as.Date(date)][!code %in% dtlist$code]
    }
    rm(selection_All)
    selection = rbind(selection, dtlist, fill=T)
    #selection = rbind(selection[,date:=as.Date(date)][!code %in% dtlist$code], dtlist, fill=T)
    selection = merge(selection, ins_ref[type=="IND",.(code,new_ios2=iso2,new_country=country,new_continent=continent,new_type=type)],by="code",all.x=T)
    selection[is.na(iso2) & !is.na(new_ios2), iso2:=new_ios2]
    selection[is.na(country) & !is.na(new_country), country:=new_country]
    selection[is.na(continent) & !is.na(new_continent), continent:=new_continent]
    selection[is.na(type) & !is.na(new_type), type:=new_type]
    selection = selection[,-c("new_ios2","new_country","new_continent","new_type")]
    selection[,":="(rt=close/shift(close) -1, change=close-shift(close), close_adj=close),by="code"]
    selection[,varpc:=100*rt]
    
    # My.Kable(codemother)
    # if (nrow(codemother) > 0 & )
    # selection = merge(selection, ins_ref[,.(code, new_coverage = coverage, new_category = category)],
    #                   by="code",all.x=T)
    # selection = merge(selection, codemother[,.(code,new_name=name,new_shortname=short_name,new_codemother=index_compo)],
    #                   by="code",all.x=T)
    # # selection[is.na(name)]
    # selection[is.na(name) & !is.na(new_name), name := new_name]
    # selection[is.na(short_name) & !is.na(new_shortname), short_name:=new_shortname]
    # selection[is.na(code_mother) & !is.na(new_codemother), code_mother:=new_codemother]
    # selection[is.na(coverage) & !is.na(new_coverage), coverage:=new_coverage]
    # 
    # selection[is.na(category) & !is.na(new_category), category:=new_category]
    # 
    # # selection[is.na(name)]
    # selection = selection[,-c("new_name","new_shortname","new_codemother", "new_category", "new_coverage")]
    # 
    # selection[,name:=gsub("^IFRC/BEQ HOLDINGS IFRC/BEQ HOLDINGS ","IFRC/BEQ HOLDINGS ",name)]
    # selection[,short_name:=gsub("^IFRC/BEQ HOLDINGS IFRC/BEQ HOLDINGS ","IFRC/BEQ HOLDINGS ",name)]
    # selection[,short_name:=gsub("^IFRC ","",short_name)]
    # selection[,short_name:=gsub("^IFRC/BEQ HOLDINGS ","",short_name)]
    
    selection = UPDATE_UPDATED(selection)
    # setkeyv(selection, c("code", "date"))
    selection = selection[code != 'XXZY']
    # My.Kable(selection)
    # My.Kable(selection[grepl('CRYPTO', name)])
    # # str(selection)
    # My.Kable(unique(selection[order(code,-date)],by="code"))
    
    summary = selection[,.(n=.N,start=date[1],end=date[.N]),by="code"]
    summary = summary[end>=SYSDATETIME(1)-20]
    
    selection = selection[code %in% summary$code | grepl('INDVNXWM',code)]
    
    # selection[grepl("ETF INDEX", name), ':=' (coverage = "INTERNATIONAL", category = 'TRADABLE', prtr = 'PR',wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
    # 
    # # My.Kable.Min(selection[order(date, code)])
    # # My.Kable(unique(selection[order(code, -date)][grepl("ETF INDEX", name)], by = 'code')[,. (code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    # 
    # selection[grepl("WOMEN", name), ':=' (prtr = substr(code, nchar(code)-4, nchar(code) - 3),wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
    # selection[grepl("WOMEN", name) & grepl('VIETNAM', name) & !grepl('TOP', name), ':=' (coverage = "VIETNAM", category = 'BENCHMARK')]
    # selection[grepl("WOMEN", name) & grepl('VIETNAM', name) & grepl('TOP', name), ':=' (coverage = "VIETNAM", category = 'TRADABLE')]
    # 
    # selection[grepl("WOMEN", name) & !grepl('VIETNAM', name) & !grepl('TOP', name), ':=' (coverage = "INTERNATIONAL", category = 'BENCHMARK')]
    # selection[grepl("WOMEN", name) & !grepl('VIETNAM', name) & grepl('TOP', name), ':=' (coverage = "INTERNATIONAL", category = 'TRADABLE')]
    # 
    # selection[substr(name, nchar(name), nchar(name)) == ')' & substr(code, nchar(code) - 2, nchar(code)) == 'LOC', cur := substr(word(name, 2, 2, '[(]'),1,3)]
    # selection[, type := substr(code, 1, 3)]
    # 
    # selection[grepl("VNX ", name) & !grepl('TOP', name) & is.na(coverage) & is.na(category), ':=' (coverage = "VIETNAM", category = 'BENCHMARK')]
    # selection[grepl("VNX ", name) & grepl('TOP', name)  & is.na(coverage) & is.na(category), ':=' (coverage = "VIETNAM", category = 'TRADABLE')]
    # selection[grepl("VNX GROUP", name), ':=' (prtr = substr(code, nchar(code)-4, nchar(code) - 3),wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
    
    
    # My.Kable.All(unique(selection[grepl('IFRC', name)], by = 'code')[,.(n=.N,start=date[1],end=date[.N]),by= c("coverage", "category")])
    # 
    # My.Kable(unique(selection[order(code, -date)][grepl("WOMEN", name)], by = 'code')[,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    # 
    # My.Kable(unique(selection[order(code, -date)][grepl('IFRC', name) & (is.na(coverage) | is.na(category))], by = 'code')[,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    # 
    # My.Kable(selection[order(date, date)][grepl('IFRC', name)][,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    
    
    selection = DBL_IND_TO_CLEAN(IND_DATA = selection, FOLDER_DATA = UData, FILE_DATA = '', ToSave = F, ToCleanFields = F, ToExclude = T)[order(code,date)]
    
    selection[, new_name := name]
    selection = merge(selection[,-c("name","short_name","code_mother","coverage","category","prtr","wgtg" ,"cur")],
                      codemother[,.(code,name,short_name,code_mother = index_compo,coverage,category,prtr = version,wgtg ,cur)], 
                      by="code", all.x=T)
    # selection[is.na(name)]
    selection[is.na(name), name := new_name]
    selection[is.na(short_name), short_name := new_name]
    selection$new_name = NULL
    try(CCPR_SAVERDS(selection, SaveFolder, SaveFile, ToSummary = T, SaveOneDrive = T))
    
    GC_SILENT()
    
    if (nchar(UploadTable)>0)
    {
      try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= UploadTable,
                                       l.filepath= tolower(paste0(SaveFolder,SaveFile)),
                                       CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    }
    
    return(selection)
  }
  rm(selection)
}

# ==================================================================================================
DBL_MERGE_DATA_IND_BY_LIST_OLD = function( Index_Folder = '', Index_File = '', 
                                           IndFolder="S:/CCPR/DATA/DASHBOARD_LIVE/", IndFile="ccpi_dashboard_indbeq_all_history.rds",
                                           ToFilter = T, Check_Empty = T,min_nb_files = 2000,
                                           SaveFolder="S:/CCPR/DATA/DASHBOARD_LIVE/", SaveFile="ccpi_dashboard_indbeq_all_history.rds",
                                           UploadTable="dbl_ind_day_chart") {
  # ------------------------------------------------------------------------------------------------
  # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_INDALS_history.rds'
  # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_INDCURCRY_history.rds'
  # Index_Folder = 'S:/WCEO_INDEXES/'; Index_File = 'ifrc_ccpr_indwceo_all_history.rds'
  # Index_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/'; Index_File = 'ifrc_ccpr_investment_history.rds'
  
  # Index_Folder = ''
  # Index_File = ''
  # min_nb_files = 2
  
  DBL_RELOAD_INSREF(ToForce = (runif(1,1,100) > 70))
  To_Continue = T
  list_todo = data.table()
  selection = data.table()
  selection_All = data.table()
  
  selection_fields = c("short_name","name","code","date","close","close_adj","rt","change","varpc","code_mother",
                       "iso2","country","continent","type","coverage","category")
  
  
  if (nchar(Index_Folder) > 0 & nchar(Index_File) > 0 & file.exists(paste0(Index_Folder,Index_File))){
    data = CHECK_CLASS(try(CCPR_READRDS(Index_Folder, Index_File, ToKable = T, ToRestore = T)))
    if ( nrow(data) > 0 )
    {
      list_todo = data.table(active = 1, folder = Index_Folder, filename = Index_File, filter = as.character(NA))
      
    }else{
      To_Continue = F
    }
  }else{
    #selection = CHECK_CLASS(try(CCPR_READRDS(IndFolder,IndFile)))
    list_files = setDT(fread("S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_ind_history.txt"))
    list_files = list_files[active==1]
    if (nrow(list_files) >= min_nb_files)
    {
      list_todo = list_files[1:min_nb_files,]
    }else{
      list_todo = copy(list_files)
    }
    
  }
  # My.Kable(list_todo)
  if (To_Continue & nrow(list_todo) > 0)
  {
    selection_All = CHECK_CLASS(try(CCPR_READRDS(IndFolder,IndFile, ToKable = T, ToRestore = T)))
    # My.Kable(selection_All)
    if ( nrow(selection_All) > 0)
    {
      selection_All = selection_All[,..selection_fields]
      # My.Kable(selection_All)
      # My.Kable.All(unique(selection_All[order(code,-date)],by="code")[,-c("short_name")])
    }
    dt_list = list()
    for (ifile in 1:nrow(list_todo) ) 
    {
      # ifile=1
      x = CHECK_CLASS(try(CCPR_READRDS(list_todo[ifile]$folder, list_todo[ifile]$filename)))
      if (nrow(x)>0)
      {
        x = merge(x[,-c("new_name","new_short_name")], ins_ref[,.(code,new_name=name,new_short_name=short_name)],
                  by="code",all.x=T)
        # My.Kable(x)
        if (Index_File == 'download_ifrc_INDCURCRY_history.rds')
        {
          x[, cur := 'USD']
          x[, prtr := 'PR']
          x[, wgtg := substr(code, nchar(code) - 1, nchar(code))]
          x[, coverage := 'INTERNATIONAL']
          x[grepl('TOP', name), category := 'TRADABLE']
          x[!grepl('TOP', name), category := 'BENCHMARK']
          
          
        }
        if (!"name" %in% names(x)) { x[, name:=new_name] }
        if (!"short_name" %in% names(x)) { x[, short_name:=new_short_name] }
        x[is.na(name) & !is.na(new_name), name:=new_name]
        x[is.na(short_name) & !is.na(new_short_name), short_name:=new_short_name]
        x[is.na(short_name) & !is.na(name), short_name:=name]
        x[!is.na(short_name) & is.na(name), name:=short_name]
        # My.Kable(x)
        if (ToFilter)
        {
          if (grepl(",",list_todo[ifile]$filter))
          {
            x = x[code %in% unlist(str_split(list_todo[ifile]$filter, ","))]
          }else{
            if(!is.na(list_todo[ifile]$filter))
            {
              x = x[grepl(list_todo[ifile]$filter,code)]
            }
            
            # My.Kable(x)
          }
        }
        x_selection = intersect(names(x),selection_fields)
        # My.Kable(x)
        x = x[,..x_selection]
        x = x[close!=0 & !is.na(close) & !is.na(date)]
        dt_list[[ifile]] = x[!is.na(name)]
        # My.Kable.Min(x)
        rm(x)
      }
    }
    GC_SILENT()
    
    # HISTORY FILTERS
    dtlist = rbindlist(dt_list, fill=T)
    if (nrow(dtlist) > 0 & all(c("code", "date") %in% names(dtlist)) )
    {
      dtlist = unique(dtlist[order(code,date)],by=c("code","date"))
    }
    rm(dt_list)
    GC_SILENT()
    length(intersect(names(dtlist),selection_fields))==length(selection_fields)
    if (nrow(selection_All) > 0)
    {
      selection = selection_All[,date:=as.Date(date)][!code %in% dtlist$code]
    }
    rm(selection_All)
    selection = rbind(selection, dtlist, fill=T)
    #selection = rbind(selection[,date:=as.Date(date)][!code %in% dtlist$code], dtlist, fill=T)
    selection = merge(selection, ins_ref[type=="IND",.(code,new_ios2=iso2,new_country=country,new_continent=continent,new_type=type)],by="code",all.x=T)
    selection[is.na(iso2) & !is.na(new_ios2), iso2:=new_ios2]
    selection[is.na(country) & !is.na(new_country), country:=new_country]
    selection[is.na(continent) & !is.na(new_continent), continent:=new_continent]
    selection[is.na(type) & !is.na(new_type), type:=new_type]
    selection = selection[,-c("new_ios2","new_country","new_continent","new_type")]
    selection[,":="(rt=close/shift(close) -1, change=close-shift(close), close_adj=close),by="code"]
    selection[,varpc:=100*rt]
    
    codemother = CHECK_CLASS(try(CCPR_READRDS("S:/CCPR/DATA/DASHBOARD_LIVE/","dbl_ind_mother.rds", ToKable = T, ToRestore = T)))
    # My.Kable(codemother)
    # if (nrow(codemother) > 0 & )
    # selection = merge(selection, ins_ref[,.(code, new_coverage = coverage, new_category = category)],
    #                   by="code",all.x=T)
    # selection = merge(selection, codemother[,.(code,new_name=name,new_shortname=short_name,new_codemother=index_compo)],
    #                   by="code",all.x=T)
    # # selection[is.na(name)]
    # selection[is.na(name) & !is.na(new_name), name := new_name]
    # selection[is.na(short_name) & !is.na(new_shortname), short_name:=new_shortname]
    # selection[is.na(code_mother) & !is.na(new_codemother), code_mother:=new_codemother]
    # selection[is.na(coverage) & !is.na(new_coverage), coverage:=new_coverage]
    # 
    # selection[is.na(category) & !is.na(new_category), category:=new_category]
    # 
    # # selection[is.na(name)]
    # selection = selection[,-c("new_name","new_shortname","new_codemother", "new_category", "new_coverage")]
    # 
    # selection[,name:=gsub("^IFRC/BEQ HOLDINGS IFRC/BEQ HOLDINGS ","IFRC/BEQ HOLDINGS ",name)]
    # selection[,short_name:=gsub("^IFRC/BEQ HOLDINGS IFRC/BEQ HOLDINGS ","IFRC/BEQ HOLDINGS ",name)]
    # selection[,short_name:=gsub("^IFRC ","",short_name)]
    # selection[,short_name:=gsub("^IFRC/BEQ HOLDINGS ","",short_name)]
    
    selection = UPDATE_UPDATED(selection)
    # setkeyv(selection, c("code", "date"))
    selection = selection[code != 'XXZY']
    # My.Kable(selection)
    # My.Kable(selection[grepl('CRYPTO', name)])
    # # str(selection)
    # My.Kable(unique(selection[order(code,-date)],by="code"))
    
    summary = selection[,.(n=.N,start=date[1],end=date[.N]),by="code"]
    summary = summary[end>=SYSDATETIME(1)-20]
    
    selection = selection[code %in% summary$code]
    
    # selection[grepl("ETF INDEX", name), ':=' (coverage = "INTERNATIONAL", category = 'TRADABLE', prtr = 'PR',wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
    # 
    # # My.Kable.Min(selection[order(date, code)])
    # # My.Kable(unique(selection[order(code, -date)][grepl("ETF INDEX", name)], by = 'code')[,. (code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    # 
    # selection[grepl("WOMEN", name), ':=' (prtr = substr(code, nchar(code)-4, nchar(code) - 3),wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
    # selection[grepl("WOMEN", name) & grepl('VIETNAM', name) & !grepl('TOP', name), ':=' (coverage = "VIETNAM", category = 'BENCHMARK')]
    # selection[grepl("WOMEN", name) & grepl('VIETNAM', name) & grepl('TOP', name), ':=' (coverage = "VIETNAM", category = 'TRADABLE')]
    # 
    # selection[grepl("WOMEN", name) & !grepl('VIETNAM', name) & !grepl('TOP', name), ':=' (coverage = "INTERNATIONAL", category = 'BENCHMARK')]
    # selection[grepl("WOMEN", name) & !grepl('VIETNAM', name) & grepl('TOP', name), ':=' (coverage = "INTERNATIONAL", category = 'TRADABLE')]
    # 
    # selection[substr(name, nchar(name), nchar(name)) == ')' & substr(code, nchar(code) - 2, nchar(code)) == 'LOC', cur := substr(word(name, 2, 2, '[(]'),1,3)]
    # selection[, type := substr(code, 1, 3)]
    # 
    # selection[grepl("VNX ", name) & !grepl('TOP', name) & is.na(coverage) & is.na(category), ':=' (coverage = "VIETNAM", category = 'BENCHMARK')]
    # selection[grepl("VNX ", name) & grepl('TOP', name)  & is.na(coverage) & is.na(category), ':=' (coverage = "VIETNAM", category = 'TRADABLE')]
    # selection[grepl("VNX GROUP", name), ':=' (prtr = substr(code, nchar(code)-4, nchar(code) - 3),wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
    
    
    # My.Kable.All(unique(selection[grepl('IFRC', name)], by = 'code')[,.(n=.N,start=date[1],end=date[.N]),by= c("coverage", "category")])
    # 
    # My.Kable(unique(selection[order(code, -date)][grepl("WOMEN", name)], by = 'code')[,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    # 
    # My.Kable(unique(selection[order(code, -date)][grepl('IFRC', name) & (is.na(coverage) | is.na(category))], by = 'code')[,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    # 
    # My.Kable(selection[order(date, date)][grepl('IFRC', name)][,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
    
    
    selection = DBL_IND_TO_CLEAN(IND_DATA = selection, FOLDER_DATA = UData, FILE_DATA = '', ToSave = F, ToCleanFields = F, ToExclude = T)[order(code,date)]
    
    selection[, new_name := name]
    selection = merge(selection[,-c("name","short_name","code_mother","coverage","category","prtr","wgtg" ,"cur")],
                      codemother[,.(code,name,short_name,code_mother = index_compo,coverage,category,prtr = version,wgtg ,cur)], 
                      by="code", all.x=T)
    # selection[is.na(name)]
    selection[is.na(name), name := new_name]
    selection[is.na(short_name), short_name := new_name]
    selection$new_name = NULL
    try(CCPR_SAVERDS(selection, SaveFolder, SaveFile, ToSummary = T, SaveOneDrive = T))
    
    GC_SILENT()
    
    if (nchar(UploadTable)>0)
    {
      try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= UploadTable,
                                       l.filepath= tolower(paste0(SaveFolder,SaveFile)),
                                       CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    }
    
    return(selection)
  }
  rm(selection)
}


# ==================================================================================================
DBL_IND_TO_CLEAN = function(IND_DATA = data.table(), FOLDER_DATA = UData,
                            FILE_DATA = 'download_yah_indhome_history.rds', 
                            ToSave = F, 
                            ToCleanFields = F,
                            ToExclude = F)
{
  
  if(nrow(IND_DATA) == 0)
  {
    IND_DATA = CHECK_CLASS(try(CCPR_READRDS(FOLDER_DATA, FILE_DATA, ToKable = T, ToRestore = T)))
    
  }
  if (nrow(IND_DATA) > 0)
  {
    dbl_n0 = nrow(IND_DATA)
    if(ToCleanFields)
    {
      IND_FIELDS = intersect(names(IND_DATA), IND_FIELDS_STD)
      IND_DATA = IND_DATA[,..IND_FIELDS]
      
    }
    if(ToExclude){
      IND_DATA = DBL_IND_EXCLUDE(IND_DATA)
    }
    IND_DATA = DBL_IND_TO_CORRECT(IND_DATA)
    #IND_DATA [code == 'INDMICEX10' & date > as.Date('2003-04-29') - 40 & date < as.Date('2003-04-29') + 40]
    
    if(ToSave & nchar(FOLDER_DATA) > 0  & nchar(FILE_DATA) > 0) 
    {
      dir.create(FOLDER_DATA)
      try(CCPR_SAVERDS(IND_DATA,FOLDER_DATA, FILE_DATA, SaveOneDrive = T, ToSummary = T))
    }
  }
  dbl_n1 = nrow(IND_DATA)
  CATln(paste("removed records = ", dbl_n0 - dbl_n1))
  return (IND_DATA)
}


# ==================================================================================================
DBL_IND_TO_CORRECT = function (IND_DATA){
  
  #IND_DATA = DATA
  dbl_n0 = nrow(IND_DATA)
  dbl_correct = CHECK_CLASS(try(setDT(fread('S:/CCPR/DATA/DASHBOARD_LIVE/dbl_list_ind_to_correct.txt'))))
  if (nrow(dbl_correct) > 0 && nrow(dbl_correct[active == 1]) > 0 ) 
  {
    IND_DATA = merge(IND_DATA[, -c('new')], dbl_correct[,.(code, date, new = close)], by = c('code', 'date'), all.x = T)
    My.Kable(IND_DATA[!is.na(new)])
    IND_DATA [!is.na(new), close := new]
    IND_DATA$new = NULL
    IND_DATA = DBL_IND_CALCULATE_RT_VAR_CHANGE (IND_DATA, Remove_zero = T)
  }
  dbl_n1 = nrow(IND_DATA)
  CATln(paste(dbl_n0 - dbl_n1))
  return (IND_DATA)
}


# ==================================================================================================
DBL_IND_CALCULATE_RT_VAR_CHANGE = function (IND_DATA, Remove_zero = T){
  
  if (all(c('code', 'close') %in% names(IND_DATA) & !is.na(IND_DATA$code)))
  {
    if (Remove_zero)
    {
      IND_DATA = unique(IND_DATA, by = c('code', 'date'))[!is.na(code) & !is.na(date) & !is.na(close) & close != 0]
    }
    IND_DATA = IND_DATA[order(code, date)]
    IND_DATA[, rt:= close/shift(close) - 1, by = 'code']
    IND_DATA[, close_adj:= close, by = 'code']
    IND_DATA[, change:= close - shift(close), by = 'code']
    IND_DATA[, varpc:= 100 * rt, by = 'code']
    IND_DATA[, var := rt, by = 'code']
  } else{
    if (all(c('codesource', 'close') %in% names(IND_DATA) & !is.na(IND_DATA$codesource)))
    {
      if (Remove_zero)
      {
        IND_DATA = unique(IND_DATA, by = c('codesource', 'date'))[!is.na(codesource) & !is.na(date) & !is.na(close) & close != 0]
      }
      IND_DATA = IND_DATA[order(codesource, date)]
      IND_DATA[, close_adj:= close, by = 'codesource']
      IND_DATA[, rt:=  as.numeric(close / shift(close)) - 1, by = 'codesource']
      IND_DATA[, change:= close - shift(close), by = 'codesource']
      IND_DATA[, varpc:= 100 * rt, by = 'codesource']
      IND_DATA[, var := rt, by = 'codesource']
    }
  }
  return(IND_DATA)
}

# ==================================================================================================
DBL_IND_EXCLUDE = function (IND_DATA){
  
  dbl_n0 = nrow(IND_DATA)
  dbl_exclude = CHECK_CLASS(try(setDT(fread('S:/CCPR/DATA/DASHBOARD_LIVE/dbl_list_ind_to_exclude.txt'))))
  if (nrow(dbl_exclude) > 0 && nrow(dbl_exclude[active == 1]) > 0 ) 
  {
    IND_DATA = IND_DATA[!code %in% dbl_exclude[active == 1]$code]
    
  }
  dbl_n1 = nrow(IND_DATA)
  CATln(paste(dbl_n0 - dbl_n1))
  return (IND_DATA)
}



# ==================================================================================================
REVIEW_TRADABLE_INDEX_OLD = function( NB_TOP    = 10, File_folder = 'R:/CCPR/DATA/DAY/YYMMDD/', File_name = 'ifrc_ccpr_all_stkvn_wceo_day_20240329.rds',
                                      WgtLimit  = 20, pSector = 'PET' , 
                                      StartDate = '2023-07-01', EndDate = '2024-06-28', idx_code = 'INDVNXWM10PRVND', idx_name = 'IFRC VNX TOP 10 WOMEN CEO')
{
  # File_name = 'ifrc_ccpr_all_stkvn_wceo_day_20231229.rds'; StartDate = '2022-01-01'; EndDate = '2023-12-31'
  IND = CCPR_READRDS(File_folder, File_name, ToKable = T) 
  # LIST_STKVN = readRDS("S:/STKVN/PRICES/FINAL/FINAL_STKVN_4INDEX_HISTORY.rds")
  # IND[sector == pSector]
  for (SEC in LIST_SEC)
  {
    COMPO  = setDT( read_xlsx ( paste0('S:/STKVN/INDEX_2024/COMPO_VNXSEC',SEC, '.xlsx'))  )
    
    MY_LOG     = IND [date == max(date)] [code %in% COMPO$code]
    # MY_LOG     = merge (MY_LOG, COMPO [,.(code, name)], all.x = T, by = 'code')
    MY_LOG [ , sector := toupper (SEC)]
    MY_pLOG [[SEC]]  = merge (MY_LOG, COMPO [,.(code, name)], all.x = T, by = 'code')
  }
  
  MY_DATA = rbindlist (MY_pLOG, fill = T) 
  MY_DATA[, .(code, date, market, sharesout, freefloat, close)]
  My.Kable(IND)
  # str(IND)
  idx_date = max(IND[, date:=as.Date(date)]$date)
  My.Kable.All(IND[is.na(sharesout) | is.na(close)][, .(code, date, market, sharesout, freefloat, close)])
  My.Kable(IND[, .(code, date, market, sharesout, freefloat, close)])
  IND[, capivnd:=sharesout*close]
  LIQUIDITY = CCPR_READRDS(UData, 'download_caf_stkvn_history.rds', ToKable = T, ToRestore = T)
  LIQUIDITY = MERGE_DATASTD_BYCODE(LIQUIDITY, pOption='FINAL')
  My.Kable.Min(LIQUIDITY[order(date, code)])
  
  LIQUIDITY_REVIEW = LIQUIDITY[date<=EndDate & date>=StartDate]
  LIQUIDITY_REVIEW[, est_turnover:=volume*close]
  My.Kable(LIQUIDITY_REVIEW[order(date, code)][, .(name, code, date, close, volume, turnover)])
  
  LIQUIDITY_REVIEW_STATS = LIQUIDITY_REVIEW[, .(name=name[1], n=.N, nb_trades=sum(ifelse(volume==0,0,1)), avg_turnover=mean(turnover, na.rm=T)), by='code']
  MaxDays = max(LIQUIDITY_REVIEW_STATS$n)
  LIQUIDITY_REVIEW_STATS[, trading_ratio:=100* nb_trades/MaxDays]
  LIQUIDITY_REVIEW_STATS[trading_ratio>=95, included:=1]
  LIQUIDITY_REVIEW_STATS_ELIGIBLE = LIQUIDITY_REVIEW_STATS[included==1][order(-avg_turnover)][, ranking:=seq.int(1, .N)][order(ranking)]
  
  My.Kable(LIQUIDITY_REVIEW_STATS[order(trading_ratio)], Nb=10)
  
  My.Kable(LIQUIDITY_REVIEW_STATS_ELIGIBLE[order(ranking)], Nb=10)
  
  IND_REVIEW = IND[, .(code, name, market, sharesout, freefloat, close, capivnd)]
  IND_REVIEW[freefloat<0, freefloat:=1]
  IND_REVIEW[,capiff:=capivnd*freefloat]
  IND_REVIEW = IND_REVIEW[order(-capiff)][, rnk_capiff:=seq.int(1, .N)]
  IND_REVIEW = merge(IND_REVIEW, LIQUIDITY_REVIEW_STATS_ELIGIBLE[, .(code, avg_turnover)], all.x=T, by='code')
  IND_REVIEW = IND_REVIEW[order(-avg_turnover)][!is.na(avg_turnover) & avg_turnover >0][, rnk_turnover:=seq.int(1, .N)]
  IND_REVIEW[, ranking:=(51*rnk_capiff + 49*rnk_turnover)/100]
  IND_REVIEW = IND_REVIEW[order(ranking)][, rnk_nr:=seq.int(1, .N)]
  My.Kable.All(IND_REVIEW)
  
  # Capping ...
  IND_REVIEW_TOP = IND_REVIEW[rnk_nr<=NB_TOP][, -c('avg_turnover')][order(-capiff)]
  IND_REVIEW_TOP[, wgt:=100*capiff/sum(capiff)]
  My.Kable.All(IND_REVIEW_TOP[, -c('freefloat')])
  
  IdxCapi  = sum(IND_REVIEW_TOP$capiff)
  IND_REVIEW_TOP[, wgtk:=wgt]
  IND_REVIEW_TOP[, capi_effective:=capiff]
  IND_REVIEW_TOP[, CAPI_IDX:=sum(capi_effective)]
  IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]
  My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close')])
  
  NK = 0
  
  IND_REVIEW_TOP[, K:=NK]
  
  # Loop
  while (nrow(IND_REVIEW_TOP[WGT_IDX>WgtLimit])>0)
  {
    NK = 1+NK
    
    # IND_REVIEW_TOP10[, capi_effective:=capiff]
    # IND_REVIEW_TOP10[, wgti_eff:=100*capi_effective/sum(capi_effective)]
    My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
    
    IdxCapiInit    = sum(IND_REVIEW_TOP$capi_effective)
    IND_REVIEW_TOP$capped=0
    IND_REVIEW_TOP[, factor:=1]
    IND_REVIEW_TOP[WGT_IDX>=WgtLimit, capped:=1]
    IND_REVIEW_TOP[WGT_IDX>=WgtLimit, wgtk:=WgtLimit]
    
    IdxWgtCapped   = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$wgtk)
    IdxCapiCapped  = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$capi_effective)
    IdxCapiRemain  = sum(IND_REVIEW_TOP[WGT_IDX<WgtLimit]$capi_effective)
    IdxCapiTotal   = 100*IdxCapiRemain/(100-IdxWgtCapped)
    IdxCapiRemain/IdxCapiTotal
    
    CATln(paste(Format.Number(IdxCapiInit,0), ' / ', Format.Number(IdxCapiCapped,0), ' / ', Format.Number(IdxCapiCapped/IdxCapiTotal,2)))
    IdxCapiTotal/IND_REVIEW_TOP[1]$CAPI_IDX
    IdxCapiRemain/IdxCapiTotal
    
    # IND_REVIEW_TOP[capped>0, factor:=wgtk/wgt]
    
    IND_REVIEW_TOP[, wgti:=100*capi_effective/IdxCapiTotal]
    IND_REVIEW_TOP[capped==1, wgti:=WgtLimit]
    sum(IND_REVIEW_TOP$wgti)
    My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'code', 'close', 'sharesout')])
    
    # IND_REVIEW_TOP[, capi_effective:=capiff*factor]
    IND_REVIEW_TOP[capped==1, capi_effective:=wgti*IdxCapiTotal/100]
    IND_REVIEW_TOP[, CAPI_IDX:=IdxCapiTotal]
    # IND_REVIEW_TOP[capped!=,  capi_effective:=wgti*wgti/100]
    
    IND_REVIEW_TOP[, wgti_eff:=100*capi_effective/sum(capi_effective)]
    CATln(Format.Number(sum(IND_REVIEW_TOP$wgti),2))
    CATln(Format.Number(sum(IND_REVIEW_TOP$wgti_eff),2))
    # 
    # 
    # IND_REVIEW_TOP[, capi_effective:=(wgti/100)*CAPI_IDX]
    IND_REVIEW_TOP[, K:=NK]
    
    # IND_REVIEW_TOP[, WGT_IDX:=100*capi_effective/CAPI_IDX]
    IND_REVIEW_TOP[, WGT_IDX:=wgti]
    My.Kable.All(IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'sharesout')])
    
    CATln(Format.Number(sum(IND_REVIEW_TOP$WGT_IDX),2))
    
    # 
    # IdxCapiInit    = sum(IND_REVIEW_TOP$capiff)
    # IND_REVIEW_TOP$capped=0
    # IND_REVIEW_TOP[, factor:=1]
    # IND_REVIEW_TOP[wgtk>WgtLimit, capped:=1]
    # IND_REVIEW_TOP[wgtk>WgtLimit, wgtk:=WgtLimit]
    # 
    # IdxWgtCapped   = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$wgtk)
    # IdxCapiCapped  = sum(IND_REVIEW_TOP[wgtk==WgtLimit]$capiff)
    # IdxCapiRemain  = sum(IND_REVIEW_TOP[wgtk<WgtLimit]$capiff)
    # IdxCapiTotal   = 100*IdxCapiRemain/(100-IdxWgtCapped)
    # CATln(paste(Format.Number(IdxCapiInit,0), ' / ', Format.Number(IdxCapiCapped,0), ' / ', Format.Number(IdxCapiCapped/IdxCapiTotal,2)))
    # IND_REVIEW_TOP[capped>0, factor:=wgtk/wgt]
    # 
    # IND_REVIEW_TOP[, wgti:=100*capiff/IdxCapiTotal]
    # IND_REVIEW_TOP[, wgti:=100*capiff/IdxCapiTotal]
    # IND_REVIEW_TOP[capped==1, wgti:=WgtLimit]
    # IND_REVIEW_TOP[, capi_effective:=capiff*factor]
    # IND_REVIEW_TOP[, wgti_eff:=100*capi_effective/sum(capi_effective)]
    # CATln(Format.Number(sum(IND_REVIEW_TOP$wgti),2))
    # CATln(Format.Number(sum(IND_REVIEW_TOP$wgti_eff),2))
    
    My.Kable.All(IND_REVIEW_TOP[, -c('freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'code', 'K', 'factor')])
  }
  
  FINAL_IND_REVIEW_TOP = IND_REVIEW_TOP[, .(K, CODE=code, TICKER=gsub('STKVN', '', code), NAME=name, MARKET=market, CLOSE=close, FREEFLOAT=freefloat,
                                            SHARES=sharesout,
                                            CAPIFF=capiff, CAPI=capivnd, CAPI_IDX, WGT_IDX, CAPI_STK=(WGT_IDX/100)*CAPI_IDX)]
  FINAL_IND_REVIEW_TOP[, CAPPING:=CAPI_STK/CAPIFF]
  FINAL_IND_REVIEW_TOP[, idx_code:=idx_code]
  FINAL_IND_REVIEW_TOP[, idx_name:=idx_name]
  FINAL_IND_REVIEW_TOP[, date:=idx_date]
  My.Kable.All(FINAL_IND_REVIEW_TOP[, -c('code', 'freefloat', 'capivnd', 'rnk_capiff', 'rnk_turnover', 'ranking', 'close', 'code', 'capped', 'idx_name','K', 'factor', 'CAPI_STK', 'CAPI_IDX')])
  return(FINAL_IND_REVIEW_TOP)
}



# ==================================================================================================
INDEXES_DATA_CLEAN_OPTIMISE = function(Option = 'FILL_ALL_DAYS', Folder = UData, FileName, Source='')  {
  # ------------------------------------------------------------------------------------------------
  switch(Option,
         'DOWNLOAD_YAH_CUR_HISTORY' = {
           x = CCPR_READRDS(UData, 'download_YAH_CUR_prices_today.rds', ToKable = T, ToRestore = T)
           Data_USD = x[grepl('^CURUSD', code) & nchar(code)==9][order(code, date)][!is.na(code) & !is.na(date) & !is.na(close)][, .(source, codesource, code, date, close)]
           My.Kable(Data_USD)
           
           Stats = Data_USD[, .(source=source[1], codesource=codesource[1], start=date[1], end = date[.N], close = close[.N]), by='code']
           Stats[, curto:=substr(code, 7, 9)]
           
           My.Kable.All(Stats)
           
           Data_USD = merge(Data_USD[, -c('start', 'end')], Stats[, .(code, start, end)], all.x = T, by='code')
           My.Kable.All(Data_USD)
           
           Data_list = list()
           
           for (k in 1:nrow(Stats))
           {
             # k = 1
             pCode = Stats[k]$code
             CATln('')
             CATln_Border(pCode)
             Data_1 = Data_USD[code == pCode ]
             pMin = Stats[k]$start
             pMax = Stats[k]$end
             date_sequence = seq(from = pMin, to = pMax, by = 1)
             Data_Full = as.data.table(date_sequence)
             names(Data_Full)= 'date'
             Data_Full[, ':='(code=pCode)]
             Data_Full = merge(Data_Full[, -c('source', 'codesource', 'close')], Data_1[,.(source, codesource, date, close)], all.x=T, by='date')
             Data_Full[, close:=na.locf(close)]
             My.Kable.TB(Data_Full)
             Data_Inverse = Data_Full[, .(source, code=paste0('CUR', substr(code, 7,9), substr(code, 4 , 6 )), date, close=1/close)]
             My.Kable.TB(Data_Inverse)
             Data_All = rbind(Data_Full, Data_Inverse, fill=T)
             Data_All = MERGE_DATASTD_BYCODE(Data_All, pOption='FINAL')
             rm(Data_Full, Data_Inverse)
             My.Kable(Data_All)
             Data_list[[k]] = Data_All
           }
           Data_All = rbindlist(Data_list, fill=T)
           My.Kable(Data_All)
           
           Data_Old = CCPR_READRDS(UData, 'download_YAH_CUR_history.rds', ToKable = T, ToRestore = T)
           Data_Old[, key:=paste(code, date)]
           Data_All[, key:=paste(code, date)]
           Data_Final = unique(rbind(Data_Old, Data_All, fill=T), by=c('key'), FromLast = T)[,.(source, codesource, code, date, close)]
           Data_Final = MERGE_DATASTD_BYCODE(Data_Final, pOption='FINAL')
           My.Kable(Data_Final)
           CCPR_SAVERDS(Data_Final, UData, 'download_YAH_CUR_history.rds', ToKable = T, SaveOneDrive = T)
           rm(Data_All, Data_Old)
           
           Data_Old = CCPR_READRDS(UData, 'IFRC_CUR_4INDEX.rds', ToKable = T, ToRestore = T)
           Data_Old[, key:=paste(code, date)]
           Data_Final[, key:=paste(code, date)]
           Data_Final = unique(rbind(Data_Old, Data_Final, fill=T), by=c('key'), FromLast = T)[,.(source, codesource, code, date, close)]
           Data_Final = MERGE_DATASTD_BYCODE(Data_Final, pOption='FINAL')
           My.Kable(Data_Final[order(date, code)])
           
           CCPR_SAVERDS(Data_Final, UData, 'IFRC_CUR_4INDEX.rds', ToKable = T, SaveOneDrive = T)
           rm(Data_All, Data_Old)
         },
         
         'FILL_ALL_DAYS' = {
           # FILL ALL DAYS ....................................................................................
           x = CCPR_READRDS(Folder, FileName, ToKable = T, ToRestore = T)
           Data_USD = x[nchar(code)==9][order(code, date)][!is.na(code) & !is.na(date) & !is.na(close)][, .(source, codesource, code, date, close)]
           My.Kable(Data_USD)
           
           Stats = Data_USD[, .(source=source[1], codesource=codesource[1], start=date[1], end = date[.N], close = close[.N]), by='code']
           # Stats[, curto:=substr(code, 7, 9)]
           
           My.Kable.TB(Stats)
           
           Data_USD = merge(Data_USD[, -c('start', 'end')], Stats[, .(code, start, end)], all.x = T, by='code')
           My.Kable.TB(Data_USD)
           My.Kable.TB(Data_USD[code == 'CURUSDVND'])
           
           
           Data_list = list()
           # Stats = Stats[codesource == 'VND=X']
           for (k in 1:nrow(Stats))
           {
             # k = 1
             pCode = Stats[k]$code
             # pCode = 'CURUSDVND'
             CATln('')
             CATln_Border(pCode)
             Data_1 = Data_USD[code == pCode ]
             pMin = Stats[k]$start
             pMax = Stats[k]$end
             date_sequence = seq(from = pMin, to = pMax, by = 1)
             Data_Full = as.data.table(date_sequence)
             names(Data_Full)= 'date'
             Data_Full[, ':='(code=pCode)]
             Data_Full = merge(Data_Full[, -c('source', 'codesource', 'close')], Data_1[,.(source, codesource, date, close)], all.x=T, by='date')
             Data_Full[, close:=na.locf(close)]
             My.Kable.TB(Data_Full)
             
             # Data_Inverse = Data_Full[, .(source, code=paste0('CUR', substr(code, 7,9), substr(code, 4 , 6 )), date, close=1/close)]
             # My.Kable.TB(Data_Inverse)
             # Data_All = rbind(Data_Full, Data_Inverse, fill=T)
             # Data_All = MERGE_DATASTD_BYCODE(Data_All, pOption='FINAL')
             # rm(Data_Full, Data_Inverse)
             # My.Kable(Data_All)
             Data_list[[k]] = Data_Full
           }
           Data_All = rbindlist(Data_list, fill=T)
           My.Kable.All(Data_All[code == 'CURUSDVND' & date > as.Date('2014-07-31') - 10 & date < as.Date('2014-07-31') + 10])
           
           Data_Old = copy(x)
           Data_Old[, key:=paste(code, date)]
           Data_All[, key:=paste(code, date)]
           if (nchar(Source)>0)
           {
             Data_All[, source:=Source]
           }
           Data_Final = unique(rbind(Data_Old, Data_All[!date %in% Data_Old$date], fill=T), by=c('code','date'))[,.(source, codesource, code, date, close)]
           Data_Final = MERGE_DATASTD_BYCODE(Data_Final, pOption='FINAL')
           My.Kable(Data_Final[order(date, code)])
           # My.Kable.All(Data_Final[order(date, code)][code == 'CURUSDVND' & date > as.Date('2014-07-31') - 10 & date < as.Date('2014-07-31') + 10])
           # 
           Data_Final[, close_adj := close]
           CCPR_SAVERDS(Data_Final, Folder, FileName, ToKable = T, SaveOneDrive = T)
           rm(Data_All, Data_Old, x)
         }
  )
}



# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_INDVN_PRICES_BY_CODE = function(pCodesource = 'vnindex', CodeInt = 'INDVNINDEX')  {
  # ------------------------------------------------------------------------------------------------
  # pCode = 'XYZ'
  # pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=30/12/2022&EndDate=30/12/2023&PageIndex=3&PageSize=20')
  # NbPagesBack = 20
  pCode     = pCodesource
  Data_List = list()
  ToContinu = T
  k = 1
  while (ToContinu)
  {
    pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=&EndDate=&PageIndex=', k, '&PageSize=100')
    CATrp(pURLk)
    x = try(jsonlite::fromJSON(pURLk))
    if (length(x$Data$Data)>0)
    {
      XData = try(as.data.table(x$Data$Data))
      if (all(class(XData)!='try-error'))
      {
        XData = CLEAN_COLNAMES(XData)
        Final_Data = XData[, .(source='CAF', codesource=pCode, ticker=pCode,
                               date      = as.Date(ngay, '%d/%m/%Y'), 
                               open      = as.numeric(giamocua),
                               high      = as.numeric(giacaonhat),
                               low       = as.numeric(giathapnhat),
                               close_adj = as.numeric(giadieuchinh),
                               close=as.numeric(giadongcua),
                               change=as.numeric(word(thaydoi,1,1,'\\(')),
                               varpc=as.numeric(word(word(thaydoi,2,2,'\\('),1,1,' ')),
                               volume=as.numeric(gsub(',','', khoiluongkhoplenh)),
                               turnover=as.numeric(gsub(',','', giatrikhoplenh))
                               
        )]
        My.Kable.TB(Final_Data)
        Data_List[[k]] = Final_Data
      } else {
        ToContinu = F
      }
    } else {
      ToContinu = F
    }
    k = k+1
  }
  CATln(pURLk); CATln('')
  Data_All = rbindlist(Data_List, fill=T)
  if (nrow(Data_All)>0)
  {
    Data_All = Data_All[order(date)]
    Data_All[, reference:=close-change]
    Data_All[, rt:=change/reference]
    Data_All[, codesource:=toupper(codesource)]
    Data_All[, code:=toupper(CodeInt)]
    My.Kable.TB(Data_All)
  } else {
    Data_All = data.table()
  }
  return(Data_All)
}

# ==================================================================================================
UPDATE_CAF_IND_VNI = function(ToCheckDate = T)
{
  CATln_Border('UPDATE_CAF_IND_VNI')
  LastTrading = CCPR_LAST_TRADING_DAY_VN(max(17, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  CAF_IND_VNI_SUMMARY = setDT(fread(paste0(UData, 'DOWNLOAD_CAF_INDVN_PRICES_HISTORY_SUMMARY.txt')))
  My.Kable(CAF_IND_VNI_SUMMARY[code=='INDVNINDEX'])
  
  if (!ToCheckDate |
      (CAF_IND_VNI_SUMMARY[code=='INDVNINDEX']$datelast > SUMMARY_DATE(paste0(UData, 'DOWNLOAD_CAF_VNI_HISTORY.rds'))) |
      CAF_IND_VNI_SUMMARY[code=='INDVNINDEX']$datelast < LastTrading
  )
  {
    x = TRAINEE_DOWNLOAD_CAF_INDVN_PRICES_BY_CODE(pCodesource = 'vnindex', CodeInt = 'INDVNINDEX') 
    My.Kable(x[code=='INDVNINDEX'])
    CCPR_SAVERDS(x, UData, 'DOWNLOAD_CAF_VNI_HISTORY.rds', ToSummary = T)
    
    DATA_OLD = CCPR_READRDS(UData, 'DOWNLOAD_CAF_INDVN_PRICES_HISTORY.rds', ToKable = T)
    My.Kable(DATA_OLD[code=='INDVNINDEX'])
    # DATA_OLD = unique(rbind(DATA_OLD, x, fill=T), by='codesource')
    DATA_OLD = unique(rbind(DATA_OLD, x, fill=T), by=c('code', 'date'), fromLast = T)
    My.Kable(DATA_OLD[code=='INDVNINDEX'][order(date)])
    
    CCPR_SAVERDS(DATA_OLD, UData, 'DOWNLOAD_CAF_INDVN_PRICES_HISTORY.rds', ToSummary = T, SaveOneDrive = T)
  }
}

# ==================================================================================================
TRAINEE_CUMULATED_ANNUALISED_RETURN = function ( pPeriod = 'YEAR', pCode = 'INDVNXSECLOGCWPRVND') {
  # ------------------------------------------------------------------------------------------------
  
  # nr = 1, 2, 
  # index, vni, excess
  switch (pPeriod, 
          'YEAR' = {
            time = 'yyyy'
          },
          'QUARTER'= {
            time = 'yyyyqn'
          },
          'MONTH' = {
            time = 'yyyymm'
          })
  pFolder = "S:/CCPR/DATA/DASHBOARD_LIVE/"
  pFile   = paste0 ('ccpi_dashboard_indbeq_',tolower (pPeriod),'_history.rds')
  
  DATA = CCPR_READRDS (pFolder, pFile, ToRestore =T, ToKable = T)
  MY_DATA = DATA [ code %in% c( 'INDVNINDEX',pCode)] [order ( -date)]
  MY_DATA [, ':=' (yrt = close_adj/shift(close_adj, type = 'lead')), by = 'code']
  MY_DATA [order (code)]
  MY_DATA [, ':=' (ac_yrt = (cumprod(yrt)-1)), by = 'code']
  MY_DATA [, ':=' (nr = seq(.N)), by = 'code']
  
  My.Kable.All(setDT(spread(MY_DATA [, .(code, nr, period , arty = ac_yrt)], key='code', value='arty')) [order (nr)]) 
  
  DATA_OUTPUT = setDT(spread(MY_DATA[, .(code, nr, period , arty = ac_yrt)], key='code', value='arty')) [order (nr)]
  # DATA_OUTPUT [, excess_rt := as.numeric(NA)]
  x = DATA_OUTPUT %>% select (nr, index = pCode,INDVNINDEX ) 
  x [is.na (index), excess_rt := 0 - INDVNINDEX]
  x [!is.na (index), excess_rt := index -INDVNINDEX ]
  
  DATA_OUTPUT = merge (DATA_OUTPUT, x [,.(nr, excess_rt)], all.x = T, by = 'nr')
  My.Kable.All(DATA_OUTPUT [order (nr)]) 
  return (DATA_OUTPUT)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_STKVN_BOARD_BY_SOURCE = function(pSource='CAF', pFolder =  paste0(SData, 'IFRC_CCPR/'), Nb_Min = 10,
                                                  Nb_Group = 10) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_MONITOR_EXECUTION_SUMMARY (pOption='CCPR_DOWNLOAD_SOURCE_STKVN_BOARD_BY_MARKET', pAction="SAVE", NbSeconds=3600, ToPrint=F)
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  List_Companies = readRDS ('S:/STKVN/PRICES/DAY/list_code_by_exc_day.rds')
  List_Companies [, codesource := substr(code, 6,8)]
  List_Companies = unique(List_Companies[order(codesource, -date)], by='codesource')[nchar(codesource)==3]
  List_Companies = merge(List_Companies[, -c('name')], ins_ref[type=='STK', .(code, name=short_name)], all.x=T, by='code')
  My.Kable.TB(List_Companies[, .(name, codesource)])
  CATln('Loaded REF... ')
  List_Codes     = unique(List_Companies[,.(codesource, name, market)], by ='codesource') 
  
  
  File_Folder = pFolder
  
  FileName = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_', gsub('-','',LastTrading))
  
  
  
  FilePath       = paste0(pFolder,   FileName, '.rds')
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  ExtraFolder = ''
  
  if (nrow(List_Codes)>0)
  {
    if (file.exists(FilePath))
    {
      # Data_old = CCPR_READRDS(pFolder, paste0(FileName, '.rds')) 
      Data_old = try ( readRDS(paste0(pFolder, FileName, '.rds'))  )
      if (nrow(Data_old)>0) {
        Data_old = Data_old[!is.na(codesource)]
        List_Codes_ToDo = List_Codes[!codesource %in% Data_old$codesource ]
        My.Kable.TB(Data_old)
      } else {
        List_Codes_ToDo = List_Codes
      }
    } else { 
      CATln(paste('FILE NO EXIST :', FilePath))
      Data_old = data.table() 
      List_Codes_ToDo = List_Codes
    }
    
    if (nrow(List_Codes_ToDo)>0)
    {
      List_Codes_ToDo = List_Codes_ToDo[order(codesource)]
      My.Kable(List_Codes_ToDo)
      Data_All = data.table()
      Data_List = list()
      
      FileData = List_Codes_ToDo
      FileRow  = nrow(List_Codes_ToDo)
      
      Nb_TODO  = min(Nb_Min, FileRow)
      Nb_Total = FileRow
      
      FileToSave = paste0(FileName, '.rds')
      Total_Time  = 0
      
      for (i in 1:Nb_TODO)
      {
        # i =1
        Start.Time = Sys.time()
        pCode    = FileData[i]$codesource
        CATln("")
        # CATln_Border(paste(i, '/', Nb_TODO, ' = ', pCode))
        CATln_Border(paste('DOWNLOAD_STKVN_BOARD_BY_SOURCE : ', pSource,  '=', i, paste0('(', Nb_Group,')'), '/', Nb_TODO, '/', Nb_Total, ' = ', pCode))
        Sys.sleep(1)
        My_Data = data.table()
        
        switch (pSource, 
                # pCode = 'AAM'                                                        
                'CAF' = {       My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_BOARD_BY_CODE(pCode=pCode)))
                },
                'VST' = {       My_Data = CHECK_CLASS(try(TRAINEE_GET_VST_BOARD_MEMBER_BY_CODE(pCode=pCode))) 
                },
                'VND' = {       My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VND_STKVN_BOARD_BY_CODE (pCode=pCode))) 
                }              
        )
        
        
        if (all(class(My_Data)!='try-error'))
        {
          Data_List[[i]] = My_Data
        }
        Sys.sleep(2)
        
        if (i %% Nb_Group ==0 | i == Nb_TODO)
        {
          # DATE
          Data_All = rbindlist(Data_List, fill=T)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := LastTrading]}
          if (! 'code' %in% names (Data_All)) { Data_All [, code := paste0('STKVN',codesource)]}
          Data_final = rbind(Data_old, Data_All, fill=T)
          
          # CCPR_SAVERDS(Data_final,pFolder, FileToSave, ToSummary = T, SaveOneDrive = T)
          saveRDS( Data_final ,  paste0(pFolder, FileToSave))
          CATln_Border(paste ('SAVED: ', paste0(pFolder, FileToSave)) )
          
          # DAY :
          FileAll = paste0(gsub(paste0('_',gsub('-','', LastTrading) ),'',FileName ),'_DAY', '.rds')
          
          if ( file.exists(paste0(pFolder, '', FileAll))) {
            # data_old1 = CCPR_READRDS(FileFolder = paste0(pFolder, ''), FileName = FileAll, ToKable = F, ToPrompt = F, ToRestore = T)
            data_old1 = try( readRDS(paste0(pFolder, FileAll )) )
          } else { data_old1 = data.table()}
          data_all_final = unique(rbind( Data_final,data_old1, fill = T), by = c('code', 'date'))
          # CCPR_SAVERDS(data_all_final,pFolder,FileAll , ToSummary = T, SaveOneDrive = T)
          saveRDS (data_all_final, paste0(pFolder,FileAll))
          CATln_Border(paste ('SAVED: ', paste0(pFolder, FileAll)) )
          # HISTORY:
          FileNameHistory = paste0(gsub('DAY','HISTORY' , FileAll) )
          if ( file.exists(paste0(pFolder,FileNameHistory))) {
            # data_old1 = CCPR_READRDS(FileFolder = pFolder, FileName = FileNameHistory, ToKable = F, ToPrompt = F, ToRestore = T)
            data_old1 = try( readRDS(paste0(pFolder, FileNameHistory )) )
          } else { data_old1 = data.table()}
          data_all_final_history = unique(rbind( Data_final,data_old1, fill = T), by = c('code', 'date'))
          
          # CCPR_SAVERDS(data_all_final_history,pFolder,FileNameHistory , ToSummary = T, SaveOneDrive = T)
          saveRDS (data_all_final, paste0(pFolder,FileNameHistory))
          CATln(paste('SAVED : ',pFolder, FileNameHistory, '-', Format.Number(nrow(Data_final),0),'records'))
          Sys.sleep(2)
        }
        
        End.Time = Sys.time()
        Total_Time = as.numeric(difftime(End.Time, Start.Time, units = 'secs')) + Total_Time
        Avg_Time = Total_Time / i
        End_Forecast = Avg_Time * (Nb_TODO - i)
        Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
        CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      }
      
      return(Data_final)
    } else {
      CATln_Border('DATA FULLY UPDATED')
      Sys.sleep(2)
    }
  }
  
  
}


# ==================================================================================================
TRAINEE_GET_VST_BOARD_MEMBER_BY_CODE = function(pCode = 'VND')  {
  # ------------------------------------------------------------------------------------------------
  Start.time = Sys.time()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  Data_Final = data.table()
  pURL  = paste0('https://finance.vietstock.vn/', pCode, '/board-of-management.htm?languageid=2')
  CATln_Border(pURL)
  content  = rvest::read_html(pURL)
  tables   = content %>% html_table(fill = TRUE)
  # length(tables)
  if (length(tables)>1)
  {
    Data_List = list()
    for (k in 2:length(tables))
    {
      Data_List[[k]] = as.data.table(tables[[k]])
    }
    Data_All = rbindlist(Data_List, fill=T)
    Data_All = CLEAN_COLNAMES(Data_All)
    # colnames(Data_All)[1]='date'
    Data_All[, date:=as.Date(LastTrading)]
    Data_All$gender = as.character(NA)
    Data_All[grepl('^Ông ', fullname), gender:='M']
    Data_All[grepl('^Bà ', fullname), gender:='F']
    Data_All[, fullname:=gsub('^Bà ','', fullname)] 
    Data_All[, fullname:=gsub('^Ông ','', fullname)] 
    # My.Kable(Data_All)
    # str(Data_All)
    Data_All[, positions:=trimws(positions)]
    Data_All[nchar(trimws(education))==0, education:=as.character(NA)]
    Data_All[grepl('N/a|NA', education), education:=as.character(NA)]
    Data_All[grepl('NA|-', yearofbirth), yearofbirth:=as.character(NA)]
    
    Data_All[grepl('N/A', time), time:=as.character(NA)]
    Data_All$independence=as.numeric(NA)
    Data_All[grepl('Independence', time), independence:=1]
    Data_All[grepl('Independence', time), time:=gsub('Independence', "", time)]
    Data_All[nchar(shares)>0, shares:=gsub(',','',shares)]
    Data_All[nchar(shares)==0, shares:=as.character(NA)]
    Data_All[, shares:=as.numeric(shares)]
    #My.Kable(Data_All)
    
    Data_Final = Data_All[, .(date, codesource=pCode, ticker=pCode, source='VST', gender, fullname_lc=fullname, positions, since=time, 
                              birthyear=as.numeric(as.character(yearofbirth)), education=as.character(education), independence)]
    Data_Final[, fullname:=trimws(decodeVN(fullname_lc, from='Unicode', to='Unicode', diacritics=F))] 
    Data_Final[, lastname:=toupper(stringr::word(fullname, 1))]
    Data_Final[, firstname:=substr(fullname, nchar(lastname)+1, nchar(fullname))]
    Data_Final[grepl('^CEO|^Chief Executive|^Director|Acting CEO', positions), ceo:=1]
    Data_Final[, updated:=substr(Sys.time(),1,19)]
    # Data_Final[, date := Sys.Date()]
    
    My.Kable.TB(Data_Final[, -c('fullname', 'independence')])
    End.time = Sys.time()
    CATln(paste('Duration = ', Format.Number(difftime(End.time, Start.time, units='sec'),2)))
  }
  
  return(Data_Final)
}

# ==================================================================================================
CHECK_BLG_CONNEXION = function()  {
  # ------------------------------------------------------------------------------------------------
  x = CHECK_CLASS(try(NEW_SMART_DOWNLOAD_BLG_INTRADAY_DAILY_BYLIST(pList=list("USDVND:CUR", "USDJPY:CUR", "USDEUR:CUR", "USDGBP:CUR", "USDAUD:CUR", "USDCAD:CUR", "EURUSD:CUR", "USDRUB:CUR"),
                                                                   pFrequency="1_DAY", Calculate_DayChangeVar=T)))
  return(nrow(x)>0)
}


# ==================================================================================================
NEW_SMART_DOWNLOAD_BLG_INTRADAY_DAILY_BYLIST = function(pList=list("USDVND:CUR", "USDJPY:CUR", "USDEUR:CUR", "USDGBP:CUR", "USDAUD:CUR", "USDCAD:CUR", "EURUSD:CUR", "USDRUB:CUR"),
                                                        pFrequency="1_DAY", Calculate_DayChangeVar=T)  {
  # ------------------------------------------------------------------------------------------------
  
  # pFrequency="1_YEAR"
  rm(xList, x, htmlALL, pURL, xcur1, x.Data1, x.Data2)
  gc(); IFRC_RELEASE_MEMORY("")
  Data_Res = data.table()
  # xList   = list("USDVND:CUR", "USDEUR:CUR", "USDJPY:CUR")
  xList   = pList
  xString = paste0(xList, collapse = ",")
  print(xString, quote=F)
  pURL = paste0("https://www.bloomberg.com/markets/api/comparison/data-timeseries?securities=", xString, "&securityType=COMMON_STOCK&timeFrame=", pFrequency, "&locale=en")
  # pURL = paste0("https://www.bloomberg.com/markets/api/comparison/data-timeseries?securities=", xString, "&securityType=COMMON_STOCK&timeFrame=1_DAY&locale=en")
  # pURL = paste0("https://www.bloomberg.com/markets/api/comparison/data-timeseries?securities=", xString, "&securityType=COMMON_STOCK&timeFrame=5_DAY&locale=en")
  # pURL = paste0("https://www.bloomberg.com/markets/api/comparison/data-timeseries?securities=", xString, "&securityType=COMMON_STOCK&timeFrame=1_YEAR&locale=en")
  CATln(pURL)
  
  htmlALL <- as.character(read_html(pURL))
  DataALL = str.extract(htmlALL, '<html><body><p>', '</p></body></html>')
  x = as.data.table(as.character(DataALL))
  nrow(x)
  if (nrow(x)==1 & ncol(x)==1)
  {
    TO_CONTINUE = F
  } else {
    TO_CONTINUE = T
  }
  if (TO_CONTINUE)
  {
    # xcur1 = fromJSON(x[[1]])
    xcur1 = try(jsonlite::fromJSON(as.character(DataALL)))
    if (all(class(xcur1)!='try-error'))
    {
      str(xcur1)
      # xcur1
      x.Data1 = setDT(xcur1[[1]])
      x.Data2 = setDT(xcur1[[2]])
      
      # DATA_DAY:
      colnames(x.Data1) = tolower(gsub(' |-', '', colnames(x.Data1)))
      str(x.Data1)
      if ("pricedate" %in% names(x.Data1)) { x.Data1[, date:=as.Date(as.character(pricedate), "%m/%d/%Y")]}
      x.Data1[, timestampvn:=as.POSIXct(lastupdateiso,format="%Y-%m-%dT%H:%M:%OS")+(7*60*60)]
      x.Data1[, timestamp:=as.POSIXct(lastupdateiso,format="%Y-%m-%dT%H:%M:%OS")]
      x.Data1[, ":="(source='BLG', codesource=id, close=price, change=pricechange1day, var=percentchange1day/100)]
      Data_Last = x.Data1
      My.Kable.All(Data_Last[, .(source='BLG', codesource=id, country, name, date, timestampvn, timestamp, price, change=pricechange1day, var=percentchange1day/100)])
      
      # str(x.Data1)
      # x.Data1 = CONVERT_IFEXIST_FIELDS(pData=x.Data1, AsType="character", List_Fields=list("name", "longname", "country", "id", "pricedate", "lastupdatetime",
      #                                                                                      "lastupdateiso", "usertimezone"))
      # x.Data1 = CONVERT_IFEXIST_FIELDS(pData=x.Data1, AsType="numeric", List_Fields=list("price", "pricechange1day", "percentchange1day", "lastupdateepoch",
      #                                                                                    "percentchange1year", "percentchange1year", "percentchange1month"))
      
      # DATA_SERIES:
      x.price    = x.Data2$price
      Data_List = list()
      for (k in 1:length(xList))
      {
        # k = 1
        # str(x.Data2)
        xk = setDT(x.price[[k]])
        colnames(xk) = tolower(gsub(' |-', '', colnames(xk)))
        # str(xk)
        xk[, codesource:=xList[[k]]]
        Data_List[[k]] = xk
      }
      Data_All = rbindlist(Data_List)
      Data_All = CONVERT_IFEXIST_FIELDS(pData=Data_All, AsType="numeric",   List_Fields=list("value"))
      if ("datetime" %in% names(Data_All)) { 
        Data_All[, datetime:=as.character(datetime)]
      }
      
      if (pFrequency=='1_DAY')
      {
        Data_All[, timestamp:=gsub("Z","", gsub('T', " ", datetime))]
        Data_All[, date:=as.Date(substr(datetime,1,10))]
        setnames(Data_All, 'value', 'close')
      } else {
        Data_All[, date:=as.Date(as.character(date))]
        setnames(Data_All, 'value', 'close')
        
      }
      
      ins_ref_blg = ins_ref[!is.na(blg)]
      Data_All = merge(Data_All[, -c('code', 'name', 'country', 'continent', 'indhome')], ins_ref_blg[, .(codesource=blg, code, name=short_name, country, continent, indhome)], all.x=T, by='codesource')
      Data_All[, source:='BLG']
      
      
      if (Calculate_DayChangeVar & pFrequency!='1_DAY')
      {
        Data_All = Data_All[order(code, date)]
        Data_All[, ':='(change=(close-shift(close)), var=(close/shift(close))-1), by='code']
      }
      My.Kable(Data_All)
      str(Data_All)
      if ("datetime" %in% names(Data_All)) { 
        Data_All[, datetime:=as.character(datetime)]
        Data_All[, timestamp:=as.POSIXct(datetime,format="%Y-%m-%dT%H:%M:%S")]
        Data_All[, timestampvn:=as.POSIXct(datetime,format="%Y-%m-%dT%H:%M:%OS")+(7*60*60)]
      }
      
      My.Kable.All(Data_Last[, .(source='BLG', codesource=id, country, name, date, timestampvn, timestamp, price, change=pricechange1day, var=percentchange1day/100)])
      My.Kable.MaxCols(Data_All)
      Data_Res = list(Data_Last, Data_All)
      
    } else { Data_Res = data.table()}
  }
  
  return(Data_Res)
}


# ==================================================================================================
TRAINEE_UPDATE_STB_STKVN_REF = function()  {
  # ------------------------------------------------------------------------------------------------
  # try(IFRC_CCPR_UPDATE_STB_STKVN_REF())
  if (SUMMARY_DATE_RDS_UDATA('DOWNLOAD_STB_STKVN_PRICES.rds') > SUMMARY_DATE_RDS_UDATA('DOWNLOAD_STB_STKVN_REF.rds'))
  {
    
    REF    = CCPR_READRDS(UData, 'DOWNLOAD_STB_STKVN_REF.rds', ToKable = T, ToRestore = T)
    PRICES = CCPR_READRDS(UData, 'DOWNLOAD_STB_STKVN_PRICES.rds', ToKable = T, ToRestore = T)
    MaxDate = max(PRICES[!is.na(date)]$date)
    PRICES_TODAY = PRICES[date==MaxDate]
    REF    = rbind(REF[date<MaxDate], PRICES_TODAY[!is.na(reference)], fill=T)[source=='STB']
    REF    = REF[,.(source, codesource, code, date, market, reference, shares, sharesout, last, change, var, close, volume)][date==MaxDate]
    if (nrow(REF)>0)
    {
      REF = MERGE_DATASTD_BYCODE(REF, pOption='FINAL')
      My.Kable(REF[order(date)])
      CCPR_SAVERDS(REF, UData, 'DOWNLOAD_STB_STKVN_REF.rds', ToSummary = T, SaveOneDrive = T)
      
      REF_HISTORY    = CCPR_READRDS(UData, 'DOWNLOAD_STB_STKVN_REF_HISTORY.rds', ToKable = T, ToRestore = T)
      REF_HISTORY    = unique(rbind(REF_HISTORY, REF, fill=T), by=c('code', 'date'), fromLast = T)
      REF_HISTORY    = REF_HISTORY[,.(source, codesource, code, date, market, reference, shares, sharesout, last, change, var, close, volume)]
      REF_HISTORY    = MERGE_DATASTD_BYCODE(REF_HISTORY, pOption='FINAL')[source=='STB']
      CCPR_SAVERDS(REF_HISTORY, UData, 'DOWNLOAD_STB_STKVN_REF_HISTORY.rds', ToSummary = T, SaveOneDrive = T)
    }
  }
}

#===================================================================================================
TRAINEE_DOWNLOAD_VND_STKVN_SHARES_BY_CODE = function(pCode = 'VNM'){
  # ------------------------------------------------------------------------------------------------
  # VND, FREE FLOAT
  # VND, FREEFLOAT
  Final_data = data.table()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  
  pURL = paste0('https://finfo-api.vndirect.com.vn/v4/ratios/latest?filter=ratioCode:MARKETCAP,NMVOLUME_AVG_CR_10D,PRICE_HIGHEST_CR_52W,PRICE_LOWEST_CR_52W,OUTSTANDING_SHARES,FREEFLOAT,BETA,PRICE_TO_EARNINGS,PRICE_TO_BOOK,DIVIDEND_YIELD,BVPS_CR,&where=code:'
                ,pCode,'~reportDate:gt:',LastTrading,'&order=reportDate&fields=ratioCode,value')
  # pCode = 'VCB'
  CATln(pURL)
  
  x = jsonlite::fromJSON(pURL)
  # print(x)
  
  xData = as.data.table(x$data)
  
  if (nrow(xData) > 0 & ('OUTSTANDING_SHARES' %in% xData$ratioCode)){
    Final_data = data.table(source = 'VND', codesource = pCode, ticker = pCode, date = LastTrading, code = paste0('STKVN', pCode),
                            sharesout = xData[ratioCode == 'OUTSTANDING_SHARES']$value,
                            shareslis = xData[ratioCode == 'OUTSTANDING_SHARES']$value,
                            updated=substr(as.character(Sys.time()),1,19))
  }
  
  # xData[, timestamp:= substr(as.character(as.POSIXct(as.numcodelist# xData[, timestamp:= substr(as.character(as.POSIXct(as.numeric(t), origin="1970-01-01")),1,19)]
  My.Kable.All(Final_data)
  
  # CCPR_MONITOR_EXECUTION_SUMMARY (pOption='IFRC_CCPR_DOWNLOAD_VND_STKVN_OWNERSHIP_BY_CODE', pAction="SAVE", NbSeconds=3600, ToPrint=F) 
  return(Final_data)
}

# ==================================================================================================

ADD_UPDATE_INSREF_FROM_INDMOTHER=function(Action="ADD",ToSave=F) {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF(ToForce=T)
  switch (Action,
          "ADD" = {
            # ToSave=T
            indall = setDT(fread("S:/CCPR/DATA/DASHBOARD_LIVE/ccpi_dashboard_indbeq_all_history_summary.txt"))
            codemother = CCPR_READRDS("S:/CCPR/DATA/DASHBOARD_LIVE/","dbl_ind_mother.rds")
            mincols = intersect(names(codemother),names(ins_ref))
            # sort(names(ins_ref))
            # str(ins_ref)
            # str(codemother)
            codemother_min = codemother[,..mincols]
            codemother_min[,":="(base_date=as.character(base_date), base_value=as.character(base_value),
                                 history=as.Date(history))]
            codemother_min[coverage=="VIETNAM", ":="(country="VIETNAM", continent="ASIA",iso2="VN",iso3="VNM")]
            codemother_min[grepl("ETF INDEX|CRYPTO",name),":="(country="GLOBAL", continent="WORLD",iso2="WL",iso3="WLD")]
            
            
            # ins_ref[iso2=="WL",.(code,continent,country,iso2,iso3)]
            # 
            # unique(ins_ref[iso2=="WL",.(code,continent,country,iso2,iso3)]$country)
            
            # ins_ref[,..mincols]
            # rbind(ins_ref, codemother_min,fill=T)
            codemother_full = codemother_min[,":="(active=1, type="IND", prtr=version, provider="IFRC/BEQ",
                                                   startdate = history)]
            ins_ref[,.(enddate,last)]
            # str(indall)
            codemother_full = merge(codemother_full, indall[,.(code,last)],by="code",all.x=T)
            ins_ref_new = codemother_full[!code %in% ins_ref[type=="IND"]$code]
            My.Kable(ins_ref_new)
            insref_final = rbind(ins_ref, ins_ref_new,fill=T)
            
            if (ToSave)
            {
              if (nrow(insref_final)-nrow(ins_ref)>0 & ncol(insref_final)-ncol(ins_ref)==0)
              {
                # select(insref_final,-names(ins_ref))
                # My.Kable.Min(insref_final)
                # My.Kable.Min(insref_final[provider=="IFRC/BEQ"])
                #insref_final [!code %in% ins_ref$code]
                CCPR_SAVERDS(insref_final, UData,"efrc_ins_ref.rds", ToSummary = T, SaveOneDrive = T)
                CCPR_SAVERDS(insref_final, "S:/R/DATA/","efrc_ins_ref.rds", ToSummary = T, SaveOneDrive = T)
                DBL_RELOAD_INSREF(ToForce=T)
                
              }
            }else{
              
              My.Kable.Min(insref_final)
              My.Kable.Min(insref_final[provider=="IFRC/BEQ"])
              
            }
          },
          "UPDATE" = {
            insref_final = data.table()
          }
  )
  
  return(insref_final)
}

# ==================================================================================================
DBL_REPAIR = function(Action = 'UPDATE_IFRC_CCPR_INDHOME_HISTORY') {
  # ------------------------------------------------------------------------------------------------
  switch(Action,
         'UPDATE_IFRC_CCPR_INDHOME_HISTORY' = {
           TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr = UData, File_Fr = 'EFRC_INDHOME_HISTORY.RDS', 
                                                                 Folder_To = 'S:/CCPR/DATA/WORLD_INDEXES/', File_To = 'IFRC_CCPR_INDHOME_HISTORY.rds', 
                                                                 RemoveNA = T, NbDays = 0, pCondition = '', MinPercent = 1, ToForce = F, IncludedOnly = T) 
         } )
}

# ==================================================================================================
# DBL_MERGE_DATA_IND_BY_LIST = function( Index_Folder = '', Index_File = '', 
#                                        IndFolder="S:/CCPR/DATA/DASHBOARD_LIVE/", IndFile="ccpi_dashboard_indbeq_all_history.rds",
#                                        ToFilter = T, Check_Empty = T,min_nb_files = 2000,
#                                        SaveFolder="S:/CCPR/DATA/DASHBOARD_LIVE/", SaveFile="ccpi_dashboard_indbeq_all_history.rds") {
#   # ------------------------------------------------------------------------------------------------
#   # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_INDALS_history.rds'
#   # Index_Folder = 'U:/EFRC/DATA/'; Index_File = 'download_ifrc_INDCURCRY_history.rds'
#   # Index_Folder = 'S:/WCEO_INDEXES/'; Index_File = 'ifrc_ccpr_indwceo_all_history.rds'
#   # Index_Folder = 'S:/WCEO_INDEXES/'; Index_File = 'ifrc_ccpr_indwceo_all_history.rds'
#   
#   # Index_Folder = ''
#   # Index_File = ''
#   # min_nb_files = 2
#   
#   DBL_RELOAD_INSREF(ToForce = (runif(1,1,100) > 70))
#   To_Continue = T
#   list_todo = data.table()
#   selection = data.table()
#   selection_All = data.table()
#   
#   selection_fields = c("short_name","name","code","date","close","close_adj","rt","change","varpc","code_mother",
#                        "iso2","country","continent","type","coverage","category")
#   
#   
#   if (nchar(Index_Folder) > 0 & nchar(Index_File) > 0 & file.exists(paste0(Index_Folder,Index_File))){
#     data = CHECK_CLASS(try(CCPR_READRDS(Index_Folder, Index_File, ToKable = T, ToRestore = T)))
#     if ( nrow(data) > 0 )
#     {
#       list_todo = data.table(active = 1, folder = Index_Folder, filename = Index_File, filter = as.character(NA))
#       
#     }else{
#       To_Continue = F
#     }
#   }else{
#     #selection = CHECK_CLASS(try(CCPR_READRDS(IndFolder,IndFile)))
#     list_files = setDT(fread("S:/CCPR/DATA/DASHBOARD_LIVE/list_files_beq_ind_history.txt"))
#     list_files = list_files[active==1]
#     if (nrow(list_files) >= min_nb_files)
#     {
#       list_todo = list_files[1:min_nb_files,]
#     }else{
#       list_todo = copy(list_files)
#     }
#     
#   }
#   My.Kable(list_todo)
#   if (To_Continue & nrow(list_todo) > 0)
#   {
#     selection_All = CHECK_CLASS(try(CCPR_READRDS(IndFolder,IndFile, ToKable = T, ToRestore = T)))
#     My.Kable(selection_All)
#     if ( nrow(selection_All) > 0)
#     {
#       selection_All = selection_All[,..selection_fields]
#       My.Kable(selection_All)
#       My.Kable.All(unique(selection_All[order(code,-date)],by="code")[,-c("short_name")])
#     }
#     dt_list = list()
#     for (ifile in 1:nrow(list_todo) ) 
#     {
#       # ifile=1
#       x = CHECK_CLASS(try(CCPR_READRDS(list_todo[ifile]$folder, list_todo[ifile]$filename)))
#       if (nrow(x)>0)
#       {
#         x = merge(x[,-c("new_name","new_short_name")], ins_ref[,.(code,new_name=name,new_short_name=short_name)],
#                   by="code",all.x=T)
#         My.Kable(x)
#         if (Index_File == 'download_ifrc_INDCURCRY_history.rds')
#         {
#           x[, cur := 'USD']
#           x[, prtr := 'PR']
#           x[, wgtg := substr(code, nchar(code) - 1, nchar(code))]
#           x[, coverage := 'INTERNATIONAL']
#           x[grepl('TOP', name), category := 'TRADABLE']
#           x[!grepl('TOP', name), category := 'BENCHMARK']
#           
#           
#         }
#         if (!"name" %in% names(x)) { x[, name:=new_name] }
#         if (!"short_name" %in% names(x)) { x[, short_name:=new_short_name] }
#         x[is.na(name) & !is.na(new_name), name:=new_name]
#         x[is.na(short_name) & !is.na(new_short_name), short_name:=new_short_name]
#         x[is.na(short_name) & !is.na(name), short_name:=name]
#         x[!is.na(short_name) & is.na(name), name:=short_name]
#         My.Kable(x)
#         if (ToFilter)
#         {
#           if (grepl(",",list_todo[ifile]$filter))
#           {
#             x = x[code %in% unlist(str_split(list_todo[ifile]$filter, ","))]
#           }else{
#             if(!is.na(list_todo[ifile]$filter))
#             {
#               x = x[grepl(list_todo[ifile]$filter,code)]
#             }
#             
#             My.Kable(x)
#           }
#         }
#         x_selection = intersect(names(x),selection_fields)
#         My.Kable(x)
#         x = x[,..x_selection]
#         x = x[close!=0 & !is.na(close) & !is.na(date)]
#         dt_list[[ifile]] = x[!is.na(name)]
#         My.Kable.Min(x)
#         rm(x)
#       }
#     }
#     GC_SILENT()
#     
#     # HISTORY FILTERS
#     dtlist = rbindlist(dt_list, fill=T)
#     if (nrow(dtlist) > 0 & all(c("code", "date") %in% names(dtlist)) )
#     {
#       dtlist = unique(dtlist[order(code,date)],by=c("code","date"))
#     }
#     rm(dt_list)
#     GC_SILENT()
#     length(intersect(names(dtlist),selection_fields))==length(selection_fields)
#     if (nrow(selection_All) > 0)
#     {
#       selection = selection_All[,date:=as.Date(date)][!code %in% dtlist$code]
#     }
#     rm(selection_All)
#     selection = rbind(selection, dtlist, fill=T)
#     #selection = rbind(selection[,date:=as.Date(date)][!code %in% dtlist$code], dtlist, fill=T)
#     selection = merge(selection, ins_ref[type=="IND",.(code,new_ios2=iso2,new_country=country,new_continent=continent,new_type=type)],by="code",all.x=T)
#     selection[is.na(iso2) & !is.na(new_ios2), iso2:=new_ios2]
#     selection[is.na(country) & !is.na(new_country), country:=new_country]
#     selection[is.na(continent) & !is.na(new_continent), continent:=new_continent]
#     selection[is.na(type) & !is.na(new_type), type:=new_type]
#     selection = selection[,-c("new_ios2","new_country","new_continent","new_type")]
#     selection[,":="(rt=close/shift(close) -1, change=close-shift(close), close_adj=close),by="code"]
#     selection[,varpc:=100*rt]
#     
#     codemother = CHECK_CLASS(try(CCPR_READRDS("S:/CCPR/DATA/DASHBOARD_LIVE/","dbl_ind_mother.rds", ToKable = T, ToRestore = T)))
#     My.Kable(codemother)
#     # if (nrow(codemother) > 0 & )
#     selection = merge(selection, ins_ref[,.(code, new_coverage = coverage, new_category = category)],
#                       by="code",all.x=T)
#     selection = merge(selection, codemother[,.(code,new_name=name,new_shortname=short_name,new_codemother=index_compo)],
#                       by="code",all.x=T)
#     # selection[is.na(name)]
#     selection[is.na(name) & !is.na(new_name), name := new_name]
#     selection[is.na(short_name) & !is.na(new_shortname), short_name:=new_shortname]
#     selection[is.na(code_mother) & !is.na(new_codemother), code_mother:=new_codemother]
#     selection[is.na(coverage) & !is.na(new_coverage), coverage:=new_coverage]
#     
#     selection[is.na(category) & !is.na(new_category), category:=new_category]
#     
#     # selection[is.na(name)]
#     selection = selection[,-c("new_name","new_shortname","new_codemother", "new_category", "new_coverage")]
#     
#     selection[,name:=gsub("^IFRC/BEQ HOLDINGS IFRC/BEQ HOLDINGS ","IFRC/BEQ HOLDINGS ",name)]
#     selection[,short_name:=gsub("^IFRC/BEQ HOLDINGS IFRC/BEQ HOLDINGS ","IFRC/BEQ HOLDINGS ",name)]
#     selection[,short_name:=gsub("^IFRC ","",short_name)]
#     selection[,short_name:=gsub("^IFRC/BEQ HOLDINGS ","",short_name)]
#     
#     selection = UPDATE_UPDATED(selection)
#     # setkeyv(selection, c("code", "date"))
#     selection = selection[code != 'XXZY']
#     My.Kable(selection)
#     My.Kable(selection[grepl('CRYPTO', name)])
#     # str(selection)
#     My.Kable(unique(selection[order(code,-date)],by="code"))
#     
#     summary = selection[,.(n=.N,start=date[1],end=date[.N]),by="code"]
#     summary = summary[end>=SYSDATETIME(1)-20]
#     
#     selection = selection[code %in% summary$code]
#     
#     selection[grepl("ETF INDEX", name), ':=' (coverage = "INTERNATIONAL", category = 'TRADABLE', prtr = 'PR',wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
#     
#     My.Kable.Min(selection[order(date, code)])
#     My.Kable(unique(selection[order(code, -date)][grepl("ETF INDEX", name)], by = 'code')[,. (code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
#     
#     selection[grepl("WOMEN", name), ':=' (prtr = substr(code, nchar(code)-4, nchar(code) - 3),wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
#     selection[grepl("WOMEN", name) & grepl('VIETNAM', name) & !grepl('TOP', name), ':=' (coverage = "VIETNAM", category = 'BENCHMARK')]
#     selection[grepl("WOMEN", name) & grepl('VIETNAM', name) & grepl('TOP', name), ':=' (coverage = "VIETNAM", category = 'TRADABLE')]
#     
#     selection[grepl("WOMEN", name) & !grepl('VIETNAM', name) & !grepl('TOP', name), ':=' (coverage = "INTERNATIONAL", category = 'BENCHMARK')]
#     selection[grepl("WOMEN", name) & !grepl('VIETNAM', name) & grepl('TOP', name), ':=' (coverage = "INTERNATIONAL", category = 'TRADABLE')]
#     
#     selection[substr(name, nchar(name), nchar(name)) == ')' & substr(code, nchar(code) - 2, nchar(code)) == 'LOC', cur := substr(word(name, 2, 2, '[(]'),1,3)]
#     selection[, type := substr(code, 1, 3)]
#     
#     selection[grepl("VNX ", name) & !grepl('TOP', name) & is.na(coverage) & is.na(category), ':=' (coverage = "VIETNAM", category = 'BENCHMARK')]
#     selection[grepl("VNX ", name) & grepl('TOP', name)  & is.na(coverage) & is.na(category), ':=' (coverage = "VIETNAM", category = 'TRADABLE')]
#     selection[grepl("VNX GROUP", name), ':=' (prtr = substr(code, nchar(code)-4, nchar(code) - 3),wgtg = substr(code, nchar(code)-6, nchar(code) - 5) ,cur = substr(code, nchar(code)-2, nchar(code)))]
#     
#     
#     My.Kable.All(unique(selection[grepl('IFRC', name)], by = 'code')[,.(n=.N,start=date[1],end=date[.N]),by= c("coverage", "category")])
#     
#     My.Kable(unique(selection[order(code, -date)][grepl("WOMEN", name)], by = 'code')[,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
#     
#     My.Kable(unique(selection[order(code, -date)][grepl('IFRC', name) & (is.na(coverage) | is.na(category))], by = 'code')[,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
#     
#     My.Kable(selection[order(date, date)][grepl('IFRC', name)][,. (iso2, code, name, date, close, rt, cur, prtr, wgtg, coverage, category)])
#     
#     
#     try(CCPR_SAVERDS(selection, SaveFolder, SaveFile, ToSummary = T, SaveOneDrive = T))
#     
#     rm(selection) ;  GC_SILENT()
#   }
#   
#   return(selection)
# }

# ==================================================================================================
DBL_INDEXES_CONVERT_CURRENCIES_FROM_VND = function(IND_FOLDER    = paste0('S:/STKVN/INDEX_2024/'), IND_FILENAME  = 'ifrc_ccpr_ind_sectors_gics_history.rds',
                                                   Save_Folder   = paste0('S:/STKVN/INDEX_2024/'), Save_File     = 'ifrc_ccpr_ind_sectors_gics_history.rds',
                                                   CUR_FILE_NAME = 'BEQ_CUR_4INDEX.rds',
                                                   IND_CURS_LIST = list('USD', 'GBP', 'EUR', 'JPY', 'SGD', 'AUD', 'CAD', 'KRW', 'HKD', 'CNY'),
                                                   IncludeOnly_VND = T) {
  # ------------------------------------------------------------------------------------------------
  
  # IND_FILENAME = 'DOWNLOAD_IFRC_INDPOR_HISTORY.rds'
  
  # IND_HISTORY  = CCPR_READRDS(UData, IND_FILENAME, ToKable = T, ToRestore = T)
  # IND_FILENAME = 'ifrc_ccpr_ind_gics_history.rds'
  # IND_FILENAME = 'ifrc_ccpr_ind_icb_history.rds'
  # IND_FILENAME = 'ifrc_ccpr_ind_basic_history.rds'
  # IND_FILENAME = 'ifrc_ccpr_ind_group_history.rds'
  
  IND_HISTORY  = CHECK_CLASS(try(CCPR_READRDS(IND_FOLDER, IND_FILENAME, ToKable = T, ToRestore = T)))
  if (nrow(IND_HISTORY)>0)
  {
    IND_HISTORY  = unique(IND_HISTORY[order(code, date)], by=c('code', 'date'))
    if (IncludeOnly_VND) { IND_HISTORY = IND_HISTORY[grepl('VND$', code)]}
    # IND_HISTORY  = MERGE_DATASTD_BYCODE(IND_HISTORY)
    My.Kable(IND_HISTORY)
    # CUR_YAH      = DATACENTER_LOADDTRDS_UDATA('DOWNLOAD_YAH_CUR_HISTORY.rds')
    # My.Kable(CUR_YAH[code=='CURUSDVND'][order(date)][, .(code, date, close)])
    
    CUR_HISTORY  = CCPR_READRDS(UData, CUR_FILE_NAME, ToKable = T, ToRestore = T)
    CUR_HISTORY = CUR_HISTORY[order(code, date)]
    CUR_HISTORY[, rt:=(close/shift(close))-1, by='code']
    CUR_HISTORY[, pclose:=shift(close), by='code']
    
    My.Kable(CUR_HISTORY[code=='CURGBPVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CUREURVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURUSDVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURJPYVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURSGDVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURAUDVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURCADVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURKRWVND'][order(date)])
    My.Kable(CUR_HISTORY[code=='CURHKDVND'][order(date)])
    
    My.Kable(CUR_HISTORY[code=='CURCNYVND'][order(date)][, .(code, date, close)][order(close)])
    My.Kable(CUR_HISTORY[code=='CURCNYVND'][order(date)][, .(code, date, close, rt, pclose)][order(rt)])
    
    My.Kable(CUR_HISTORY[code=='CURUSDVND'][order(date)])
    
    # CUR_FROM = 'USD'; ISO2 = "US"
    CUR_FROM = 'VND'; ISO2 = "VN"
    
    FINAL_INDEXES = data.table()
    
    for (PRTR in list('PR', 'TR'))
    {
      for (pCUR in IND_CURS_LIST)
      {
        # PRTR = 'PR'; pCUR = 'GBP'
        # PRTR = 'PR'; pCUR = 'EUR'
        # PRTR = 'PR'; pCUR = 'JPY'
        # PRTR = 'PR'; pCUR = 'SGD'
        # PRTR = 'PR'; pCUR = 'VND'
        # pCUR = 'USD'
        # CUR_TO   = 'USD'
        CUR_TO   = pCUR
        IND_CUR_MOTHER = IND_HISTORY[grepl(paste0(PRTR, CUR_FROM,'$'), code)]
        IND_CUR_MOTHER[, cur:=CUR_FROM]
        # My.Kable.TB(unique(IND_CUR_MOTHER[order(code, -date)], by='code')[, .(code, name, date, close, cur, name_mother=name)])
        
        CUR_CONVERT = paste0('CUR', CUR_TO, CUR_FROM)
        CUR_CONVERT_INV = paste0('CUR', CUR_FROM,CUR_TO)
        CUR_TOMERGE = CUR_HISTORY[code==CUR_CONVERT][, .(code, date, close)]
        CUR_INVERSE = CUR_HISTORY[code==CUR_CONVERT_INV][, .(code, date, close)]
        
        CUR_TOMERGE_FINAL = merge(CUR_TOMERGE, CUR_INVERSE[, .(date, inverse=close)], all=T, by='date')
        My.Kable(CUR_TOMERGE_FINAL)
        CUR_TOMERGE_FINAL[, code:=CUR_CONVERT]
        CUR_TOMERGE_FINAL[is.na(close) & !is.na(inverse), ':='(close=1/inverse, r=1)]
        My.Kable(CUR_TOMERGE_FINAL)
        
        IND_CUR_MOTHER_DATES = unique(IND_CUR_MOTHER, by='date')[, .(date)]
        IND_CUR_MOTHER_DATES = merge(IND_CUR_MOTHER_DATES[, -c('cur_tofrom')], CUR_TOMERGE_FINAL[, .(date, cur_tofrom=close)], all.x=T, by='date')
        
        MinDate  = min(IND_CUR_MOTHER_DATES$date)
        MinValue = (CUR_TOMERGE_FINAL[!is.na(close)][1]$close)
        MaxDate  = max(CUR_TOMERGE_FINAL[date<=MinDate]$date)
        if (!is.infinite(MaxDate)) {
          MaxValue = CUR_TOMERGE_FINAL[date==MaxDate]$close
        } else {
          MaxValue = MinValue
        }
        CATln(paste(MinDate, MaxDate, MaxValue))
        IND_CUR_MOTHER_DATES[date==MinDate, close:=MaxValue]
        IND_CUR_MOTHER_DATES[date==MinDate, cur_tofrom    :=MaxValue]
        
        IND_CUR_MOTHER_DATES[, cur_tofrom:=na.locf(cur_tofrom)]
        IND_CUR_MOTHER_DATES[, rt_cur:=(cur_tofrom/shift(cur_tofrom))-1]
        My.Kable(IND_CUR_MOTHER_DATES)
        
        IND_CUR_MOTHER = IND_CUR_MOTHER[order(code, date)][, .(code, date, close, cur, cur_to=CUR_TO, cur_to_from=paste0(CUR_TO, CUR_FROM))]
        IND_CUR_MOTHER[, rt:=(close/shift(close))-1, by='code']
        IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('rt_cur', 'cur_tofrom')], IND_CUR_MOTHER_DATES[, .(date, rt_cur, cur_tofrom)], all.x=T, by='date')
        IND_CUR_MOTHER = IND_CUR_MOTHER[order(code, date)]
        IND_CUR_MOTHER[!is.na(rt), rt_ratio := (1+rt)/(1+rt_cur), by='code']
        IND_CUR_MOTHER[is.na(rt), rt_ratio := 1]
        IND_CUR_MOTHER[, cum_rt_ratio := cumprod(rt_ratio), by='code']
        IND_CUR_MOTHER_START = unique(IND_CUR_MOTHER[order(code, date)], by='code')
        
        IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('close_curto')], IND_CUR_MOTHER_START[, .(code, close_curto=close)], all.x=T, by='code')
        IND_CUR_MOTHER[, close_curto:=close_curto*cum_rt_ratio]
        IND_CUR_MOTHER[, rt_curto:=(close_curto/shift(close_curto))-1, by='code']
        IND_CUR_MOTHER[, check:=(1+rt_curto)-rt_ratio]
        # IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')
        IND_CUR_MOTHER = MERGE_DATASTD_BYCODE(IND_CUR_MOTHER)[order(code, date)]
        # My.Kable(IND_CUR_MOTHER[order(code, date)][code==paste0('INDVNXASPR', CUR_FROM)][, .(provider, monitor, country, code, name, date, close, cur, rt)])
        IND_CUR_MOTHER_FINAL = IND_CUR_MOTHER
        IND_CUR_MOTHER_FINAL[, code_mother:=code]
        IND_CUR_MOTHER_FINAL[, close:=close_curto]
        IND_CUR_MOTHER_FINAL[, code:=gsub(CUR_FROM, CUR_TO, code_mother)]
        IND_CUR_MOTHER_FINAL[, cur:=CUR_TO]
        # IND_CUR_MOTHER_FINAL = MERGE_DATASTD_BYCODE(IND_CUR_MOTHER_FINAL)[order(code, date)]
        IND_CUR_MOTHER_FINAL[, rt:=(close/shift(close))-1, by='code']
        IND_CUR_MOTHER_FINAL[, change:=(close-shift(close)), by='code']
        IND_CUR_MOTHER_FINAL[, varpc:=100*rt, by='code']
        # str(IND_CUR_MOTHER_FINAL)
        
        IND_CUR_MOTHER_FINAL[, name:=gsub(paste0(CUR_FROM,')$'), paste0(CUR_TO,')'), name )]
        IND_CUR_MOTHER_FINAL = IND_CUR_MOTHER_FINAL[, -c('rt_curto', 'rt_cur', 'cum_rt_ratio', 'cur_to_from', 'capiusd', 
                                                         'close_curto', 'check', 'cur_tofrom', 'cur_to', 'rt_ratio', 'capiusd')]
        # IND_CUR_MOTHER_FINAL = merge(IND_CUR_MOTHER_FINAL[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')
        # str(IND_CUR_MOTHER_FINAL)
        
        My.Kable.Min(IND_CUR_MOTHER_FINAL[order(code, date)])
        FINAL_INDEXES = rbind(FINAL_INDEXES, IND_CUR_MOTHER_FINAL, fill=T)
        GC_SILENT()
      }
    }
    
    FINAL_INDEXES = rbind(IND_HISTORY, FINAL_INDEXES, fill=T)[!is.na(date)]
    FINAL_INDEXES[grepl('VND$', code), cur:='VND']
    # FINAL_INDEXES = merge(FINAL_INDEXES[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')[, -c('sample', 'home')]
    FINAL_INDEXES = unique(FINAL_INDEXES[order(code, date)], by=c('code', 'date'))
    My.Kable(FINAL_INDEXES[, -c('continent', 'type')])
    My.Kable(unique(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd", "n", "base_value", "base_date", "code_mother", "source")][order(code, -date)], by='code'), Nb=10)
    My.Kable(unique(FINAL_INDEXES[, .(code, date, close, cur)][order(code, -date)], by='code'), Nb=10)
    My.Kable(unique(FINAL_INDEXES[, .(code, date, close, cur)][order(code, date)], by='code'), Nb=10)
    
    CATln_Border('REMOVE CLOSE == 0')
    FINAL_INDEXES = FINAL_INDEXES[!is.na(close)]
    
    # FINAL_INDEXES[grepl('VND$', code), cur:='VND']
    FINAL_INDEXES[grepl('PRVND$|TRVND$', code), code_mother:=code]
    FINAL_INDEXES[, close_adj:=close]
    FINAL_INDEXES[, varpc:=100*rt]
    My.Kable.Min(unique(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd")][order(code, -date)], by='code'))
    
    # name
    ONE_INDEX = unique(FINAL_INDEXES[!is.na(name)], by='code')
    FINAL_INDEXES = merge(FINAL_INDEXES[, -c('name')], ONE_INDEX[, .(code, name)], all.x=T, by='code')
    
    str(FINAL_INDEXES)
    FINAL_INDEXES = FINAL_INDEXES[, -c('provider', 'monitor', 'codesource', 'source', 'type', 'fcat', 'iso2', 'country', 'continent', 'name')]
    # My.Kable(FINAL_INDEXES[, .(code, name)][order(code, -date)][code=='IFRCINDETFBLKCHNEWPRUSD'])
    My.Kable(FINAL_INDEXES[order(code, -date)])
    My.Kable(unique(FINAL_INDEXES[order(code, date)], by='code'))
    FINAL_INDEXES = FINAL_INDEXES[order(code, date)]
    FINAL_INDEXES[, close_adj:=close]
    FINAL_INDEXES[, rt:=(close/shift(close))-1, by='code']
    FINAL_INDEXES[, varpc:=100*rt]
    FINAL_INDEXES[, change:=close-shift(close), by='code']
    My.Kable(FINAL_INDEXES)
    My.Kable(FINAL_INDEXES[order(-date,code)])
    
    FINAL_INDEXES = FINAL_INDEXES[order(code, date)]
    IND_FILENAME_PRICES = gsub('history', 'prices', IND_FILENAME)
    CATln_Border(IND_FILENAME_PRICES)
    
    FINAL_INDEXES = TRAINEE_MERGE_COL_FROM_REF (pData        = FINAL_INDEXES, 
                                                Folder_Fr    =  '',       File_Fr = '' , 
                                                ToSave       = F ,   Folder_To = '' ,       File_To = '' ,
                                                List_Fields  = c('name','cur','wgtg','prtr', 'category', 'coverage'))
    
    My.Kable(FINAL_INDEXES[, .(code, name, date, close, rt, varpc, change, cur, wgtg, category, coverage, prtr)])
    # CCPR_SAVERDS(FINAL_INDEXES, UData, IND_FILENAME_PRICES, ToSummary = T, SaveOneDrive = T)
    try(CCPR_SAVERDS(FINAL_INDEXES, Save_Folder, Save_File, ToSummary = T, SaveOneDrive = T))
    
  }
  return (FINAL_INDEXES)
  
}


# ==================================================================================================
TRAINEE.IFRC.UPLOAD.RDS.2024 = function(l.host = "ifrc.vn",user = '', password = '', host = '', dbname = "ccpi_dashboard_login",
                                        l.tablename='', l.filepath='', 
                                        CheckHostFields=T, CheckListFields =T, LIST_FIELDS = list('category', 'coverage'), 
                                        ToPrint = F,
                                        ToForceUpload=F, ToForceStructure=F)  {
  # ------------------------------------------------------------------------------------------------
  # l.host = "strategy.vnefrc.com"; l.tablename = "efrc_str_ifrclab_last"; l.filepath = paste0(UData,"strategy/efrc_str_ifrclab_last.rds")
  # l.host = "ccpr.vn"; l.tablename = "ccpr_indals_history"; l.filepath = paste0(UData,"ccpr_indals_history.rds")
  # l.host = "ccpr.vn"; l.tablename = "ccpr_indcur_history"; l.filepath = paste0(UData,"ccpr_indcur_history.rds")
  # 
  # CheckField=T; ToPrint = T;  ToForceUpload=T; ToForceStructure=F
  # ToPrint = T
  DATACENTER_LINE_BORDER(paste('IFRC.UPLOAD.RDS = ', l.host, ' >>>', l.tablename))
  
  if (ToForceUpload) 
  {   ToUploadAll=T } else {   source("T:/R/CONFIG/UPLOAD_ALL.R", echo = F)     }
  CATln(paste ('ToUploadAll = ',ToUploadAll) )
  
  if (ToUploadAll)
  {
    # ToUploadAll = T
    t1 = Sys.time()
    CATrp("Connecting host...")
    
    if (nchar (l.host) == 0)
    {
      # MY_CONNECTION = try(dbConnect(MySQL(), user = "dashboard_user_login", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard_login"))
      conn = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = dbname))
      
    } else {
      conn = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = l.host))
    }
    
    # print(conn)
    
    SUCCESS =  (typeof (conn) == 'S4')
    if (SUCCESS)
    {
      if (ToPrint) 
      { 
        print(conn) 
        Sys.sleep (2)
      }
      
      l.data = readRDS(l.filepath)
      
      DATACENTER_LINE_BORDER(paste('CHECK TABLE EXIST:  ', l.host, ' >>>', l.tablename))
      
      check_table_exist = setDT(dbGetQuery(conn,statement = paste0('SHOW TABLES LIKE "',l.tablename, '"')))
      dbDisconnect(conn)
      
      if (nrow(check_table_exist)>0)
      {
        colnames(check_table_exist) = c("tablename")
        check_table_exist = check_table_exist[tablename == l.tablename]
      }
      nb = nrow(check_table_exist)
      CATln(paste('nb = ', nb))
      if (nb >= 1) {  CATrp('EXIST TABLE ...')}
      
      # try(dbDisconnect(conn),silent = T)
      if (nb == 1) 
      {
        if (ToForceStructure) 
        { 
          UPLOAD_STRUCTURE_RDS_TO_SQL.2023(FileRDS="", DataRDS=l.data, TableSQL=l.tablename, host=l.host, ToForce=T) 
        }
        
        DATACENTER_LINE_BORDER(paste('COMPARE LOCAL DATA COLNAMES VS HOST ...'))
        if (CheckHostFields)
        {
          if (nchar (l.host) == 0)
          {
            conn = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = dbname))
          } else {
            conn = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = l.host))
          }
          
          CATrp("Read Table...")
          host_dt = dbReadTable(conn,l.tablename)
          host_dt = setDT(host_dt)
          ncols0  = colnames(host_dt)
          ncols   = setdiff(ncols0, "id")
          ncols   = (l.data[,colnames(l.data)[which(gsub(" ","\\.",colnames(l.data)) %in% ncols)]])
          l.data  = l.data[, ..ncols]
          try(dbDisconnect(conn),silent = T)
          CATln("Close connexion.")
          
          if (! 'update' %in% names (l.data)) { UPDATE_UPDATED (l.data)  }
          if ('ord' %in% names(l.data)) { l.data[, ord:=as.numeric(ord)] }
          My.Kable.MaxCols(l.data)
          str(l.data)
          
          diff = setdiff (ncols, colnames (l.data))
          if ( length (diff) > 0 ) 
          {
            CATln(paste ("MISSING FIELDS =", paste (diff, collapse = ',')) ) 
            HOST_FIELDS = T
          } else { 
            CATln("NO MISSING HOST FIELDS") 
            HOST_FIELDS = F
          }
          
        }
        
        if (HOST_FIELDS ) 
        {
          if (CheckListFields)
          {
            
            DATACENTER_LINE_BORDER(paste('TO CHECK REQUIRED FIELDS ...'))
            if (all ( LIST_FIELDS %in% names (l.data)) )
            {
              CHECK_FIELDS = T
              CATln("NO MISSING CHECK FIELDS")
              if (nchar (l.host) == 0)
              {
                conn = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = dbname))
              } else {
                conn = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = l.host))
              }
              x = IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023(l.host, l.tablename, l.data)
              try(dbDisconnect(conn),silent = T)
              CATln("Close connexion.")
              
            } else {
              mising_fields = unlist (setdiff (LIST_FIELDS, names (l.data)))
              CATrp( paste0 ( 'NOT UPLOAD, MISSING CHECK FIELDS = ', paste(mising_fields, collapse = ',') ) )
            }
            
          }
        } else {
          DATACENTER_LINE_BORDER("MISSING CHECK FIELDS, NOT UPLOAD...")
        }
        
      } else if (nb == 0) {
        
        if (CheckListFields)
        {
          DATACENTER_LINE_BORDER(paste('TO CHECK REQUIRED FIELDS ...'))
          if (all ( LIST_FIELDS %in% names (l.data)) )
          {
            CHECK_FIELDS = T
            CATln("NO MISSING CHECK FIELDS")
            
            if (nchar (l.host) == 0)
            {
              conn = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = dbname))
            } else {
              conn = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = l.host))
            }
            try(UPLOAD_STRUCTURE_RDS_TO_SQL.2023(FileRDS="", DataRDS=l.data, TableSQL=l.tablename, host=l.host, ToForce=T)     )   
            x = IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023(l.host, l.tablename, l.data)
          } else {
            mising_fields = unlist (setdiff (LIST_FIELDS, names (l.data)))
            DATACENTER_LINE_BORDER( paste0 ( 'NOT UPLOAD, MISSING CHECK FIELDS = ', paste(mising_fields, collapse = ',') ) )
          }
          
          try(dbDisconnect(conn),silent = T)
          CATln("Close connexion.")
        }
        
        print(paste("IFRC.UPLOAD.RDS >>> path :", l.filepath, "| OK"))
      } 
    } else {
      CATln(paste0("CONNEXION NOT AVAILABLE"))
      try(dbDisconnect(conn),silent = T) 
    }
    
    printrep('.',100)
    if(ToPrint) {   efrc.print.time("Elapsed time = ", t1)    }
    
    try(dbDisconnect(conn),silent = T) 
  }
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VND_ACCOUNTING = function(pCode = 'VND', PERIOD = 'QUARTER'){
  # ------------------------------------------------------------------------------------------------
  pURL = paste0('https://finfo-api.vndirect.com.vn/v4/financial_models?sort=displayOrder:asc&q=codeList:',pCode,'~modelType:1,89,101,411~note:TT199/2014/TT-BTC,TT334/2016/TT-BTC,TT49/2014/TT-NHNN,TT202/2014/TT-BTC~displayLevel:0,1,2,3&size=999')
  x = jsonlite::fromJSON(pURL)
  data = as.data.table(x$data)
  data = CLEAN_COLNAMES(data)
  
  years = 1900:year(Sys.Date())
  switch(PERIOD,
         'YEAR' = {
           fiscal_dates = paste0(years, "-12-31")
           fiscal_date_param =paste(fiscal_dates, collapse = ",")
           
           base_url = paste0("https://finfo-api.vndirect.com.vn/v4/financial_statements?q=code:",pCode,"~reportType:ANNUAL~modelType:1,89,101,411~fiscalDate:")
           query_params = "&sort=fiscalDate&size=36500"
           
           pURL = paste0(base_url, fiscal_date_param, query_params)
         },
         'QUARTER' = {
           current_year = year(Sys.Date())
           current_quarter = quarter(Sys.Date())
           
           fiscal_dates = c()
           
           while (current_year >= 2000) {
             for (q in 4:1) {
               if (current_year == year(Sys.Date()) && q > current_quarter) next
               day = ifelse(q == 1, 31, ifelse(q == 2, 30, ifelse(q == 3, 30, 31)))
               month = ifelse(q == 1, 3, ifelse(q == 2, 6, ifelse(q == 3, 9, 12)))
               fiscal_dates = c(fiscal_dates, paste0(current_year, sprintf("-%02d-%02d", month, day)))
             }
             current_year = current_year - 1
           }
           
           fiscal_date_param = paste(fiscal_dates, collapse = ",")
           
           base_url = paste0("https://finfo-api.vndirect.com.vn/v4/financial_statements?q=code:", pCode, "~reportType:QUARTER~modelType:1,89,101,411~fiscalDate:")
           query_params = "&sort=fiscalDate&size=3650"
           
           pURL = paste0(base_url, fiscal_date_param, query_params)
           # https://finfo-api.vndirect.com.vn/v4/financial_statements?q=code:VND~reportType:QUARTER~modelType:1,89,101,411~fiscalDate:2024-03-31,2023-12-31,2023-09-31,2023-06-31,2023-03-31,2022-12-31,2022-09-31,2022-06-31,2022-03-31,2021-12-31,2021-09-31,2021-06-31,2021-03-31&sort=fiscalDate&size=3650
           # pURL = 'https://finfo-api.vndirect.com.vn/v4/financial_statements?q=code:VNM~reportType:QUARTER~modelType:1,89,101,411~fiscalDate:2024-03-31,2023-12-31,2023-09-30,2023-06-30,2023-03-31,2022-12-31,2022-09-30,2022-06-30,2022-03-31,2021-12-31&sort=fiscalDate&size=2000'
         })
  
  # cat(pURL)
  
  # pURL = 'https://finfo-api.vndirect.com.vn/v4/financial_statements?q=code:VNM~reportType:ANNUAL~modelType:1,89,101,411~fiscalDate:2024-12-31,2023-12-31,2022-12-31,2021-12-31,2020-12-31,2019-12-31,2018-12-31,2017-12-31,2016-12-31,2015-12-31,2014-12-31&sort=fiscalDate&size=2000'
  # pURL = 'https://finfo-api.vndirect.com.vn/v4/financial_statements?q=code:VNM~reportType:ANNUAL~modelType:1,89,101,411~fiscalDate:2024-06-30,2024-03-31,2023-12-31,2023-09-30,2023-06-30,2023-03-31,2022-12-31,2022-09-30,2022-06-30&sort=fiscalDate&size=2000'
  x = jsonlite::fromJSON(pURL)
  data_value = as.data.table(x$data)
  data_value = CLEAN_COLNAMES(data_value)
  
  data_value = merge(data_value, data[, .(itemcode, itemvnname, itemenname)], all.x = T, by = 'itemcode')
  final_data = data_value[, .(source = 'VND', dataset = 'ACCOUNTING',category = 'FINANCIAL STATEMENTS', ticker = code, code = paste0('STKVN',code), itemcode, itemvnname = gsub('  ', ' ', itemvnname), itemenname = gsub('  ', ' ', itemenname), 
                              year = year(fiscaldate), fiscaldate, reporttype, value = numericvalue, date = as.Date(modifieddate))]
  final_data = final_data[order(itemcode, -fiscaldate)]
  final_data = UPDATE_UPDATED(final_data)
  My.Kable(final_data)
  # My.Kable(final_data[grepl('Loss', itemenname, ignore.case = T)])
  
  return(final_data)
}

#===================================================================================================
TRAINEE_CREATE_PERIOD_FROM_HISTORY = function(pData       = data.table(),
                                              Period      = 'MONTH', 
                                              File_Folder = UData,
                                              File_Name   = 'EFRC_INDHOME_HISTORY.rds',
                                              ToSave      = T) {
  # ------------------------------------------------------------------------------------------------
  # x = TRAINEE_CREATE_PERIOD_FROM_HISTORY (Period = 'MONTH', File_Folder = "S:/CCPR/DATA/DASHBOARD_LIVE/", File_Name = 'ccpi_dashboard_indbeq_all_history.rds', ToSave = T)
  # x = TRAINEE_CREATE_PERIOD_FROM_HISTORY (Period = 'YEAR', File_Folder = "S:/CCPR/DATA/DASHBOARD_LIVE/", File_Name = 'ccpi_dashboard_indbeq_all_history.rds', ToSave = T)
  
  # File_Folder = UData
  # File_Name   = 'EFRC_INDHOME_HISTORY.rds'
  # File_Folder = "S:/CCPR/DATA/DASHBOARD_LIVE/",
  # File_Name   = "ccpi_dashboard_indbeq_all_history.rds"
  StartTime = Sys.time()
  IND_PERIOD     = data.table()
  if (nrow(pData)==0)
  {
    IND_HISTORY = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T, ToRestore = T)))
  } else {
    IND_HISTORY = copy(pData)
  }
  # IND_HISTORY = CCPR_READRDS(UData, 'EFRC_INDHOME_HISTORY.rds', ToKable=T, ToRestore = T)
  exclude = try (setDT (fread ('S:/CCPR/DATA/DASHBOARD_LIVE/dbl_list_ind_to_exclude.txt') ) )
  if (all(class(exclude)!='try-error')) {
    Ind_History = IND_HISTORY [! code %in% exclude [active == 1]$code] 
  }
  
  # My.Kable.Min(IND_HISTORY)
  if (nrow(IND_HISTORY)>0)
  {
    DBL_RELOAD_INSREF()
    
    
    Fields_min = c('code', 'date', 'name', 'close', 'close_adj', 'cur', 'wgtg', 'version', 'prtr','category', 'size',  'coverage')
    Fields_cmn = intersect(Fields_min,names(IND_HISTORY))
    IND_HISTORY = IND_HISTORY[, ..Fields_cmn][code!='XXZY'][!is.na(close)]
    
    # IND_HISTORY = MERGE_DATASTD_BYCODE(IND_HISTORY, pOption='FINAL')
    # IND_SUMMARY  = IND_HISTORY[order(code, date)][, .(n=.N, start=date[1], end=date[.N]), by='code']
    switch(
      Period,
      'MONTH' = {
        IND_HISTORY[, yyyymm:=100*year(date)+month(date)]
        IND_PERIOD    = unique(IND_HISTORY[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
      },
      'YEAR' = {
        IND_HISTORY[, yyyy:=year(date)]
        IND_PERIOD    = unique(IND_HISTORY[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]        
      },
      'QUARTER' = {
        IND_HISTORY[, yyyyqn:=year(date)*100+floor((month(date)-1)/3)+1]
        IND_PERIOD    = unique(IND_HISTORY[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
      },
      'SEMESTER' = {
        IND_HISTORY[, yyyy6m := year(date)*100 + ceiling(month(date)/6)]
        IND_PERIOD = unique(IND_HISTORY[order(code, -date)], by = c('code', 'yyyy6m'))[order(code, date)]
      }
    )   
  }     
  
  # IND_PERIOD    = unique(IND_HISTORY[, .(code, date, close)][order(code, -date)][, yyyymm:=100*year(date)+month(date)], by=c('code', 'yyyymm'))[order(code, date)]
  if ( !'rt' %in% names (IND_PERIOD))
  {
    IND_PERIOD[, rt:=(close/shift(close))-1, by='code']
  }
  
  IND_PERIOD[, updated := SYS.TIME()]
  # My.Kable(IND_PERIOD[order(code, date)])
  # My.Kable.TB(IND_PERIOD[grepl('IFRC', name)][order(date,code)], Nb=5)
  
  
  IND_PERIOD = CHECK_CLASS(try(TRAINEE_MERGE_COL_FROM_REF (pData = IND_PERIOD, 
                                                           List_Fields = c('name','cur','wgtg','prtr', 'version', 'category', 'size', 'coverage'))))
  My.Kable.TB(IND_PERIOD[order(date,code)])
  
  # 
  #     
  #     IND_DMY = IND_MONTH
  #     IND_DMY = merge(IND_DMY[, -c('name', 'provider', 'monitor')], ins_ref[, .(code, name=short_name, provider, monitor)], all.x=T, by='code')[order(name)]
  #     IND_DMY = IND_DMY[!is.na(close)]
  #     IND_DMY = merge(IND_DMY[, -c(',', 'start')], IND_SUMMARY[, .(code, n, start)], all.x=T, by='code')
  #     IND_DMY = IND_DMY[, -c('provider', 'monitor')]
  #     
  #     IND_DMY = merge(IND_DMY[, -c('country', 'iso2')], ins_ref[, .(code, country, iso2)], all.x=T, by='code')
  #     IND_DMY = IND_DMY %>% select(iso2, country, code, name, n, start, date, close, everything())
  #     IND_DMY = IND_DMY[, -c('n')]
  #     My.Kable(IND_DMY[order(date)])
  
  if (ToSave & (nchar(File_Name) > 0)){
    if (grepl('history.rds', File_Name, ignore.case = T)){
      CCPR_SAVERDS(IND_PERIOD[order(code, date)], File_Folder, paste0(gsub('history.rds', paste0(Period, '_history.rds'), File_Name)), ToSummary = T, SaveOneDrive = T)
    } else {
      CCPR_SAVERDS(IND_PERIOD[order(code, date)], File_Folder, paste0(gsub('.rds', paste0('_', Period, '_history.rds'), File_Name)), ToSummary = T, SaveOneDrive = T)
    }
  }
  EndTime = Sys.time()
  print(difftime(EndTime,StartTime))
  return(IND_PERIOD)
}

#===================================================================================================
TRAINEE_MERGE_COL_FROM_REF = function(pData = data.table(), 
                                      Folder_Fr =  '',       File_Fr = '' , 
                                      ToSave = F ,   Folder_To = '' ,       File_To = '' ,
                                      List_Fields  = c('name','cur','wgtg','prtr', 'category', 'size')) {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  
  if (nrow (pData) > 0 )
  {
    data_table = pData
  } else {
    data_table = CCPR_READRDS ( Folder_Fr,File_Fr, ToRestore = T, ToKable = T )
  }
  
  for (col in List_Fields) 
  {
    if (col %in% names(ins_ref)) 
    {
      data_table = merge(data_table[, -c('new')], ins_ref[, .(code, new = get(col))], all.x = TRUE, by = 'code')
      if (col %in% names(data_table)) 
      {
        data_table[is.na(get(col)) & !is.na(new), (col) := new]
        data_table$new = NULL
      } else {
        data_table[, (col) := new]
        data_table$new = NULL
      }
    }
  }
  
  My.Kable (data_table)
  if (ToSave) { CCPR_SAVERDS (data_table, Folder_To  ,  File_To, ToSummary = T   )}
  return(data_table)
  
}


# ==================================================================================================
IFRC_INDEXES_CONVERT_CURRENCIES_FROM_USD = function(IND_FOLDER   = UData, IND_FROMCUR = 'DOWNLOAD_IFRC_INDPORVND_HISTORY.rds',
                                                    IND_PREFIX_NAME = '', 
                                                    IND_FILENAME = 'DOWNLOAD_IFRC_INDPORVND_HISTORY.rds', CUR_FROM = 'VND', ISO2 = "VN") {
  # ------------------------------------------------------------------------------------------------
  
  # IND_FOLDER   = UData ; IND_FILENAME = 'DOWNLOAD_IFRC_INDPOR_HISTORY.rds'
  # IND_FOLDER   = UData ; IND_FILENAME = 'DOWNLOAD_IFRC_INDPRV_HISTORY.rds'
  
  # IND_FOLDER   = paste0(CCPRData, 'DASHBOARD/')
  # IND_FILENAME = 'DOWNLOAD_IFRC_INDETF_HISTORY.rds'
  
  # IND_HISTORY  = CCPR_READRDS(UData, IND_FILENAME, ToKable = T, ToRestore = T)
  # IND_FILENAME = 'ifrc_ccpr_ind_gics_history.rds'
  
  IND_CURS_LIST = list('GBP', 'EUR', 'JPY', 'SGD', 'VND', 'AUD', 'CAD', 'KRW', 'HKD', 'CNY')
  IND_CURS_TODO = setdiff(IND_CURS_LIST, CUR_FROM)
  
  IND_HISTORY   = CCPR_READRDS(IND_FOLDER, IND_FROMCUR, ToKable = T, ToRestore = T)
  
  IND_HISTORY = IND_HISTORY[substr(code, nchar(code)-2, nchar(code))=='USD']
  # IND_HISTORY  = CCPR_READRDS(paste0(CCPRData, 'DASHBOARD/'), IND_FILENAME, ToKable = T, ToRestore = T)
  IND_HISTORY   = unique(IND_HISTORY[order(code, date)], by=c('code', 'date'))
  # IND_HISTORY  = MERGE_DATASTD_BYCODE(IND_HISTORY)
  My.Kable(IND_HISTORY)
  # CUR_YAH      = DATACENTER_LOADDTRDS_UDATA('DOWNLOAD_YAH_CUR_HISTORY.rds')
  # My.Kable(CUR_YAH[code=='CURUSDVND'][order(date)][, .(code, date, close)])
  
  CUR_HISTORY  = CCPR_READRDS(UData, 'IFRC_CUR_4INDEX.rds', ToKable = T, ToRestore = T)
  
  
  My.Kable(CUR_HISTORY[code=='CURUSDGBP'][order(date)])
  My.Kable(CUR_HISTORY[code=='CURUSDEUR'][order(date)])
  My.Kable(CUR_HISTORY[code=='CURUSDVND'][order(date)])
  My.Kable(CUR_HISTORY[code=='CURUSDJPY'][order(date)])
  
  # CUR_FROM = 'USD'; ISO2 = "US"
  # CUR_FROM = 'VND'; ISO2 = "VN"
  
  FINAL_INDEXES = data.table()
  
  for (PRTR in list('PR', 'TR'))
  {
    for (pCUR in IND_CURS_TODO)
    {
      # PRTR = 'PR'; pCUR = 'GBP'
      # PRTR = 'PR'; pCUR = 'EUR'
      # PRTR = 'PR'; pCUR = 'JPY'
      # PRTR = 'PR'; pCUR = 'SGD'
      # PRTR = 'PR'; pCUR = 'VND'
      # pCUR = 'USD'
      # CUR_TO   = 'USD'
      CATln_Border(paste('PRTR = ', PRTR, '/ CUR_TO = ', pCUR))
      CUR_TO   = pCUR
      IND_CUR_MOTHER = IND_HISTORY[grepl(paste0(PRTR, CUR_FROM,'$'), code)]
      IND_CUR_MOTHER[, name_mother:=name]
      IND_CUR_MOTHER[, cur:=CUR_FROM]
      My.Kable.TB(unique(IND_CUR_MOTHER[order(code, -date)], by='code')[, .(code, name, date, close, cur, name_mother)])
      
      CUR_CONVERT = paste0('CUR', CUR_TO, CUR_FROM)
      CUR_CONVERT_INV = paste0('CUR', CUR_FROM,CUR_TO)
      CUR_TOMERGE = CUR_HISTORY[code==CUR_CONVERT][, .(code, date, close)]
      CUR_INVERSE = CUR_HISTORY[code==CUR_CONVERT_INV][, .(code, date, close)]
      
      CUR_TOMERGE_FINAL = merge(CUR_TOMERGE, CUR_INVERSE[, .(date, inverse=close)], all=T, by='date')
      My.Kable(CUR_TOMERGE_FINAL)
      CUR_TOMERGE_FINAL[, code:=CUR_CONVERT]
      CUR_TOMERGE_FINAL[is.na(close) & !is.na(inverse), ':='(close=1/inverse, r=1)]
      My.Kable(CUR_TOMERGE_FINAL)
      
      IND_CUR_MOTHER_DATES = unique(IND_CUR_MOTHER, by='date')[, .(date)]
      IND_CUR_MOTHER_DATES = merge(IND_CUR_MOTHER_DATES[, -c('cur_tofrom')], CUR_TOMERGE_FINAL[, .(date, cur_tofrom=close)], all.x=T, by='date')
      
      MinDate  = min(IND_CUR_MOTHER_DATES$date)
      MinValue = (CUR_TOMERGE_FINAL[!is.na(close)][1]$close)
      MaxDate  = max(CUR_TOMERGE_FINAL[date<=MinDate]$date)
      if (!is.infinite(MaxDate)) {
        MaxValue = CUR_TOMERGE_FINAL[date==MaxDate]$close
      } else {
        MaxValue = MinValue
      }
      CATln(paste(MinDate, MaxDate, MaxValue))
      IND_CUR_MOTHER_DATES[date==MinDate, close:=MaxValue]
      IND_CUR_MOTHER_DATES[date==MinDate, cur_tofrom    :=MaxValue]
      
      IND_CUR_MOTHER_DATES[, cur_tofrom:=na.locf(cur_tofrom)]
      IND_CUR_MOTHER_DATES[, rt_cur:=(cur_tofrom/shift(cur_tofrom))-1]
      My.Kable(IND_CUR_MOTHER_DATES)
      
      IND_CUR_MOTHER = IND_CUR_MOTHER[order(code, date)][, .(code, date, close, cur, cur_to=CUR_TO, cur_to_from=paste0(CUR_TO, CUR_FROM), name_mother)]
      IND_CUR_MOTHER[, rt:=(close/shift(close))-1, by='code']
      IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('rt_cur', 'cur_tofrom')], IND_CUR_MOTHER_DATES[, .(date, rt_cur, cur_tofrom)], all.x=T, by='date')
      IND_CUR_MOTHER = IND_CUR_MOTHER[order(code, date)]
      IND_CUR_MOTHER[!is.na(rt), rt_ratio := (1+rt)/(1+rt_cur), by='code']
      IND_CUR_MOTHER[is.na(rt), rt_ratio := 1]
      IND_CUR_MOTHER[, cum_rt_ratio := cumprod(rt_ratio), by='code']
      IND_CUR_MOTHER_START = unique(IND_CUR_MOTHER[order(code, date)], by='code')
      
      IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('close_curto')], IND_CUR_MOTHER_START[, .(code, close_curto=close)], all.x=T, by='code')
      IND_CUR_MOTHER[, close_curto:=close_curto*cum_rt_ratio]
      IND_CUR_MOTHER[, rt_curto:=(close_curto/shift(close_curto))-1, by='code']
      IND_CUR_MOTHER[, check:=(1+rt_curto)-rt_ratio]
      # IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')
      IND_CUR_MOTHER = MERGE_DATASTD_BYCODE(IND_CUR_MOTHER)[order(code, date)]
      # My.Kable(IND_CUR_MOTHER[order(code, date)][code==paste0('INDVNXASPR', CUR_FROM)][, .(provider, monitor, country, code, name, date, close, cur, rt)])
      
      
      
      IND_CUR_MOTHER_FINAL = IND_CUR_MOTHER
      IND_CUR_MOTHER_FINAL[, code_mother:=code]
      IND_CUR_MOTHER_FINAL[, close:=close_curto]
      IND_CUR_MOTHER_FINAL[, code:=gsub(CUR_FROM, CUR_TO, code_mother)]
      IND_CUR_MOTHER_FINAL[, cur:=CUR_TO]
      # IND_CUR_MOTHER_FINAL = MERGE_DATASTD_BYCODE(IND_CUR_MOTHER_FINAL)[order(code, date)]
      IND_CUR_MOTHER_FINAL[, rt:=(close/shift(close))-1, by='code']
      IND_CUR_MOTHER_FINAL[, change:=(close-shift(close)), by='code']
      IND_CUR_MOTHER_FINAL[, varpc:=100*rt, by='code']
      # str(IND_CUR_MOTHER_FINAL)
      
      IND_CUR_MOTHER_FINAL[, name:=gsub(paste0(CUR_FROM,')$'), paste0(CUR_TO,')'), name_mother )]
      IND_CUR_MOTHER_FINAL = IND_CUR_MOTHER_FINAL[, -c('rt_curto', 'rt_cur', 'cum_rt_ratio', 'cur_to_from', 'capiusd', 
                                                       'close_curto', 'check', 'cur_tofrom', 'cur_to', 'rt_ratio', 'capiusd')]
      # IND_CUR_MOTHER_FINAL = merge(IND_CUR_MOTHER_FINAL[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')
      # str(IND_CUR_MOTHER_FINAL)
      
      My.Kable.Min(IND_CUR_MOTHER_FINAL[order(code, date)][, .(code, name, date, close)])
      FINAL_INDEXES = rbind(FINAL_INDEXES, IND_CUR_MOTHER_FINAL, fill=T)
      GC_SILENT()
    }
  }
  
  FINAL_INDEXES = rbind(IND_HISTORY, FINAL_INDEXES, fill=T)
  FINAL_INDEXES = merge(FINAL_INDEXES[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')[, -c('sample', 'home')]
  FINAL_INDEXES = unique(FINAL_INDEXES[order(code, date)], by=c('code', 'date'))
  My.Kable(FINAL_INDEXES[, -c('continent', 'type')])
  My.Kable(unique(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd", "n", "base_value", 
                                     "base_date", "code_mother", "source")][order(code, -date)], by='code'), Nb=10)
  CATln_Border('REMOVE CLOSE == 0')
  FINAL_INDEXES = FINAL_INDEXES[!is.na(close)]
  FINAL_INDEXES[, ':='(codesource=code)]
  # FINAL_INDEXES[grepl('VND$', code), cur:='VND']
  FINAL_INDEXES[grepl('PRVND$|TRVND$', code), code_mother:=code]
  FINAL_INDEXES[, close_adj:=close]
  FINAL_INDEXES[, varpc:=100*rt]
  FINAL_INDEXES[, ':='(source='IFRC/BEQ')]
  FINAL_INDEXES[, ':='(continent='ASIA')]
  FINAL_INDEXES[, ':='(country='VIETNAM')]
  FINAL_INDEXES[, ':='(iso2='VN')]
  FINAL_INDEXES[, ':='(iso3='VNM')]
  FINAL_INDEXES[, ':='(type='IND')]
  FINAL_INDEXES[, ':='(provider='IFRC')]
  FINAL_INDEXES = UPDATE_UPDATED(FINAL_INDEXES)
  My.Kable.Min(unique(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd")][order(code, -date)], by='code'))
  My.Kable.Min(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd")][order(code, -date)])
  
  # name
  if (nchar(IND_PREFIX_NAME)>0)
  {
    # IND_PREFIX_NAME = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
    str(FINAL_INDEXES)
    FINAL_INDEXES[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
    FINAL_INDEXES[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
    FINAL_INDEXES[, cur:=substr(code, nchar(code)-2, nchar(code))]
    # My.Kable(FINAL_INDEXES[, .(code, name)][order(code, -date)][code=='IFRCINDETFBLKCHNEWPRUSD'])
    FINAL_INDEXES[wgtg=='VW', wgtg:='CW']
    
    FINAL_INDEXES[, new_name:=paste(IND_PREFIX_NAME, wgtg, prtr, paste0('(',cur,')'))]
    FINAL_INDEXES[!grepl('[(]', name), new_cur:=cur]
    My.Kable(FINAL_INDEXES[, .(code, name, new_name, prtr, wgtg, cur)])
    # FINAL_INDEXES[, name:=new_name]
    
    
    # FINAL_INDEXES[grepl('[(]', name), new_name:=name]
    # FINAL_INDEXES[!grepl('[(]', name), new_name:=paste(name, prtr, paste0('(',cur,')'))]
    # FINAL_INDEXES[grepl(' VW ', new_name), new_name:=gsub(' VW ', ' CW ', new_name)]
    # # FINAL_INDEXES[!grepl(' CW', new_name), new_name:=paste(new_name, ' CW')]
    # 
    # FINAL_INDEXES[grepl(' TR CW ', new_name), new_name:=gsub(' TR CW ', ' CW TR ', new_name)]
    # FINAL_INDEXES[grepl(' PR CW ', new_name), new_name:=gsub(' PR CW ', ' CW PR ', new_name)]
    # FINAL_INDEXES[grepl(' TR EW ', new_name), new_name:=gsub(' TR EW ', ' EW TR ', new_name)]
    # FINAL_INDEXES[grepl(' PR EW ', new_name), new_name:=gsub(' PR EW ', ' EW PR ', new_name)]
    # FINAL_INDEXES[grepl(' TR TR ', new_name), new_name:=gsub(' TR TR ', ' TR ', new_name)]
    # FINAL_INDEXES[grepl(' EW ', new_name), wgtg:='EW']
    # FINAL_INDEXES[grepl(' CW ', new_name), wgtg:='CW']
    # 
    # FINAL_INDEXES[grepl(' PR PR ', new_name), new_name:=gsub(' PR PR ', ' PR ', new_name)]
    # 
    # FINAL_INDEXES[!grepl(' EW| CW', new_name) & prtr=='PR', ':='(new_name=gsub(' PR ', ' CW PR ', new_name), wgtg='CW')]
    # FINAL_INDEXES[!grepl('(VND)', new_name), ':='(cur='VND')]
    # FINAL_INDEXES[grepl('NA)$', new_name), ':='(new_name=gsub('NA)', 'VND)', new_name))]
    # FINAL_INDEXES[grepl(')$', new_name), ':='(new_cur=substr(word(new_name,2,2,'[(]'),1,3))]
    
    # FINAL_INDEXES[cur !=new_cur, cur:=new_cur]
  } else {
    ONE_INDEX = unique(FINAL_INDEXES[!is.na(name)], by='code')
    str(FINAL_INDEXES)
    FINAL_INDEXES[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
    FINAL_INDEXES[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
    FINAL_INDEXES[, cur:=substr(code, nchar(code)-2, nchar(code))]
    # My.Kable(FINAL_INDEXES[, .(code, name)][order(code, -date)][code=='IFRCINDETFBLKCHNEWPRUSD'])
    FINAL_INDEXES[wgtg=='VW', wgtg:='CW']
    
    FINAL_INDEXES = merge(FINAL_INDEXES[, -c('name')], ONE_INDEX[, .(code, name)], all.x=T, by='code')
    FINAL_INDEXES[grepl(' EW$', name), ':='(name=paste(name, prtr, paste0('(',cur,')')))]
    FINAL_INDEXES[grepl(' VW$', name), ':='(name=paste(name, prtr, paste0('(',cur,')')))]
    FINAL_INDEXES[grepl(' VW ', name), name:=gsub(' VW ', ' CW ', name)]
    My.Kable(FINAL_INDEXES[, .(iso2, iso3, country, continent, code, name, prtr, wgtg, cur, date, close, rt)])
    
  }
  
  try(My.Kable(FINAL_INDEXES[, .(code, date, name, cur,prtr, wgtg)][order(date, code)]))
  
  if ('new_name' %in% names(FINAL_INDEXES)) { FINAL_INDEXES[, name:=new_name] }
  FINAL_INDEXES$new_name = NULL
  FINAL_INDEXES$new_cur = NULL
  
  # FINAL_INDEXES[grepl(' TR CW ', name), name:=gsub(' TR CW ', ' CW TR ', name)]
  # 
  # FINAL_INDEXES[grepl(' PR CW ', name), name:=gsub(' PR CW ', ' CW PR ', name)]
  # FINAL_INDEXES[grepl(' TR EW ', name), name:=gsub(' TR EW ', ' EW TR ', name)]
  # FINAL_INDEXES[grepl(' PR EW ', name), name:=gsub(' PR EW ', ' EW PR ', name)]
  # FINAL_INDEXES[grepl(' TR TR ', name), name:=gsub(' TR TR ', ' TR ', name)]
  # FINAL_INDEXES[grepl(' EW ', new_name), wgtg:='EW']
  # FINAL_INDEXES[grepl(' CW ', new_name), wgtg:='CW']
  # 
  # FINAL_INDEXES[grepl(' PR PR ', new_name), new_name:=gsub(' PR PR ', ' PR ', new_name)]
  # 
  # FINAL_INDEXES[!grepl(' EW| CW', new_name) & prtr=='PR', ':='(new_name=gsub(' PR ', ' CW PR ', new_name), wgtg='CW')]
  
  My.Kable(FINAL_INDEXES[, .(code, name, cur, prtr, wgtg, date, close)][order(date, code)])
  
  Data_Old = CHECK_CLASS(try(CCPR_READRDS(UData, IND_FILENAME, ToKable = T, ToRestore = T)))
  if (nrow(Data_Old)>0)
  {
    Data_Old = unique(rbind(Data_Old[!code %in% FINAL_INDEXES$code], FINAL_INDEXES, fill=T), by=c('code', 'date'))[!is.na(code) & !is.na(date)]
  } else {
    Data_Old = unique(FINAL_INDEXES, by=c('code', 'date'))[!is.na(code) & !is.na(date)]
  }
  
  My.Kable(Data_Old[, .(code, name, cur, prtr, wgtg, date, close)][order(date, code)])
  
  # setkey(Data_Old, )
  try(CCPR_SAVERDS(Data_Old, IND_FOLDER, IND_FILENAME, ToSummary = T, SaveOneDrive = T))
}

# ==================================================================================================
TRAINEE_CONVERT_INDEXES_CURRENCIES_FROM_USD = function(){
  # ------------------------------------------------------------------------------------------------
  LIST_ISO2 = list ('AUS' ,	'BEL' ,	'CHN' ,	'DEU', 	'FRA' ,	'HKG' ,	'IDN' ,	'IRL' ,	'ITA' ,	'JPN' ,	'MYS' ,	'NLD' ,	'NOR' ,	'PRT' ,	'SGP' ,	'THA', 	'TWN', 'USA')
  
  for (i in 1:length(LIST_ISO2)){
    # i = 3
    PREFIX = LIST_ISO2[[i]]
    # PREFIX = 'USA'
    FOLDER = paste0('S:/WCEO_INDEXES/', PREFIX,'/')
    HISTORY   = paste0('ifrc_ccpr_indwceo', PREFIX, '_history.rds')
    USD    = paste0('ifrc_ccpr_indwceo', PREFIX, '_USD_history.rds')
    ALL    = paste0('ifrc_ccpr_indwceo', PREFIX, '_ALL_history.rds')
    # PRICES = paste0('download_',PREFIX,'_yah_prices_final_day.rds')
    
    history = CCPR_READRDS(FOLDER, HISTORY, ToKable = T, ToRestore = T)
    My.Kable(history)
    
    usd_history = CCPR_READRDS(FOLDER, USD, ToKable = T, ToRestore = T)
    
    # price = CCPR_READRDS(FOLDER, PRICES, ToKable = T, ToRestore = T)
    # My.Kable(price)
    
    if (max(usd_history$date) < max(history$date)){
      CCPR_SAVERDS(history, FOLDER, USD, ToSummary = T)
      usd_history = CCPR_READRDS(FOLDER, USD, ToKable = T, ToRestore = T)
    }
    all_history = CCPR_READRDS(FOLDER, ALL, ToKable = T, ToRestore = T)
    # My.Kable.All(unique(all_history[order(code, date)], by=c('code'))[, .(code, date, name)])
    
    if (max(usd_history$date) > max(all_history$date)){
      try(IFRC_INDEXES_CONVERT_CURRENCIES_FROM_USD(IND_FOLDER   = FOLDER, CUR_FROM = 'USD', ISO2 = "",
                                                   IND_FROMCUR  = USD,
                                                   IND_FILENAME = ALL))
      
      all_history = CCPR_READRDS(FOLDER, ALL, ToKable = T, ToRestore = T)
      My.Kable.All(unique(all_history[order(code, date)], by=c('code'))[, .(code, date, name)])
      
    } else {
      CATln_Border('ALL DATA UPDATED')
    }
  }
  
  data = list()
  for (ISO2 in LIST_ISO2) 
  {
    # ISO2 = 'AUS'
    FOLDER = 'S:/WCEO_INDEXES/'
    FILE = paste0 ('ifrc_ccpr_indwceo',tolower (ISO2),'_all_history.rds' )
    # if ( SUMMARY_DATE( paste0(FOLDER, ISO2, '/', FILE) ) > ( Sys.Date () - 7 ) )
    # {
    MY_DATA = CCPR_READRDS ( paste0(FOLDER, ISO2, '/'), FILE, ToRestore = T, ToKable =T )
    # }
    data [[ISO2]]  = MY_DATA
    
  }
  DATA_ALL = rbindlist (data, fill = T)
  CCPR_SAVERDS ( DATA_ALL, 'S:/CCPR/DATA/' , 'IFRC_CCPR_INDWCEOIN_ALL_HISTORY.RDS', ToSummary = T)
  
  data = list()
  for (ISO2 in LIST_ISO2) 
  {
    # ISO2 = 'AUS'
    FOLDER = 'S:/WCEO_INDEXES/'
    FILE = paste0 ('ifrc_ccpr_indwceo',tolower (ISO2),'_history.rds' )
    # if ( SUMMARY_DATE( paste0(FOLDER, ISO2, '/', FILE) ) > ( Sys.Date () - 7 ) )
    # {
    MY_DATA = CCPR_READRDS ( paste0(FOLDER, ISO2, '/'), FILE, ToRestore = T, ToKable =T )
    # }
    data [[ISO2]]  = MY_DATA
    
  }
  
  DATA_ALL = rbindlist (data, fill = T)
  CCPR_SAVERDS ( DATA_ALL, 'S:/CCPR/DATA/' , 'IFRC_CCPR_INDWCEOIN_HISTORY.RDS', ToSummary = T)
}

# ==================================================================================================
CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD = function(Sub_Folder = 'S/STKVN/PRICES/DAY/', File_Ext    = '.rds', Nb_Days     = 2)  {
  # ------------------------------------------------------------------------------------------------
  CATln_Border(paste('CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD - BEGIN', '/', SYS.TIME()))
  File_Folder = paste0(ODDrive, Sub_Folder)
  File_List   = as.data.table(list.files(File_Folder, File_Ext))
  
  File_Selection = File_List[grepl("\\d{4}\\d{2}\\d{2}", V1)]
  My.Kable(File_Selection)
  if (nrow(File_Selection)>0)
  {
    for (k in 1:nrow(File_Selection))
    {
      # k = 1
      File_Name = paste0(File_Folder, File_Selection[k]$V1)
      if (file.exists(File_Name))
      {
        File_Date = file.info(File_Name)$mtime
        CATln_Border(paste(k, '/', nrow(File_Selection),' = ', File_Name))
        Diff_Date = as.numeric(difftime(Sys.time(), File_Date, units='day'))
        if (Diff_Date > Nb_Days)
        {
          x = file.remove(File_Name)
          CATln('deleted.')
          CATln('')
        }
      }
    }
  }
  CATln_Border(paste('CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD - END', '/', SYS.TIME()))
}
# ==================================================================================================
RUN_RD_TEAM = function ()  {
  # ------------------------------------------------------------------------------------------------
  try(  TRAINEE_EXPORT_CONNECTIONS("S:/SHINY/MONITOR/LIST_URL.xlsx") )
  
  try( CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD(Sub_Folder = 'S/STKVN/PRICES/DAY/', File_Ext    = '.rds', Nb_Days     = 2) )
  try(CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD(Sub_Folder = 'S/STKVN/PRICES/DAY/', File_Ext    = '.txt', Nb_Days     = 2))
  try(CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD(Sub_Folder = 'U/EFRC/DATA/',        File_Ext    = '.txt', Nb_Days     = 2))
  try(CLEAN_FILES_ONEDRIVE_WITH_YYYYMMDD(Sub_Folder = 'U/EFRC/DATA/',        File_Ext    = '.rds', Nb_Days     = 2))
}

# ==================================================================================================
CHECK_WEBSITE = function(pURL) {
  # ------------------------------------------------------------------------------------------------
  response = NULL
  active   = 0
  message  = NA
  update   = NA
  tryCatch({
    response = GET(pURL, config(ssl_verifypeer = FALSE))
  }, error   = function(err) {
    active   = 0
    message  = conditionMessage(err)
    update   = format(Sys.time(), "%Y-%m-%d %H:%M:%S")
  })
  
  if (!is.null(response)) {
    status_code = status_code(response)
    content     = content(response)
    if (status_code == 200) {
      active  = 1
      message = "SUCCESS"
      update  = format(Sys.time(), "%Y-%m-%d %H:%M:%S")
    } else {
      active  = 0
      message = content$message
      update  = format(Sys.time(), "%Y-%m-%d %H:%M:%S")
    }
  }
  return (list(pURL = pURL, active = active, message = message, update = update))
}

# ==================================================================================================
TRAINEE_EXPORT_CONNECTIONS = function(file_path) {
  # ------------------------------------------------------------------------------------------------
  data     = read_excel(file_path)
  list_url = data$URL
  results  = data.frame(URL = character(), active = integer(), Message = character(), Update = character(), Sound = character(), stringsAsFactors = FALSE)
  
  for (i in seq_along(list_url)) {
    url           = list_url[i]
    check_website = CHECK_WEBSITE(url)
    if (length(check_website) == 4) {
      active  = check_website$active
      message = check_website$message
      update  = check_website$update
      sound   = ifelse(i %% 2 == 0, "phonering.mp3", "alert.mp3")
      new_row = data.frame(URL = url, active = active, Message = message, Update = update, Sound = sound, stringsAsFactors = FALSE)
      results = rbind(results, new_row)
    }
  }
  
  con = dbConnect(RMySQL::MySQL(), 
                  dbname = "intranet_dev",
                  host   = "192.168.1.105", 
                  port   = 3306, 
                  user   = "intranet_admin", 
                  password = "admin@123456")
  
  dbWriteTable(con, "report_web", results, row.names = FALSE, overwrite = TRUE)
  
  dbDisconnect(con)
  My.Kable (results)
}


# ==================================================================================================
DASHBOARD_LIVE_REPAIR = function(Action = 'REPAIR_MARKET_FOREX', ToForce = F)  {
  # ------------------------------------------------------------------------------------------------
  switch(Action,
         
         'REPAIR_CCPR_DASHBOARD_MARKET' = {
           Action = 'REPAIR_CCPR_DASHBOARD_MARKET'
           CATln_Border(paste(Action,'-', SYS.TIME()))
           if (ToForce || SUMMARY_DATE(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 	'ccpi_dashboard_markets.rds')) < SYSDATETIME(1))
           {
             try (MAINTENANCE_DASHBOARD (Action = 'DASHBOARD_CCPI_MARKET_CHARTS',  Minutes= 0))
           }
         },
         'REPAIR_MARKET_FOREX' = {
           CATln_Border(paste(Action,'-', SYS.TIME()))
           if (ToForce || SUMMARY_DATE(paste0('S:/CCPR/DATA/DAY/FOREX/', 	'download_yah_forex_intraday_today.rds')) < SYSDATETIME(1))
           {
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CURRENCIES',ToDownload = T, ToSave = T, ToUpload = T, pHost = 'dashboard_live') )
           }
         },
         
         'REPAIR_CCPR_DASHBOARD_WORLD_EQUITIES' = {
           Action = 'REPAIR_CCPR_DASHBOARD_WORLD_EQUITIES'
           CATln_Border(paste(Action,'-', SYS.TIME()))
           if (ToForce || SUMMARY_DATE(paste0('S:/CCPR/DATA/', 	'	ccpr_worldindexes_history.rds')) < SYSDATETIME(1))
           {
             try( TRAINEE_DASHBOARD_LIVE_DIV  (pOptions = 'WORLD_EQUITIES_INDEX', Minutes = 0) )
           }
         },
         'REPAIR_CCPR_DASHBOARD_WTI' = {
           Action = 'REPAIR_CCPR_DASHBOARD_WTI'
           CATln_Border(paste(Action,'-', SYS.TIME()))
           if (ToForce || SUMMARY_DATE(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 	'ifrc_ccpr_investment_history.rds')) < SYSDATETIME(1))
           {
             try( TRAINEE_DASHBOARD_LIVE_DIV  (pOptions = 'WHERE_TO_INVEST', Minutes = 0) )
           }
         }
         
  )
  
  CATln_Border(paste('DASHBOARD_LIVE_REPAIR','-', SYS.TIME()))
}

# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_LIST_CODES = function ( ByRDS = T, BySummary = F , SaveFolder = '')  {
  # ------------------------------------------------------------------------------------------------
  
  data = setDT (read_xlsx ( paste0('D:/OneDrive/', 'TRAINEE/','CHECK_UPDATE_DASHBOARD_LIVE 1.xlsx')) )
  
  my_data = unique (data [ grepl('history',local_file)], by = 'local_file' )
  
  LIST = list()
  for (i in 1:length (my_data))
  {
    # i = 1
    FOLDER = my_data $ local_location [i]
    FILE   = my_data$local_file [i]
    # if ( ByRDS)
    # {
    LIST [[i]] = unique ( CCPR_READRDS (FOLDER, FILE, ToRestore = T), by = 'name' )
    # }
    
    # BySummary = T
    # if (BySummary) 
    # {
    #   LIST [[i]] = unique ( fread (paste0(FOLDER, gsub('.rds','',FILE), '_summary.txt'), sep = '\t'), by = 'name' )
    # }
    #
    
  }
  # str ( LIST [[i]])
  MY_LIST = rbindlist (LIST , fill = T)
  DATA_FINAL = unique (MY_LIST [,.(code, name, code_mother)], by = 'code' )
  if (nchar (SaveFolder) > 0)
  {
    try( CCPR_SAVERDS (DATA_FINAL, SaveFolder, 'ccpi_dashboard_ind_mother.rds') )
    try (write.xlsx(DATA_FINAL, paste0(SaveFolder, 'ccpi_dashboard_ind_mother.xlsx') ) )
    CATln ( paste ( 'SAVED:   ', paste0(SaveFolder, 'ccpi_dashboard_ind_mother.xlsx')))
  }
  My.Kable.TB(DATA_FINAL)
}

# ==================================================================================================
REPAIR_CALENDAR_VN = function()  {
  # ------------------------------------------------------------------------------------------------
  # REPAIR_CALENDAR_VN()
  x       = CCPR_READRDS(UData, 'idx_calendar.vn.rds', ToKable = T)
  NROW    = nrow(x)
  x_error = x[date=='2024-02-09']
  if (nrow(x_error)>0)
  {
    x     = x[!date %in% x_error$date]
    NROW1 = nrow(x)
    str(x)
    x[, prv_date:=shift(date, type='lag')]
    x[, nxt_date:=shift(date, type='lead')]
    My.Kable(x[date<Sys.Date()])
  }
  x_error = x[date=='2022-04-11']
  if (nrow(x_error)>0)
  {
    x     = x[!date %in% x_error$date]
    NROW1 = nrow(x)
    str(x)
    x[, prv_date:=shift(date, type='lag')]
    x[, nxt_date:=shift(date, type='lead')]
    My.Kable(x[date<Sys.Date()])
  }
  NB_CORRECT = NROW-NROW1
  if (NB_CORRECT>0)
  {
    CATln_Border('CORRECTION')
    saveRDS(x, paste0(UData, 'idx_calendar.vn.rds'))
    saveRDS(x, paste0('S:/R/', 'idx_calendar.vn.rds'))
  } else {
    CATln_Border('NO CORRECTION')
  }
}

# ==============================================================================
DOWNLOAD_STB_STKVN_PRICESDAY_BY_CODE = function(pCode = 'VND')
{
  # ----------------------------------------------------------------------------
  pURL = paste0('http://en.stockbiz.vn/Stocks/', pCode, '/HistoricalQuotes.aspx')
  CATln_Border(pURL)
  content    = try(rvest::read_html(pURL))
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    xTable     = as.data.table(tables[[23]])
    xData      = xTable[, 1:9]
    xHeader    = gsub(' ','', tolower(as.list(xData[1,])))
    xHeader[1]
    colnames(xData)     = xHeader
    xData      = xData[2:(nrow(xData)-1), ]
    # My.Kable(xData)
    Final_Data = xData[, .(codesource=pCode, source='STB', code=paste0('STKVN', pCode),
                           date  = as.Date(date, '%m/%d/%Y'), 
                           open  = 1000*as.numeric(gsub(',','',open)),
                           high  = 1000*as.numeric(gsub(',','',high)),
                           low   = 1000*as.numeric(gsub(',','',low)),
                           close = 1000*as.numeric(gsub(',','',close)),
                           average = 1000*as.numeric(gsub(',','',average)),
                           close_adj = 1000*as.numeric(gsub(',','',adjustedclose )),
                           change  = 1000*as.numeric(gsub(',','',word(change,1,1,'/') )),
                           volume = as.numeric(gsub(',','',volume ))
    )]
    Final_Data = Final_Data[order(date)]
    Final_Data[, reference:=(close-change)]
    Final_Data[, rt_calculated:=(change)/reference]
    # Final_Data[, change:=]
    My.Kable.TB(Final_Data)
  }
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE = function (pOption = 'OVERVIEW' , ToSave = T,  ToUpload = T,
                                               pHost = 'dashboard_live', username = '', password = '', host = '', dbname = "ccpi_dashboard_login",
                                               Minutes = 5)  {
  # pOption = 'CHART'
  ToPrint  =T
  DBL_RELOAD_INSREF()
  LIST_INDEX_NAME = c ('LOGISTICS', 'BROKERAGE', 'PETROLIMEX','REALESTATE', 
                       'RETAIL', 'BANK', 'HEALTHCARE', 'ENERGY', 'FINANCE', 'AI'  )
  # INDEX = 'FINANCE'
  # pFactor = 'fin'
  switch (pOption, 
          'OVERVIEW' =  {
            
            if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE>',pOption), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
            {
              for (INDEX in LIST_INDEX_NAME) {
                
                switch ( INDEX, 
                         'LOGISTICS'       = { PREFIX = 'log' } ,
                         'BROKERAGE'       = { PREFIX = 'brk' } ,
                         'PETROLIMEX'      = { PREFIX = 'pet' } ,
                         'REALESTATE'      = { PREFIX = 'rst' } ,
                         'RETAIL'          = { PREFIX = 'rtl' } ,
                         'BANK'            = { PREFIX = 'bnk' } ,
                         'HEALTHCARE'      = { PREFIX = 'hlc' } ,
                         'ENERGY'          = { PREFIX = 'eny' } ,
                         'FINANCE'         = { PREFIX = 'fin' } ,
                         'AI'              = { PREFIX = 'ari' }  )
                
                
                
                Fr_File_Path = paste0('S:/STKVN/INDEX_2024/', 'beq_ind', PREFIX, 'als_history.rds')
                To_File_Path = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_ind', PREFIX, '.rds')
                
                # if (TRAINEE_SUMMARY_DATE_RDS(Fr_File_Path) > TRAINEE_SUMMARY_DATE_RDS(To_File_Path)) {
                
                # OVERVIEW
                OVERVIEW = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/INDEX_2024/', 
                                                                          Fr_File = paste0('beq_ind', PREFIX, 'als_history.rds'),
                                                                          To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_ind', PREFIX, '.rds'), 
                                                                          DateLimit = Sys.Date()  ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                                          ToSave = T, ToUpload = F , pHost = pHost) )
                print(OVERVIEW)
                
                
                # } else {
                #   message("No update performed due to date check.")
                # }
                
              }
              
              if (ToUpload)
              {
                if (nchar (pHost) == 0)
                {
                  # MY_CONNECTION = try(dbConnect(MySQL(), user = "dashboard_user_login", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard_login"))
                  MY_CONNECTION = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = dbname))
                  
                } else {
                  MY_CONNECTION = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = pHost))
                }
                
                for (INDEX in LIST_INDEX_NAME) 
                {
                  switch ( INDEX, 
                           'LOGISTICS'       = { PREFIX = 'log' } ,
                           'BROKERAGE'       = { PREFIX = 'brk' } ,
                           'PETROLIMEX'      = { PREFIX = 'pet' } ,
                           'REALESTATE'      = { PREFIX = 'rst' } ,
                           'RETAIL'          = { PREFIX = 'rtl' } ,
                           'BANK'            = { PREFIX = 'bnk' } ,
                           'HEALTHCARE'      = { PREFIX = 'hlc' } ,
                           'ENERGY'          = { PREFIX = 'eny' } ,
                           'FINANCE'         = { PREFIX = 'fin' } ,
                           'AI'              = { PREFIX = 'ari' }  )
                  
                  RDS_folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/'
                  RDS_file   = paste0 ('ccpi_dashboard_ind', PREFIX, '.rds')
                  SQL_table  = paste0 ('ccpi_dashboard_ind', PREFIX )
                  
                  if (file.exists( paste0 (RDS_folder, RDS_file)))
                  {
                    start = Sys.time()
                    l.data = CHECK_CLASS( try ( CCPR_READRDS ( RDS_folder, RDS_file, ToRestore = T, ToKable = T)))
                    
                    if ( nrow (l.data) > 0)
                    {
                      stm1 = paste0("drop table if exists ", SQL_table)
                      stm3 = paste0("insert into ", SQL_table)
                      if (ToPrint) {print(stm1, quote = F)}; dbGetQuery(MY_CONNECTION, statement = stm1)
                      if (ToPrint) {print(stm3, quote = F)};dbWriteTable(MY_CONNECTION, SQL_table, l.data, field.types = NULL, row.names = F, append = TRUE)
                    }
                    end = Sys.time()
                    CATln_Border ( paste ( 'UPLOAD TABLE DURATION = ' , difftime (end, start)))
                  }
                }
                
                dbDisconnect(MY_CONNECTION)
              }
              TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE>',pOption), pAction="SAVE", NbSeconds=0, ToPrint=F)
            }  else { CATln_Border(paste(paste0('TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE>',pOption), 'SKIP')) } 
            
            
          } ,
          'CHART'    =  {
            if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE>',pOption), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
            {
              if (ToUpload)
              {
                if (nchar (pHost) == 0)
                {
                  # MY_CONNECTION = try(dbConnect(MySQL(), user = "dashboard_user_login", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard_login"))
                  MY_CONNECTION = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = dbname))
                  
                } else {
                  MY_CONNECTION = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = pHost))
                }
                
                for (INDEX in LIST_INDEX_NAME) 
                {
                  switch ( INDEX, 
                           'LOGISTICS'       = { PREFIX = 'log' } ,
                           'BROKERAGE'       = { PREFIX = 'brk' } ,
                           'PETROLIMEX'      = { PREFIX = 'pet' } ,
                           'REALESTATE'      = { PREFIX = 'rst' } ,
                           'RETAIL'          = { PREFIX = 'rtl' } ,
                           'BANK'            = { PREFIX = 'bnk' } ,
                           'HEALTHCARE'      = { PREFIX = 'hlc' } ,
                           'ENERGY'          = { PREFIX = 'eny' } ,
                           'FINANCE'         = { PREFIX = 'fin' } ,
                           'AI'              = { PREFIX = 'ari' }  )
                  
                  RDS_folder = 'S:/STKVN/INDEX_2024/'
                  RDS_file   = paste0('beq_ind',PREFIX,'als_history.rds')
                  SQL_table  = paste0('ccpi_dashboard_ind',PREFIX,'_history')
                  FILE_LOCAL = paste0 (RDS_folder, RDS_file)
                  FILE_HOST  = paste0 ('S:/CCPR/DATA/DASHBOARD_LIVE/HOST_TO_LOCAL/', paste0 (SQL_table, '.rds'))
                  if (file.exists( paste0 (RDS_folder, RDS_file)))
                  {
                    if (TRAINEE_SUMMARY_DATE_RDS(FILE_LOCAL ) > TRAINEE_SUMMARY_DATE_RDS(FILE_HOST))
                    {
                      l.data = CHECK_CLASS( try ( CCPR_READRDS ( RDS_folder, RDS_file, ToRestore = T, ToKable = T)))
                      
                      if ( nrow (l.data) > 0)
                      {
                        stm1 = paste0("drop table if exists ", SQL_table)
                        stm3 = paste0("insert into ", SQL_table)
                        if (ToPrint) {print(stm1, quote = F)}; dbGetQuery(MY_CONNECTION, statement = stm1)
                        if (ToPrint) {print(stm3, quote = F)};dbWriteTable(MY_CONNECTION, SQL_table, l.data, field.types = NULL, row.names = F, append = TRUE)
                      }
                      
                      CATln_Border ( paste ( 'UPLOAD TABLE  = ' , SQL_table))
                    } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' , SQL_table))}
                  }
                }
                
                
                dbDisconnect(MY_CONNECTION)
              }
              TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE>',pOption), pAction="SAVE", NbSeconds=0, ToPrint=F)
            } else { CATln_Border(paste(paste0('TRAINEE_BEQ_INDEXES_DASHBOARD_LIVE>',pOption), 'SKIP'))  }
          }
          
  )
  
}

# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_COMPOSITION_2ND_OLD = function(pOption="ICB", ToSave=F, pHost="")  {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  compo_files = list.files('S:/STKVN/INDEX_2024/','beq_.*_compo')
  compo_all_cw = list()
  for (ifile in 1:length(compo_files)) {
    xData = CCPR_READRDS('S:/STKVN/INDEX_2024/',compo_files[ifile])
    
    # STEP 1: READ FILE PRICES HISTORY
    Data_All = xData
    
    # cleanse raw data
    x = unique(Data_All, by = c('code', 'date'))
    
    
    # STEP 2: RE-CALCULATE DATA
    # Ind_History = x  [date <= Compo_Date]  
    # my_date = max (Ind_History$date)
    Ind_History = x[order(code, date)] 
    Ind_History[, ':='(change=close_unadj-shift(close_unadj), varpc=100*(close_unadj/shift(close_unadj)-1)), by='code']
    Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
    Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
    Ind_Month[, rtm:=(close_unadj/shift(close_unadj))-1, by='code']
    
    Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
    Ind_Year[, rty:=(close_unadj/shift(close_unadj))-1, by='code']
    
    Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
    Ind_Quarter[, rtq:=(close_unadj/shift(close_unadj))-1, by='code']
    
    Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code'))[, .(code, name, date, last=close_unadj, change, varpc)]
    Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
    Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
    Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
    My.Kable(Ind_Overview)
    
    
    Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
    My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
    Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
    
    Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
    Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
    My.Kable(Res_Year)
    
    Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
    Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
    My.Kable(Res_Quarter)
    # End.time = Sys.time()
    
    Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
    Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
    Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
    Ind_All 
    
    # STEP 3: ADD missing COLUMNS: market, sector, industry, size, ticker
    switch ( pOption, 
             'ICB'  = { icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
             # CCPR_SAVERDS(icb, 'S:/CCPR/DATA/', 'STKVN_ICB_ALL.rds')
             }  ,
             'GICS' = { gics = setDT (read_xlsx('S:/CCPR/DATA/DASHBOARD/From_BloombergVN_GICS_en.xlsx'))
             gics = TRAINEE_CLEAN_COLNAMES(gics)
             gics [san == 'UPCOM', market := 'UPC']
             gics [san == 'HOSE',  market := 'HSX']
             gics [san == 'HNX',   market := 'HNX']
             # colnames(gics)
             # gics [ ,. (code1 = code___5, name1 = gics_1 )]
             })
    Data_All [, capivnd:= shares*close]
    y = merge(Data_All, icb[,.(code, sector = toupper( icb1_name),  industry = toupper( icb2_name))], all.x= T, by = 'code')
    Ind_All  = merge( Ind_All, y [,.(code, market, date,     sector   , industry)], all.x = T, by = c('code' , 'date') )
    Ind_All$name = NULL
    
    xData = xData[date==max(date)]
    compo_all_cw[[ifile]] = merge (xData[,-c("market")],Ind_All, all.x = T, by = c('code', 'date')  ) 
    
  }
  compo_all_cw = rbindlist(compo_all_cw)
  # compo_all_cw = merge(compo_all_cw[,-c("code_mother")],
  #                   ins_ref[type=="IND",.(code_mother=code, index_name=gsub(" PR| CW| \\(VND\\)","",name))],
  #                   by="index_name",all.x=T)
  compo_all_cw[,code_mother:=gsub("PRVND","CWPRVND",index_code)]
  
  compo_all_cw[, capibnvnd:=shares*close_unadj/1000000000,by="code_mother"]
  compo_all_cw[, sum_capi:=sum(capibnvnd, na.rm=T),by="code_mother"]
  compo_all_cw[, nb:=.N,by="code_mother"]
  compo_all_cw[, wgt_pc:=100*capibnvnd/sum_capi,by="code_mother"]
  compo_all_cw[, ticker:=gsub('STKVN','', code)]
  
  compo_all_ew = copy(compo_all_cw)
  compo_all_ew[,":="(code_mother=gsub("CWPRVND","EWPRVND",code_mother), wgt_pc=100/.N),by="code_mother"]
  
  COMPO_4INDEX_FINAL = rbind(compo_all_cw, compo_all_ew)
  
  COMPO_4INDEX_FINAL = COMPO_4INDEX_FINAL %>% dplyr::select('code_mother', 'nb', 'ticker', 'code', 'name', 'date', 'shares', 
                                                            'close_unadj', 'capibnvnd', 'wgt_pc', everything())
  COMPO_4INDEX_FINAL$IFRC_rt=NULL
  
  
  # MaxDate = max(my_short_list$date)
  STKVN_CLEANED = copy(COMPO_4INDEX_FINAL[!is.na(capibnvnd) & !is.na(code_mother)])
  STKVN_CLEANED[, sum_capi:=sum(capibnvnd), by=c('code_mother','date')]
  STKVN_CLEANED[, cum_capi:=cumsum(capibnvnd), by=c('code_mother','date')]
  STKVN_CLEANED[, pc_capi:=100*cum_capi/sum_capi, by=c('code_mother','date')]
  STKVN_CLEANED[pc_capi<=85, size:='LARGE']
  STKVN_CLEANED[pc_capi>85 & pc_capi<=95, size:='MID']
  STKVN_CLEANED[pc_capi>95, size:='SMALL']
  STKVN_CLEANED$pc_capi = NULL
  STKVN_CLEANED$cum_capi = NULL
  STKVN_CLEANED$sum_capi = NULL
  My.Kable(STKVN_CLEANED)
  STKVN_CLEANED[, updated:= substr (as.character(Sys.time()),1,19)]
  STKVN_CLEANED[, short_name:=trimws(toupper(name))]
  STKVN_CLEANED = STKVN_CLEANED [order (-capibnvnd)]
  
  # COMPO_4INDEX_FINAL = merge (COMPO_4INDEX_FINAL,STKVN_CLEANED , all.x = T, by = 'code' )
  
  # # str(STKVN_CLEANED)
  if (ToSave ) {
    CCPR_SAVERDS(STKVN_CLEANED,'S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_indvn_compo.rds' , ToSummary=T, SaveOneDrive = T) 
  }
  # STEP 4: UPLOAD DATA
  if( nchar(pHost)>0 ) {
    
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= gsub ('.rds','', tolower('ccpi_dashboard_indvn_compo.rds') ),
                                     l.filepath= tolower(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/',  'ccpi_dashboard_indvn_compo.rds') ),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
}

# ==================================================================================================
TRAINEE_CREATE_BATCH_BY_PC = function(MyPC='IFRC-LINUX', output='')  {
  # ------------------------------------------------------------------------------------------------
  # pMyPC = toupper(IFRC_CCPR_GET_MYPC())
  # pMyPC = 'BEQ-RD4'
  # ODDrive = 'D:/Onedrive/'
  File_OneDrive_XLS = paste0(ODDrive, 'BeQ/CCPR/DATA/MONITOR/', 'MANAGEMENT_RD_TEAM.xlsx')
  XLS_DATA          = CLEAN_COLNAMES(setDT(openxlsx::read.xlsx(File_OneDrive_XLS, sheet='BATCH_BY_PC', startRow = 4)))
  str(XLS_DATA)
  mypc = tolower ( gsub('-','_', (MyPC)) )
  if (mypc %in% names(XLS_DATA))
  {
    My_Columns  = union(c('batch_to_run', 'location'), mypc)
    My_Selectop = XLS_DATA[, ..My_Columns][!is.na(batch_to_run)]
    My_Selectop = na.omit(My_Selectop)
    My_Location = unique(My_Selectop$location)
    data    = list ()
    my_list = list ()
    for ( i in My_Location) 
    {
      # i = "R:/R/BATCH/"
      # i = "T:/R/BATCH/EFRC/" 
      data    = list ()
      intro      = paste ( substr(i,1,2), '\n', paste ('CD', gsub ('/', '\\\\',i)) , '\n TIMEOUT 3 \n')
      list_batch = My_Selectop [ location == i]
      for (k in 1: nrow (list_batch)) 
      {
        data [[k]] = paste ('start' , list_batch$batch_to_run [[k]] , '\n TIMEOUT 1200 \n')
      }
      
      run_batch     = paste (unlist(data), collapse='' )
      my_list [[i]] = paste (intro,run_batch )
    }
    
    batch_by_pc = paste (unlist(my_list),collapse='' )
    batch_by_pc = paste (batch_by_pc, '\n exit \n quit')
    # unlist(batch_by_pc)
    writeLines   (batch_by_pc, paste0('S:/R/BATCH/', paste0 (toupper(mypc),'_','TO_RUN.bat') ) )
  }
  if (file.exists ( paste0('S:/R/BATCH/', paste0 (toupper(mypc),'_','TO_RUN.bat') )))
    
  {
    CATln_Border( paste0('SAVED =   S:/R/BATCH/', paste0 (toupper(mypc),'_','TO_RUN.bat') ))
  }
  
}

# ==================================================================================================
TRAINEE_LOOP_WCEO_VN = function ()  {
  # ------------------------------------------------------------------------------------------------
}

# ==================================================================================================
TRAINEE_MERGE_STKVN_BOARD_DAY_OLD = function  (  Fr_Folder =  paste0('S:/STKVN/BOARD/WOMAN_CEO/') ,
                                                 pFolder =   paste0('S:/STKVN/BOARD/WOMAN_CEO/'),
                                                 LIST_SOURCES = list('CAF','VST','VND'),
                                                 pPrefix = 'ccpr',  
                                                 CheckDate = '2024-06-14' ,
                                                 ToIntegrateHistory = F) {
  # ------------------------------------------------------------------------------------------------
  
  # MERGE CEO 
  LastTrading = CCPR_LAST_TRADING_DAY_VN(09, ToPrompt = T)
  # LIST_SOURCES = list( 'VND', 'CAF', 'VST')
  DATA_MERGE = data.table()
  pData = list ()
  for (k in 1:length(LIST_SOURCES))
  {
    # k =3
    pSource     = LIST_SOURCES[[k]]
    File_Folder = Fr_Folder
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    
    if ( nrow (File_Data) > 0) 
    {
      if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'ceo', 'source') %in% names(File_Data) ) )
      {
        switch (pSource,
                'VND' = {
                  xData = File_Data[ceo==1, .(code, date, source,gender, value=as.character(people_name))] 
                } ,
                'CAF' = {
                  xData = File_Data[ceo==1, .(code, date, source,gender, value=as.character(people_name))] 
                },
                'VST' = {
                  xData = File_Data[ceo==1, .(code, date, source,gender, value=as.character(fullname_lc))] 
                }
        )
        
        pData [[k]] = xData
        My.Kable( pData [[k]] )
        Sys.sleep(2)
      }
    }
    
  }
  DATA_MERGE = rbindlist(pData, fill=T)
  DATA_MERGE [, source := as.character (source)]
  
  My.Kable(DATA_MERGE[order(-date, code)])
  
  
  DATA_ALL = unique(DATA_MERGE, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
  unique(DATA_ALL, by = 'source')
  MaxDate   = max(DATA_ALL [!is.na(date)]$date)
  DATA_ALL  = DATA_ALL[date==MaxDate]
  xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_ALL = unique (DATA_ALL, by = c('code','source','value'))
  
  DATA_SPD = TRAINEE_FINAL_SOURCES_DATASET(pData=copy(DATA_ALL[,. (source, date, code, value)]),
                                           Dataset="CEO", KeySpread="source", ValueSpread="value",
                                           ExcludeCols = c("code","date"))
  
  My.Kable.TB(DATA_SPD[order(date, code)])
  DATA_SPD [, ':='(people_name = final)]
  
  
  # MERGE GENDER --------------------------------------------
  
  CEO_LIST = DATA_SPD [,.(code, people_name = final)]
  CEO_LIST [, name_clean := decodeVN(people_name, from='Unicode', to='Unicode', diacritics=F)]
  DATA_MERGE = CEO_LIST
  File_Data = setDT (read.xlsx('S:/R/DATA/BOARD/LIST/name_with_gender.xlsx'))
  xData = File_Data [,. (name_clean = pname, gender )]
  DATA_MERGE = unique ( merge (DATA_MERGE,xData , all.x = T, by = 'name_clean'), by = 'name_clean' ) [, source := 'EXCEL']
  
  Data = list()
  for (i in 1:length(LIST_SOURCES))
  {
    # i = 1
    pSource     = LIST_SOURCES[[i]]
    File_Folder = Fr_Folder
    
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    File_Data [, gender := trimws(gender)]
    File_Data [gender == 'FEMALE', gender := 'F']
    File_Data [gender == 'MALE', gender := 'M']
    File_Data = File_Data [nchar (code) == 8]
    
    if ( nrow (File_Data) > 0) 
    {
      switch (pSource,
              'VND' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name & ceo==1] [,.( code,source, people_name,  gender)] 
              } ,
              'CAF' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name & ceo==1] [,.(code, source, people_name,  gender)] 
              },
              'VST' = {
                xData = File_Data [fullname_lc %in% CEO_LIST$people_name & ceo==1] [,.(code,source, people_name = fullname_lc,  gender)] 
              }
      )
      Data [[i]] = xData
    }
    
  }
  
  DATA_ALL = rbindlist (Data, fill = T)
  DATA_MERGE = rbind (DATA_MERGE[!is.na(people_name)] [,.(people_name, code, gender, source)], DATA_ALL, fill =T)
  DATA_MERGE = DATA_MERGE[!is.na(people_name)]
  xCOUNT = DATA_MERGE[!is.na(people_name)][, .(n=.N), by=c('code', 'gender')][!is.na(gender)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_MERGE = unique( DATA_MERGE[!is.na(gender)] , by = c('code', 'source' , 'people_name') )
  
  DATA_SPDg = TRAINEE_FINAL_SOURCES_DATASET(pData=copy(DATA_MERGE[,. (source, code, people_name, gender)]),
                                            Dataset="GENDER", KeySpread="source", ValueSpread="gender",
                                            ExcludeCols = c("code","people_name"))
  DATA_SPD = merge (DATA_SPD [,.(code,date,people_name, dataset)], DATA_SPDg [,. (people_name, gender = final)], all.x = T, by = 'people_name')
  DATA_SPD [!is.na(people_name)]
  
  market   = CCPR_READRDS("S:/STKVN/PRICES/FINAL/","final_stkvn_market_4index_day.rds")
  DATA_SPD = merge (DATA_SPD, market [,.(code, market)], all.x = T, by ='code')
  DATA_SPD = unique (DATA_SPD , by = c ('code', 'people_name'))
  DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
  
  DATA_SPD [gender == 'F', gender := 'FEMALE']
  DATA_SPD [gender == 'M', gender := 'MALE']
  
  My.Kable.TB ( DATA_SPD[order(date, code)])
  My.Kable.TB ( DATA_SPD[order(date, code)][is.na(people_name)])
  
  FileBoard = paste0 (  pPrefix, "_stkvn_board_", gsub('-','',CheckDate),".rds")
  FileWCEO  = paste0 (  pPrefix, "_stkvn_wceo_", gsub('-','',CheckDate),".rds")
  
  saveRDS  (DATA_SPD, paste0 (  pFolder,FileBoard  ) )
  CATln_Border( paste ('SAVED: ',paste0 (  pFolder,FileBoard  ) ) )
  
  DATA_WCEO = DATA_SPD [gender == 'FEMALE' & market!="UPC"] 
  if (nrow (DATA_WCEO >0))
  {
    My.Kable (DATA_WCEO)
    saveRDS  (DATA_WCEO ,paste0 (  pFolder, FileWCEO ) )
    CATln_Border( paste ('SAVED: ',paste0 (  pFolder, FileWCEO )  ) )
  }
  
  if (ToIntegrateHistory) 
  {
    if (nrow (DATA_SPD) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileBoard, ToKable = T, ToRestore = T)
      Data_All = unique(rbind(Data_Old, DATA_SPD, fill=T), by=c('code', 'date'))
      Data_All = MERGE_DATASTD_BYCODE(Data_All, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_All[order(date, code)][, .( code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_All, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileBoard),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
    if (nrow (DATA_WCEO) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileWCEO, ToKable = T, ToRestore = T)
      Data_WCEO = unique(rbind(Data_Old, DATA_WCEO, fill=T), by=c('code', 'date'))
      Data_WCEO = MERGE_DATASTD_BYCODE(Data_WCEO, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_WCEO[order(date, code)][, .( code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_WCEO, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileWCEO),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
  }
  return (DATA_SPD)
}

# ==================================================================================================
TRAINEE_STKVN_WCEO_DAILY_REPORT_OLD = function(pDate = "2024-06-14",
                                               pFolder = "S:/STKVN/BOARD/WOMAN_CEO/",
                                               pFile = "data_stkvn_ceo_day.rds"){
  # ------------------------------------------------------------------------------------------------
  dt_wceo = CCPR_READRDS(pFolder,paste0("ccpr_stkvn_board_",gsub("-","",pDate),".rds"))
  
  # My_Data =  TRAINEE_CALCULATE_FILE_PERFORMANCE  (pData = data.table(), pFolder =  'S:/STKVN/PRICES/FINAL/',
  #                                                 pFile   = 'IFRC_CCPR_STKVN_FOR_DASHBOARD.RDS', EndDate  = pDate ) 
  
  dt_stkvn = CCPR_READRDS("S:/STKVN/PRICES/FINAL/DAY/",paste0("final_stkvn_4index_day_",gsub("-","",pDate),".rds"))
  
  dt_wceo = merge(dt_wceo[code %in% dt_stkvn$code,.(code,date,company_name=name,ceo=people_name,gender)],
                  dt_stkvn[,.(code,market,sharesout,close,rt,capibvnd=capivnd/1000000000)], by="code", all.x=T)
  
  icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
  dt_wceo = merge(dt_wceo, icb[,.(code, sector=icb1_name, industry=icb2_name)])
  
  dt_wceo[, sum_capi:=sum(capibvnd), by='date']
  dt_wceo[, cum_capi:=cumsum(capibvnd), by='date']
  dt_wceo[, pc_capi:=100*cum_capi/sum_capi, by='date']
  dt_wceo[pc_capi<=85, size:='LARGE']
  dt_wceo[pc_capi>85 & pc_capi<=95, size:='MID']
  dt_wceo[pc_capi>95, size:='SMALL']
  dt_wceo$pc_capi = NULL
  dt_wceo$cum_capi = NULL
  dt_wceo$sum_capi = NULL
  
  My.Kable(dt_wceo[order(-capibvnd)])
  CCPR_SAVERDS(dt_wceo[order(-capibvnd)], pFolder,pFile)
  CCPR_SAVERDS(dt_wceo[order(-capibvnd)], pFolder,gsub("day.rds",paste0(gsub("-","",pDate),".rds"),pFile))
  
  CCPR_SAVERDS(dt_wceo[order(-capibvnd)], paste0("S:/SHINY/STKVN/CEO/"), pFile)
  try(TRAINEE_CONVERT_FILE_RDS_TO_FST(pData = data.table(), File_Folder = paste0("S:/SHINY/STKVN/CEO/"), File_Name = pFile, FST_Folder = ''))
  
  # ceo_hist = CCPR_READRDS(pFolder, gsub("day.rds","history.rds",pFile))
  # CCPR_SAVERDS(dt_wceo, pFolder,"data_stkvn_ceo_day.rds")
  
  
  CCPR_SAVERDS(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)], pFolder,gsub("ceo","wceo",pFile))
  CCPR_SAVERDS(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)], pFolder,gsub("day.rds",paste0(gsub("-","",pDate),".rds"),gsub("ceo","wceo",pFile)))
  CCPR_SAVERDS(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)], paste0("S:/SHINY/STKVN/WCEO/"),gsub("ceo","wceo",pFile))
  try(TRAINEE_CONVERT_FILE_RDS_TO_FST(pData = data.table(), File_Folder = paste0("S:/SHINY/STKVN/WCEO/"), File_Name = gsub("ceo","wceo",pFile), FST_Folder = ''))
  My.Kable(dt_wceo[gender=="FEMALE" & market!="UPC"][order(-capibvnd)])
}

# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_CHART = function ( pOption = 'INDCS', pHost = 'dashboard_live' ) {
  # ------------------------------------------------------------------------------------------------
  FOLDER_HOST = 'S:/CCPR/DATA/DASHBOARD_LIVE/HOST_TO_LOCAL/'
  switch (pOption ,
          'INDCS' = {
            # try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= 'ccpi_dashboard_indcs_history',
            #                                  l.filepath= tolower(paste0('S:/CCPR/DATA/',  'ifrc_ccpr_indcs_history.rds') ),
            #                                  CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
            if (TRAINEE_SUMMARY_DATE_RDS('S:/CCPR/DATA/ifrc_ccpr_indcs_history.rds' ) > TRAINEE_SUMMARY_DATE_RDS(paste0 (FOLDER_HOST, 'ccpi_dashboard_indcs_history.rds'))) 
            {
              UPLOAD_RDS_TO_SQL (Connexion = pHost,  host = '', user = "", password = "", 
                                 SQL_str = "", 
                                 SQL_file = '', 
                                 pSleep = 1,
                                 ToReplace = F, PARAM_REPLACE = list( ) ,
                                 RDS_folder = 'S:/CCPR/DATA/', RDS_file = 'ifrc_ccpr_indcs_history.rds', SQL_table = 'ccpi_dashboard_indcs_history') 
              
              CATln_Border ( paste ( 'UPLOAD TABLE  = ' ,  'ccpi_dashboard_indcs_history'))
            } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' ,  'ccpi_dashboard_indcs_history'))} 
          },
          'INDIN' = {
            # try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= 'ccpi_dashboard_indcs_history',
            #                                  l.filepath= tolower(paste0('S:/CCPR/DATA/',  'ifrc_ccpr_indcs_history.rds') ),
            #                                  CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
            if (TRAINEE_SUMMARY_DATE_RDS('S:/CCPR/DATA/download_ifrc_indetf_history.rds' ) > TRAINEE_SUMMARY_DATE_RDS(paste0 (FOLDER_HOST, 'ccpi_dashboard_indetf_history.rds'))) 
            {
              UPLOAD_RDS_TO_SQL (Connexion = pHost,  host = '', user = "", password = "", 
                                 SQL_str = "", 
                                 SQL_file = '', 
                                 pSleep = 1,
                                 ToReplace = F, PARAM_REPLACE = list( ) ,
                                 RDS_folder = 'S:/CCPR/DATA/', RDS_file = 'download_ifrc_indetf_history.rds', SQL_table = 'ccpi_dashboard_indetf_history') 
              CATln_Border ( paste ( 'UPLOAD TABLE  = ' ,  'ccpi_dashboard_indetf_history'))
            } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' ,  'ccpi_dashboard_indetf_history'))} 
          },
          'CRYPTO' = {
            if (TRAINEE_SUMMARY_DATE_RDS('S:/CCPR/DATA/CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds' ) > TRAINEE_SUMMARY_DATE_RDS(paste0 (FOLDER_HOST, 'ccpi_dashboard_crypto_history.rds'))) 
            {
              UPLOAD_RDS_TO_SQL(Connexion = 'dashboard_live',  host = '27.71.235.71', user = "dashboard_user_login", password = "admin@beqholdings", 
                                SQL_str = "", 
                                SQL_file = '', 
                                pSleep = 1,
                                ToReplace = F, PARAM_REPLACE = list( ) ,
                                RDS_folder = 'S:/CCPR/DATA/', RDS_file = 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', SQL_table = 'ccpi_dashboard_crypto_history') 
              CATln_Border ( paste ( 'UPLOAD TABLE  = ' ,  'ccpi_dashboard_crypto_history'))
            } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' ,  'ccpi_dashboard_crypto_history'))} 
          },
          'RESEARCH' = {
            if (TRAINEE_SUMMARY_DATE_RDS('S:/CCPR/DATA/DOWNLOAD_IFRC_INDPOR_HISTORY.rds' ) > TRAINEE_SUMMARY_DATE_RDS(paste0 (FOLDER_HOST, 'ccpi_dashboard_indpor_history.rds'))) 
            {
              UPLOAD_RDS_TO_SQL(Connexion = 'dashboard_live',  host = '27.71.235.71', user = "dashboard_user_login", password = "admin@beqholdings", 
                                SQL_str = "", 
                                SQL_file = '', 
                                pSleep = 1,
                                ToReplace = F, PARAM_REPLACE = list( ) ,
                                RDS_folder = 'S:/CCPR/DATA/', RDS_file = 'DOWNLOAD_IFRC_INDPOR_HISTORY.rds', SQL_table = 'ccpi_dashboard_indpor_history') 
              CATln_Border ( paste ( 'UPLOAD TABLE  = ' ,  'ccpi_dashboard_indpor_history'))
            } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' ,  'ccpi_dashboard_indpor_history'))} 
          },
          'IND_WORLD' = {
            if (TRAINEE_SUMMARY_DATE_RDS('S:/CCPR/DATA/CCPR_WORLDINDEXES_HISTORY.rds' ) > TRAINEE_SUMMARY_DATE_RDS(paste0 (FOLDER_HOST, 'ccpi_dashboard_ind_world_history.rds'))) 
            {
              UPLOAD_RDS_TO_SQL(Connexion = 'dashboard_live',  host = '27.71.235.71', user = "dashboard_user_login", password = "admin@beqholdings", 
                                SQL_str = "", 
                                SQL_file = '', 
                                pSleep = 1,
                                ToReplace = F, PARAM_REPLACE = list( ) ,
                                RDS_folder = 'S:/CCPR/DATA/', RDS_file = 'CCPR_WORLDINDEXES_HISTORY.rds', SQL_table = 'ccpi_dashboard_ind_world_history') 
              CATln_Border ( paste ( 'UPLOAD TABLE  = ' ,  'ccpi_dashboard_ind_world_history'))
            } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' ,  'ccpi_dashboard_ind_world_history'))} 
          },
          'STKVN' = {
            if (TRAINEE_SUMMARY_DATE_RDS('S:/STKVN/PRICES/FINAL/IFRC_CCPR_STKVN_FOR_DASHBOARD.RDS' ) > TRAINEE_SUMMARY_DATE_RDS(paste0 (FOLDER_HOST, 'ccpi_dashboard_stkvn_history.rds'))) 
            {
              UPLOAD_RDS_TO_SQL(Connexion = 'dashboard_live',  host = '27.71.235.71', user = "dashboard_user_login", password = "admin@beqholdings", 
                                SQL_str = "", 
                                SQL_file = '', 
                                pSleep = 1,
                                ToReplace = F, PARAM_REPLACE = list( ) ,
                                RDS_folder = 'S:/STKVN/PRICES/FINAL/', RDS_file = 'IFRC_CCPR_STKVN_FOR_DASHBOARD.RDS', SQL_table = 'ccpi_dashboard_stkvn_history') 
              CATln_Border ( paste ( 'UPLOAD TABLE  = ' ,  'ccpi_dashboard_stkvn_history'))
            } else { CATln_Border ( paste ( 'SKIP UPLOAD TABLE  = ' ,  'ccpi_dashboard_stkvn_history'))} 
          }
  )
  
}


# ==================================================================================================
UPLOAD_RDS_TO_SQL = function(Connexion  = 'dashboard_live',  host = '27.71.235.71', user = "dashboard_user_login", password = "admin@beqholdings", 
                             SQL_str    = "UPDATE ccpi_dashboard_main_blocks_sql_test SET active = 1 WHERE div_name = 'WHERE TO INVEST';  ", 
                             SQL_file   = 'S:/CCPR/DATA/DASHBOARD_LIVE/SQL_TABLE/SQL_QUERY_TEST_v2.txt', 
                             pSleep     = 1, ToPrint =T, 
                             ToReplace  = F, PARAM_REPLACE = list('<PARAM_01>|WHERE TO INVEST','<PARAM_02>|CCPI VIETNAM INDEXES' ) ,
                             RDS_folder = '', RDS_file = '', SQL_table = '',
                             AutoUpload = T)  {
  # Connexion = 'xxx'
  
  
  LIST_QUERY = list()
  if (nchar (Connexion) == 0)
  {
    # MY_CONNECTION = try(dbConnect(MySQL(), user = "dashboard_user_login", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard_login"))
    MY_CONNECTION = try(dbConnect(MySQL(), user = username, password = password, host = host, dbname = "ccpi_dashboard_login"))
    
  } else {
    
    if (AutoUpload){
      source(paste0(SDLibrary, "TRAINEE_INTRO.R"), echo=F)
      
      if (Connexion %in% list('dashboard_live_dev','dashboard_live','dashboard_live_bat' ))
      {
        switch( DBL_Upload, 
                'DEV' = {Final_host = 'dashboard_live_dev' } ,
                'PRD' = {
                  if (Connexion == 'dashboard_live_bat')
                  {  Final_host = 'dashboard_live_bat'} else {Final_host = 'dashboard_live'} 
                },
                {    Final_host = Connexion  })
        
      } else {  Final_host = Connexion}
      MY_CONNECTION = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = Final_host))
    } else {  Final_host = Connexion
    MY_CONNECTION = try( TRAINEE.IFRC.CONNEXTION.2023 (lhost = Final_host))
    }
    CATln_Border(Final_host)
    # DBL_Upload
    
    DATACENTER_LINE_BORDER(paste('IFRC.UPLOAD.RDS = ', Final_host, ' >>>'))
  }
  SUCCESS =  (typeof (MY_CONNECTION) == 'S4')
  if (SUCCESS)
  {
    if (ToPrint) { print(MY_CONNECTION)  }
    if (nchar (SQL_file) > 0)
    {
      if (file.exists(SQL_file))
      {
        LIST_QUERY = readLines(SQL_file)
        CATln_Border('LIST QUERY:   ')
        print (LIST_QUERY) 
        # LIST_QUERY_1 = LIST_QUERY [1]
        if (ToReplace)
        {
          if (length (PARAM_REPLACE) > 0)
          {
            for (j in 1: length (LIST_QUERY))
            {
              LIST_QUERY_1 = LIST_QUERY [j]
              for (k in 1:length (PARAM_REPLACE))
              {
                # k = 1
                # PARAM_REPLACE [[1]]
                PARAM_FROM = word( PARAM_REPLACE [[k]], 1,1,'[|]'  )
                PARAM_TO   = word( PARAM_REPLACE [[k]], 2,2,'[|]'  )
                LIST_QUERY_1 = gsub (PARAM_FROM,PARAM_TO, LIST_QUERY_1  )
                LIST_QUERY [j] = LIST_QUERY_1
              }
            }
            CATln_Border('LIST QUERY REPLACED:   ')
            print ( LIST_QUERY) 
          }
        }
      }
    }
    
    # ToPrint =T
    if (nchar (SQL_str) >0)
    {
      if (ToPrint) {print(SQL_str, quote = F)};x = dbGetQuery(MY_CONNECTION, statement = SQL_str)
    } else {
      if (length (LIST_QUERY) >0)
      {
        for (i in 1: length (LIST_QUERY))
        {
          # i= 1
          SQL_str = LIST_QUERY [i]
          if (ToPrint) {print(SQL_str, quote = F)}; x = dbGetQuery(MY_CONNECTION, statement = SQL_str)
          Sys.sleep(pSleep)
        }
      }
    }
    
    if (file.exists( paste0 (RDS_folder, RDS_file)))
    {
      start = Sys.time()
      l.data = CHECK_CLASS( try ( CCPR_READRDS ( RDS_folder, RDS_file, ToRestore = T, ToKable = T)))
      if (! 'updated' %in% names (l.data)) { l.data [, updated := SYS.TIME()]}
      
      if ( nrow (l.data) > 0)
      {
        # try (IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023 (l.host = Connexion, l.tablename = SQL_table , l.data, ToPrint = T) 
        stm1 = paste0("drop table if exists ", SQL_table)
        # stm2 = paste0("create table ", SQL_table, " like tempx_", SQL_table,"_", my_time)
        stm3 = paste0("insert into ", SQL_table)
        
        # conn = TRAINEE.IFRC.CONNEXTION.2023(l.host)
        if (ToPrint) {print(stm1, quote = F)}; dbGetQuery(MY_CONNECTION, statement = stm1)
        if (ToPrint) {print(stm3, quote = F)}; dbWriteTable(MY_CONNECTION, SQL_table, l.data, field.types = NULL, row.names = F, append = TRUE)
      }
      end = Sys.time()
      CATln_Border ( paste ( 'UPLOAD TABLE DURATION = ' , difftime (end, start)))
    }
  }
  dbDisconnect(MY_CONNECTION)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_WCEO_IN_FROM_YAH = function(pCountry  = 'SGP', ToCheckDate = T, Minutes=1*60, Delay = 1, Proba = 90) {
  # ------------------------------------------------------------------------------------------------
  
  # pCountry  = 'NLD'
  # pCountry  = 'SGP'; ToCheckDate = T; Minutes=0*60
  
  File_name   = paste0('ifrc_ccpr_indwceo', tolower(pCountry), '_compo.rds')
  File_folder = paste0('S:/WCEO_INDEXES/', pCountry, '/')
  File_Day    = paste0('download_', pCountry, '_yah_prices_final_day.rds')
  TO_DO       = F
  if ( runif(1,1,100) > Proba)
  {
    TO_DO = T
  } else {
    if (ToCheckDate)
    {
      Summary_Day = SUMMARY_DATE(paste0(File_folder, File_Day))
      if (Summary_Day < SYSDATETIME_DELAY(17, delay = Delay))
      {
        TO_DO = T
      }
    }
  }
  
  if (TO_DO)
  {
    My_action = paste('TRAINEE_DOWNLOAD_WCEO_IN_FROM_YAH >', pCountry)
    if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=My_action, pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
    {
      # try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=My_action, pAction="SAVE", NbSeconds=0*60, ToPrint=F))
      data      = CHECK_CLASS(try(CCPR_READRDS(paste0('S:/SHINY/INDEX/WOMENCEO/', pCountry, '/'), File_name, ToKable = T, ToRestore = T)))
      
      
      data_Day    = CHECK_CLASS(try(CCPR_READRDS(File_folder, File_Day)))
      
      # SYSDATETIME(23)
      
      if (nrow(data_Day)>0)
      {
        Maxdate   = max(data_Day$date)
        CATln_Border(Maxdate)
      } else {
        Maxdate = as.Date('1900-01-01')
      }
      if (nrow(data_Day)>0) { My.Kable.Min(data_Day) }
      
      if (nrow(data) > 0 & (SYSDATETIME(23) - Maxdate > 0) )
      {
        My.Kable(data)
        list_codesource = data$codesource
        
        list_code = list_codesource
        xList = list()
        DATA  = data.table()
        print(list_code)
        
        for (k in 1:length(list_code)) 
        {
          # k = 1
          CATln('')
          CATln_Border(paste(k,'/', length(list_code)))
          x = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_ALL_BY_CODE  (pCode = list_code[[k]], NB_Day = 100000, Dividend = T, Capi = T, Sharesout = T)))
          if (nrow(x) > 0) {
            xList[[k]] = x
          }
        }
        
        DATA_ALL = rbindlist(xList, fill=T)
        File_folder = paste0('S:/WCEO_INDEXES/', pCountry, '/')
        File_name   = paste0('download_', pCountry, '_yah_prices_final_day.rds')
        CATln_Border(paste(File_folder, File_name))
        if(nrow(DATA_ALL) > 0 )
        {
          try(DBL_CCPR_SAVERDS(DATA_ALL, File_folder, File_name, ToSummary = T, SaveOneDrive = T))
        }
      } else {
        CATln_Border(paste('FILE ALREADY UPDATED = ', File_Day))
      }
    }
    try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=My_action, pAction="SAVE", NbSeconds=0*60, ToPrint=F))
  }
  
  CATln('')
}

# ==================================================================================================
TRAINEE_DOWNLOAD_FANT_VIETNAM_INDEX_BY_CODE = function(){
  # ------------------------------------------------------------------------------------------------
  # pCode = 'VNINDEX'
  Start.Time  = Sys.time()
  list_index = list('VNINDEX', 'HNXINDEX', 'UPINDEX', 'VN30', 'HNX30')
  xList = list()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  for (i in 1:length(list_index)){
    pCode = list_index[[i]]
    x = try (TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE (pCodesource = pCode, Starttime=8, STOCK = T, CodeInt='',  merge_ins_ref = F))
    my_data = x[date == LastTrading][, .(name    = paste0(codesource,', VIETNAM'),
                                         codesource,
                                         country = 'VIETNAM',
                                         last    = close,
                                         pClose  = close + change,
                                         time    = format(strptime(substr(SYS.TIME(), 12, 19), "%H:%M:%S"), "%I:%M:%S"),
                                         ampm    = ifelse(as.numeric(format(strptime(substr(SYS.TIME(), 12, 19), "%H:%M:%S"), "%H")) >= 12, "PM", "AM"),
                                         date    = LastTrading,
                                         updated = substr(as.character(Sys.time()),1,19),
                                         change  = change,
                                         varpc   = 100*((close/reference)-1),
                                         continent = 'ASIA',
                                         name_chart = paste0(codesource,', VIETNAM')
    )]
    My.Kable.All(my_data)
    xList[[i]] = my_data
  }
  
  final_data = rbindlist(xList, fill = T)
  My.Kable.All(final_data)
  End.Time = Sys.time()
  Duration = Format.Number(difftime(End.Time, Start.Time, units='secs'), 2)
  CATln(paste('TRAINEE_DOWNLOAD_FANT_VIETNAM_INDEX_BY_CODE - Duration = ', Duration))
  catrep('-', 120)
  return (final_data)
  
}

# ==================================================================================================
REPORT_WCEO_INDEX = function(Action='CHECK INDEX DATA', SaveTo = '',
                             list_country = list('AUS', 'FRA', 'BEL', 'HKG', 'CHN', 'IDN', 'IRL', 'ITA', 'JPN', 'MYS', 'NOR', 'SGP', 'THA', 'TWN', 'PRT', 'DEU', 'NLD'),
                             Folder_data = 'S:/WCEO_INDEXES/')
{
  # ------------------------------------------------------------------------------------------------
  Display_All = data.table()
  switch(Action,
         'CHECK WCEO DATA' = {
           
           Data_list = list()
           k = 0
           for (pCountry in list_country)
           {
             k = k+1
             Final_Data = data.table()
             rm(data, NCodes, NDates, NDate1)
             # pCountry  = 'DEU'
             # pCountry  = 'FRA'
             # File_name = 'PRICES_FINAL_DAY.rds'
             # download_nld_yah_prices_final_day
             File_name = paste0('download_', pCountry, '_yah_prices_final_day.rds')
             data      = CHECK_CLASS(try(CCPR_READRDS(paste0(Folder_data, pCountry, '/'), File_name, ToKable = T)))
             
             if (nrow(data)>1)
             {
               NCodes    = nrow(unique(data[!is.na(codesource)], by='codesource'))
               NDates    = data[!is.na(codesource)][order(codesource, date)][, .(n=.N, start=date[1], end=date[.N]), by='codesource']
               if (!is.null(NDates))
               {
                 NDate1    = NDates[, .(records=sum(n), start=min(start), end=max(end))]
                 Final_Data = cbind(data.table(iso3=pCountry), data.table(codes=NCodes), NDate1)
                 My.Kable.All(Final_Data)
                 Data_list[[k]] = Final_Data
               }
               else{
                 #   # NDate1    = NDates[, .(records = as.numeric(NA), start = as.Date(NA), end = as.Date(NA))]
                 #   # Final_Data = cbind(data.table(iso3=pCountry), data.table(codes=as.numeric(NA)), NDate1)
                 #   # My.Kable.All(Final_Data)
                 Data_list[[k]] = Final_Data
               }
             }
           }
           All_List     = rbindlist(Data_list, fill=T)
           Display_All  = data.table()
           
           # Number ............................................................................................
           Display_List = All_List[, .(iso3, date=as.character(codes))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='DATA CODES'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           # Dates ............................................................................................
           Display_List = All_List[, .(iso3, date=as.character(start))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='DATA START'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           Display_List = All_List[, .(iso3, date=as.character(end))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='DATA END'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           My.Kable.All(Display_All)
         },
         'CHECK WCEO INDEXES' = {
           
           Data_list = list()
           k = 0
           for (pCountry in list_country)
           {
             k = k+1
             Final_Data = data.table()
             rm(data, NCodes, NDates, NDate1)
             # pCountry  = 'SGP'
             # pCountry  = 'USA'
             # File_name = 'PRICES_FINAL_DAY.rds'
             # File_name = paste0('ifrc_ccpr_indwceo', pCountry, '_history.rds')
             # ifrc_ccpr_indwceonld_history.rds
             # File_name = paste0('wceo_', pCountry, '_ind_history.rds')
             File_name = paste0('ifrc_ccpr_indwceo', pCountry, '_history.rds')
             data      = CHECK_CLASS(try(CCPR_READRDS(paste0(Folder_data, pCountry, '/'), File_name, ToKable = T)))
             
             if (nrow(data)>0)
             {
               NCodes    = nrow(unique(data[!is.na(code)], by='code'))
               NDates    = data[!is.na(code)][order(code, date)][, .(n=.N, start=date[1], end=date[.N]), by='code']
               NDate1    = NDates[, .(records=sum(n), start=min(start), end=max(end))]
               Final_Data = cbind(data.table(iso3=pCountry), data.table(codes=NCodes), NDate1)
               My.Kable.All(Final_Data)
               Data_list[[k]] = Final_Data
             } else{
               Data_list[[k]] = data.table(iso3=pCountry)
             }
           }
           All_List     = rbindlist(Data_list, fill=T)
           Display_All  = data.table()
           
           # Number ............................................................................................
           Display_List = All_List[, .(iso3, date=as.character(codes))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='INDEX CODES'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           # Dates ............................................................................................
           Display_List = All_List[, .(iso3, date=as.character(start))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='INDEX START'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           Display_List = All_List[, .(iso3, date=as.character(end))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='INDEX END'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           My.Kable.All(Display_All)
         }
  )
  
  if (nchar(SaveTo) >0) { saveRDS (Display_All, SaveTo)
    CATln(''); CATln_Border(paste('SAVED TO: ',SaveTo) ); CATln('')
  }
  if (nrow(Display_All)>0) { 
    CATln(''); CATln_Border('FINALLY '); CATln('')
    My.Kable.All(Display_All)}
  return(Display_All)
}

# ==================================================================================================
BEQ_INDEX_2024  = function(INDEX.NAME, MinDate = '2024-05-20', ToCheckDate = F) {
  CATln_Border(paste('BEQ_INDEX_2024 =', INDEX.NAME))
  # INDEX.NAME = 'BANK'; MinDate = Sys.Date()
  switch(INDEX.NAME,
         
         'LOGISTICS' = {
           INDEX.NAME = 'LOGISTICS'
           # LOGISTICS ........................................................................................
           lFactor         = 'LOG'
           FileCompoXLSX   = paste0('COMPO_VNXSEC', lFactor, '.xlsx')
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR LOGISTICS'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = paste0('VNXSEC', lFactor)
           INDEX_FCODE     = paste0('INDVNXSEC', lFactor, 'PRVND')
           MAX_RT          = 0.45
           BEQIND_NAME_VND = paste0('BEQ_IND', lFactor, 'ALS_VND.rds')
           BEQIND_NAME_HST = paste0('BEQ_IND', lFactor, 'ALS_HISTORY.rds')
           BEQIND_NAME_CMP = paste0('BEQ_IND', lFactor, 'ALS_COMPO.rds')
           SEARCH_INSREF   = 'LOGISTICS'
         },
         
         'FINANCE' = {
           # BROKERAGE ........................................................................................
           lFactor         = 'FIN'
           FileCompoXLSX   = paste0('COMPO_VNXSEC', lFactor, '.xlsx')
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR FINANCE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = paste0('VNXSEC', lFactor)
           INDEX_FCODE     = paste0('INDVNXSEC', lFactor, 'PRVND')
           MAX_RT          = 0.45
           BEQIND_NAME_VND = paste0('BEQ_IND', lFactor, 'ALS_VND.rds')
           BEQIND_NAME_HST = paste0('BEQ_IND', lFactor, 'ALS_HISTORY.rds')
           BEQIND_NAME_CMP = paste0('BEQ_IND', lFactor, 'ALS_COMPO.rds')
           SEARCH_INSREF   = 'ENERGY'
         },
         
         'ENERGY' = {
           # BROKERAGE ........................................................................................
           lFactor         = 'ENY'
           FileCompoXLSX   = paste0('COMPO_VNXSEC', lFactor, '.xlsx')
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR ENERGY'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = paste0('VNXSEC', lFactor)
           INDEX_FCODE     = paste0('INDVNXSEC', lFactor, 'PRVND')
           MAX_RT          = 0.45
           BEQIND_NAME_VND = paste0('BEQ_IND', lFactor, 'ALS_VND.rds')
           BEQIND_NAME_HST = paste0('BEQ_IND', lFactor, 'ALS_HISTORY.rds')
           BEQIND_NAME_CMP = paste0('BEQ_IND', lFactor, 'ALS_COMPO.rds')
           SEARCH_INSREF   = 'ENERGY'
         },
         
         'PETROLIMEX' = {
           # PETROLIMEX ........................................................................................
           lFactor         = 'PET'
           FileCompoXLSX   = paste0('COMPO_VNXSEC', lFactor, '.xlsx')
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX GROUP PETROLIMEX'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXGRPPET'
           INDEX_FCODE     = 'INDVNXGRPPETPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDPETALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDPETALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDPETALS_COMPO.rds'
           SEARCH_INSREF   = 'PETROLIMEX'
         },
         
         'BROKERAGE' = {
           # BROKERAGE ........................................................................................
           lFactor         = 'BRK'
           FileCompoXLSX   = 'COMPO_VNXSECBRK.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR BROKERAGE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECBRK'
           INDEX_FCODE     = 'INDVNXSECBRKPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDBRKALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDBRKALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDBRKALS_COMPO.rds'
           SEARCH_INSREF   = 'BROKERAGE'
         },
         
         'HEALTHCARE' = {
           # HEALTHCARE .......................................................................................
           lFactor         = 'HLC'
           FileCompoXLSX   = 'COMPO_VNXSECHLC.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR HEALTHCARE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGHLC'
           INDEX_FCODE     = 'INDVNXSECHLCPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDHLCALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDHLCALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDHLCALS_COMPO.rds'
           SEARCH_INSREF   = 'HEALTHCARE'
         },
         
         'REALESTATE' = {
           # REALESTATE .......................................................................................
           lFactor         = 'RST'
           FileCompoXLSX   = 'COMPO_VNXSECRST.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR REAL ESTATE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE    = 'VNXSECGRST'
           INDEX_FCODE   = 'INDVNXSECRSTPRVND'
           MAX_RT        = 0.45
           BEQIND_NAME_VND = 'BEQ_INDRSTALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDRSTALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDRSTALS_COMPO.rds'
           SEARCH_INSREF   = 'REAL ESTATE'
         },
         
         'RETAIL' = {
           # RETAIL ...........................................................................................
           lFactor         = 'RTL'
           FileCompoXLSX   = 'COMPO_VNXSECRTL.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR RETAIL'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGRTL'
           INDEX_FCODE     = 'INDVNXSECRTLPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDRTLALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDRTLALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDRTLALS_COMPO.rds'
           SEARCH_INSREF   = 'RETAIL'
         },
         
         'BANK' = {
           # BANK .............................................................................................
           lFactor         = 'BNK'
           FileCompoXLSX   = 'COMPO_VNXSECBNK.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR BANK'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGBNK'
           INDEX_FCODE     = 'INDVNXSECBNKPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDBNKALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDBNKALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDBNKALS_COMPO.rds'
           SEARCH_INSREF   = 'BANK'
         },
         
         'AI' = {
           # AI .............................................................................................
           lFactor         = 'ARI'
           FileCompoXLSX   = 'COMPO_VNXSECARI.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR ARTIFICIAL INTELLIGENCE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGARI'
           INDEX_FCODE     = 'INDVNXSECARIPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDARIALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDARIALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDARIALS_COMPO.rds'
           SEARCH_INSREF   = 'ARTIFICIAL INTELLIGENCE'
         }
         
  )
  
  # ................................................................................................
  TODO = T
  # ................................................................................................
  if (ToCheckDate) 
  {
    if (TRAINEE_SUMMARY_DATE_RDS(paste0(UData, 'IFRC_STKVN_HSXHNX_4INDEX.rds')) > 
        TRAINEE_SUMMARY_DATE_RDS(paste0('S:/STKVN/INDEX_2024/', 'beq_ind', lFactor,'als_history.rds')))
    {
      TODO = T
    } else {
      TODO = F
    }
  }
  
  if (TODO)
  {
    STKVN_4INDEX = CCPR_READRDS(UData, 'IFRC_STKVN_HSXHNX_4INDEX.rds', ToKable=T, ToRestore=T)
    # [date<=SYSDATETIME(16)]
    My.Kable.Min(STKVN_4INDEX[order(date, code)])
    # ....
    List_Codes_XLS = setDT(openxlsx::read.xlsx(paste0(FolderCompoXLSX, FileCompoXLSX)))
    My.Kable(List_Codes_XLS)
    List_STK       = as.list(List_Codes_XLS$code)
    # File_STK = 'IFRC_CCPR_STKVN_FOR_INDEX.rds'
    
    File_STK = 'IFRC_STKVN_4INDEX.rds'
    # File_STK = 'IFRC_STKVN_HSXHNX_4INDEX.rds'
    
    # lFactor      = 'LOG'
    # STKVN_4INDEX = STKVN_CLEANED
    # STKVN_4INDEX[, secn:='LOG']
    NAME         = INDEX_NAME
    CODE         = INDEX_CODE
    FINAL_CODE   = INDEX_FCODE
    xCONDITION   = 'market %in% list("HSX", "HNX") & code %in% List_STK'
    
    # ------------------------------------------------------------------------------------------------
    
    Start.time = Sys.time()
    COMPO_4INDEX   = data.table()
    CLOSE_4INDEX   = data.table()
    
    STKVN_4INDEX   = CCPR_READRDS(UData, File_STK, ToKable=T, ToRestore=T)
    
    FIRST_SHARES   = unique(STKVN_4INDEX[order(code, date)][!is.na(shares)], by='code') 
    My.Kable.TB(FIRST_SHARES[, .(code, name, date, shares)])
    
    STKVN_4INDEX   = STKVN_4INDEX[code %in% FIRST_SHARES$code] 
    STKVN_4INDEX   = merge(STKVN_4INDEX, FIRST_SHARES[, .(code, first_shares=date)], all.x = T, by='code')
    My.Kable.TB(STKVN_4INDEX[, .(code, name, date, shares, first_shares)][order(first_shares)])
    
    STKVN_4INDEX   = STKVN_4INDEX[date>=first_shares]
    
    STKVN_4INDEX   = STKVN_4INDEX[order(code, date)]
    STKVN_4INDEX[, shares:=na.locf(shares), by='code']
    # STKVN_4INDEX[, sharesout:=na.locf(sharesout), by='code']
    # STKVN_4INDEX[, shareslis:=na.locf(shareslis), by='code']
    
    
    My.Kable(STKVN_4INDEX[, .(code, date, shares, shareslis, sharesout, close, rt, rtd)])
    
    STKVN_4INDEX   = STKVN_4INDEX[abs(rt)<MAX_RT & !is.na(shares) & !is.na(close) & !is.na(rt) &!is.na(market)]
    STKVN_CLEANED  = copy(STKVN_4INDEX)
    print(unique(STKVN_CLEANED$market))
    STKVN_4INDEX = STKVN_CLEANED
    STKVN_4INDEX[, secn:=lFactor]
    
    if (nchar(xCONDITION)==0)
    {
      STKVN_4INDEX = MERGE_DATASTD_BYCODE(STKVN_4INDEX, pOption='FINAL')
    } else {
      STKVN_4INDEX = MERGE_DATASTD_BYCODE(STKVN_4INDEX, pOption='FINAL')[eval(parse(text = xCONDITION))]
    }
    str(STKVN_4INDEX)
    # STKVN_4INDEX[code %in% List_STK]
    
    My.Kable.Min(STKVN_4INDEX[order(date, code)])
    
    
    
    STKVN_4INDEX[, close_unadj:=close]
    STKVN_4INDEX[, capi:=shares*close_unadj]
    
    STKVN_4INDEX[, capi:=shares*close]
    STKVN_4INDEX[is.na(capi) & !is.na(shares) & !is.na(reference), capi:=shares*reference]
    # STKVN_4INDEX[, level:=as.numeric(IDX_LEVEL)]
    My.Kable(STKVN_4INDEX[, .(code, secn, name, market, date, close_unadj, shares, reference, rt, shares, capi)])
    My.Kable(STKVN_4INDEX[is.na(secn)][, .(code, secn, name, market, date, close_unadj, shares, reference, rt, shares, capi)][order(date)])
    
    STKVN_4INDEX_TO_CALCULATE = STKVN_4INDEX[!is.na(secn) & !is.na(capi) & !is.na(rt) & !is.na(market)][date>='2008-12-31']
    COMPO_4INDEX = rbind(COMPO_4INDEX, STKVN_4INDEX_TO_CALCULATE[, .(secn, market, code, date, shares, close_unadj, rt, rtd, capi)], fill=T)
    Data_Sample = STKVN_4INDEX_TO_CALCULATE
    Data_Compo  = copy(Data_Sample)
    Data_Compo[is.na(capi_loc) & !is.na(close_unadj) & !is.na(shares), capi_loc:=shares*close_unadj]
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][order(date, code)])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][is.na(capi_loc)])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][abs(rt)>0.4])
    
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][(!is.na(rt) | !is.na(rtd)) & rt>rtd])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][(!is.na(rt) | !is.na(rtd)) & rt!=rtd])
    
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][is.na(rt) | is.na(rtd) | rt>rtd])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][rt>rtd])
    
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][order(date, code)])
    
    Date_Sample   = unique(Data_Sample[, .(date)], by='date')
    Data_Sample[, factor:=secn]
    Capi_Sample   = Data_Sample[, .(sum_capi=sum(capi, na.rm=T)), by=c('date', 'factor')]
    Date_Sample   = merge(Date_Sample, Capi_Sample, all.x=T, by='date')
    My.Kable(Date_Sample[order(date)])
    
    # CALCULATE : ......................................................................................
    
    MaxABS = MAX_RT
    STKVN_4INDEX_TO_CALCULATE = STKVN_4INDEX_TO_CALCULATE[abs(rt)< MaxABS]
    # IFRC_INDEX_CALCULATION_GICS_SECTOR =
    STKVN_4INDEX_SUMS = STKVN_4INDEX_TO_CALCULATE[,.(
      n        = .N, 
      sum_capi = sum(capi, na.rm=T), 
      sum_rt   = sum(rt, na.rm=T),  
      sum_rtd  = sum(rtd, na.rm=T), 
      sum_prod_capixrt  = sum(capi*rt, na.rm=T),
      sum_prod_capixrtd = sum(capi*rtd, na.rm=T)
    ) , by=c('factor', 'date')]
    
    My.Kable(STKVN_4INDEX_SUMS[order(date, factor)])
    STKVN_4INDEX_SUMS[!is.na(n) & n>0,  rt_ew:=  sum_rt/n]
    STKVN_4INDEX_SUMS[!is.na(sum_capi), rt_cw:=  sum_prod_capixrt/sum_capi]
    STKVN_4INDEX_SUMS[!is.na(n) & n>0,  rtd_ew:= sum_rtd/n]
    STKVN_4INDEX_SUMS[!is.na(sum_capi), rtd_cw:= sum_prod_capixrtd/sum_capi]
    STKVN_4INDEX_SUMS[, index_ew:=1000]
    STKVN_4INDEX_SUMS[, index_cw:=1000]
    STKVN_4INDEX_SUMS[, index_ewd:=1000]
    STKVN_4INDEX_SUMS[, index_cwd:=1000]
    
    My.Kable.TB(STKVN_4INDEX_SUMS[order(date, factor)], Nb=10)
    
    List_FACTORS = unique(STKVN_4INDEX_TO_CALCULATE$factor)
    print(List_FACTORS)
    
    xList = list()
    
    xFACTOR = lFactor
    # CATln('\014')
    CATln_Border(xFACTOR)
    Sys.sleep(2)
    starter = 1000
    STKVN_4INDEX_SUMS_ONE = STKVN_4INDEX_SUMS[factor==xFACTOR][order(date)]
    STKVN_4INDEX_SUMS_ONE[, nr:=seq.int(.N)]
    
    STKVN_4INDEX_SUMS_ONE[nr==1, rt_ew:=0]
    STKVN_4INDEX_SUMS_ONE[nr==1, rt_cw:=0]
    STKVN_4INDEX_SUMS_ONE[nr==1, rtd_ew:=0]
    STKVN_4INDEX_SUMS_ONE[nr==1, rtd_cw:=0]
    # View(STKVN_4INDEX_SUMS_ONE)
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rt_ew)),
             index_ew = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rtd_ew)),
             index_ewd = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    # STKVN_4INDEX_SUMS_ONE = setDT(STKVN_4INDEX_SUMS_ONE)[order(factor, date)]
    
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rt_cw)),
             index_cw = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rtd_cw)),
             index_cwd = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    
    STKVN_4INDEX_SUMS_ONE = setDT(STKVN_4INDEX_SUMS_ONE)[order(factor, date)]
    
    STKVN_4INDEX_SUMS_ONE$index_temp = NULL
    STKVN_4INDEX_SUMS_ONE$nr = NULL
    STKVN_4INDEX_SUMS_ONE$wgtrt.unit = NULL
    
    My.Kable(STKVN_4INDEX_SUMS_ONE)
    # FINAL_CODE = 'XXX'
    STKVN_4INDEX_SUMS_ONE = merge(STKVN_4INDEX_SUMS_ONE[, -c('index_name', 'index_code', 'index_symbol')], 
                                  data.table(factor=lFactor, index_name=gsub('&amp;','&', paste('IFRC/BEQ HOLDINGS', NAME)), 
                                             index_code=FINAL_CODE, index_symbol=CODE),
                                  all.x=T, by='factor')
    My.Kable(STKVN_4INDEX_SUMS_ONE)
    INDEX_ONE = STKVN_4INDEX_SUMS_ONE[, .(index_code, index_name, index_symbol, date, rt_ew, rt_cw, index_ew, index_cw, rtd_ew, rtd_cw, index_ewd, index_cwd)]
    My.Kable(INDEX_ONE)
    INDEX_ONE_EW = INDEX_ONE[, .(code=gsub('PRVND', 'EWPRVND', index_code), name=paste(index_name, 'PR EW (VND)'), date, close=index_ew, rt=rt_ew)]
    INDEX_ONE_CW = INDEX_ONE[, .(code=gsub('PRVND', 'CWPRVND', index_code), name=paste(index_name, 'PR CW (VND)'), date, close=index_cw, rt=rt_cw)]
    
    INDEX_ONE_EWD = INDEX_ONE[, .(code=gsub('PRVND', 'EWTRVND', index_code), name=paste(index_name, 'TR EW (VND)'), date, close=index_ewd, rt=rtd_ew)]
    INDEX_ONE_CWD = INDEX_ONE[, .(code=gsub('PRVND', 'CWTRVND', index_code), name=paste(index_name, 'TR CW (VND)'), date, close=index_cwd, rt=rtd_cw)]
    
    INDEX_ONE_ALL = rbind(INDEX_ONE_EW, INDEX_ONE_CW, INDEX_ONE_EWD, INDEX_ONE_CWD)
    My.Kable(INDEX_ONE_ALL)
    My.Kable.All(unique(INDEX_ONE_ALL[order(code, -date)], by='code'))
    End.time = Sys.time()
    
    CLOSE_4INDEX = copy(INDEX_ONE_ALL)
    CLOSE_4INDEX[, ':='(source='IFRC', codesource=code)]
    CLOSE_4INDEX = CLOSE_4INDEX[order(code, date)]
    CLOSE_4INDEX[, ":="(change=close-shift(close), varpc=100*rt)]
    CLOSE_4INDEX[, name:=gsub('  ',' ', gsub(paste(INDEX_DUPL,INDEX_DUPL), INDEX_DUPL, name))]
    
    CLOSE_4INDEX[, cur:=substr(code, nchar(code)-2, nchar(code))]
    CLOSE_4INDEX[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
    CLOSE_4INDEX[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
    CLOSE_4INDEX[, updated:=SYS.TIME()]
    
    My.Kable.TB(CLOSE_4INDEX)
    My.Kable.All(unique(CLOSE_4INDEX[order(code, -date)], by='code'))
    
    CCPR_SAVERDS(CLOSE_4INDEX, paste0('S:/STKVN/INDEX_2024/'), BEQIND_NAME_VND, ToSummary = T, SaveOneDrive = T)
    
    try(IFRC_INDEXES_CONVERT_CURRENCIES_FROM_USDVND(IND_FOLDER   = 'S:/STKVN/INDEX_2024/', CUR_FROM = 'VND', ISO2 = "VN",
                                                    IND_PREFIX_NAME = '', 
                                                    IND_FROMCUR  = BEQIND_NAME_VND,
                                                    IND_FILENAME = BEQIND_NAME_VND))
    
    ALL_4INDEX = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', BEQIND_NAME_VND, ToKable = T, ToRestore = T)))
    ALL_4INDEX[, ':='(codesource=code, source='IFRC', iso2='VN', continent='ASIA', country='VIETNAM', provider='IFRC')]
    
    IND_PREFIX = INDEX_NAME
    ALL_4INDEX[cur!='VND', name:=paste0(IND_PREFIX, ' ', prtr, ' ', wgtg, ' ', '(', cur, ')')]
    ALL_4INDEX[, short_name:=gsub('IFRC/BEQ HOLDINGS','', name)]
    ALL_4INDEX[, updated:=SYS.TIME()]
    
    My.Kable.TB(ALL_4INDEX[, -c('iso2', 'country', 'continent', 'monitor', 'type', 'codesource', 'name')][order(date, code)][cur=='VND'], Nb=10)
    My.Kable.TB(ALL_4INDEX[, -c('iso2', 'country', 'continent', 'monitor', 'type', 'codesource', 'name')][order(date, code)][cur!='VND'], Nb=10)
    My.Kable.TB(ALL_4INDEX[, -c('iso2', 'country', 'continent', 'monitor', 'type', 'codesource', 'name')][order(date, code)], Nb=10)
    
    CCPR_SAVERDS(ALL_4INDEX, 'S:/STKVN/INDEX_2024/', BEQIND_NAME_HST, ToSummary = T, SaveOneDrive = T)
    
    # ***
    # ADD INSREF
    DBL_RELOAD_INSREF(ToForce = T)
    sort(names(ins_ref))
    IND_INSREF = ins_ref[type=='IND' & grepl('IFRC', provider, ignore.case=T) & !grepl('VOLATILITY|FEAR|SENTIMENT', provider) & 
                           grepl(SEARCH_INSREF, name, ignore.case = T)][, .(provider, fcat, scat, code, name, short_name, cur, prtr, wgtg)]
    My.Kable.All(IND_INSREF)
    ALL_4INDEX_INREF = ALL_4INDEX[, .(type='IND', provider='IFRCLAB', fcat='INDVN', scat='EQUITY',
                                      name=name[1], short_name=short_name[1], cur=cur[1], prtr=prtr[1], wgtg=wgtg[1], last=close[.N], records=.N, 
                                      startdate=date[1], enddate=date[.N], date=date[.N], base_value=close[1], base_date=date[1], active=1), by='code']
    My.Kable.All(ALL_4INDEX_INREF[, -c('type', 'fcat', 'scat', 'active')])
    
    ALL_4INDEX_INREF_NEW = ALL_4INDEX_INREF[!code %in% ins_ref$code]
    
    My.Kable.All(ALL_4INDEX_INREF_NEW[, -c('type', 'fcat', 'scat', 'active')], l.Text='NEW')
    
    if (nrow(ALL_4INDEX_INREF_NEW)>0)
    {
      # names(ins_ref)[12]
      N0      = nrow(ins_ref)
      ins_ref = rbind(ins_ref, ALL_4INDEX_INREF_NEW[, base_date:=as.character(base_date)], fill=T)
      N1      = nrow(ins_ref)
      CATln_Border(paste(N1-N0, 'new records'))
      CCPR_SAVERDS(ins_ref, UData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
      CCPR_SAVERDS(ins_ref, CCPRData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
      CCPR_SAVERDS(ins_ref, 'S:/CCPR/DATA/', 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    }
    Data_Compo = MERGE_DATASTD_BYCODE(Data_Compo, pOption='FINAL')
    Data_Compo[, capivnd:=sharesout*close]
    Data_Compo[, updated:=SYS.TIME()]
    Data_Compo[, index_name:=INDEX_NAME]
    Data_Compo[, index_code:=INDEX_FCODE]
    My.Kable(Data_Compo[, .(index_code, index_name, code, name, market, date, sharesout, reference, close, capivnd, updated)][order(date, capivnd)])
    
    CCPR_SAVERDS(Data_Compo, 'S:/STKVN/INDEX_2024/', BEQIND_NAME_CMP, ToSummary = T, SaveOneDrive = T)
  } else {
    CATln_Border('ALREADY DONE.')
  }
  
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('BEQ_INDEX_2024 >', INDEX.NAME), pAction="SAVE", NbSeconds=1, ToPrint=F))
  # x = try(CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste('BEQ_INDEX_2024 >', INDEX.NAME), pAction="SAVE", NbSeconds=3600, ToPrint = T))
  CATln_Border(paste('BEQ_INDEX_2024 =', INDEX.NAME, ' - END.'))
  
  x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', BEQIND_NAME_HST, ToKable = T, ToRestore = T)))
  return(x)
}

# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_RESEARCH = function ( pOption = '' , 
                                             pHost = 'dashboard_live', MaxDateCompo = Sys.Date(),
                                             UpdateOverview = F,
                                             UpdateChart = F ,
                                             UpdateCompo = F,
                                             UpdateFigures = F,
                                             UpdateSpecs = F,
                                             Minutes = 5)  {
  DBL_RELOAD_INSREF()
  # TEST ---------------------------------------------------------------------------------------------  
  
  switch ( pOption, 
           'LOGISTICS'       = { pFactor = 'log' } ,
           'BROKERAGE'       = { pFactor = 'brk' } ,
           'PETROLIMEX'      = { pFactor = 'pet' } ,
           'REALESTATE'      = { pFactor = 'rst' } ,
           'RETAIL'          = { pFactor = 'rtl' } ,
           'BANK'            = { pFactor = 'bnk' } ,
           'HEALTHCARE'      = { pFactor = 'hlc' } ,
           'ENERGY'          = { pFactor = 'eny' } ,
           'FINANCE'         = { pFactor = 'fin' } ,
           'AI'              = { pFactor = 'ari' } 
  )
  
  
  # calculate performance
  if (UpdateOverview) {
    try (  CALCULATE_UPLOAD_BEQ_INDEX_2024 (INDEX.NAME= pOption, ToCheckDate = T, ToUpload = F , Minutes = Minutes))
  }
  
  # charts
  if (UpdateChart) {
    if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>CHARTS' ), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
    {
      # try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= paste0('ccpi_dashboard_ind',pFactor,'_history'),
      #                                  l.filepath= tolower(paste0('S:/STKVN/INDEX_2024/',  paste0('beq_ind',pFactor,'als_history.rds') ) ),
      #                                  CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
      UPLOAD_RDS_TO_SQL (Connexion = pHost,  host = '', user = "", password = "", 
                         SQL_str = "", 
                         SQL_file = '', 
                         pSleep = 1,
                         ToReplace = F, PARAM_REPLACE = list( ) ,
                         RDS_folder = 'S:/STKVN/INDEX_2024/', RDS_file = paste0('beq_ind',pFactor,'als_history.rds'), SQL_table = paste0('ccpi_dashboard_ind',pFactor,'_history')) 
      
      x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>CHARTS' ), pAction="SAVE",   NbSeconds=0, ToPrint=T)
      
    }  else { CATln_Border(paste(paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>CHARTS' ), 'SKIP')) } 
  }
  
  # compo
  if (UpdateCompo){
    if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>COMPO' ), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
    {
      z = try ( TRAINEE_DASHBOARDLIVE_CCPI_STKVN_COMPO (pOption ='ICB', Compo_Folder = 'S:/STKVN/INDEX_2024/',
                                                        Compo_File =  paste0('beq_ind',pFactor,'als_compo.rds'),
                                                        Index_Code = '',
                                                        ToFolder = 'S:/CCPR/DATA/DASHBOARD_LIVE/' , ToFile = paste0( 'ccpi_dashboard_ind',pFactor,'_compo.rds' ),
                                                        ToSave = T, ToUpload = T,  pHost = pHost,
                                                        Compo_Date = MaxDateCompo ) )
      x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>COMPO' ), pAction="SAVE",    NbSeconds=0, ToPrint=T)
      
    }  else { CATln_Border(paste(paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>COMPO' ), 'SKIP')) } 
  }
  
  # figures for 2nd page
  if (UpdateFigures) {
    if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>FIGURES' ), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
    {
      y = try( TRAINEE_CCPI_DASHBOARD_FIGURES ( pFolder = 'S:/STKVN/INDEX_2024/', pFile = paste0( 'beq_ind',pFactor,'als_history.rds' ),
                                                ToFolder = 'S:/CCPR/DATA/DASHBOARD_LIVE/' , ToFile  = paste0(tolower(pOption), '_figures.rds'),
                                                FolderMerge = 'S:/CCPR/DATA/DASHBOARD_LIVE/', FileMerge = 'FIGURES_ALL.rds',
                                                ToSave = T,
                                                ToIntergration = T, ToUpload = T , pDate = Sys.Date() , pHost = pHost) )
      x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>FIGURES' ), pAction="SAVE",    NbSeconds=0, ToPrint=T)
      
    }  else { CATln_Border(paste(paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>FIGURES' ), 'SKIP')) } 
  }
  
  # specs for 2nd page
  if (UpdateSpecs) {
    if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>SPECS' ), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
    {
      x = try( TRAINEE_CCPI_DASHBOARD_SPECIFICATIONS (pFolder = 'S:/STKVN/INDEX_2024/', pFile =  paste0('beq_ind',pFactor,'als_history.rds' ) ,
                                                      ToFolder = 'S:/CCPR/DATA/DASHBOARD_LIVE/' , ToFile  = paste0(tolower(pOption), '_specifications.rds'),
                                                      FolderMerge = 'S:/CCPR/DATA/DASHBOARD_LIVE/', FileMerge = 'SPECIFICATIONS_ALL.rds',
                                                      ToSave = T, ToMerge  = T, ToUpload = T  , pHost = pHost) )
      x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>SPECS' ), pAction="SAVE",    NbSeconds=0, ToPrint=T)
      
    }  else { CATln_Border(paste(paste0('TRAINEE_DASHBOARD_LIVE_RESEARCH>',pOption,'>SPECS' ), 'SKIP')) } 
  }
  
  
  
}

# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_DIV = function (pOptions = '', Minutes = 5)   {
  # ------------------------------------------------------------------------------------------------
  
  DBL_RELOAD_INSREF()
  # TEST ---------------------------------------------------------------------------------------------  
  if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_DIV>',pOptions ), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
  {
    
    switch ( pOptions, 
             'WHERE_TO_INVEST'  =  {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = pOptions, Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', 
                                                              Fr_File = 'ifrc_ccpr_investment_history.rds',
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_wti.rds', 
                                                              DateLimit = Sys.Date()  ,
                                                              ToAddBenchmark = F, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'WORLD_EQUITIES_INDEX'  = {
               data = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'WORLD_EQUITIES_INDEX', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/', 
                                                                     Fr_File = 'CCPR_WORLDINDEXES_HISTORY.rds',
                                                                     To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'dbl_indworld_performance.rds', 
                                                                     DateLimit = Sys.Date() ,
                                                                     ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                                     ToSave = F, ToUpload = F , pHost = 'dashboard_live_bat') )
               
               DATA_OLD = CHECK_CLASS (try (CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/',  'dbl_indworld_performance.rds')))
               MY_DATA = unique( rbind (DATA_OLD, data, fill = T), fromLast = T, by = 'code')
               CCPR_SAVERDS(MY_DATA [!is.na (close)],'S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indworld_performance.rds', ToSummary = T, SaveOneDrive = T)   
               
               try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= gsub(".rds","",'dbl_indworld_performance.rds'),
                                                l.filepath= paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'dbl_indworld_performance.rds' ) ,
                                                CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
             },
             'CCPI_VIETNAM_STOCKS'  = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_VIETNAM_STOCKS', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/PRICES/FINAL/', 
                                                              Fr_File = 'IFRC_CCPR_STKVN_FOR_DASHBOARD.RDS',
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_stkvn.rds', 
                                                              DateLimit = Sys.Date()  , ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_VIETNAM_INDEXES'  = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_VIETNAM_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/INDEX_2024/', 
                                                              Fr_File =  paste0('beq_ind','vn','_history.rds' )  ,
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indvn.rds', 
                                                              DateLimit = Sys.Date(), ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_VIETNAM_TRADABLE_INDEXES'  = { 
               try(TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_VIETNAM_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/', 
                                                             Fr_File = 'ifrc_ccpr_tradable_indvn_history.rds',
                                                             To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_tradable.rds', 
                                                             DateLimit = Sys.Date()  , ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                             ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_CUSTOMISED_INDEXES' = {
               try (  TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_CUSTOMISED_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/', 
                                                                Fr_File = 'ifrc_ccpr_indcs_history.rds',
                                                                To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indcs.rds', 
                                                                DateLimit = Sys.Date()  ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                                ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_INTERNATIONAL_INDEXES' = {
               try(TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/', 
                                                             Fr_File = 'download_ifrc_indetf_history.rds',
                                                             To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indetf.rds', 
                                                             DateLimit = Sys.Date() ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                             ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat'))
             },
             'CCPI_CRYPTO_INDEXES' = {
               try (TRAINEE_DASHBOARD_LIVE_CRYPTO  ( Data = data.table(), Folder = 'S:/CCPR/DATA/',
                                                     File   = 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', EndDate  = Sys.Date()  , 
                                                     ToSave = T, ToFolder = 'S:/CCPR/DATA/DASHBOARD_LIVE/' , ToFile = 'ccpi_dashboard_crypto.rds' ,
                                                     ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_RESEARCH_INDEXES' = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_RESEARCH_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/', 
                                                              Fr_File =  paste0('DOWNLOAD_IFRC_INDPOR_HISTORY.rds' )  ,
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indpor.rds', 
                                                              DateLimit = Sys.Date(), ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_WCEO_VIETNAM' = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/WCEO_INDEXES/', 
                                                              Fr_File = 'CCPR_INDVNWCEO_HISTORY.rds',
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indvnwceo.rds', 
                                                              DateLimit = Sys.Date()  ,
                                                              ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_WCEO_US' = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/WCEO_INDEXES/USA/' , 
                                                              Fr_File =   "ifrc_ccpr_indwceousa_history.rds",
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indwceous.rds', 
                                                              DateLimit = Sys.Date()  ,
                                                              ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_WCEO_INTERNATIONAL' = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/', 
                                                              Fr_File = 'IFRC_CCPR_INDWCEOIN_HISTORY.RDS',
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = 'ccpi_dashboard_indinwceo.rds', 
                                                              DateLimit = Sys.Date()  ,
                                                              ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = T, ToUpload = T , pHost = 'dashboard_live_bat') )
             },
             'CCPI_INTERNATIONAL_STOCKS' = {
               try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_STOCKS', Fr_Data = YAH_STK,  Fr_Folder = UData, 
                                                              Fr_File = paste0('download_yah_stkhome_history.rds'),
                                                              To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_stkin.rds'), 
                                                              DateLimit = Sys.Date()  ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                              ToSave = F, ToUpload = F , pHost = 'dashboard_live_bat') )
             }
    )
    x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_LIVE_DIV>',pOptions ), pAction="SAVE",   NbSeconds=0, ToPrint=T)
  } else { CATln_Border(paste(paste0('TRAINEE_DASHBOARD_LIVE_DIV>',pOptions ), 'SKIP')) }
  
}

# ==================================================================================================
TRAINEE_STKVN_FOR_DASHBOARD_OLD = function()  {
  # ------------------------------------------------------------------------------------------------
  STKVN_SHARES = CCPR_READRDS('S:/STKVN/PRICES/FINAL/', 'FINAL_STKVN_SHARESOUT_4INDEX_HISTORY.rds', ToKable = T, ToRestore = T)
  STKVN_SHARES[, sharesout:=as.numeric(sharesout)]
  My.Kable(STKVN_SHARES[order(date, code)])
  
  # PRICES ............................................................................................
  STKVN = CCPR_READRDS(UData, 'DOWNLOAD_CAF_STKVN_HISTORY.rds', ToKable = T, ToRestore = T)
  My.Kable(STKVN[order(date, code)][, .(market, code, date, reference, close, rt, change, varpc)])
  
  STKVN = STKVN[order(code, date)]
  STKVN[, close_unadj:=close]
  STKVN[, varpc:=100*rt]
  My.Kable(STKVN[order(date, code)][, .(market, code, date, reference, close, close_unadj, rt, change, varpc)][code=='STKVNVIC'])
  
  SHARES = CCPR_READRDS(UData, 'IFRC_STKVN_4INDEX.rds', ToKable = T, ToRestore = T)
  SHARES = SHARES[, .(market, code, date, shares, shareslis, sharesout, rtd)]
  
  Compo = merge(STKVN[, -c('market')], SHARES, all.x=T, by=c('code', 'date'))
  My.Kable(Compo[order(date, code)][, .(market, code, date, reference, close, close_unadj, rt, change, varpc, shares, shareslis, sharesout)][code=='STKVNVIC'])
  My.Kable(Compo[order(date, code)][, .(market, code, date, reference, close, close_unadj, rt, change, varpc, shares, shareslis, sharesout)])
  
  STKVN_PRICES = copy(Compo)
  STKVN_PRICES = merge(STKVN_PRICES[, -c('new')], STKVN_SHARES[, .(code, date, new=sharesout)], all.x = T, by=c('code', 'date'))
  STKVN_PRICES[!is.na(new) & is.na(sharesout), sharesout:=new]
  STKVN_PRICES[!is.na(new) & is.na(shares), shares:=new]
  My.Kable(STKVN_PRICES[order(date, code)][, .(market, code, date, reference, close, close_unadj, rt, change, varpc, shares, shareslis, sharesout)][code=='STKVNVIC'])
  My.Kable(STKVN_PRICES[order(date, code)][, .(market, code, date, reference, close, close_unadj, rt, change, varpc, shares, shareslis, sharesout)])
  
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(9, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  STKVN_PRICES     = STKVN_PRICES[date<=LastTrading]
  
  STKVN_PRICES     = STKVN_PRICES[market %in% list('HSX', 'HNX')]
  MinDate          = min(STKVN_PRICES$date)
  MinDate          = '2000-12-31'
  
  Start.Date       = max(STKVN_PRICES[year(date)==year(MinDate)]$date)
  Compo            = STKVN_PRICES[date>=Start.Date][order(date)]
  Compo[date==Start.Date, rt:=0]
  
  Compo = Compo[order(code, date)][!is.na(rt)]
  
  Compo %>%
    group_by(code) %>%
    mutate(wgtrt.unit = order_by(date,cumprod(1+rt))) -> Compo
  Compo = setDT(Compo)
  My.Kable(Compo)
  # My.Kable(Compo[code =='STKVNVIC'][, .(code, date, close, close_unadj, rt, wgtrt.unit, rtc_adj)], Nb=10)
  # Compo
  Compo[, rtc_adj:=wgtrt.unit/wgtrt.unit[1], by='code']
  My.Kable(Compo[code =='STKVNVIC'][, .(code, date, reference, close, close_unadj, rt, rtd, wgtrt.unit, rtc_adj)], Nb=10)
  
  Compo[, rtc_inv:=rtc_adj/rtc_adj[.N], by='code']
  My.Kable(Compo[code =='STKVNVIC'][, .(code, date, reference, close, close_unadj, rt, rtd, wgtrt.unit, rtc_adj, rtc_inv)], Nb=10)
  
  Compo[, close_end:=close[.N], by='code']
  Compo[, close_adj:=close_end*rtc_inv, by='code']
  
  Compo = Compo[order(code, date)]
  Compo = Compo[, rt_adj:=(close_adj/shift(close_adj))-1, by='code']
  Compo = Compo[, lchange:=(close-shift(close)), by='code']
  Compo = Compo[order(code, date)]
  My.Kable(Compo[, .(market, code, date, reference, close_end, close, close_adj, close_unadj, lchange, rt, wgtrt.unit, rtc_adj, rtc_inv, rt_adj)], Nb=10)
  
  Compo = TRAINEE_SMOOTH_BEFOREAFTER_EQUAL(pFile="", pData=Compo, InCol="shares", ByGroup="code", ToReplace=T, ToReSave="")
  Compo = TRAINEE_SMOOTH_BEFOREAFTER_EQUAL(pFile="", pData=Compo, InCol="sharesout", ByGroup="code", ToReplace=T, ToReSave="")
  Compo = TRAINEE_SMOOTH_BEFOREAFTER_EQUAL(pFile="", pData=Compo, InCol="shareslis", ByGroup="code", ToReplace=T, ToReSave="")
  Compo = Compo[order(code, date)]
  My.Kable(Compo[code=='STKVNVIC'][, .(market, code, date, sharesout, shares, shareslis, close_end, close, close_adj, close_unadj, rt, wgtrt.unit, rtc_adj, rtc_inv, rt_adj)], Nb=10)
  # Compo[, last.change:=(close-shift(close)), by='code']
  
  Last_compo = unique(Compo[order(code, -date)], by='code')[, .(code, date, last_close=close, last_change=lchange)]
  Compo = merge(Compo[, -c('last_close', 'last_change')], Last_compo, all.x=T, by=c('code', 'date'))
  # Compo[, last_close[is.na(last_close)] := close_end[order(date)][, .SD[.N]], by = 'code']
  
  STKVN_FINAL = Compo[, .(market, code, date, sharesout, shares, shareslis, reference, close_end, close, close_adj, close_unadj, last_close, rt, wgtrt.unit, rtc_adj, rtc_inv, rt_adj, last_change)]
  STKVN_FINAL[, capibvnd:=sharesout*close_unadj/1000000000]
  STKVN_FINAL[, change:=(close_unadj-reference)]
  STKVN_FINAL[, varpc:=100*rt]
  My.Kable(STKVN_FINAL[code=='STKVNVIC'])
  
  STKVN_FINAL_DAHBOARD = STKVN_FINAL[, .(market, code, date, reference, shares, sharesout, close, close_unadj, last_close, last_change, change, last_capibvnd=capibvnd, capibvnd, close_adj, rt, rt_adj, varpc)]
  My.Kable.TB(STKVN_FINAL_DAHBOARD[code=='STKVNVIC'], Nb=5)
  My.Kable.TB(STKVN_FINAL_DAHBOARD[code=='STKVNREE'], Nb=5)
  My.Kable.TB(STKVN_FINAL_DAHBOARD[code=='STKVNFPT'], Nb=5)
  
  CCPR_SAVERDS(STKVN_FINAL_DAHBOARD, 'S:/STKVN/PRICES/FINAL/', 'IFRC_CCPR_STKVN_FOR_DASHBOARD.rds', ToSummary = T, SaveOneDrive = T)
}

# ==================================================================================================
TRAINEE_STKVN_FOR_DASHBOARD = function()  {
  # ------------------------------------------------------------------------------------------------
  STKVN_SHARES = CCPR_READRDS('S:/STKVN/PRICES/FINAL/', 'FINAL_STKVN_SHARESOUT_4INDEX_HISTORY.rds', ToKable = T, ToRestore = T)
  STKVN_SHARES[, sharesout:=as.numeric(sharesout)]
  # My.Kable(STKVN_SHARES[order(date, code)])
  
  # PRICES ............................................................................................
  STKVN = CCPR_READRDS("S:/STKVN/PRICES/DAY/", paste0("download_caf_stkvn_pricesday_history.rds"))
  STKVN_CAF = CCPR_READRDS(UData, 'DOWNLOAD_CAF_STKVN_HISTORY.rds', ToKable = T, ToRestore = T)
  STKVN_FINAL = CCPR_READRDS("S:/STKVN/PRICES/FINAL/", paste0("FINAL_STKVN_4INDEX_HISTORY.rds"))
  STKVN = unique(rbind(STKVN_FINAL, STKVN_CAF, STKVN, fill=T),by=c("code","date"))
  STKVN = STKVN[code %in% STKVN_FINAL$code]
  GC_SILENT()
  # My.Kable(STKVN[order(date, code)][, .(market, code, date, reference, close, rt, change, varpc)])
  
  STKVN = STKVN[order(code, date)]
  STKVN[is.na(rt), rt:=close/reference -1,by="code"]
  
  STKVN[, close_unadj:=close]
  STKVN[, varpc:=100*rt]
  # My.Kable(STKVN[order(date, code)][, .(market, code, date, reference, close, close_unadj, rt, change, varpc)][code=='STKVNVIC'])
  
  SHARES = CCPR_READRDS(UData, 'IFRC_STKVN_4INDEX.rds', ToKable = T, ToRestore = T)
  SHARES[, shareslis := sharesout]
  SHARES = unique(SHARES[!is.na(sharesout), .(code, date, shares, shareslis, sharesout)],by=c("code","date"))
  
  Compo = merge(STKVN[, -c('sharesout','shareslis','shares')], SHARES, all.x=T, by=c('code', 'date'))
  GC_SILENT()
  
  STKVN_PRICES = copy(Compo)
  STKVN_PRICES = merge(STKVN_PRICES[, -c('new')], STKVN_SHARES[, .(code, date, new=sharesout)], all.x = T, by=c('code', 'date'))
  STKVN_PRICES[!is.na(new) & is.na(sharesout), sharesout:=new]
  STKVN_PRICES[!is.na(new) & is.na(shares), shares:=new]
  GC_SILENT()
  
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(17, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  STKVN_PRICES     = STKVN_PRICES[date<=LastTrading]
  
  STKVN_PRICES     = STKVN_PRICES[code %in% STKVN_FINAL[market %in% list('HSX', 'HNX')]$code]
  MinDate          = min(STKVN_PRICES$date)
  MinDate          = '2000-12-31'
  
  Start.Date       = max(STKVN_PRICES[year(date)==year(MinDate)]$date)
  Compo            = STKVN_PRICES[date>=Start.Date][order(date)]
  Compo[date==Start.Date, rt:=0]
  Compo = Compo[abs(rt)<0.2]
  Compo = Compo[order(code, date)][!is.na(rt)]
  
  Compo %>%
    group_by(code) %>%
    mutate(wgtrt.unit = order_by(date,cumprod(1+rt))) -> Compo
  Compo = setDT(Compo)
  My.Kable(Compo)
  # Compo
  Compo[, rtc_adj:=wgtrt.unit/wgtrt.unit[1], by='code']
  
  Compo[, rtc_inv:=rtc_adj/rtc_adj[.N], by='code']
  
  Compo[, close_end:=close[.N], by='code']
  Compo[, close_adj:=close_end*rtc_inv, by='code']
  
  Compo = Compo[order(code, date)]
  Compo = Compo[, rt_adj:=(close_adj/shift(close_adj))-1, by='code']
  Compo = Compo[, lchange:=(close-shift(close)), by='code']
  Compo = Compo[order(code, date)]
  # My.Kable(Compo[, .(market, code, date, reference, close_end, close, close_adj, close_unadj, lchange, rt, wgtrt.unit, rtc_adj, rtc_inv, rt_adj)], Nb=10)
  
  Compo = TRAINEE_SMOOTH_BEFOREAFTER_EQUAL(pFile="", pData=Compo, InCol="shares", ByGroup="code", ToReplace=T, ToReSave="")
  Compo = TRAINEE_SMOOTH_BEFOREAFTER_EQUAL(pFile="", pData=Compo, InCol="sharesout", ByGroup="code", ToReplace=T, ToReSave="")
  Compo = TRAINEE_SMOOTH_BEFOREAFTER_EQUAL(pFile="", pData=Compo, InCol="shareslis", ByGroup="code", ToReplace=T, ToReSave="")
  Compo = Compo[order(code, date)]
  
  Last_compo = unique(Compo[order(code, -date)], by=c('code','date'))[, .(code, date, last_close=close, last_change=lchange)]
  Compo = merge(Compo[, -c('last_close', 'last_change')], Last_compo, all.x=T, by=c('code', 'date'))
  
  STKVN_FINAL = Compo[, .(ticker, market, code, date, sharesout, shares, shareslis, reference, close_end, close,
                          close_adj, close_unadj, last_close, rt, wgtrt.unit, rtc_adj, rtc_inv, rt_adj, last_change, volume)]
  STKVN_FINAL[, capibvnd:=sharesout*close_unadj/1000000000]
  STKVN_FINAL[, change:=(close_unadj-reference)]
  STKVN_FINAL[, varpc:=100*rt]
  
  STKVN_FINAL_DAHBOARD = STKVN_FINAL[, .(ticker, code, date, market, reference, shares, sharesout, close=close_adj, close_unadj,
                                         last_close, last_change, change, last_capibvnd=capibvnd, capibvnd, close_adj, rt, rt_adj, varpc, volume)]
  # My.Kable.TB(STKVN_FINAL_DAHBOARD[date == max(date)], Nb=5)
  
  icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
  STKVN_FINAL_DAHBOARD  = merge(STKVN_FINAL_DAHBOARD, icb[,.(code,sector = toupper(icb1_name), industry = toupper(icb2_name), 
                                                             sub_ind = toupper(icb3_name), icb4 = toupper(icb4_name))], all.x = T, by = 'code')
  
  STKVN_FINAL_DAHBOARD = STKVN_FINAL_DAHBOARD[order(-capibvnd)]
  STKVN_FINAL_DAHBOARD[, sum_capi:=sum(capibvnd,na.rm = T), by='date']
  STKVN_FINAL_DAHBOARD[, cum_capi:=cumsum(capibvnd), by='date']
  STKVN_FINAL_DAHBOARD[, pc_capi:=100*cum_capi/sum_capi, by='date']
  STKVN_FINAL_DAHBOARD[pc_capi<=85, size:='LARGE']
  STKVN_FINAL_DAHBOARD[pc_capi>85 & pc_capi<=95, size:='MID']
  STKVN_FINAL_DAHBOARD[pc_capi>95, size:='SMALL']
  STKVN_FINAL_DAHBOARD$pc_capi = NULL
  STKVN_FINAL_DAHBOARD$cum_capi = NULL
  STKVN_FINAL_DAHBOARD$sum_capi = NULL
  
  CCPR_SAVERDS(STKVN_FINAL_DAHBOARD[order(code,date)], 'S:/STKVN/PRICES/FINAL/', 'IFRC_CCPR_STKVN_FOR_DASHBOARD.rds', ToSummary = T, SaveOneDrive = T)
  return(STKVN_FINAL_DAHBOARD)
}

#===================================================================================================
TRAINEE_SMOOTH_BEFOREAFTER_EQUAL = function(pFile="", pData=data.table(), InCol="sharesout", ByGroup="code", ToReplace=F, ToReSave=""){
  # ------------------------------------------------------------------------------------------------
  
  if (nchar(pFile)>0)
  {
    pData = DATACENTER_LOADDTRDS_REPEAT(pFile)
  } else { pData = pData }
  
  # pData = stkcst
  if (nrow(pData)>0)
  {
    pParseCode  = ByGroup
    pParseCode
    
    sort(names(pData))
    
    # ORDER:
    pParseTextO = paste0("order(", ByGroup,", date)")
    pParseTextO
    pData = pData[eval(parse(text = pParseTextO))] 
    # My.Kable.MaxCols(pData)
    
    # CREATE TEMPORARY FIELD:
    pParseTextF = paste0("temp_field:=", InCol) 
    pData[, eval(parse(text = pParseTextF))] 
    
    # str(pData) 
    
    # SMOOTH FORWARD/BACKWARD:
    pData[, value_l:=temp_field]
    pData[, value_b:=temp_field]
    
    # pData = setDT(pData %>% 
    #                group_by(code) %>% 
    #                fill(value_l) %>% #default direction down
    #                fill(value_b, .direction = "up"))
    pData = setDT(pData %>% 
                    group_by(eval(parse(text = ByGroup))) %>% 
                    fill(value_l) %>% #default direction down
                    fill(value_b, .direction = "up"))
    
    pData[, value_final:=temp_field]
    pData[value_l==value_b, value_final:=value_l]
    
    pParseText_Show = paste0(".(code, date, ", InCol, ", value_final, value_l, value_b)")
    pParseText_Show
    # My.Kable(pData[!is.na(value_final) & is.na(eval(parse(text = InCol))), 
    #                eval(parse(text = pParseText_Show))])
    if (ToReplace)
    {
      pParseText_Condition = paste0("is.na(", InCol,") & !is.na(value_final)") 
      pParseText_Condition
      
      pParseText_Replace   = paste0(InCol,":=value_final") 
      pParseText_Replace
      
      pData[eval(parse(text = pParseText_Condition)), eval(parse(text = pParseText_Replace))]
      My.Kable.MaxCols(pData[code=='' & date==''])
      pData = pData[, -c('value_final', "value_l", "value_b")]
      
      if (nchar(ToReSave)>0)
      {
        DATACENTER_SAVEDTRDS(pData, ToReSave)
      }
    }
  }
  return(pData)
}

# ==================================================================================================
REPORT_WCEO = function(Action='CHECK DOWNLOAD DATA', ToSave = T,  SaveTo = '',
                       list_country = list('AUS', 'FRA', 'BEL', 'HKG', 'CHN', 'IDN', 'IRL', 'ITA', 'JPN', 'MYS', 'NOR', 'SGP', 'THA', 'TWN', 'PRT', 'DEU', 'NLD'))
{
  Display_All = data.table()
  switch(Action,
         'CHECK DOWNLOAD DATA' = {
           
           Data_list = list()
           k = 0
           for (pCountry in list_country)
           {
             k = k+1
             Final_Data = data.table()
             rm(data, NCodes, NDates, NDate1)
             # pCountry  = 'SGP'
             # pCountry  = 'FRA'
             File_name = 'PRICES_FINAL_DAY.rds'
             data      = CHECK_CLASS(try(CCPR_READRDS(paste0('S:/SHINY/INDEX/WOMENCEO/', pCountry, '/'), File_name, ToKable = T)))
             
             if (nrow(data)>0)
             {
               NCodes    = nrow(unique(data[!is.na(codesource)], by='codesource'))
               NDates    = data[!is.na(codesource)][order(codesource, date)][, .(n=.N, start=date[1], end=date[.N]), by='codesource']
               NDate1    = NDates[, .(records=sum(n), start=min(start), end=max(end))]
               Final_Data = cbind(data.table(iso3=pCountry), data.table(codes=NCodes), NDate1)
               My.Kable.All(Final_Data)
               Data_list[[k]] = Final_Data
             } else{
               Data_list[[k]] = data.table(iso3=pCountry)
             }
           }
           All_List     = rbindlist(Data_list, fill=T)
           Display_All  = data.table()
           
           # Number ............................................................................................
           Display_List = All_List[, .(iso3, date=as.character(codes))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='DATA CODES'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           # Dates ............................................................................................
           Display_List = All_List[, .(iso3, date=as.character(start))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='DATA START'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           Display_List = All_List[, .(iso3, date=as.character(end))]
           names_data   = as.vector(Display_List$iso3)
           data         = setDT(transpose(Display_List)[-1,])
           names(data)  = names_data
           data        = cbind(data.table(dataset='DATA END'), data)
           My.Kable(data)
           Display_All = rbind(Display_All, data, fill=T)
           
           # Updated ............................................................................................
           Display_All [, updated := SYS.TIME()]
           My.Kable.All(Display_All)
         }
  )
  
  if (ToSave) { saveRDS (Display_All, SaveTo)
    CATln(''); CATln_Border(paste('SAVED TO: ',SaveTo) ); CATln('')
  }
  if (nrow(Display_All)>0) { 
    CATln(''); CATln_Border('FINALLY '); CATln('')
    My.Kable.All(Display_All)}
  return(Display_All)
}

# ==================================================================================================
TRAINEE_MERGE_STKVN_BOARD_DAY_OLD_2 = function (  Fr_Folder =  paste0('S:/STKVN/BOARD/DAY/') ,
                                                  pFolder =  paste0(CCPRData, 'IFRC_CCPR/'),
                                                  pReference ='R:/CCPR/DATA/DAY/ccpr_download_all_stkvn_market_day.rds',
                                                  LIST_SOURCES = list( 'VND', 'CAF', 'VST'),
                                                  pPrefix = 'ccpr',  
                                                  CheckDate = '2024-03-29' ,
                                                  ToIntegrateHistory = F) {
  # ------------------------------------------------------------------------------------------------
  
  # MERGE CEO 
  LastTrading = CCPR_LAST_TRADING_DAY_VN(09, ToPrompt = T)
  # LIST_SOURCES = list( 'VND', 'CAF', 'VST')
  DATA_MERGE = data.table()
  pData = list ()
  for (k in 1:length(LIST_SOURCES))
  {
    # k =2
    pSource     = LIST_SOURCES[[k]]
    File_Folder = Fr_Folder
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    # File_Data [code == 'STKVNVNM']
    
    if ( nrow (File_Data) > 0) 
    {
      if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'ceo', 'source') %in% names(File_Data) ) )
      {
        switch (pSource,
                'VND' = {
                  xData = File_Data[, .(code, date, source,gender, value=as.character(people_name))] 
                } ,
                'CAF' = {
                  # File_Data [, rank := seq(.N), by = c(code, '')]
                  # File_Data = readRDS("S:/STKVN/BOARD/DAY/TRAINEE_CAF_BOARD_FULL_DAY.rds") [, date:= as.Date('2024-03-29')]
                  # File_Data [grepl('^CEO|^Chief Executive', source_position), ceo:=1]
                  # File_Data [ is.na(ceo) & category == 'EXECUTIVES' & rank ==1, ceo:=1]
                  # File_Data [ dataset == 'EXECUTIVES']
                  xData = File_Data[, .(code, date, source,gender, value=as.character(people_name))] 
                },
                'VST' = {
                  xData = File_Data[ceo == 1, .(code, date, source,gender, value=as.character(fullname_lc))] 
                }
        )
        
        pData [[k]] = xData
        My.Kable( pData [[k]] )
        Sys.sleep(2)
      }
    }
    
  }
  DATA_MERGE = rbindlist(pData, fill=T)
  DATA_MERGE [, source := as.character (source)]
  
  My.Kable(DATA_MERGE[order(-date, code)])
  
  
  DATA_ALL = unique(DATA_MERGE, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
  unique(DATA_ALL, by = 'source')
  MaxDate   = max(DATA_ALL [!is.na(date)]$date)
  DATA_ALL  = DATA_ALL[date==MaxDate]
  xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_ALL = unique (DATA_ALL, by = c('code','source','value'))
  DATA_SPD = setDT(tidyr::spread(DATA_ALL, key="source", value="value"))[!is.na(code)]
  My.Kable.TB(DATA_SPD[order(date, code)])
  xCOUNT_N2 = xCOUNT[n>=2]
  xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
  DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
  
  DATA_SPD [, ':='(people_name = final, dataset='CEO')]
  if( 'CAF' %in% names(DATA_SPD)) {DATA_SPD [is.na(final), final := CAF] }
  if( 'VST' %in% names(DATA_SPD)) {DATA_SPD [is.na(final), final := VST] }
  if( 'VND' %in% names(DATA_SPD)) {DATA_SPD [is.na(final), final := VND] }
  # DATA_SPD [is.na(people_name)]
  
  # MERGE GENDER --------------------------------------------
  
  CEO_LIST = DATA_SPD [,.(code, people_name = final)]
  CEO_LIST [, name_clean := decodeVN(people_name, from='Unicode', to='Unicode', diacritics=F)]
  DATA_MERGE = CEO_LIST
  File_Data = setDT (read.xlsx('S:/R/DATA/BOARD/LIST/name_with_gender.xlsx'))
  xData = File_Data [,. (name_clean = pname, gender )]
  DATA_MERGE = unique ( merge (DATA_MERGE,xData , all.x = T, by = 'name_clean'), by = 'name_clean' ) [, source := 'EXCEL']
  
  LIST_SOURCES = list( 'VND', 'CAF', 'VST')
  Data = list()
  for (i in 1:length(LIST_SOURCES))
  {
    # i = 2
    pSource     = LIST_SOURCES[[i]]
    File_Folder = Fr_Folder
    
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    File_Data [, gender := trimws(gender)]
    File_Data [gender == 'FEMALE', gender := 'F']
    File_Data [gender == 'MALE', gender := 'M']
    File_Data = File_Data [nchar (code) == 8]
    
    if ( nrow (File_Data) > 0) 
    {
      switch (pSource,
              'VND' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name] [,.( code,source, people_name,  gender)] 
              } ,
              'CAF' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name] [,.(code, source, people_name,  gender)] 
              },
              'VST' = {
                xData = File_Data [fullname_lc %in% CEO_LIST$people_name] [,.(code,source, people_name = fullname_lc,  gender)] 
              }
      )
      Data [[i]] = xData
    }
    
  }
  
  DATA_ALL = rbindlist (Data, fill = T)
  
  DATA_MERGE = rbind (DATA_MERGE[!is.na(people_name)] [,.(people_name, code, gender, source)], DATA_ALL, fill =T)
  
  DATA_MERGE = DATA_MERGE[!is.na(people_name)]
  xCOUNT = DATA_MERGE[!is.na(people_name)][, .(n=.N), by=c('people_name', 'gender')][!is.na(gender)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_MERGE = unique( DATA_MERGE[!is.na(gender)] , by = c('code', 'source' , 'people_name') )
  DATA_SPDg = setDT(tidyr::spread(DATA_MERGE, key="source", value="gender"))[!is.na(code)]
  My.Kable.TB(DATA_SPDg[order(people_name, code)])
  xCOUNT_N2 = xCOUNT[n>=2]
  xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'people_name')
  DATA_GDR = merge(DATA_SPDg, xCOUNT_N2[, .( final = gender, people_name)], all.x=T, by=c('people_name'))
  if( 'EXCEL' %in% names(DATA_GDR)) {DATA_GDR [is.na(final), final := EXCEL] }
  if( 'CAF' %in% names(DATA_GDR)) {DATA_GDR [is.na(final), final := CAF] }
  if( 'VST' %in% names(DATA_GDR)) {DATA_GDR [is.na(final), final := VST] }
  if( 'VND' %in% names(DATA_GDR)) {DATA_GDR [is.na(final), final := VND] }
  DATA_GDR = unique( DATA_GDR, by = 'people_name' )
  # -----------------------------------
  
  DATA_SPD = merge (DATA_SPD [,.(code,date,people_name = final, dataset)], DATA_GDR [,. (people_name, gender = final)], all.x = T, by = 'people_name')
  DATA_SPD [is.na(people_name)]
  unique(DATA_SPD , by ='code')
  # DATA_SPD [code == 'STKVNAAV']
  DATA_SPD [!is.na(people_name)]
  
  market   = readRDS (pReference)
  DATA_SPD = merge (DATA_SPD, market [,.(code, market = final)], all.x = T, by ='code')
  DATA_SPD = unique (DATA_SPD , by = c ('code', 'people_name'))
  DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
  
  My.Kable.TB ( DATA_SPD[order(date, code)])
  My.Kable.TB ( DATA_SPD[order(date, code)][is.na(people_name)])
  
  FileBoard = paste0 (  pPrefix, "_stkvn_board_", gsub('-','',CheckDate),".rds")
  FileWCEO  = paste0 (  pPrefix, "_stkvn_wceo_", gsub('-','',CheckDate),".rds")
  
  saveRDS  (DATA_SPD, paste0 (  pFolder,FileBoard  ) )
  
  DATA_WCEO = DATA_SPD [gender == 'F' & market != 'UPC'] 
  if (nrow (DATA_WCEO >0))
  {
    My.Kable (DATA_WCEO)
    saveRDS  (DATA_WCEO ,paste0 (  pFolder, FileWCEO ) )
  }
  
  if (ToIntegrateHistory) 
  {
    if (nrow (DATA_SPD) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileBoard, ToKable = T, ToRestore = T)
      Data_All = unique(rbind(Data_Old, DATA_SPD, fill=T), by=c('code', 'date'))
      Data_All = MERGE_DATASTD_BYCODE(Data_All, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_All[order(date, code)][, .(source, code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_All, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileBoard),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
    if (nrow (DATA_WCEO) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileWCEO, ToKable = T, ToRestore = T)
      Data_WCEO = unique(rbind(Data_Old, DATA_WCEO, fill=T), by=c('code', 'date'))
      Data_WCEO = MERGE_DATASTD_BYCODE(Data_WCEO, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_WCEO[order(date, code)][, .(source, code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_WCEO, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileWCEO),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
  }
  return (DATA_SPD)
}

# ==================================================================================================
REPORT_MISC = function(ToForce = F){
  # ------------------------------------------------------------------------------------------------
  List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
  LastTrading = CCPR_LAST_TRADING_DAY_VN(16, ToPrompt = T)
  
  for (SOURCE in sample(list( 'VND', 'CAF', 'VPS','C68','DNSE', 'STB'))){
    for (MARKET in sample(list('HNX','HSX','UPC'))){
      for (pFirstChars in sample(List_SetChars)){
        if (ToForce || CHECK_TIMEBETWEEN('17:00' , '23:00') || CHECK_TIMEBETWEEN('12:00' , '14:00') || CHECK_TIMEBETWEEN('01:00' , '05:00')){
          FirstChar = pFirstChars
          x = NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE ( ranking    = '', FirstChars = pFirstChars, random = F,
                                                 pMarket    = MARKET, 
                                                 pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                 File_Pattern  = paste0('DOWNLOAD_',SOURCE,'_STKVN_PRICESDAY_',FirstChar),
                                                 pDate      = LastTrading,
                                                 List_Codes = list(),
                                                 File_Codes = paste0("S:/CCPR/DATA/download_",tolower(MARKET),"_stkvn_ref_history.rds"),
                                                 Action     = paste0('DOWNLOAD_',SOURCE,'_STKVN_PRICESDAY_BY_CODE'))
        }
      }
    }
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VND_STKVN_BOARD_BY_CODE = function(pCode = 'VIC')  {
  # ------------------------------------------------------------------------------------------------
  xData       = data.table()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  
  pURL        = paste0('https://finfo-api.vndirect.com.vn/v4/personnel?q=code:', pCode, '~locale:EN_GB&sort=displayOrder:ASC')
  CATln_Border(pURL)
  x           = jsonlite::fromJSON(pURL)
  
  xData = try(as.data.table(x$data))
  if (all(class(xData)!='try-error'))
  {
    xData     = CLEAN_COLNAMES(xData)
    xData$gender = as.character(NA)
    xData$ceo    = as.numeric(NA)
    xData$cob    = as.numeric(NA)
    xData[grepl('Mr.', salution), gender:='MALE']
    xData[grepl('Ms.', salution), gender:='FEMALE']
    xData[grepl('Mrs.', salution), gender:='FEMALE']
    xData[, ticker:=code]
    xData[, code:=paste0('STKVN', ticker)]
    xData[, date:=as.Date(LastTrading)]
    xData[, updated:=SYS.TIME()]
    setnames(xData, 'name', 'people_name')
    xData[,people_name_en:=vietnameseConverter::decodeVN(people_name, from='Unicode', to='Unicode', diacritics=F)]
    xData[,age:=year(Sys.Date())-as.numeric(yearofbirth )]
    xData[position=='CEO',ceo:=1]
    xData[position=='Chairman',cob:=1]
    xData[ceo==1 & gender=='FEMALE',wceo:=1]
    My.Kable.All(xData[, .(ticker, code, date, gender, people_name, people_name_en, position, wceo, ceo, cob, age, updated)][order(-ceo, -cob)])
  }
  return (xData)
}
# ==================================================================================================
DOWNLOAD_CAF_STKVN_PRICESDAY_BY_CODE = function(pCodesource = 'VNM')  {
  # ------------------------------------------------------------------------------------------------
  # pCode = 'XYZ'
  # pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=30/12/2022&EndDate=30/12/2023&PageIndex=3&PageSize=20')
  # NbPagesBack = 20
  pCode     = pCodesource
  Data_List = list()
  ToContinu = T
  k = 1
  while (ToContinu)
  {
    pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=&EndDate=&PageIndex=', k, '&PageSize=100')
    CATrp(pURLk)
    x = try(jsonlite::fromJSON(pURLk))
    if (length(x$Data$Data)>0)
    {
      XData = try(as.data.table(x$Data$Data))
      if (all(class(XData)!='try-error'))
      {
        XData = CLEAN_COLNAMES(XData)
        Final_Data = XData[, .(source='CAF', codesource=pCode, ticker=pCode, code=paste0('STKVN', pCode),
                               date      = as.Date(ngay, '%d/%m/%Y'), 
                               open      = 1000*as.numeric(giamocua),
                               high      = 1000*as.numeric(giacaonhat),
                               low       = 1000*as.numeric(giathapnhat),
                               close_adj = 1000*as.numeric(giadieuchinh),
                               close=1000*as.numeric(giadongcua),
                               change=1000*as.numeric(word(thaydoi,1,1,'\\(')),
                               varpc=as.numeric(word(word(thaydoi,2,2,'\\('),1,1,' ')),
                               volume=as.numeric(gsub(',','', khoiluongkhoplenh)),
                               turnover=as.numeric(gsub(',','', giatrikhoplenh))
                               
        )]
        My.Kable.TB(Final_Data)
        Data_List[[k]] = Final_Data
      } else {
        ToContinu = F
      }
    } else {
      ToContinu = F
    }
    k = k+1
  }
  CATln(pURLk); CATln('')
  Data_All = rbindlist(Data_List, fill=T)
  if (nrow(Data_All)>0)
  {
    Data_All = Data_All[order(date)]
    Data_All[, reference:=close-change]
    Data_All[, rt:=change/reference]
    My.Kable.TB(Data_All)
  } else {
    Data_All = data.table()
  }
  return(Data_All)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_PRICES_BY_CODE = function(pCodesource = 'VNM')  {
  # ------------------------------------------------------------------------------------------------
  # pCode = 'XYZ'
  # pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=30/12/2022&EndDate=30/12/2023&PageIndex=3&PageSize=20')
  # NbPagesBack = 20
  pCode     = pCodesource
  Data_List = list()
  ToContinu = T
  k = 1
  while (ToContinu)
  {
    pURLk = paste0('https://s.cafef.vn/Ajax/PageNew/DataHistory/PriceHistory.ashx?Symbol=', pCode, '&StartDate=&EndDate=&PageIndex=', k, '&PageSize=100')
    CATrp(pURLk)
    x = try(jsonlite::fromJSON(pURLk))
    if (length(x$Data$Data)>0)
    {
      XData = try(as.data.table(x$Data$Data))
      if (all(class(XData)!='try-error'))
      {
        XData = CLEAN_COLNAMES(XData)
        Final_Data = XData[, .(source='CAF', codesource=pCode, ticker=pCode, code=paste0('STKVN', pCode),
                               date      = as.Date(ngay, '%d/%m/%Y'), 
                               open      = 1000*as.numeric(giamocua),
                               high      = 1000*as.numeric(giacaonhat),
                               low       = 1000*as.numeric(giathapnhat),
                               close_adj = 1000*as.numeric(giadieuchinh),
                               close=1000*as.numeric(giadongcua),
                               change=1000*as.numeric(word(thaydoi,1,1,'\\(')),
                               varpc=as.numeric(word(word(thaydoi,2,2,'\\('),1,1,' ')),
                               volume=as.numeric(gsub(',','', khoiluongkhoplenh)),
                               turnover=as.numeric(gsub(',','', giatrikhoplenh))
                               
        )]
        My.Kable.TB(Final_Data)
        Data_List[[k]] = Final_Data
      } else {
        ToContinu = F
      }
    } else {
      ToContinu = F
    }
    k = k+1
  }
  CATln(pURLk); CATln('')
  Data_All = rbindlist(Data_List, fill=T)
  if (nrow(Data_All)>0)
  {
    Data_All = Data_All[order(date)]
    Data_All[, reference:=close-change]
    Data_All[, rt:=change/reference]
    My.Kable.TB(Data_All)
  } else {
    Data_All = data.table()
  }
  return(Data_All)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_FANT_STKVN_DIV_BY_CODE = function(pCodesource = 'HD8', Starttime=8)  {
  # ------------------------------------------------------------------------------------------------
  # x = DOWNLAD_FANT_STKVN_REF_INFO_BY_CODE(pCodesource = 'AAV')
  Start.Time  = Sys.time()
  endDate     = Sys.Date() + 36500
  startDate   = as.Date("1962-01-01")
  limit       = as.numeric(endDate - startDate)
  pURL        = paste0('https://restv2.fireant.vn/events/search?symbol=', pCodesource, '&orderBy=1&type=0&startDate=', startDate,'&endDate=',endDate ,'&offset=0&limit=', limit )
  headers = c(
    `Accept` = "application/json, text/plain, */*",
    `Accept-Encoding` = "gzip, deflate, br, zstd",
    `Accept-Language` = "en-US,en;q=0.9",
    `Authorization` = "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",
    `Sec-Ch-Ua` = '"Microsoft Edge";v="125", "Chromium";v="125", "Not.A/Brand";v="24"',
    `User-Agent` = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36 Edg/125.0.0.0"
  )
  
  # Start.Time  = Sys.time()
  # endDate     = Sys.Date()
  # startDate   = as.Date("1962-01-01")
  # limit = as.numeric(endDate - startDate)
  # pURL        = paste0('https://restv2.fireant.vn/events/search?symbol=', pCodesource, '&orderBy=1&type=0&startDate=', startDate,'&endDate=',endDate ,'&offset=0&limit=', limit )
  # data_table  = data.table()
  # headers = c(
  #   `Accept` = "application/json, text/plain, */*",
  #   `Accept-Encoding` = "gzip, deflate, br, zstd",
  #   `Accept-Language` = "en-US,en;q=0.9",
  #   `Authorization` = "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",
  #   `Sec-Ch-Ua` = '"Microsoft Edge";v="125", "Chromium";v="125", "Not.A/Brand";v="24"',
  #   `User-Agent` = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36 Edg/125.0.0.0"
  # )
  # 
  response = GET(pURL, add_headers(.headers = headers))
  
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  
  
  data = content(response, as = "text", encoding = "UTF-8")
  json_data = jsonlite::fromJSON(data)
  if (length(json_data) > 5)
  {
    data_table = try(as.data.table(json_data))
    if (all(class(data_table)!='try-error') && nrow(data_table)>0)
    {
      
      data_table[, codesource:=pCodesource]  
      data_table[, code:=paste0('STKVN', pCodesource)]
      date_cols   = c("registrationDate", "executionDate", "recordDate")
      data_table[, (date_cols) := lapply(.SD, as.Date), .SDcols = date_cols]
      data_table  = data_table[!grepl("Cổ tức năm|Phát hành CP cho CĐHH|tỷ lệ 100:", title)]
      text        = data_table[, title]
      number      = sub(".*tỷ lệ ([0-9]+)đ.*", "\\1", text)
      number      = as.numeric(number)
      data_table[, value:= number]
      data_table[, dataset:= "DIVIDEND"]
      data_table[, c("symbol", "type", "title", "name") := NULL]
      # data_table[, updated:=substr(as.character(Sys.time()),1,19)]
      data_table = setDT(data_table)
      data_table = CLEAN_COLNAMES(data_table)
      # sort(names(data_table))
      
      RELOAD_CALENDAR_VN()
      # str(data_table)
      data_table = merge(data_table[, -c('date_ex')], idx_calendar.vn[, .(recorddate=date, date_ex=prv_date)], all.x = T, by='recorddate')
      data_table[, date:=as.Date(date_ex)]
      data_table[, updated:=SYS.TIME()]
      data_table = MERGE_DATASTD_BYCODE(data_table, pOption='FINAL')
      # My.Kable.FieldVertical(pData=data_table, pRow=1)
      My.Kable.All(data_table[order(date)][, -c('country', 'continent', 'home', 'sample', 'fcat', 'scat')])
    }
  } 
  End.Time = Sys.time()
  Duration = Format.Number(difftime(End.Time, Start.Time, units='secs'), 2)
  CATln(paste('Duration = ', Duration)); catrep('-', 120)
  return(data_table)
}

# ==================================================================================================
TRAINEE_LOAD_SQL_TABLES_HOST = function(pTableSQL = list ( 'wcw_directory', 'ccpi_dashboard_wti'), pHost = 'dashboard_live', ToDisconnect=T, 
                                        SaveFolder = '', ToKable=T) {
  # ------------------------------------------------------------------------------------------------
  if ((nchar(SaveFolder) > 0) & !file.exists(SaveFolder))
  {
    dir.exists(SaveFolder)
  }
  host_dt      = data.table()
  my.connexion = try(TRAINEE.IFRC.CONNEXTION.2023 (pHost))
  print(my.connexion)
  
  if (all(class(my.connexion)!='try-error'))
  {
    My_Table = list ()
    for ( i in 1: length (pTableSQL) )
    {
      # i = 1
      tableSQL = pTableSQL [[i]]
      CATln('')
      CATln_Border(tableSQL)
      CATrp("Read Table...")
      host_dt = try(dbReadTable(my.connexion,tableSQL))
      Sys.sleep(3)
      if (all(class(host_dt)!='try-error'))
      {
        OutDt = setDT(host_dt)
        if ('date' %in% names(OutDt))
        {
          OutDt [, date := as.Date(date)]
        }
        
        if (!'code' %in% names(OutDt))
        {  OutDt [, code := as.character (name) ] }
        # str(host_dt)
        Table = data.table (host = pHost, code = tableSQL, start = as.Date(min (OutDt[!is.na(date)]$date)), end = as.Date(max (OutDt[!is.na(date)]$date)),
                            date = as.Date(max (OutDt [!is.na(date)]$date)), records = as.numeric(nrow (OutDt)), updated = as.character(max (OutDt[!is.na(updated)]$updated)))
        My_Table [[i]] = Table
        CATln(paste('CCPR_LOAD_SQL_HOST : ', tableSQL, ' - DONE, ', SYS.TIME()))
        if (nchar(SaveFolder) > 0) { 
          try(CCPR_SAVERDS (OutDt, SaveFolder, paste0(tableSQL, '.rds'), SaveOneDrive = F, ToSummary = T))
          # CCPR_SAVERDS (My_TableSQL, SaveFolder, paste0(pTableSQL, '_SUMMARY.rds'), SaveOneDrive = F)
          # fwrite( My_TableSQL, paste0(SaveFolder, pTableSQL, '_SUMMARY.txt'), sep = '\t') 
        }
        Sys.sleep(1)
        
        if (nchar(SaveFolder) > 0) { 
          # CCPR_SAVERDS (OutDt, SaveFolder, paste0(pTableSQL, '.rds'), SaveOneDrive = F)
          # CCPR_SAVERDS (Table, SaveFolder, paste0(tableSQL, '_SUMMARY.rds'), SaveOneDrive = F)
          fwrite( Table, paste0(SaveFolder, tableSQL, '_SUMMARY.txt'), sep = '\t') 
        }
      } 
      
    }
    My_TableSQL = rbindlist (My_Table, fill = T)
    
    
  } else {
    CATln(paste(pHost, ": NO CONNEXION."))
  }
  
  if (ToKable) { My.Kable.All(My_TableSQL) }
  if (ToDisconnect) { try(dbDisconnect(my.connexion),silent = T) }
  if (length(pTableSQL) > 1)
  {
    OutDt = data.table()
  }
  return( list(My_TableSQL, OutDt) )
}

# ==================================================================================================
TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE = function(pCodesource = 'VIC', Starttime=8, STOCK = T, CodeInt='',  merge_ins_ref = T)  {
  # ------------------------------------------------------------------------------------------------
  # pCodesource = 'VIC'; Starttime=8; STOCK = T; CodeInt=''
  CATln_Border(paste('TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE - ', pCodesource))
  Start.Time  = Sys.time()
  endDate     = Sys.Date()
  startDate   = as.Date("1962-01-01")
  limit = as.numeric(endDate - startDate)
  
  Final_Data  = data.table()
  pURL = paste0('https://restv2.fireant.vn/symbols/', pCodesource, '/historical-quotes?startDate=', startDate, '&endDate=', endDate, '&offset=0&limit=', limit)
  
  headers = c(
    `Accept` = "application/json, text/plain, */*",
    `Accept-Encoding` = "gzip, deflate, br, zstd",
    `Accept-Language` = "en-US,en;q=0.9",
    `Authorization` = "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",
    `Sec-Ch-Ua` = '"Microsoft Edge";v="125", "Chromium";v="125", "Not.A/Brand";v="24"',
    `User-Agent` = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36 Edg/125.0.0.0"
  )
  
  response  = GET(pURL, add_headers(.headers = headers))
  
  data      = content(response, as = "text", encoding = "UTF-8")
  json_data = jsonlite::fromJSON(data)
  
  if (length(json_data) > 5)
  {
    data_table = try(as.data.table(json_data))
    if (all(class(data_table)!='try-error') && nrow(data_table)>0)
    {
      # data_table[, change:=close_adj-shift(close_adj)]
      # data_table[, varpc:=100*(close_adj/shift(close_adj)-1)]
      numeric_cols = names(data_table)[sapply(data_table, is.numeric)]
      # data_table[, (numeric_cols) := lapply(.SD, function(x) {
      #   ifelse(x %% 1 == 0, prettyNum(x, big.mark = ",", scientific = FALSE), formatC(x, format = "f", big.mark = ",", digits = 2))
      # }), .SDcols = numeric_cols]      
      data_table[, codesource:=pCodesource]  
      if (STOCK) { 
        data_table[, code:=paste0('STKVN', pCodesource)] 
      } else  { 
        if (nchar(CodeInt)>0) {
          data_table[, code:=CodeInt] 
        } else {data_table[, code:=as.character(NA)]}
      }
      data_table[, date:=as.Date(date)]
      data_table[, updated:=SYS.TIME()]
      data_table = setDT(data_table)
      data_table = CLEAN_COLNAMES(data_table)
      # sort(names(data_table))
      # My.Kable.FieldVertical(pData=data_table, pRow=1)
      # str(data_table)
      # My.Kable(data_table[, .(code, date, close_adj, change, varpc, unit)])
      Final_Data = data_table[, .(source = 'FANT', ticker = symbol, codesource, code, date, open = unit*priceopen, close_adj=unit*priceclose,
                                  high=unit*pricehigh, low=pricelow*unit, average=unit*priceaverage, close=unit*priceclose, reference=unit*pricebasic, 
                                  close_unadj=unit*priceclose, volume=totalvolume, turnover=totalvalue)]
      Final_Data[reference==0, reference:=as.numeric(NA)]
      Final_Data[!is.na(reference), change:=close-reference]
      Final_Data[!is.na(reference), varpc:=100*change/reference]
      Final_Data[, rt:=varpc/100]
      Final_Data = UPDATE_UPDATED(Final_Data)
      
      # Final_Data[is.na(change) & !is.na(reference),  change:=close-reference]
      # Final_Data[is.na(varpc)  & !is.na(reference),  varpc:=100*change/reference]
      Final_Data[is.na(rt)  & !is.na(reference),     rt:=varpc/100]
      if (merge_ins_ref){
        DBL_RELOAD_INSREF()
        if (nrow(Final_Data[!is.na(code)])>0) { Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption='FINAL')}
        My.Kable.TB(Final_Data[, -c('country', 'continent', 'home', 'sample', 'scat', 'fcat', 'isin')])
      }
      Final_Data = Final_Data[order(date)]
      My.Kable.TB(Final_Data)
    }
  } 
  End.Time = Sys.time()
  Duration = Format.Number(difftime(End.Time, Start.Time, units='secs'), 2)
  CATln(paste('TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE - Duration = ', Duration))
  catrep('-', 120)
  return(Final_Data)
}


# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_BENCHMARK  = function ( Data_Fr = data.table(), List_Codes = list (), 
                                               FrFolder = '' , FrFile = '',
                                               ToIntegration = T,
                                               ToFolder = '', ToFile = '',
                                               ToUpload = F, pHost = 'dashboard_live')  {
  # ------------------------------------------------------------------------------------------------
  
  
  if (nrow(as.data.table(Data_Fr) ) > 1 ) { 
    Data_Add = Data_Fr ; Data_Add
  } else {
    if (length (List_Codes) > 0 ) {
      Data_Add = CCPR_READRDS( FrFolder, FrFile, ToRestore = T) [ code %in% List_Codes] ; Data_Add
    } else { 
      Data_Add = CCPR_READRDS( FrFolder, FrFile, ToRestore = T)  ; Data_Add }
    
  }
  Data_Add [, excess := 1]
  
  if (ToIntegration) {
    Data_Old  = CCPR_READRDS( ToFolder , ToFile, ToRestore = T, ToKable = T)
    My_Data   = unique( rbind(Data_Old, Data_Add, fill =T), fromLast = T , by = 'code')
    CCPR_SAVERDS(My_Data,ToFolder , ToFile, ) 
    
  }  else {  My_Data = Data_Add }
  My.Kable.Min(My_Data)
  if (ToUpload) {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', ToFile)),
                                     l.filepath= tolower(paste0(ToFolder , ToFile)),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
  
  return (My_Data)
}


# ==================================================================================================
LAST_SHARES_TO_UDATA = function(pSource = 'CAF', FieldCheck = 'sharesout', ToCheckDate = T, IntegrateHistory = F) {
  # ------------------------------------------------------------------------------------------------
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  File_Save   = paste0('download_', pSource, '_stkvn_shares_day.rds')
  
  if (!ToCheckDate ||  SUMMARY_DATE(paste0(UData, File_Save)) < LastTrading)
  {
    File_Name   = paste0('download_', pSource, '_stkvn_shares_', gsub('-','', LastTrading), '.rds')
    x           = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', File_Name, ToKable = T)))
    My.Kable(x)
    if (FieldCheck  %in% names(x))
    {
      x = UPDATE_UPDATED(x)
      x[, shares:=sharesout]
      
      My.Kable.TB(x)
      CCPR_SAVERDS(x, UData, File_Save, ToSummary=T, SaveOneDrive = T)
    }
  } else { CATln_Border(paste0(File_Save, ': ALREADY UPDATED')) }
  if (IntegrateHistory)
  {
    try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = UData,  File_Fr     = File_Save, 
                                                              Folder_To   = UData,  File_To     = gsub('day.rds', 'history.rds', File_Save), 
                                                              pCondition  = '', 
                                                              RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=F))
  }
  
  if (!ToCheckDate ||  SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', File_Save)) < LastTrading)
  {
    try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = UData,                   File_Fr     = File_Save, 
                                                              Folder_To   = 'S:/STKVN/PRICES/DAY/',  File_To     = File_Save, 
                                                              pCondition  = '', 
                                                              RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=T))
  }
  try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('LAST_SHARES_TO_UDATA >', pSource), pAction="SAVE", NbSeconds=3600, ToPrint=F))
}

# ==================================================================================================
TRAINEE_DASHBOARDLIVE_CCPI_STKVN_COMPO = function(pOption ='ICB', Compo_Folder = 'S:/STKVN/INDEX_2024/',
                                                  Compo_File = 'beq_indlogals_compo.rds',
                                                  Index_Code = 'INDVNXGRPLOGCWPRVND', 
                                                  ToFolder = '' , ToFile = '', ToSave = F, ToUpload = F, pHost = '',
                                                  Compo_Date = Sys.Date()) {
  # ------------------------------------------------------------------------------------------------
  COMPO_4INDEX_FINAL = data.table()
  xData = CHECK_CLASS(try(CCPR_READRDS(Compo_Folder, Compo_File, ToKable = T, ToRestore = T)))
  My.Kable(xData)
  # COMPO_4INDEX = CCPR_READRDS(paste0(CCPRData, 'DASHBOARD/'), paste0('IFRC_CCPR_IND_GICS_ALL_COMPO_4INDEX.rds'), ToKable = T, ToRestore = T)
  # COMPO_4INDEX = COMPO_4INDEX[, -c('source', 'codesource', 'close')][!is.na(index_code)]
  Compo.Date   = max(xData[date<=Compo_Date]$date)
  COMPO_4INDEX = xData[date==Compo.Date]
  My.Kable(COMPO_4INDEX)
  str(COMPO_4INDEX)
  
  COMPO_4INDEX[, capibnvnd:=shares*close_unadj/1000000000]
  COMPO_4INDEX[, sum_capi:=sum(capibnvnd, na.rm=T)]
  COMPO_4INDEX[, nb:=.N]
  COMPO_4INDEX[, wgt_cw_pc:=100*capibnvnd/sum_capi]
  COMPO_4INDEX[, wgt_ew_pc:=100*1/nb]
  COMPO_4INDEX[, ticker:=gsub('STKVN','', code)]
  COMPO_4INDEX[, index_code:=Index_Code]
  COMPO_4INDEX = COMPO_4INDEX %>% dplyr::select('index_code', 'nb', 'ticker', 'code', 'name', 'date', 'shares', 
                                                'close_unadj', 'capibnvnd', 'wgt_cw_pc', 'wgt_ew_pc', everything())
  COMPO_4INDEX$IFRC_rt=NULL
  My.Kable(COMPO_4INDEX[order(index_code, -capibnvnd)])
  
  COMPO_4INDEX_STR = CHECK_CLASS(try(CCPR_READRDS('S:/CCPR/DATA/DASHBOARD/', 'INDGICS_COMPOSITION_ALL.rds', ToKable = T, ToRestore = T)))
  CommonField      = intersect(names(COMPO_4INDEX), names(COMPO_4INDEX_STR))
  COMPO_4INDEX_FINAL = COMPO_4INDEX[, ..CommonField]
  
  DBL_RELOAD_INSREF()
  COMPO_4INDEX_FINAL = merge(COMPO_4INDEX_FINAL[, -c('index_name')], ins_ref[, .(index_code=code, index_name=short_name)], all.x=T, by='index_code')
  COMPO_4INDEX_FINAL = COMPO_4INDEX_FINAL %>% dplyr::select('index_code', 'index_name', 'nb', 'ticker', 'code', 'name', 'date', 'shares', 
                                                            'close_unadj', 'capibnvnd', 'wgt_cw_pc', 'wgt_ew_pc', everything())
  
  My.Kable.All(COMPO_4INDEX_FINAL[, -c('code', 'sum_capi')])
  
  # STEP 1: READ FILE PRICES HISTORY
  Data_All = xData
  
  # cleanse raw data
  x = unique(Data_All, by = c('code', 'date'))
  
  
  # STEP 2: RE-CALCULATE DATA
  Ind_History = x  [date <= Compo_Date]  
  my_date = max (Ind_History$date)
  Ind_History = Ind_History[order(code, date)] 
  Ind_History[, ':='(change=close_unadj-shift(close_unadj), varpc=100*(close_unadj/shift(close_unadj)-1)), by='code']
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_unadj/shift(close_unadj))-1, by='code']
  
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_unadj/shift(close_unadj))-1, by='code']
  
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_unadj/shift(close_unadj))-1, by='code']
  
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code'))[, .(code, name, date, last=close_unadj, change, varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  My.Kable(Ind_Overview)
  
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  # End.time = Sys.time()
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  Ind_All 
  
  # STEP 3: ADD missing COLUMNS: market, sector, industry, size, ticker
  switch ( pOption, 
           'ICB'  = { icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
           # CCPR_SAVERDS(icb, 'S:/CCPR/DATA/', 'STKVN_ICB_ALL.rds')
           }  ,
           'GICS' = { gics = setDT (read_xlsx('S:/CCPR/DATA/DASHBOARD/From_BloombergVN_GICS_en.xlsx'))
           gics = TRAINEE_CLEAN_COLNAMES(gics)
           gics [san == 'UPCOM', market := 'UPC']
           gics [san == 'HOSE',  market := 'HSX']
           gics [san == 'HNX',   market := 'HNX']
           # colnames(gics)
           # gics [ ,. (code1 = code___5, name1 = gics_1 )]
           })
  Data_All [, capivnd:= shares*close]
  y = merge(Data_All, icb[,.(code, sector = icb1_name,  industry = icb2_name)], all.x= T, by = 'code')
  Ind_All  = merge( Ind_All, y [,.(code, market, date,     sector   , industry)], all.x = T, by = c('code' , 'date') )
  Ind_All$name = NULL
  my_short_list = merge (COMPO_4INDEX_FINAL,Ind_All, all.x = T, by = c('code', 'date')  ) 
  
  # MaxDate = max(my_short_list$date)
  STKVN_CLEANED = copy(my_short_list[!is.na(capibnvnd) & date==Compo_Date])
  STKVN_CLEANED[, sum_capi:=sum(capibnvnd), by='date']
  STKVN_CLEANED[, cum_capi:=cumsum(capibnvnd), by='date']
  STKVN_CLEANED[, pc_capi:=100*cum_capi/sum_capi, by='date']
  STKVN_CLEANED[pc_capi<=85, size:='LARGE']
  STKVN_CLEANED[pc_capi>85 & pc_capi<=95, size:='MID']
  STKVN_CLEANED[pc_capi>95, size:='SMALL']
  STKVN_CLEANED$pc_capi = NULL
  STKVN_CLEANED$cum_capi = NULL
  STKVN_CLEANED$sum_capi = NULL
  My.Kable(STKVN_CLEANED)
  STKVN_CLEANED[, updated:= substr (as.character(Sys.time()),1,19)]
  STKVN_CLEANED[, short_name:=trimws(toupper(name))]
  STKVN_CLEANED = STKVN_CLEANED [order (-capibnvnd)]
  
  # COMPO_4INDEX_FINAL = merge (COMPO_4INDEX_FINAL,STKVN_CLEANED , all.x = T, by = 'code' )
  
  # # str(STKVN_CLEANED)
  if (ToSave ) {
    CCPR_SAVERDS(STKVN_CLEANED,ToFolder, ToFile , ToSummary=T, SaveOneDrive = T) }
  
  # STEP 4: UPLOAD DATA
  if( ToUpload ) {
    
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= gsub ('.rds','', tolower(ToFile) ),
                                     l.filepath= tolower(paste0(ToFolder,  ToFile) ),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
  
  My.Kable(STKVN_CLEANED)
  return ( STKVN_CLEANED)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE = function(pCode="VNM") {
  # ------------------------------------------------------------------------------------------------
  # pCode = "VNM"
  # TRAINEE_MONITOR_EXECUTION_SUMMARY (pOption='TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE', pAction="SAVE", NbSeconds=3600, ToPrint=F) 
  
  print(paste0(pCode,":  DOWNLOADING..."))
  caf_url = paste0("https://s.cafef.vn/hose/",pCode,".chn")
  caf_cnt = content(GET(caf_url),"text",encoding = "UTF-8")
  caf_cnt = tolower(stri_trans_general(caf_cnt, "ASCII"))
  caf_div = gsub('.*class="tt view-more-btn"',"",caf_cnt)
  caf_div = gsub('ngay hien thi la ngay gd khong huong quyen.*',"",caf_div)
  
  
  div_type = str_split(caf_div,"</b>: ")[[1]]
  if (length(div_type)>1)
  {
    type_temp   = data.table(typeraw=div_type[2:length(div_type)])
    type_temp[,id:=seq(1,.N)]
    type_temp[,typeraw:=paste("temp",id," ",gsub('&ensp;',paste("temp",id," "),typeraw)),by="id"]
    dt_type = data.table(type = unlist(str_split(type_temp$typeraw,"temp")))
    dt_type = dt_type[nchar(type)>0]
    dt_type[grepl("ty le.*%", type),valuepc := gsub('.*ty le ','',gsub("%.*","",type))]
    dt_type[,":="(id = as.integer(gsub(" .*","",trimws(type))),
                  type = gsub(',.*',"",gsub('&nbsp;',"",type)))]
    dt_type[,type:=gsub(paste0(paste0(id,collapse = "|"),'|</font>.*'),"",type)]
    
    div_date = str_split(caf_div,"<b>")[[1]]
    div_date = gsub("</b>.*","",div_date[2:length(div_date)])
    dt_date  = data.table(date_eff = as.Date(div_date, format="%d/%m/%Y"))
    dt_date[,id:=seq(1,.N)]
    
    dt_div = merge(dt_type, dt_date, by="id", all.x=T)
    dt_div = dt_div[,.(ticker = pCode, code = paste0("STKVN",pCode), dataset = "DIVIDEND", date_eff, event = tolower(type),
                       ratiopc = as.numeric(gsub(",","\\.",valuepc)),
                       close = ifelse(grepl("co tuc.*tien", type), round(10000*as.numeric(as.numeric(gsub(",","\\.",valuepc)))/100), as.numeric(NA)),
                       source = "CAF", updated = substr( as.character(Sys.time()),1,19))]
    RELOAD_CALENDAR_VN()
    dt_div = merge(dt_div, idx_calendar.vn[,.(date_eff = date, date = prv_date)],by="date_eff",all.x=T)
    dt_div$date_eff = NULL
    dt_div = MERGE_DATASTD_BYCODE(dt_div, pOption='FINAL')
    dt_div = dt_div[grepl("co tuc.*tien", event)]
  } else { dt_div = data.table() }
  
  My.Kable (dt_div)
  return(dt_div)
}

# ==================================================================================================
TRAINEE_REPORT_OPEN_FINAL = function (File_Folder  = 'S:/STKVN/PRICES/DAY/',
                                      LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'STB', 'DCL'),
                                      LIST_DATASET = list('reference_open', 'market', 'sharesout'),
                                      Pre_Date     = '',
                                      STKVN        = F) {
  # ------------------------------------------------------------------------------------------------
  
  # File_Folder = 'S:/STKVN/PRICES/DAY/'
  # LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL')
  # LIST_DATASET = list('reference', 'market', 'sharesout')
  
  DBL_RELOAD_INSREF()
  CURRENT_TIME = substr(Sys.time(), 12,13)
  if (nchar(Pre_Date) != 0) 
  {
    LastTrading = Pre_Date
  }else{
    LastTrading     = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  }
  LIST_PRICES_BOARD = list()
  LIST_SHARES       = list()
  Final_Data        = data.table()
  
  for (k in 1:length(LIST_SOURCES))
  {
    # k = 5
    pSource = LIST_SOURCES[[k]]
    # PRICESBOARD FILES 
    # ------------------------------------------------------------------------------------------------
    File_Name_Day    = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_DAY.rds')
    CATln_Border(paste('DAY  = ', File_Name_Day))
    Data_Day         = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Day, ToKable = T, ToRestore = T)))
    
    File_Name_Date   = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_', gsub('-','', LastTrading), '.rds')
    CATln_Border(paste('DATE = ', File_Name_Date))
    Data_Date        = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Date, ToKable = T, ToRestore = T)))
    
    Data_All_Pricesboard = rbind(Data_Day, Data_Date, fill=T)
    
    if (nrow(Data_All_Pricesboard)>0) 
    {
      Data_All_Pricesboard = Data_All_Pricesboard[date==LastTrading]
      Data_All_Pricesboard[market == 'UPCOM', market := 'UPC']
      Data_All_Pricesboard[market == 'HOSE', market := 'HSX']
      Data_All_Pricesboard = unique(Data_All_Pricesboard, by=c('code', 'date'))
      Data_All_Pricesboard = merge(Data_All_Pricesboard[, -c('name')], ins_ref[, .(code, name=short_name)], all.x=T, by='code')
      LIST_PRICES_BOARD[[k]] = Data_All_Pricesboard
    }
    
    # # STKVN SHARES FILES 
    # ------------------------------------------------------------------------------------------------
    File_Name_Day    = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES_DAY.rds')
    CATln_Border(paste('DAY  = ', File_Name_Day))
    Data_Day         = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Day, ToKable = T, ToRestore = T)))
    
    File_Name_Date   = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES_', gsub('-','', LastTrading), '.rds')
    CATln_Border(paste('DATE = ', File_Name_Date))
    Data_Date        = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Date, ToKable = T, ToRestore = T)))
    
    Data_All_Shares = rbind(Data_Day, Data_Date, fill=T)
    
    if (nrow(Data_All_Shares)>0)
    {
      Data_All_Shares  = Data_All_Shares[date==LastTrading]
      Data_All_Shares = unique(Data_All_Shares, by=c('code', 'market'))
      LIST_SHARES[[k]] = Data_All_Shares
    }
    
  }
  
  DATA_ALL_PRICESBOARD = rbindlist(LIST_PRICES_BOARD, fill = T)
  DATA_ALL_SHARES_DAY = rbindlist(LIST_SHARES, fill = T)
  
  LIST_CODE_BY_EXC = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('list_code_by_exc_', gsub('-', '', LastTrading), '.rds'))))
  
  if (nrow(LIST_CODE_BY_EXC) == 0 )
  {
    Prev_date = CCPR_LAST_TRADING_DAY_VN(pHH = 9, ToPrompt = F, Option = 'Prev_date')
    LIST_CODE_BY_EXC = CHECK_CLASS(try(CCPR_READRDS(File_Folder, paste0('list_code_by_exc_', gsub('-', '', Prev_date), '.rds'))))
  }
  
  DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('market')], LIST_CODE_BY_EXC[,. (code, market)], all.x = T, by = 'code')
  DATA_ALL_SHARES_DAY = unique(DATA_ALL_SHARES_DAY[date == LastTrading], by = c("source", "code"))
  DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[!is.na(sharesout)]
  DATA_ALL_SHARES_DAY[source %in% c("HNX", "HSX", "UPC"), source := "EXC"]
  
  DATA_ALL = merge(DATA_ALL_PRICESBOARD, DATA_ALL_SHARES_DAY[,. (date, source, ticker = codesource, shareslis, sharesout)], by = c('source', 'date', 'ticker'), all.x = T)
  unique(DATA_ALL$source)
  
  DATA_ALL_PRICESBOARD = unique(DATA_ALL[order(source, code, -updated)], by = c('source', 'code'))
  DATA_ALL_DAY_EXC = DATA_ALL_PRICESBOARD[source == "EXC"]
  
  #list_dataset = list('reference', 'market')
  x = list()
  for (dataset in LIST_DATASET) 
  {
    # dataset = 'reference'
    # dataset = 'market'
    # dataset = 'sharesout'
    
    if(dataset != 'market'){
      fields_source  = union(c('code', 'date', 'market', 'source'), dataset) 
    }else{
      fields_source  = union(c('code', 'date', 'source'), dataset) 
    }
    
    
    DATA_ALL_DATASET_SOURCE = DATA_ALL[, ..fields_source]
    
    num_columns = ncol(DATA_ALL_DATASET_SOURCE)
    DATA_ALL_DATASET_SOURCE$market = paste0(dataset, "_", DATA_ALL_DATASET_SOURCE$market)
    if (dataset == 'sharesout') {  DATA_ALL_DATASET_SOURCE = DATA_ALL_DATASET_SOURCE[!is.na(sharesout)] }
    
    DATA_ALL_DATASET_SOURCE = DATA_ALL_DATASET_SOURCE[,. (date, source, market)]
    DATA_ALL_DATASET_SOURCE[, updated := substr(Sys.time(), 1,19)]
    
    names(DATA_ALL_DATASET_SOURCE) = c("date", "source", "value", "updated")
    
    x[[dataset]] = DATA_ALL_DATASET_SOURCE
    
  }
  
  DATA = rbindlist(x, fill = T)
  DATA[, LastTrading := LastTrading]
  DATA_ALL_DATE = unique(DATA[order(source, value, -date)], by = c('source', 'value'))
  DATA_ALL_DATE [, n := as.character(date - LastTrading)]
  DATA_ALL_DATE [n == 0, n := substr(updated, 12, 16)]
  
  report_open_date = setDT(spread(DATA_ALL_DATE[, .(n), by = .(source, value, date)], key = 'source', value = 'n'))[, ':='( updated = substr(Sys.time(),1,19) )]
  
  report_open = setDT(spread(DATA[,.(n=.N), by=c('date','source', 'value')], key='source', value='n'))[, updated := substr(Sys.time(), 1, 19)]
  report_open = unique(report_open[order(-date)], by = "value")
  My.Kable.All(report_open)
  My.Kable.All(report_open_date)
  
  CCPR_SAVERDS(report_open,'S:/SHINY/STKVN/OPEN/', 'report_open_day_number.rds')
  CCPR_SAVERDS(report_open_date,'S:/SHINY/STKVN/OPEN/', 'report_open_day_date.rds')
  try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
  x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_REPORT_OPEN_FINAL'), pAction="SAVE", NbSeconds=0, ToPrint = T))
}


# ==================================================================================================
CALCULATE_UPLOAD_BEQ_INDEX_2024 = function (INDEX.NAME = 'LOGISTICS', ToCheckDate = T, ToUpload = F, Minutes = 5) {
  # ------------------------------------------------------------------------------------------------
  if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('CALCULATE_UPLOAD_BEQ_INDEX_2024>',INDEX.NAME), pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
  {
    DBL_RELOAD_INSREF()
    # INDEX.NAME = 'BROKERAGE'
    if (INDEX.NAME == 'VIETNAM_INDEXES') 
    {
      PREFIX = tolower('VN')
      Fr_File_Path = paste0('S:/STKVN/INDEX_2024/', 'beq_ind', PREFIX, '_history.rds')
      To_File_Path = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_ind', PREFIX, '.rds')
      x = readRDS(To_File_Path)
      CCPR_SAVERDS(x, 'S:/CCPR/DATA/DASHBOARD_LIVE/', paste0('ccpi_dashboard_ind', PREFIX, '.rds'), ToSummary=T)
      
      if (ToCheckDate) {
        if (TRAINEE_SUMMARY_DATE_RDS(Fr_File_Path) >= TRAINEE_SUMMARY_DATE_RDS(To_File_Path)) {
          
          # OVERVIEW
          OVERVIEW = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_VIETNAM_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/INDEX_2024/', 
                                                                    Fr_File = paste0('beq_ind', PREFIX, '_history.rds'),
                                                                    To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_ind', PREFIX, '.rds'), 
                                                                    DateLimit = Sys.Date()  ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                                    ToSave = T, ToUpload = T , pHost = 'dashboard_live') )
        } 
      } else {
        message("No update performed due to date check.")
      }
      
    } else {
      switch (INDEX.NAME,
              'LOGISTICS' = {
                PREFIX = tolower('LOG')
              },
              'BROKERAGE' = {
                PREFIX = tolower('BRK')
              },
              'PETROLIMEX' = {
                PREFIX = tolower('PET')
              },
              'REALESTATE' = {
                PREFIX = tolower('RST')
              },
              'RETAIL' = {
                PREFIX = tolower('RTL')
              },
              'BANK' = {
                PREFIX = tolower('BNK')
              },
              'HEALTHCARE' = {
                PREFIX = tolower('HLC')
              },
              'ENERGY' = {
                PREFIX = tolower('ENY')
              },
              'FINANCE' = {
                PREFIX = tolower('FIN')
              },
              'AI' = {
                PREFIX = tolower('ARI')
              }
      )
      
      # Fr_File_Path = paste0('S:/STKVN/INDEX_2024/', 'beq_ind', PREFIX, 'als_history.rds')
      # To_File_Path = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_ind', PREFIX, '.rds')
      # # x = readRDS(To_File_Path)
      # # y = readRDS(Fr_File_Path)
      # x = CHECK_CLASS(try(CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', paste0( 'ccpi_dashboard_ind', PREFIX, '.rds'), ToKable = T, ToRestore = T ))) 
      # if ( nrow(x) > 0)
      # {
      #   try(CCPR_SAVERDS(x, 'S:/CCPR/DATA/DASHBOARD_LIVE/', paste0('ccpi_dashboard_ind', PREFIX, '.rds'), ToSummary=T))
      # }
      # 
      Fr_File_Path = paste0('S:/STKVN/INDEX_2024/', 'beq_ind', PREFIX, 'als_history.rds')
      To_File_Path = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_ind', PREFIX, '.rds')
      
      if (ToCheckDate) {
        if (TRAINEE_SUMMARY_DATE_RDS(Fr_File_Path) >= TRAINEE_SUMMARY_DATE_RDS(To_File_Path)) {
          
          # OVERVIEW
          OVERVIEW = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/INDEX_2024/', 
                                                                    Fr_File = paste0('beq_ind', PREFIX, 'als_history.rds'),
                                                                    To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_ind', PREFIX, '.rds'), 
                                                                    DateLimit = Sys.Date()  ,ToAddBenchmark = T, REF_LIST = list ('INDSPX', 'INDVNINDEX','CMDGOLD'),
                                                                    ToSave = T, ToUpload = T , pHost = 'dashboard_live') )
          print(OVERVIEW)
          
          # CHART
          if (ToUpload){
            # CHART = try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= paste0('ccpi_dashboard_ind', PREFIX, '_history'),
            #                                          l.filepath= tolower(paste0('S:/STKVN/INDEX_2024/',  paste0('beq_ind', PREFIX, 'als_history.rds')) ),
            #                                          CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
            
            UPLOAD_RDS_TO_SQL (Connexion = 'dashboard_live',  host = '', user = "", password = "", 
                               SQL_str = "", 
                               SQL_file = '', 
                               pSleep = 1,
                               ToReplace = F, PARAM_REPLACE = list( ) ,
                               RDS_folder = 'S:/STKVN/INDEX_2024/', RDS_file = paste0('beq_ind', PREFIX, 'als_history.rds'), SQL_table = paste0('ccpi_dashboard_ind', PREFIX, '_history')) 
            print(CHART)
          }
          
          
        } 
      } else {
        message("No update performed due to date check.")
      }
    }
    # My.Kable(x)
    
    try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('CALCULATE_UPLOAD_BEQ_INDEX_2024>',INDEX.NAME), pAction="SAVE", NbSeconds=3600, ToPrint=F))
    
  }  else { CATln_Border(paste('DASHBOARD_CCPI_MARKET_CHARTS :', 'SKIP')) } 
}


# ==================================================================================================
OLD_BEQ_INDEX_2024  = function(INDEX.NAME, MinDate = '2024-05-20', ToCheckDate = F) {
  CATln_Border(paste('BEQ_INDEX_2024 =', INDEX.NAME))
  switch(INDEX.NAME,
         
         'LOGISTICS' = {
           INDEX.NAME = 'LOGISTICS'
           # LOGISTICS ........................................................................................
           lFactor         = 'LOG'
           FileCompoXLSX   = 'ccpr_indvn_logistic.xlsx'
           FolderCompoXLSX = 'S:/CCPR/DATA/IFRC_CCPR/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR LOGISTICS'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = paste0('VNXSEC', lFactor)
           INDEX_FCODE     = paste0('INDVNXSEC', lFactor, 'PRVND')
           MAX_RT          = 0.45
           BEQIND_NAME_VND = paste0('BEQ_IND', lFactor, 'ALS_VND.rds')
           BEQIND_NAME_HST = paste0('BEQ_IND', lFactor, 'ALS_HISTORY.rds')
           BEQIND_NAME_CMP = paste0('BEQ_IND', lFactor, 'ALS_COMPO.rds')
           SEARCH_INSREF   = 'LOGISTICS'
         },
         
         'FINANCE' = {
           # BROKERAGE ........................................................................................
           lFactor         = 'FIN'
           FileCompoXLSX   = paste0('COMPO_VNXSEC', lFactor, '.xlsx')
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR FINANCE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = paste0('VNXSEC', lFactor)
           INDEX_FCODE     = paste0('INDVNXSEC', lFactor, 'PRVND')
           MAX_RT          = 0.45
           BEQIND_NAME_VND = paste0('BEQ_IND', lFactor, 'ALS_VND.rds')
           BEQIND_NAME_HST = paste0('BEQ_IND', lFactor, 'ALS_HISTORY.rds')
           BEQIND_NAME_CMP = paste0('BEQ_IND', lFactor, 'ALS_COMPO.rds')
           SEARCH_INSREF   = 'ENERGY'
         },
         
         'ENERGY' = {
           # BROKERAGE ........................................................................................
           lFactor         = 'ENY'
           FileCompoXLSX   = paste0('COMPO_VNXSEC', lFactor, '.xlsx')
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR ENERGY'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = paste0('VNXSEC', lFactor)
           INDEX_FCODE     = paste0('INDVNXSEC', lFactor, 'PRVND')
           MAX_RT          = 0.45
           BEQIND_NAME_VND = paste0('BEQ_IND', lFactor, 'ALS_VND.rds')
           BEQIND_NAME_HST = paste0('BEQ_IND', lFactor, 'ALS_HISTORY.rds')
           BEQIND_NAME_CMP = paste0('BEQ_IND', lFactor, 'ALS_COMPO.rds')
           SEARCH_INSREF   = 'ENERGY'
         },
         
         'PETROLIMEX' = {
           # PETROLIMEX ........................................................................................
           lFactor         = 'PET'
           FileCompoXLSX   = 'ccpr_stkvn_petrolimex.xlsx'
           FolderCompoXLSX = 'S:/CCPR/DATA/IFRC_CCPR/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX GROUP PETROLIMEX'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXGRPPET'
           INDEX_FCODE     = 'INDVNXGRPPETPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDPETALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDPETALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDPETALS_COMPO.rds'
           SEARCH_INSREF   = 'PETROLIMEX'
         },
         
         'BROKERAGE' = {
           # BROKERAGE ........................................................................................
           lFactor         = 'BRK'
           FileCompoXLSX   = 'COMPO_VNXSECBRK.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR BROKERAGE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECBRK'
           INDEX_FCODE     = 'INDVNXSECBRKPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDBRKALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDBRKALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDBRKALS_COMPO.rds'
           SEARCH_INSREF   = 'BROKERAGE'
         },
         
         'HEALTHCARE' = {
           # HEALTHCARE .......................................................................................
           lFactor         = 'HLC'
           FileCompoXLSX   = 'COMPO_VNXSECHLC.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR HEALTHCARE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGHLC'
           INDEX_FCODE     = 'INDVNXSECHLCPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDHLCALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDHLCALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDHLCALS_COMPO.rds'
           SEARCH_INSREF   = 'HEALTHCARE'
         },
         
         'REALESTATE' = {
           # REALESTATE .......................................................................................
           lFactor         = 'RST'
           FileCompoXLSX   = 'COMPO_VNXSECRST.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR REAL ESTATE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE    = 'VNXSECGRST'
           INDEX_FCODE   = 'INDVNXSECRSTPRVND'
           MAX_RT        = 0.45
           BEQIND_NAME_VND = 'BEQ_INDRSTALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDRSTALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDRSTALS_COMPO.rds'
           SEARCH_INSREF   = 'REAL ESTATE'
         },
         
         'RETAIL' = {
           # RETAIL ...........................................................................................
           lFactor         = 'RTL'
           FileCompoXLSX   = 'COMPO_VNXSECRTL.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR RETAIL'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGRTL'
           INDEX_FCODE     = 'INDVNXSECRTLPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDRTLALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDRTLALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDRTLALS_COMPO.rds'
           SEARCH_INSREF   = 'RETAIL'
         },
         
         'BANK' = {
           # BANK .............................................................................................
           lFactor         = 'BNK'
           FileCompoXLSX   = 'COMPO_VNXSECBNK.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR BANK'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGBNK'
           INDEX_FCODE     = 'INDVNXSECBNKPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDBNKALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDBNKALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDBNKALS_COMPO.rds'
           SEARCH_INSREF   = 'BANK'
         },
         
         'AI' = {
           # AI .............................................................................................
           lFactor         = 'ARI'
           FileCompoXLSX   = 'COMPO_VNXSECARI.xlsx'
           FolderCompoXLSX = 'S:/STKVN/INDEX_2024/'
           INDEX_NAME      = 'IFRC/BEQ HOLDINGS VNX SECTOR ARTIFICIAL INTELLIGENCE'
           INDEX_DUPL      = 'IFRC/BEQ HOLDINGS'
           # IND_PREFIX    = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
           INDEX_CODE      = 'VNXSECGARI'
           INDEX_FCODE     = 'INDVNXSECARIPRVND'
           MAX_RT          = 0.45
           BEQIND_NAME_VND = 'BEQ_INDARIALS_VND.rds'
           BEQIND_NAME_HST = 'BEQ_INDARIALS_HISTORY.rds'
           BEQIND_NAME_CMP = 'BEQ_INDARIALS_COMPO.rds'
           SEARCH_INSREF   = 'ARTIFICIAL INTELLIGENCE'
         }
         
  )
  
  # ................................................................................................
  TODO = T
  # ................................................................................................
  if (ToCheckDate) 
  {
    if (TRAINEE_SUMMARY_DATE_RDS(paste0(UData, 'IFRC_STKVN_HSXHNX_4INDEX.rds')) > 
        TRAINEE_SUMMARY_DATE_RDS(paste0('S:/STKVN/INDEX_2024/', 'beq_ind', lFactor,'als_history.rds')))
    {
      TODO = T
    } else {
      TODO = F
    }
  }
  
  if (TODO)
  {
    STKVN_4INDEX = CCPR_READRDS(UData, 'IFRC_STKVN_HSXHNX_4INDEX.rds', ToKable=T, ToRestore=T)
    # [date<=SYSDATETIME(16)]
    My.Kable.Min(STKVN_4INDEX[order(date, code)])
    # ....
    List_Codes_XLS = setDT(openxlsx::read.xlsx(paste0(FolderCompoXLSX, FileCompoXLSX)))
    My.Kable(List_Codes_XLS)
    List_STK       = as.list(List_Codes_XLS$code)
    # File_STK = 'IFRC_CCPR_STKVN_FOR_INDEX.rds'
    
    File_STK = 'IFRC_STKVN_4INDEX.rds'
    # File_STK = 'IFRC_STKVN_HSXHNX_4INDEX.rds'
    
    # lFactor      = 'LOG'
    # STKVN_4INDEX = STKVN_CLEANED
    # STKVN_4INDEX[, secn:='LOG']
    NAME         = INDEX_NAME
    CODE         = INDEX_CODE
    FINAL_CODE   = INDEX_FCODE
    xCONDITION   = 'market %in% list("HSX", "HNX") & code %in% List_STK'
    
    # ------------------------------------------------------------------------------------------------
    
    Start.time = Sys.time()
    COMPO_4INDEX   = data.table()
    CLOSE_4INDEX   = data.table()
    
    STKVN_4INDEX   = CCPR_READRDS(UData, File_STK, ToKable=T, ToRestore=T)
    
    FIRST_SHARES   = unique(STKVN_4INDEX[order(code, date)][!is.na(shares)], by='code') 
    My.Kable.TB(FIRST_SHARES[, .(code, name, date, shares)])
    
    STKVN_4INDEX   = STKVN_4INDEX[code %in% FIRST_SHARES$code] 
    STKVN_4INDEX   = merge(STKVN_4INDEX, FIRST_SHARES[, .(code, first_shares=date)], all.x = T, by='code')
    My.Kable.TB(STKVN_4INDEX[, .(code, name, date, shares, first_shares)][order(first_shares)])
    
    STKVN_4INDEX   = STKVN_4INDEX[date>=first_shares]
    
    STKVN_4INDEX   = STKVN_4INDEX[order(code, date)]
    STKVN_4INDEX[, shares:=na.locf(shares), by='code']
    # STKVN_4INDEX[, sharesout:=na.locf(sharesout), by='code']
    # STKVN_4INDEX[, shareslis:=na.locf(shareslis), by='code']
    
    
    My.Kable(STKVN_4INDEX[, .(code, date, shares, shareslis, sharesout, close, rt, rtd)])
    
    STKVN_4INDEX   = STKVN_4INDEX[abs(rt)<MAX_RT & !is.na(shares) & !is.na(close) & !is.na(rt) &!is.na(market)]
    STKVN_CLEANED  = copy(STKVN_4INDEX)
    print(unique(STKVN_CLEANED$market))
    STKVN_4INDEX = STKVN_CLEANED
    STKVN_4INDEX[, secn:=lFactor]
    
    if (nchar(xCONDITION)==0)
    {
      STKVN_4INDEX = MERGE_DATASTD_BYCODE(STKVN_4INDEX, pOption='FINAL')
    } else {
      STKVN_4INDEX = MERGE_DATASTD_BYCODE(STKVN_4INDEX, pOption='FINAL')[eval(parse(text = xCONDITION))]
    }
    str(STKVN_4INDEX)
    # STKVN_4INDEX[code %in% List_STK]
    
    My.Kable.Min(STKVN_4INDEX[order(date, code)])
    
    
    
    STKVN_4INDEX[, close_unadj:=close]
    STKVN_4INDEX[, capi:=shares*close_unadj]
    
    STKVN_4INDEX[, capi:=shares*close]
    STKVN_4INDEX[is.na(capi) & !is.na(shares) & !is.na(reference), capi:=shares*reference]
    # STKVN_4INDEX[, level:=as.numeric(IDX_LEVEL)]
    My.Kable(STKVN_4INDEX[, .(code, secn, name, market, date, close_unadj, shares, reference, rt, shares, capi)])
    My.Kable(STKVN_4INDEX[is.na(secn)][, .(code, secn, name, market, date, close_unadj, shares, reference, rt, shares, capi)][order(date)])
    
    STKVN_4INDEX_TO_CALCULATE = STKVN_4INDEX[!is.na(secn) & !is.na(capi) & !is.na(rt) & !is.na(market)][date>='2008-12-31']
    COMPO_4INDEX = rbind(COMPO_4INDEX, STKVN_4INDEX_TO_CALCULATE[, .(secn, market, code, date, shares, close_unadj, rt, rtd, capi)], fill=T)
    Data_Sample = STKVN_4INDEX_TO_CALCULATE
    Data_Compo  = copy(Data_Sample)
    Data_Compo[is.na(capi_loc) & !is.na(close_unadj) & !is.na(shares), capi_loc:=shares*close_unadj]
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][order(date, code)])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][is.na(capi_loc)])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][abs(rt)>0.4])
    
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][(!is.na(rt) | !is.na(rtd)) & rt>rtd])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][(!is.na(rt) | !is.na(rtd)) & rt!=rtd])
    
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][is.na(rt) | is.na(rtd) | rt>rtd])
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][rt>rtd])
    
    My.Kable(Data_Compo[, .(code, date, symbol, market, reference, close, close_unadj, rt, rtd, rtx, lnrt, shares, div, capi_loc)][order(date, code)])
    
    Date_Sample   = unique(Data_Sample[, .(date)], by='date')
    Data_Sample[, factor:=secn]
    Capi_Sample   = Data_Sample[, .(sum_capi=sum(capi, na.rm=T)), by=c('date', 'factor')]
    Date_Sample   = merge(Date_Sample, Capi_Sample, all.x=T, by='date')
    My.Kable(Date_Sample[order(date)])
    
    # CALCULATE : ......................................................................................
    
    MaxABS = MAX_RT
    STKVN_4INDEX_TO_CALCULATE = STKVN_4INDEX_TO_CALCULATE[abs(rt)< MaxABS]
    # IFRC_INDEX_CALCULATION_GICS_SECTOR =
    STKVN_4INDEX_SUMS = STKVN_4INDEX_TO_CALCULATE[,.(
      n        = .N, 
      sum_capi = sum(capi, na.rm=T), 
      sum_rt   = sum(rt, na.rm=T),  
      sum_rtd  = sum(rtd, na.rm=T), 
      sum_prod_capixrt  = sum(capi*rt, na.rm=T),
      sum_prod_capixrtd = sum(capi*rtd, na.rm=T)
    ) , by=c('factor', 'date')]
    
    My.Kable(STKVN_4INDEX_SUMS[order(date, factor)])
    STKVN_4INDEX_SUMS[!is.na(n) & n>0,  rt_ew:=  sum_rt/n]
    STKVN_4INDEX_SUMS[!is.na(sum_capi), rt_cw:=  sum_prod_capixrt/sum_capi]
    STKVN_4INDEX_SUMS[!is.na(n) & n>0,  rtd_ew:= sum_rtd/n]
    STKVN_4INDEX_SUMS[!is.na(sum_capi), rtd_cw:= sum_prod_capixrtd/sum_capi]
    STKVN_4INDEX_SUMS[, index_ew:=1000]
    STKVN_4INDEX_SUMS[, index_cw:=1000]
    STKVN_4INDEX_SUMS[, index_ewd:=1000]
    STKVN_4INDEX_SUMS[, index_cwd:=1000]
    
    My.Kable.TB(STKVN_4INDEX_SUMS[order(date, factor)], Nb=10)
    
    List_FACTORS = unique(STKVN_4INDEX_TO_CALCULATE$factor)
    print(List_FACTORS)
    
    xList = list()
    
    xFACTOR = lFactor
    # CATln('\014')
    CATln_Border(xFACTOR)
    Sys.sleep(2)
    starter = 1000
    STKVN_4INDEX_SUMS_ONE = STKVN_4INDEX_SUMS[factor==xFACTOR][order(date)]
    STKVN_4INDEX_SUMS_ONE[, nr:=seq.int(.N)]
    
    STKVN_4INDEX_SUMS_ONE[nr==1, rt_ew:=0]
    STKVN_4INDEX_SUMS_ONE[nr==1, rt_cw:=0]
    STKVN_4INDEX_SUMS_ONE[nr==1, rtd_ew:=0]
    STKVN_4INDEX_SUMS_ONE[nr==1, rtd_cw:=0]
    # View(STKVN_4INDEX_SUMS_ONE)
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rt_ew)),
             index_ew = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rtd_ew)),
             index_ewd = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    # STKVN_4INDEX_SUMS_ONE = setDT(STKVN_4INDEX_SUMS_ONE)[order(factor, date)]
    
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rt_cw)),
             index_cw = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    STKVN_4INDEX_SUMS_ONE %>%
      mutate(wgtrt.unit = order_by(date,cumprod(1+rtd_cw)),
             index_cwd = wgtrt.unit*starter) -> STKVN_4INDEX_SUMS_ONE
    
    STKVN_4INDEX_SUMS_ONE = setDT(STKVN_4INDEX_SUMS_ONE)[order(factor, date)]
    
    STKVN_4INDEX_SUMS_ONE$index_temp = NULL
    STKVN_4INDEX_SUMS_ONE$nr = NULL
    STKVN_4INDEX_SUMS_ONE$wgtrt.unit = NULL
    
    My.Kable(STKVN_4INDEX_SUMS_ONE)
    # FINAL_CODE = 'XXX'
    STKVN_4INDEX_SUMS_ONE = merge(STKVN_4INDEX_SUMS_ONE[, -c('index_name', 'index_code', 'index_symbol')], 
                                  data.table(factor=lFactor, index_name=gsub('&amp;','&', paste('IFRC/BEQ HOLDINGS', NAME)), 
                                             index_code=FINAL_CODE, index_symbol=CODE),
                                  all.x=T, by='factor')
    My.Kable(STKVN_4INDEX_SUMS_ONE)
    INDEX_ONE = STKVN_4INDEX_SUMS_ONE[, .(index_code, index_name, index_symbol, date, rt_ew, rt_cw, index_ew, index_cw, rtd_ew, rtd_cw, index_ewd, index_cwd)]
    My.Kable(INDEX_ONE)
    INDEX_ONE_EW = INDEX_ONE[, .(code=gsub('PRVND', 'EWPRVND', index_code), name=paste(index_name, 'PR EW (VND)'), date, close=index_ew, rt=rt_ew)]
    INDEX_ONE_CW = INDEX_ONE[, .(code=gsub('PRVND', 'CWPRVND', index_code), name=paste(index_name, 'PR CW (VND)'), date, close=index_cw, rt=rt_cw)]
    
    INDEX_ONE_EWD = INDEX_ONE[, .(code=gsub('PRVND', 'EWTRVND', index_code), name=paste(index_name, 'TR EW (VND)'), date, close=index_ewd, rt=rtd_ew)]
    INDEX_ONE_CWD = INDEX_ONE[, .(code=gsub('PRVND', 'CWTRVND', index_code), name=paste(index_name, 'TR CW (VND)'), date, close=index_cwd, rt=rtd_cw)]
    
    INDEX_ONE_ALL = rbind(INDEX_ONE_EW, INDEX_ONE_CW, INDEX_ONE_EWD, INDEX_ONE_CWD)
    My.Kable(INDEX_ONE_ALL)
    My.Kable.All(unique(INDEX_ONE_ALL[order(code, -date)], by='code'))
    End.time = Sys.time()
    
    CLOSE_4INDEX = copy(INDEX_ONE_ALL)
    CLOSE_4INDEX[, ':='(source='IFRC', codesource=code)]
    CLOSE_4INDEX = CLOSE_4INDEX[order(code, date)]
    CLOSE_4INDEX[, ":="(change=close-shift(close), varpc=100*rt)]
    CLOSE_4INDEX[, name:=gsub('  ',' ', gsub(paste(INDEX_DUPL,INDEX_DUPL), INDEX_DUPL, name))]
    
    CLOSE_4INDEX[, cur:=substr(code, nchar(code)-2, nchar(code))]
    CLOSE_4INDEX[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
    CLOSE_4INDEX[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
    CLOSE_4INDEX[, updated:=SYS.TIME()]
    
    My.Kable.TB(CLOSE_4INDEX)
    My.Kable.All(unique(CLOSE_4INDEX[order(code, -date)], by='code'))
    
    CCPR_SAVERDS(CLOSE_4INDEX, paste0('S:/STKVN/INDEX_2024/'), BEQIND_NAME_VND, ToSummary = T, SaveOneDrive = T)
    
    try(IFRC_INDEXES_CONVERT_CURRENCIES_FROM_USDVND(IND_FOLDER   = 'S:/STKVN/INDEX_2024/', CUR_FROM = 'VND', ISO2 = "VN",
                                                    IND_PREFIX_NAME = '', 
                                                    IND_FROMCUR  = BEQIND_NAME_VND,
                                                    IND_FILENAME = BEQIND_NAME_VND))
    
    ALL_4INDEX = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', BEQIND_NAME_VND, ToKable = T, ToRestore = T)))
    ALL_4INDEX[, ':='(codesource=code, source='IFRC', iso2='VN', continent='ASIA', country='VIETNAM', provider='IFRC')]
    
    IND_PREFIX = INDEX_NAME
    ALL_4INDEX[cur!='VND', name:=paste0(IND_PREFIX, ' ', prtr, ' ', wgtg, ' ', '(', cur, ')')]
    ALL_4INDEX[, short_name:=gsub('IFRC/BEQ HOLDINGS','', name)]
    ALL_4INDEX[, updated:=SYS.TIME()]
    
    My.Kable.TB(ALL_4INDEX[, -c('iso2', 'country', 'continent', 'monitor', 'type', 'codesource', 'name')][order(date, code)][cur=='VND'], Nb=10)
    My.Kable.TB(ALL_4INDEX[, -c('iso2', 'country', 'continent', 'monitor', 'type', 'codesource', 'name')][order(date, code)][cur!='VND'], Nb=10)
    My.Kable.TB(ALL_4INDEX[, -c('iso2', 'country', 'continent', 'monitor', 'type', 'codesource', 'name')][order(date, code)], Nb=10)
    
    CCPR_SAVERDS(ALL_4INDEX, 'S:/STKVN/INDEX_2024/', BEQIND_NAME_HST, ToSummary = T, SaveOneDrive = T)
    
    # ***
    # ADD INSREF
    DBL_RELOAD_INSREF(ToForce = T)
    sort(names(ins_ref))
    IND_INSREF = ins_ref[type=='IND' & grepl('IFRC', provider, ignore.case=T) & !grepl('VOLATILITY|FEAR|SENTIMENT', provider) & 
                           grepl(SEARCH_INSREF, name, ignore.case = T)][, .(provider, fcat, scat, code, name, short_name, cur, prtr, wgtg)]
    My.Kable.All(IND_INSREF)
    ALL_4INDEX_INREF = ALL_4INDEX[, .(type='IND', provider='IFRCLAB', fcat='INDVN', scat='EQUITY',
                                      name=name[1], short_name=short_name[1], cur=cur[1], prtr=prtr[1], wgtg=wgtg[1], last=close[.N], records=.N, 
                                      startdate=date[1], enddate=date[.N], date=date[.N], base_value=close[1], base_date=date[1], active=1), by='code']
    My.Kable.All(ALL_4INDEX_INREF[, -c('type', 'fcat', 'scat', 'active')])
    
    ALL_4INDEX_INREF_NEW = ALL_4INDEX_INREF[!code %in% ins_ref$code]
    
    My.Kable.All(ALL_4INDEX_INREF_NEW[, -c('type', 'fcat', 'scat', 'active')], l.Text='NEW')
    
    if (nrow(ALL_4INDEX_INREF_NEW)>0)
    {
      # names(ins_ref)[12]
      N0      = nrow(ins_ref)
      ins_ref = rbind(ins_ref, ALL_4INDEX_INREF_NEW[, base_date:=as.character(base_date)], fill=T)
      N1      = nrow(ins_ref)
      CATln_Border(paste(N1-N0, 'new records'))
      CCPR_SAVERDS(ins_ref, UData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
      CCPR_SAVERDS(ins_ref, CCPRData, 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
      CCPR_SAVERDS(ins_ref, 'S:/CCPR/DATA/', 'efrc_ins_ref.rds', ToSummary = T, SaveOneDrive = T)
    }
    Data_Compo = MERGE_DATASTD_BYCODE(Data_Compo, pOption='FINAL')
    Data_Compo[, capivnd:=sharesout*close]
    Data_Compo[, updated:=SYS.TIME()]
    Data_Compo[, index_name:=INDEX_NAME]
    My.Kable(Data_Compo[, .(index_name, code, name, market, date, sharesout, reference, close, capivnd, updated)][order(date, capivnd)])
    CCPR_SAVERDS(Data_Compo, 'S:/STKVN/INDEX_2024/', BEQIND_NAME_CMP, ToSummary = T, SaveOneDrive = T)
  } else {
    CATln_Border('ALREADY DONE.')
  }
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('BEQ_INDEX_2024 >', INDEX.NAME), pAction="SAVE", NbSeconds=1, ToPrint=F))
  # x = try(CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste('BEQ_INDEX_2024 >', INDEX.NAME), pAction="SAVE", NbSeconds=3600, ToPrint = T))
  CATln_Border(paste('BEQ_INDEX_2024 =', INDEX.NAME, ' - END.'))
  
  x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', BEQIND_NAME_HST, ToKable = T, ToRestore = T)))
  return(x)
}

# ==================================================================================================
CALCULATE_UPLOAD_BEQ_INDEX_2024_V0 = function (INDEX.NAME = 'LOGISTICS', ToCheckDate = T) {
  
  DBL_RELOAD_INSREF()
  
  if (INDEX.NAME == 'VIETNAM_INDEXES') {
    PREFIX = tolower('VN')
    Fr_File_Path = paste0('S:/STKVN/INDEX_2024/', 'beq_ind', PREFIX, '_history.rds')
    To_File_Path = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_ind', PREFIX, '.rds')
    
    if (ToCheckDate) {
      if (TRAINEE_SUMMARY_DATE_RDS(Fr_File_Path) > TRAINEE_SUMMARY_DATE_RDS(To_File_Path)) {
        
        # OVERVIEW
        OVERVIEW = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_VIETNAM_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/INDEX_2024/', 
                                                                  Fr_File = paste0('beq_ind', PREFIX, '_history.rds'),
                                                                  To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_ind', PREFIX, '.rds'), 
                                                                  DateLimit = Sys.Date()  ,
                                                                  ToSave = T, ToUpload = T , pHost = 'dashboard_live') )
      } 
    } else {
      message("No update performed due to date check.")
    }
    
  } else {
    switch (INDEX.NAME,
            'LOGISTICS' = {
              PREFIX = tolower('LOG')
            },
            'BROKERAGE' = {
              PREFIX = tolower('BRK')
            },
            'PETROLIMEX' = {
              PREFIX = tolower('PET')
            },
            'REALESTATE' = {
              PREFIX = tolower('RST')
            },
            'RETAIL' = {
              PREFIX = tolower('RTL')
            },
            'BANK' = {
              PREFIX = tolower('BNK')
            },
            'HEALTHCARE' = {
              PREFIX = tolower('HLC')
            },
            'ENERGY' = {
              PREFIX = tolower('ENY')
            },
            'FINANCE' = {
              PREFIX = tolower('FIN')
            },
            'AI' = {
              PREFIX = tolower('ARI')
            }
    )
    
    Fr_File_Path = paste0('S:/STKVN/INDEX_2024/', 'beq_ind', PREFIX, 'als_history.rds')
    To_File_Path = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_ind', PREFIX, '.rds')
    x = readRDS(To_File_Path)
    CCPR_SAVERDS(x, 'S:/CCPR/DATA/DASHBOARD_LIVE/', paste0('ccpi_dashboard_ind', PREFIX, '.rds'), ToSummary=T)
    
    
    if (ToCheckDate) {
      if (TRAINEE_SUMMARY_DATE_RDS(Fr_File_Path) > TRAINEE_SUMMARY_DATE_RDS(To_File_Path)) {
        
        # OVERVIEW
        OVERVIEW = try( TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK  (pOption = 'CCPI_INTERNATIONAL_INDEXES', Fr_Data = data.table(),  Fr_Folder = 'S:/STKVN/INDEX_2024/', 
                                                                  Fr_File = paste0('beq_ind', PREFIX, 'als_history.rds'),
                                                                  To_Folder = 'S:/CCPR/DATA/DASHBOARD_LIVE/', To_File = paste0('ccpi_dashboard_ind', PREFIX, '.rds'), 
                                                                  DateLimit = Sys.Date()  ,
                                                                  ToSave = T, ToUpload = T , pHost = 'dashboard_live') )
        print(OVERVIEW)
        
        # CHART
        CHART = try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = 'dashboard_live', l.tablename= paste0('ccpi_dashboard_ind', PREFIX, '_history'),
                                                 l.filepath= tolower(paste0('S:/STKVN/INDEX_2024/',  paste0('beq_ind', PREFIX, 'als_history.rds')) ),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
        print(CHART)
        
      } 
    } else {
      message("No update performed due to date check.")
    }
  }
  
}

# ==================================================================================================
TRAINEE_SUMMARY_DATE_RDS = function(pFileName, ToBrowse=T, DateOnly=T) {
  # ------------------------------------------------------------------------------------------------
  # pFileName = paste0(UData, "download_EXC_stk_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_ref.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_day.rds")
  File_Summary = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
  datemax      = as.Date("1900-01-01")
  xDate        = datemax
  
  if (file.exists(File_Summary))
  {
    x = try(setDT(fread(File_Summary, sep='\t', fill=T)))
    if (all(class(x)!='try-error') && nrow(x)>0)
    {
      # str(x)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="numeric", List_Fields=list("last", "nbdays", "nb", 'sample', 'home'), ToConvertSeparator=F)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list("type", "code", "source", "codesource"), ToConvertSeparator=F)
      if ("type" %in% names(x)) { x[, type:=as.character(type)]}
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="date", List_Fields=list("start", "date", "datelast"), ToConvertSeparator=F)
      if (DateOnly){ x[nchar(as.character(date))>10, date:=as.character(substr(date,1,10))]}
      x = x[nchar(as.character(date))==10][, date:=as.Date(date)]
      xDate = max(x[!is.na(date)]$date)
    }
    
    # str(x)
  }
  # x = SUMMARY_DATE(gsub(".rds", "_summary.txt", pFileName, ignore.case=T))
  if (ToBrowse)
  {
    CATln(paste(FormatSS(pFileName, 85), FormatSS(xDate, 12)))
    catrep('-',100)
  }
  return(xDate)
}

# ==================================================================================================
SUMMARY_DATE_RDS = function(pFileName, ToBrowse=T, DateOnly=T) {
  # ------------------------------------------------------------------------------------------------
  # pFileName = paste0(UData, "download_EXC_stk_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_ref.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_day.rds")
  File_Summary = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
  datemax      = as.Date("1900-01-01")
  xDate        = datemax
  
  if (file.exists(File_Summary))
  {
    x = try(setDT(fread(File_Summary, sep='\t', fill=T)))
    if (all(class(x)!='try-error') && nrow(x)>0)
    {
      # str(x)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="numeric", List_Fields=list("last", "nbdays", "nb", 'sample', 'home'), ToConvertSeparator=F)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list("type", "code", "source", "codesource"), ToConvertSeparator=F)
      if ("type" %in% names(x)) { x[, type:=as.character(type)]}
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="date", List_Fields=list("start", "date", "datelast"), ToConvertSeparator=F)
      if (DateOnly){ x[nchar(as.character(date))>10, date:=as.character(substr(date,1,10))]}
      x = x[nchar(as.character(date))==10][, date:=as.Date(date)]
      xDate = max(x[!is.na(date)]$date)
    }
    
    # str(x)
  }
  # x = SUMMARY_DATE(gsub(".rds", "_summary.txt", pFileName, ignore.case=T))
  if (ToBrowse)
  {
    CATln(paste(FormatSS(pFileName, 85), FormatSS(xDate, 12)))
    catrep('-',100)
  }
  return(xDate)
}


# ==================================================================================================
TRAINEE_COMPARE_UPDATED_TO_UPLOAD = function (pDiv = '', pHost = 'dashboard_live', pTable  = 'ccpi_dashboard_wti', pFolder = 'S:/CCPR/DATA/DASHBOARD_LIVE/' )  {
  # ------------------------------------------------------------------------------------------------
  x = TRAINEE_LOAD_SQL_HOST (pTableSQL = pTable, pHost = pHost, ToDisconnect=T, ToKable=T)
  
  y = CCPR_READRDS( pFolder, paste0(pTable, '.rds'))
  
  if (nrow(x)>0 & nrow(y) >0)
  {
    pResult = unique (x$updated)< max( unique (y$updated) )
    pDuration = difftime (unique (y$updated), max( unique (y$updated) ),  units="secs")
  }
  print (pDuration)
  return (pDuration)
}

# ==================================================================================================
TRAINEE_DASHBOARD_CCPI_STKVN_COMPO = function(pOption ='ICB', List_Codes = list (), pSector = '' ,
                                              FilePrices = 'S:/CCPR/DATA/DASHBOARD/ifrc_ccpr_stkvn_all_history.rds',
                                              ToFolder = ''  , ToFile = '' ,
                                              pHost = ''  , DateLimit = '2024-05-22' ,
                                              ToSave = F, ToUpload = F) {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  # STEP 1: READ FILE PRICES HISTORY
  Data_All = try (readRDS (FilePrices))
  if ( ! 'close_adj' %in% names (Data_All)) { Data_All [, close_adj := close]}
  if ( ! 'name' %in% names (Data_All)) { Data_All = merge (Data_All, ins_ref [,.(code, name)], all.x = T, by = 'code')}
  if (length (List_Codes) > 0) { 
    x = Data_All [ code %in% List_Codes]}  else { 
      x = Data_All
      
    } 
  colnames(x)
  # cleanse raw data
  x = unique(x, by = c('code', 'date'))
  
  
  # STEP 2: RE-CALCULATE DATA
  Ind_History = x  [date <= DateLimit]  
  my_date = max (Ind_History$date)
  
  str(Ind_History)
  
  Ind_History = Ind_History[order(code, date)] 
  Ind_History[, ':='(change=close_adj-shift(close_adj), varpc=100*(close_adj/shift(close_adj)-1)), by='code']
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_adj/shift(close_adj))-1, by='code']
  
  # Ind_Quarter = unique(Ind_History[order(code, -date)][, yyyymm:=100*year(date)+month(date)], by=c('code', 'yyyymm'))[order(code, date)]
  # Ind_Quarter[, rtm:=(close/shift(close))-1, by='code']
  
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code'))[, .(code, name, date, last=close_adj, change, varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  My.Kable(Ind_Overview)
  
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  # End.time = Sys.time()
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  Ind_All 
  
  # STEP 3: ADD missing COLUMNS: market, sector, industry, size, ticker
  switch ( pOption, 
           'ICB'  = { icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
           # CCPR_SAVERDS(icb, 'S:/CCPR/DATA/', 'STKVN_ICB_ALL.rds')
           }  ,
           'GICS' = { gics = setDT (read_xlsx('S:/CCPR/DATA/DASHBOARD/From_BloombergVN_GICS_en.xlsx'))
           gics = TRAINEE_CLEAN_COLNAMES(gics)
           gics [san == 'UPCOM', market := 'UPC']
           gics [san == 'HOSE',  market := 'HSX']
           gics [san == 'HNX',   market := 'HNX']
           # colnames(gics)
           # gics [ ,. (code1 = code___5, name1 = gics_1 )]
           })
  # 
  #  open_day = readRDS("R:/CCPR/DATA/IFRC_CCPR/ifrc_ccpr_stkvn_open_history.rds")
  # shares =  CCPR_READRDS( 'R:/CCPR/DATA/DAY/', 'ccpr_download_all_stkvn_shares_history.rds')
  # Data_All = merge (Data_All, shares [,. (code, date,sharesout = final)], all.x = T, by = c('code', 'date'))
  # CCPR_SAVERDS (Data_All,'R:/CCPR/DATA/DASHBOARD/','ifrc_ccpr_stkvn_all_history.rds' )
  Data_All [, capivnd:= sharesout*reference]
  # Data_All [is.na(sharesout), capivnd:= shareslis*reference]
  Data_All [ !is.na(capivnd), ':=' (capibnvnd = capivnd/1000000000, capi_musd = capivnd/(1000000*24250))]
  y = merge(Data_All, icb[,.(code, sector = icb1_name,  industry = icb2_name)], all.x= T, by = 'code')
  Ind_All  = merge( Ind_All, y [,.(capibnvnd ,capivnd  ,code, date, market,     sector   , industry)], all.x = T, by = c('code' , 'date') )
  # my_day   = Ind_All [date == my_date] ; my_day
  # icb      = merge(icb, my_day[,.(code, capivnd)], all.x = T, by = 'code')
  
  if ( nchar (pSector) >0)  {
    my_short_list = Ind_All [ grepl(pSector, icb1_name )]
  } else { my_short_list = Ind_All}
  
  # my_indvn = Ind_All
  # download_ssi_stkvn_ref = readRDS('R:/CCPR/DATA/STKVN/download_ssi_stkvn_ref.rds')
  # market   = unique( rbind (icb, download_ssi_stkvn_ref , fill =T) [order(-market)], by = 'code') [,.(code, market)]
  # my_data  = merge(my_indvn, icb[,.(code,sector = toupper(icb1_name), industry = toupper(icb2_name), 
  #                                   sub_ind = toupper(icb3_name), icb4 = toupper(icb4_name), capivnd)], all.x = T, by = 'code')
  # my_xdata = merge(my_data, market, all.x = T, by = 'code')
  # my_xdata [is.na(market)]
  # my_xdata [!grepl('VNI',name) & is.na(market), market:= 'OTC']
  # saveRDS (my_xdata, 'R:/CCPR/DATA/DASHBOARD/ccpr_stkvn_all_performance.rds')
  
  # my_short_list = my_xdata [is.na(market) | market %in% c('HSX','HNX')] # [is.na(industry)]
  # my_short_list = my_short_list [order(-capivnd)]
  # nacapi = my_short_list [is.na(capivnd)] $code
  # pcapi  = unique(open_day [code %in% nacapi] [order(-date)] , by = 'code')
  # my_short_list  [order(name)] [is.na(capivnd) & !grepl('VNI',name) ] $capivnd = pcapi$capivnd
  # 
  
  
  MaxDate = max(my_short_list$date)
  STKVN_CLEANED = copy(my_short_list[!is.na(capivnd) & date==MaxDate])
  STKVN_CLEANED[, sum_capi:=sum(capivnd), by='date']
  STKVN_CLEANED[, cum_capi:=cumsum(capivnd), by='date']
  STKVN_CLEANED[, pc_capi:=100*cum_capi/sum_capi, by='date']
  STKVN_CLEANED[pc_capi<=85, size:='LARGE']
  STKVN_CLEANED[pc_capi>85 & pc_capi<=95, size:='MID']
  STKVN_CLEANED[pc_capi>95, size:='SMALL']
  STKVN_CLEANED$pc_capi = NULL
  STKVN_CLEANED$cum_capi = NULL
  STKVN_CLEANED$sum_capi = NULL
  My.Kable(STKVN_CLEANED)
  STKVN_CLEANED[, updated:= substr (as.character(Sys.time()),1,19)]
  STKVN_CLEANED[, ticker:=gsub('STKVN', '', code)]
  STKVN_CLEANED[, short_name:=trimws(toupper(name))]
  STKVN_CLEANED[, weight := round(100*capivnd/ sum(capivnd),2)]
  STKVN_CLEANED = STKVN_CLEANED [order (-weight)]
  # str(STKVN_CLEANED)
  if (ToSave ) {
    CCPR_SAVERDS(STKVN_CLEANED,ToFolder, ToFile , ToSummary=T, SaveOneDrive = T) }
  
  # STEP 4: UPLOAD DATA
  if( ToUpload ) {
    
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= gsub ('.rds','', tolower(ToFile) ),
                                     l.filepath= tolower(paste0(ToFolder,  ToFile) ),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T)) 
  }
  
  My.Kable(STKVN_CLEANED)
  return ( STKVN_CLEANED)
  
}


# ==================================================================================================
TRAINEE_DOWNLOAD_SOURCE_PRICESBOARD_OPEN_CLOSE_DAY = function (pSource = 'TVSI', 
                                                               Save_Folder = 'S:/STKVN/PRICES/DAY/',
                                                               Save_File = '') {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-27 17:31
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  Data_final  = data.table()
  
  switch (pSource,
          'TVSI' = {
            hsx = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'UPCOM')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_TVSI_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_TVSI_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'VST' = {
            hsx = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='HSX', pURL = 'https://banggia.vietstock.vn/bang-gia/hose')
            hnx = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='HNX', pURL = 'https://banggia.vietstock.vn/bang-gia/hnx')
            upc = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='UPC', pURL = 'https://banggia.vietstock.vn/bang-gia/upcom')
            Data_final = rbind(hsx, hnx, upc)
            Data_final[, close := as.numeric(NA)]
            Data_final[, date := LastTrading]
            Data_final[, updated :=substr(as.character(Sys.time()), 1, 19)]
            
            # pHour =  as.POSIXct(substr(as.character(Sys.time()), 1, 19))
            # hour   = unique(format(pHour, "%H"))
            # minute = unique(format(pHour, "%M"))
            # is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
            
            
            
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VST_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VST_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'EXC' = {
            # hnx = TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
            #                                         Source = 'EXC',
            #                                         Market = 'HNX')
            # upc = TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
            #                                         Source = 'EXC',
            #                                         Market = 'UPC')
            
            hsx = try(TRAINEE_DOWNLOAD_EXC_PRICESBOARD (Source = 'EXC', Market = 'HSX'))
            
            hsx = readRDS('S:/STKVN/PRICES/DAY/DOWNLOAD_HSX_PRICESBOARD_DAY.rds')
            
            hnx = try(TRAINEE_DOWNLOAD_EXC_PRICESBOARD (Source = 'EXC', Market = 'HNX'))
            
            upc = try(TRAINEE_DOWNLOAD_EXC_PRICESBOARD (Source = 'EXC', Market = 'UPC'))
            
            Data_final = rbind(hnx, upc, hsx)
            if (nrow(Data_final)>0)
            {
              My.Kable(Data_final)
              
              Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                           "close", "date", "updated", "name", 'change'), with = FALSE]
              UPDATE_UPDATED (Data_final)
              Data_final[last == 0, last := as.numeric(NA)]
              # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
              # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
              if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
                Data_final[, close := last]
                Data_final[is.na(volume) & close == reference][, volume := 0]
                
              }
              if (substr(as.character(Sys.time()),12,13)< 12) {
                Data_final[, reference_open := reference]
              } else { Data_final[, reference_close := reference] }
              Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
              Data_final[!is.na(reference) & volume == 0, last := reference]
              Data_final[volume == 0, close := last]
              Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
              
              if (nchar(Save_File) > 0)
              {
                Save_File_Day = paste0('DOWNLOAD_EXC_PRICESBOARD_DAY.rds')
                Save_File = paste0('DOWNLOAD_EXC_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
                CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
                CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
              }
            }
          },
          'VND' = {
            hsx = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='HSX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hose')
            hnx = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='HNX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hnx')
            upc = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='UPC', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/upcom')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VND_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VND_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'MBS' = {
            upc = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'UPC',
                                              code = '091')
            
            hnx = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'HNX',
                                              code = '011')
            
            hsx = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'HSX',
                                              code = '012')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_MBS_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_MBS_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }, 
          'BSC' = {
            upc = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'UPCOM')
            hsx = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'HOSE')
            hnx = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'HNX')
            
            Data_final <- rbind(upc, hsx, hnx)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_BSC_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_BSC_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'VPS' = {
            upc = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'UPC',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            hsx = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'HSX',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            hnx = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'HNX',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VPS_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VPS_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }, 
          'C68' = {
            
            hsx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=2&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=3&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'UPC')
            # 
            # hsx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'HSX')
            # 
            # hnx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'HNX')
            # 
            # upc = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'UPC')
            
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_C68_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_C68_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'CAF' = {
            
            
            
            upc =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'UPC',
                                                                 pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            hsx =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'HSX',
                                                                 pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            hnx =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'HNX',
                                                                 pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name", 'change'), with = FALSE]
            UPDATE_UPDATED (Data_final)
            Data_final[last == 0, last := as.numeric(NA)]
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            Data_final[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
            Data_final[!is.na(reference) & volume == 0, last := reference]
            Data_final[volume == 0, close := last]
            Data_final[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_CAF_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_CAF_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }
  )
  if (nrow(Data_final) > 0)
  {
    UPDATE_UPDATED (Data_final)
    Data_final[last == 0, last := as.numeric(NA)]
  }
  
  # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
  return (Data_final)
  
}



# ==================================================================================================
NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE = function( ranking    = '', FirstChars = 'ABC', random = F,
                                             pMarket    = 'HNX', 
                                             pFolder    = 'S:/STKVN/PRICES/DAY/',
                                             File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                             pDate      = Sys.Date(),
                                             List_Codes = list(),
                                             File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                             Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT') {
  # ------------------------------------------------------------------------------------------------
  
  # ranking    = 'ASC'; FirstChars = ''; random = F;  pMarket    = 'HNX'; pDate      = Sys.Date();   List_Codes = list()
  # pFolder    = 'S:/STKVN/PRICES/DAY/';  File_Name  = paste0('TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE_', gsub('-','', Sys.Date()), '.rds')
  # File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds"
  
  DBL_RELOAD_INSREF()
  File_Name = paste0(File_Pattern,'_', gsub('-','', pDate), '.rds')
  FilePath  = paste0(pFolder, File_Name)
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  Data_All  = data.table()
  # File_Codes_RAW = gsub('S:/CCPR/DATA/','', File_Codes)
  count_char = str_count(File_Codes, "[/]")
  
  File_Codes_RAW   = word(File_Codes, count_char+1, count_char+1, "[/]")
  Folder_Codes_RAW = paste0(word(File_Codes, 1, count_char, "[/]"),'/')
  
  if (length(List_Codes)==0 & nchar(File_Codes)>0)
  {
    List_Codes = CCPR_READRDS(Folder_Codes_RAW, File_Codes_RAW, ToKable = T, ToRestore = T)
    List_Codes = unique(List_Codes[order(-date)], by = 'codesource' )
    List_Codes = as.vector(List_Codes$codesource)
  }
  
  if (nchar(ranking)>0)
  {
    switch (ranking,
            'ASC' = {
              List_Codes = sort(List_Codes, decreasing = F)
            },
            'DESC' = {
              List_Codes = sort(List_Codes, decreasing = T)
            })
  }
  
  if (nchar(FirstChars)>0)
  {
    char_set <- strsplit(FirstChars, "")[[1]]
    # inChars <- 'ABC'
    # > List_CODES <- c('AAB', 'AAC', 'BCC', 'XXY')
    # Vectorized filtering for efficiency
    Selected_Codes = List_Codes[substr(List_Codes, 1, 1) %in% char_set]
    List_Codes = Selected_Codes 
  }
  print(List_Codes)
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  
  ExtraFolder = ''
  
  if (file.exists(FilePath))
  {
    Data_old = CHECK_CLASS(try( CCPR_READRDS(pFolder, File_Name, ToKable = T, ToRestore = T)))
    
    if (nrow(Data_old)>0) 
    {
      Data_done = unique(Data_old[!is.na(codesource)][order(-date)], by = 'codesource')
      # str(Data_done)
      Data_List = Data_done[codesource %in% List_Codes & date >= pDate]
      List_Codes_ToDo = setdiff(List_Codes, as.vector(Data_List$codesource))
      length(List_Codes_ToDo)
    } else {
      List_Codes_ToDo = List_Codes
    }
  } else { 
    CATln(paste('FILE NO EXIST :', FilePath))
    Data_old = data.table() 
    List_Codes_ToDo = List_Codes
  }
  print(List_Codes_ToDo)
  
  
  # ================================================================================================
  
  if (length(List_Codes_ToDo)>0)
  {
    Data_All = Data_old
    if (random){
      List_Codes_ToDo = sample(List_Codes_ToDo)
    }
    Data_All = data.table()
    Data_List = list()
    
    FileDataAll = List_Codes_ToDo
    FileRow  = nrow(List_Codes_ToDo)
    Nb_Total = length(List_Codes_ToDo)
    
    FileToSave = paste0(File_Name)
    Total_Time  = 0
    
    for (i in 1:Nb_Total)
    {
      # i = 1
      Start.Time = Sys.time()
      pCode    = List_Codes_ToDo[i]
      CATln("")
      
      Sys.sleep(1)
      My_Data = data.table()
      
      if (! pCode %in% Data_All$codesource)
      {
        switch(Action,
               'TRAINEE_DOWNLOAD_YAH_BOARD_EXECUTIVES_GENDER' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_BOARD_EXECUTIVES_GENDER (pCode=pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(codesource=pCode, updated = SYS.TIME())] 
                 }  
                 IFRC_SLEEP(5)
               },
               'TRAINEE_DOWNLOAD_YAH_PRICES_ALL_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_ALL_BY_CODE (pCode=pCode, NB_Day = 20000, Dividend = T, Capi = T)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(codesource=pCode, updated = SYS.TIME())] 
                 }  
               },
               'TRAINEE_DOWNLOAD_VND_FINANCIAL_RATIOS' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VND_FINANCIAL_RATIOS (pCode = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(codesource=pCode, updated = SYS.TIME())] 
                 }                
               },
               'TRAINEE_DOWNLOAD_VND_ACCOUNTING' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VND_ACCOUNTING (pCode = pCode, PERIOD = 'YEAR')))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(codesource=pCode, updated = SYS.TIME())] 
                 }                
               },
               'TRAINEE_DOWNLOAD_VND_STKVN_BOARD_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VND_STKVN_BOARD_BY_CODE (pCode = pCode)  ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = SYS.TIME())] 
                 }
               },
               'TRAINEE_DOWNLOAD_FANT_STKVN_DIV_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_FANT_STKVN_DIV_BY_CODE (pCodesource = pCode, Starttime=8)  ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='FANT', codesource=pCode, updated = SYS.TIME())] 
                 }
               },
               'TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_FANT_PRICES_BY_CODE(pCodesource = pCode, Starttime=8, STOCK = T)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='FANT', codesource=pCode, updated = SYS.TIME())] 
                 }
               },
               
               'TRAINEE_DOWNLOAD_YAH_STK_DIVIDEND' = {
                 xCode = paste0(pCode, '.VN')
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_STK_DIVIDEND( pCode = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='YAH', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               },
               
               'TRAINEE_DOWNLOAD_YAH_STKVN_PRICES_BY_CODE' = {
                 xCode = paste0(pCode, '.VN')
                 My_Data = CHECK_CLASS(try(DOWNLOAD_YAH_INS_PRICES_UNADJ(p_nbdays_back= 250000, tickers=xCode, freq.data='daily', p_saveto="", NbTry=15))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='YAH', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               },
               'TRAINEE_DOWNLOAD_YAH_STKVN_DIV_BY_CODE' = {
                 xCode = paste0(pCode, '.VN')
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_DIVIDEND(pCode = xCode, Nbdays = 10000, ToKable = T, silent = T) )) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='YAH', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE (pCode = pCode))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLOAD_VST_STKVN_DIV_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VST_STKVN_DIV_BY_CODE (pCode = pCode))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VST', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='UPC', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) # HNX
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='HNX', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'DOWNLOAD_CAF_STKVN_SNAPSHOT' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_SNAPSHOT_BY_CODE (pCode  = pCode, URL = '', ToAdd = F)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'DOWNLOAD_STB_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_STB_STKVN_PRICESDAY_BY_CODE ( pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='STB', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               },                
               'DOWNLOAD_CAF_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_CAF_STKVN_PRICESDAY_BY_CODE ( pCodesource  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_DNSE_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'DNSE', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='DNSE', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_VND_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'VND', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_VPS_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'VPS', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VPS', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_C68_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'C68', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='C68', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_VND_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = 'VND', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_DNSE_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = 'DNSE', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='DNSE', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_24H_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = '24HMONEY', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='24H', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_CAF_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_CAF_STKVN_SHARES_BY_CODE (pCode  = pCode, URL = '', ToAdd = F) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               }, 
               'TRAINEE_DOWNLOAD_C68_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_C68_STKVN_SHARES_BY_CODE (pCode = pCode) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               },
               'TRAINEE_DOWNLOAD_VST_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_VST_STKVN_SHARES_BY_CODE (pCode = pCode) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               },
               'TRAINEE_DOWNLOAD_STB_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_STB_STKVN_SHARES_BY_CODE (pCode = pCode) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               },
               'TRAINEE_DOWNLOAD_HNX_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_HNX_STKVN_SHARES_BY_CODE (pCode = pCode) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               },
               'TRAINEE_DOWNLOAD_VND_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_VND_STKVN_SHARES_BY_CODE (pCode = pCode) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               },
        )
        
        My.Kable (My_Data)
        # My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) 
        # if (all(class(My_Data)!='try-error') )
        if (! 'date' %in% names (Data_All)) { Data_All [, date := pDate]}
        
        if (! 'code' %in% names(Data_All)){Data_All[, code := as.character(NA)]}
        if (all(class(My_Data)!='try-error') && nrow(My_Data)>0)
        {
          Data_old_restore = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name, ToKable = T, ToRestore = T)))
          Data_All = rbind(Data_All, My_Data, Data_old, Data_old_restore, fill=T)[!is.na(codesource)]
          Data_All[, market:=pMarket]
          if (Action == 'TRAINEE_DOWNLOAD_VND_FINANCIAL_RATIOS'){
            Data_All = unique(Data_All, by=c('code', 'itemcode', 'year'))
            My.Kable(Data_All)
          } else {
            Data_All = unique(Data_All[order(codesource, date, -updated)], by=c('codesource', 'date'))
            My.Kable(Data_All)
          }
          
          
          CCPR_SAVERDS(Data_All, pFolder, File_Name, ToSummary=T, SaveOneDrive = T)
          CATln_Border(paste ('SAVED: ', paste0(pFolder, File_Name), '=', nrow(Data_All), 'records') )
          
        }
      }
      
      End.Time = Sys.time()
      Total_Time = Format.Number(as.numeric(difftime(End.Time, Start.Time, units = 'secs')), 3) 
      # Avg_Time = Total_Time / i
      # End_Forecast = Avg_Time * (Nb_TODO - i)
      # Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
      # CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      CATln_Border(paste('DURATION :', substr(Total_Time,1,19)))
    }
    
  } else {
    CATln_Border(paste0('DATA FULLY UPDATED = ',FilePath))
    Sys.sleep(2)
  }
  return(Data_All)
}





# ==================================================================================================
MERGE_DAY_TO_HISTORY = function(File_Folder = 'S:/STKVN/PRICES/DAY/',
                                File_Name = 'download_hsx_stkvn_shares_day.rds',
                                File_History = '') {
  # ------------------------------------------------------------------------------------------------
  
  Data_History = data.table()
  x = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T, ToRestore = T)))
  if (nrow(x) > 0)
  {
    if (nchar(File_History) == 0)
    {
      File_History = gsub('_day','_history',File_Name)
    }
    Data_History = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_History, ToKable = T, ToRestore = T)))
    Data_History = rbind(Data_History, x, fill = T)
    if (nrow(Data_History) > 0)
    {
      Data_History = unique(Data_History, by = c('code', 'date'), fromLast = T)
      My.Kable(Data_History)
      CCPR_SAVERDS(Data_History, File_Folder, File_History, ToSummary = T, SaveOneDrive = T)
    }
  }
  return(Data_History)
}


NEW_TRAINEE_DOWNLOAD_SOURCE_PRICESBOARD_OPEN_CLOSE_DAY = function (pSource = 'TVSI', 
                                                                   Save_Folder = 'S:/STKVN/PRICES/DAY/',
                                                                   Save_File = '') {
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  Data_final  = data.table()
  
  switch (pSource,
          'TVSI' = {
            hsx = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'UPCOM')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_TVSI_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_TVSI_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'VST' = {
            hsx = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='HSX', pURL = 'https://banggia.vietstock.vn/bang-gia/hose')
            hnx = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='HNX', pURL = 'https://banggia.vietstock.vn/bang-gia/hnx')
            upc = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='UPC', pURL = 'https://banggia.vietstock.vn/bang-gia/upcom')
            Data_final = rbind(hsx, hnx, upc)
            Data_final[, close := as.numeric(NA)]
            Data_final[, date := LastTrading]
            Data_final[, updated :=substr(as.character(Sys.time()), 1, 19)]
            
            # pHour =  as.POSIXct(substr(as.character(Sys.time()), 1, 19))
            # hour   = unique(format(pHour, "%H"))
            # minute = unique(format(pHour, "%M"))
            # is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
            
            
            
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VST_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VST_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'EXC' = {
            # hnx = TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
            #                                         Source = 'EXC',
            #                                         Market = 'HNX')
            # upc = TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
            #                                         Source = 'EXC',
            #                                         Market = 'UPC')
            
            hsx = TRAINEE_DOWNLOAD_EXC_PRICESBOARD (Source = 'EXC', Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_EXC_PRICESBOARD (Source = 'EXC', Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_EXC_PRICESBOARD (Source = 'EXC', Market = 'UPC')
            
            Data_final = rbind(hnx, upc, hsx)
            if (nrow(Data_final)>0)
            {
              My.Kable(Data_final)
              
              Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                           "close", "date", "updated", "name"), with = FALSE]
              UPDATE_UPDATED (Data_final)
              # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
              # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
              if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
                Data_final[, close := last]
                Data_final[is.na(volume) & close == reference][, volume := 0]
                
              }
              if (substr(as.character(Sys.time()),12,13)< 12) {
                Data_final[, reference_open := reference]
              } else { Data_final[, reference_close := reference] }
              
              if (nchar(Save_File) > 0)
              {
                Save_File_Day = paste0('DOWNLOAD_EXC_PRICESBOARD_DAY.rds')
                Save_File = paste0('DOWNLOAD_EXC_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
                CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
                CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
              }
            }
          },
          'VND' = {
            hsx = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='HSX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hose')
            hnx = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='HNX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hnx')
            upc = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='UPC', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/upcom')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VND_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VND_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'MBS' = {
            upc = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'UPC',
                                              code = '091')
            
            hnx = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'HNX',
                                              code = '011')
            
            hsx = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'HSX',
                                              code = '012')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_MBS_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_MBS_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }, 
          'BSC' = {
            upc = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'UPCOM')
            hsx = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'HOSE')
            hnx = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'HNX')
            
            Data_final <- rbind(upc, hsx, hnx)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_BSC_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_BSC_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'VPS' = {
            upc = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'UPC',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            hsx = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'HSX',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            hnx = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'HNX',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VPS_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VPS_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }, 
          'C68' = {
            
            hsx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=2&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=3&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'UPC')
            # 
            # hsx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'HSX')
            # 
            # hnx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'HNX')
            # 
            # upc = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'UPC')
            
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_C68_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_C68_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'CAF' = {
            
            
            
            upc =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'UPC',
                                                                 pURL = 'https://dev-s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            hsx =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'HSX',
                                                                 pURL = 'https://dev-s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            hnx =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'HNX',
                                                                 pURL = 'https://dev-s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_CAF_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_CAF_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }
  )
  UPDATE_UPDATED (Data_final)
  
  # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
  return (Data_final)
  
}

# ==================================================================================================
TRAINEE_LOAD_SQL_HOST = function(pTableSQL = 'wcw_directory', pHost = '', ToDisconnect=T, ToKable=T) {
  # ------------------------------------------------------------------------------------------------
  host_dt      = data.table()
  my.connexion = try(TRAINEE.IFRC.CONNEXTION.2023 (pHost))
  print(my.connexion)
  
  if (all(class(my.connexion)!='try-error'))
  {
    CATrp("Read Table...")
    host_dt = try(dbReadTable(my.connexion,pTableSQL))
    
    if (all(class(host_dt)!='try-error'))
    {
      OutDt = setDT(host_dt)
      My.Kable(host_dt)
      str(host_dt)
    } 
  } else {
    CATln(paste(pHost, ": NO CONNEXION."))
  }
  
  CATln(paste('CCPR_LOAD_SQL_HOST : ', pTableSQL, ' - DONE, ', Sys.time()))
  if (ToKable) { My.Kable.MaxCols(host_dt) }
  if (ToDisconnect) { try(dbDisconnect(my.connexion),silent = T) }
  return(host_dt)
}

# ==================================================================================================
SYS.TIME = function() {
  # ------------------------------------------------------------------------------------------------
  # CATln(SYS.TIME())
  return(substr(as.character(Sys.time()),1,19))
}

# ==================================================================================================
TRAINEE_LOOP_ACTION_BYPC = function() {
  # ------------------------------------------------------------------------------------------------
  pMyPC = as.character(try(fread("C:/R/my_pc.txt", header = F)))
  
  
  if ( (CHECK_TIMEBETWEEN('16:30' , '23:30') | CHECK_TIMEBETWEEN('01:00' , '06:00') ) & wday(Sys.Date()) %in% c(2:6)  )
  {
    if (pMyPC %in% list ('IFRC-IREEDS', 'IFRC-3630'))
      
    {
      for (ind.name in sample(LIST_INDEX_NAMES))
      {
        ind = try(BEQ_INDEX_2024(INDEX.NAME = ind.name, MinDate = Sys.Date(), ToCheckDate = T))
        ind = try(CALCULATE_UPLOAD_BEQ_INDEX_2024 (INDEX.NAME = ind.name, ToCheckDate = T))
      }
    }
  }
  
  
  if (CHECK_TIMEBETWEEN('08:00' , '15:00') & wday(Sys.Date()) %in% c(2:6) )
  {
    try(TRAINEE_DOWNLOAD_SOURCES_STKVN_INFO())
    Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_DOWNLOAD_SOURCES_STKVN_INFO', pAction="SAVE", NbSeconds=1, ToPrint=F))
  }
  
  if (CHECK_TIMEBETWEEN('08:00' , '23:00') & wday(Sys.Date()) %in% c(2:6) )
  {
    for (pSource in sample(LIST_SOURCES_SHARES))
    {
      # pSource = 'CAF'
      List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
      # List_SetChars = list('A')
      
      LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
      
      for (pFirstChars in sample(List_SetChars))
      {
        hsx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                    pMarket    = 'HSX', 
                                                    pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                    File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES'),
                                                    pDate      = LastTrading,
                                                    List_Codes = list(),
                                                    File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
                                                    Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_SHARES_BY_CODE')))
        
        hnx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                    pMarket    = 'HNX', 
                                                    pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                    File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES'),
                                                    pDate      = LastTrading,
                                                    List_Codes = list(),
                                                    File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                    Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_SHARES_BY_CODE')))
        
        upc = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                    pMarket    = 'UPC', 
                                                    pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                    File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES'),
                                                    pDate      = LastTrading,
                                                    List_Codes = list(),
                                                    File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                    Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_SHARES_BY_CODE')))
      }
      # rm(hsx, hnx, upc)
      GC_SILENT()
    }
  }
}

# ==================================================================================================
FIX_ACTION = function(Action='DOWNLOAD_HSX_STKVN_SNAPSHOT_DAY', pPROBA = 80)  {
  # ------------------------------------------------------------------------------------------------
  switch(Action,
         'DOWNLOAD_EXC_SHARES_DAY_HISTORY' = {
           # pPROBA = 80
           for (pMarket in list('HSX', 'HNX', 'UPC'))
           {
             try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = paste0('download_', pMarket, '_stkvn_shares_day.rds'), 
                                                                       Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = paste0('download_', pMarket, '_stkvn_shares_history.rds'), 
                                                                       pCondition  = '', 
                                                                       RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>pPROBA)))
             
             try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = paste0('download_', pMarket, '_stkvn_shares_history.rds'), 
                                                                       Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = paste0('download_', pMarket, '_stkvn_shares_day.rds'), 
                                                                       pCondition  = '', 
                                                                       RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>pPROBA)))
             
             try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = paste0('download_', pMarket, '_stkvn_shares_day.rds'), 
                                                                       Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = paste0('download_', 'EXC',   '_stkvn_shares_day.rds'), 
                                                                       pCondition  = '', 
                                                                       RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>pPROBA)))
             
             try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = paste0('download_', pMarket, '_stkvn_shares_history.rds'), 
                                                                       Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = paste0('download_', 'EXC',   '_stkvn_shares_history.rds'), 
                                                                       pCondition  = '', 
                                                                       RemoveNA    = T, NbDays = 0, MinPercent  = 0, ToForce=(runif(1,1,100)>pPROBA)))
             
           }
         },
         
         'DOWNLOAD_HSX_STKVN_REF' = {
           ToCheckDate = (runif(1,1,100)>90)
           # ................................................................................................
           pOption = "download_hsx_stkvn_ref.rds" ; pHH = 9 ### OK
           # ................................................................................................
           DATACENTER_LINE_BORDER(paste(pOption, ": Executing ..."))
           if (SUMMARY_DATE_RDS_UDATA(pOption) < SYSDATETIME(pHH) || !ToCheckDate)
           {
             Start.RUN = Sys.time()
             hsx_ref = try(DOWNLOAD_HSX_STKVN_REF())                         # download_hsx_stkvn_ref.rds and summary.txt
             My.Kable(hsx_ref)
             End.RUN = Sys.time()
             CATln_Border(paste('DURATION = ', Format.Number(difftime(End.RUN, Start.RUN, units='secs'),2), ''))
           } else { CATln('SKIP.')}
         },
         'DOWNLOAD_HNX_STKVN_REF' = {
           ToCheckDate = (runif(1,1,100)>50)
           # ..................................................................................................
           pOption = "download_hnx_stkvn_ref.rds" ; pHH = 9 ### OK
           # ..................................................................................................
           DATACENTER_LINE_BORDER(paste(pOption, ": Executing ..."))
           if (SUMMARY_DATE_RDS_UDATA(pOption) < SYSDATETIME(pHH) || !ToCheckDate)
           {
             Start.RUN = Sys.time()
             hnx_ref = try(DOWNLOAD_EXC_STKVN_REF (pEXC="HNX", ToUpdate=F))  # download_hnx_stkvn_ref.rds and summary.txt
             My.Kable(hsx_ref)
             End.RUN = Sys.time()
             CATln_Border(paste('DURATION = ', Format.Number(difftime(End.RUN, Start.RUN, units='secs'),2), ''))
           } else { CATln('SKIP.')}
         },
         
         'DOWNLOAD_UPC_STKVN_REF' = {
           # MHM_DOWNLOAD_UPC_STKVN_REF_NEW(SaveFolder="U:/EFRC/DATA/STKVN/DAY/REF/EXC/", nrl=20, ToIntegrateHistory=T)
           
           ToCheckDate = (runif(1,1,100)>50)
           # ................................................................................................
           pOption = "download_upc_stkvn_ref.rds" ; pHH = 9 ### OK
           # ................................................................................................
           DATACENTER_LINE_BORDER(paste(pOption, ": Executing ..."))
           if (SUMMARY_DATE_RDS_UDATA(pOption) < SYSDATETIME(pHH) || !ToCheckDate)
           {
             Start.RUN = Sys.time()
             upc_ref = try(DOWNLOAD_EXC_STKVN_REF (pEXC="UPC", ToUpdate=F))  # download_upc_stkvn_ref.rds and summary.txt
             My.Kable(upc_ref)
             End.RUN = Sys.time()
             CATln_Border(paste('DURATION = ', Format.Number(difftime(End.RUN, Start.RUN, units='secs'),2), ''))
           } else { CATln('SKIP.')}
         },
         
         'DOWNLOAD_HSX_STKVN_SNAPSHOT_DAY' = {
           if (file.exists(UData))
           {
             DBL_RELOAD_INSREF()
             LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
             HSX_SHARES       = CCPR_READRDS(UData, 'download_hsx_stkvn_ref.rds', ToKable = T, ToRestore = T)
             if ('shout' %in% names(HSX_SHARES))
             {
               MaxDate          = max(HSX_SHARES$date)
               HSX_SHARES_DAY   = HSX_SHARES[date==MaxDate]
               HSX_SHARES_DAY[, code:=paste0('STKVN', ticker)]
               HSX_SHARES_DAY[, sharesout:=shout]
               HSX_SHARES_DAY[, shareslis:=shlis]
               HSX_SHARES_DAY = merge(HSX_SHARES_DAY[, -c('name')], ins_ref[, .(code, name=short_name)], all.x = T, by='code')
               HSX_SHARES_DAY = UPDATE_UPDATED(HSX_SHARES_DAY)
               My.Kable.TB(HSX_SHARES_DAY[, .(code, date, sharesout, shareslis)])
               CCPR_SAVERDS(HSX_SHARES_DAY, 'S:/STKVN/PRICES/DAY/', 'DOWNLOAD_HSX_STKVN_SNAPSHOT_DAY.rds', ToKable = F, SaveOneDrive=T)
             } else {
               CATln_Border('YOU DONT HAVE ACESS TO UDATA')
             }
           }
         }
  )
}


# ==============================================================================
TRAINEE_DOWNLOAD_YAH_STK_DIVIDEND = function(pCode = 'AAPL')  {
  # ----------------------------------------------------------------------------
  # pCode = 'X12345'
  # pCode = 'XRXR'
  # pCode = 'FPT.VN'
  Epoch_Now = floor(EPOCH_NOW())
  # pURL = 'https://query1.finance.yahoo.com/v8/finance/chart/AAPL?region=US&lang=en-US&includePrePost=false&interval=1mo&useYfid=true&range=1d&corsDomain=finance.yahoo.com&.tsrc=finance'
  pURL  = paste0('https://finance.yahoo.com/quote/', pCode, '/history?period1=0&period2=', Epoch_Now, '&interval=capitalGain%7Cdiv%7Csplit&filter=div&frequency=1d&includeAdjustedClose=true')
  # pURL  = paste0('https://finance.yahoo.com/quote/', pCode, '/history?period1=962409600&period2=1688169600&interval=capitalGain%7Cdiv%7Csplit&filter=div&frequency=1d&includeAdjustedClose=true')
  # pURL = 'https://finance.yahoo.com/quote/IBM/history?period1=962409600&period2=1688169600&interval=capitalGain%7Cdiv%7Csplit&filter=div&frequency=1d'
  CATln_Border(pURL)
  
  
  response   = GET(pURL, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  xweb       = content(response, as="text")
  content    = try(rvest::read_html(xweb))
  
  # content  = rvest::read_html(pURL)
  tables   = content %>% html_table(fill = TRUE)
  # rm(d.dates)
  d.dates  = try(as.data.table(tables[[1]]$Date), silent=T)
  if (! ( is.null(nrow(d.dates)) || nrow(d.dates)==0) )
  {
    class(d.dates)
    dates = d.dates[, .(date = as.Date(V1, '%B %d, %Y'))][!is.na(date)]
    
    d.dividends  = as.data.table(tables[[1]]$Dividend)
    d.dividends[, V1:=gsub(',','', V1)]
    dividends    = d.dividends[, .(dividend = as.numeric(word(V1,1,1)))][!is.na(dividend)]
    
    MyData       = cbind(dates, dividends)
    MyData[, ':='(source='YAH', codesource=pCode, dataset='DIVIDEND', updated=substr(as.character(Sys.time()),1,19))]
    setnames(MyData, 'dividend', 'close')
    MyData       = MyData %>% select(source, codesource, dataset, date, close, everything())
    MyData       = MyData[order(date)]
    My.Kable.All(MyData)
  } else {
    CATln('NO DATA')
    MyData = data.table() 
  }
  return(MyData)
}

# ==================================================================================================
OLD_TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE = function(pCode="VNM") {
  # ------------------------------------------------------------------------------------------------
  # pCode = "VNM"
  TRAINEE_MONITOR_EXECUTION_SUMMARY (pOption='TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE', pAction="SAVE", NbSeconds=3600, ToPrint=F) 
  
  print(paste0(pCode,":  DOWNLOADING..."))
  caf_url = paste0("https://s.cafef.vn/hose/",pCode,".chn")
  caf_cnt = content(GET(caf_url),"text",encoding = "UTF-8")
  caf_cnt = tolower(stri_trans_general(caf_cnt, "ASCII"))
  caf_div = gsub('.*class="tt view-more-btn"',"",caf_cnt)
  caf_div = gsub('ngay hien thi la ngay gd khong huong quyen.*',"",caf_div)
  
  
  div_type = str_split(caf_div,"</b>: ")[[1]]
  if (length(div_type)>1)
  {
    type_temp   = data.table(typeraw=div_type[2:length(div_type)])
    type_temp[,id:=seq(1,.N)]
    type_temp[,typeraw:=paste("temp",id," ",gsub('&ensp;',paste("temp",id," "),typeraw)),by="id"]
    dt_type = data.table(type = unlist(str_split(type_temp$typeraw,"temp")))
    dt_type = dt_type[nchar(type)>0]
    dt_type[grepl("ty le.*%", type),valuepc := gsub('.*ty le ','',gsub("%.*","",type))]
    dt_type[,":="(id = as.integer(gsub(" .*","",trimws(type))),
                  type = gsub(',.*',"",gsub('&nbsp;',"",type)))]
    dt_type[,type:=gsub(paste0(paste0(id,collapse = "|"),'|</font>.*'),"",type)]
    
    div_date = str_split(caf_div,"<b>")[[1]]
    div_date = gsub("</b>.*","",div_date[2:length(div_date)])
    dt_date  = data.table(date = as.Date(div_date, format="%d/%m/%Y"))
    dt_date[,id:=seq(1,.N)]
    
    dt_div = merge(dt_type, dt_date, by="id", all.x=T)
    dt_div = dt_div[,.(ticker = pCode, code = paste0("STKVN",pCode), dataset = "DIVIDEND", date, event = tolower(type),
                       ratiopc = as.numeric(gsub(",","\\.",valuepc)),
                       close = ifelse(grepl("co tuc.*tien", type), 10000*as.numeric(as.numeric(gsub(",","\\.",valuepc)))/100, as.numeric(NA)),
                       source = "CAF", updated = substr( as.character(Sys.time()),1,19))]
    dt_div = MERGE_DATASTD_BYCODE(dt_div, pOption='FINAL')
  }else { dt_div = data.table() }
  
  My.Kable (dt_div)
  return(dt_div)
}

# ==================================================================================================
TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO = function(Folder_Fr = UData, File_Fr = 'EFRC_CUR_HISTORY.RDS',
                                                        Folder_To = UData, File_To = 'EFRC_CUR_HISTORY_1M.RDS', RemoveNA = T, NbDays = 31, pCondition = '', IncludedOnly = F) {
  # ------------------------------------------------------------------------------------------------
  GC_SILENT()
  DATACENTER_LINE_BORDER_BEGINEND(paste('TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO :',File_To), 'BEGIN')
  Data_Fr     = CHECK_CLASS(try(CCPR_READRDS(Folder_Fr, File_Fr, ToKable = T, ToRestore = T)))
  if (nrow(Data_Fr)>0)
  {
    if (File_Fr != File_To)
    {
      Data_To     = CHECK_CLASS(try(CCPR_READRDS(Folder_To, File_To, ToKable = T, ToRestore = T)))
    } else { Data_To =  data.table()}
    
    if (IncludedOnly)
    {
      Data_Fr = Data_Fr[code %in% Data_To$code]
    }
    
    Data_To     = rbind(Data_To, Data_Fr, fill=T)
    My.Kable.Min(Data_To)
    if (nrow(Data_To)>0)
    {
      Data_To = unique(Data_To, by=c('code', 'date'))[order(code, date)]
      if (RemoveNA) { Data_To = Data_To[!is.na(code) & !is.na(date)]}
      if (NbDays!=0)
      {
        # Data_To[, x.maxdate:=max(date), by='code']
        Data_To = Data_To[order(code, -date)]
        Data_To[, x.nr:=seq.int(1,.N), by='code']
        
        Data_To = Data_To[x.nr<=NbDays]
        Data_To = Data_To[order(code, date)]
        Data_To$x.nr = NULL
      }
      Data_To = MERGE_DATASTD_BYCODE(Data_To, pOption='FINAL')[!is.na(date) & date>="1800-01-01" & date<="2099-12-31"]
      if (nchar(pCondition)>0) {  Data_To = Data_To[eval(parse(text = pCondition))] }
      
      Data_To[, type:=substr(code, 1,3)]
      Data_To$close = as.numeric(Data_To$close)
      
      Data_To[type!='STK', close_adj:=close]
      if ('close' %in% names(Data_To)) { Data_To[type!='STK' & !is.na(rt), rt:=(close/shift(close))-1, by='code'] }
      CATln_Border("MERGED DATA")
      My.Kable.Min(Data_To[order(date)])
    }
    if (nrow(Data_To)>0)
    {
      try(CCPR_SAVERDS(Data_To, Folder_To, File_To, ToKable = T, ToSummary = T, SaveOneDrive = T))
    }
  }
  DATACENTER_LINE_BORDER_BEGINEND(paste('TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO :',File_To), 'END')
  GC_SILENT()
}

# ==================================================================================================
TRAINEE_CONVERT_FILE_RDS_TO_FST = function(pData = data.table(), File_Folder, File_Name = 'download_ssi_stkvn_ref_history.rds', FST_Folder = '') {
  # ------------------------------------------------------------------------------------------------
  # pData       = data.table()
  # File_Folder = 'S:/STKVN/PRICES/DAY/'
  # File_Name   = 'download_vnd_pricesboard_day.rds'
  # FST_Folder  = ''
  CATln_Border(paste('TRAINEE_CONVERT_FILE_RDS_TO_FST : ', paste0(File_Folder, File_Name)))
  if (nrow(pData)>0)
  {
    RDS_Data = copy(pData)
  } else {
    RDS_Data = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name)))
  }
  
  if (nrow(RDS_Data)>0)
  {
    if (nchar(FST_Folder)==0)
    {
      FST_Path = paste0(File_Folder, gsub(".rds", ".fst", File_Name, ignore.case = T)) 
    } else {
      FST_Path = paste0(File_Folder, gsub(".rds", ".fst", File_Name, ignore.case = T)) 
    }
    fst_file = fst::write_fst(RDS_Data, FST_Path)
    CATln_Border(paste('TRAINEE_CONVERT_FILE_RDS_TO_FST : ', paste0(File_Folder, File_Name), '- DONE.'))
    
  } else {
    CATln_Border('WARNING = NO DATA')
  }
}

# ==================================================================================================
REPORT_OVERVIEW_DASHBOARD = function(option = 'DASHBOARD') {
  # ------------------------------------------------------------------------------------------------
  # LastUpdated = 2024-05-16 12:01
  
  Start.Time = Sys.time()
  data       = setDT(read_excel("S:/SHINY/REPORTS/GUIDE_UPDATE_UPLOAD.xlsx"))
  dataid     = data[, id:=seq.int(1, .N)]
  My.Kable.All(dataid[,. (DIV, FILE, FOLDER, FILE_NAME)])
  
  final_data = list()
  for (k in 1:nrow(data)) 
  {
    #k = 19
    file_name = paste0(data[k]$FOLDER, data[k]$FILE_NAME)
    CATln(''); CATln(paste(k, file_name))
    
    if (file.exists(file_name))
    {
      xData      = try(readRDS(file_name), silent = TRUE)
      updated    = max(na.omit(xData$updated))
      delay      = as.numeric(difftime(Sys.time(), updated, units='mins'))
      temp_data  = data.table(option   = option,
                              DIV      = data[k]$DIV,
                              updated  = updated,
                              UPDATED  = NA,
                              WARNING  = NA,
                              DAY      = NA,
                              MORE     = NA,
                              BUG      = NA)
      if (!is.na(delay)) {
        if (delay <= 30) {
          temp_data[, UPDATED := tolower(data[k]$FILE_NAME)]
        } else if (delay > 30 && delay <= 60) {
          temp_data[, WARNING := tolower(data[k]$FILE_NAME)]
        } else if (delay > 60 && delay <= 1440) {
          temp_data[, DAY := tolower(data[k]$FILE_NAME)]
        } else {
          temp_data[, MORE := tolower(data[k]$FILE_NAME)]
        }
        final_data[[k]] =temp_data
      } else {
        temp_data[, BUG := tolower(data[k]$FILE_NAME)]
      }
      
    }
  }
  
  report_overview  = rbindlist(final_data, fill = TRUE)
  My.Kable.All(report_overview)
  file_name        = paste0("S:/SHINY/REPORT/REPORT_OVERVIEW/report_overview_dashboard.rds")
  saveRDS(report_overview, file_name)
  
  x                = try(readRDS(file_name), silent = TRUE) 
  fst_file         = fst::write_fst(x, gsub(".rds", ".fst", file_name, ignore.case = T))
  
  End.Time         = Sys.time()
  Total_Time       = Format.Number(as.numeric(difftime(End.Time, Start.Time, units = 'secs')), 3) 
  CATln_Border(paste('DURATION :', substr(Total_Time,1,19)))
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='REPORT_OVERVIEW_DASHBOARD', pAction="SAVE", NbSeconds=1, ToPrint=F))
  
  return(report_overview)
}

MERGE_HSX_HNX_UPC_TO_EXC = function(Prefix= 'PRICESBOARD')
{
  # ------------------------------------------------------------------------------------------------
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  
  switch(Prefix,
         'PRICESBOARD' = {
           # ..................................................................................................
           # Prefix      = 'PRICESBOARD'
           # ..................................................................................................
           try(TRAINEE_REPAIR_SUMMARY_RDS (File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_exc_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_exc_pricesboard_day.rds')))
           
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hnx_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hnx_pricesboard_day.rds')))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_hnx_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           
           
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           pMarket     = 'UPC'
           try(TRAINEE_REPAIR_SUMMARY_RDS (File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_upc_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_upc_pricesboard_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_hsx_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           
           pMarket     = 'HSX'
           try(TRAINEE_REPAIR_SUMMARY_RDS (File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hsx_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hsx_pricesboard_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           My.Kable.All(x[,.(date=max(date, na.rm=T), n=.N) , by='market'])
           # ..................................................................................................
         },
         'SNAPSHOT' = {
           # ..................................................................................................
           # Prefix      = 'SNAPSHOT'
           # ..................................................................................................
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hnx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_snapshot_day.rds'), ToSummary = T, SaveOneDrive = F)
           
           pMarket     = 'UPC'
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_upc_stkvn_snapshot_',gsub('-','',LastTrading),'.rds')))
           
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'))))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_snapshot_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           
           pMarket     = 'HSX'
           hsx = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/','download_hsx_stkvn_shares_day.rds',  ToKable = T, ToRestore = T)))
           CCPR_SAVERDS(hsx, 'S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_', gsub('-','',LastTrading), '.rds'), ToSummary = T, SaveOneDrive = T)
           
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hsx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_snapshot_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_stkvn_snapshot_day.rds', ToKable = T, ToRestore = T)))
           x[, source := 'EXC']
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_snapshot_day.rds'), ToSummary = T, SaveOneDrive = T)
           # CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_shares_day.rds'), ToSummary = T, SaveOneDrive = F)
           
           My.Kable.All(x[,.(date=max(date, na.rm=T), n=.N) , by='market'])
         },
         
         'SHARES' = {
           # ..................................................................................................
           # Prefix      = 'SHARES'
           # ..................................................................................................
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hnx_stkvn_shares_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_shares_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_shares_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_shares_day.rds'), ToSummary = T, SaveOneDrive = T)
           
           pMarket     = 'UPC'
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_shares_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_upc_stkvn_shares_',gsub('-','',LastTrading),'.rds')))
           
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_shares_',gsub('-','',LastTrading),'.rds'))))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_shares_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           
           pMarket     = 'HSX'
           hsx = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/','download_hsx_stkvn_shares_day.rds',  ToKable = T, ToRestore = T)))
           # CCPR_SAVERDS(hsx, 'S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_', gsub('-','',LastTrading), '.rds'), ToSummary = T, SaveOneDrive = F)
           
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hsx_stkvn_shares_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_shares_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_shares_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_shares_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_stkvn_shares_day.rds', ToKable = T, ToRestore = T)))
           x[, source := 'EXC']
           # CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_snapshot_day.rds'), ToSummary = T, SaveOneDrive = F)
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_shares_day.rds'), ToSummary = T, SaveOneDrive = T)
           
           My.Kable.All(x[,.(date=max(date, na.rm=T), n=.N) , by='market'])
         }
  )
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('MERGE_HSX_HNX_UPC_TO_EXC >', Prefix), pAction="SAVE", NbSeconds=1, ToPrint=F))
}


OLD_MERGE_HSX_HNX_UPC_TO_EXC = function(Prefix= 'PRICESBOARD')
{
  # ------------------------------------------------------------------------------------------------
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  
  switch(Prefix,
         'PRICESBOARD' = {
           # ..................................................................................................
           # Prefix      = 'PRICESBOARD'
           # ..................................................................................................
           try(TRAINEE_REPAIR_SUMMARY_RDS (File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_exc_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_exc_pricesboard_day.rds')))
           
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hnx_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hnx_pricesboard_day.rds')))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_hnx_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           
           
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           pMarket     = 'UPC'
           try(TRAINEE_REPAIR_SUMMARY_RDS (File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_upc_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_upc_pricesboard_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_hsx_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           
           pMarket     = 'HSX'
           try(TRAINEE_REPAIR_SUMMARY_RDS (File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hsx_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hsx_pricesboard_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           My.Kable.All(x[,.(date=max(date, na.rm=T), n=.N) , by='market'])
           # ..................................................................................................
         },
         'SNAPSHOT' = {
           # ..................................................................................................
           # Prefix      = 'SNAPSHOT'
           # ..................................................................................................
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hnx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_snapshot_day.rds'), ToSummary = T, SaveOneDrive = T)
           
           pMarket     = 'UPC'
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_upc_stkvn_snapshot_',gsub('-','',LastTrading),'.rds')))
           
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'))))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_snapshot_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           
           pMarket     = 'HSX'
           hsx = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/','download_hsx_stkvn_shares_day.rds',  ToKable = T, ToRestore = T)))
           CCPR_SAVERDS(hsx, 'S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_', gsub('-','',LastTrading), '.rds'), ToSummary = T, SaveOneDrive = T)
           
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hsx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_snapshot_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_stkvn_snapshot_day.rds', ToKable = T, ToRestore = T)))
           x[, source := 'EXC']
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_snapshot_day.rds'), ToSummary = T, SaveOneDrive = T)
           # CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_shares_day.rds'), ToSummary = T, SaveOneDrive = F)
           
           My.Kable.All(x[,.(date=max(date, na.rm=T), n=.N) , by='market'])
         },
         'SHARES' = {
           # ..................................................................................................
           # Prefix      = 'SHARES'
           # ..................................................................................................
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hnx_stkvn_shares_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_shares_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hnx_stkvn_shares_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_shares_day.rds'), ToSummary = T, SaveOneDrive = T)
           
           pMarket     = 'UPC'
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_shares_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_upc_stkvn_shares_',gsub('-','',LastTrading),'.rds')))
           
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_upc_stkvn_shares_',gsub('-','',LastTrading),'.rds'))))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_shares_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           
           pMarket     = 'HSX'
           hsx = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/','download_hsx_stkvn_shares_day.rds',  ToKable = T, ToRestore = T)))
           # CCPR_SAVERDS(hsx, 'S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_snapshot_', gsub('-','',LastTrading), '.rds'), ToSummary = T, SaveOneDrive = F)
           
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = paste0('download_hsx_stkvn_shares_',gsub('-','',LastTrading),'.rds')))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_shares_',gsub('-','',LastTrading),'.rds'))))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('download_hsx_stkvn_shares_',gsub('-','',LastTrading),'.rds'), ToKable = T, ToRestore = T)))
           
           File_name  = paste0('download_', pMarket, '_' ,'stkvn_', Prefix, '_',gsub('-','',LastTrading),'.rds')
           
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name,
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_stkvn_shares_day.rds',
                                                                     pCondition  = '',
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_stkvn_shares_day.rds', ToKable = T, ToRestore = T)))
           x[, source := 'EXC']
           # CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_snapshot_day.rds'), ToSummary = T, SaveOneDrive = F)
           CCPR_SAVERDS(x,  'S:/STKVN/PRICES/DAY/', paste0('download_exc_stkvn_shares_day.rds'), ToSummary = T, SaveOneDrive = T)
           
           My.Kable.All(x[,.(date=max(date, na.rm=T), n=.N) , by='market'])
         }
  )
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('MERGE_HSX_HNX_UPC_TO_EXC >', Prefix), pAction="SAVE", NbSeconds=1, ToPrint=F))
}

# ==================================================================================================
OLD_MERGE_HSX_HNX_UPC_TO_EXC = function(Prefix= 'PRICESBOARD')  {
  # ------------------------------------------------------------------------------------------------
  switch(Prefix,
         'SNAPSHOT' = {
           # ..................................................................................................
           Prefix      = 'SNAPSHOT'
           # ..................................................................................................
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_exc_SNAPSHOT_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_exc_SNAPSHOT_day.rds')))
           
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hnx_SNAPSHOT_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hnx_SNAPSHOT_day.rds')))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_hnx_SNAPSHOT_day.rds', ToKable = T, ToRestore = T)))
           
           
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_SNAPSHOT_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           pMarket     = 'UPC'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_upc_SNAPSHOT_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_upc_SNAPSHOT_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_SNAPSHOT_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_upc_SNAPSHOT_day.rds', ToKable = T, ToRestore = T)))
           
           pMarket     = 'HSX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hsx_SNAPSHOT_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hsx_SNAPSHOT_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_SNAPSHOT_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_SNAPSHOT_day.rds', ToKable = T, ToRestore = T)))
           My.Kable.All(x[,.(prefix=Prefix, date=max(date, na.rm=T), n=.N) , by='market'])
           # ..................................................................................................
         },
         
         'PRICESBOARD' = {
           # ..................................................................................................
           Prefix      = 'PRICESBOARD'
           # ..................................................................................................
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_exc_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_exc_pricesboard_day.rds')))
           
           pMarket     = 'HNX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hnx_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hnx_pricesboard_day.rds')))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_hnx_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           
           
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           pMarket     = 'UPC'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_upc_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_upc_pricesboard_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_upc_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           
           pMarket     = 'HSX'
           try(TRAINEE_REPAIR_SUMMARY_RDS(File_Folder = 'S:/STKVN/PRICES/DAY/', File_RDS = 'download_hsx_pricesboard_day.rds'))
           print(SUMMARY_DATE(paste0('S:/STKVN/PRICES/DAY/', 'download_hsx_pricesboard_day.rds')))
           File_name  = paste0('download_', pMarket, '_', Prefix, '_day.rds')
           try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO (Folder_Fr   = 'S:/STKVN/PRICES/DAY/', File_Fr     = File_name, 
                                                                     Folder_To   = 'S:/STKVN/PRICES/DAY/', File_To     = 'download_exc_pricesboard_day.rds', 
                                                                     pCondition  = 'source=="EXC"', 
                                                                     RemoveNA    = T, NbDays = 1, MinPercent  = 0, ToForce=(runif(1,1,100)>0)))
           
           x = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_exc_pricesboard_day.rds', ToKable = T, ToRestore = T)))
           My.Kable.All(x[,.(prefix=Prefix, date=max(date, na.rm=T), n=.N) , by='market'])
           # ..................................................................................................
         }
  )
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('MERGE_HSX_HNX_UPC_TO_EXC >', Prefix), pAction="SAVE", NbSeconds=1, ToPrint=F))
  
}


# ==================================================================================================
TRAINEE_LOADRDS_SUMMARY = function(pFolder=UData, pFileRDS='IFRC_CUR_4INDEX.rds') {
  # ------------------------------------------------------------------------------------------------
  Data_Summary = data.table()
  File_Fullpath = paste0(pFolder, gsub('.rds$', '_summary.txt', pFileRDS, ignore.case = T))
  if (file.exists(File_Fullpath))
  {
    Data_Summary = setDT(fread(File_Fullpath, sep='\t'))
    Data_Summary$capiusd = NULL
    My.Kable.TB(Data_Summary[order(date)], Nb=5)
  }
  return(Data_Summary)
}


# ==============================================================================
TRAINEE_REPAIR_SUMMARY_RDS = function(File_Folder=UData, File_RDS = 'EFRC_COV_HISTORY_1M.rds') {
  # ----------------------------------------------------------------------------
  if (file.exists(paste0(File_Folder, File_RDS)))
  {
    File_Summary = CHECK_CLASS(try(TRAINEE_LOADRDS_SUMMARY(File_Folder, File_RDS)))
    if (nrow(File_Summary)==0)
    {
      CATln('Reparing ...')
      My_Data = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_RDS, ToKable = T)))
      if (nrow(My_Data)==0)
      {
        file.remove(paste0(File_Folder, File_RDS))
        file.remove(paste0(File_Folder, gsub('.rds$', '_summary.txt', File_RDS, ignore.case=T)))
      } else {
        try(CCPR_SAVERDS(My_Data, File_Folder, File_RDS, ToSummary = T, SaveOneDrive = T))
      }
    }
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VST_STKVN_DIV_BY_CODE = function(pCode      = 'VNM')  {
  # ------------------------------------------------------------------------------------------------
  TRAINEE_MONITOR_EXECUTION_SUMMARY (pOption='TRAINEE_DOWNLOAD_VST_STKVN_DIV_BY_CODE', pAction="SAVE", NbSeconds=3600, ToPrint=F) 
  Final_Data = data.table()
  pURL       = paste0('https://finance.vietstock.vn/', pCode, '/news-event.htm')
  CATln_Border(pURL)
  File_Temp  = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '', Sys.time())), '.txt')
  # xweb       = IFRC_CCPR_WEB_SAVE_AS(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
  xweb       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('DIV_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T, pSleep = 10)
  
  content    = try(rvest::read_html(xweb))
  Sys.sleep(5)
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    xData      = CHECK_CLASS(try(as.data.table(tables[[10]])))
    if (nrow(xData)>0)
    {
      xData      = xData[grepl('Trả cổ tức|bằng tiền', X2)]
      # xData[,x2:=vietnameseConverter::decodeVN(X2, from='Unicode', to='Unicode', diacritics=F)]
      # My.Kable(xData)
      Final_Data = xData[, .(source='VST', dataset='DIVIDEND', codesource=pCode, code=paste0('STKVN', pCode),
                             date   = as.Date(X1, '%d/%m/%Y'), 
                             close  = as.numeric(gsub(',',"", word(word(X2,2,2,'bằng tiền,'),1,1,' đồng'))), updated=as.character(Sys.Date()))]
      Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption='FINAL')
      My.Kable.All(Final_Data)
    }
  } else {
    CATln_Border('NO DATA')
  }
  return(Final_Data)
}
# ==================================================================================================
TRAINEE_REPORT_DAY_OPENCLOSE = function (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                         LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'STB', 'DCL'),
                                         SESSION = 'OPEN') {
  # ------------------------------------------------------------------------------------------------
  
  LIST_PRICES_BOARD       = list()
  LIST_SNAPSHOT           = list()
  LIST_COUNT_NB_DATE_PRICESBOARD = list()
  LIST_COUNT_SOURCE = list()
  for ( k in 1:length(LIST_SOURCES))
  {
    # k = 1
    pSource = LIST_SOURCES[[k]]
    PRICES_BOARD = COUNT_NUMBER_DATE(File_Folder = File_Folder, Prefix = 'PRICESBOARD', Dataset='', pSource = pSource, STKVN=F)
    SNAPSHOT = COUNT_NUMBER_DATE(File_Folder = File_Folder, Prefix = 'SNAPSHOT', Dataset='SHARESOUT', pSource = pSource, STKVN=T)
    if (nrow(PRICES_BOARD)> 0 | nrow(SNAPSHOT) > 0)
    {
      LIST_PRICES_BOARD[[pSource]]= PRICES_BOARD
      LIST_SNAPSHOT[[pSource]]= SNAPSHOT
    }
  }
  DATA_ALL_PRICESBOARD = rbindlist(LIST_PRICES_BOARD, fill = TRUE)
  DATA_ALL_SNAPSHOT = rbindlist(LIST_SNAPSHOT, fill = TRUE)
  unique(DATA_ALL_SNAPSHOT$source)
  report_pricesboard = setDT (spread(DATA_ALL_PRICESBOARD, key='source', value='output'))
  if (nrow(DATA_ALL_SNAPSHOT) > 0) 
  {
    report_snapshot = setDT (spread(DATA_ALL_SNAPSHOT, key='source', value='output'))
    report_pricesboard = rbind(report_pricesboard, report_snapshot[, -c('nd', 'percent', 'dataset')], fill = T)
  }
  My.Kable.All(report_pricesboard)
  report_pricesboard = UPDATE_UPDATED(report_pricesboard)
  
  # if (nrow(DATA_ALL_SNAPSHOT) > 0) {report_snapshot = setDT (spread(DATA_ALL_SNAPSHOT, key='source', value='output'))}
  My.Kable.All(report_pricesboard)
  report_pricesboard = UPDATE_UPDATED(report_pricesboard) 
  CCPR_SAVERDS(report_pricesboard,paste0('S:/SHINY/STKVN/', SESSION,'/'), 'report_pricesboard_number_date.rds')
  
  ### LOOP COUNT NUMBER AND DATE (LIST DATASET)
  LIST_DATASET      =  list('REFERENCE', 'MARKET', 'SHARESOUT')
  if (SESSION == 'CLOSE') {LIST_DATASET = list('REFERENCE', 'MARKET', 'SHARESOUT', 'VOLUME', 'CLOSE') }
  
  for (i in 1:length(LIST_SOURCES))
  {
    pSource = LIST_SOURCES[[i]]
    for (k in 1:length(LIST_DATASET) )
    {
      # k = 1
      dataset = LIST_DATASET[[k]]
      COUNT_PRICESBOARD = CHECK_CLASS(try( COUNT_NUMBER_DATE(File_Folder='S:/STKVN/PRICES/DAY/', 
                                                             Prefix = 'PRICESBOARD', Dataset = dataset, pSource = pSource, STKVN=F)))
      if ( nrow(COUNT_PRICESBOARD) > 0 )
      {
        LIST_COUNT_NB_DATE_PRICESBOARD [[dataset]] = COUNT_PRICESBOARD
      }
    }
    COUNT_NB_DATE_PRICESBOARD = rbindlist(LIST_COUNT_NB_DATE_PRICESBOARD, fill = TRUE)
    LIST_COUNT_SOURCE[[pSource]] = COUNT_NB_DATE_PRICESBOARD
    print("DONE")
  }
  
  
  DATA_COUNT_NB_DATE_ALL = rbindlist(LIST_COUNT_SOURCE, fill = TRUE)
  DATA_COUNT_NB_DATE_ALL = rbind(DATA_COUNT_NB_DATE_ALL, DATA_ALL_SNAPSHOT)
  DATA_COUNT_NB_DATE_ALL = unique(DATA_COUNT_NB_DATE_ALL[!is.na(dataset)], by = c("source", "dataset","market"))
  
  report_number_dated = setDT (spread(DATA_COUNT_NB_DATE_ALL[,. (source, market, output, dataset)], 
                                      key='source', value='output'))[order(dataset)]
  report_percent = setDT (spread(DATA_COUNT_NB_DATE_ALL[,. (source, market, percent, dataset)], 
                                 key='source', value='percent'))[order(dataset)]
  report_number_dated = UPDATE_UPDATED(report_number_dated) 
  report_percent = UPDATE_UPDATED(report_percent) 
  My.Kable.All(report_number_dated)
  My.Kable.All(report_percent)
  CCPR_SAVERDS(report_number_dated,paste0('S:/SHINY/STKVN/', SESSION,'/'), paste0('report_', tolower(SESSION),'_day_final.rds'))
  CCPR_SAVERDS(report_percent,paste0('S:/SHINY/STKVN/', SESSION,'/'),  paste0('report_', tolower(SESSION),'_day_percent.rds'))
  try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
  x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_REPORT_DAY_OPENCLOSE'), pAction="SAVE", NbSeconds=0, ToPrint = T))
}

# ==================================================================================================
COUNT_NUMBER_DATE = function(File_Folder='S:/STKVN/PRICES/DAY/', Prefix = 'PRICESBOARD', Dataset='MARKET', pSource = 'VND', STKVN=F)  {
  # ------------------------------------------------------------------------------------------------
  Final_Data   = data.table()
  DBL_RELOAD_INSREF()
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  File_Name_Day    = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_DAY.rds')
  CATln_Border(paste('DAY  = ', File_Name_Day))
  Data_Day         = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Day, ToKable = T, ToRestore = T)))
  
  File_Name_Date   = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_', gsub('-','', LastTrading), '.rds')
  CATln_Border(paste('DATE = ', File_Name_Date))
  Data_Date        = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Date, ToKable = T, ToRestore = T)))
  
  Data_All = rbind(Data_Day, Data_Date, fill=T)
  
  if (nrow(Data_All)>0) 
  {
    Data_All = Data_All[date==LastTrading]
    Data_All[market == 'UPCOM', market := 'UPC']
    Data_All[market == 'HOSE', market := 'HSX']
    Data_All = unique(Data_All, by=c('code', 'date'))
    Data_All = merge(Data_All[, -c('name')], ins_ref[, .(code, name=short_name)], all.x=T, by='code')
    # My.Kable.TB(Data_All)
    Stats = Data_All[, .(source=pSource, n=.N, maxdate=max(date, na.rm=T)), by=c('market')]
    Stats[, delay:=as.numeric(LastTrading-maxdate)]
    Stats[, output:= paste(' ', sprintf("%4s", as.character(delay)), '/', sprintf("%6s", as.character(n)))]
    # My.Kable.All(Stats)
    Final_Data = Stats[, .(Prefix, source, market, output)]
    My.Kable.All(Final_Data)
    
    if (nchar(Dataset)>0)
    {
      switch (Dataset,
              'MARKET' = { 
                if ('market' %in% names(Data_All))
                {
                  Select_Data  = Data_All[!is.na(market)]
                  Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
                  Final_Data[, dataset:='MARKET']
                  Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                }
              },
              'REFERENCE' = { 
                if ('reference' %in% names(Data_All))
                {
                  Select_Data  = Data_All[!is.na(reference)]
                  Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
                  Final_Data[, dataset:='REFERENCE']
                  Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                }
              },
              'LAST' = {
                if ('last' %in% names(Data_All))
                {
                  Select_Data  = Data_All[!is.na(last)]
                  Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
                  Final_Data[, dataset:='LAST']
                  Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                }
              },
              'VOLUME' = {
                if ('volume' %in% names(Data_All))
                {
                  Select_Data  = Data_All[!is.na(volume)]
                  Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
                  Final_Data[, dataset:='VOLUME']
                  Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                }
              },
              'CLOSE' = {
                if ('close' %in% names(Data_All))
                {
                  Select_Data  = Data_All[!is.na(close)]
                  Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
                  Final_Data[, dataset:='CLOSE']
                  Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                }
              },
              'SHARESOUT' = { 
                if ('sharesout' %in% names(Data_All))
                {
                  Select_Data  = Data_All[!is.na(sharesout)]
                  Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
                  Final_Data[, dataset:='SHARESOUT']
                  Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                } else{
                  Final_Data[, dataset:='SHARESOUT']
                  Final_Data[, nd:=as.numeric(NA)]
                  Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
                  My.Kable.All(Final_Data)
                }
              }
      )
    }
  }
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_SAVERDS_WITH_FST = function(pData        = My_Data, FileFolder, FileName , 
                                    SaveOneDrive = T, ToKable=F, ToSummary=F, ToPrompt=T, 
                                    ToFST        = F, FSTFolder    = '') {
  # ------------------------------------------------------------------------------------------------
  # LastUpdated = 2024-05-14 17:04
  # ................................................................................................
  # ODDrive = 'D:/OneDrive/'
  # CATln('CCPR_SAVERDS in CCPR')
  DBL_RELOAD_INSREF()
  # pData      = CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'download_upc_stkvn_snapshot_20240514.rds')
  # FileFolder = 'S:/STKVN/PRICES/DAY/'
  # FileName   = 'download_upc_stkvn_snapshot_20240514.rds'
  # SaveOneDrive = T
  # ToKable    = F 
  # ToSummary  = F
  # ToPrompt   = T
  # ToFST      = T
  # FSTFolder  = ''
  if (ToKable) { My.Kable.Min(pData) }
  ODDrive_Data = paste0(ODDrive, substr(FileFolder,1,1), word(FileFolder,2,2,":"))
  
  if (!file.exists(ODDrive_Data))
  {
    try(dir.create(ODDrive_Data, recursive=T))
  }
  FullPath_Local   = paste0(FileFolder, FileName)
  FullPath_ODDrive = paste0(ODDrive_Data, FileName)
  if (ToPrompt) { CATln_Border(paste('SAVE LOCAL = ', FullPath_Local, '-', substr(Sys.time(),1,19))) }
  if (ToPrompt) { CATrp('Saving ...') }
  saveRDS(pData, tolower(FullPath_Local))
  # x = readRDS(tolower(FullPath_Local)); My.Kable.Min(x)
  if (ToSummary) { try(CCPR_WRITE_SUMMARY_CURRENT(pData=pData, pFileName=FullPath_Local, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
  if (ToPrompt) { CATln('Done.') }
  
  if (SaveOneDrive)
  {
    if (ToPrompt) { CATln_Border(paste('SAVE ONEDRIVE = ', FullPath_ODDrive, '-', substr(Sys.time(),1,19))) }
    if (ToPrompt) { CATrp('Saving ...') }
    saveRDS(pData, FullPath_ODDrive)
    if (ToSummary) { try(CCPR_WRITE_SUMMARY_CURRENT(pData=pData, pFileName=FullPath_ODDrive, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
    if (ToPrompt) { CATln('Done.') }
  }
  
  if (ToFST) {
    if (ToPrompt) { CATrp('FST ...') }
    if (nchar(FSTFolder)==0)
    {
      FilePath = gsub(".rds", ".fst", paste0(FileFolder, FileName), ignore.case = T) 
      CATln_Border(FilePath)
      fst_file = fst::write_fst(pData, FilePath )
    }
    else
    {
      FilePath = gsub(".rds", ".fst", paste0(FSTFolder, FileName), ignore.case = T) 
      CATln_Border(FilePath)
      fst_file = fst::write_fst(data, FilePath )
    }
  }
}

# ==================================================================================================
TRAINEE_REPORT_CLOSE_FINAL = function (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                       LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL'),
                                       LIST_DATASET = list('reference', 'market', 'sharesout', 'close', 'volume') ){
  # ------------------------------------------------------------------------------------------------
  
  # File_Folder = 'S:/STKVN/PRICES/DAY/'
  # LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL')
  # LIST_DATASET = list('reference', 'market', 'sharesout')
  
  LastTrading = CCPR_LAST_TRADING_DAY_VN( hour(Sys.time()), ToPrompt = T)
  DBL_RELOAD_INSREF()
  DATA_ALL_DAY = data.table()
  DATA_ALL_SHARES_DAY = data.table()
  xList_day = list()
  xList_shares = list()
  
  ####### FILES PRICESBOARD ####
  
  for (k in 1:length(LIST_SOURCES))
  {
    # k = 6
    pSource     = LIST_SOURCES[[k]]
    File_day_Name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    CATln_Border(File_day_Name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_day_Name, ToKable = T)))
    My.Kable(File_Data_Day)
    
    if ( nrow (File_Data_Day) > 0) 
    {
      File_Data_Day[, K := k]
      File_Data_Day[, updated := as.character(updated)]
      xList_day[[k]] = File_Data_Day
    }
  }
  
  DATA_ALL_DAY = rbindlist(xList_day, fill = T)
  
  #clean
  DATA_ALL_DAY[market == 'UPCOM', market := 'UPC']
  DATA_ALL_DAY[market == 'HOSE', market := 'HSX']
  DATA_ALL_DAY[, ticker:= gsub('[*]', '', ticker)]
  DATA_ALL_DAY[, code := paste0('STKVN', ticker)]
  DATA_ALL_DAY[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
  DATA_ALL_DAY[!is.na(reference) & volume == 0, last := reference]
  DATA_ALL_DAY[volume == 0, close := last]
  DATA_ALL_DAY[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
  DATA_ALL_DAY = merge(DATA_ALL_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
  DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
  
  
  ####### FILES SHARES ####
  
  x = gsub('-', '', LastTrading)
  
  files = list.files(File_Folder)
  matching_files <- files[grep(paste0('_stkvn_snapshot_', x), files)]
  
  for (file_name in matching_files) {
    new_file_name = gsub(paste0("stkvn_snapshot_", x), "stkvn_shares_day", file_name)
    old_file_path = file.path(File_Folder, file_name)
    new_file_path = file.path(File_Folder, new_file_name)
    file.copy(old_file_path, new_file_path, overwrite = T)
    cat("Created copy:", new_file_name, "\n")
  }
  x_list = list()
  
  for (k in 1:length(LIST_SOURCES)) 
  {
    # k = 8
    pSource = LIST_SOURCES[[k]]
    Name_file = paste0("DOWNLOAD_", pSource, "_STKVN_SHARES")
    File_day = paste0(Name_file, "_DAY.rds")
    File_history = paste0(Name_file, "_HISTORY.rds")
    DAY = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_day)))
    HISTORY = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_history)))
    DATA = rbind(DAY, HISTORY, fill = T)
    if (nrow(DAY) > 0 ) 
    {
      x_list[[k]] = DATA
    }
    
  }
  
  DATA_ALL_SHARES_DAY = rbindlist(x_list, fill = T)
  LIST_MARKET = CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'final_stkvn_market_day.rds')
  DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('market')], LIST_MARKET[,. (code, market = value)], all.x = T, by = 'code')
  unique(DATA_ALL_SHARES_DAY$source)
  DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[nchar(code) == 8]
  DATA_ALL_SHARES_DAY = unique(DATA_ALL_SHARES_DAY[date == LastTrading], by = c("source", "code"))
  
  DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
  DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[!is.na(sharesout)]
  
  DATA_SHARES_EXC = DATA_ALL_SHARES_DAY[source %in% c("UPC", "HNX", "HSX")]
  
  DATA_ALL = merge (DATA_ALL_DAY, DATA_SHARES_EXC[,. (code, sharesout, shareslis, date)], by = c("code", "date"), all.x = T)      # UPC, HNX, HSXHSX
  #DATA_ALL = merge (DATA_ALL_DAY, DATA_ALL_SHARES_DAY[,. (code, sharesout, shareslis, date)], by = c("code", "date"), all.x = T)   ALL SOURSOURCE
  unique(DATA_ALL$source)
  
  
  ############ FINAL OPEN OK AND NOT OKE #############
  
  list_ok = list()
  list_nok = list()
  
  DATA_ALL_DAY = unique(DATA_ALL[order(source, code, -updated)], by = c('source', 'code'))
  
  x = list()
  for (k in 1:length(LIST_DATASET)) 
  {
    
    fields  = union(c('code', 'date'), LIST_DATASET[[k]]) 
    fields_source  = union(c('code', 'date', 'source'), LIST_DATASET[[k]]) 
    DATA_ALL_DATASET = DATA_ALL_DAY[, ..fields]
    DATA_ALL_DATASET_SOURCE = DATA_ALL_DAY[, ..fields_source]
    
    names(DATA_ALL_DATASET) = c('code', 'date', 'value')
    names(DATA_ALL_DATASET_SOURCE) = c('code', 'date', 'source', LIST_DATASET[[k]])
    My.Kable(DATA_ALL_DATASET)
    My.Kable(DATA_ALL_DATASET_SOURCE)
    
    data_final = unique(DATA_ALL_DATASET_SOURCE[, .(n=.N), b=c('code', LIST_DATASET[[k]])][order(-n)], by='code')
    data_final = data_final[nchar(code)==8]
    data_final_ok = data_final[n>1]
    data_final_nok = data_final[n==1]
    data_final_ok = select(data_final_ok, -c("n"))
    data_final_nok = select(data_final_nok, -c("n"))
    
    My.Kable(data_final_nok)
    My.Kable(data_final_ok)
    
    list_ok[[k]] = data_final_ok
    list_nok[[k]] = data_final_nok
    
  }
  DATA_OK = data.table()
  DATA_NOK = data.table()
  
  for (k in 1:length(LIST_DATASET)) {
    # k = 1
    
    if(k == 1){
      
      DATA_OK = list_ok[[k]]
      DATA_NOK = list_nok[[k]]
    }else{
      DATA_OK = merge(DATA_OK,list_ok[[k]], by = "code", all.x = T)
      DATA_NOK = merge(DATA_NOK,list_nok[[k]], by = "code", all.x = T)
    }
    
  }
  
  DATA_FINAL_OK = merge(DATA_OK, unique(DATA_ALL[order(-updated)][,. (code, ticker , name)], by = "code"), by = "code", all.x = T)
  My.Kable(DATA_FINAL_OK)
  
  CCPR_SAVERDS(DATA_FINAL_OK,'S:/SHINY/STKVN/CLOSE/', 'data_final_ok_close.rds')
  DATA_FINAL_NOK = merge(DATA_NOK, unique(DATA_ALL_DAY[order(-updated)][,. (code, ticker , name)], by = "code"), by = "code", all.x = T)
  CCPR_SAVERDS(DATA_FINAL_NOK,'S:/SHINY/STKVN/CLOSE/', 'data_final_nok_close.rds')
  
  #list_dataset = list('reference', 'market')
  x = list()
  for (dataset in LIST_DATASET) 
    
  {
    # dataset = 'reference'
    # dataset = 'market'
    # dataset = 'sharesout'
    
    if(dataset != 'market'){
      fields_source  = union(c('code', 'date', 'market', 'source'), dataset) 
    }else{
      fields_source  = union(c('code', 'date', 'source'), dataset) 
    }
    
    
    DATA_ALL_DATASET_SOURCE = DATA_ALL[, ..fields_source]
    
    num_columns = ncol(DATA_ALL_DATASET_SOURCE)
    DATA_ALL_DATASET_SOURCE$market = paste0(dataset, "_", DATA_ALL_DATASET_SOURCE$market)
    if (dataset == 'sharesout') {  DATA_ALL_DATASET_SOURCE = DATA_ALL_DATASET_SOURCE[!is.na(sharesout)] }
    
    DATA_ALL_DATASET_SOURCE = DATA_ALL_DATASET_SOURCE[,. (date, source, market)]
    DATA_ALL_DATASET_SOURCE[, updated := substr(Sys.time(), 1,19)]
    
    names(DATA_ALL_DATASET_SOURCE) = c("date", "source", "value", "updated")
    
    x[[dataset]] = DATA_ALL_DATASET_SOURCE
    
  }
  
  DATA = rbindlist(x, fill = T)
  DATA[, LastTrading := LastTrading]
  
  
  DATA_ALL_DATE = unique(DATA[order(source, value, -date)], by = c('source', 'value'))
  DATA_ALL_DATE [, n := as.character(date - LastTrading)]
  DATA_ALL_DATE [n == 0, n := substr(updated, 12, 16)]
  
  report_close_date = setDT(spread(DATA_ALL_DATE[, .(n), by = .(source, value, date)], key = 'source', value = 'n'))[, ':='( updated = substr(Sys.time(),1,19) )]
  
  report_close = setDT(spread(DATA[,.(n=.N), by=c('date','source', 'value')], key='source', value='n'))[, updated := substr(Sys.time(), 1, 19)]
  report_close = unique(report_close[order(-date)], by = "value")
  My.Kable.All(report_close)
  My.Kable.All(report_close_date)
  
  CCPR_SAVERDS(report_close,'S:/SHINY/STKVN/CLOSE/', 'report_close_day_number.rds')
  CCPR_SAVERDS(report_close_date,'S:/SHINY/STKVN/CLOSE/', 'report_close_day_date.rds')
  try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
}


# # ==================================================================================================
# COUNT_NUMBER_DATE = function(File_Folder='S:/STKVN/PRICES/DAY/', Prefix = 'PRICESBOARD', Dataset='MARKET', pSource = 'VND', STKVN=F)  {
#   # ------------------------------------------------------------------------------------------------
#   Final_Data   = data.table()
#   DBL_RELOAD_INSREF()
#   LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
#   File_Name_Day    = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_DAY.rds')
#   CATln_Border(paste('DAY  = ', File_Name_Day))
#   Data_Day         = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Day, ToKable = T, ToRestore = T)))
#   
#   File_Name_Date   = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_', gsub('-','', LastTrading), '.rds')
#   CATln_Border(paste('DATE = ', File_Name_Date))
#   Data_Date        = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Date, ToKable = T, ToRestore = T)))
#   
#   Data_All = rbind(Data_Day, Data_Date, fill=T)
#   
#   if (nrow(Data_All)>0) 
#   {
#     Data_All = Data_All[date==LastTrading]
#     Data_All[market == 'UPCOM', market := 'UPC']
#     Data_All[market == 'HOSE', market := 'HSX']
#     Data_All = unique(Data_All, by=c('code', 'date'))
#     Data_All = merge(Data_All[, -c('name')], ins_ref[, .(code, name=short_name)], all.x=T, by='code')
#     # My.Kable.TB(Data_All)
#     Stats = Data_All[, .(source=pSource, n=.N, maxdate=max(date, na.rm=T)), by=c('market')]
#     Stats[, delay:=as.numeric(LastTrading-maxdate)]
#     Stats[, output:= paste(' ', sprintf("%4s", as.character(delay)), '/', sprintf("%6s", as.character(n)))]
#     # My.Kable.All(Stats)
#     Final_Data = Stats[, .(Prefix, source, market, output)]
#     My.Kable.All(Final_Data)
#     
#     if (nchar(Dataset)>0)
#     {
#       switch (Dataset,
#               'REFERENCE' = { 
#                 if ('reference' %in% names(Data_All))
#                 {
#                   Select_Data  = Data_All[!is.na(reference)]
#                   Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
#                   Final_Data[, dataset:='REFERENCE']
#                   Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
#                   Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
#                   My.Kable.All(Final_Data)
#                 }
#               },
#               'LAST' = {
#                 if ('last' %in% names(Data_All))
#                 {
#                   Select_Data  = Data_All[!is.na(last)]
#                   Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
#                   Final_Data[, dataset:='LAST']
#                   Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
#                   Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
#                   My.Kable.All(Final_Data)
#                 }
#               },
#               'VOLUME' = {
#                 if ('volume' %in% names(Data_All))
#                 {
#                   Select_Data  = Data_All[!is.na(volume)]
#                   Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
#                   Final_Data[, dataset:='VOLUME']
#                   Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
#                   Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
#                   My.Kable.All(Final_Data)
#                 }
#               },
#               'CLOSE' = {
#                 if ('close' %in% names(Data_All))
#                 {
#                   Select_Data  = Data_All[!is.na(close)]
#                   Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
#                   Final_Data[, dataset:='CLOSE']
#                   Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
#                   Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
#                   My.Kable.All(Final_Data)
#                 }
#               },
#               'SHARESOUT' = { 
#                 if ('sharesout' %in% names(Data_All))
#                 {
#                   Select_Data  = Data_All[!is.na(sharesout)]
#                   Select_Stats = Select_Data[, .(nd=.N), by=c('market')]
#                   Final_Data[, dataset:='SHARESOUT']
#                   Final_Data = merge(Final_Data[,-c('nd')], Select_Stats, all.x=T, by='market')
#                   Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
#                   My.Kable.All(Final_Data)
#                 } else{
#                   Final_Data[, dataset:='SHARESOUT']
#                   Final_Data[, nd:=as.numeric(NA)]
#                   Final_Data[, percent:=100*nd/as.numeric(word(output,2,2,'/'))]
#                   My.Kable.All(Final_Data)
#                 }
#               }
#       )
#     }
#   }
#   return(Final_Data)
# }

# ==================================================================================================
REPORT_LAST_UPDATE <- function(file_name = paste0("S:/SHINY/STKVN/LAST_UPDATE/files_last_update.rds")) {
  # ------------------------------------------------------------------------------------------------
  data_excel <- setDT(read_excel("S:/SHINY/REPORTS/SHINY_REPORT_MANAGEMENT.xlsx"))
  output_list <- list()
  
  list_pSection <- unique(data_excel$page)  
  
  for (pSection in list_pSection) {
    # pSection = list_pSection[1]
    
    list_pTab <- unique(data_excel[page == pSection]$Tab_label)
    
    temp_df <- NULL
    
    for (pTab in list_pTab) {
      # pTab = list_pTab[1]
      
      output <- CHECK_CLASS(try(EXTRACT_LAST_UPDATE(pSection = pSection, pTab = pTab, ToPrompt = FALSE)))
      output[, sys_time := substr (as.character (Sys.time()),1,19)]
      # output[, sys_time := format(Sys.time(), "%Y-%m-%d %H:%M:%S")]
      output[, delay := as.numeric(difftime(sys_time, output$last_updated, units='mins'))]
      
      if (!is.null(output)) {
        
        temp_df <- rbind(temp_df, output, fill = TRUE)
      }
    }
    
    output_list[[pSection]] <- temp_df
  }
  
  final_output <- rbindlist(output_list, fill = TRUE)
  My.Kable.All(final_output[,. (page, Tab_label, FILE_NAME, FILE_TYPE, id, last_date, last_updated, sys_time, delay)])
  
  saveRDS(final_output, file_name)
  
  x <- try(readRDS(file_name), silent = TRUE) 
  fst_file <- fst::write_fst(x, gsub(".rds", ".fst", file_name, ignore.case = T))
  
  return(final_output)
}
# x = REPORT_LAST_UPDATE(file_name = paste0("S:/SHINY/STKVN/LAST_UPDATE/files_last_update.rds"))


# ==================================================================================================
COPY_PRICESBOARD_SNAPSHOT_YYYYMMDD_TO_DAY = function(Prefix='PRICESBOARD', pSource='VND', STKVN=F, ToForce = F) {
  # ------------------------------------------------------------------------------------------------
  # LatUpdated = 2024-05-17 15:47
  # ................................................................................................
  LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  File_Fr     = paste0('DOWNLOAD_', pSource, ifelse(STKVN, '_STKVN', ''), '_', Prefix, '_', gsub('-','',LastTrading),'.rds')
  File_To     = paste0('DOWNLOAD_', pSource, ifelse(STKVN, '_STKVN', ''), '_', Prefix, '_', 'day', '.rds')
  CATln_Border(File_Fr)
  CATln_Border(File_To)
  
  if (file.exists(paste0('S:/STKVN/PRICES/DAY/', File_Fr)))
  {
    if (ToForce || (!file.exists(paste0('S:/STKVN/PRICES/DAY/', File_To))))
    {
      x = try(file.copy(paste0('S:/STKVN/PRICES/DAY/', File_Fr), paste0('S:/STKVN/PRICES/DAY/', File_To), overwrite=T))
      print(x)
      CATln('Copied')
    }
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VST_STKVN_SHARES_BY_CODE = function(pCode = 'VND') {
  # ------------------------------------------------------------------------------------------------
  # pCode = 'YRC'
  # x = FINAL_DOWNLOAD_VST_STKVN_SHARES_BY_CODE(pCode = 'VND')
  # x = FINAL_DOWNLOAD_VST_STKVN_SHARES_BY_CODE(pCode = 'PSI')
  Final_Data = data.table()
  pURL = paste0('https://finance.vietstock.vn/', toupper(pCode), '/profile.htm?languageid=2')
  
  # pURL = paste0('https://finance.vietstock.vn/', toupper(pCode), '/ho-so-doanh-nghiep.htm')
  CATln_Border(pURL)
  content    = try(rvest::read_html(pURL))
  
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    if (length(tables)>0)
    {
      xData      = TRAINEE_SELECT_TABLE_WITH_FIELD(tables, pField='x1', pContent="Shares outstanding", like=F)
      if (all(class(xData)!='try-error') & any(grepl('Shares outstanding',xData$x1)))
      {
        xData$field   = decodeVN(xData$x1, from='Unicode', to='Unicode', diacritics=F)
        SharesOut  = as.numeric(gsub(',','', xData[field=='Shares outstanding']$x2))
        SharesLis  = as.numeric(gsub(',','', xData[field=='Listed shares']$x2))
        SharesFirst  = as.numeric(gsub(',','', xData[field=='First listed volume']$x2))
        DateFirst    = as.Date(xData[field=='First trading date']$x2,'%m/%d/%Y')
        
        Final_Data = data.table(source='VST', codesource=pCode, ticker=pCode, date=SYSDATETIME(9), code=paste0('STKVN', pCode), 
                                sharesout=SharesOut, shareslis=SharesLis, shares1st=SharesFirst, date1st=DateFirst, updated=substr(as.character(Sys.time()),1,19)) 
        My.Kable.All(Final_Data)
      }
    }
  } else {
    Final_Data = data.table(source='VST', codesource=pCode, ticker=pCode, date=SYSDATETIME(9), code=paste0('STKVN', pCode))
  }
  
  
  return(Final_Data)
}
#===================================================================================================
TRAINEE_DOWNLOAD_STB_STKVN_SHARES_BY_CODE = function(pCode = 'A32') {
  # ------------------------------------------------------------------------------------------------
  Final_Data = data.table()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  pURL  = paste0('https://stockbiz.vn/ma-chung-khoan/', pCode)
  CATln_Border(pURL)
  
  
  response <- GET(pURL, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  
  # http_type(response)
  # status_code(response)
  xweb = content(response, as="text")
  # x = jsonlite::fromJSON(dataJson)
  # xView = as.data.table(x$data$tradesTable$rows)
  # View(xView)
  
  
  
  File_Temp  = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '', Sys.time())), '.txt')
  # xweb = IFRC_CCPR_WEB_SAVE_AS(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
  
  content    = try(rvest::read_html(xweb))
  tables     = content %>% html_table(fill = TRUE)
  
  xData    = TRAINEE_SELECT_TABLE_WITH_FIELD(tables=tables, pField='x1', pContent="Số lượng CPLH", like=T)
  My.Kable.All(xData)
  if (nrow(xData)>0)
  {
    shares_outstanding = TRAINEE_GET_VALUE_IN_TABLE_x1x2(pTable=xData, pDataset='Số lượng CPLH')
    shares_outstanding = TRAINEE_CONVERT_IN_VALUE_KMBT(shares_outstanding)
    print(shares_outstanding)
  } else {
    shares_outstanding = as.numeric(NA)
  }
  
  xData    = TRAINEE_SELECT_TABLE_WITH_FIELD(tables=tables, pField='thongtincoban', pContent="Mã ngành ICB", like=T)
  names(xData) = c('x1', 'x2')
  My.Kable.All(xData)
  if (nrow(xData)>0)
  {
    icb_level4    = as.character(TRAINEE_GET_VALUE_IN_TABLE_x1x2(pTable=xData, pDataset='Mã ngành ICB'))
    print(icb_level4)
    date_creation = TRAINEE_GET_VALUE_IN_TABLE_x1x2(pTable=xData, pDataset='Năm thành lập')
    date_creation = as.Date(date_creation, '%d/%m/%Y')
    print(date_creation)
  } else {
    icb_level4 = as.character(NA)
    date_creation = as.Date(NA)
  }
  Final_Data = data.table(source='STB', codesource=pCode, code=paste0('STKVN', pCode), date=LastTrading, dataset='SHARES OUTSTANDING',
                          sharesout=shares_outstanding, date_creation=date_creation, icb4=icb_level4, close=shares_outstanding,
                          updated=as.character(Sys.Date()))
  Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption = 'FINAL')
  My.Kable.All(Final_Data)
  return(Final_Data)
}

# ==================================================================================================
DELETE_C_TEMP = function(StartWith='TEMP_') {
  # ------------------------------------------------------------------------------------------------
  # LastUpdate = 2024-05-17 12:31
  # ................................................................................................
  try(GC_SILENT())
  DATACENTER_LINE_BORDER_BEGINEND(paste('DELETE_C_TEMP :',StartWith), 'BEGIN')
  
  # StartWith='BANG_GIA_'
  List_Files = as.data.table(list.files('C:/temp/', '*.txt$', ignore.case = T))
  List_Files = List_Files[grepl(paste0('^', StartWith), V1, ignore.case=T)]
  My.Kable.TB(List_Files)
  
  if (nrow(List_Files)>0)
  {
    for (k in 1:nrow(List_Files))
    {
      # k = 1
      FullPath = paste0('C:/temp/', List_Files[k]$V1)
      if (file.exists(FullPath))
      {
        CATln('')
        CATln_Border(FullPath)
        x = file.remove(FullPath)
        print(x)
      }
    }
  }
  DATACENTER_LINE_BORDER_BEGINEND(paste('DELETE_C_TEMP :',StartWith), 'END')
}

# ==============================================================================
SUMMARY_DATE = function(pFileName, ToBrowse=T, DateOnly=T)  {
  # ----------------------------------------------------------------------------
  # pFileName = paste0(UData, "download_EXC_stk_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_ref.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_history.rds")
  # pFileName = paste0(UData, "download_HSX_stkvn_intraday_day.rds")
  
  File_Summary = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
  datemax      = as.Date("1900-01-01")
  xDate        = datemax
  
  if (file.exists(File_Summary))
  {
    x = try(setDT(fread(File_Summary, sep='\t', fill=T)))
    if (all(class(x)!='try-error') && nrow(x)>0)
    {
      # str(x)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="numeric", List_Fields=list("last", "nbdays", "nb", 'sample', 'home'), ToConvertSeparator=F)
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="character", List_Fields=list("type", "code", "source", "codesource"), ToConvertSeparator=F)
      if ("type" %in% names(x)) { x[, type:=as.character(type)]}
      
      x = CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR(pData=x, AsType="date", List_Fields=list("start", "end", "date", "datelast"), ToConvertSeparator=F)
      if (DateOnly){ x[nchar(as.character(date))>10, date:=as.character(substr(date,1,10))]}
      x = x[nchar(as.character(date))==10][, date:=as.Date(date)]
      xDate = max(x[!is.na(date)]$date)
    }
    
    # str(x)
  }
  # x = SUMMARY_DATE(gsub(".rds", "_summary.txt", pFileName, ignore.case=T))
  if (ToBrowse)
  {
    CATln(paste(FormatSS(pFileName, 85), FormatSS(xDate, 12)))
    catrep('-',100)
  }
  return(xDate)
}

# ==============================================================================
CONVERT_IFEXIST_FIELDS_WITH_SEPARATOR = function(pData=ins_last, AsType="numeric", List_Fields=list("cf_last", "cf_netchange"), ToConvertSeparator=F, EchoOn=F)
{
  # ----------------------------------------------------------------------------
  if (nrow(pData)>0)
  {
    for (k in 1:length(List_Fields))
    {
      # k = 1
      # CATln(k)
      pField = List_Fields[[k]]
      
      if (pField %in% names(pData))
      {
        switch(AsType,
               "numeric"      = { 
                 if (ToConvertSeparator)
                 {
                   cParseText = paste0(pField, ":=", 'gsub(",","",',pField, ')')
                   if (EchoOn) { print(cParseText, quote=F) }
                   pData[, eval(parse(text = cParseText))]
                 }
                 pParseText = paste0(pField,":=as.numeric(", pField, ")") 
                 
               },
               "date"         = { pParseText = paste0(pField,":=as.Date(as.character(", pField, "))") },
               "character"    = { pParseText = paste0(pField,":=as.character(", pField, ")") }
        )
        if (pField %in% names(pData)) { pData[, eval(parse(text = pParseText))] }
        if (AsType == 'character' & pField %in% names(pData))
        {
          pParseTextNA = paste0(pField,":=ifelse(nchar(", pField, ")>0,", pField,",as.character(NA))")
          pData[, eval(parse(text = pParseTextNA))]
        }
        
      }
    }
  }
  # str(pData)
  return(pData)
}

# ==============================================================================
FormatSS = function(l.Num, l.Wid, l.Sep = "|") 
{
  # -----------------------------------------------------------------------------
  l.res = paste(format(l.Num, width = l.Wid), l.Sep)
  return(l.res)
}


# ==================================================================================================

TRAINEE_REPORT_SHARES = function (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                  LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL')){
  # ------------------------------------------------------------------------------------------------
  
  LastTrading = CCPR_LAST_TRADING_DAY_VN( hour(Sys.time()), ToPrompt = T)
  DBL_RELOAD_INSREF()
  
  x = gsub('-', '', LastTrading)
  
  files = list.files(File_Folder)
  matching_files <- files[grep(paste0('_stkvn_snapshot_', x), files)]
  
  for (file_name in matching_files) {
    new_file_name = gsub(paste0("stkvn_snapshot_", x), "stkvn_shares_day", file_name)
    old_file_path = file.path(File_Folder, file_name)
    new_file_path = file.path(File_Folder, new_file_name)
    file.copy(old_file_path, new_file_path, overwrite = T)
    cat("Created copy:", new_file_name, "\n")
  }
  x_list = list()
  
  for (k in 1:length(LIST_SOURCES)) 
  {
    # k = 8
    pSource = LIST_SOURCES[[k]]
    Name_file = paste0("DOWNLOAD_", pSource, "_STKVN_SHARES")
    File_day = paste0(Name_file, "_DAY.rds")
    File_history = paste0(Name_file, "_HISTORY.rds")
    DAY = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_day)))
    HISTORY = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_history)))
    DATA = rbind(DAY, HISTORY, fill = T)
    if (nrow(DAY) > 0 ) 
    {
      x_list[[k]] = DATA
    }
    
  }
  DATA_ALL_SHARES_DAY = rbindlist(x_list, fill = T)
  LIST_MARKET = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'final_stkvn_market_day.rds')))
  DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('market')], LIST_MARKET[,. (code, market = value)], all.x = T, by = 'code')
  unique(DATA_ALL_SHARES_DAY$source)
  DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[nchar(code) == 8]
  DATA_ALL_SHARES_DAY = unique(DATA_ALL_SHARES_DAY[date == LastTrading], by = c("source", "code"))
  
  DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
  DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[!is.na(sharesout)]
  
  
  DATA_ALL_DAY_REPORT = unique(DATA_ALL_SHARES_DAY[order(-date)][, .(source , market, date)], by = c("source", "market"))[, LastTrading := LastTrading]
  DATA_ALL_DAY_REPORT = DATA_ALL_DAY_REPORT [, nd := as.numeric(date - LastTrading)]
  DATA_ALL_DAY_REPORT = unique(DATA_ALL_DAY_REPORT, by = c("source", "market"))
  
  report_shares_date  = setDT(spread(DATA_ALL_DAY_REPORT[,.(n = as.numeric(date - LastTrading)), by=c('source', 'market')], key='source', value='n'))[order(market)][, ':='( updated = substr(Sys.time(),1,19) ,data = 'SHARES')]
  CCPR_SAVERDS(report_shares_date,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_shares_date.rds')
  
  My.Kable(report_shares_date)
  
  DATA_ALL_SHARES_NUMBER = unique(DATA_ALL_SHARES_DAY[order(date == LastTrading), by = c("source", "code")])
  report_shares_number = setDT(spread(DATA_ALL_SHARES_NUMBER[,.(n = .N), by=c('source', 'market')], key='source', value='n'))[order(market)][, ':='( updated = substr(Sys.time(),1,19) ,data = 'SHARES')]
  CCPR_SAVERDS(report_shares_number,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_shares_number.rds')
  My.Kable.All(report_shares_number)
  try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
}

# ==================================================================================================
CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY = function()  {
  # ------------------------------------------------------------------------------------------------
  if (file.exists(UData) & file.exists(CCPRData))
  {
    IND_CURCRY = CCPR_READRDS(UData, 'DOWNLOAD_IFRC_INDCURCRY_HISTORY.rds', ToKable = T, ToRestore = T)
    IND_CURCRY[, name:=gsub('EQUAL WEIGHTED$', 'EW', name)]
    IND_CURCRY[, name:=gsub('CAPITALISATION WEIGHTED$', 'CW', name)]
    IND_CURCRY[grepl('EW$', code), wgtg:='EW']
    IND_CURCRY[grepl('CW$', code), wgtg:='CW']
    IND_CURCRY[, cur:='USD']
    IND_CURCRY[, prtr:='PR']
    IND_CURCRY[, code:=paste0(codesource, prtr, cur)]
    IND_CURCRY = IND_CURCRY[, -c('codesource')]
    IND_CURCRY[, name:=paste(name, 'PR (USD)')]
    My.Kable(IND_CURCRY)
    My.Kable.Min(IND_CURCRY[order(date, code)])
    My.Kable.Min(unique(IND_CURCRY[order(-date, code)], by='code'))
    
    CCPR_SAVERDS(IND_CURCRY, paste0(CCPRData, 'DASHBOARD/'), 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', ToSummary = T, SaveOneDrive = T)
    CCPR_SAVERDS(IND_CURCRY, paste0(SCCPRData, 'DASHBOARD/'), 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', ToSummary = T, SaveOneDrive = T)
    CCPR_SAVERDS(IND_CURCRY, paste0(SCCPRData, 'DASHBOARD_LIVE/'), 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', ToSummary = T, SaveOneDrive = T)
  }
}

# ==================================================================================================
IFRC_CCPR_INVESTMENT_HISTORY = function(MaxDate=Sys.Date()) {
  # ------------------------------------------------------------------------------------------------
  
  # try(IFRC_CCPR_INVESTMENT_HISTORY())
  SCCPRData = 'S:/CCPR/DATA/'
  
  # Bonds ..........................................................................................
  y = download.file(paste0('https://fred.stlouisfed.org/graph/fredgraph.csv?bgcolor=%23e1e9f0&chart_type=line&drp=0&fo=open%20sans&graph_bgcolor=%23ffffff&height=450&mode=fred&recession_bars=on&txtcolor=%23444444&ts=12&tts=12&width=1318&nt=0&thu=0&trc=0&show_legend=yes&show_axis_titles=yes&show_tooltip=yes&id=DGS10&scale=left&cosd=1900-01-01&coed=',Sys.Date(),'&line_color=%234572a7&link_values=false&line_style=solid&mark_type=none&mw=3&lw=2&ost=-99999&oet=99999&mma=0&fml=a&fq=Daily&fam=avg&fgst=lin&fgsnd=2020-02-01&line_index=1&transformation=lin&vintage_date=',Sys.Date(),'&revision_date=',Sys.Date(),'&nd=1962-01-02'), 
                    'C:/temp/fed.csv')
  
  data = setDT(fread('C:/temp/fed.csv'))
  My.Kable(data)
  y = data[, .(code = 'BNDGUS10Y', name = 'U.S. 10Y BOND YIELD', date = as.Date(DATE), close = as.numeric(DGS10))]
  y[, close := na.locf(close)]
  My.Kable(y[is.na(close)])
  
  xc  = DBL_CCPR_READRDS(UData, 'DOWNLOAD_INV_BND_HISTORY.rds', ToKable = T, ToRestore = T)
  My.Kable(xc)
  
  BND = unique(xc[code=='BNDGUS10Y'][order(date)], by=c('code', 'date'))
  BND = unique(rbind(BND[!is.na(close)], y, fill = T), by = c('code', 'date'),  fromLast = T)
  BND[, rtd:=(close/100)/365]
  My.Kable(BND[, .(code, date, rtd, close)])
  BND[, value:=100]
  LastValue = 100
  
  cumulative_rtd = cumprod(1 + BND$rtd)
  BND$value      = c(LastValue, LastValue * cumulative_rtd[-nrow(BND)])
  
  BND = BND[, .(code, date, rtd, close=value, value)]
  BND = MERGE_DATASTD_BYCODE(BND, pOption = 'FINAL')
  My.Kable(BND[order(date)])
  
  # Crypto ..........................................................................................
  xc = DBL_CCPR_READRDS(UData, 'DOWNLOAD_CNM_CURCRY_HISTORY.rds', ToKable = T, ToRestore = T)
  x1 = xc[grepl('BTC', code)]
  BTC = x1[code=='CURCRYBTC']
  My.Kable.Min(BTC[order(date)])
  
  y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = 'BTC-USD', freq.data = 'daily', p_saveto="", NbTry=10) 
  y[, code := 'CURCRYBTC']
  z = unique(rbind(BTC, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
  My.Kable(z[order(date)][, .(code, date, close)])
  BTC = z
  
  xc = DBL_CCPR_READRDS(UData, 'DOWNLOAD_YAH_CMD_HISTORY.rds', ToKable = T, ToRestore = T)
  x1 = xc[grepl('GOLD', code)]
  GOLD = x1[code=='CMDGOLD'][, close := close_adj]
  My.Kable.Min(GOLD[order(date)])
  
  y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = 'GC=F', freq.data = 'daily', p_saveto="", NbTry=10) 
  z = unique(rbind(GOLD, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
  My.Kable(z[order(date)][, .(code, date, close)])
  GOLD = z
  
  x = DBL_CCPR_READRDS(UData, 'EFRC_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
  x1 = x[grepl('VNI', code)]
  VNIx1 = x1[code =='INDVNINDEX']
  
  y = DBL_CCPR_READRDS(UData, 'download_caf_indvn_prices_history.rds', ToKable = T, ToRestore = T)
  y1 = y[grepl('VNI', code)]
  VNIy1 = y1[code=='INDVNINDEX']
  z = unique(rbind(VNIx1, VNIy1, fill = T), by = c("code", "date"), fromLast = T)
  My.Kable(z[order(date)][, .(code, date, close)])
  VNI = z
  
  x1 = x[grepl('500', name)]
  SPX = x1[code=='INDSPX']
  My.Kable(SPX[, .(code, date, close)])
  y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^GSPC', freq.data = 'daily', p_saveto="", NbTry=10) 
  z = unique(rbind(SPX, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
  My.Kable(z[order(date)][, .(code, date, close)])
  SPX = z
  
  x1 = x[grepl('NASDAQ', name)]
  NDX = x1[code=='INDNDX']
  My.Kable(NDX[, .(code, date, close)])
  y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^NDX', freq.data = 'daily', p_saveto="", NbTry=10) 
  z = unique(rbind(NDX, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
  My.Kable(z[order(date)][, .(code, date, close)])
  NDX = z
  
  # N225 = x1[code=='INDN225']
  
  IPO = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = 'IPO', freq.data = 'daily', p_saveto="", NbTry=10) 
  # x1 = MERGE_DATASTD_BYCODE(IPO)[order(code, date)]
  # x2 = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', IPO)
  IPO = MERGE_DATASTD_BYCODE(IPO, pOption = 'FINAL')
  IPO[, ':=' (code = 'FNDINIPOIPO', name = 'RENAISSANCE IPO ETF', type = 'FND', fcat = 'FND', scat = 'EQUITY', isin = 'US7599372049')]
  
  # a = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^990100-USD-STRD', freq.data = 'daily', p_saveto="", NbTry=10) 
  # # x1 = MERGE_DATASTD_BYCODE(IPO)[order(code, date)]
  # # x2 = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', IPO)
  # MSCI = MERGE_DATASTD_BYCODE(MSCI, pOption = 'FINAL')
  # MSCI[, ':=' (code = 'INDMSCIWORLD', name = 'MSCI WORLD PR (USD)', type = 'FND', fcat = 'INDOTH', scat = 'EQUITY')]
  x = DBL_CCPR_READRDS(UData, 'EFRC_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
  # y = CCPR_READRDS(UData, 'DOWNLOAD_YAH_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
  MSCIz = DBL_CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', 'MSCI_WORLD.rds', ToKable = T, ToRestore = T)
  # MSCI_YAH = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^990100-USD-STRD', freq.data = 'daily', p_saveto="", NbTry=10) 
  MSCI = x[grepl('INDMSCIWORLD', code)][, code := gsub('USD','',code)]
  # MSCI[, codesource := '^990100-USD-STRD']  
  # MSCI = merge(unique(MSCI[, -c('date','close')], by = 'codesource'), MSCI_YAH[, .(codesource, date, close)], all.y = T, by = 'codesource')
  MSCI = unique(rbind(MSCI, MSCIz, fill = T), fromLast = T, by = c('code','date'))
  
  ASEAN40 = x[grepl('ASEAN40', code)]
  # y = CCPR_READRDS(UData, 'DOWNLOAD_RTS_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
  ASEAN40z = DBL_CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ASEAN_40.rds', ToKable = T, ToRestore = T)
  ASEAN40z[, code := 'INDFTSEASEAN40']
  ASEAN40 = unique(rbind(ASEAN40, ASEAN40z, fill = T), fromLast = T, by = c('code','date'))
  
  LOG_HISTORY = CHECK_CLASS(try(DBL_CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indlogals_history.rds', ToRestore = T)))
  LOG = LOG_HISTORY[code == 'INDVNXSECLOGCWPRVND']
  
  FIN_HISTORY = CHECK_CLASS(try(DBL_CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indfinals_history.rds', ToRestore = T)))
  FIN = FIN_HISTORY[code == 'INDVNXSECFINCWPRVND']
  
  HLC_HISTORY = CHECK_CLASS(try(DBL_CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indhlcals_history.rds', ToRestore = T)))
  HLC = HLC_HISTORY[code == 'INDVNXSECHLCCWPRVND']
  
  ENY_HISTORY = CHECK_CLASS(try(DBL_CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indenyals_history.rds', ToRestore = T)))
  ENY = ENY_HISTORY[code == 'INDVNXSECENYCWPRVND']
  
  xALL = rbind(VNI, NDX, SPX, BTC, GOLD, BND, LOG, FIN, HLC, ENY, IPO, MSCI, ASEAN40, fill=T)[, .(code, name, date, close)]
  
  # x = DBL_CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/','dbl_source_ins_day_history.rds')
  # 
  # common_cols = intersect(names(x), names(xALL))
  # 
  # xALL = rbind(xALL, x[code %in% xALL$code, ..common_cols])
  # 
  xALL = unique(xALL, by=c('code', 'date'))
  xALL = MERGE_DATASTD_BYCODE(xALL, pOption='FINAL')[order(code, date)]
  xALL = xALL[date<=MaxDate]
  
  xALL = xALL[order(code, date)]
  xALL[, rt := close/shift(close), by = 'code']
  
  xALL[, sub_name := name]
  
  xALL[code == 'INDVNXSECLOGCWPRVND', sub_name := 'BEQ LOGISTICS SECTOR']
  xALL[code == 'INDVNXSECFINCWPRVND', sub_name := 'BEQ FINANCE SECTOR']
  xALL[code == 'INDVNXSECENYCWPRVND', sub_name := 'BEQ ENERGY SECTOR']
  xALL[code == 'INDVNXSECHLCCWPRVND', sub_name := 'BEQ HEALTH CARE SECTOR']
  xALL[code == 'INDMSCIWORLD'       , sub_name := 'MSCI WORLD PR (USD)']
  xALL[code == 'INDFTSEASEAN40'     , sub_name := 'FTSE/ASEAN40']
  xALL[code == 'INDFTSEASEAN40'     , name := 'FTSE/ASEAN40']
  
  # xALL[, sub_name := name]
  # xALL[, name := NULL]
  My.Kable.Min(xALL)
  My.Kable.All(unique(xALL[order(code, -date)], by='code'))
  
  Data_Old = DBL_CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ifrc_ccpr_investment_history.rds', ToRestore = T)
  if (nrow(Data_Old) > 0){
    xALL = unique(rbind(Data_Old, xALL, fill = T), by = c('code', 'date'))[order(code,date)]
    dir.create(paste0(CCPRData, 'INDEX/'))
    dir.create(paste0(SCCPRData, 'INDEX/'))
    
    # try(DBL_CCPR_SAVERDS(xALL, paste0(CCPRData, 'INDEX/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
    # try(DBL_CCPR_SAVERDS(xALL, paste0(CCPRData, 'DASHBOARD/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
    try(DBL_CCPR_SAVERDS(xALL, paste0(SCCPRData, 'INDEX/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
    try(DBL_CCPR_SAVERDS(xALL, paste0(SCCPRData, 'DASHBOARD/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
    try(DBL_CCPR_SAVERDS(xALL, paste0('S:/SHINY/INDEX/DASHBOARD/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
    try(DBL_CCPR_SAVERDS(xALL, paste0('S:/CCPR/DATA/DASHBOARD_LIVE/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
  }
}

# # ==================================================================================================
# IFRC_CCPR_INVESTMENT_HISTORY = function(MaxDate=Sys.Date()) {
#   # ------------------------------------------------------------------------------------------------
#   
#   # try(IFRC_CCPR_INVESTMENT_HISTORY())
#   SCCPRData = 'S:/CCPR/DATA/'
#   
#   # Bonds ..........................................................................................
#   y = download.file(paste0('https://fred.stlouisfed.org/graph/fredgraph.csv?bgcolor=%23e1e9f0&chart_type=line&drp=0&fo=open%20sans&graph_bgcolor=%23ffffff&height=450&mode=fred&recession_bars=on&txtcolor=%23444444&ts=12&tts=12&width=1318&nt=0&thu=0&trc=0&show_legend=yes&show_axis_titles=yes&show_tooltip=yes&id=DGS10&scale=left&cosd=1900-01-01&coed=',Sys.Date(),'&line_color=%234572a7&link_values=false&line_style=solid&mark_type=none&mw=3&lw=2&ost=-99999&oet=99999&mma=0&fml=a&fq=Daily&fam=avg&fgst=lin&fgsnd=2020-02-01&line_index=1&transformation=lin&vintage_date=',Sys.Date(),'&revision_date=',Sys.Date(),'&nd=1962-01-02'), 
#                     'C:/temp/fed.csv')
#   
#   data = setDT(fread('C:/temp/fed.csv'))
#   My.Kable(data)
#   y = data[, .(code = 'BNDGUS10Y', name = 'U.S. 10Y BOND YIELD', date = as.Date(DATE), close = as.numeric(DGS10))]
#   y[, close := na.locf(close)]
#   My.Kable(y[is.na(close)])
#   
#   xc  = CCPR_READRDS(UData, 'DOWNLOAD_INV_BND_HISTORY.rds', ToKable = T, ToRestore = T)
#   My.Kable(xc)
#   
#   BND = unique(xc[code=='BNDGUS10Y'][order(date)], by=c('code', 'date'))
#   BND = unique(rbind(BND[!is.na(close)], y, fill = T), by = c('code', 'date'),  fromLast = T)
#   BND[, rtd:=(close/100)/365]
#   My.Kable(BND[, .(code, date, rtd, close)])
#   BND[, value:=100]
#   LastValue = 100
#   
#   cumulative_rtd = cumprod(1 + BND$rtd)
#   BND$value      = c(LastValue, LastValue * cumulative_rtd[-nrow(BND)])
#   # BND[, value2 := c(value[1], LastValue*cumprod((1+rtd[-(.N)])))]
#   
#   # for (k in 2: nrow(BND))
#   # {
#   #   # k = 3
#   #   LastValue = LastValue*(1+BND[k-1]$rtd)
#   #   BND[k]$value = LastValue
#   # }
#   
#   BND = BND[, .(code, date, rtd, close=value, value)]
#   BND = MERGE_DATASTD_BYCODE(BND, pOption = 'FINAL')
#   My.Kable(BND[order(date)])
#   
#   
#   # Crypto ..........................................................................................
#   xc = CCPR_READRDS(UData, 'DOWNLOAD_CNM_CURCRY_HISTORY.rds', ToKable = T, ToRestore = T)
#   x1 = xc[grepl('BTC', code)]
#   BTC = x1[code=='CURCRYBTC']
#   My.Kable.Min(BTC[order(date)])
#   
#   y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = 'BTC-USD', freq.data = 'daily', p_saveto="", NbTry=10) 
#   y[, code := 'CURCRYBTC']
#   z = unique(rbind(BTC, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
#   My.Kable(z[order(date)][, .(code, date, close)])
#   BTC = z
#   
#   xc = CCPR_READRDS(UData, 'DOWNLOAD_YAH_CMD_HISTORY.rds', ToKable = T, ToRestore = T)
#   x1 = xc[grepl('GOLD', code)]
#   GOLD = x1[code=='CMDGOLD'][, close := close_adj]
#   My.Kable.Min(GOLD[order(date)])
#   
#   y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = 'GC=F', freq.data = 'daily', p_saveto="", NbTry=10) 
#   z = unique(rbind(GOLD, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
#   My.Kable(z[order(date)][, .(code, date, close)])
#   GOLD = z
#   
#   x = CCPR_READRDS(UData, 'EFRC_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
#   x1 = x[grepl('VNI', code)]
#   VNIx1 = x1[code =='INDVNINDEX']
#   
#   y = CCPR_READRDS(UData, 'download_caf_indvn_prices_history.rds', ToKable = T, ToRestore = T)
#   y1 = y[grepl('VNI', code)]
#   VNIy1 = y1[code=='INDVNINDEX']
#   z = unique(rbind(VNIx1, VNIy1, fill = T), by = c("code", "date"), fromLast = T)
#   My.Kable(z[order(date)][, .(code, date, close)])
#   VNI = z
#   
#   x1 = x[grepl('500', name)]
#   SPX = x1[code=='INDSPX']
#   My.Kable(SPX[, .(code, date, close)])
#   y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^GSPC', freq.data = 'daily', p_saveto="", NbTry=10) 
#   z = unique(rbind(SPX, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
#   My.Kable(z[order(date)][, .(code, date, close)])
#   SPX = z
#   
#   x1 = x[grepl('NASDAQ', name)]
#   NDX = x1[code=='INDNDX']
#   My.Kable(NDX[, .(code, date, close)])
#   y = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^NDX', freq.data = 'daily', p_saveto="", NbTry=10) 
#   z = unique(rbind(NDX, y, fill = T), by = c("code", "date"), fromLast = T)[, .(code, date, close)]
#   My.Kable(z[order(date)][, .(code, date, close)])
#   NDX = z
#   
#   # N225 = x1[code=='INDN225']
#   
#   IPO = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = 'IPO', freq.data = 'daily', p_saveto="", NbTry=10) 
#   # x1 = MERGE_DATASTD_BYCODE(IPO)[order(code, date)]
#   # x2 = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', IPO)
#   IPO = MERGE_DATASTD_BYCODE(IPO, pOption = 'FINAL')
#   IPO[, ':=' (code = 'FNDINIPOIPO', name = 'RENAISSANCE IPO ETF', type = 'FND', fcat = 'FND', scat = 'EQUITY', isin = 'US7599372049')]
#   
#   # a = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^990100-USD-STRD', freq.data = 'daily', p_saveto="", NbTry=10) 
#   # # x1 = MERGE_DATASTD_BYCODE(IPO)[order(code, date)]
#   # # x2 = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', IPO)
#   # MSCI = MERGE_DATASTD_BYCODE(MSCI, pOption = 'FINAL')
#   # MSCI[, ':=' (code = 'INDMSCIWORLD', name = 'MSCI WORLD PR (USD)', type = 'FND', fcat = 'INDOTH', scat = 'EQUITY')]
#   x = CCPR_READRDS(UData, 'EFRC_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
#   # y = CCPR_READRDS(UData, 'DOWNLOAD_YAH_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
#   MSCIz = CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', 'MSCI_WORLD.rds', ToKable = T, ToRestore = T)
#   # MSCI_YAH = DOWNLOAD_YAH_INS_PRICES_UNADJ (p_nbdays_back = 3600, tickers = '^990100-USD-STRD', freq.data = 'daily', p_saveto="", NbTry=10) 
#   MSCI = x[grepl('INDMSCIWORLD', code)][, code := gsub('USD','',code)]
#   # MSCI[, codesource := '^990100-USD-STRD']  
#   # MSCI = merge(unique(MSCI[, -c('date','close')], by = 'codesource'), MSCI_YAH[, .(codesource, date, close)], all.y = T, by = 'codesource')
#   MSCI = unique(rbind(MSCI, MSCIz, fill = T), fromLast = T, by = c('code','date'))
#   
#   ASEAN40 = x[grepl('ASEAN40', code)]
#   # y = CCPR_READRDS(UData, 'DOWNLOAD_RTS_INDHOME_HISTORY.rds', ToKable = T, ToRestore = T)
#   ASEAN40z = CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ASEAN_40.rds', ToKable = T, ToRestore = T)
#   ASEAN40z[, code := 'INDFTSEASEAN40']
#   ASEAN40 = unique(rbind(ASEAN40, ASEAN40z, fill = T), fromLast = T, by = c('code','date'))
#   
#   LOG_HISTORY = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indlogals_history.rds', ToRestore = T)))
#   LOG = LOG_HISTORY[code == 'INDVNXSECLOGCWPRVND']
#   
#   FIN_HISTORY = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indfinals_history.rds', ToRestore = T)))
#   FIN = FIN_HISTORY[code == 'INDVNXSECFINCWPRVND']
#   
#   HLC_HISTORY = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indhlcals_history.rds', ToRestore = T)))
#   HLC = HLC_HISTORY[code == 'INDVNXSECHLCCWPRVND']
#   
#   ENY_HISTORY = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/INDEX_2024/', 'beq_indenyals_history.rds', ToRestore = T)))
#   ENY = ENY_HISTORY[code == 'INDVNXSECENYCWPRVND']
#   
#   xALL = rbind(VNI, NDX, SPX, BTC, GOLD, BND, LOG, FIN, HLC, ENY, IPO, MSCI, ASEAN40, fill=T)[, .(code, name, date, close)]
#   xALL = unique(xALL, by=c('code', 'date'))
#   xALL = MERGE_DATASTD_BYCODE(xALL, pOption='FINAL')[order(code, date)]
#   xALL = xALL[date<=MaxDate]
#   
#   xALL = xALL[order(code, date)]
#   xALL[, rt := close/shift(close), by = 'code']
#   
#   xALL[, sub_name := name]
#   
#   xALL[code == 'INDVNXSECLOGCWPRVND', sub_name := 'BEQ LOGISTICS SECTOR']
#   xALL[code == 'INDVNXSECFINCWPRVND', sub_name := 'BEQ FINANCE SECTOR']
#   xALL[code == 'INDVNXSECENYCWPRVND', sub_name := 'BEQ ENERGY SECTOR']
#   xALL[code == 'INDVNXSECHLCCWPRVND', sub_name := 'BEQ HEALTH CARE SECTOR']
#   xALL[code == 'INDMSCIWORLD'       , sub_name := 'MSCI WORLD PR (USD)']
#   xALL[code == 'INDFTSEASEAN40'     , sub_name := 'FTSE/ASEAN40']
#   xALL[code == 'INDFTSEASEAN40'     , name := 'FTSE/ASEAN40']
#   
#   # xALL[, sub_name := name]
#   # xALL[, name := NULL]
#   My.Kable.Min(xALL)
#   My.Kable.All(unique(xALL[order(code, -date)], by='code'))
#   
#   dir.create(paste0(CCPRData, 'INDEX/'))
#   dir.create(paste0(SCCPRData, 'INDEX/'))
#   
#   try(CCPR_SAVERDS(xALL, paste0(CCPRData, 'INDEX/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
#   try(CCPR_SAVERDS(xALL, paste0(CCPRData, 'DASHBOARD/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
#   try(CCPR_SAVERDS(xALL, paste0(SCCPRData, 'INDEX/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
#   try(CCPR_SAVERDS(xALL, paste0(SCCPRData, 'DASHBOARD/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
#   try(CCPR_SAVERDS(xALL, paste0('S:/SHINY/INDEX/DASHBOARD/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
#   try(CCPR_SAVERDS(xALL, paste0('S:/CCPR/DATA/DASHBOARD_LIVE/'), 'ifrc_ccpr_investment_history.rds', ToSummary = T, SaveOneDrive = T))
# }


# ==================================================================================================
TRAINEE_LOOP_ACTION_MISC = function()  {
  # ------------------------------------------------------------------------------------------------
  
  source(paste0(SDLibrary, "TRAINEE_LIBRARY.R"),                                               echo=F)
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
    LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
    for (pMarket in sample(list('HSX', 'HNX')))
    {
      for (FirstChars in sample(List_SetChars))
      {
        x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = FirstChars, random = F,
                                                  pMarket    = pMarket, 
                                                  pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                  File_Pattern  = paste0('DOWNLOAD_YAH_STKVN_DIVIDEND_DAY'),
                                                  pDate      = LastTrading,
                                                  List_Codes = list(''),
                                                  File_Codes = paste0('S:/CCPR/DATA/download_', pMarket,'_stkvn_ref_history.rds'),
                                                  Action     = paste0('TRAINEE_DOWNLOAD_YAH_STK_DIVIDEND')))
      }
    }
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    try(MERGE_HSX_HNX_UPC_TO_EXC(Prefix= 'PRICESBOARD'))
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    try(MERGE_HSX_HNX_UPC_TO_EXC(Prefix= 'SNAPSHOT'))
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    try(MERGE_HSX_HNX_UPC_TO_EXC(Prefix= 'SHARES'))
  }
  
  # REPORTS
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    X = try(TRAINEE_REPORT_PRICES_DAILY (File_Folder = 'S:/STKVN/PRICES/DAY/', 
                                         LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL')))
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    X = try(TRAINEE_REPORT_OPEN_FINAL (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                       LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'STB', 'DCL'),
                                       LIST_DATASET = list('reference_open', 'market', 'sharesout',
                                                           Pre_Date = '')))
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    X = try(TRAINEE_REPORT_CLOSE_FINAL (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                        LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'STB', 'DCL'),
                                        # LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL'),
                                        LIST_DATASET = list('reference', 'market', 'sharesout', 'close', 'volume') ))
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    X = try(TRAINEE_REPORT_DAY_OPENCLOSE (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                          LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'STB', 'DCL'),
                                          # LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL'),
                                          SESSION = 'CLOSE'))
  }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>33)
  {
    X = try(TRAINEE_REPORT_DAY_OPENCLOSE (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                          LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL'),
                                          SESSION = 'OPEN'))
  }
  
  List_SOURCES = list('VND','CAF', 'TVSI', 'VST', 'VPS', 'MBS', 'BSC', 'HSX', 'HNX', 'UPC', 'C68')
  for (pSource in sample(List_SOURCES))
  {
    try(PRICESBOARD_TO_UDATA_PRICES_AND_HISTORY(pSource = pSource, ToIntegrate = T))
  }
  
  try(SNAPSHOT_TO_UDATA_SHARES_AND_HISTORY(pSource = 'HNX', ToIntegrate = T))
  try(SNAPSHOT_TO_UDATA_SHARES_AND_HISTORY(pSource = 'UPC', ToIntegrate = T))
  
  # PRICESDAY
  if ( CHECK_TIMEBETWEEN('20:00' , '23:30') || CHECK_TIMEBETWEEN('01:00' , '07:00') )
  {
    # for (pSource in list ('VND', 'VST', 'C68'))
    # {
    #   List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
    #   LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
    
    #   for (pFirstChars in sample(List_SetChars))
    #   {
    #     hsx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
    #                                                 pMarket    = 'HSX', 
    #                                                 pFolder    = 'S:/STKVN/PRICES/DAY/',
    #                                                 File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_PRICESDAY'),
    #                                                 pDate      = LastTrading,
    #                                                 List_Codes = list(),
    #                                                 File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
    #                                                 Action     = paste0('DOWNLOAD_', pSource, '_STKVN_PRICESDAY_BY_CODE')))
    #     hnx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
    #                                                 pMarket    = 'HNX', 
    #                                                 pFolder    = 'S:/STKVN/PRICES/DAY/',
    #                                                 File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_PRICESDAY'),
    #                                                 pDate      = LastTrading,
    #                                                 List_Codes = list(),
    #                                                 File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
    #                                                 Action     = paste0('DOWNLOAD_', pSource, '_STKVN_PRICESDAY_BY_CODE')))
    #   }
    #   rm(hsx, hnx)
    #   GC_SILENT()
    # }
    List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
    LastTradingClose = CCPR_LAST_TRADING_DAY_VN(16, ToPrompt = T)
    
    for (SOURCE in sample(list('VPS','C68','DNSE', 'VND', 'CAF'))){
      for (MARKET in sample(list('HNX','HSX','UPC'))){
        for (pFirstChars in sample(List_SetChars)){
          if (ToForce || CHECK_TIMEBETWEEN('17:00' , '23:00') || CHECK_TIMEBETWEEN('12:00' , '14:00') || CHECK_TIMEBETWEEN('01:00' , '05:00')){
            FirstChar = pFirstChars
            x = NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE ( ranking    = '', FirstChars = pFirstChars, random = F,
                                                   pMarket    = MARKET, 
                                                   pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                   File_Pattern  = paste0('DOWNLOAD_',SOURCE,'_STKVN_PRICESDAY_',FirstChar),
                                                   pDate      = LastTradingClose,
                                                   List_Codes = list(),
                                                   File_Codes = paste0("S:/CCPR/DATA/download_",tolower(MARKET),"_stkvn_ref_history.rds"),
                                                   Action     = paste0('DOWNLOAD_',SOURCE,'_STKVN_PRICESDAY_BY_CODE')
            )
          }
        }
      }
    }
  }
  
  LIST_SOURCES = list('HSX', 'HNX', 'UPC', 'VND', 'MBS', 'VPS', 'TVSI','BSC','VST', 'C68', 'CAF')
  for (pSource in sample(LIST_SOURCES))
  {
    try(COPY_PRICESBOARD_SNAPSHOT_YYYYMMDD_TO_DAY(Prefix='PRICESBOARD', pSource=pSource, STKVN=F, ToForce = (runif(1,1,100)>50)))
  }
  
  for (pSource in sample(LIST_SOURCES))
  {
    try(COPY_PRICESBOARD_SNAPSHOT_YYYYMMDD_TO_DAY(Prefix='SNAPSHOT', pSource=pSource, STKVN=F, ToForce = (runif(1,1,100)>50)))
  }
  
  
  
  # CAF_DIV
  #   for (pSource in list ('CAF'))
  # {
  #   List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
  #   LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  #   
  #   for (pFirstChars in sample(List_SetChars))
  #   {
  #     hsx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
  #                                                 pMarket    = 'HSX', 
  #                                                 pFolder    = 'S:/STKVN/PRICES/DAY/',
  #                                                 File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_DIVIDEND'),
  #                                                 pDate      = LastTrading,
  #                                                 List_Codes = list(),
  #                                                 File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
  #                                                 Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_DIV_BY_CODE')))
  #     
  #     hnx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
  #                                                 pMarket    = 'HNX', 
  #                                                 pFolder    = 'S:/STKVN/PRICES/DAY/',
  #                                                 File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_DIVIDEND'),
  #                                                 pDate      = LastTrading,
  #                                                 List_Codes = list(),
  #                                                 File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
  #                                                 Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_DIV_BY_CODE')))
  #   }
  #   rm(hsx, hnx)
  #   GC_SILENT()
  # }
  
  # DIVIDEND
  for (pSource in list ('CAF','FANT'))
  {
    List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
    LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
    
    for (pFirstChars in sample(List_SetChars))
    {
      hsx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                  pMarket    = 'HSX', 
                                                  pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                  File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_DIVIDEND'),
                                                  pDate      = LastTrading,
                                                  List_Codes = list(),
                                                  File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
                                                  Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_DIV_BY_CODE')))
      
      hnx = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                  pMarket    = 'HNX', 
                                                  pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                  File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_DIVIDEND'),
                                                  pDate      = LastTrading,
                                                  List_Codes = list(),
                                                  File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                  Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_DIV_BY_CODE')))
      
      upc = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                  pMarket    = 'UPC', 
                                                  pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                  File_Pattern  = paste0('DOWNLOAD_', pSource, '_STKVN_DIVIDEND'),
                                                  pDate      = LastTrading,
                                                  List_Codes = list(),
                                                  File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                  Action     = paste0('TRAINEE_DOWNLOAD_', pSource, '_STKVN_DIV_BY_CODE')))
    }
    rm(hsx, hnx)
    GC_SILENT()
  }
  
  TRAINEE_MONITOR_EXECUTION_SUMMARY (pOption='TRAINEE_LOOP_ACTION_MISC', pAction="SAVE", NbSeconds=3600, ToPrint=F)
}

# ==================================================================================================
TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO = function(Folder_Fr = UData, File_Fr = 'EFRC_CUR_HISTORY.RDS', 
                                                                Folder_To = UData, File_To = 'EFRC_CUR_HISTORY_1M.RDS', 
                                                                RemoveNA = T, NbDays = 31, pCondition = '', MinPercent = 1, ToForce = F, IncludedOnly = F) {
  # ------------------------------------------------------------------------------------------------
  
  try(GC_SILENT())
  DATACENTER_LINE_BORDER_BEGINEND(paste('TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO :',File_To), 'BEGIN')
  
  TO_DO = try(TRAINEE_CCPR_SUMMARY_DATE_COMPARE_UPDATES_PERCENT_BY_CODE(Folder_Fr = Folder_Fr, Folder_To = Folder_To, 
                                                                        File_Fr   = File_Fr, 
                                                                        File_To   = File_To, MinPercent = MinPercent, EchoOn = F))
  if (ToForce || TO_DO)
  {
    try(TRAINEE_IFRC_SLEEP(2))
    try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO(Folder_Fr = Folder_Fr, Folder_To=Folder_To,
                                                     File_Fr = File_Fr, File_To = File_To, 
                                                     RemoveNA = RemoveNA, NbDays = NbDays, pCondition = pCondition, IncludedOnly = IncludedOnly))
    try(GC_SILENT())
  }
  DATACENTER_LINE_BORDER_BEGINEND(paste('TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY_FR_TO :',File_To), 'END')
  try(GC_SILENT())
}

# ==================================================================================================
TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO_V0 = function(Folder_Fr = UData, File_Fr = 'EFRC_CUR_HISTORY.RDS',
                                                           Folder_To = UData, File_To = 'EFRC_CUR_HISTORY_1M.RDS', RemoveNA = T, NbDays = 31, pCondition = '') {
  # ------------------------------------------------------------------------------------------------
  GC_SILENT()
  DATACENTER_LINE_BORDER_BEGINEND(paste('TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO :',File_To), 'BEGIN')
  Data_Fr     = CHECK_CLASS(try(CCPR_READRDS(Folder_Fr, File_Fr, ToKable = T, ToRestore = T)))
  if (nrow(Data_Fr)>0)
  {
    if (File_Fr != File_To)
    {
      Data_To     = CHECK_CLASS(try(CCPR_READRDS(Folder_To, File_To, ToKable = T, ToRestore = T)))
    } else { Data_To =  data.table()}
    Data_To     = rbind(Data_To, Data_Fr, fill=T)
    My.Kable.Min(Data_To)
    if (nrow(Data_To)>0)
    {
      Data_To = unique(Data_To, by=c('code', 'date'))[order(code, date)]
      if (RemoveNA) { Data_To = Data_To[!is.na(code) & !is.na(date)]}
      if (NbDays!=0)
      {
        # Data_To[, x.maxdate:=max(date), by='code']
        Data_To = Data_To[order(code, -date)]
        Data_To[, x.nr:=seq.int(1,.N), by='code']
        
        Data_To = Data_To[x.nr<=NbDays]
        Data_To = Data_To[order(code, date)]
        Data_To$x.nr = NULL
      }
      Data_To = MERGE_DATASTD_BYCODE(Data_To, pOption='FINAL')[!is.na(date) & date>="1800-01-01" & date<="2099-12-31"]
      if (nchar(pCondition)>0) {  Data_To = Data_To[eval(parse(text = pCondition))] }
      Data_To[type!='STK', close_adj:=close]
      Data_To[type!='STK' & !is.na(rt), rt:=(close/shift(close))-1, by='code']
      CATln_Border("MERGED DATA")
      My.Kable.Min(Data_To[order(date)])
    }
    if (nrow(Data_To)>0)
    {
      try(CCPR_SAVERDS(Data_To, Folder_To, File_To, ToKable = T, ToSummary = T, SaveOneDrive = T))
    }
  }
  DATACENTER_LINE_BORDER_BEGINEND(paste('TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_FR_TO :',File_To), 'END')
  GC_SILENT()
}

TRAINEE_LOOP_ACTION = function(Action='DOWNLOAD_HNX_STKVN_SNAPSHOT')
{
  switch(Action,
         'DOWNLOAD_UPC_STKVN_SNAPSHOT' = {
           List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
           LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
           
           for (pFirstChars in sample(List_SetChars))
           {
             # pFirstChars = 'ABC'
             # pFirstChars = 'VWXYZ'
             upc = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                         pMarket    = 'UPC', 
                                                         pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                         File_Pattern  = paste0('DOWNLOAD_UPC_STKVN_SNAPSHOT'),
                                                         pDate      = LastTrading,
                                                         List_Codes = list(),
                                                         File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                         Action     = 'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE'))
             
           }
         },
         'DOWNLOAD_HNX_STKVN_SNAPSHOT' = {
           List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
           LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
           
           for (pFirstChars in sample(List_SetChars))
           {
             # pFirstChars = 'ABC'
             # pFirstChars = 'VWXYZ'
             upc = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                         pMarket    = 'HNX', 
                                                         pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                         File_Pattern  = paste0('DOWNLOAD_HNX_STKVN_SNAPSHOT'),
                                                         pDate      = LastTrading,
                                                         List_Codes = list(),
                                                         File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                         Action     = 'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE'))
             
           }
         }
  )
}

# ==================================================================================================
OLD_LOOP_DOWNLOAD_CUSTOM_BY_CODE = function( ranking    = '', FirstChars = 'ABC', random = F,
                                             pMarket    = 'HNX', 
                                             pFolder    = 'S:/STKVN/PRICES/DAY/',
                                             File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                             pDate      = Sys.Date(),
                                             List_Codes = list(),
                                             File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                             Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT') {
  # ------------------------------------------------------------------------------------------------
  
  # ranking    = 'ASC'; FirstChars = ''; random = F;  pMarket    = 'HNX'; pDate      = Sys.Date();   List_Codes = list()
  # pFolder    = 'S:/STKVN/PRICES/DAY/';  File_Name  = paste0('TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE_', gsub('-','', Sys.Date()), '.rds')
  # File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds"
  
  DBL_RELOAD_INSREF()
  File_Name = paste0(File_Pattern,'_', gsub('-','', pDate), '.rds')
  FilePath  = paste0(pFolder, File_Name)
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  Data_All  = data.table()
  # File_Codes_RAW = gsub('S:/CCPR/DATA/','', File_Codes)
  count_char = str_count(File_Codes, "[/]")
  
  File_Codes_RAW   = word(File_Codes, count_char+1, count_char+1, "[/]")
  Folder_Codes_RAW = paste0(word(File_Codes, 1, count_char, "[/]"),'/')
  
  if (length(List_Codes)==0 & nchar(File_Codes)>0)
  {
    List_Codes = CCPR_READRDS(Folder_Codes_RAW, File_Codes_RAW, ToKable = T, ToRestore = T)
    List_Codes = unique(List_Codes[order(-date)], by = 'codesource' )
    List_Codes = as.vector(List_Codes$codesource)
  }
  
  if (nchar(ranking)>0)
  {
    switch (ranking,
            'ASC' = {
              List_Codes = sort(List_Codes, decreasing = F)
            },
            'DESC' = {
              List_Codes = sort(List_Codes, decreasing = T)
            })
  }
  
  if (nchar(FirstChars)>0)
  {
    char_set <- strsplit(FirstChars, "")[[1]]
    # inChars <- 'ABC'
    # > List_CODES <- c('AAB', 'AAC', 'BCC', 'XXY')
    # Vectorized filtering for efficiency
    Selected_Codes = List_Codes[substr(List_Codes, 1, 1) %in% char_set]
    List_Codes = Selected_Codes 
  }
  print(List_Codes)
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  
  ExtraFolder = ''
  
  if (file.exists(FilePath))
  {
    Data_old = CHECK_CLASS(try( CCPR_READRDS(pFolder, File_Name, ToKable = T, ToRestore = T)))
    
    if (nrow(Data_old)>0) 
    {
      Data_done = unique(Data_old[!is.na(codesource)][order(-date)], by = 'codesource')
      # str(Data_done)
      Data_List = Data_done[codesource %in% List_Codes & date >= pDate]
      List_Codes_ToDo = setdiff(List_Codes, as.vector(Data_List$codesource))
      length(List_Codes_ToDo)
    } else {
      List_Codes_ToDo = List_Codes
    }
  } else { 
    CATln(paste('FILE NO EXIST :', FilePath))
    Data_old = data.table() 
    List_Codes_ToDo = List_Codes
  }
  print(List_Codes_ToDo)
  
  
  # ================================================================================================
  
  if (length(List_Codes_ToDo)>0)
  {
    Data_All = Data_old
    if (random){
      List_Codes_ToDo = sample(List_Codes_ToDo)
    }
    Data_All = data.table()
    Data_List = list()
    
    FileDataAll = List_Codes_ToDo
    FileRow  = nrow(List_Codes_ToDo)
    Nb_Total = length(List_Codes_ToDo)
    
    FileToSave = paste0(File_Name)
    Total_Time  = 0
    
    for (i in 1:Nb_Total)
    {
      # i = 1
      Start.Time = Sys.time()
      pCode    = List_Codes_ToDo[i]
      CATln("")
      
      Sys.sleep(1)
      My_Data = data.table()
      
      if (! pCode %in% Data_All$codesource)
      {
        switch(Action,
               
               'TRAINEE_DOWNLOAD_YAH_STK_DIVIDEND' = {
                 xCode = paste0(pCode, '.VN')
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_STK_DIVIDEND( pCode = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='YAH', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               },
               
               'TRAINEE_DOWNLOAD_YAH_STKVN_PRICES_BY_CODE' = {
                 xCode = paste0(pCode, '.VN')
                 My_Data = CHECK_CLASS(try(DOWNLOAD_YAH_INS_PRICES_UNADJ(p_nbdays_back= 250000, tickers=xCode, freq.data='daily', p_saveto="", NbTry=15))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='YAH', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               },
               'TRAINEE_DOWNLOAD_YAH_STKVN_DIV_BY_CODE' = {
                 xCode = paste0(pCode, '.VN')
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_DIVIDEND(pCode = xCode, Nbdays = 10000, ToKable = T, silent = T) )) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='YAH', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_DIV_BY_CODE (pCode = pCode))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLOAD_VST_STKVN_DIV_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VST_STKVN_DIV_BY_CODE (pCode = pCode))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VST', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='UPC', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) # HNX
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='HNX', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'DOWNLOAD_CAF_STKVN_SNAPSHOT' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_SNAPSHOT_BY_CODE (pCode  = pCode, URL = '', ToAdd = F)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'DOWNLOAD_DNSE_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'DNSE', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='DNSE', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_VND_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'VND', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_VPS_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'VPS', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VPS', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_C68_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'C68', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='C68', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_VND_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = 'VND', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_DNSE_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = 'DNSE', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='DNSE', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_24H_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = '24HMONEY', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='24H', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_CAF_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_CAF_STKVN_SHARES_BY_CODE (pCode  = pCode, URL = '', ToAdd = F) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               }, 
               'TRAINEE_DOWNLOAD_C68_STKVN_SHARES_BY_CODE' = {
                 My_Data = CHECK_CLASS(try( TRAINEE_DOWNLOAD_C68_STKVN_SHARES_BY_CODE (pCode = pCode) ))
                 if (nrow(My_Data)>0)
                 {
                   My_Data = UPDATE_UPDATED (My_Data) 
                 }
               }
        )
        
        My.Kable.TB (My_Data)
        # My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) 
        # if (all(class(My_Data)!='try-error') )
        if (all(class(My_Data)!='try-error') && nrow(My_Data)>0)
        {
          Data_old_restore = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name)))
          Data_All = rbind(Data_All, My_Data, Data_old, Data_old_restore, fill=T)[!is.na(code)]
          Data_All[, market:=pMarket]
          Data_All = unique(Data_All[order(codesource, date, -updated)], by=c('codesource', 'date'))
          My.Kable.TB(Data_All)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := pDate]}
          
          CCPR_SAVERDS(Data_All ,  pFolder, File_Name, SaveOneDrive = T)
          CATln_Border(paste ('SAVED: ', paste0(pFolder, File_Name), '=', nrow(Data_All), 'records') )
          
        }
      }
      
      End.Time = Sys.time()
      Total_Time = Format.Number(as.numeric(difftime(End.Time, Start.Time, units = 'secs')), 3) 
      # Avg_Time = Total_Time / i
      # End_Forecast = Avg_Time * (Nb_TODO - i)
      # Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
      # CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      CATln_Border(paste('DURATION :', substr(Total_Time,1,19)))
    }
    
  } else {
    CATln_Border(paste0('DATA FULLY UPDATED = ',FilePath))
    Sys.sleep(2)
  }
  return(Data_All)
}


# ==================================================================================================
SNAPSHOT_TO_UDATA_SHARES_AND_HISTORY = function(pSource = 'HNX', ToIntegrate = T)  {
  # ------------------------------------------------------------------------------------------------
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  File_PricesBoard = paste0('DOWNLOAD_', pSource, '_STKVN_SNAPSHOT_', gsub('-','', LastTrading), '.rds')
  CATln_Border(File_PricesBoard)
  Data_PricesBoard = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', File_PricesBoard)))
  My.Kable(Data_PricesBoard)
  
  
  if (nrow(Data_PricesBoard)>0)
  {
    Check_Data  = Data_PricesBoard[!is.na(sharesout) & date == LastTrading]
    if (nrow(Check_Data)>0)
    {
      File_Prices = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES_DAY', '.rds')
      CATln_Border(File_Prices)
      Data_Prices = CHECK_CLASS(try(CCPR_READRDS(UData, File_Prices)))
      My.Kable.Min(Data_Prices)
      
      if (nrow(Data_Prices)==0)
      {
        My.Kable(Data_PricesBoard)
        Data_Prices = copy(Data_PricesBoard)
      }
      
      if (nrow(Data_Prices)>0)
      {
        if ('last' %in% names(Data_Prices)) { Data_Prices[, close:=last] }
        Data_Prices = Data_Prices[!is.na(last) & date == LastTrading]
        Data_Prices = rbind(Data_Prices, Data_PricesBoard[date==LastTrading], fill=T)
        Data_Prices = unique(Data_Prices, by=c('code', 'date'), fromLast=T)
        # Data_Prices[, close:=last]
        # Data_Prices[is.na(close), close:=reference]
        # Data_Prices[is.na(volume), volume:=0]
        # Data_Prices[, rt:=(close/reference)-1]
        My.Kable(Data_Prices)
        
        if (nrow(Data_Prices)>0)
        {
          Data_Prices = UPDATE_UPDATED(Data_Prices)
          try(CCPR_SAVERDS(Data_Prices, UData, File_Prices, ToKable = T, SaveOneDrive = T))
          
          # PRICESBOARD_HISTORY
          if (ToIntegrate)
          {
            File_HistoryBoard = paste0('DOWNLOAD_', pSource, '_SHARES_HISTORY.rds')
            CATln_Border(File_HistoryBoard)
            Data_HistoryBoard = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', File_HistoryBoard)))
            My.Kable(Data_HistoryBoard)
            Data_HistoryBoard = rbind(Data_HistoryBoard, Data_Prices, fill=T)
            Data_HistoryBoard = unique(Data_HistoryBoard, by=c('code', 'date'), fromLast=T)
            Data_HistoryBoard = MERGE_DATASTD_BYCODE(Data_HistoryBoard, pOption='FINAL')
            # Data_Prices[, close:=last]
            # Data_Prices[is.na(close), close:=reference]
            # Data_Prices[is.na(volume), volume:=0]
            # Data_Prices[, rt:=(close/reference)-1]
            Data_HistoryBoard = UPDATE_UPDATED(Data_HistoryBoard)
            
            My.Kable(Data_HistoryBoard[order(date)][, .(code, name, market, date, shareslis, sharesout)])
            try(CCPR_SAVERDS(Data_HistoryBoard, 'S:/STKVN/PRICES/DAY/', File_HistoryBoard, ToSummary = T, SaveOneDrive = T))
          }
          
          if (ToIntegrate)
          {
            File_History = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES_HISTORY', '.rds')
            CATln_Border(File_History)
            Data_History = CHECK_CLASS(try(CCPR_READRDS(UData, File_History)))
            Data_History = rbind(Data_History, Data_Prices, fill=T)
            Data_History = unique(Data_History, by=c('code', 'date'), fromLast=T)
            Data_History = MERGE_DATASTD_BYCODE(Data_History, pOption='FINAL')
            # Data_Prices[, close:=last]
            # Data_Prices[is.na(close), close:=reference]
            # Data_Prices[is.na(volume), volume:=0]
            # Data_Prices[, rt:=(close/reference)-1]
            Data_History = UPDATE_UPDATED(Data_History)
            My.Kable(Data_History[order(date)][, .(code, name, market, date, shareslis, sharesout)])
            try(CCPR_SAVERDS(Data_History, UData, File_History, ToSummary = T, SaveOneDrive = T))
          }
        }
      }
    }
  }
}


# ==================================================================================================
TRAINEE_CONVERT_FILE_NAME_SHARES = function (File_Folder = 'S:/STKVN/PRICES/DAY/') {
  # ------------------------------------------------------------------------------------------------
  File_Folder <- 'S:/STKVN/PRICES/DAY/'
  files <- list.files(File_Folder)
  selected_files <- files[grep('_stkvn_shares_day.rds', files)]
  selected_files_ccpr <- selected_files[grep("ccpr", selected_files)]
  print(selected_files_ccpr)
  for (file_name in selected_files_ccpr) {
    new_file_name <- gsub("ccpr_", "", file_name)
    old_file_path <- paste0(File_Folder, file_name)
    new_file_path <- paste0(File_Folder, new_file_name)
    file.copy(old_file_path, new_file_path, overwrite = T)
    cat("Created copy:", new_file_name, "\n")
  }
}

# ==================================================================================================
PRICESBOARD_TO_UDATA_PRICES_AND_HISTORY = function(pSource = 'HSX', ToIntegrate = T) {
  # ------------------------------------------------------------------------------------------------
  
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  File_PricesBoard = paste0('DOWNLOAD_', pSource, '_PRICESBOARD_', gsub('-','', LastTrading), '.rds')
  CATln_Border(File_PricesBoard)
  Data_PricesBoard = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', File_PricesBoard)))
  My.Kable(Data_PricesBoard)
  Check_Data = Data_PricesBoard[!is.na(last) & date == LastTrading]
  
  if (nrow(Check_Data)>0)
  {
    File_Prices = paste0('DOWNLOAD_', pSource, '_STKVN_PRICES', '.rds')
    CATln_Border(File_Prices)
    Data_Prices = CHECK_CLASS(try(CCPR_READRDS(UData, File_Prices)))
    My.Kable.Min(Data_Prices)
    
    if (nrow(Data_Prices)>0)
    {
      if ('last' %in% names(Data_Prices)) { Data_Prices[, close:=last] }
      Data_Prices = Data_Prices[!is.na(last) & date == LastTrading]
      Data_Prices = rbind(Data_Prices, Data_PricesBoard[date==LastTrading], fill=T)
      Data_Prices = unique(Data_Prices, by=c('code', 'date'), fromLast=T)
      Data_Prices[, close:=last]
      Data_Prices[is.na(close), close:=reference]
      Data_Prices[is.na(volume), volume:=0]
      Data_Prices[, rt:=(close/reference)-1]
      My.Kable.Min(Data_Prices)
      
      if (nrow(Data_Prices)>0)
      {
        Data_Prices = MERGE_DATASTD_BYCODE(Data_Prices, pOption='FINAL')
        try(CCPR_SAVERDS(Data_Prices, UData, File_Prices, ToKable = T, SaveOneDrive = T))
        
        # VOLUME
        File_Volume = paste0('DOWNLOAD_', pSource, '_STKVN_LIQUIDITY', '.rds')
        CATln_Border(File_Volume)
        try(CCPR_SAVERDS(Data_Prices, UData, File_Volume, ToKable = T, SaveOneDrive = T))
        
        # PRICESBOARD_HISTORY
        if (ToIntegrate)
        {
          File_HistoryBoard = paste0('DOWNLOAD_', pSource, '_PRICESBOARD_HISTORY.rds')
          CATln_Border(File_HistoryBoard)
          Data_HistoryBoard = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', File_HistoryBoard)))
          My.Kable(Data_HistoryBoard)
          Data_HistoryBoard = rbind(Data_HistoryBoard, Data_Prices, fill=T)
          Data_HistoryBoard = unique(Data_HistoryBoard, by=c('code', 'date'), fromLast=T)
          Data_HistoryBoard = MERGE_DATASTD_BYCODE(Data_HistoryBoard, pOption='FINAL')
          # Data_Prices[, close:=last]
          # Data_Prices[is.na(close), close:=reference]
          # Data_Prices[is.na(volume), volume:=0]
          # Data_Prices[, rt:=(close/reference)-1]
          Data_HistoryBoard = UPDATE_UPDATED(Data_HistoryBoard)
          My.Kable.Min(Data_HistoryBoard[order(date)])
          try(CCPR_SAVERDS(Data_HistoryBoard, 'S:/STKVN/PRICES/DAY/', File_HistoryBoard, ToSummary = T, SaveOneDrive = T))
        }
        
        if (ToIntegrate)
        {
          File_History = paste0('DOWNLOAD_', pSource, '_STKVN_HISTORY', '.rds')
          CATln_Border(File_History)
          Data_History = CHECK_CLASS(try(CCPR_READRDS(UData, File_History)))
          Data_History = rbind(Data_History, Data_Prices, fill=T)
          Data_History = unique(Data_History, by=c('code', 'date'), fromLast=T)
          Data_History = MERGE_DATASTD_BYCODE(Data_History, pOption='FINAL')
          # Data_Prices[, close:=last]
          # Data_Prices[is.na(close), close:=reference]
          # Data_Prices[is.na(volume), volume:=0]
          # Data_Prices[, rt:=(close/reference)-1]
          My.Kable.Min(Data_History[order(date)])
          Data_History = UPDATE_UPDATED(Data_History)
          try(CCPR_SAVERDS(Data_History, UData, File_History, ToSummary = T, SaveOneDrive = T))
        }
      }
    }
  }
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='PRICESBOARD_TO_UDATA_PRICES_AND_HISTORY', pAction="SAVE", NbSeconds=1, ToPrint=F))
}

# ==================================================================================================
OPENCLOSE_PRIMARY = function ()  {
  # ------------------------------------------------------------------------------------------------
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  
  if (CHECK_TIMEBETWEEN('08:30' , '22:00') & wday(Sys.Date()) %in% c(2:6) ) 
  {  
    try(TRAINEE_DOWNLOAD_SOURCES_STKVN_PRICESBOARD())
  }
  
  if (CHECK_TIMEBETWEEN('08:00' , '15:00') & wday(Sys.Date()) %in% c(2:6) )
  {
    try(TRAINEE_DOWNLOAD_SOURCES_STKVN_INFO())
  }
  
  if (CHECK_TIMEBETWEEN('09:00' , '22:00') & wday(Sys.Date()) %in% c(2:6) ) 
  {  
    List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
    
    for (pFirstChars in sample(List_SetChars))
    {
      # pFirstChars = 'ABC'
      # pFirstChars = 'VWXYZ'
      x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                pMarket    = 'HSX', 
                                                pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                pDate      = LastTrading,
                                                List_Codes = list(),
                                                File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
                                                Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
    }
    
    LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
    for (pFirstChars in sample(List_SetChars))
    {
      # pFirstChars = 'ABC'
      x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                pMarket    = 'HNX', 
                                                pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                pDate      = LastTrading,
                                                List_Codes = list(),
                                                File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
    }
    
    for (pFirstChars in sample(List_SetChars))
    {
      # pFirstChars = 'ABC'
      x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                pMarket    = 'UPC', 
                                                pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                pDate      = LastTrading,
                                                List_Codes = list(),
                                                File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
    }
    
    x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'ASC', FirstChars = '', random = T,
                                              pMarket    = 'HNX', 
                                              pFolder    = 'S:/STKVN/PRICES/DAY/',
                                              File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                              pDate      = LastTrading,
                                              List_Codes = list(),
                                              File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                              Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
    x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'ASC', FirstChars = '', random = T,
                                              pMarket    = 'HSX', 
                                              pFolder    = 'S:/STKVN/PRICES/DAY/',
                                              File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                              pDate      = LastTrading,
                                              List_Codes = list(),
                                              File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
                                              Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
    x = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'ASC', FirstChars = '', random = T,
                                              pMarket    = 'UPC', 
                                              pFolder    = 'S:/STKVN/PRICES/DAY/',
                                              File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                              pDate      = LastTrading,
                                              List_Codes = list(),
                                              File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                              Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
    
  }
  
}


# ==================================================================================================
OPENCLOSE_SECONDARY = function ()  {
  # ------------------------------------------------------------------------------------------------
  pRANDOM = runif(1,1,100)
  if (pRANDOM>75) { try(SYNCHRONISE_LIST_FILES()) }
  
  pRANDOM = runif(1,1,100)
  if (pRANDOM>75) { try(FILES_DATES()) }
}


# ==================================================================================================
TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK = function (pOption = 'WHERE_TO_INVEST', Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/DASHBOARD/', 
                                                    Fr_File = 'ifrc_ccpr_investment_history.rds',
                                                    To_Folder = 'S:/CCPR/DATA/DASHBOARD/', To_File = 'ccpi_dashboard_wti.rds', 
                                                    DateLimit = Sys.Date() ,
                                                    ToSave = T, ToUpload = T , Remove_MAXABSRT = T,
                                                    ToAddBenchmark = F, REF_LIST = list (),
                                                    pHost = 'dashboard_live')  {
  # ------------------------------------------------------------------------------------------------
  
  start = Sys.time()
  if (pOption == 'WHERE_TO_INVEST') {
    if (nrow (Fr_Data) == 0) {
      DATA_OLD = CCPR_READRDS (Fr_Folder, Fr_File)
      IPO = CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ETFIPO.rds')
      Fr_Data = unique ( rbind (DATA_OLD, IPO, fill = T), by = c('code', 'date') )
      Fr_Data = Fr_Data [!is.na(close)]
      Fr_Data [, ':=' (close_adj = close)]
      Fr_Data [, rt:=((close_adj/shift(close_adj))-1), by='code']
      Fr_Data = DBL_IND_CALCULATE_RT_VAR_CHANGE (Fr_Data, Remove_zero = T)
    } else { Fr_Data = Fr_Data
    Fr_Data = Fr_Data [!is.na(close)]
    }
    
  }
  
  My_Data =  TRAINEE_CALCULATE_FILE_PERFORMANCE  (pData = Fr_Data, pFolder = Fr_Folder,
                                                  pFile   = Fr_File, EndDate  = DateLimit, Remove_MAXABSRT = Remove_MAXABSRT ) 
  
  
  switch (pOption,
          'CCPI_RESEARCH_INDEXES' = {
            My_Data [, ':=' (cur = substr(code, nchar(code)-2, nchar(code)), version = substr(code, nchar(code)-4, nchar(code)-3),
                             wgtg = substr(code, nchar(code)-6, nchar(code)-5), short_name= gsub('IFRC RESEARCH ','',name))]
            My_Data [, excess := 0]
          },
          'WHERE_TO_INVEST' = {
            My_Data [, ':=' (cur = as.character(NA) , version = as.character(NA),
                             wgtg = as.character(NA), short_name= gsub('IFRC/BEQ HOLDINGS ','',name), excess = 0)]
            My_Data[is.na(last), last := close]
            My_Data[is.na(change), change := (close-shift(close)), by='code']
            My_Data[is.na(varpc), varpc:=100*rt, by='code']
          },
          'CCPI_VIETNAM_INDEXES' = {
            # ifrc_ccpr_indvn_history.rds
            My_Data [, ':=' (cur = substr(code, nchar(code)-2, nchar(code)), version = substr(code, nchar(code)-4, nchar(code)-3),
                             wgtg = substr(code, nchar(code)-6, nchar(code)-5), short_name= gsub('IFRC/BEQ HOLDINGS ','',name))]
            My_Data [grepl('TOP ', name), category:='TRADABLE']
            My_Data [!grepl('TOP ', name), category:='BENCHMARK']
            My_Data [category == 'BENCHMARK', excess := 0]
          },
          'CCPI_INTERNATIONAL_INDEXES' = {
            My_Data [, ':=' (cur = substr(code, nchar(code)-2, nchar(code)), version = substr(code, nchar(code)-4, nchar(code)-3),
                             wgtg = substr(code, nchar(code)-6, nchar(code)-5), short_name= gsub('IFRC/BEQ HOLDINGS ','',name))]
            My_Data [, excess := 0]
          },
          'CCPI_VIETNAM_STOCKS' = {
            # icb      = readRDS("S:/CCPR/DATA/STKVN_ICB_ALL.rds")
            DBL_RELOAD_INSREF ()
            # open_day = merge(My_Data, icb[,.(code, sector = icb1_name,  industry = icb2_name, name)], all.x= T, by = 'code')
            # my_day   = open_day [date == max(open_day[date <= DateLimit]$date)] ; my_day
            # icb      = merge(icb, my_day[,.(code, capivnd)], all.x = T, by = 'code')
            my_ref = ins_ref[type == 'STK' & iso2 == 'VN'][,. (code,industry = toupper(gics_ind_name), sector = toupper(gics_sector_name),
                                                               sub_ind = gics_sub_name, icb4 = gics_group_name)]
            my_indvn = My_Data
            my_data  = merge(my_indvn[, -c('sector','industry','sub_ind','icb4')], my_ref[,.(code,sector , industry , 
                                                                                             sub_ind = toupper(sub_ind), icb4 = toupper(icb4))], all.x = T, by = 'code')
            # my_xdata = merge(my_data, market, all.x = T, by = 'code')
            # my_xdata [is.na(market)]
            my_data [!grepl('VNI',name) & is.na(market), market:= 'OTC']
            # saveRDS (my_xdata, 'R:/CCPR/DATA/DASHBOARD/ccpr_stkvn_all_performance.rds')
            
            my_short_list = my_data [is.na(market) | market %in% c('HSX','HNX')] # [is.na(industry)]
            my_short_list = my_short_list [order(-capibvnd)]
            nacapi = my_short_list [is.na(capibvnd)] $code
            # pcapi  = unique(open_day [code %in% nacapi] [order(-date)] , by = 'code')
            # my_short_list  [order(name)] [is.na(last_capibvnd) & !grepl('VNI',name) ] $last_capibvnd = pcapi$last_capibvnd
            
            MaxDate = max(my_short_list$date)
            STKVN_CLEANED = copy(my_short_list[!is.na(capibvnd) & date==MaxDate])
            STKVN_CLEANED[, sum_capi:=sum(capibvnd), by='date']
            STKVN_CLEANED[, cum_capi:=cumsum(capibvnd), by='date']
            STKVN_CLEANED[, pc_capi:=100*cum_capi/sum_capi, by='date']
            STKVN_CLEANED[pc_capi<=85, size:='LARGE']
            STKVN_CLEANED[pc_capi>85 & pc_capi<=95, size:='MID']
            STKVN_CLEANED[pc_capi>95, size:='SMALL']
            STKVN_CLEANED$pc_capi = NULL
            STKVN_CLEANED$cum_capi = NULL
            STKVN_CLEANED$sum_capi = NULL
            My.Kable(STKVN_CLEANED)
            STKVN_CLEANED[, updated:= SYS.TIME()]
            STKVN_CLEANED[, ticker:=gsub('STKVN', '', code)]
            STKVN_CLEANED[, short_name:=trimws(toupper(name))]
            str(STKVN_CLEANED)
            benchmark = CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ccpi_dashboard_wti.rds')
            benchmark[, excess:= 1]
            My_Data = rbind(STKVN_CLEANED, benchmark[code == 'INDVNINDEX'], fill =T)
            # My_Data [, ':=' (close = last_close, change = last_change)]
          },
          'WORLD_EQUITIES_INDEX' = {
            
            My_Data [, ':=' (cur = as.character(NA), version = as.character(NA),
                             wgtg = as.character(NA), short_name= gsub('IFRC/BEQ HOLDINGS ','',name))]
            My_Data [, excess := 0]
          },
          'CCPI_TRADABLE_INDEXES' = {
            My_Data [, ':=' (cur = as.character(NA), version = as.character(NA),
                             wgtg = as.character(NA), short_name= gsub('IFRC/BEQ HOLDINGS ','',name))]
            My_Data [, excess := 0]
          },
          'CCPI_CUSTOMISED_INDEXES' = {
            # ifrc_ccpr_indvn_history.rds
            My_Data [, ':=' (cur = substr(code, nchar(code)-2, nchar(code)), version = substr(code, nchar(code)-4, nchar(code)-3),
                             wgtg = substr(code, nchar(code)-6, nchar(code)-5), short_name= gsub('IFRC/BEQ HOLDINGS ','',name), organisation = NA, 
                             iso2 = 'VN', country = 'VIETNAM', continent = 'ASIA')]
          },
          'CCPI_INTERNATIONAL_STOCKS' = {
            my_indvn = My_Data
            if (! 'market' %in% names (my_indvn)) 
            {
              my_indvn [, market := sub(".*\\.", "", codesource)]
            }
            STKVN_CLEANED = my_indvn
            STKVN_CLEANED[, updated:= SYS.TIME()]
            STKVN_CLEANED[, ticker:=sub("\\..*", "", codesource)]
            STKVN_CLEANED[, short_name:=trimws(toupper(name))]
            # My_Data [, ':=' (close = last_close, change = last_change)]
          }
  )
  
  My_Data = UPDATE_UPDATED(My_Data)
  # if (all (c ( 'last_change', 'last_varpc' ,'last_close' )%in% names (My_Data) )) { 
  #   My_Data [,':=' ( change = last_change, varpc = last_varpc, last = last_close)]
  #   }
  if (ToAddBenchmark)  {
    
    if (length (REF_LIST) > 0 ) {
      Data_Add = CCPR_READRDS( 'S:/CCPR/DATA/DASHBOARD_LIVE/',  'ccpi_dashboard_wti.rds', ToRestore = T) [ code %in% REF_LIST] ; Data_Add
    } else { 
      Data_Add = CCPR_READRDS( 'S:/CCPR/DATA/DASHBOARD_LIVE/',  'ccpi_dashboard_wti.rds', ToRestore = T)  ; Data_Add }
    
    
    Data_Add [, excess := 1]
    
    My_Data =  rbind (Data_Add, My_Data, fill = T)
    My.Kable.Min(My_Data)
    
  }
  
  # My_Data
  # LIST_NAME =  CCPR_LOAD_SQL_HOST (lhost = 'dashboard_live', pTableSQL = 'dbl_ind_mother', ToDisconnect=T, ToKable=T)
  # 
  # if ( 'name' %in% names (My_Data))  {
  #   na.name   = My_Data [is.na(name)] [order (code)] $code 
  #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
  #   {My_Data [is.na(name)] [order (code)] $name = LIST_NAME [code %in% na.name] [order (code)] $name }
  # }
  # 
  # if ( 'short_name' %in% names (My_Data))  {
  #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
  #   {My_Data [is.na(short_name)] [order (code)] $short_name = LIST_NAME [code %in% na.name] [order (code)] $short_name}
  #   
  # }
  # na.name   = My_Data [is.na(name)] [order (code)] $code 
  # My_Data [is.na(name)] [order (code)] $name = LIST_NAME [code %in% na.name] [order (code)] $name
  # My_Data [is.na(short_name)] [order (code)] $short_name = LIST_NAME [code %in% na.name] [order (code)] $short_name
  if (ToSave) {  
    DATA_OLD = CHECK_CLASS (try (CCPR_READRDS (To_Folder,  To_File)))
    MY_DATA = unique( rbind (DATA_OLD, My_Data, fill = T), fromLast = T, by = 'code')
    if ('symbol' %in% names (MY_DATA)) { MY_DATA = unique (MY_DATA, by = 'symbol')}
    CCPR_SAVERDS(MY_DATA [!is.na(close)],To_Folder, To_File, ToSummary = T, SaveOneDrive = T) 
    # try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= paste0('TRAINEE_DASHBOARD_CALCULATE_STATS_BLOCK >', pOption ) , pAction="SAVE", NbSeconds=3600, ToPrint=F))
  }
  if (ToUpload) {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', To_File)),
                                     l.filepath= tolower(paste0(To_Folder,  To_File)),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    #   try (UPLOAD_RDS_TO_SQL (Connexion = pHost,  host = '', user = "", password = "", 
    #                      SQL_str = "", 
    #                      SQL_file = '', 
    #                      pSleep = 1,
    #                      ToReplace = F, PARAM_REPLACE = list( ) ,
    #                      RDS_folder = To_Folder, RDS_file = To_File, SQL_table = tolower(gsub('.rds','', To_File))) )
  }
  end = Sys.time()
  print (difftime(end, start, unit = 'secs') )
  return (My_Data)
}

# ==================================================================================================
TRAINEE_DASHBOARD_LIVE_CRYPTO = function ( Data = data.table(), Folder = 'S:/CCPR/DATA/DASHBOARD/',
                                           File   = 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', EndDate  = '2024-04-30' , 
                                           ToSave = F, ToFolder = 'S:/CCPR/DATA/DASHBOARD/' , ToFile = 'ccpi_dashboard_crypto.rds' ,
                                           ToUpload = F , pHost = 'dashboard_live')  {
  # ------------------------------------------------------------------------------------------------
  
  My_Data = TRAINEE_CALCULATE_FILE_PERFORMANCE  (pData = Data, pFolder = Folder,
                                                 pFile   = File, EndDate  = EndDate ) 
  My_Data [, ':=' ( version = as.character (NA),
                    wgtg = as.character (NA), short_name= gsub('IFRC/BEQ HOLDINGS ','',name) , 
                    updated = SYS.TIME())]
  if ( !'cur' %in% names (My_Data)) { My_Data [, cur := as.character ('USD')]}
  My_Data [, excess := 0]
  
  
  if (ToSave)  {
    CCPR_SAVERDS (My_Data, ToFolder , ToFile)
  }
  
  if (ToUpload)  {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost , l.tablename= tolower(gsub('.rds','', ToFile)),
                                     l.filepath= tolower(paste0(ToFolder ,  ToFile)),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
  
  try( TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_DASHBOARD_LIVE_CRYPTO', pAction="COMPARE", NbSeconds=3600, ToPrint=F))
}


# ==================================================================================================
TRAINEE_STOP_BATCH = function(batch_name) {
  # ------------------------------------------------------------------------------------------------
  tasks = system("tasklist /fo csv /v", intern = TRUE)
  
  tasks_df = read.csv(text = tasks, stringsAsFactors = FALSE)
  
  target_pid = tasks_df$PID[tasks_df$Image.Name == "cmd.exe" & grepl(batch_name, tasks_df$Window.Title, ignore.case = TRUE)]
  
  print(target_pid)
  
  if (length(target_pid) > 0) {
    sapply(target_pid, function(pid) {
      system(paste("taskkill /F /PID", pid), intern = FALSE)
      cat(sprintf("Tiến trình %d đã được dừng.\n", pid))
    })
  } else {
    cat("Không tìm thấy tiến trình phù hợp.\n")
  }
  
  Sys.sleep(5)
  tasks = system("tasklist /fo csv /v", intern = TRUE)
  print(batch_name)
  tasks_df = read.csv(text = tasks, stringsAsFactors = FALSE)
  target_pid = tasks_df$PID[tasks_df$Image.Name == "Rterm.exe" & grepl(batch_name, tasks_df$Window.Title, ignore.case = TRUE)]
  
  
  if (length(target_pid) > 0) {
    sapply(target_pid, function(pid) {
      system(paste("taskkill /F /PID", pid), intern = FALSE)
      cat(sprintf("Tiến trình %d đã được dừng.\n", pid))
    })
  } else {
    cat("Không tìm thấy tiến trình phù hợp.\n")
  }
}

# ==================================================================================================
IFRC_SLEEP = function(NbSeconds) {
  # ------------------------------------------------------------------------------------------------
  # IFRC_SLEEP(NbSeconds=20)
  # time1 = Sys.time()
  for (i in NbSeconds:1)
  {
    # i=2; NbSeconds = 10
    CATrp(paste("TIMER = ", FormatNS(i,0,10), FormatNS(NbSeconds,0,10)))
    Sys.sleep(1)
  }
  # CATln(Sys.time()-time1)
  CATrp("")
}


# ==================================================================================================
EXTRACT_LAST_UPDATE = function(pSection = 'STKVN', pTab = 'OPEN', ToPrompt = F) {
  # ------------------------------------------------------------------------------------------------
  CATln_Border(paste('EXTRACT_LAST_UPDATE :', pSection, pTab))
  Select_Data = data.table()
  data <- setDT(read_excel("S:/SHINY/REPORTS/SHINY_REPORT_MANAGEMENT.xlsx"))
  data = data[tolower(FILE_TYPE) == "rds"]
  data$checkdate = as.character(NA)
  dataid = data[, id:=seq.int(1, .N)]
  if (ToPrompt) { My.Kable.All(dataid[,. (id, page, Tab_label, FILE_NAME, FILE_TYPE, checkdate)]) }
  
  
  Select_Data = dataid[page==pSection & Tab_label==pTab][FILE_TYPE=='rds']
  if (nrow(Select_Data)>0)
  {
    Select_Data$last_updated = as.character(NA)
    Select_Data$last_date    = as.Date(NA)
    if (ToPrompt) {My.Kable.All(Select_Data[,. (id, page, Tab_label, FILE_NAME, FILE_TYPE, checkdate)][order(id)][FILE_TYPE=='rds']) }
    
    # k = 1
    for (k in 1:nrow(Select_Data))
    {
      file_name = paste0("S:/SHINY/", Select_Data[k]$page, "/", Select_Data[k]$Tab_label, "/", Select_Data[k]$FILE_NAME, ".", Select_Data[k]$FILE_TYPE)
      if (ToPrompt) { CATln(''); CATln(paste(k, file_name)) }
      pData     = CHECK_CLASS(try(readRDS(file_name)))
      if (nrow(pData)>0)
      {
        if ('updated' %in% names(pData)) 
        { 
          LastUpdated = as.character(max(pData$updated))
        } else {
          LastUpdated = as.character(max(pData$date))
        }
        
        if ('date' %in% names(pData)) 
        { 
          LastDate = as.Date(max(pData$date))
        } else {
          # LastDate = as.Date(max(pData$date))
        }
        Select_Data[k]$last_date=LastDate
        Select_Data[k]$last_updated=LastUpdated
      }
    }
    
    My.Kable.All(Select_Data[,. (id, page, Tab_label, FILE_NAME, FILE_TYPE, checkdate, last_date, last_updated)])
  }
  return(Select_Data)
}

# ==================================================================================================
TRAINEE_CALCULATE_FILE_PERFORMANCE = function (pData = data.table(), pFolder = 'S:/CCPR/DATA/DASHBOARD/',
                                               pFile   = 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', EndDate  = '2024-05-06', 
                                               ToAddRef = T, Remove_MAXABSRT = T )  {
  # ------------------------------------------------------------------------------------------------
  #updated: 2024-06-04 18:55
  
  if (nrow(pData ) > 1 ) 
  { 
    x = pData
    if ( !'close_adj' %in% colnames(pData) ) { x [, close_adj := close]}
    x [is.na(close_adj), close_adj := close]
    if ( !'code' %in% colnames(pData) ) { x [, code := codesource]}
  } else {
    if (pFile == 'ifrc_ccpr_investment_history.rds') {
      investment = CCPR_READRDS(pFolder, pFile) [order (-date)]
      ipo = CCPR_READRDS ('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ETFIPO.rds')
      investment = rbind (investment, ipo, fill=  T)
      investment [, rt:=((close/shift(close))-1), by='code']
      investment [, ':=' (cur = NA, close_adj = close)]
      x = investment
    } else { 
      x = CCPR_READRDS(pFolder, pFile)
      My.Kable(x[order(date)])
      if ( !'close_adj' %in% colnames(x) ) { x [, close_adj := close]}
      if ( !'code' %in% colnames(x) ) { x [, code := codesource]}
    }
  }
  
  # STEP 1: READ FILE PRICES HISTORY
  My.Kable(x)
  colnames(x)
  # cleanse raw data
  x = unique(x, by = c('code', 'date'))
  x = x [!is.na(close_adj)]
  
  if ( nrow(x [substr(code,1,3) == 'STK']) == nrow (x)) { pType = 'STK' } else { 
    if ( nrow(x [substr(code,1,3) == 'STK']) == 0) {pType = 'OTHER'} else {pType = ''}
  }
  if (Remove_MAXABSRT) { 
    source(paste0(SDLibrary, "TRAINEE_INTRO.R"),    echo=F)
    
    print (paste(pType,STK_MAXABSRT,IND_MAXABSRT) )
    switch (pType,
            'STK' = { 
              ToExclude = unique (x [abs(rt) > STK_MAXABSRT ]$code)
              if (length (ToExclude) >0) { x = x [!code %in% ToExclude]}
            },
            'OTHER' = {
              ToExclude = unique (x [abs(rt) > IND_MAXABSRT & !grepl('VIX',code)]$code)
              if (length (ToExclude) >0) { x = x [!code %in% ToExclude ]}
            },
            {
              ToExclude = unique (x [abs(rt) > 1 & !grepl('VIX',code)]$code)
              if (length (ToExclude) >0) { x = x [!code %in% ToExclude ]}
            })
  } 
  # rm(pType)
  
  
  # if (grepl ('STK',pFile)) { x [rt < STK_MAXABSRT]} else { x [rt <= IND_MAXABSRT]}
  
  # STEP 2: RE-CALCULATE DATA
  # Limit data maxdate
  exclude = try (setDT (fread ('S:/CCPR/DATA/DASHBOARD_LIVE/dbl_list_ind_to_exclude.txt') ) )
  if (all(class(exclude)!='try-error')) {
    Ind_History = x  [date <= EndDate] [! code %in% exclude [active == 1]$code] 
  }
  
  My.Kable(Ind_History[, .(code, date, close)][order(date)])
  str(Ind_History)
  
  #Calculate necessary column: change, varpc, yyyy, yyyymm, yyyyqn
  # Ind_History = Ind_History[order(code, date)] 
  Ind_History = CALCULATE_CHANGE_RT_VARPC(Ind_History)
  if (all (! c('change', 'varpc') %in% names (Ind_History))) {
    Ind_History[, ':='(change=close_adj-shift(close_adj), varpc=100*(close_adj/shift(close_adj)-1)), by='code']
  }
  
  # if (pType != 'STK'){
  #   Ind_History = CHECK_LAST_CHANGE_ZERO(Ind_History)
  # }
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  
  #Calculate rtm
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_adj/shift(close_adj))-1, by='code']
  
  My.Kable(Ind_History[, .(code, date, close, yyyy, yyyymm, yyyyqn)])
  #Calculate rtq
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_adj/shift(close_adj))-1, by='code']
  
  #Calculate rty
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_adj/shift(close_adj))-1, by='code']
  
  #Merge data: month, quarter, year
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code')) #[, .(code, name, date, last=close_adj, last_change, last_varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  My.Kable.All(Ind_Overview[,.(code, date, close, yyyy, yyyymm, yyyyqn, mtd, qtd, ytd)])
  
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  My.Kable(Ind_All)
  
  # my_add   =  ins_ref [ code %in% Ind_All$code]
  # Ind_Data = merge (Ind_All, my_add [,.(code,  iso2, country, continent)], all.x = T, by = 'code')
  if (ToAddRef) {
    Ind_Data = TRAINEE_MERGE_COL_FROM_REF (pData = Ind_All, 
                                           List_Fields = c('name','cur','wgtg','prtr', 'category', 'size'))
  } else { Ind_Data = Ind_All}
  
  # if (!'name' %in% names (Ind_All)) {
  #   Ind_Data = merge (Ind_All, my_add [,.(code, name)], all.x = T, by = 'code')  
  # } else { Ind_Data = Ind_All}
  
  if (!'last' %in% names (Ind_Data)) {
    Ind_Data [, last:= close]
  }
  Ind_Data [, updated := SYS.TIME()]
  
  return(Ind_Data)
}

# ==================================================================================================
TRAINEE_CALCULATE_FILE_PERFORMANCE_20240604 = function (pData = data.table(), pFolder = 'S:/CCPR/DATA/DASHBOARD/',
                                                        pFile   = 'CCPI_DASHBOARD_INDIFRCCURCRY_HISTORY.rds', EndDate  = '2024-05-06' )  {
  # ------------------------------------------------------------------------------------------------
  #updated: 2024-06-01 11:03
  
  if (nrow(pData ) > 1 ) 
  { 
    x = pData
    if ( !'close_adj' %in% colnames(pData) ) { x [, close_adj := close]}
    if ( !'code' %in% colnames(pData) ) { x [, code := codesource]}
  } else {
    if (pFile == 'ifrc_ccpr_investment_history.rds') {
      investment = CCPR_READRDS(pFolder, pFile) [order (-date)]
      investment [, rt:=((close/shift(close))-1)*100, by='code']
      investment [, ':=' (cur = NA, close_adj = close)]
      x = investment
    } else { 
      x = CCPR_READRDS(pFolder, pFile)
      My.Kable(x[order(date)])
      if ( !'close_adj' %in% colnames(x) ) { x [, close_adj := close]}
      if ( !'code' %in% colnames(x) ) { x [, code := codesource]}
    }
  }
  
  # STEP 1: READ FILE PRICES HISTORY
  My.Kable(x)
  colnames(x)
  # cleanse raw data
  x = unique(x, by = c('code', 'date'))
  
  # STEP 2: RE-CALCULATE DATA
  # Limit data maxdate
  Ind_History = x  [date <= EndDate]  
  My.Kable(Ind_History[, .(code, date, close)][order(date)])
  str(Ind_History)
  
  #Calculate necessary column: change, varpc, yyyy, yyyymm, yyyyqn
  Ind_History = Ind_History[order(code, date)] 
  if (all (! c('change', 'varpc') %in% names (Ind_History))) {
    Ind_History[, ':='(change=close_adj-shift(close_adj), varpc=100*(close_adj/shift(close_adj)-1)), by='code']
  }
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  
  #Calculate rtm
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_adj/shift(close_adj))-1, by='code']
  
  #Calculate rtq
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_adj/shift(close_adj))-1, by='code']
  
  #Calculate rty
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_adj/shift(close_adj))-1, by='code']
  
  #Merge data: month, quarter, year
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code')) #[, .(code, name, date, last=close_adj, last_change, last_varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  My.Kable(Ind_Overview)
  
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  My.Kable(Ind_All)
  
  my_add  =  ins_ref [ code %in% Ind_All$code]
  if (!'name' %in% names (Ind_All)) {
    Ind_Data = merge (Ind_All, my_add [,.(code, name, iso2, country, continent)], all.x = T, by = 'code')  
  } else { Ind_Data = Ind_All}
  
  if (!'last' %in% names (Ind_Data)) {
    Ind_Data [, last:= close]
  }
  Ind_Data [, updated := substr ( as.character( Sys.time()),1,16)]
  
  return (Ind_Data)
}

# ==================================================================================================
TRAINEE_SAVERDS = function(pData=My_Data, FileFolder=SData, FileName='download_ssi_stkvn_ref_history.rds' , 
                           SaveOneDrive=T, ToKable=F, ToSummary=F, ToPrompt=T, ToFST = F,
                           FSTFolder = '')
{
  # ------------------------------------------------------------------------------------------------
  # ODDrive = 'D:/OneDrive/'
  CATln('CCPR_SAVERDS in CCPR')
  if (ToKable) { My.Kable.Min(pData) }
  ODDrive_Data = paste0(ODDrive, substr(FileFolder,1,1), word(FileFolder,2,2,":"))
  if (!file.exists(ODDrive_Data))
  {
    try(dir.create(ODDrive_Data, recursive=T))
  }
  FullPath_Local   = paste0(FileFolder, FileName)
  FullPath_ODDrive = paste0(ODDrive_Data, FileName)
  if (ToPrompt) { CATln_Border(paste('SAVE LOCAL = ', FullPath_Local, '-', substr(Sys.time(),1,19))) }
  if (ToPrompt) { CATrp('Saving ...') }
  saveRDS(pData, tolower(FullPath_Local))
  # x = readRDS(tolower(FullPath_Local)); My.Kable.Min(x)
  if (ToSummary) { try(CCPR_WRITE_SUMMARY_CURRENT(pData=pData, pFileName=FullPath_Local, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
  if (ToPrompt) { CATln('Done.') }
  
  if (SaveOneDrive)
  {
    if (ToPrompt) { CATln_Border(paste('SAVE ONEDRIVE = ', FullPath_ODDrive, '-', substr(Sys.time(),1,19))) }
    if (ToPrompt) { CATrp('Saving ...') }
    saveRDS(pData, FullPath_ODDrive)
    if (ToSummary) { try(CCPR_WRITE_SUMMARY_CURRENT(pData=pData, pFileName=FullPath_ODDrive, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
    if (ToPrompt) { CATln('Done.') }
  }
  if (ToFST) {
    
    if (file.exists(FSTFolder)) 
    {
      FilePath = gsub(".rds", ".fst", paste0(FSTFolder,FileName ) , ignore.case = T) 
      fst_file <- fst::write_fst(data,FilePath )
      
    }
  }
}

# ==============================================================================
CHECK_TIMEBETWEEN = function(pTimeInf="00:30", pTimeSup="23:30")
{
  # ----------------------------------------------------------------------------
  CurrentTime = substr(as.character(Sys.time()), 12,16)
  if (CurrentTime>=pTimeInf & CurrentTime<=pTimeSup) {TimeBetweenRes=T} else { TimeBetweenRes=F}
  return(TimeBetweenRes)
}

# ==================================================================================================
OLD_TRAINEE_REPORT_OPEN_FINAL = function (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                          LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'STB', 'DCL'),
                                          LIST_DATASET = list('reference_open', 'market', 'sharesout'),
                                          Pre_Date = '') {
  # ------------------------------------------------------------------------------------------------
  
  # File_Folder = 'S:/STKVN/PRICES/DAY/'
  # LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL')
  # LIST_DATASET = list('reference', 'market', 'sharesout')
  
  DBL_RELOAD_INSREF()
  CURRENT_TIME = substr(Sys.time(), 12,13)
  if (nchar(Pre_Date) != 0) 
  {
    LastTrading = Pre_Date
  }else{
    LastTrading     = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  }
  LIST_PRICES_BOARD = list()
  LIST_SHARES       = list()
  Final_Data        = data.table()
  
  
  for (k in 1:length(LIST_SOURCES))
  {
    # k = 5
    pSource = LIST_SOURCES[[k]]
    # PRICESBOARD FILES 
    # ------------------------------------------------------------------------------------------------
    File_Name_Day    = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_DAY.rds')
    CATln_Border(paste('DAY  = ', File_Name_Day))
    Data_Day         = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Day, ToKable = T, ToRestore = T)))
    
    File_Name_Date   = paste0('DOWNLOAD_', pSource, ifelse(STKVN,'_STKVN',''), '_', Prefix, '_', gsub('-','', LastTrading), '.rds')
    CATln_Border(paste('DATE = ', File_Name_Date))
    Data_Date        = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Date, ToKable = T, ToRestore = T)))
    
    Data_All_Pricesboard = rbind(Data_Day, Data_Date, fill=T)
    
    if (nrow(Data_All_Pricesboard)>0) 
    {
      Data_All_Pricesboard = Data_All_Pricesboard[date==LastTrading]
      Data_All_Pricesboard[market == 'UPCOM', market := 'UPC']
      Data_All_Pricesboard[market == 'HOSE', market := 'HSX']
      Data_All_Pricesboard = unique(Data_All_Pricesboard, by=c('code', 'date'))
      Data_All_Pricesboard = merge(Data_All_Pricesboard[, -c('name')], ins_ref[, .(code, name=short_name)], all.x=T, by='code')
      LIST_PRICES_BOARD[[k]] = Data_All_Pricesboard
    }
    
    # # STKVN SHARES FILES 
    # ------------------------------------------------------------------------------------------------
    File_Name_Day    = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES_DAY.rds')
    CATln_Border(paste('DAY  = ', File_Name_Day))
    Data_Day         = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Day, ToKable = T, ToRestore = T)))
    
    File_Name_Date   = paste0('DOWNLOAD_', pSource, '_STKVN_SHARES_', gsub('-','', LastTrading), '.rds')
    CATln_Border(paste('DATE = ', File_Name_Date))
    Data_Date        = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name_Date, ToKable = T, ToRestore = T)))
    
    Data_All_Shares = rbind(Data_Day, Data_Date, fill=T)
    
    if (nrow(Data_All_Shares)>0)
    {
      Data_All_Shares  = Data_All_Shares[date==LastTrading]
      Data_All_Shares = unique(Data_All_Shares, by=c('code', 'market'))
      LIST_SHARES[[k]] = Data_All_Shares
    }
    
  }
  
  DATA_ALL_PRICESBOARD = rbindlist(LIST_PRICES_BOARD, fill = T)
  DATA_ALL_SHARES_DAY = rbindlist(LIST_SHARES, fill = T)
  
  LIST_CODE_BY_EXC = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', paste0('list_code_by_exc_', gsub('-', '', LastTrading), '.rds'))))
  
  if (nrow(LIST_CODE_BY_EXC) == 0 )
  {
    Prev_date = CCPR_LAST_TRADING_DAY_VN(pHH = 9, ToPrompt = F, Option = 'Prev_date')
    LIST_CODE_BY_EXC = CHECK_CLASS(try(CCPR_READRDS(File_Folder, paste0('list_code_by_exc_', gsub('-', '', Prev_date), '.rds'))))
  }
  
  DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('market')], LIST_CODE_BY_EXC[,. (code, market)], all.x = T, by = 'code')
  DATA_ALL_SHARES_DAY = unique(DATA_ALL_SHARES_DAY[date == LastTrading], by = c("source", "code"))
  DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[!is.na(sharesout)]
  DATA_ALL_SHARES_DAY[source %in% c("HNX", "HSX", "UPC"), source := "EXC"]
  
  DATA_ALL = merge(DATA_ALL_PRICESBOARD, DATA_ALL_SHARES_DAY[,. (date, source, ticker = codesource, shareslis, sharesout)], by = c('source', 'date', 'ticker'), all.x = T)
  unique(DATA_ALL$source)
  
  DATA_ALL_PRICESBOARD = unique(DATA_ALL[order(source, code, -updated)], by = c('source', 'code'))
  DATA_ALL_DAY_EXC = DATA_ALL_PRICESBOARD[source == "EXC"]
  
  #list_dataset = list('reference', 'market')
  x = list()
  for (dataset in LIST_DATASET) 
  {
    # dataset = 'reference'
    # dataset = 'market'
    # dataset = 'sharesout'
    
    if(dataset != 'market'){
      fields_source  = union(c('code', 'date', 'market', 'source'), dataset) 
    }else{
      fields_source  = union(c('code', 'date', 'source'), dataset) 
    }
    
    
    DATA_ALL_DATASET_SOURCE = DATA_ALL[, ..fields_source]
    
    num_columns = ncol(DATA_ALL_DATASET_SOURCE)
    DATA_ALL_DATASET_SOURCE$market = paste0(dataset, "_", DATA_ALL_DATASET_SOURCE$market)
    if (dataset == 'sharesout') {  DATA_ALL_DATASET_SOURCE = DATA_ALL_DATASET_SOURCE[!is.na(sharesout)] }
    
    DATA_ALL_DATASET_SOURCE = DATA_ALL_DATASET_SOURCE[,. (date, source, market)]
    DATA_ALL_DATASET_SOURCE[, updated := substr(Sys.time(), 1,19)]
    
    names(DATA_ALL_DATASET_SOURCE) = c("date", "source", "value", "updated")
    
    x[[dataset]] = DATA_ALL_DATASET_SOURCE
    
  }
  
  DATA = rbindlist(x, fill = T)
  DATA[, LastTrading := LastTrading]
  DATA_ALL_DATE = unique(DATA[order(source, value, -date)], by = c('source', 'value'))
  DATA_ALL_DATE [, n := as.character(date - LastTrading)]
  DATA_ALL_DATE [n == 0, n := substr(updated, 12, 16)]
  
  report_open_date = setDT(spread(DATA_ALL_DATE[, .(n), by = .(source, value, date)], key = 'source', value = 'n'))[, ':='( updated = substr(Sys.time(),1,19) )]
  
  report_open = setDT(spread(DATA[,.(n=.N), by=c('date','source', 'value')], key='source', value='n'))[, updated := substr(Sys.time(), 1, 19)]
  report_open = unique(report_open[order(-date)], by = "value")
  My.Kable.All(report_open)
  My.Kable.All(report_open_date)
  
  CCPR_SAVERDS(report_open,'S:/SHINY/STKVN/OPEN/', 'report_open_day_number.rds')
  CCPR_SAVERDS(report_open_date,'S:/SHINY/STKVN/OPEN/', 'report_open_day_date.rds')
  try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
  x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_REPORT_OPEN_FINAL'), pAction="SAVE", NbSeconds=0, ToPrint = T))
}


#===================================================================================================
TRAINEE_DOWNLOAD_HNX_STKVN_SHARES_BY_CODE = function(pCode='AAV')  {
  # ------------------------------------------------------------------------------------------------
  GC_SILENT()
  LastTradingVN = CCPR_LAST_TRADING_DAY_VN(9, ToPrompt = T)
  pURL = paste0('https://hnx.vn/cophieu-etfs/chi-tiet-chung-khoan-ny-', pCode, '.html?_des_tab=1')
  CATln_Border(pURL)
  # content    = try(rvest::read_html(pURL))
  # # Sys.sleep(1)
  # tables     = content %>% html_table(fill = TRUE)
  
  File_Temp  = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '', Sys.time())), '.txt')
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
  # content    = try(rvest::read_html(xweb))
  # xTemp      = readr::read_file(paste0('c:/temp/', File_Temp))
  xROWS      = unlist(strsplit(xweb, '<div class="dktimkiem_row row_inline">'))
  xData      = as.data.table(xROWS)
  
  x1Data     = xData[grepl('KLLH', xROWS)]
  if (nrow(x1Data)==1)
  {
    sharesout = gsub('\n','', gsub('"','', x1Data$xROWS))
    sharesout = trimws(gsub('[.]', '', trimws(str.extract(sharesout, '<div class=dktimkiem_cell_content>', '</div>'))))
  } else { sharesout = as.numeric(NA) }
  Final_Data = data.table(source='HNX', code=paste0('STKVN', pCode), codesource=pCode, market='HNX',
                          date=as.Date(LastTradingVN), sharesout=sharesout, updated=as.character(Sys.Date()))
  Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption='FINAL')
  My.Kable.All(Final_Data)
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_HSX_STKVN_SHARES_BY_PAGE = function(pFolder='S:/STKVN/PRICES/DAY/', ToIntegrateHistory=T) {
  # ------------------------------------------------------------------------------------------------
  # x = IFRC_DOWNLOAD_HSX_STKVN_REF(pFolder=CCPRData, ToIntegrateHistory=T)
  
  # install.package("vietnameseConverter")
  # library(vietnameseConverter)
  # x_ref = DOWNLOAD_HSX_STKVN_REF()
  # SaveFolder="U:/EFRC/DATA/STKVN/DAY/REF/"
  #  SaveFolder="U:/EFRC/DATA/STKVN/DAY/REF/"; ToIntegrateHistory=F
  # IFRC_RELEASE_MEMORY("",F)
  # time_start = Sys.time(); function_name=match.call()[[1]]
  # MHM_FUNCTION_HEADER(p.cat=T, p.option="START", function_name) 
  # LOAD_INSREF_INDREF(l_option="DAY")
  # ................................................................................................
  nr_page   = 0
  ToContinu = T
  data_group = data.table()
  
  while (ToContinu)
  {
    nr_page = nr_page+1
    # nr_page = 5
    DATACENTER_LINE_BORDER(nr_page)
    LcURL = paste0("https://www.hsx.vn/Modules/Listed/Web/SymbolList?pageFieldName1=Code&pageFieldValue1=&pageFieldOperator1=eq&pageFieldName2=Sectors&pageFieldValue2=&pageFieldOperator2=&pageFieldName3=Sector&pageFieldValue3=00000000-0000-0000-0000-000000000000&pageFieldOperator3=&pageFieldName4=StartWith&pageFieldValue4=&pageFieldOperator4=&pageCriteriaLength=4&_search=false&nd=1559705825560&rows=100&page=", nr_page, "&sidx=id&sord=desc")
    print(LcURL)
    rm(web.data)
    web.data = try(jsonlite::fromJSON(LcURL)$row)
    
    hsx.ref = setDT(web.data)
    if (nrow(hsx.ref)>0)
    {
      hsx.ref = hsx.ref[,2]
      # Convert list to table
      
      dt.out =data.table::rbindlist(list(hsx.ref$cell))
      dt.out = as.data.table(dt.out)
      
      str(dt.out)
      dt.out.tr = data.table::transpose(dt.out, fill=NA)
      str(dt.out.tr)
      
      
      # x = "41.000.000,00"
      #   gsub("\\,", "\\.", gsub("\\.","", x))
      # x = "25/12/2009"
      # as.Date(x, format="%d/%m/%Y")
      
      colnames(dt.out.tr) = c("cid", "ticker", "isin", "figi", "source_name_vn", "shlis", "shout", "ipo")
      dt.out.tr[, ":="(shlis=as.numeric(gsub("\\,", "\\.", gsub("\\.","", shlis))), 
                       shout=as.numeric(gsub("\\,", "\\.", gsub("\\.","", shout))))]
      dt.out.tr[, ":="(ipo=as.Date(ipo, format="%d/%m/%Y"))]
      My.Kable(dt.out.tr[, -c("source_name_vn")])
    } else { dt.out.tr = data.table()}
    # 
    # 
    # print(nr_page)
    # LcURL = paste0("https://www.hsx.vn/Modules/Listed/Web/SymbolList?pageFieldName1=Code&pageFieldValue1=&pageFieldOperator1=eq&pageFieldName2=Sectors&pageFieldValue2=&pageFieldOperator2=&pageFieldName3=Sector&pageFieldValue3=00000000-0000-0000-0000-000000000000&pageFieldOperator3=&pageFieldName4=StartWith&pageFieldValue4=&pageFieldOperator4=&pageCriteriaLength=4&_search=false&nd=1559705825560&rows=100&page=", nr_page, "&sidx=id&sord=desc")
    # x_temp = getURL(LcURL)
    # print(x_temp)
    # x_temp = jsonlite::fromJSON(LcURL)
    # typeof(x_temp)
    # x_list =as.data.table(x_temp$row[2])
    if (nrow(dt.out.tr)>0) {
      data_group = rbind(data_group, dt.out.tr)
    } else {ToContinu=F}
  }
  
  if (nrow(data_group)>0) 
  {
    data_group = unique(data_group,by=c("ticker"))[nchar(ticker)==3]
    data_group[, lastupdate:=Sys.Date()]
    data_group[, source_name:=vietnameseConverter::decodeVN(source_name_vn, from='Unicode', to='Unicode', diacritics=F)]
    # str(data_group)
    My.Kable(data_group[, -c('')])
    Last_Trading =  CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
    data_group[, ":="(market="HSX", source="HSX", codesource=ticker, code=paste0("STKVN", ticker), 
                      date=Last_Trading)]
    data_group[, ":="(shareslis=shlis, sharesout=shout)]
    My.Kable(data_group[, -c('name_vn', 'source', 'codesource', 'shlis', 'shout')])
    
    CCPR_SAVERDS(data_group, pFolder, "download_hsx_stkvn_shares_day.rds", ToSummary=T, SaveOneDrive = T)
    CCPR_SAVERDS(data_group, pFolder, paste0("download_hsx_stkvn_shares_",gsub('-','',Last_Trading),".rds"), ToSummary=T, SaveOneDrive = T)
    
    if (ToIntegrateHistory) 
    {
      Data_Old = CCPR_READRDS(pFolder, 'download_hsx_stkvn_shares_history.rds', ToKable = T, ToRestore = T)
      Data_Old = unique(rbind(Data_Old, data_group, fill=T), by=c('code', 'date'))
      Data_Old = MERGE_DATASTD_BYCODE(Data_Old, pOption = 'FINAL')[!is.na(shareslis) & !is.na(sharesout)]
      My.Kable(Data_Old[order(date, code)][, .(source, code, date, name, market, shareslis, sharesout)])
      CCPR_SAVERDS(Data_Old, pFolder, 'download_hsx_stkvn_shares_history.rds', ToSummary = T, SaveOneDrive = T)
    }
  }
  # ............................................................................
  return(data_group)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_SHARES_BY_CODE_old = function(pCode  = 'THM', URL = '', ToAdd = F)  {
  # ----------------------------------------------------------------------------
  # pCode  = 'AAH'; URL = 'https://s.cafef.vn/upcom/aah-cong-ty-co-phan-hop-nhat.chn':  ToAdd = T
  temp_dir = tempdir()
  Final_Data = data.table()
  DBL_RELOAD_INSREF()
  CAF_LINK = as.character(NA)
  
  if (nchar(URL) == 0)
  {
    CAF_LINKS = CCPR_READRDS(SData, 'download_caf_stkvn_list_links.rds', ToRestore = T)
    # CCPR_SAVERDS (CAF_LINKS, SData,'download_caf_stkvn_list_links.rds' )
    CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
    # CAF_LINKS = CAF_LINKS[ticker!='AAH']
    CAF_ONE   = CAF_LINKS[code==paste0('STKVN', pCode)]
    # CAF_LINK  = paste0('https://s.cafef.vn/', CAF_LINKS[ticker==pCode][, .(link)]$link)
    CAF_LINK = CAF_LINKS[ticker==pCode][, .(URL)]$URL
  } else {
    CAF_LINK  = URL
    
  }
  CATln_Border(CAF_LINK)
  
  if (!is.na(CAF_LINK))
  {
    # pURL = 'https://s.cafef.vn/hose/vic-tap-doan-vingroup-cong-ty-co-phan.chn'
    # pURL      = paste0('https://s.cafef.vn/', CAF_ONE[1]$link)
    pURL = CAF_LINK
    CATln_Border(pURL)
    
    # x    = WEB_SAVE_AS(pURL = pURL, SaveFolder = 'c:/python/downloads/')
    # grepl('KLCP đang niêm yết', x)
    # SharesLis = as.numeric(gsub(',','', trimws(word(trimws(gsub('\n','', str.extract(x, '<div class="l"><b>KLCP đang niêm yết:</b></div>', '</div>'))),2,2, '>'))))
    # SharesOut = as.numeric(gsub(',','', trimws(word(trimws(gsub('\n','', str.extract(x, '<div class="l"><b>KLCP đang lưu hành:</b></div>', '</div>'))),2,2, '>'))))
    LastTrading = CCPR_LAST_TRADING_DAY_VN(max(9, hour(Sys.time())), ToPrompt = T)
    
    CATln_Border(pURL)
    # content    = try(readr::read_file(pURL))
    File_Temp  = paste0('CAF_', gsub('-|[:]| ', '' ,substr(as.character(Sys.time()),1,19)),'.txt')
    content    = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
    x.SHARESLIS = trimws(gsub('\r\n', '', str.extract(content, '<div class="l"><b>KLCP đang niêm yết:</b></div>', '</div')))
    v.SHARESLIS = as.numeric(gsub(',','', trimws(word(x.SHARESLIS,2,2,">")))); CATln(v.SHARESLIS)
    x.SHARESOUT = trimws(gsub('\r\n', '', str.extract(content, '<div class="l"><b>KLCP đang lưu hành:</b></div>', '</div')))
    v.SHARESOUT = as.numeric(gsub(',','', trimws(word(x.SHARESOUT,2,2,">")))); CATln(v.SHARESOUT)
    Final_Data = data.table(sharesout=v.SHARESOUT, shareslis=v.SHARESLIS)
    
    SharesLis = v.SHARESLIS
    SharesOut = v.SHARESOUT
    
    Final_Data = data.table(codesource=pCode, source='CAF', code=paste0('STKVN', pCode), date=LastTrading, sharesout=SharesOut, shareslis=SharesLis)
    Final_Data = merge(Final_Data[, -c('name')], ins_ref[, .(code, name=short_name)], all.x=T, by='code')
    My.Kable.All(Final_Data)
    
    if (nrow(Final_Data)>0 & ToAdd)
    {
      CAF_LINKS = CCPR_READRDS(CCPRData, 'download_caf_stkvn_list_links.rds', ToRestore = T)
      CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
      
      s.Code   = paste0('STKVN', pCode)
      if (!s.Code %in% CAF_LINKS$code)
      {
        s.URL  = URL
        s.link = gsub('https://s.cafef.vn/', '', URL)
        s.exc  = word(s.link,1,1,'/')
        ADD_ONE = data.table(ticker=pCode, code=paste0('STKVN', pCode), link=s.link, URL=s.URL, updated=substr(as.character(Sys.time()),1,19))
        My.Kable.All(ADD_ONE)
        # str(CAF_LINKS)
        CAF_LINKS = rbind(CAF_LINKS, ADD_ONE, fill=T)
        CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
        My.Kable.TB(CAF_LINKS[,.(ticker, code, link, URL)])
        saveRDS(CAF_LINKS, paste0(CCPRData, 'download_caf_stkvn_list_links.rds'))
      }
    }
  }
  return(Final_Data)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_C68_STKVN_SHARES_BY_CODE = function(pCode = 'VND') {
  # ------------------------------------------------------------------------------------------------
  # pCode = 'YRC'
  Final_Data = data.table()
  pURL = paste0('https://www.cophieu68.vn/quote/profile.php?id=', tolower(pCode))
  CATln_Border(pURL)
  content    = try(rvest::read_html(pURL))
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    if (length(tables)>0)
    {
      xData      = as.data.table(tables[[1]])
      xData$field = decodeVN(xData$X1, from='Unicode', to='Unicode', diacritics=F)
      SharesOut  = as.numeric(gsub(',','', xData[field=='KL luu hanh']$X2))
      SharesLis  = as.numeric(gsub(',','', xData[field=='KL niem yet']$X2))
      LastTrading = CCPR_LAST_TRADING_DAY_VN(max(9, hour(Sys.time())), ToPrompt = T)
      # LastTrading = '2023-09-27'
      Final_Data = data.table(source='C68', codesource=pCode, ticker=pCode, date=LastTrading, code=paste0('STKVN', pCode),
                              sharesout=SharesOut, shareslis=SharesLis, updated=substr(as.character(Sys.time()),1,19)) 
      My.Kable.All(Final_Data)
    }
  }
  return(Final_Data)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_MARKET_CUSTOM = function (pOption = 'INDEXES', ToDownload = T, ToSave = F, ToUpload = F, pHost = '')  {
  # ------------------------------------------------------------------------------------------------
  # pOption = 'CRYPTO',ToDownload = F, ToSave = T, ToUpload = T, pHost = ''
  # x = TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CRYPTO',ToDownload = T, ToSave = T, ToUpload = F, pHost = '')  
  # x = TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CRYPTO',ToDownload = F, ToSave = T, ToUpload = T, pHost = 'dashboard_live') 
  LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(7, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  try (DBL_RELOAD_INSREF())
  switch (pOption, 
          'CRYPTO'     = {
            if (ToDownload) 
            {
              pURL = 'https://finance.yahoo.com/crypto/'
              Nr   = 0
              To_Continu = T
              xList = list()
              while (To_Continu)
              {
                Nr = Nr+1
                pURL = paste0('https://finance.yahoo.com/crypto/?count=100&offset=', (Nr-1)*100)
                CATln_Border(pURL)
                content    = try(rvest::read_html(pURL))
                if (all(class(content)!='try-error'))
                {
                  tables     = content %>% html_table(fill = TRUE)
                  xData      = as.data.table(tables[[1]])
                  xData      = CLEAN_COLNAMES(xData)
                  setnames(xData, gsub("[():]", "", names(xData)))
                  # My.Kable.TB(xData)
                  # if 
                  # str(xData)
                  # , source_name= toupper(name);  close=as.numeric(gsub(',','', priceintraday)), 
                  Final_Data = xData[, .(source='YAH', symbol = gsub( " .*$", "", symbol ),
                                         close=as.numeric(gsub(',','', str_extract(price, "[^+|^-]+"))),
                                         change=as.numeric(gsub(',','', change)), varpc=as.numeric(gsub('[%]','', changepercent_)),
                                         capiusd=as.numeric(gsub(',','', sub("[^0-9.]+$", "", marketcap ))), capi_unit=substr(marketcap,nchar(marketcap),nchar(marketcap)),
                                         volume=as.numeric(gsub(',','', sub("[^0-9.]+$", "", volumeincurrency24hr ))), 
                                         volume_unit=substr(volumeincurrency24hr,nchar(volumeincurrency24hr),nchar(volumeincurrency24hr)),
                                         supply=as.numeric(gsub(',','', sub("[^0-9.]+$", "", circulatingsupply            ))), 
                                         supply_unit=substr(circulatingsupply           ,nchar(circulatingsupply           ),nchar(circulatingsupply           ))
                  ) ]
                  Final_Data[capi_unit=='K', capiusd:=1000*capiusd]
                  Final_Data[capi_unit=='M', capiusd:=1000000*capiusd]
                  Final_Data[capi_unit=='B', capiusd:=1000000000*capiusd]
                  
                  Final_Data[volume_unit=='K', volume:=1000*volume]
                  Final_Data[volume_unit=='M', volume:=1000000*volume]
                  Final_Data[volume_unit=='B', volume:=1000000000*volume]
                  
                  Final_Data[supply_unit=='K', supply:=1000*supply]
                  Final_Data[supply_unit=='M', supply:=1000000*supply]
                  Final_Data[supply_unit=='B', supply:=1000000000*supply]
                  
                  Final_Data$capi_unit = NULL
                  Final_Data$volume_unit = NULL
                  Final_Data$supply_unit = NULL
                  Final_Data[, updated:=substr(as.character(Sys.time()),1,19)]
                  Final_Data[, timestamp:=substr(as.character(Sys.time()),1,19)]
                  Final_Data[, date:=as.Date(timestamp)]
                  My.Kable.TB(Final_Data)
                  
                  if (Nr==1)
                  { 
                    First_Code  = Final_Data[1]$symbol 
                    xList[[Nr]] = Final_Data
                  } else {
                    if (Final_Data[1]$symbol == First_Code) { To_Continu = F} else {     xList[[Nr]] = Final_Data }
                  }
                  
                }
                
              }
              xALL = rbindlist(xList, fill=T)
              xALL$capi_unit = NULL
              xALL[, codesource:=trimws(symbol)]
              xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xALL)
              xALL = MERGE_DATASTD_BYCODE(xALL, pOption = 'FINAL')
              xALL = unique(xALL, by=c('codesource', 'date'))
              My.Kable.Min(xALL[order(-capiusd)])
              My.Kable.Min(xALL[codesource=='BTC-USD'])
              
              
              
              if (ToSave && (nrow (xALL) >0) ) {  CCPR_SAVERDS(xALL[!is.na(name) & !is.na(close)], paste0(SData, 'DAY/CRYPTO/'), 'DOWNLOAD_YAH_CURCRY_INTRADAY_TODAY.rds', ToSummary=T, SaveOneDrive = T)}
            }
            
            if (ToUpload) {
              x = CHECK_CLASS (try(CCPR_READRDS (paste0(SData, 'DAY/CRYPTO/'),  'DOWNLOAD_YAH_CURCRY_INTRADAY_TODAY.rds', ToRestore = T, ToKable = T) ))
              if ( nrow (x) > 0 ) {
                try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_intraday_crypto.rds')),
                                                 l.filepath= tolower(paste0(paste0(SData, 'DAY/CRYPTO/'),  'DOWNLOAD_YAH_CURCRY_INTRADAY_TODAY.rds')),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))   
              }
            }
          },
          'CURRENCIES' = {
            if (ToDownload)
            {
              pURL = 'https://finance.yahoo.com/currencies/'
              Nr   = 0
              To_Continu = T
              xList = list()
              # First_Code
              while (To_Continu)
              {
                Nr = Nr+1
                pURL = paste0('https://finance.yahoo.com/currencies/?count=100&offset=', (Nr-1)*100)
                CATln_Border(pURL)
                x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp='c:/temp/yahoo_currencies.txt', 
                                                       pSleep=5, ToDeleteTemp=F)
                # x = readr::read_file('c:/temp/yahoo_page.txt')
                content    = try(rvest::read_html(x))
                
                if (all(class(content)!='try-error'))
                {
                  tables     = content %>% html_table(fill = TRUE)
                  xData      = as.data.table(tables[[1]])
                  xData      = CLEAN_COLNAMES(xData)
                  setnames(xData, gsub("[():]", "", names(xData)))
                  # My.Kable.TB(xData)
                  # if 
                  # str(xData)
                  Final_Data = xData[, .(source='YAH', symbol = gsub( " .*$", "", symbol ), source_name=toupper(str_extract(symbol, '\\S+$')),  close=as.numeric(gsub(',','', str_extract(price, "[^+|^-]+"))), 
                                         change=as.numeric(gsub(',','', change)), varpc=as.numeric(gsub('[%]','', changepercent_))
                  ) ]
                  Final_Data[, updated:=substr(as.character(Sys.time()),1,19)]
                  Final_Data[, timestamp:=substr(as.character(Sys.time()),1,19)]
                  Final_Data[, date:=as.Date(timestamp)]
                  My.Kable.TB(Final_Data)
                  
                  if (Nr==1)
                  { 
                    First_Code  = Final_Data[1]$symbol 
                    xList[[Nr]] = Final_Data
                  } else {
                    if (Final_Data[1]$symbol == First_Code) { To_Continu = F} else {     xList[[Nr]] = Final_Data }
                  }
                  
                }
                
              }
              xALL = rbindlist(xList, fill=T)
              xALL[, codesource:=trimws(symbol)]
              xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xALL)
              # xALL = MERGE_DATASTD_BYCODE(xALL, pOption = 'FINAL')
              xALL = unique(xALL, by=c('codesource', 'date'))
              xALL[, name:= toupper (source_name )]
              My.Kable.Min(xALL[order(source_name)])
              
              if (ToSave && (nrow (xALL) >0) )  {  CCPR_SAVERDS(xALL[!is.na(name) & !is.na(close)], paste0(SData, 'DAY/FOREX/'), 'DOWNLOAD_YAH_FOREX_INTRADAY_TODAY.rds', ToSummary=T, SaveOneDrive = T)}
              
            }
            
            if (ToUpload) {
              x = CHECK_CLASS (try(CCPR_READRDS (paste0(SData, 'DAY/FOREX/'),  'DOWNLOAD_YAH_FOREX_INTRADAY_TODAY.rds', ToRestore = T, ToKable = T) ))
              if (nrow (x) >0) {
                try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_intraday_currencies.rds')),
                                                 l.filepath= tolower(paste0(paste0(SData, 'DAY/FOREX/'),  'DOWNLOAD_YAH_FOREX_INTRADAY_TODAY.rds')),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
              }
            }
            
          } ,
          'INDEXES'    = {
            if (ToDownload)
            {
              pURL = 'https://finance.yahoo.com/world-indices/'
              x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp='c:/temp/yahoo_indexes.txt', 
                                                     pSleep=5, ToDeleteTemp=F)
              content    = try(rvest::read_html(x))
              # content    = try(rvest::read_html(pURL))
              if (all(class(content)!='try-error'))
              {
                tables     = content %>% html_table(fill = TRUE)
                xData      = as.data.table(tables[[1]])
                xData      = CLEAN_COLNAMES(xData)
                setnames(xData, gsub("[():]", "", names(xData)))
                
                # My.Kable.TB(xData)
                # if
                # str(xData)
                # source_name=gsub (' INDEX','',toupper(name),ignore.case = T),
                Final_Data = xData[, .(source='YAH', symbol = gsub( " .*$", "", symbol ),   close=as.numeric(gsub(',','', str_extract(xData$price, "[^+|^-]+"))),
                                       change=as.numeric(gsub(',','', change)), varpc=as.numeric(gsub('[%]','', changepercent_))
                ) ]
                # Final_Data = MERGE_DATASRC_CODE_BYCODESOURCE(pSource = 'YAH', Final_Data)
                # xALL = MERGE_DATASTD_BYCODE(Final_Data, pOption = 'FINAL')
                Final_Data[, updated:=substr(as.character(Sys.time()),1,16)]
                Final_Data[, timestamp:=substr(as.character(Sys.time()),1,19)]
                Final_Data[, date:=as.Date(timestamp)]
                My.Kable.TB(Final_Data)
                
              }
              
              xALL = Final_Data
              xALL[, codesource:=trimws(symbol)]
              xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xALL)
              xALL = MERGE_DATASTD_BYCODE(xALL, pOption = 'FINAL')
              xALL = unique(xALL, by=c('codesource', 'date'))
              xALL[, name:= toupper (name )]
              My.Kable.All(xALL[order(name)])
              
              if (CHECK_TIMEBETWEEN('08:30' , '18:00')){
                x_vn = CHECK_CLASS(try(TRAINEE_DOWNLOAD_FANT_VIETNAM_INDEX_BY_CODE()))
                if (nrow(x_vn) > 0){
                  x_vn[, iso2 := 'VN']
                  x_vn[, type := 'IND']
                  x_vn[, code := gsub(', VIETNAM','',name)]
                  x_vn[, codesource := gsub(', VIETNAM','',name)]
                  x_vn[, source := 'FANT']
                  x_vn[, symbol := gsub(', VIETNAM','',name)]
                  x_vn[, source_name := name]
                  x_vn[, close := pClose]
                  x_vn[, timestamp := updated]
                  x_vn[, fcat := NA]
                  x_vn[, scat := NA]
                  x_vn_ALL = x_vn[, .(iso2, country, continent, type, name, code, date, codesource, source, symbol, source_name, close, change, varpc, updated, timestamp, fcat, scat)]
                  My.Kable.All(x_vn_ALL)
                  xALL = rbind(xALL, x_vn_ALL, fill = T)
                }
              }
              
              if (ToSave && (nrow (xALL) >0) ) {  
                x = CHECK_CLASS (try(CCPR_READRDS (paste0(SData, 'DAY/INDEXES/'),  'DOWNLOAD_YAH_INDEXES_INTRADAY_TODAY.rds', ToRestore = T, ToKable = T) ))
                xALL = unique(rbind(xALL, x, fill = T), by = 'codesource')
                CCPR_SAVERDS(xALL[!is.na(name) &!is.na(close)], paste0(SData, 'DAY/INDEXES/'), 'DOWNLOAD_YAH_INDEXES_INTRADAY_TODAY.rds', ToSummary=T, SaveOneDrive = T)
              }
            }
            if (ToUpload) {
              x = CHECK_CLASS (try(CCPR_READRDS (paste0(SData, 'DAY/INDEXES/'),  'DOWNLOAD_YAH_INDEXES_INTRADAY_TODAY.rds', ToRestore = T, ToKable = T) ))
              if (nrow (x) >0) {
                try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_intraday_indexes')),
                                                 l.filepath= tolower(paste0(paste0(SData, 'DAY/INDEXES/'),  'DOWNLOAD_YAH_INDEXES_INTRADAY_TODAY.rds')),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
              }
            }
          } , 
          'COMMODITIES'    = {
            if (ToDownload)
            {
              # pURL = 'https://finance.yahoo.com/commodities'
              pURL = 'https://finance.yahoo.com/commodities?guccounter=1'
              # CATln_Border(pURL)
              x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp='c:/temp/yahoo_page.txt', 
                                                     pSleep=5, ToDeleteTemp=F)
              content    = try(rvest::read_html(x))
              if (all(class(content)!='try-error'))
              {
                tables     = content %>% html_table(fill = TRUE)
                xData      = as.data.table(tables[[1]])
                xData      = CLEAN_COLNAMES(xData)
                setnames(xData, gsub("[():]", "", names(xData)))
                # My.Kable.TB(xData)
                # if
                # str(xData)
                Final_Data = xData[, .(source='YAH',symbol = gsub( " .*$", "", symbol ), source_name=toupper(gsub("^\\S+ ", "", symbol)),  close=as.numeric(gsub(',','', str_extract(xData$price, "[^+|^-]+"))),
                                       change=as.numeric(gsub(',','', change)), varpc=as.numeric(gsub('[%]','', changepercent_))
                ) ]
                Final_Data[, updated:=substr(as.character(Sys.time()),1,19)]
                Final_Data[, timestamp:=substr(as.character(Sys.time()),1,19)]
                Final_Data[, date:=as.Date(timestamp)]
                My.Kable.TB(Final_Data)
                
              }
              
              xALL = Final_Data
              xALL[, codesource:=trimws(symbol)]
              xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xALL)
              xALL = MERGE_DATASTD_BYCODE(xALL, pOption = 'FINAL')
              xALL = unique(xALL, by=c('codesource', 'date'))
              xALL[, name:= toupper(source_name)]
              My.Kable.Min(xALL[order(source_name)])
              
              # x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp='c:/temp/yahoo_page.txt', 
              #                                        pSleep=5, ToDeleteTemp=F)
              # x = readr::read_file('c:/temp/yahoo_page.txt')
              # xBody = str.extract(x, '<table class="W(100%)">', '</table')
              # xROWS = unlist(strsplit(xBody, '<a data-test="quoteLink'))
              # # xONE  = as.character(xROWS[[3]])
              # # print(xONE)
              # data = list()
              # for (i in 1:length (xROWS))
              # {
              #   xONE  = xROWS[[i]]
              #   x.name   = gsub('&amp;', '&', gsub('"','', str.extract(xONE, 'aria-label="Name">', "<"))); CATln(x.name)
              #   x.symbol = gsub('"','', str.extract(xONE, 'data-symbol=', " ")); CATln(x.symbol)
              #   x.last   = gsub(',','', str.extract(word(word(xONE, 2,2, 'data-field="regularMarketPrice"'),2,2, 'value='),'>','<'));CATln(x.last)
              #   x.change = gsub('"', '', gsub(',','', str.extract(word(word(xONE, 2,2, 'data-field="regularMarketChange"'),2,2, 'value='),'"','>')));CATln(x.change)
              #   x.varpc  = gsub('"', '', gsub(',','', str.extract(word(word(xONE, 2,2, 'data-field="regularMarketChangePercent"'),2,2, 'value='),'"','>')));CATln(x.varpc)
              #   # x.name   = gsub(',','', str.extract(word(word(xONE, 2,2, 'data-field="regularMarketChangePercent"'),2,2, 'value='),'"','>'));CATln(x.varpc)
              #   x.time   = gsub('"','', str.extract(str.extract(xONE, 'data-field=\"regularMarketTime\"', "fin-streamer>"), 'value=', '>')); CATln(x.time)
              #   x.timestamp   = as.POSIXct(as.numeric(x.time), origin = "1970-01-01", tz = "UTC"); CATln(x.timestamp)
              #   xData = data.table(name=x.name, codesource=x.symbol, timestamp=x.timestamp, close=as.numeric(x.last), change = as.numeric(x.change), varpc = as.numeric(x.varpc))
              #   # DBL_RELOAD_INSREF()
              #   # xData = merge(xData, ins_ref[!is.na(yah)][, .(short_name, code, codesource=yah)], all.x = T, by='codesource')
              #   My.Kable.All(xData)
              #   
              #   data [[i]] = xData
              # }
              # my_data = rbindlist (data, fill = T)
              # my_data = my_data[nchar(codesource) > 2]
              # my_data [,':=' (yah= codesource, date = LastTrading, updated = SYS.TIME() )]
              # xdata = merge (my_data , ins_ref [,.(code, yah)],all.x = T,  by = 'yah')
              # My.Kable( xdata)
              # xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xdata)
              # xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xALL)
              # xALL = MERGE_DATASTD_BYCODE(xALL, pOption = 'FINAL')
              # xALL = UPDATE_UPDATED (xALL)
              if (ToSave && (nrow (xALL) >0)) {  CCPR_SAVERDS(xALL[!is.na(name) & !is.na(close)], paste0(SData, 'DAY/COMMODITIES/'), 'DOWNLOAD_YAH_COMMODITIES_INTRADAY_TODAY.rds', ToSummary=T, SaveOneDrive = T)}
              
            }
            
            if (ToUpload) {
              x = CHECK_CLASS (try(CCPR_READRDS (paste0(SData, 'DAY/COMMODITIES/'),  'DOWNLOAD_YAH_COMMODITIES_INTRADAY_TODAY.rds', ToRestore = T, ToKable = T) ))
              if (nrow (x) >0) {
                try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_intraday_commodities.rds')),
                                                 l.filepath= tolower(paste0(paste0(SData, 'DAY/COMMODITIES/'),  'DOWNLOAD_YAH_COMMODITIES_INTRADAY_TODAY.rds')),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
              }
            }
          }
          ,
          'STOCKS'  = {
            # STOCK ............................................................................................
            # ToSave = T
            if (ToDownload)
            {
              pURL = 'https://finance.yahoo.com/most-active/'
              CATln_Border(pURL)
              content    = try(rvest::read_html(pURL))
              
              if (all(class(content)!='try-error'))
              {
                tables     = content %>% html_table(fill = TRUE)
                xData      = as.data.table(tables[[1]])
                xData      = CLEAN_COLNAMES(xData)
                setnames(xData, gsub("[():]", "", names(xData)))
                # My.Kable.TB(xData)
                # if
                # str(xData)
                Final_Data = xData[, .(source='YAH', symbol = gsub( " .*$", "", symbol ),
                                       close=as.numeric(gsub(',','', str_extract(price, "[^+|^-]+"))),
                                       change=as.numeric(gsub(',','', change)), varpc=as.numeric(gsub('[%]','', changepercent_)),
                                       capi=as.numeric(gsub(',','', sub("[^0-9.]+$", "", marketcap ))), unit=substr(marketcap,nchar(marketcap),nchar(marketcap)),
                                       volume=as.numeric(gsub(',','', sub("[^0-9.]+$", "", volume ))), 
                                       volume_unit=substr(volume,nchar(volume),nchar(volume)),
                                       source_name=toupper(gsub("^\\S+ ", "", symbol))
                )
                ]
                Final_Data[unit=='B', capi:=1000000000*capi]
                Final_Data[unit=='T', capi:=1000000000000*capi]
                Final_Data[unit=='M', capi:=1000000*capi]
                Final_Data[unit=='K', capi:=1000*capi]
                Final_Data[volume_unit=='B', volume:=1000000000*volume]
                Final_Data[volume_unit=='T', volume:=1000000000000*volume]
                Final_Data[volume_unit=='M', volume:=1000000*volume]
                Final_Data[volume_unit=='K', volume:=1000*volume]
                Final_Data [,unit:= NULL]
                Final_Data [,volume_unit:= NULL]
                Final_Data [, codesource:= symbol]
                
                
                Final_Data[, updated:=substr(as.character(Sys.time()),1,19)]
                Final_Data[, timestamp:=substr(as.character(Sys.time()),1,19)]
                Final_Data[, date:=as.Date(timestamp)]
                # Final_Data = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', Final_Data)
                # Final_Data = MERGE_DATASTD_BYCODE(Final_Data, pOption = 'FINAL')
                My.Kable(Final_Data,  Nb=20)
                
              }
              
              xALL = Final_Data
              xALL[, codesource:=trimws(symbol)]
              xALL = MERGE_DATASRC_CODE_BYCODESOURCE('YAH', xALL)
              xALL = MERGE_DATASTD_BYCODE(xALL, pOption = 'FINAL')
              xALL = unique(xALL, by=c('codesource', 'date'))
              xALL[, name:= toupper (source_name)]
              My.Kable.Min(xALL[order(source_name)])
              
              
              File_Folder = paste0(SData, 'DAY/STOCKS/')
              if (!file.exists(File_Folder)){ dir.create(File_Folder) }
              
              if (ToSave && (nrow (xALL) >0)) {  CCPR_SAVERDS(xALL[!is.na(name) & !is.na(close)], paste0(SData, 'DAY/STOCKS/'),
                                                              'DOWNLOAD_YAH_STOCKS_INTRADAY_TODAY.rds', ToSummary=T, SaveOneDrive = T)}
            }
            if (ToUpload) {
              x = CHECK_CLASS (try(CCPR_READRDS (paste0(SData, 'DAY/STOCKS/'),  'DOWNLOAD_YAH_STOCKS_INTRADAY_TODAY.rds', ToRestore = T, ToKable = T) ))
              if (nrow (x) >0) {
                try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_intraday_stocks')),
                                                 l.filepath= tolower(paste0(paste0(SData, 'DAY/STOCKS/'),  'DOWNLOAD_YAH_STOCKS_INTRADAY_TODAY.rds')),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
              }
            }
            
          } ,
          'IPO'  = {
            # STOCK ............................................................................................
            # ToSave = T
            if (ToDownload)
            {
              
              pURL = 'https://www.iposcoop.com/last-100-ipos/'
              # # Solution 2: ......................................................................................
              x = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp='c:/temp/ipo.txt', 
                                                     pSleep=5, ToDeleteTemp=F)
              content    = try(rvest::read_html(x))
              # # # Solution 1: ......................................................................................
              # CATln(pURL)
              # response <- GET(pURL, add_headers(
              #   `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
              #   ,`Accept-Language`= "en-US,en;q=0.5"
              # ))
              # xweb       = content(response, as="text")
              # content    = try(rvest::read_html(xweb))
              tables     = content %>% html_table(fill = TRUE)
              
              xData      = as.data.table(tables[[1]])
              xData      = CLEAN_COLNAMES(xData)
              setnames(xData, 'shares(millions)', 'shares_mn')
              setnames(xData, '1stdayclose', 'firstdayclose')
              str(xData)
              My.Kable(xData)
              Final_Data = xData[, .(company     = toupper(company), symbol, industry, 
                                     offer_date  = as.Date(offerdate,'%m/%d/%Y'), 
                                     offer_price = as.numeric(str_extract(offerprice, "[0-9.]+")),
                                     first_close = as.numeric(str_extract(firstdayclose, "[0-9.]+")),
                                     last_close  = as.numeric(str_extract(currentprice, "[0-9.]+")),
                                     return_percent   = as.numeric(gsub('[%]','', return))
              )
              ]
              Final_Data[, return_1st_percent:=100*((first_close/offer_price)-1)]
              Final_Data[, ':='(code=symbol, date=offer_date, updated=as.character(Sys.Date()))]
              My.Kable.TB(Final_Data[order(-offer_date)])
              
              Data_Old = CHECK_CLASS(try(DBL_CCPR_READRDS(UData, 'ifrc_ccpr_ipo_returns.rds', ToKable = T, ToRestore = T)))
              Data_Old = unique (rbind(Data_Old,Final_Data, fill=T)[order(-offer_date)], fromLast = T, by = 'symbol')
              Data_Old[, ':='(code=symbol, date=offer_date, updated=as.character(Sys.Date()))]
              Data_Old = unique ( Data_Old, by = 'symbol')
              My.Kable.TB(Data_Old[order(-offer_date)])
              
              
              if (ToSave && (nrow (Data_Old) >0)) {  
                DBL_CCPR_SAVERDS(Data_Old, UData, 'ifrc_ccpr_ipo_returns.rds', ToSummary = T, SaveOneDrive = T)
                DBL_CCPR_SAVERDS(Data_Old, paste0(SData, 'DASHBOARD/'), 'ifrc_ccpr_ipo_returns.rds', ToSummary = T, SaveOneDrive = T)
              }
            }
            if (ToUpload) {
              x = CHECK_CLASS (try(DBL_CCPR_READRDS (paste0(SData, 'DASHBOARD/'), 'ifrc_ccpr_ipo_returns.rds', ToRestore = T, ToKable = T) ))
              if (nrow (x) >0) {
                try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower('ccpi_dashboard_intraday_ipo'),
                                                 l.filepath= tolower(paste0(SData, 'DASHBOARD/', 'ifrc_ccpr_ipo_returns.rds') ),
                                                 CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
              }
            }
            
          }
          
  )
  x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_DOWNLOAD_MARKET_CUSTOM >', pOption), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}



# ==================================================================================================
# TRAINEE_CCPI_DASHBOARD_MARKETS_RT = function(ToSave = T, ToUpload = F, pHost = '')  {
#   # ------------------------------------------------------------------------------------------------
#   # x = TRAINEE_CCPI_DASHBOARD_MARKETS_RT(ToSave = T, ToUpload = T) 
#   try (DBL_RELOAD_INSREF())
#   ALL_DATA = data.table()
#   for (pContinent in list('europe', 'asia', 'us', 'cryptocurrency'))
#   {
#     # pContinent = 'us'
#     pURL       = paste0('https://www.marketwatch.com/market-data/', pContinent, '?mod=market-data-center')
#     response <- GET(pURL, add_headers(
#       `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
#       ,`Accept-Language`= "en-US,en;q=0.5"
#     ))
#     xWeb     = content(response, as="text")
#     content  = try(rvest::read_html(pURL))
#     tables   = content %>% html_table(fill = TRUE)
#     xData    = as.data.frame(tables[[1]])
#     txData   = transpose(xData)
#     txData   = txData[, -c(1:2)]
#     xData    = as.data.table(t(txData))
#     names(xData) = c('name', 'last', 'change', 'varpc')
#     Final_Data = xData[,  .(
#       continent=toupper(pContinent),
#       name=trimws(gsub('Index', '', name, ignore.case=T)), last=as.numeric(gsub(',|[$]','',last)), 
#       change=as.numeric(gsub(',','',change)), varpc=as.numeric(gsub('[%]','',varpc)))]
#     head(Final_Data, nrow(Final_Data))
#     ALL_DATA = rbind(ALL_DATA, Final_Data, fill=T)
#   }
#   ALL_DATA[, updated:=substr(as.character(Sys.time()),1,19)]
#   My.Kable.All(ALL_DATA)
#   
#   if (ToSave) { 
#     # CCPR_SAVERDS(ALL_DATA, 'R:/CCPR/DATA/DASHBOARD/','ccpi_dashboard_markets.rds')
#     CCPR_SAVERDS(ALL_DATA, 'S:/CCPR/DATA/DASHBOARD/','ccpi_dashboard_markets.rds')
#   }
#   if (ToUpload) {
#     try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_markets')),
#                              l.filepath= tolower(paste0('S:/CCPR/DATA/DASHBOARD/',  'ccpi_dashboard_markets.rds')),
#                              CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
#   }
#   x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_CCPI_DASHBOARD_MARKETS_RT'), pAction="SAVE", NbSeconds=3600, ToPrint = T))
#   return(ALL_DATA)
# }

# ==============================================================================
TRAINEE_CCPR_CHECK_MYPC = function(pSleep = 10)  
{
  # ----------------------------------------------------------------------------
  # try(CCPR_CHECK_MYPC(pSleep=10))
  MyPC = ""
  if (file.exists('c:/r/my_pc.txt'))
  {
    MyPC = as.character(readLines('c:/r/my_pc.txt'))
  }
  FileName = 'CHECK_MYPC.rds'
  pFolder  = paste0(SData, 'MONITOR/')
  ODDrive_Data = paste0(ODDrive, substr(pFolder, 1, 1), word(pFolder, 2, 2, ":"))
  CATln(ODDrive_Data)
  
  if (!file.exists(ODDrive_Data))
  {
    try(dir.create(ODDrive_Data))
  }
  FullPath_Local = paste0(pFolder, FileName)
  FullPath_ODDrive = paste0(ODDrive_Data, FileName)
  
  Has_Config      = ifelse(file.exists('c:/r/config.r'), 'Y', 'N')
  Has_MyPC        = ifelse(file.exists('c:/r/my_pc.txt'), 'Y', 'N')
  Has_Py_Download = ifelse(file.exists('c:/r/my_pc.txt'), 'Y', 'N')
  Has_CCPR        = if_else(file.exists(SData),'Y','N')
  Has_Udata       = if_else(file.exists(UData),'Y','N')
  Has_SDrive      = if_else(file.exists('S:/'),'Y','N')
  Has_RDrive      = if_else(file.exists('R:/'),'Y','N')
  Has_UDrive      = if_else(file.exists('U:/'),'Y','N')
  Has_TDrive      = if_else(file.exists('T:/'),'Y','N')
  
  Data_One = data.table(
    mypc        = MyPC,
    date        = Sys.Date(),
    updated     = substr(Sys.time(), 1, 19),
    config      = Has_Config,
    my_pc       = Has_MyPC,
    py_download = Has_Py_Download,
    SData    = Has_CCPR,
    udata       = Has_Udata,
    sdrive      = Has_SDrive,
    rdrive      = Has_RDrive,
    tdrive      = Has_TDrive,
    udrive      = Has_UDrive
  )
  My.Kable.All(Data_One)
  
  Data_MYPC = CCPR_READRDS('S:/CCPR/DATA/', FileName)
  # 
  # if (!file.exists(FullPath_Local)) {
  #   Data_MYPC = data.table()
  # } else {
  #   Data_MYPC = CCPR_READ_RDS_WITH_ALTERNATIVE(FileFrm = FullPath_Local, FileAlt = FullPath_ODDrive)[[1]]
  # }
  # 
  Data_MYPC = rbind(Data_MYPC, Data_One, fill = T)
  Data_MYPC$x = NULL
  Data_MYPC = unique(Data_MYPC[order(mypc,-updated)], by = 'mypc')[!is.na(mypc)]
  My.Kable.All(Data_MYPC)
  CCPR_SAVERDS(Data_MYPC, 'S:/CCPR/DATA/', FileName, SaveOneDrive = T)
  CCPR_SAVERDS(Data_MYPC, 'S:/SHINY/BATCH/', FileName, SaveOneDrive = T)
  # 
  # xSaveOneDrive = (runif(1,1,100)>90)
  # try(SAVERDS_WITH_ONEDRIVE(pData=Data_MYPC, FileFolder=paste0(SData, 'MONITOR/'), FileName=FileName , SaveOneDrive=xSaveOneDrive))
  IFRC_SLEEP(pSleep)
}

# ==================================================================================================
MAINTENANCE_WCEO = function (Action = '' , Minutes = 5)  {
  # ------------------------------------------------------------------------------------------------
}

# ==================================================================================================
MAINTENANCE_CUSTOM = function (Action = '' , Minutes = 15)  {
  # ------------------------------------------------------------------------------------------------
  # MAINTENANCE_CUSTOM (Action = 'LOOP_CAF_SNAPHOT_ASC' , Minutes = 15) 
  switch (Action, 
          'SCAN' = {
            List_Actions = setDT(fread('S:/STKVN/MAINTENANCE_ACTIONS.txt'))
            List_Actions = List_Actions[maintenance=='CUSTOM']
            My.Kable.All(List_Actions)
            if (nrow(List_Actions)>0)
            {
              for (k in 1:nrow(List_Actions [action != 'SCAN']))
              {
                # k = 1
                pAction = trimws(List_Actions[k]$action)
                pMinute = List_Actions[k]$minutes
                try(MAINTENANCE_CUSTOM (Action=pAction, Minutes=pMinute))
              }
            }
          } ,
          
          'LOOP_CAF_SNAPHOT_FIRSTCHARS' = {
            
            # TEST ---------------------------------------------------------------------------------------------  
            if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='LOOP_CAF_SNAPHOT_FIRSTCHARS', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
            {
              x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='LOOP_CAF_SNAPHOT_FIRSTCHARS', pAction="SAVE",    NbSeconds=Minutes*60, ToPrint=F)
              List_SetChars = list('ABC', 'DEF', 'GHI', 'JKL', 'MNO', 'PQR', 'STU', 'VWXYZ')
              for (pFirstChars in sample(List_SetChars))
              {
                # pFirstChars = 'VWXYZ'
                x = try(LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                      pMarket    = 'HSX', 
                                                      pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                      File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                      pDate      = LastTrading,
                                                      List_Codes = list(),
                                                      File_Codes = "S:/CCPR/DATA/download_hsx_stkvn_ref_history.rds",
                                                      Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
              }
              
              for (pFirstChars in sample(List_SetChars))
              {
                # pFirstChars = 'ABC'
                x = try(LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                      pMarket    = 'UPC', 
                                                      pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                      File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                      pDate      = LastTrading,
                                                      List_Codes = list(),
                                                      File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                      Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
              }
              
              for (pFirstChars in sample(List_SetChars))
              {
                # pFirstChars = 'ABC'
                x = try(LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = pFirstChars, random = T,
                                                      pMarket    = 'HNX', 
                                                      pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                      File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                      pDate      = LastTrading,
                                                      List_Codes = list(),
                                                      File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                      Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
              }
              
            } else { CATln_Border(paste('LOOP_CAF_SNAPHOT_ASC :', 'SKIP')) }
          }, 
          'LOOP_CAF_SNAPHOT_DESC' = {
            
            # TEST ---------------------------------------------------------------------------------------------  
            if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='LOOP_CAF_SNAPHOT_DESC', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
            {
              x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='LOOP_CAF_SNAPHOT_DESC', pAction="SAVE",    NbSeconds=Minutes*60, ToPrint=F)
              try (LOOP_DOWNLOAD_CUSTOM_BY_CODE ( ranking    = 'DESC', FirstChars = 'ABC', random = F, pMarket    = 'UPC', 
                                                  pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                  File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                                  pDate      = Sys.Date(),  List_Codes = list(),
                                                  File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                  Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT'))
              
            } else { CATln_Border(paste('LOOP_CAF_SNAPHOT_DESC :', 'SKIP')) }
          },
          'TRAINEE_CCPR_CHECK_MYPC' = {
            # Monitor_All = readRDS(paste0(CCPRDrive, 'CCPR/DATA/MONITOR/CHECK_MYPC.rds'))
            
            
            if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_CCPR_CHECK_MYPC', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
            {
              x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_CCPR_CHECK_MYPC', pAction="SAVE",    NbSeconds=Minutes*60, ToPrint=F)
              try ( TRAINEE_CCPR_CHECK_MYPC (pSleep = 10) )
              
            } else { CATln_Border(paste('TRAINEE_CCPR_CHECK_MYPC :', 'SKIP')) }
          },
          
          
  )
}

# ==================================================================================================
UPDATE_UPDATED = function(TableName) {
  # ------------------------------------------------------------------------------------------------
  if ('updated' %in% names(TableName)) { TableName[, updated:=as.character(updated)]}
  if ('updated' %in% names(TableName)) { TableName[, updated:=substr(updated,1,19)]}
  if (!'updated' %in% names(TableName)) { TableName[, updated:=substr(as.character(Sys.time()),1,19)]}
  TableName[is.na(updated), updated:=substr(as.character(Sys.time()),1,19)]
  return(TableName)
}

# ==================================================================================================
UPDATE_UPDATED_BY_FILE = function(File_folder = 'S:/STKVN/PRICES/DAY/', pFileName = 'download_bsc_pricesboard_day.rds')  {
  # ------------------------------------------------------------------------------------------------
  CATln(''); CATln_Border(paste0(File_folder, pFileName))
  File_data = CHECK_CLASS(try(CCPR_READRDS(File_folder, pFileName, ToKable = T)))
  if (nrow(File_data)>0)
  {
    File_data = UPDATE_UPDATED(File_data)
    My.Kable(File_data)
    try(CCPR_SAVERDS(File_data, File_folder, pFileName, ToSummary=F, SaveOneDrive = T))
  }
}

# ==================================================================================================
UPDATE_UPDATED_BY_LIST_FILES = function(File_folder = 'S:/STKVN/PRICES/DAY/', Pattern = '_pricesboard_')  {
  # ------------------------------------------------------------------------------------------------
  List_files  = as.data.table(list.files(File_folder, '*.rds$'))
  
  List_files  = List_files[grepl(Pattern, V1)]
  My.Kable(List_files)
  for (k in 1:nrow(List_files))
  {
    pFileName = List_files[k]$V1
    CATln(''); CATln_Border(paste(k, '/', nrow(List_files), ' = ', pFileName))
    File_data = CHECK_CLASS(try(CCPR_READRDS(File_folder, pFileName, ToKable = T)))
    if (nrow(File_data)>0)
    {
      File_data = UPDATE_UPDATED(File_data)
      My.Kable(File_data)
      try(CCPR_SAVERDS(File_data, File_folder, pFileName, ToSummary=F, SaveOneDrive = T))
    }
  }
}


# ==================================================================================================
MAINTENANCE_OPENCLOSE = function (Action = '', Minutes=5) {
  # ------------------------------------------------------------------------------------------------
  
  ##### REPORT #####
  
  switch(Action,
         'SCAN' = {
           List_Actions = setDT(fread('S:/STKVN/MAINTENANCE_ACTIONS.txt'))
           List_Actions = List_Actions[maintenance=='OPENCLOSE']
           My.Kable.All(List_Actions)
           if (nrow(List_Actions)>0)
           {
             for (k in 1:nrow(List_Actions [action != 'SCAN']))
             {
               # k = 1
               pAction = trimws(List_Actions[k]$action)
               pMinute = List_Actions[k]$minutes
               try(MAINTENANCE_OPENCLOSE (Action=pAction, Minutes=pMinute))
             }
           }
         },
         
         'TRAINEE_CLOSE_PRICES_DAILY' = {
           
           # TEST ---------------------------------------------------------------------------------------------  
           if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_CLOSE_PRICES_DAILY', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
           {
             # try(DASHBOARD_CCPI_MARKET_CHARTS(ToUpload = T, ToSave   = T))
             x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_CLOSE_PRICES_DAILY', pAction="SAVE",    NbSeconds=Minutes*60, ToPrint=F)
             CLOSE = try(TRAINEE_CLOSE_PRICES_DAILY (File_Folder = 'S:/STKVN/PRICES/DAY/', 
                                                     LIST_SOURCES = list('HSX', 'HNX', 'UPC', 'VND', 'MBS', 'VPS','TVSI','BSC','VST', 'C68', 'CAF')))
           } else { CATln_Border(paste('TRAINEE_CLOSE_PRICES_DAILY :', 'SKIP')) }
           
           # TEST (End) ---------------------------------------------------------------------------------------
           
         },
         
         'TRAINEE_OPEN_PRICES_DAILY' = {
           
           # TEST ---------------------------------------------------------------------------------------------  
           if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_OPEN_PRICES_DAILY', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
           {
             # try(DASHBOARD_CCPI_MARKET_CHARTS(ToUpload = T, ToSave   = T))
             x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_OPEN_PRICES_DAILY', pAction="SAVE",    NbSeconds=Minutes*60, ToPrint=F)
             CLOSE = try(TRAINEE_REPORT_OPEN_FINAL (File_Folder = 'S:/STKVN/PRICES/DAY/',
                                                    LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC', 'HSX', 'STB', 'DCL'),
                                                    LIST_DATASET = list('reference', 'market', 'sharesout')))
           } else { CATln_Border(paste('TRAINEE_OPEN_PRICES_DAILY :', 'SKIP')) }
           
           # TEST (End) ---------------------------------------------------------------------------------------
           
         },
         
         'TRAINEE_REPORT_PRICES_DAILY' = {   
           try(TRAINEE_REPORT_PRICES_DAILY (File_Folder = 'S:/STKVN/PRICES/DAY/', 
                                            LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC', 'HSX')))
         }
  )
}

# ==================================================================================================
TRAINEE_MONITOR_EXECUTION_SUMMARY = function(pOption='MAINTENANCE_STKVN > REF', pAction="SAVE", NbSeconds=3600, ToPrint=F) {
  # ------------------------------------------------------------------------------------------------
  pResult = T
  # pOption='SCRIPT > TRAINEE_DEV_REPORT'
  switch(pAction,
         # .......................................................................................
         "SAVE" = {
           # .......................................................................................
           MyPC = toupper(TRAINEE_GET_MYPC())
           FileName = "TRAINEE_MONITOR_EXECUTION_SUMMARY.rds"
           # FileName <- "TRAINEE_MONITOR_EXECUTION_SUMMARY_V2.rds"
           
           MonitorDir = "S:/CCPR/DATA/MONITOR/"
           
           if (file.exists(file.path(MonitorDir, FileName))) {
             Data_Old = CHECK_CLASS(try(DBL_CCPR_READRDS(MonitorDir, FileName, ToRestore = T)))
             
             if (max(Data_Old$date) == Sys.Date()){
               list_option = unique(Data_Old$code)
               
               if (pOption %in% list_option){
                 Data_Old = Data_Old[date == Sys.Date()]
               }
               else {
                 num_columns = ncol(Data_Old) 
                 new_row = data.frame(code = pOption, 
                                      
                                      date = Sys.Date(),
                                      matrix(NA, nrow = 1, ncol = num_columns - 2))  
                 names(new_row)[-c(1, 2)] <- names(Data_Old)[-c(1, 2)]  
                 Data_Old = rbind(Data_Old, new_row)
                 Data_Old = Data_Old[date == Sys.Date()]
               }
             }
             else {
               Data_Old = data.table(code = pOption, date = Sys.Date())
             }
           } else {
             Data_Old = data.table(code = pOption, date = Sys.Date())
           }
           
           if (!MyPC %in% names(Data_Old))
           {
             Data_Old[, (MyPC) := as.character(NA_character_)]
           }
           
           subset_data = Data_Old[code == pOption]
           if (is.na(Data_Old[code == pOption, get(MyPC)]) | 
               (subset_data[[MyPC]] != SYS.TIME()) ) {
             current_date = as.Date(Sys.time())
             if (any(Data_Old$date == current_date)) {
               subset_data[, (MyPC) := SYS.TIME()]
             }
             else {
               subset_data[, (MyPC) := SYS.TIME()]
             }
             Data_Old[code == pOption] = subset_data
           }
           Data_Old <- unique(Data_Old, by = 'code', fromLast = TRUE)
           Data_Old = Data_Old[order(code)]
           
           
           LastTrading      = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
           Data_Old[, updated := NULL]
           
           Data_Convert = copy(Data_Old)
           columns_to_convert = setdiff(names(Data_Convert), c("code", "date"))
           
           # Data_Convert[, (columns_to_convert) := lapply(.SD, function(x) {
           #   ifelse(is.na(x), NA, paste0(LastTrading,' ', x))
           # }), .SDcols = columns_to_convert]
           Data_Convert[, (columns_to_convert) := lapply(.SD, function(x) {
             ifelse(is.na(x), NA, x)
           }), .SDcols = columns_to_convert]
           
           Data_Convert[, (columns_to_convert) := lapply(.SD, function(x) as.POSIXct(x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")), .SDcols = columns_to_convert]
           
           Data_Convert[, updated := do.call(pmax, c(.SD, na.rm = TRUE)), .SDcols = columns_to_convert]
           Data_Convert[, updated := substr(as.character(updated), 1, 19)]
           
           Data_Old = merge(Data_Old, Data_Convert[, .(code, updated)], by = "code", all.x = T)
           My.Kable.All(Data_Old)
           
           # Data_Old = UPDATE_UPDATED(Data_Old)
           DBL_CCPR_SAVERDS(Data_Old, MonitorDir, FileName, ToSummary = T, SaveOneDrive = T, Nb_repeat = 1, pSleep = 1,
                            ToSaveDate = (runif(1,1,100) > 99), SaveDate_Folder="S:/CCPR/DATA/DASHBOARD_LIVE/BACKUP/")
           DBL_CCPR_SAVERDS(Data_Old, 'S:/SHINY/REPORT/PC_FUNCTIONS/', FileName, ToSummary = T, SaveOneDrive = T, Nb_repeat = 1)
           
           
           library(fst)
           write_fst(Data_Old, "S:/SHINY/REPORT/PC_FUNCTIONS/trainee_monitor_execution_summary.fst")
           try(fwrite(Data_Old, file.path(MonitorDir, gsub('.rds', '.txt', FileName)), sep = '\t', col.names = TRUE))
           
         },
         # .......................................................................................
         "COMPARE" = {
           # .......................................................................................
           MyPC = toupper(TRAINEE_GET_MYPC())  #getMyPC()
           FileName = "TRAINEE_MONITOR_EXECUTION_SUMMARY.rds"
           if (file.exists(paste0('S:/CCPR/DATA/', "MONITOR/", FileName)))
           {
             Data_Old = CHECK_CLASS(try(DBL_CCPR_READRDS(paste0('S:/CCPR/DATA/', "MONITOR/"), FileName, ToRestore=T)))
             if (nrow(Data_Old)>0) { Data_Old = Data_Old[date==Sys.Date()] } else { Data_Old = data.table() }
           } else { Data_Old = data.table() }
           if (nrow(Data_Old)>0) { Data_One = Data_Old[code==pOption] } else {  Data_One = data.table() }
           
           if (nrow(Data_One)>0)
           {
             Data_One = unique(Data_One, by="code")
             # Past_time = Data_One$updated
             #  Past_time = as.POSIXct(paste0(Sys.Date(),' ', Data_One$updated), format="%Y-%m-%d %H:%M:%S")
             Past_time = Data_One$updated
             if (is.na(Past_time)) { Past_time = Sys.time()}
             Diff_time = difftime(Sys.time(), Past_time, units='secs')
             CATln(paste(pOption, ":", as.character(round(Diff_time,3))))
             pResult = Diff_time>NbSeconds
           }
         }
  )
  if (ToPrint) { CATln(pResult)}
  return(pResult)
}


# ==================================================================================================
OLD_TRAINEE_MONITOR_EXECUTION_SUMMARY = function(pOption='SCRIPT > MAINTENANCE_PRICESBOARD', pAction="SAVE", NbSeconds=3600, ToPrint=F) {
  # ------------------------------------------------------------------------------------------------
  # LastUpdated = 2024-05-30 09:50
  pResult = T
  # pAction="COMPARE"
  switch(pAction,
         # .......................................................................................
         "SAVE" = {
           # .......................................................................................
           MyPC <- toupper(TRAINEE_GET_MYPC())
           FileName <- "TRAINEE_MONITOR_EXECUTION_SUMMARY.rds"
           # FileName <- "TRAINEE_MONITOR_EXECUTION_SUMMARY_V2.rds"
           
           MonitorDir <- "S:/CCPR/DATA/MONITOR/"
           
           if (file.exists(file.path(MonitorDir, FileName))) 
           {
             Data_Old <- CHECK_CLASS(try(CCPR_READRDS(MonitorDir, FileName, ToRestore = TRUE)))
             
             if (max(Data_Old$date) == Sys.Date())
             {
               list_option = unique(Data_Old$code)
               
               if (pOption %in% list_option){
                 Data_Old = Data_Old[date == Sys.Date()]
                 # Data_Old = Data_Old[date == Sys.Date()]
               }
               else {
                 num_columns <- ncol(Data_Old) 
                 new_row <- data.frame(code = pOption, 
                                       date = Sys.Date(),
                                       matrix(NA, nrow = 1, ncol = num_columns - 2))  
                 names(new_row)[-c(1, 2)] <- names(Data_Old)[-c(1, 2)]  
                 Data_Old <- rbind(Data_Old, new_row)
                 Data_Old <- Data_Old[date == Sys.Date()]
               }
             }
             else {
               Data_Old <- data.table(code = pOption, date = Sys.Date(), updated=SYS.TIME())
               My.Kable.All(Data_Old)
             }
           }
           else {
             Data_Old <- data.table(code = pOption, date = Sys.Date(), updated=substr(as.character(Sys.time()),1,19))
           }
           
           if (!MyPC %in% names(Data_Old))
           {
             Data_Old[, (MyPC) := as.character(NA_character_)]
           }
           
           subset_data <- Data_Old[code == pOption]
           if (nrow(subset_data)>0) { subset_data[, updated:=SYS.TIME()]}
           if (is.na(Data_Old[code == pOption, get(MyPC)]) | 
               (subset_data[[MyPC]] != substr(as.character(Sys.time()), 1, 19))) {
             current_date <- as.Date(Sys.time())
             if (any(Data_Old$date == current_date)) {
               subset_data[, (MyPC) := substr(as.character(Sys.time()), 12, 19)]
             }
             else {
               subset_data[, (MyPC) := as.character(Sys.time())]
             }
             Data_Old[code == pOption] <- subset_data
           }
           
           Data_Old = unique(Data_Old, by = 'code', fromLast = TRUE)
           Data_Old = Data_Old[order(code)]
           My.Kable.All(Data_Old)
           Data_Old = UPDATE_UPDATED(Data_Old)
           LastUpdate = SYS.TIME()
           Data_Old[, updated:=LastUpdate]
           
           CCPR_SAVERDS(Data_Old, MonitorDir, FileName)
           CCPR_SAVERDS(Data_Old, 'S:/SHINY/REPORT/PC_FUNCTIONS/', FileName)
           # S:/SHINY/REPORT/PC_FUNCTIONS/trainee_monitor_execution_summary.rds
           
           try(fwrite(Data_Old, file.path(MonitorDir, gsub('.rds', '.txt', FileName, ignore.case = T)), sep = '\t', col.names = TRUE))
           fst_file = fst::write_fst(Data_Old, gsub(".rds", ".fst", paste0('S:/SHINY/REPORT/PC_FUNCTIONS/', FileName), ignore.case = T))
           # My.Kable.TB(Data_Old[order(updated)][updated==LastUpdate])
         },
         
         # .......................................................................................
         "COMPARE" = {
           # .......................................................................................
           MyPC = toupper(TRAINEE_GET_MYPC())  #getMyPC()
           FileName <- "TRAINEE_MONITOR_EXECUTION_SUMMARY.rds"
           if (file.exists(paste0('S:/CCPR/DATA/', "MONITOR/", FileName)))
           {
             Data_Old = CHECK_CLASS(try(CCPR_READRDS(paste0('S:/CCPR/DATA/', "MONITOR/"), FileName, ToRestore=T)))
             if (nrow(Data_Old)>0) { Data_Old = Data_Old[date==Sys.Date()] } else { Data_Old = data.table() }
           } else { Data_Old = data.table() }
           
           if (nrow(Data_Old)>0) { Data_One = Data_Old[code==pOption] } else {  Data_One = data.table() }
           
           if (nrow(Data_One)>0)
           {
             Data_One  = unique(Data_One, by="code")
             Past_time = Data_One$updated
             Diff_time = difftime(Sys.time(), Past_time, units='secs')
             CATln(paste(pOption, ":", as.character(round(Diff_time,3))))
             pResult = Diff_time>NbSeconds
           }
         }
  )
  if (ToPrint) { CATln(pResult)}
  return(pResult)
}

# ==================================================================================================
MERGE_CODE_FROM_INSREF = function(pData, ins_ref, source){
  # ------------------------------------------------------------------------------------------------
  switch(source,
         'YAH' = { pData = merge(pData[, -c('type', 'code','name', 'continent', 'country','scat')], 
                                 ins_ref[, .(type, code,name,codesource=yah, continent, country,scat)], all.x=T, by='codesource') }
  )
  return(pData)
}
# ==================================================================================================
TRAINEE_DOWNLOAD_INTRADAY_YAH = function(pCode='SGO.PA', pDur='1m', NbDays=250){
  # ------------------------------------------------------------------------------------------------
  xData = data.table()
  switch(pDur,
         '5m' = { pDuration = 30*24*60*60},
         '1m' = { pDuration = 7*24*60*60},
         '1d' = { pDuration = NbDays*24*60*60}
  )
  
  Epoch_Now    = floor(as.numeric(Sys.time()))
  Epoch_Before = floor(as.numeric(Sys.time()-pDuration))
  lubridate::as_datetime(Epoch_Now)
  lubridate::as_datetime(Epoch_Before)
  
  # pURL = 'https://query1.finance.yahoo.com/v8/finance/chart/SGO.PA?symbol=SGO.PA&period1=1687378200&period2=1687841183&useYfid=true&interval=5m&includePrePost=true&events=div%7Csplit%7Cearn&lang=en-US&region=US&crumb=GlxsM.YMaan&corsDomain=finance.yahoo.com'
  pURL  = paste0('https://query1.finance.yahoo.com/v8/finance/chart/', pCode, '?symbol=', pCode, '&period1=', 
                 Epoch_Before, '&period2=', Epoch_Now, '&useYfid=true&interval=', pDur, 
                 '&includePrePost=true&events=div%7Csplit%7Cearn&lang=en-US&region=US&crumb=GlxsM.YMaan&corsDomain=finance.yahoo.com')
  CATln_Border(pURL)
  x = try( jsonlite::fromJSON(pURL))
  
  # x$chart$result$timestamp
  
  xCUR      = as.character(x$chart$result$meta$currency)
  xTZ       = as.character(x$chart$result$meta$timezone)
  xEXC      = as.character(x$chart$result$meta$exchangeName)
  xTZEXC    = as.character(x$chart$result$meta$exchangeTimezoneName)
  xOFFSET   = as.character(x$chart$result$meta$gmtoffset)
  xTYPE     = as.character(x$chart$result$meta$instrumentType)
  y = as.vector(x$chart$result$indicators$quote)
  
  z = as.data.table(y)
  
  x.timestamp = as.data.table(x$chart$result$timestamp)
  x.high   = as.data.table(z$high)
  x.low    = as.data.table(z$low)
  x.open   = as.data.table(z$open)
  x.close  = as.data.table(z$close)
  x.volume = as.data.table(z$volume)
  xData    = setDT(cbind(x.timestamp, x.high, x.low, x.open, x.close, x.volume)) 
  
  
  colnames(xData) = c('timestamp', 'high', 'low', 'open', 'close', 'volume')
  
  
  
  # xData[, datetime:=lubridate::as_datetime(timestamp)]
  xData[, datetime:=lubridate::with_tz(timestamp, xTZEXC) ]
  
  xData[, ":="(codesource=pCode, source='YAH', cur=xCUR, tz=xTZ, tzn = xTZEXC, tzoffset=as.numeric(xOFFSET), instype=xTYPE, date=as.Date(substr(datetime,1,10)))]
  xData = xData %>% select(instype, codesource, source, timestamp, datetime, tz,tzn, tzoffset, everything())
  
  # xData[, datetime:=as.Date(as.POSIXct(timestamp, origin="1970-01-01"))]
  My.Kable(xData)
  return(xData)
}

# ==================================================================================================
TRAINEE_REPORT_PRICES_DAILY = function (File_Folder = 'S:/STKVN/PRICES/DAY/', 
                                        LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'EXC', 'HNX', 'UPC', 'HSX', 'STB', 'DCL')) {
  
  #File_Folder = 'S:/STKVN/PRICES/DAY/'
  #LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC', 'HSX')
  LastTrading = CCPR_LAST_TRADING_DAY_VN( hour(Sys.time()), ToPrompt = T)
  
  TRAINEE_REPORT_SHARES (File_Folder, LIST_SOURCES)  
  
  DBL_RELOAD_INSREF()
  DATA_ALL_DAY = data.table()
  xList_day    = list()
  for (k in 1:length(LIST_SOURCES))
  {
    # k = 6
    pSource     = LIST_SOURCES[[k]]
    File_day_Name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    CATln_Border(File_day_Name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_day_Name, ToKable = T)))
    My.Kable(File_Data_Day)
    
    if ( nrow (File_Data_Day) > 0) 
    {
      File_Data_Day[, K := k]
      File_Data_Day[, updated := as.character(updated)]
      xList_day[[k]] = File_Data_Day
    }
  }
  
  
  DATA_ALL_DAY = rbindlist(xList_day, fill = T)
  
  #clean
  DATA_ALL_DAY[market == 'UPCOM', market := 'UPC']
  DATA_ALL_DAY[market == 'HOSE', market := 'HSX']
  DATA_ALL_DAY[, ticker:= gsub('[*]', '', ticker)]
  DATA_ALL_DAY[, code := paste0('STKVN', ticker)]
  DATA_ALL_DAY[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
  DATA_ALL_DAY[!is.na(reference) & volume == 0, last := reference]
  DATA_ALL_DAY[volume == 0, close := last]
  DATA_ALL_DAY[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
  DATA_ALL_DAY = merge(DATA_ALL_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
  DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
  
  DATA_ALL_DATE = rbind(DATA_ALL_DAY[, .(source , market, date, updated)], DATA_ALL_DAY[ market %in% list('HNX', 'HSX')][, .(source , market = 'HSXHNX', updated ), date])
  DATA_ALL_DATE = unique(DATA_ALL_DATE[order(source, market, -date)], by = c('source', 'market'))[, LastTrading := LastTrading]
  max_date = unique(DATA_ALL_DATE[order(market, - date)][,. (market, date)], by = 'market')
  DATA_ALL_DATE = merge(DATA_ALL_DATE, max_date[,. (market, max_date = date)], by = "market", all.x = TRUE)
  DATA_ALL_DATE = DATA_ALL_DATE[date == max_date, ]
  DATA_ALL_DATE [, n := as.character(date - LastTrading)]
  DATA_ALL_DATE [n == 0, n := substr(updated, 12, 16)]
  
  report_date = setDT(spread(DATA_ALL_DATE[, .(n), by = .(source, market, date)], key = 'source', value = 'n'))[, ':='( updated = substr(Sys.time(),1,19) ,data = 'PRICESBOARD')]
  My.Kable.All(report_date)
  CCPR_SAVERDS(report_date,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_pricesboard_date.rds')
  
  DATA_ALL_NUMBER = DATA_ALL_DAY[ date == LastTrading]
  DATA_ALL_NUMBER_REPORT = rbind(DATA_ALL_NUMBER[, .(source , market, date)], DATA_ALL_NUMBER[ market %in% list('HNX', 'HSX')][, .(source , market = 'HSXHNX'), date])
  report_number = setDT(spread(DATA_ALL_NUMBER_REPORT[,.(n=.N), by=c('source', 'market')], key='source', value='n'))[market!='HSXHNX', nr:=0][market=='HSXHNX', nr:=1][order(nr, market)][, ':='(date = LastTrading,  updated = substr(Sys.time(),1,19) ,data = 'PRICESBOARD')]
  My.Kable.All(report_number)
  CCPR_SAVERDS(report_number,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_pricesboard_number.rds')
  try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
  Monitor = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='TRAINEE_REPORT_PRICES_DAILY', pAction="SAVE", NbSeconds=1, ToPrint=F))
}

# ==================================================================================================
TRAINEE_UPDATE_UPLOAD_CCPR_MARKET_LAST = function(UData='S:/CCPR/DATA/', UList= paste0('S:/CCPR/DATA/', 'YAH/LIST/','LIST_YAH_MARKET_LAST.txt'), 
                                                  pSource = 'YAH',  xPeriod = '5m', toReset = F, pHost = 'ccpi_dashboard',
                                                  ToDownload = F , ToUpload = F , Days = 5) {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-06-07 14:47
  # CATln_Border('LOADING INS_REF...')
  try(DBL_RELOAD_INSREF ())
  # ins_ref = readRDS(paste0('R:/CCPR/DATA/', 'efrc_ins_ref.rds'))
  # SData = UData
  # ccpi_quote_slider
  # UPDATE_UPLOAD_CCPR_MARKET_LAST(UData=SData, UList= paste0(SData, 'YAH/LIST/','LIST_YAH_MARKET_LAST.txt'),
  #                                           pSource = 'YAH',  xPeriod = '5m', toReset = F)
  if (ToDownload) {
    start.time = Sys.time()
    xList = list()
    
    Data_To_Do = read.table(UList, header = FALSE, sep = "\t")
    setnames(Data_To_Do, as.character(Data_To_Do[1, ]))
    Data_To_Do = Data_To_Do[-1, ]
    Data_To_Do = data.table(Data_To_Do)
    # Data_To_Do = Data_To_Do[slider == 0]
    
    for (i in 1:nrow(Data_To_Do))
    {
      # i = 40
      CATln('')
      x     = try(TRAINEE_DOWNLOAD_INTRADAY_YAH(pCode = Data_To_Do[i]$yah, pDur = xPeriod, NbDays = Days))
      if (all(class(x)!='try-error')) { 
        x = MERGE_CODE_FROM_INSREF(pData = x, ins_ref = ins_ref, source = pSource) 
        x[is.na(code), ':='(code=Data_To_Do[i]$code, name=Data_To_Do[i]$name)]
        x[is.na(type), type:= Data_To_Do[i]$type]
        x[scat=='CRYPTO',type:='CRY']
        x[is.na(country), country:= Data_To_Do[i]$country]
        x[is.na(continent), continent:= Data_To_Do[i]$continent]
        x[, slider:= Data_To_Do[i]$slider ]
        x[, datetime:=as.character(datetime)] 
        timezone = unique(x$tzn)
        From_Time = as.POSIXlt(x$datetime, tz = timezone,  format = "%Y-%m-%d %H:%M:%OS", optional = F)
        From_Time2 = as.POSIXlt(x$datetime, tz = timezone,   tryFormats = c("%Y-%m-%d %H:%M:%OS",
                                                                            "%Y/%m/%d %H:%M:%OS",
                                                                            "%Y-%m-%d %H:%M",
                                                                            "%Y/%m/%d %H:%M",
                                                                            "%Y-%m-%d",
                                                                            "%Y/%m/%d"), optional = F) 
        my_time = data.table(timestamp = x$timestamp,datetime = From_Time,date = From_Time2)
        my_time[is.na(datetime), datetime := date]
        my_time [, datetime_vn := as.character(substr(lubridate::with_tz(datetime, "Asia/Bangkok"),1,16))]
        x$datetime_vn = my_time$datetime_vn
        My.Kable.TB(x) 
        xList[[i]] = x
      }
    }
    
    xAll = rbindlist(xList, fill=T)
    My.Kable(xAll)
    Data_Old = data.table()
    Data_Finalx = rbind(Data_Old, xAll, fill=T)[, -c('codesource', 'source')]
    Data_Finalx[, datetime:=as.character(datetime)]   
    # Data_Final$datetime = with_tz(Data_Final$datetime, tzone = "UTC")
    # From_Time = as.POSIXct(Data_Final$datetime,tz = "Europe/London")
    # To_Time   = as.POSIXct(From_Time, tz="UTC")
    # To_Time   = as.character(substr(lubridate::with_tz(Data_Final$datetime, "Asia/Bangkok"),1,19)); CATln(To_Time)
    # Data_Final[, datetime_vn:= substr(To_Time, 1,16)] 
    
    My.Kable(Data_Finalx[, .(continent, country, slider, code, name,datetime, datetime_vn, close)] [order(-datetime_vn)])
    # str(Data_Final)
    if(!toReset){
      # Data_Old = readRDS(paste0(SData, 'ccpi_market_last_intraday.rds')) D:\Onedrive\R\CCPR\DATA
      # Data_Old = CCPR_READ_RDS_WITH_ALTERNATIVE (FileFrm = paste0(SData, 'ccpi_market_last_intraday.rds'), FileAlt=paste0(ODDrive,'R/CCPR/DATA/', 'ccpi_market_last_intraday.rds')) [[1]]
      Data_Old = try ( CCPR_READRDS(SData,'ccpi_market_last_intraday.rds', ToRestore = T) )
      Data_Final = unique(rbind( Data_Old,Data_Finalx,fromLast = T, fill=T), by=c('code', 'datetime'))
      # saveRDS(Data_Final, paste0(SData, 'ccpi_market_last_intraday.rds'))
      Data_Final[, updated := SYS.TIME()]
      if (!'updated' %in% names (Data_Final)) { Data_Final[, updated := SYS.TIME()]  }
      CCPR_SAVERDS (Data_Final, SData,'ccpi_market_last_intraday.rds' , SaveOneDrive=T, ToSummary = T)
    } else {
      if (!'updated' %in% names (Data_Finalx)) { Data_Finalx[, updated := SYS.TIME()]  }
      if ('timestamp' %in% names (Data_Finalx)) { Data_Finalx = Data_Finalx [!is.na(timestamp)] }
      CCPR_SAVERDS (Data_Finalx, SData,'ccpi_market_last_intraday.rds' , SaveOneDrive=T, ToSummary = T)
      
      
    }
    
    My.Kable.TB(Data_Finalx[order(-datetime_vn)][, .(slider, code, name, datetime_vn, close)])
    # My.Kable(Data_Final[order(-datetime_vn, code) & (slider == 1)][, .(slider, code, name, datetime_vn, close)])
    # saveRDS(Data_Final, paste0(SData, 'ccpi_market_last_intraday.rds'))
    
    Data_Final_Day = unique(Data_Finalx[order(code, -datetime)][!is.na(close)], by=c('code', 'date'))[order(code, date)]
    Data_Final_Day = Data_Final_Day[, ":="(pclose=shift(close), change=close-shift(close), varpc=100*((close/shift(close))-1)), by='code'][order(code, -date)]
    
    Data_Final_Last = unique(Data_Final_Day, by='code')[, .(slider, type, code, name, date, datetime, datetime_vn, tz, tzoffset, last=close,
                                                            previous = pclose, change, varpc, timestamp=paste(datetime, tz), cur,continent,country)]
    
    Data_Qoute_Slider = Data_Final_Last[slider == 1,.(type, code, name, date, datetime, datetime_vn, tz, tzoffset ,
                                                      last, previous, change, varpc, timestamp, cur, updated = substr (as.character (Sys.time()),1,16))]
    
    My.Kable.All(Data_Qoute_Slider)
    if (!'updated' %in% names (Data_Qoute_Slider)) { Data_Qoute_Slider[, updated := SYS.TIME()]  }
    # saveRDS(Data_Qoute_Slider, paste0(SData, 'ccpi_quote_slider.rds'))
    
    CCPR_SAVERDS (Data_Qoute_Slider, SData,'ccpi_quote_slider.rds' , SaveOneDrive=T, ToSummary = T)
    # x = CCPR_READRDS (SData,'ccpi_quote_slider.rds')
    # str (x)
    
    Data_Final_Last = Data_Final_Last[order(continent, country)]  
    # Data_Final_Day[order(continent, country)] 
    My.Kable.All(Data_Final_Last)
    
    if (!'updated' %in% names (Data_Final_Last)) { Data_Final_Last[, updated := substr ( as.character (Sys.time()),1,16)]  }
    # saveRDS(Data_Final_Last, paste0(SData, 'ccpi_market_last.rds'))
    CCPR_SAVERDS (Data_Final_Last, SData, 'ccpi_market_last.rds', ToSummary = T)
    My.Kable.All(Data_Final_Last)
    
    end.time = Sys.time()
    
    
    x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_REPORT_PRICES_DAILY>DOWNLOAD'), pAction="SAVE", NbSeconds=0, ToPrint = T))
    
    print ( paste('DOWNLOAD DURATION = ',  difftime(end.time, start.time, units = 'sec') ) )
  }
  
  if (ToUpload) {
    start.time = Sys.time()
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host =pHost, l.tablename='ccpi_market_last_intraday',
                                     l.filepath= tolower(paste0(SData, 'ccpi_market_last_intraday.rds')),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    CATln_Border( paste( 'UPLOADING: ', 'ccpi_market_last_intraday' , pHost))
    
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename='ccpi_quote_slider',
                                     l.filepath= tolower(paste0(SData, 'ccpi_quote_slider.rds')),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    CATln_Border( paste( 'UPLOADING: ', 'ccpi_quote_slider' , pHost))
    
    # CCPR_SAVERDS (Data_Final_Last, SData,'ccpi_quote_slider.rds' , SaveOneDrive=T)
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename='ccpi_market_last',
                                     l.filepath= tolower(paste0(SData, 'ccpi_market_last.rds')),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
    CATln_Border( paste( 'UPLOADING: ', 'ccpi_market_last' , pHost))
    
    end.time = Sys.time()
    
    
    x = try(TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption=paste('TRAINEE_REPORT_PRICES_DAILY>UPLOAD'), pAction="SAVE", NbSeconds=0, ToPrint = T))
    
    print ( paste('UPLOAD DURATION = ',  difftime(end.time, start.time, units = 'sec') ) )
  }
  
  
  
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_SHARES = function(pCode = 'AAPL'){
  # ------------------------------------------------------------------------------------------------
  library(xml2)
  Final_data = data.table()
  pURL = paste0("https://finance.yahoo.com/quote/", pCode, "/key-statistics")
  
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/','yahoo_stat.txt'), ToDeleteTemp = T)
  content    = try(rvest::read_html(xweb))
  
  float_value = html_nodes(content, 
                           xpath = '//*[@id="nimbus-app"]/section/section/section/article/article/div/section[2]/div/section[2]/table/tbody/tr[5]/td[2]')
  value = xml_text(float_value)
  float = TRAINEE_CONVERT_NUMBER(as.vector(value))
  
  sharesout_value = html_nodes(content, 
                               xpath = '//*[@id="nimbus-app"]/section/section/section/article/article/div/section[2]/div/section[2]/table/tbody/tr[3]/td[2]')
  
  value_s = xml_text(sharesout_value)
  sharesout = TRAINEE_CONVERT_NUMBER(as.vector(value_s))
  
  library(quantmod)
  what_metrics <- yahooQF(c("Market Capitalization"))
  
  metrics <- tryCatch({
    getQuote(paste(pCode, sep="", collapse=";"), what=what_metrics)
  }, error = function(e) {
    return(NULL)
  })
  
  market_cap = metrics$`Market Capitalization`
  
  Final_data = data.table(codesource = pCode, share_outstanding = sharesout, float = float, market_cap = market_cap)
  My.Kable.All(Final_data)
  return(Final_data)
}


# ==================================================================================================
# TRAINEE_DOWNLOAD_YAH_PRICES_ALL_BY_CODE = function (pCode='IBM', NB_Day = 100000) {
# 
#   # pCode = 'BTC-USD'
#   # NB_Day = 10
#   xData = data.table()
#   xData_shares = data.table()
#   xData_prices   = CHECK_CLASS(try(DOWNLOAD_YAH_INS_PRICES_UNADJ(p_nbdays_back= NB_Day, tickers=pCode, freq.data='daily', p_saveto="", NbTry=15)))
#   if ('STK' %in% unique(xData_prices$type)){
#     xData_shares   = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_SHARES (pCode=pCode)))
#   }
#   xData_dividend = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_DIVIDEND  ( pCode = pCode,  Nbdays = NB_Day,
#                                                                     silent = T, ToKable = T)))
#   str(xData_dividend)
#   if (nrow(xData_prices) > 0 & nrow(xData_shares)> 0 )
#   {
#     xData = merge(xData_prices, xData_shares[,. (codesource, market_cap, share_outstanding, float)], by = c ('codesource'), all.x = T)
#     names(xData)[names(xData) == "name"] <- "company_name"
#     if (nrow(xData_dividend) > 0)
#     {
#       xData = merge(xData, xData_dividend[,. (date=ref_date, codesource, dividend)], by = c("codesource", "date"), all.x = T)
#     }else{
#       xData[, dividend := NA]
#     }
#   } else {
#     xData = xData_prices
#   }
# 
#   pURL = paste0("https://finance.yahoo.com/quote/",pCode,"/")
#   xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/','yahoo_stat.txt'), ToDeleteTemp = T)
#   content    = try(rvest::read_html(xweb))
# 
#   if (!'market_cap' %in% names(xData)){
#     capi_value = html_nodes(content,
#                             xpath = '//*[@id="nimbus-app"]/section/section/section/article/div[2]/ul/li[9]/span[2]')
#     value = xml_text(capi_value)
#     capi1Day = TRAINEE_CONVERT_NUMBER(as.vector(value))
#     if (!is.na(capi1Day)){
#       xData[, market_cap := capi1Day]
#     } else {
#       capi_value = html_nodes(content,
#                               xpath = '//*[@id="nimbus-app"]/section/section/section/article/div[2]/ul/li[7]/span[2]/fin-streamer')
#       value = trimws(xml_text(capi_value))
#       capi1Day = TRAINEE_CONVERT_NUMBER(as.vector(value))
#       xData[, market_cap := capi1Day]
#     }
# 
#   }
# 
#   cur_text = html_nodes(content,
#                    xpath = '//*[@id="nimbus-app"]/section/section/section/article/section[1]/div[1]/span/span[2]')
#   xData[, cur := xml_text(cur_text)]
# 
#   xData = xData[order(codesource, date)]
#   xData[is.na(rt), rt := 0, by = "codesource"]
#   xData[, rt_1:= 1 + rt]
#   xData[, cumul := rt_1[1] * cumprod(rt_1), by = "codesource"]
#   xData[, capi := market_cap[.N] * cumul / cumul[.N], by = "codesource"]
#   xData[, ':=' (rt_1 = NULL, cumul = NULL)]
#   xData[cur == 'USD', capiusd := capi]
#   xData[, close_unadj := close]
# 
# 
#   DATA_ALL = xData
#   #download_all_board <- readRDS("S:/R/DATA/BOARD/download_all_board.rds")
#   #DATA_ALL = merge(DATA_ALL, download_all_board[,. (codesource, name, title, first_name, last_name, ceo, cob, gender)], by = 'codesource', all.x = T)
#   if (nrow(DATA_ALL)>0)
#   {
#     DATA_ALL = MERGE_DATASTD_BYCODE(DATA_ALL, pOption = 'FINAL')
#     My.Kable.TB(DATA_ALL)
#   }
#   return(DATA_ALL)
# }


# # ==================================================================================================
# TRAINEE_GET_FLOAT_SHARE = function(pCode="1518.T", ToPrint=T){
#   # ------------------------------------------------------------------------------------------------
#   Final_Data = data.table()
#   pURL       = paste0("https://finance.yahoo.com/quote/", pCode, "/key-statistics")
#   CATln_Border(pURL)
#   response   = GET(pURL, add_headers(
#     `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
#     ,`Accept-Language`= "en-US,en;q=0.5"
#   ))
#   float_shares      = as.numeric(NA)
#   xweb       = content(response, as="text")
#   content    = try(rvest::read_html(xweb))
#   dataTXT    = content(response, as="text")
#   # writeLines(dataTXT, 'c:/temp/yah.txt')
#   
#   if (grepl('Float', dataTXT))
#   {
#     # <td class="label svelte-vaowmx">Float <sup>8</sup> </td> <td class="value svelte-vaowmx">915.2M</td> </tr>
#     value = str.extract(dataTXT, 'Float <sup>8</sup>', '</td> </tr>')
#     value = word(value,3,3,'>')
#     float_shares = TRAINEE_CONVERT_NUMBER(as.vector(value))
#     if (ToPrint) { CATln_Border(paste('TRAINEE_GET_FLOAT_SHARE of', pCode, '=', float_shares)) }
#   }
#   # Final_Data = data.table(source='YAH', codesource=pCode, date=Sys.Date(), float=float_shares, updated=substr(as.character(Sys.time()),1,19))
#   return(float_shares)
# }


# ==================================================================================================
MAINTENANCE_DASHBOARD = function (Action='', Minutes=5) {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-06-07 14:59
  switch(Action,
         'SCAN' = {
           List_Actions = setDT(fread('S:/STKVN/MAINTENANCE_ACTIONS.txt'))
           List_Actions = List_Actions[maintenance=='DASHBOARD']
           My.Kable.All(List_Actions)
           if (nrow(List_Actions)>0)
           {
             for (k in 1:nrow(List_Actions))
             {
               # k = 1
               pAction = trimws(List_Actions[k]$action)
               pMinute = List_Actions[k]$minutes
               try(MAINTENANCE_DASHBOARD (Action=pAction, Minutes=pMinute))
             }
           }
         },
         
         'DASHBOARD_CCPI_MARKET_CHARTS' = {
           
           # TEST ---------------------------------------------------------------------------------------------  
           if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='DASHBOARD_CCPI_MARKET_CHARTS', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
           {
             
             DASHBOARD_CCPI_MARKET_CHARTS (phost = 'ccpi_dashboard', ToDownload = T, ToUpload = F, ToSave   = T) 
             DASHBOARD_CCPI_MARKET_CHARTS (phost = 'dashboard_live_bat', ToDownload = T, ToUpload = F, ToSave   = T) 
             DASHBOARD_CCPI_MARKET_CHARTS (phost = 'ccpi_dashboard', ToDownload = F, ToUpload = T, ToSave   = F) 
             DASHBOARD_CCPI_MARKET_CHARTS (phost = 'dashboard_live_bat', ToDownload = F, ToUpload = T, ToSave   = F) 
             x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='DASHBOARD_CCPI_MARKET_CHARTS', pAction="SAVE",    NbSeconds=0, ToPrint=F)
           } else { CATln_Border(paste('DASHBOARD_CCPI_MARKET_CHARTS :', 'SKIP')) }
           
           # TEST (End) ---------------------------------------------------------------------------------------
           
         },
         'UPDATE_UPLOAD_CCPR_MARKET_LAST' = {
           # MAINTENANCE_DASHBOARD (Action='UPDATE_UPLOAD_CCPR_MARKET_LAST', Minutes=5) 
           
           if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='UPDATE_UPLOAD_CCPR_MARKET_LAST', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
           {
             # TRAINEE_UPDATE_UPLOAD_CCPR_MARKET_LAST (UData='S:/CCPR/DATA/', UList= paste0('S:/CCPR/DATA/', 'YAH/LIST/','LIST_YAH_MARKET_LAST.txt'),
             #                                         pSource = 'YAH',  xPeriod = '5m', toReset = F, pHost = 'ccpi_dashboard',
             #                                         ToDownload = T, ToUpload = T) 
             
             TRAINEE_UPDATE_UPLOAD_CCPR_MARKET_LAST (UData='S:/CCPR/DATA/', UList= paste0('S:/CCPR/DATA/', 'YAH/LIST/','LIST_YAH_MARKET_LAST.txt'),
                                                     pSource = 'YAH',  xPeriod = '5m', toReset = F, pHost = 'dashboard_live',
                                                     ToDownload = T, ToUpload = T)
             
             
             x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='UPDATE_UPLOAD_CCPR_MARKET_LAST', pAction="SAVE",    NbSeconds=0, ToPrint=F)
           } else { CATln_Border(paste('UPDATE_UPLOAD_CCPR_MARKET_LAST :', 'SKIP')) }
         },
         'UPDATE_UPLOAD_CCPR_MARKET_TABS' = {
           if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='UPDATE_UPLOAD_CCPR_MARKET_TABS', pAction="COMPARE", NbSeconds=Minutes*60, ToPrint=F))
           {
             
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'INDEXES', ToSave = T, ToUpload = T, pHost = 'dashboard_live') )
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'COMMODITIES', ToSave = T, ToUpload = T, pHost = 'dashboard_live')  )
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'FOREX', ToSave = T, ToUpload = T, pHost = 'dashboard_live') )
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CRYPTO', ToSave = T, ToUpload = T, pHost = 'dashboard_live') )
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CURRENCIES', ToSave = T, ToUpload = T, pHost = 'dashboard_live') )
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'STOCKS', ToSave = T, ToUpload = T, pHost = 'dashboard_live') )
             try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'IPO', ToDownload = T, ToSave = T, ToUpload = T, pHost = 'dashboard_live'))
             x = TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption='UPDATE_UPLOAD_CCPR_MARKET_TABS', pAction="SAVE",    NbSeconds=0, ToPrint=F)
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'INDEXES', ToSave = T, ToUpload = T, pHost = 'ccpi_dashboard') )
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'COMMODITIES', ToSave = T, ToUpload = T, pHost = 'ccpi_dashboard')  )
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'FOREX', ToSave = T, ToUpload = T, pHost = 'ccpi_dashboard') )
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CRYPTO', ToSave = T, ToUpload = T, pHost = 'ccpi_dashboard') )
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'CURRENCIES', ToSave = T, ToUpload = T, pHost = 'ccpi_dashboard') )
             # try(TRAINEE_DOWNLOAD_MARKET_CUSTOM (pOption = 'STOCKS', ToSave = T, ToUpload = T, pHost = 'ccpi_dashboard') )
           } else { CATln_Border(paste('UPDATE_UPLOAD_CCPR_MARKET_TABS :', 'SKIP')) }
         }
  )
}

# ==================================================================================================


# TRAINEE_REPORT_PRICES_DAILY = function (File_Folder = 'S:/STKVN/PRICES/DAY/', 
#                                         LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC', 'HSX')) {
#   
#   
#   #File_Folder = 'S:/STKVN/PRICES/DAY/'
#   #LIST_SOURCES = list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC', 'HSX')
#   
#   LastTrading = CCPR_LAST_TRADING_DAY_VN( hour(Sys.time()), ToPrompt = T)
#   DBL_RELOAD_INSREF()
#   DATA_ALL_DAY = data.table()
#   DATA_ALL_SHARES_DAY = data.table()
#   xList_day = list()
#   xList_shares = list()
#   for (k in 1:length(LIST_SOURCES))
#   {
#     # k = 6
#     pSource     = LIST_SOURCES[[k]]
#     File_day_Name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
#     CATln_Border(File_day_Name)
#     File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_day_Name, ToKable = T)))
#     My.Kable(File_Data_Day)
#     
#     if ( nrow (File_Data_Day) > 0) 
#     {
#       File_Data_Day[, K := k]
#       File_Data_Day[, updated := as.character(updated)]
#       xList_day[[k]] = File_Data_Day
#     }
#   }
#   
#   
#   
#   for (k in 1:length(LIST_SOURCES)) 
#   {
#     
#     pSource     = LIST_SOURCES[[k]]
#     File_shares_name   = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
#     CATln_Border(File_shares_name)
#     File_Shares_Day = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_shares_name, ToKable = T)))
#     
#     if ( nrow (File_Shares_Day) > 0 ) 
#     {
#       File_Shares_Day[, K := k]
#       xList_shares[[k]] = File_Shares_Day
#     }
#   }
#   
#   DATA_ALL_SHARES_DAY = rbindlist(xList_shares, fill = T)
#   
#   LIST_MARKET = CCPR_READRDS('S:/STKVN/PRICES/DAY/', 'final_stkvn_market_day.rds')
#   
#   DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('market')], LIST_MARKET[,. (code, market = value)], all.x = T, by = 'code')
#   DATA_ALL_SHARES_DAY = DATA_ALL_SHARES_DAY[nchar(code) == 8]
#   max_date = max(DATA_ALL_SHARES_DAY$date)
#   DATA_ALL_SHARES_DAY = unique(DATA_ALL_SHARES_DAY[date == max_date], by = 'code')
#   
#   
#   DBL_RELOAD_INSREF()
#   
#   
#   
#   
#   DATA_ALL_SHARES_DAY = merge(DATA_ALL_SHARES_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
#   
#   DATA_ALL_DAY_REPORT = DATA_ALL_SHARES_DAY[, .(source , market)]
#   report_shares = setDT(spread(DATA_ALL_DAY_REPORT[,.(n=.N), by=c('source', 'market')], key='source', value='n'))[market!='HSXHNX', nr:=0][market=='HSXHNX', nr:=1][, date := LastTrading ][order(nr, market)][, ':='( updated = substr(Sys.time(),1,19) ,data = 'SHARES')]
#   
#   DATA_SHARES_DATE = rbind(DATA_ALL_SHARES_DAY[, .(source , market, date)], DATA_ALL_SHARES_DAY[ market %in% list('HNX', 'HSX')][, .(source , market = 'HSXHNX'), date])
#   DATA_SHARES_DATE = unique(DATA_SHARES_DATE, by = c('source', 'market', 'date'))[, LastTrading := LastTrading]
#   report_shares_date =  setDT(spread(DATA_SHARES_DATE[, .(n = as.numeric(date - LastTrading)), by = .(source, market, date)], key = 'source', value = 'n'))[, ':='( updated = substr(Sys.time(),1,19) ,data = 'SHARES')]
#   CCPR_SAVERDS(report_shares,'S:/STKVN/PRICES/DAY/', 'report_day_sources_shares_number.rds')
#   CCPR_SAVERDS(report_shares,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_shares_number.rds')
#   CCPR_SAVERDS(report_shares_date,'S:/STKVN/PRICES/DAY/', 'report_day_sources_shares_date.rds')
#   CCPR_SAVERDS(report_shares_date,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_shares_date.rds')
#   
#   DATA_ALL_DAY = rbindlist(xList_day, fill = T)
#   
#   #clean
#   DATA_ALL_DAY[market == 'UPCOM', market := 'UPC']
#   DATA_ALL_DAY[market == 'HOSE', market := 'HSX']
#   DATA_ALL_DAY[, ticker:= gsub('[*]', '', ticker)]
#   DATA_ALL_DAY[, code := paste0('STKVN', ticker)]
#   DATA_ALL_DAY[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
#   DATA_ALL_DAY[!is.na(reference) & volume == 0, last := reference]
#   DATA_ALL_DAY[volume == 0, close := last]
#   DATA_ALL_DAY[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
#   DATA_ALL_DAY = merge(DATA_ALL_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
#   DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
#   
#   
#   DATA_ALL_DATE = rbind(DATA_ALL_DAY[, .(source , market, date, updated)], DATA_ALL_DAY[ market %in% list('HNX', 'HSX')][, .(source , market = 'HSXHNX', updated ), date])
#   
#   DATA_ALL_DATE = unique(DATA_ALL_DATE[order(source, market, -date)], by = c('source', 'market'))[, LastTrading := LastTrading]
#   max_date = unique(DATA_ALL_DATE[order(market, - date)][,. (market, date)], by = 'market')
#   DATA_ALL_DATE = merge(DATA_ALL_DATE, max_date[,. (market, max_date = date)], by = "market", all.x = TRUE)
#   DATA_ALL_DATE = DATA_ALL_DATE[date == max_date, ]
#   
#   DATA_ALL_DATE [, n := as.character(date - LastTrading)]
#   DATA_ALL_DATE [n == 0, n := substr(updated, 12, 16)]
#   
#   report_date = setDT(spread(DATA_ALL_DATE[, .(n), by = .(source, market, date)], key = 'source', value = 'n'))[, ':='( updated = substr(Sys.time(),1,19) ,data = 'PRICESBOARD')]
#   My.Kable.All(report_date)
#   
#   My.Kable.All(report_date)
#   CCPR_SAVERDS(report_date,'S:/STKVN/PRICES/DAY/', 'report_day_sources_pricesboard_date.rds')
#   CCPR_SAVERDS(report_date,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_pricesboard_date.rds')
#   
#   DATA_ALL_NUMBER = DATA_ALL_DAY[ date == LastTrading]
#   DATA_ALL_NUMBER_REPORT = rbind(DATA_ALL_NUMBER[, .(source , market, date)], DATA_ALL_NUMBER[ market %in% list('HNX', 'HSX')][, .(source , market = 'HSXHNX'), date])
#   report_number = setDT(spread(DATA_ALL_NUMBER_REPORT[,.(n=.N), by=c('source', 'market')], key='source', value='n'))[market!='HSXHNX', nr:=0][market=='HSXHNX', nr:=1][order(nr, market)][, ':='(date = LastTrading,  updated = substr(Sys.time(),1,19) ,data = 'PRICESBOARD')]
#   My.Kable.All(report_number)
#   CCPR_SAVERDS(report_number,'S:/STKVN/PRICES/DAY/', 'report_day_sources_pricesboard_number.rds')
#   CCPR_SAVERDS(report_number,'S:/SHINY/STKVN/REPORT_PRICESBOARD/', 'report_day_sources_pricesboard_number.rds')
#   try(TRAINEE_CONVERT_RDS_TO_FST (file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"))
#   
# }


# ==================================================================================================
TRAINEE_INFO_TO_SHARES = function(pSource='HNX', IntegrateHistory = F)  {
  # ------------------------------------------------------------------------------------------------
  # pSource='UPC'
  # pSource='HNX'
  if (file.exists('U:/'))
  {
    LastTrading       = CCPR_LAST_TRADING_DAY_VN(max(9, as.numeric(substr(Sys.time(),12,13))), ToPrompt = T)
    # trainee_downlad_hnx_stkvn_ref_info_by_code_20240422.rds
    FileName_YYYYMMDD = paste0('trainee_download_', pSource, '_stkvn_ref_info_by_code_', gsub('-','', LastTrading), '.rds')
    CATln_Border(FileName_YYYYMMDD)
    # FileName_YYYYMMDD = paste0('download_', pSource, '_pricesboard_', gsub('-','', LastTrading), '.rds')
    x                 = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', FileName_YYYYMMDD, ToKable = F)))
    My.Kable(x)
    if (nrow(x)>0)
    {
      x = x[!is.na(code)]
      UPDATE_UPDATED (x)
      # if ('updated' %in% names(x)) { x[, updated:=as.character(updated)]}
      if ('close' %in% names(x)) { x[, close:=as.numeric(close)]}
      My.Kable(x)
      FileName_SHARES   = paste0('download_', pSource, '_stkvn_shares_day.rds')
      CCPR_SAVERDS(x, UData, FileName_SHARES, ToSummary = T, SaveOneDrive = T)
      if (IntegrateHistory)
      {
        FileName_HST   = paste0('download_', pSource, '_stkvn_shares_history.rds')
        CATln_Border(FileName_HST)
        History        = CHECK_CLASS(try(CCPR_READRDS(UData, FileName_HST, ToKable = T)))
        History        = unique(rbind(History, x, fill=T)[!is.na(code) & !is.na(date)], by=c('code', 'date'), FromLast = T)
        My.Kable(History[order(date, code)])
        CCPR_SAVERDS(History, UData, FileName_HST, ToSummary = T, SaveOneDrive = T)
      }
    }
  }
}

# ==============================================================================
TRAINEE_IFRC_SLEEP = function(NbSeconds)  {
  # ----------------------------------------------------------------------------
  # IFRC_SLEEP(NbSeconds=20)
  # time1 = Sys.time()
  for (i in NbSeconds:1)
  {
    # i=2; NbSeconds = 10
    CATrp(paste("TIMER = ", FormatNS(i,0,10), FormatNS(NbSeconds,0,10)))
    Sys.sleep(1)
  }
  # CATln(Sys.time()-time1)
  CATrp("")
}

# ==================================================================================================
TRAINEE_CCPR_SUMMARY_DATE_COMPARE_UPDATES_PERCENT_BY_CODE = function(Folder_Fr=UData, Folder_To=UData, 
                                                                     File_Fr='efrc_stkworld_forindex.rds', File_To='efrc_stktop1000_forindex.rds', MinPercent=1, EchoOn=F) {
  # ------------------------------------------------------------------------------------------------
  # Updated = 2022-03-30
  # EchoOn=T
  # Folder_Fr=UData; Folder_To=UData
  # File_Fr='download_rts_ind_history.rds'; File_To='download_rts_indin_history.rds'; MinPercent=1; EchoOn=F
  Sum.Quality = 0
  Decision = F
  Sum.From = try(DATACENTER_LOAD_TEXTFILE(Folder_Fr, gsub('.rds', '_summary.txt', tolower(File_Fr))))
  Sum.To   = try(DATACENTER_LOAD_TEXTFILE(Folder_To, gsub('.rds', '_summary.txt', tolower(File_To))))
  if ( all(class(Sum.From)!='try-error') & all(class(Sum.To)!='try-error'))
  {
    # if (max(Sum.From$date) > max(Sum.To$date))
    # {
    #   # Sum.Quality = 100
    # } else {
    Sum.From = unique(Sum.From, by='code')
    Sum.To   = unique(Sum.To, by='code')
    
    if (nrow(Sum.From)>0 & nrow(Sum.To)>0)
    {
      DateFrom = max(Sum.From[!is.na(date)]$date)
      DateTo   = max(Sum.To[!is.na(date)]$date)
      
      Sum.To   = merge(Sum.To[, -c('date_from')], Sum.From[, .(code, date_from=date)], all.x=T, by='code') # add date_from to Sum_To
      Sum.ToFr = Sum.To[!is.na(date_from)]
      # Sum.ToFr = MERGE_DATASTD_BYCODE(Sum.ToFr)
      if (EchoOn) { My.Kable.MaxCols(Sum.ToFr) }
      Sum.Quality = 100*nrow(Sum.To[date<as.Date(substr(date_from,1,10))])/nrow(Sum.To) # Updated %
      
      Condition_Date    = max(Sum.ToFr[!is.na(date_from)]$date_from)>max(Sum.ToFr[!is.na(date)]$date)
      Condition_Percent = Sum.Quality > MinPercent
      
      DateToFr   = max(Sum.ToFr[!is.na(date)]$date)
      
      # CATln(paste("QUALITY UPDATE TODO : ", File_Fr, ">", File_To, "=", Format.Number(Sum.Quality,2), '%', DateFrom, "/", DateTo, DateToFr), top_border = T, p_border=T)
      Decision = Condition_Date | Condition_Percent
      CATln('')
      CATln_Border(paste("QUALITY UPDATE TODO : ", File_Fr, ">", File_To, "=", Format.Number(Sum.Quality,2), '%', DateFrom, "/", DateTo, DateToFr, '>>> TODO =', Decision))
    } else { Sum.Quality = 0 }
    # }
  } 
  return(Decision)
}

# ==================================================================================================
TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES = function(File_Folder = UData, File_Fr = 'EFRC_CUR_HISTORY.RDS', 
                                                  File_To = 'EFRC_CUR_HISTORY_1M.RDS', RemoveNA = T, NbDays = 31, pCondition = '') {
  # ------------------------------------------------------------------------------------------------
  GC_SILENT()
  DATACENTER_LINE_BORDER_BEGINEND(paste('IFRC_CCPR_INTEGRATION_BY_FILES to :',File_To), 'BEGIN')
  Data_Fr     = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Fr, ToKable = T, ToRestore = T)))
  if (nrow(Data_Fr)>0)
  {
    if (File_Fr != File_To)
    {
      Data_To     = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_To, ToKable = T, ToRestore = T)))
    } else { Data_To =  data.table()}
    Data_To     = rbind(Data_To, Data_Fr, fill=T)
    My.Kable.Min(Data_To)
    if (nrow(Data_To)>0)
    {
      Data_To = unique(Data_To, by=c('code', 'date'))[order(code, date)]
      if (RemoveNA) { Data_To = Data_To[!is.na(code) & !is.na(date)]}
      if (NbDays!=0)
      {
        # Data_To[, x.maxdate:=max(date), by='code']
        Data_To = Data_To[order(code, -date)]
        Data_To[, x.nr:=seq.int(1,.N), by='code']
        
        Data_To = Data_To[x.nr<=NbDays]
        Data_To = Data_To[order(code, date)]
        Data_To$x.nr = NULL
      }
      Data_To = MERGE_DATASTD_BYCODE(Data_To, pOption='FINAL')[!is.na(date) & date>="1800-01-01" & date<="2099-12-31"]
      if (nchar(pCondition)>0) {  Data_To = Data_To[eval(parse(text = pCondition))] }
      Data_To[type!='STK', close_adj:=close]
      Data_To[type!='STK' & !is.na(rt), rt:=(close/shift(close))-1, by='code']
      CATln_Border("MERGED DATA")
      My.Kable.Min(Data_To[order(date)])
    }
    if (nrow(Data_To)>0)
    {
      try(CCPR_SAVERDS(Data_To, File_Folder, File_To, ToKable = T, ToSummary = T, SaveOneDrive = T))
    }
  }
  DATACENTER_LINE_BORDER_BEGINEND(paste('IFRC_CCPR_INTEGRATION_BY_FILES to :',File_To), 'END')
  GC_SILENT()
}

# ==================================================================================================
TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY = function(File_Folder = UData, File_Fr = 'EFRC_CUR_HISTORY.RDS', File_To = 'EFRC_CUR_HISTORY_1M.RDS', 
                                                          RemoveNA = T, NbDays = 31, pCondition = '', MinPercent = 1, ToForce = F) {
  # ------------------------------------------------------------------------------------------------
  
  try(GC_SILENT())
  DATACENTER_LINE_BORDER_BEGINEND(paste('IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY to :',File_To), 'BEGIN')
  
  TO_DO = try(TRAINEE_CCPR_SUMMARY_DATE_COMPARE_UPDATES_PERCENT_BY_CODE(Folder_Fr = File_Folder, Folder_To = File_Folder, 
                                                                        File_Fr   = File_Fr, 
                                                                        File_To   = File_To, MinPercent = MinPercent, EchoOn = F))
  if (ToForce || TO_DO)
  {
    TRAINEE_IFRC_SLEEP(2)
    try(TRAINEE_IFRC_CCPR_INTEGRATION_BY_FILES(File_Folder = File_Folder, File_Fr = File_Fr, File_To = File_To, 
                                               RemoveNA = RemoveNA, NbDays = NbDays, pCondition = pCondition))
    try(GC_SILENT())
  }
  DATACENTER_LINE_BORDER_BEGINEND(paste('IFRC_CCPR_INTEGRATION_BY_FILES_QUALITY to :',File_To), 'END')
  try(GC_SILENT())
}

# ==================================================================================================
TRAINEE_OPEN_PRICES_DAILY = function (File_Folder = 'S:/STKVN/PRICES/DAY/', 
                                      LIST_SOURCES = list('HSX', 'HNX', 'UPC', 'VND', 'MBS', 'VPS','TVSI','BSC','VST', 'C68')) {
  # ------------------------------------------------------------------------------------------------
  # File_Folder = 'S:/STKVN/PRICES/DAY/'
  # LIST_SOURCES =  list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC')
  DATA_OPEN   = data.table()
  LastTrading = CCPR_LAST_TRADING_DAY_VN( hour(Sys.time()), ToPrompt = T)
  DBL_RELOAD_INSREF()
  
  LIST_SOURCES_SHARES = list('HSX', 'HNX', 'UPC')
  xList_day = list()
  
  for (k in 1:length(LIST_SOURCES_SHARES))
  {
    # k = 11
    pSource     = LIST_SOURCES_SHARES[[k]]
    File_pricesboard_name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    # File_shares_name        = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
    CATln_Border(File_pricesboard_name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_pricesboard_name, ToKable = T)))
    if ( nrow (File_Data_Day) > 0 ) 
    {
      File_Data_Day[, K := k]
      UPDATE_UPDATED (File_Data_Day)
      # if ('updated' %in% names(File_Data_Day))  { File_Data_Day[, updated:= substr (as.character(Sys.time()),1,19)]}
      # if (!'updated' %in% names(File_Data_Day)) { File_Data_Day[, updated:= substr (as.character(Sys.time()),1,19)]}
      # if(nrow(File_Shares_Day) > 0) {    File_Data_Day = merge(File_Data_Day, File_Shares_Day[,. (code, sharesout)], by = 'code', all.x = T)}
      xList_day[[k]] = File_Data_Day
    }
  }
  DATA_REF_DAY = rbindlist(xList_day, fill = T)
  My.Kable(DATA_REF_DAY)
  
  xList_day = list()
  for (k in 1:length(LIST_SOURCES_SHARES))
  {
    # k = 1
    # k = 2
    # k = 3
    pSource     = LIST_SOURCES_SHARES[[k]]
    # File_pricesboard_name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    File_shares_name        = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
    CATln_Border(File_shares_name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_shares_name, ToKable = F)))
    if ( nrow (File_Data_Day) > 0 ) 
    {
      File_Data_Day[, K := k]
      if (pSource=='UPC') { File_Data_Day[, source:='UPC']}
      My.Kable.TB(File_Data_Day)
      # if(nrow(File_Shares_Day) > 0) {    File_Data_Day = merge(File_Data_Day, File_Shares_Day[,. (code, sharesout)], by = 'code', all.x = T)}
      xList_day[[k]] = File_Data_Day
    }
  }
  DATA_SHARES_DAY = rbindlist(xList_day, fill = T)
  My.Kable(DATA_SHARES_DAY)
  
  DATA_ALL_REF = merge(DATA_REF_DAY[, -c('sharesout', 'shareslis')], DATA_SHARES_DAY[, .(code, sharesout, shareslis)], all.x=T, by='code')
  My.Kable(DATA_ALL_REF[order(code)])
  dataset = 'shares'
  UPDATE_UPDATED (DATA_ALL_REF)
  # if (!'updated' %in% names(DATA_ALL_REF)) { DATA_ALL_REF[, updated:= substr (as.character(Sys.time()),1,19)]}
  My.Kable(DATA_ALL_REF[order(code)])
  
  CCPR_SAVERDS(DATA_ALL_REF, 'S:/STKVN/PRICES/DAY/', paste0('final_stkvn_',dataset,'_day.rds'))
  # >>>
  
  DATA_ALL_DAY = data.table()
  xList_day = list()
  
  for (k in 1:length(LIST_SOURCES))
  {
    # k = 2
    pSource     = LIST_SOURCES[[k]]
    File_pricesboard_name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    File_shares_name        = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
    CATln_Border(File_pricesboard_name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_pricesboard_name, ToKable = T)))
    CATln_Border(File_shares_name)
    File_Shares_Day = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_shares_name, ToKable = T)))
    
    if ( nrow (File_Data_Day) > 0 ) 
    {
      File_Data_Day[, K := k]
      UPDATE_UPDATED (File_Data_Day)
      # if(nrow(File_Shares_Day) > 0) {    File_Data_Day = merge(File_Data_Day, File_Shares_Day[,. (code, sharesout)], by = 'code', all.x = T)}
      xList_day[[k]] = File_Data_Day
    }
  }
  DATA_ALL_DAY = rbindlist(xList_day, fill = T)
  # str(xList_day[[2]])
  #clean
  DATA_ALL_DAY[market == 'UPCOM', market := 'UPC']
  DATA_ALL_DAY[market == 'HOSE', market := 'HSX']
  DATA_ALL_DAY[, ticker:= gsub('[*]', '', ticker)]
  DATA_ALL_DAY[, code := paste0('STKVN', ticker)]
  DATA_ALL_DAY[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
  DATA_ALL_DAY[!is.na(reference) & volume == 0, last := reference]
  DATA_ALL_DAY[volume == 0, close := last]
  DATA_ALL_DAY[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
  DATA_ALL_DAY = merge(DATA_ALL_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
  DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
  My.Kable(DATA_ALL_DAY)
  
  DATA_ALL_DAY = DATA_ALL_DAY[code %in% DATA_ALL_REF$code]
  # DATA_ALL_DAY[is.na(sharesout) | is.na(reference) | is.na(market)]
  
  #list_dataset = list('reference', 'market')
  list_dataset = list('reference', 'market')
  for (dataset in list_dataset) 
  {
    # dataset = 'reference'
    DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
    
    fields  = union(c('code', 'date'), dataset) 
    fields_source  = union(c('code', 'date', 'source'), dataset) 
    DATA_ALL_DATASET = DATA_ALL_DAY[, ..fields]
    DATA_ALL_DATASET_SOURCE = DATA_ALL_DAY[, ..fields_source]
    
    names(DATA_ALL_DATASET) = c('code', 'date', 'value')
    names(DATA_ALL_DATASET_SOURCE) = c('code', 'date', 'source', 'value')
    My.Kable(DATA_ALL_DATASET)
    
    data_final = unique(DATA_ALL_DATASET[, .(n=.N), b=c('code', 'value')][order(-n)], by='code')[,dataset:=dataset]
    data_final = data_final[nchar(code)==8]
    data_final_ok = data_final[n>1]
    data_final_nok = data_final[n==1]
    My.Kable(data_final_nok)
    My.Kable(data_final_ok)
    
    # print(as.vector(LIST_SOURCES))
    print(paste(LIST_SOURCES, collapse=" "))
    for (k in 1:length(LIST_SOURCES))
    {
      # k = 1
      SOURCE = LIST_SOURCES[[k]]
      DATA_NNA = DATA_ALL_DATASET_SOURCE[source==SOURCE & !is.na(value)]
      data_final_nok_source = data_final_nok[code %in% DATA_NNA$code] 
      if (nrow(data_final_nok_source)>0)
      {
        data_final_ok = rbind(data_final_ok, data_final_nok_source, fill=T)
        data_final_nok = data_final_nok[!code %in% DATA_NNA$code] 
      }
    }
    data_final_ok[, date := LastTrading]
    My.Kable(data_final_nok)
    My.Kable(data_final_ok)
    UPDATE_UPDATED (data_final_ok)
    # if (!'updated' %in% names(DATA_ALL_REF)) { DATA_ALL_REF[, updated:= substr (as.character(Sys.time()),1,19)] }
    CCPR_SAVERDS(data_final_ok, 'S:/STKVN/PRICES/DAY/', paste0('final_stkvn_',dataset,'_day.rds'))
  }
  
  DATA_REFERENCE =  CHECK_CLASS(try(CCPR_READRDS(File_Folder, paste0('final_stkvn_', 'REFERENCE','_day.rds'), ToKable = T)))
  DATA_OPEN = merge(DATA_ALL_REF[, .(code, codesource=ticker, ticker, date, sharesout, shareslis)],
                    DATA_REFERENCE[, .(code, date, reference=value)], all.x=T, by=c('code', 'date'))
  DATA_OPEN = merge(DATA_OPEN[, -c('market')], DATA_REF_DAY[, .(code, market)], all.x = T, by=c('code'))
  DATA_OPEN = MERGE_DATASTD_BYCODE(DATA_OPEN, pOption = 'FINAL')
  My.Kable(DATA_OPEN[, - c('continent', 'country')])
  
  UPDATE_UPDATED (DATA_OPEN)
  # if ('updated' %in% names(DATA_OPEN)) { DATA_OPEN[, updated:= as.character(updated)]}
  # if (!'updated' %in% names(DATA_OPEN)) { DATA_OPEN[, updated:= substr(as.character(Sys.time()),1,19)]}
  CCPR_SAVERDS(DATA_OPEN, File_Folder, 'STKVN_OPEN_MARKET.rds', ToSummary = T, SaveOneDrive = T)
  CCPR_SAVERDS(DATA_OPEN, 'S:/SHINY/STKVN/OPEN/', 'STKVN_OPEN_MARKET.rds', ToSummary = T, SaveOneDrive = T)
  return(DATA_OPEN)
}


# ==================================================================================================
TRAINEE_CLOSE_PRICES_DAILY = function (File_Folder = 'S:/STKVN/PRICES/DAY/', 
                                       LIST_SOURCES = list('HSX', 'HNX', 'UPC', 'VND', 'MBS', 'VPS','TVSI','BSC','VST', 'C68')) {
  # ------------------------------------------------------------------------------------------------
  # File_Folder = 'S:/STKVN/PRICES/DAY/'
  # LIST_SOURCES =  list('VND', 'MBS', 'VPS','TVSI', 'CAF', 'BSC','VST', 'C68', 'HNX', 'UPC')
  
  DATA_CLOSE = data.table()
  LastTrading = CCPR_LAST_TRADING_DAY_VN( hour(Sys.time()), ToPrompt = T)
  DBL_RELOAD_INSREF()
  
  LIST_SOURCES_SHARES = list('HSX', 'HNX', 'UPC')
  xList_day = list()
  
  for (k in 1:length(LIST_SOURCES_SHARES))
  {
    # k = 11
    pSource     = LIST_SOURCES[[k]]
    File_pricesboard_name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    # File_shares_name        = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
    CATln_Border(File_pricesboard_name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_pricesboard_name, ToKable = T)))
    if ( nrow (File_Data_Day) > 0 ) 
    {
      File_Data_Day[, K := k]
      UPDATE_UPDATED (File_Data_Day)
      # if ('updated' %in% names(File_Data_Day)) { File_Data_Day[, updated:=as.character(updated)]}
      
      # if(nrow(File_Shares_Day) > 0) {    File_Data_Day = merge(File_Data_Day, File_Shares_Day[,. (code, sharesout)], by = 'code', all.x = T)}
      xList_day[[k]] = File_Data_Day
    }
  }
  DATA_REF_DAY = rbindlist(xList_day, fill = T)
  My.Kable(DATA_REF_DAY)
  
  xList_day = list()
  for (k in 1:length(LIST_SOURCES_SHARES))
  {
    # k = 1
    # k = 2
    # k = 3
    pSource     = LIST_SOURCES_SHARES[[k]]
    # File_pricesboard_name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    File_shares_name        = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
    CATln_Border(File_shares_name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_shares_name, ToKable = F)))
    if ( nrow (File_Data_Day) > 0 ) 
    {
      File_Data_Day[, K := k]
      if (pSource=='UPC') { File_Data_Day[, source:='UPC']}
      My.Kable.TB(File_Data_Day)
      # if(nrow(File_Shares_Day) > 0) {    File_Data_Day = merge(File_Data_Day, File_Shares_Day[,. (code, sharesout)], by = 'code', all.x = T)}
      xList_day[[k]] = File_Data_Day
    }
  }
  DATA_SHARES_DAY = rbindlist(xList_day, fill = T)
  My.Kable(DATA_SHARES_DAY)
  
  DATA_ALL_REF = merge(DATA_REF_DAY[, -c('sharesout', 'shareslis')], DATA_SHARES_DAY[, .(code, sharesout, shareslis)], all.x=T, by='code')
  My.Kable(DATA_ALL_REF[order(code)])
  dataset = 'shares'
  CCPR_SAVERDS(DATA_ALL_REF, 'S:/STKVN/PRICES/DAY/', paste0('final_stkvn_',dataset,'_day.rds'))
  # >>>
  
  DATA_ALL_DAY = data.table()
  xList_day = list()
  
  for (k in 1:length(LIST_SOURCES))
  {
    # k = 11
    pSource     = LIST_SOURCES[[k]]
    File_pricesboard_name   = paste0('download_', tolower(pSource), '_pricesboard_day.rds')
    File_shares_name        = paste0('download_', tolower(pSource), '_stkvn_shares_day.rds')
    CATln_Border(File_pricesboard_name)
    File_Data_Day  = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_pricesboard_name, ToKable = T)))
    CATln_Border(File_shares_name)
    File_Shares_Day = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_shares_name, ToKable = T)))
    
    if ( nrow (File_Data_Day) > 0 ) 
    {
      File_Data_Day[, K := k]
      UPDATE_UPDATED (File_Data_Day)
      # if ('updated' %in% names(File_Data_Day)) { 
      #   x =  class(File_Data_Day$updated)
      #   if ( all(grepl ('POSIX', x) )) {
      #     File_Data_Day$updated = NULL
      #     File_Data_Day[, updated:= substr (as.character(Sys.time()),1,19)]
      #   }
      # }
      # 
      # if ('updated' %in% names(File_Data_Day)) { File_Data_Day[, updated:=as.character(updated)]}
      # if(nrow(File_Shares_Day) > 0) {    File_Data_Day = merge(File_Data_Day, File_Shares_Day[,. (code, sharesout)], by = 'code', all.x = T)}
      xList_day[[k]] = File_Data_Day
    }
  }
  DATA_ALL_DAY = rbindlist(xList_day, fill = T)
  # str(xList_day[[1]])
  #clean
  DATA_ALL_DAY[market == 'UPCOM', market := 'UPC']
  DATA_ALL_DAY[market == 'HOSE', market := 'HSX']
  DATA_ALL_DAY[, ticker:= gsub('[*]', '', ticker)]
  DATA_ALL_DAY[, code := paste0('STKVN', ticker)]
  DATA_ALL_DAY[!is.na(reference) & is.na(last) & is.na(volume), volume:=0]
  DATA_ALL_DAY[!is.na(reference) & volume == 0, last := reference]
  DATA_ALL_DAY[volume == 0, close := last]
  DATA_ALL_DAY[!is.na(reference) & is.na(volume) & !is.na(last) & last == reference, volume := 0]
  DATA_ALL_DAY = merge(DATA_ALL_DAY[, -c('name')], ins_ref[,. (name = short_name, code )], all.x = T, by = 'code')
  DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
  My.Kable(DATA_ALL_DAY)
  
  DATA_ALL_DAY = DATA_ALL_DAY[code %in% DATA_ALL_REF$code]
  # DATA_ALL_DAY[is.na(sharesout) | is.na(reference) | is.na(market)]
  
  #list_dataset = list('reference', 'market')
  list_dataset = list('reference', 'market', 'close', 'volume')
  for (dataset in list_dataset) 
  {
    DATA_ALL_DAY = unique(DATA_ALL_DAY[order(source, code, -updated)], by = c('source', 'code'))
    
    fields  = union(c('code', 'date'), dataset) 
    fields_source  = union(c('code', 'date', 'source'), dataset) 
    DATA_ALL_DATASET = DATA_ALL_DAY[, ..fields]
    DATA_ALL_DATASET_SOURCE = DATA_ALL_DAY[, ..fields_source]
    
    names(DATA_ALL_DATASET) = c('code', 'date', 'value')
    names(DATA_ALL_DATASET_SOURCE) = c('code', 'date', 'source', 'value')
    My.Kable(DATA_ALL_DATASET)
    
    data_final = unique(DATA_ALL_DATASET[, .(n=.N), b=c('code', 'value')][order(-n)], by='code')[,dataset:=dataset]
    data_final = data_final[nchar(code)==8]
    data_final_ok = data_final[n>1]
    data_final_nok = data_final[n==1]
    My.Kable(data_final_nok)
    My.Kable(data_final_ok)
    
    # print(as.vector(LIST_SOURCES))
    print(paste(LIST_SOURCES, collapse=" "))
    for (k in 1:length(LIST_SOURCES))
    {
      # k = 1
      SOURCE = LIST_SOURCES[[k]]
      DATA_NNA = DATA_ALL_DATASET_SOURCE[source==SOURCE & !is.na(value)]
      data_final_nok_source = data_final_nok[code %in% DATA_NNA$code] 
      if (nrow(data_final_nok_source)>0)
      {
        data_final_ok = rbind(data_final_ok, data_final_nok_source, fill=T)
        data_final_nok = data_final_nok[!code %in% DATA_NNA$code] 
      }
    }
    data_final_ok[, date := LastTrading]
    My.Kable(data_final_nok)
    My.Kable(data_final_ok)
    CCPR_SAVERDS(data_final_ok, 'S:/STKVN/PRICES/DAY/', paste0('final_stkvn_',dataset,'_day.rds'))
  }
  
  DATA_REFERENCE =  CHECK_CLASS(try(CCPR_READRDS(File_Folder, paste0('final_stkvn_', 'REFERENCE','_day.rds'), ToKable = T)))
  DATA_CLOSE     =  CHECK_CLASS(try(CCPR_READRDS(File_Folder, paste0('final_stkvn_', 'CLOSE','_day.rds'), ToKable = T)))
  DATA_VOLUME    =  CHECK_CLASS(try(CCPR_READRDS(File_Folder, paste0('final_stkvn_', 'VOLUME','_day.rds'), ToKable = T)))
  
  
  FINAL_CLOSE = merge(DATA_ALL_REF[, .(code, codesource=ticker, ticker, date, sharesout, shareslis)],
                      DATA_REFERENCE[, .(code, date, reference=value)], all.x=T, by=c('code', 'date'))
  FINAL_CLOSE = merge(FINAL_CLOSE,
                      DATA_CLOSE[, .(code, date, close=value)], all.x=T, by=c('code', 'date'))
  FINAL_CLOSE = merge(FINAL_CLOSE,
                      DATA_VOLUME[, .(code, date, volume=value)], all.x=T, by=c('code', 'date'))
  FINAL_CLOSE = merge(FINAL_CLOSE[, -c('market')], DATA_REF_DAY[, .(code, market)], all.x = T, by=c('code'))
  
  FINAL_CLOSE = MERGE_DATASTD_BYCODE(FINAL_CLOSE, pOption = 'FINAL')
  My.Kable(FINAL_CLOSE)
  
  UPDATE_UPDATED (FINAL_CLOSE)
  # if ('updated' %in% names(FINAL_CLOSE)) { FINAL_CLOSE[, updated:= as.character(updated)]}
  # if (!'updated' %in% names(FINAL_CLOSE)) { FINAL_CLOSE[, updated:= substr(as.character(Sys.time()),1,19)]}
  
  CCPR_SAVERDS(FINAL_CLOSE, File_Folder, 'STKVN_CLOSE_MARKET.rds', ToSummary = T, SaveOneDrive = T)
  CCPR_SAVERDS(FINAL_CLOSE, 'S:/SHINY/STKVN/CLOSE/', 'STKVN_CLOSE_MARKET.rds', ToSummary = T, SaveOneDrive = T)
  return(FINAL_CLOSE)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_PRICESBOARD_CAF = function (Source = 'CAF',
                                             Market = 'HNX',
                                             pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=')  {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:24
  DBL_RELOAD_INSREF()
  switch (Market,
          'HNX' = {
            market = '2'
          },
          'HSX' = {
            market = '1'
          },
          'UPC' = {
            market = '9'
          }
  )
  
  pURL = paste0(pURL, market)
  xData = as.data.table(jsonlite::fromJSON(pURL))
  names(xData) = gsub('Data.','', names(xData))
  xData = CLEAN_COLNAMES(xData)
  
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  Final_Data = xData[, .(source=Source, market=Market, ticker=symbol, reference=referenceprice, last = currentprice, change = change ,volume = totalvolume)]
  Final_Data[, code:=paste0('STKVN', ticker)]
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub(',','',reference)) )]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub(',','',last)))]
  Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub(',','',change)))]
  
  Final_Data[, close := as.numeric(NA)]
  
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), as.numeric(gsub(',','',volume)))]
  
  Final_Data[, date := LastTrading]
  Final_Data[, updated := substr(as.character(Sys.time()),1,19)]# Final_Data[, updated := Sys.time()]
  
  # hour <- unique(as.numeric(format(Final_Data$date, "%H")))
  hour = as.numeric(substr(as.character(Sys.time()),12,13))
  if (hour >= 16 | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  My.Kable.TB(Final_Data)
  return(Final_Data)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC = function(pSource = 'VND', pCode = 'VIC'){
  # ------------------------------------------------------------------------------------------------
  Final_Data <- data.table()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  switch (pSource,
          'VND' = {
            xData = TRAINEE_DOWNLOAD_VND_STKVN_OWNERSHIP_BY_CODE(pCode = pCode)
            free_float = xData[ratioCode == 'FREEFLOAT']$value*100
          },
          'DNSE' = {
            library(stringi)
            free_float = TRAINEE_DOWNLOAD_DNSE_FREEFLOATPC(pCode = pCode)
          },
          '24HMONEY' = {
            free_float = TRAINEE_DOWNLOAD_24HMONEY_FREEFLOATPC(pCode = pCode)
          }
  )
  
  Final_Data[, source := pSource]
  Final_Data[, ticker := pCode]
  Final_Data[, codesource := pCode]
  Final_Data[, code := paste0('STKVN', pCode)]
  Final_Data[, free_float := ceiling(free_float / 5) * 5]
  Final_Data[, date := LastTrading]
  Final_Data[, updated := substr(as.character(Sys.time()), 1, 19)]
  
  My.Kable.All(Final_Data)
  return(Final_Data)
}

#===================================================================================================
TRAINEE_DOWNLOAD_VND_STKVN_OWNERSHIP_BY_CODE = function(pCode = 'VNM') {
  # ------------------------------------------------------------------------------------------------
  # VND, FREE FLOAT
  # VND, FREEFLOAT
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  # pCode = 'VCB'
  # pURL = 'https://finfo-api.vndirect.com.vn//v4/ratios/latest?order=reportDate&filter=itemCode:57066,57057,57053&where=code:VCB'
  pURL = paste0('https://finfo-api.vndirect.com.vn//v4/ratios/latest?order=reportDate&filter=itemCode:57066,57057,57053&where=code:',pCode)
  CATln(pURL)
  # pURL = 'https://finfo-api.vndirect.com.vn/v4/?filter=itemCode:57066&where=code:VCB'
  # 
  # pURL = 'https://finfo-api.vndirect.com.vn//v4/ratios/'?
  # pURL = 'https://finfo-api.vndirect.com.vn//v4/ratios/oldest?order=reportDate&filter=itemCode:57066&where=code:VNM'
  x = jsonlite::fromJSON(pURL)
  # print(x)
  
  xData = as.data.table(x$data)
  
  xData[, date:= LastTrading]
  xData[, ':='(source='VND', dataset='OWNERSHIP', codesource=code)]
  xData[, code:=paste0('STKVN', codesource)]
  xData[, close:=value]
  # xData[, timestamp:= substr(as.character(as.POSIXct(as.numcodelist# xData[, timestamp:= substr(as.character(as.POSIXct(as.numeric(t), origin="1970-01-01")),1,19)]
  My.Kable.All(xData)
  
  # CCPR_MONITOR_EXECUTION_SUMMARY (pOption='IFRC_CCPR_DOWNLOAD_VND_STKVN_OWNERSHIP_BY_CODE', pAction="SAVE", NbSeconds=3600, ToPrint=F) 
  return(xData)
}

# ==================================================================================================
DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE = function(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/african-middle-eastern-stock-markets')  {
  # ------------------------------------------------------------------------------------------------
  response   = GET(pURL, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  xweb       = content(response, as="text")
  content    = try(rvest::read_html(xweb))
  tables     = content %>% html_table(fill = TRUE)
  xData      = as.data.table(tables[[1]])
  
  xData      = CLEAN_COLNAMES(xData)
  names(xData) = gsub('\r\n','_', names(xData))
  str(xData)
  Final_Data = xData[grepl('\r\n', name_country)][, .(
    name=word(name_country,1,1,'\r\n'), country=word(name_country,2,2,'\r\n'),
    last   = as.numeric(gsub(',','', word(last_prev_close,1,1,'\r\n'))),
    pclose = as.numeric(gsub(',','', word(last_prev_close,2,2,'\r\n'))),
    time   = trimws(substr(time_date,1,8)),
    ampm   = substr(word(time_date,2,2,' '),1,2),
    date   = as.Date(word(time_date,2,2,'\r\n'),'%m/%d/%Y'),
    updated = substr(as.character(Sys.time()),1,19)
  )]
  
  Final_Data[, change:=(last-pclose)]
  Final_Data[, varpc:=100*(last-pclose)/pclose]
  My.Kable(Final_Data)
  # str(Final_Data)
  
  country_ref = CCPR_READRDS('S:/CCPR/DATA/', 'efrc_country_ref.rds')
  Final_Data[, country:=toupper(country)]
  Final_Data = merge(Final_Data, country_ref[, .(country=name.ifrc, continent)], all.x=T, by='country')
  Final_Data[country=='USA', continent:='AMERICA']
  Final_Data[country=='HONG KONG', continent:='ASIA']
  Final_Data[country=='GREAT BRITAIN', continent:='EUROPE']
  Final_Data[country=='REPUBLIC OF KOREA', continent:='ASIA']
  Final_Data[, name:=toupper(name)]
  My.Kable.All(Final_Data)
  return(Final_Data)
}

# ==================================================================================================
DOWNLOAD_BIN_PAGE_INDEXES_ALL = function(pURL = 'https://markets.businessinsider.com/indices')  {
  # ------------------------------------------------------------------------------------------------
  response   = GET(pURL, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  xweb       = content(response, as="text")
  content    = try(rvest::read_html(xweb))
  tables     = content %>% html_table(fill = TRUE)
  xData      = as.data.table(tables[[1]])
  xData      = CLEAN_COLNAMES(xData)
  names(xData) = gsub('\n','_', names(xData))
  str(xData)
  Final_Data = xData[grepl('\n', name_country)][, .(
    name=word(name_country,1,1,'\n'), country=word(name_country,2,2,'\n'),
    last   = as.numeric(gsub(',','', word(last_prev_close,1,1,'\n'))), 
    pclose = as.numeric(gsub(',','', word(last_prev_close,2,2,'\n'))),
    time   = substr(time_date,1,8),
    ampm   = substr(time_date,10,11),
    date   = as.Date(word(time_date,2,2,'\n'),'%m/%d/%Y'),
    updated = substr(as.character(Sys.time()),1,19)
  )]
  Final_Data[, change:=(last-pclose)]
  Final_Data[, varpc:=100*(last-pclose)/pclose]
  My.Kable(Final_Data)
  
  country_ref = CCPR_READRDS('S:/CCPR/DATA/', 'efrc_country_ref.rds')
  Final_Data[, country:=toupper(country)]
  Final_Data = merge(Final_Data, country_ref[, .(country=name.ifrc, continent)], all.x=T, by='country')
  Final_Data[country=='USA', continent:='AMERICA']
  Final_Data[country=='HONG KONG', continent:='ASIA']
  Final_Data[country=='GREAT BRITAIN', continent:='EUROPE']
  Final_Data[country=='REPUBLIC OF KOREA', continent:='ASIA']
  Final_Data[, name:=toupper(name)]
  My.Kable.All(Final_Data)
  return(Final_Data)
}
# ==================================================================================================
DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE = function(pSource = 'VND', pCode  = 'VIC', NbDaysBack = 36500){
  # ------------------------------------------------------------------------------------------------
  Start.RUN = Sys.time()
  EndTime <- Sys.time()
  datetime  <- strptime(EndTime, "%Y-%m-%d %H:%M:%S")
  posix_end <- as.numeric(as.POSIXlt(datetime))
  
  switch(pSource,
         'VND' = {
           StartTime <- paste(Sys.Date()-NbDaysBack, "09:00:00")
           datetime  <- strptime(StartTime, "%Y-%m-%d %H:%M:%S")
           posix_start <- as.numeric(as.POSIXlt(datetime))
           pURL    = paste0('https://dchart-api.vndirect.com.vn/dchart/history?resolution=', 'D', '&symbol=', pCode, '&from=', posix_start, '&to=', posix_end)
           CATln_Border(pURL)
           xData = as.data.table(jsonlite::fromJSON(pURL))
           xData[!is.na(t), timestamp:=as.character(as.POSIXlt(as.numeric(t)))]
         },
         'DNSE' = {
           StartTime <- paste(Sys.Date()-NbDaysBack, "09:00:00")
           datetime  <- strptime(StartTime, "%Y-%m-%d %H:%M:%S")
           posix_start <- as.numeric(as.POSIXlt(datetime))
           pURL    = paste0('https://services.entrade.com.vn/chart-api/v2/ohlcs/stock?from=',posix_start,'&to=',posix_end,'&symbol=',pCode,'&resolution=', '1D')
           CATln_Border(pURL)
           xData = as.data.table(jsonlite::fromJSON(pURL))
           xData[!is.na(t), timestamp:=as.character(as.POSIXlt(as.numeric(t)))]
         },
         'VPS' = {
           gc()
           NbTry=20
           Divider = 2
           
           NrTry       = 0
           NbDays_ToDo = NbDaysBack*Divider
           ToContinu   = T
           CATln('')
           while (ToContinu & NrTry<=NbTry)
           {
             NrTry       = NrTry+1
             NbDays_ToDo = floor(NbDays_ToDo/(Divider))
             print(paste('try ', NrTry, '=', NbDays_ToDo))
             
             StartTime <- paste(Sys.Date()-NbDays_ToDo, "09:00:00")
             datetime  <- strptime(StartTime, "%Y-%m-%d %H:%M:%S")
             posix_start <- as.numeric(as.POSIXlt(datetime))
             pURL = paste0('https://histdatafeed.vps.com.vn/tradingview/history?symbol=',pCode,'&resolution=','1D','&from=',posix_start,'&to=', posix_end)
             CATln_Border(pURL)
             
             xData = try((jsonlite::fromJSON(pURL))) 
             if (all(class(xData)!='try-error') & length(xData) > 0 )
             {
               xData = as.data.table(xData)
               xData[!is.na(t), timestamp:=as.character(as.POSIXlt(as.numeric(t)))]
               ToContinu = F
             } else { ToContinu = T }
           }
           
           
         },
         'C68' = {
           x          = jsonlite::fromJSON(paste0('https://www.cophieu68.vn/chart/chart_data.php?parameters=%7B%7D&stockname=', pCode, '&dateby=1'))
           xJson      = as.data.table(x$candle)
           xData      = xJson[, .(
             date       = as.Date(date), 
             o          = as.numeric(gsub(',', '', open)),
             h          = as.numeric(gsub(',', '', high)),
             l          = as.numeric(gsub(',', '', low)),
             c          = as.numeric(gsub(',', '', close)),
             v          = as.numeric(gsub(',', '', volume))
           )]
           xData[, timestamp:= paste0(date, " 07:00:00")]
         }
  )
  Final_Data = xData[, .(source=pSource, ticker=pCode, codesource=pCode, code=paste0('STKVN', pCode), timestamp=timestamp, 
                         date=as.Date(substr(timestamp,1,10)), open_adj=1000*o, high_adj=1000*h, low_adj=1000*l, close_adj=1000*c, volume=v)]
  Final_Data = Final_Data[order(date)][, rt:=(close_adj/shift(close_adj))-1]
  Final_Data[, change:=(close_adj-shift(close_adj))]
  Final_Data[, varpc:=100*rt]
  My.Kable.TB(Final_Data)
  End.RUN = Sys.time()
  CATln_Border(paste('DURATION = ', Format.Number(difftime(End.RUN, Start.RUN, units='secs'),3)))
  return(Final_Data)
}

# ==================================================================================================
PRICESBOARD_MISC = function()
{
  try(DELETE_C_TEMP(StartWith='TEMP_'))
  try(DELETE_C_TEMP(StartWith='BANG_GIA_'))
  
  if (TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= 'DOWNLOAD_WEXC_IND_MYANPIX_HISTORY', pAction="COMPARE", NbSeconds=60*60*6, ToPrint=F))
  {
    CHECK_CLASS (try ( DOWNLOAD_WEXC_IND_MYANPIX_HISTORY(ToIntegrate = T)))
    TRAINEE_MONITOR_EXECUTION_SUMMARY(pOption= 'DOWNLOAD_WEXC_IND_MYANPIX_HISTORY', pAction="SAVE", NbSeconds=1, ToPrint=F)
  }
}

# ==================================================================================================
DASHBOARD_CCPI_MARKET_CHARTS = function(phost = 'dashboard_live', ToDownload = F, ToUpload = F, ToSave   = F)  {
  # ------------------------------------------------------------------------------------------------
  # phost = 'dashboard_live'; ToDownload = T; ToUpload = T; ToSave   = T
  if (ToDownload)
  {
    xList = list()
    xList[[1]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_ALL(pURL = 'https://markets.businessinsider.com/indices')))
    xList[[2]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/african-middle-eastern-stock-markets')))
    xList[[3]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/asian-pacific-stock-markets')))
    xList[[4]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/european-stock-markets/eastern')))
    xList[[5]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/european-stock-markets/western')))
    xList[[6]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/south-american-markets')))
    xList[[7]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/latin-america-canadian-markets')))
    xList[[8]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/us-stock-markets')))
    CRYPTO     = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_CRYPTO_BY_ONE(pURL = 'https://markets.businessinsider.com/cryptocurrencies')))
    xALL = rbind(rbindlist(xList, fill=T), CRYPTO, fill=T)
    xALL = unique(xALL, by='name')
    ALL_DATA = xALL
    My.Kable(ALL_DATA)
    
    SELECTED = setDT(read.xlsx('S:/CCPR/DATA/DASHBOARD/ccpi_dashboard_markets_select.xlsx'))
    if (CHECK_TIMEBETWEEN('09:15' , '18:00') & wday(Sys.Date()) %in% c(2:6) )
    {
      x_vn = CHECK_CLASS(try(TRAINEE_DOWNLOAD_FANT_VIETNAM_INDEX_BY_CODE()))
      My.Kable.All(x_vn)
      if (nrow(x_vn) > 0){
        x_vn = CLEAN_COLNAMES(x_vn)
        # ALL_DATA = rbind(ALL_DATA, x_vn, fill = T)
        x_vn[, active := 1]
      }
    } else {
      x = CHECK_CLASS(try(CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/','ccpi_dashboard_markets.rds', ToKable = T, ToRestore = T)))
      x_vn = x[country == 'VIETNAM']
      x_vn[, active := 1]
    }
  }
  
  if (ToSave) 
  { 
    ALL_DATA = rbind(ALL_DATA, x_vn, fill = T)
    ALL_DATA = merge(ALL_DATA[, -c('active', 'name_chart','code')], SELECTED[,.(active, name,name_chart,code)], by='name', all.x=T)
    SELECT_DATA = ALL_DATA[active==1][, -c('active')][order(continent, country)]
    SELECT_DATA[!is.na(name_chart), name:=name_chart]
    SELECT_DATA [, updated:= SYS.TIME()]
    if (! 'code' %in% names (SELECT_DATA) ) { SELECT_DATA [, code := name]} 
    SELECT_DATA [is.na(code), code := name]
    My.Kable.All(SELECT_DATA)
    
    other_source = CHECK_CLASS(try(CCPR_READRDS("S:/CCPR/DATA/DASHBOARD_LIVE/","dbl_source_ins_last_today.rds", ToKable = T, ToRestore = T)))
    other_source = unique(other_source[order(-date)], by = c('code'))
    other_source = MERGE_DATASTD_BYCODE(other_source)
    other_source = other_source[, .(code,codesource, country, name, last = close, 
                                    pclose = close + change, 
                                    time   = format(strptime(substr(timestamp  , 12, 19), "%H:%M:%S"), "%I:%M:%S"),
                                    ampm    = ifelse(as.numeric(format(strptime(substr(timestamp  , 12, 19), "%H:%M:%S"), "%H")) >= 12, "PM", "AM"),
                                    date = as.Date(timestamp_vn),updated,
                                    change, varpc, continent)]
    # other_source[continent == 'WORLD']
    # SELECT_DATA[continent == 'CRYPTOCURRENCY']
    # other_source[code %in% SELECT_DATA$code & continent == 'WORLD']
    other_source = merge(other_source[, -c('active', 'name_chart')], SELECTED[,.(active,name_chart,code)], by='code', all.x=T)[active == 1][, -c('active')][order(continent, country)]
    other_source[grepl('-USD',codesource), continent := 'CRYPTOCURRENCY']
    SELECT_DATA = rbind(SELECT_DATA, other_source, fill = T)
    SELECT_DATA[, datetime := as.POSIXct(paste(date, time, ampm), format = "%Y-%m-%d %I:%M:%S %p")]
    SELECT_DATA = SELECT_DATA[order(-datetime)]
    SELECT_DATA[is.na(date), date := Sys.Date()]
    SELECT_DATA = unique(SELECT_DATA, by = c('code'))
    
    Data_Old = CHECK_CLASS(try(CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/','ccpi_dashboard_markets.rds', ToKable = T, ToRestore = T)))
    Data_Old = unique(rbind(Data_Old, SELECT_DATA[varpc != 0], fill = T), by = 'code', fromLast = T)
    Data_Old = Data_Old[!grepl('VIETNAM',code) | !is.na(code)]
    My.Kable.All(Data_Old)
    dir.create('S:/CCPR/DATA/DASHBOARD_LIVE/')
    
    try(CCPR_SAVERDS(Data_Old, 'S:/CCPR/DATA/DASHBOARD_LIVE/','ccpi_dashboard_markets.rds', ToSummary = T, SaveOneDrive = T))
  }
  if (ToUpload)
  {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = phost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_markets.rds')),
                                     l.filepath= tolower(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/',  'ccpi_dashboard_markets.rds')),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
  }
}


# ==================================================================================================
DASHBOARD_CCPI_MARKET_CHARTS_OLD = function(phost = 'dashboard_live', ToDownload = F, ToUpload = F, ToSave   = F)  {
  # ------------------------------------------------------------------------------------------------
  # phost = 'dashboard_live'; ToDownload = T; ToUpload = T; ToSave   = T
  if (ToDownload)
  {
    xList = list()
    xList[[1]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_ALL(pURL = 'https://markets.businessinsider.com/indices')))
    xList[[2]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/african-middle-eastern-stock-markets')))
    xList[[3]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/asian-pacific-stock-markets')))
    xList[[4]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/european-stock-markets/eastern')))
    xList[[5]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/european-stock-markets/western')))
    xList[[6]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/south-american-markets')))
    xList[[7]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/latin-america-canadian-markets')))
    xList[[8]] = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_INDEXES_BY_ONE(pURL = 'https://markets.businessinsider.com/ajax/IndexListTab/us-stock-markets')))
    CRYPTO     = CHECK_CLASS(try(DOWNLOAD_BIN_PAGE_CRYPTO_BY_ONE(pURL = 'https://markets.businessinsider.com/cryptocurrencies')))
    xALL = rbind(rbindlist(xList, fill=T), CRYPTO, fill=T)
    xALL = unique(xALL, by='name')
    My.Kable(xALL)
    
    ALL_DATA = xALL
    My.Kable(ALL_DATA)
    # write.xlsx(ALL_DATA, 'S:/CCPR/DATA/DASHBOARD/ccpi_dashboard_markets_select.xlsx')
    # write.xlsx(CRYPTO, 'S:/CCPR/DATA/DASHBOARD/ccpi_dashboard_markets_crypto_select.xlsx')
    
    SELECTED = setDT(read.xlsx('S:/CCPR/DATA/DASHBOARD/ccpi_dashboard_markets_select.xlsx'))
    if (CHECK_TIMEBETWEEN('09:15' , '18:00') & wday(Sys.Date()) %in% c(2:6) )
    {
      x_vn = CHECK_CLASS(try(TRAINEE_DOWNLOAD_FANT_VIETNAM_INDEX_BY_CODE()))
      My.Kable.All(x_vn)
      if (nrow(x_vn) > 0){
        x_vn = CLEAN_COLNAMES(x_vn)
        # ALL_DATA = rbind(ALL_DATA, x_vn, fill = T)
        x_vn[, active := 1]
      }
    } else {
      x = CHECK_CLASS(try(CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/','ccpi_dashboard_markets.rds', ToKable = T, ToRestore = T)))
      x_vn = x[country == 'VIETNAM']
      x_vn[, active := 1]
    }
  }
  
  
  if (ToSave) 
  { 
    ALL_DATA = merge(xALL[, -c('active', 'name_chart','code')], SELECTED[,.(active, name,name_chart,code)], by='name', all.x=T)
    ALL_DATA = rbind(ALL_DATA, x_vn, fill = T)
    SELECT_DATA = ALL_DATA[active==1][, -c('active')][order(continent, country)]
    SELECT_DATA[!is.na(name_chart), name:=name_chart]
    SELECT_DATA [, updated:= SYS.TIME()]
    SELECT_DATA [is.na(code), code := name]
    My.Kable.All(SELECT_DATA)
    
    Data_Old = CHECK_CLASS(try(CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/','ccpi_dashboard_markets.rds', ToKable = T, ToRestore = T)))
    
    telegram = CHECK_CLASS(try(CCPR_READRDS('S:/TELEGRAM/', 'telegram_last.rds')))[code %in% SELECT_DATA$code][order(code)]
    if (nrow(telegram) > 0){
      telegram = telegram[,.(code, last = close, pclose,
                             time = format(strptime(substr(timestamp_loc, 12, 19), "%H:%M:%S"), "%I:%M:%S"),
                             ampm = ifelse(as.numeric(format(strptime(substr(timestamp_loc, 12, 19), "%H:%M:%S"), "%H")) >= 12, "PM", "AM"),
                             date = as.Date(timestamp), 
                             change, varpc)]
      
      x = merge(SELECT_DATA[code %in% telegram$code][,-c('last','pclose','time','ampm','date','change','varpc')],
                telegram, all.x = T, by = 'code')
      
      Data_Old = unique(rbind(Data_Old[!name %in% SELECT_DATA$name], SELECT_DATA[!name %in% x$name],x, fill = T))
      
    } else {
      Data_Old = unique(rbind(Data_Old[!name %in% SELECT_DATA$name], SELECT_DATA, fill = T))
    }
    
    # CCPR_SAVERDS(SELECT_DATA, 'S:/CCPR/DATA/DASHBOARD/','ccpi_dashboard_markets.rds', ToSummary = T, SaveOneDrive = T)
    My.Kable.All(Data_Old)
    
    dir.create('S:/CCPR/')
    dir.create('S:/CCPR/DATA/')
    dir.create('S:/CCPR/DATA/DASHBOARD/')
    # CCPR_SAVERDS(SELECT_DATA, 'S:/CCPR/DATA/DASHBOARD/','ccpi_dashboard_markets.rds', ToSummary = T, SaveOneDrive = T)
    dir.create('S:/CCPR/DATA/DASHBOARD_LIVE/')
    
    try(CCPR_SAVERDS(Data_Old, 'S:/CCPR/DATA/DASHBOARD_LIVE/','ccpi_dashboard_markets.rds', ToSummary = T, SaveOneDrive = T))
  }
  if (ToUpload)
  {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = phost, l.tablename= tolower(gsub('.rds','', 'ccpi_dashboard_markets.rds')),
                                     l.filepath= tolower(paste0('S:/CCPR/DATA/DASHBOARD_LIVE/',  'ccpi_dashboard_markets.rds')),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=F))
  }
}


# ==================================================================================================
DOWNLOAD_BIN_PAGE_CRYPTO_BY_ONE = function(pURL = 'https://markets.businessinsider.com/cryptocurrencies')  {
  # ------------------------------------------------------------------------------------------------
  response   = GET(pURL, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  xweb       = content(response, as="text")
  content    = try(rvest::read_html(xweb))
  tables     = content %>% html_table(fill = TRUE)
  xData      = as.data.table(tables[[1]])
  
  xData      = CLEAN_COLNAMES(xData)
  names(xData) = gsub('\r\n','_', names(xData))
  str(xData)
  names(xData)[3] = 'change_varpc'
  Final_Data = xData[, .(
    name=namecurrency,
    last   = as.numeric(gsub(',','', price)),
    change = as.numeric(gsub(',','', word(change_varpc,1,1,'\r\n'))),
    varpc = as.numeric(gsub('%','', word(percent_         ,1,1,'\r\n'))),
    # time   = trimws(substr(time_date,1,8)),
    # ampm   = substr(word(time_date,2,2,' '),1,2),
    date   = as.Date(lastupdated      ,'%m/%d/%Y'),
    updated = substr(as.character(Sys.time()),1,19),
    continent = 'CRYPTOCURRENCY'
  )]
  
  # Final_Data[, change:=(last-pclose)]
  # Final_Data[, varpc:=100*(last-pclose)/pclose]
  My.Kable(Final_Data)
  # str(Final_Data)
  
  # country_ref = CCPR_READRDS(UData, 'efrc_country_ref.rds')
  # Final_Data[, country:=toupper(country)]
  # Final_Data = merge(Final_Data, country_ref[, .(country=name.ifrc, continent)], all.x=T, by='country')
  # Final_Data[country=='USA', continent:='AMERICA']
  # Final_Data[country=='HONG KONG', continent:='ASIA']
  # Final_Data[country=='GREAT BRITAIN', continent:='EUROPE']
  # Final_Data[country=='REPUBLIC OF KOREA', continent:='ASIA']
  Final_Data[, name:=toupper(name)]
  My.Kable.All(Final_Data)
  return(Final_Data)
}

# ==================================================================================================
LOOP_DOWNLOAD_CUSTOM_BY_CODE = function( ranking    = '', FirstChars = 'ABC', random = F,
                                         pMarket    = 'HNX', 
                                         pFolder    = 'S:/STKVN/PRICES/DAY/',
                                         File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                         pDate      = Sys.Date(),
                                         List_Codes = list(),
                                         File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                         Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT') {
  # ------------------------------------------------------------------------------------------------
  
  # ranking    = 'ASC'; FirstChars = ''; random = F;  pMarket    = 'HNX'; pDate      = Sys.Date();   List_Codes = list()
  # pFolder    = 'S:/STKVN/PRICES/DAY/';  File_Name  = paste0('TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE_', gsub('-','', Sys.Date()), '.rds')
  # File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds"
  
  DBL_RELOAD_INSREF()
  File_Name = paste0(File_Pattern,'_', gsub('-','', pDate), '.rds')
  FilePath  = paste0(pFolder, File_Name)
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  Data_All  = data.table()
  File_Codes_RAW = gsub('S:/CCPR/DATA/','', File_Codes)
  
  if (length(List_Codes)==0 & nchar(File_Codes)>0)
  {
    List_Codes = CCPR_READRDS('S:/CCPR/DATA/', File_Codes_RAW, ToKable = T, ToRestore = T)
    List_Codes = unique(List_Codes[order(-date)], by = 'codesource' )
    List_Codes = as.vector(List_Codes$codesource)
  }
  
  if (nchar(ranking)>0)
  {
    switch (ranking,
            'ASC' = {
              List_Codes = sort(List_Codes, decreasing = F)
            },
            'DESC' = {
              List_Codes = sort(List_Codes, decreasing = T)
            })
  }
  
  if (nchar(FirstChars)>0)
  {
    char_set <- strsplit(FirstChars, "")[[1]]
    # inChars <- 'ABC'
    # > List_CODES <- c('AAB', 'AAC', 'BCC', 'XXY')
    # Vectorized filtering for efficiency
    Selected_Codes = List_Codes[substr(List_Codes, 1, 1) %in% char_set]
    List_Codes = Selected_Codes 
  }
  print(List_Codes)
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  
  ExtraFolder = ''
  
  if (file.exists(FilePath))
  {
    Data_old = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name, ToKable = T)))
    
    if (nrow(Data_old)>0) 
    {
      Data_done = unique(Data_old[!is.na(codesource)][order(-date)], by = 'codesource')
      str(Data_done)
      Data_List = Data_done[codesource %in% List_Codes & date >= pDate]
      List_Codes_ToDo = setdiff(List_Codes, as.vector(Data_List$codesource))
      length(List_Codes_ToDo)
    } else {
      List_Codes_ToDo = List_Codes
    }
  } else { 
    CATln(paste('FILE NO EXIST :', FilePath))
    Data_old = data.table() 
    List_Codes_ToDo = List_Codes
  }
  print(List_Codes_ToDo)
  
  
  # ================================================================================================
  
  if (length(List_Codes_ToDo)>0)
  {
    Data_All = Data_old
    if (random){
      List_Codes_ToDo = sample(List_Codes_ToDo)
    }
    Data_All = data.table()
    Data_List = list()
    
    FileDataAll = List_Codes_ToDo
    FileRow  = nrow(List_Codes_ToDo)
    Nb_Total = length(List_Codes_ToDo)
    
    FileToSave = paste0(File_Name)
    Total_Time  = 0
    
    for (i in 1:Nb_Total)
    {
      # i = 1
      Start.Time = Sys.time()
      pCode    = List_Codes_ToDo[i]
      CATln("")
      
      Sys.sleep(1)
      My_Data = data.table()
      if (! pCode %in% Data_All$codesource)
      {
        switch(Action,
               'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) # UPC
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='UPC', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) # HNX
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='HNX', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'DOWNLOAD_CAF_STKVN_SNAPSHOT' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_SNAPSHOT_BY_CODE (pCode  = pCode, URL = '', ToAdd = F)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               } ,
               'DOWNLOAD_DNSE_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'DNSE', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='DNSE', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_VND_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'VND', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_VPS_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'VPS', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VPS', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'DOWNLOAD_C68_STKVN_PRICESDAY_BY_CODE' = {
                 My_Data = CHECK_CLASS(try(DOWNLOAD_SOURCE_STKVN_PRICESDAY_BY_CODE (pSource = 'C68', pCode  = pCode, NbDaysBack = 36500)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='C68', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_VND_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = 'VND', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='VND', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_DNSE_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = 'DNSE', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='DNSE', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }, 
               'TRAINEE_DOWNLOAD_24H_FREEFLOATPC' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_FREEFLOATPC (pSource = '24HMONEY', pCode  = pCode)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='24H', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               }
        )
        My.Kable.TB (My_Data)
        # My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) 
        if (all(class(My_Data)!='try-error'))
        {
          Data_old = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name)))
          Data_All = rbind(My_Data, Data_old, fill=T)[!is.na(code)]
          Data_All[, market:=pMarket]
          My.Kable.TB(Data_All)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := pDate]}
          
          CCPR_SAVERDS(Data_All ,  pFolder, File_Name, SaveOneDrive = T)
          CATln_Border(paste ('SAVED: ', paste0(pFolder, File_Name)) )
          
        }
      }
      
      End.Time = Sys.time()
      Total_Time = Format.Number(as.numeric(difftime(End.Time, Start.Time, units = 'secs')), 3) 
      # Avg_Time = Total_Time / i
      # End_Forecast = Avg_Time * (Nb_TODO - i)
      # Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
      # CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      CATln_Border(paste('DURATION :', substr(Total_Time,1,19)))
    }
    
  } else {
    CATln_Border(paste0('DATA FULLY UPDATED = ',FilePath))
    Sys.sleep(2)
  }
  return(Data_All)
}

# ==================================================================================================
LOOP_DOWNLOAD_CUSTOM_BY_CODE_V0 = function( ranking    = '', FirstChars = 'ABC', random = F,
                                            pMarket    = 'HNX', 
                                            pFolder    = 'S:/STKVN/PRICES/DAY/',
                                            File_Pattern  = paste0('DOWNLOAD_CAF_STKVN_SNAPSHOT'),
                                            pDate      = '2024-04-22',
                                            List_Codes = list(),
                                            File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                            Action     = 'DOWNLOAD_CAF_STKVN_SNAPSHOT') {
  # ------------------------------------------------------------------------------------------------
  
  # ranking    = 'ASC'; FirstChars = ''; random = F;  pMarket    = 'HNX'; pDate      = Sys.Date();   List_Codes = list()
  # pFolder    = 'S:/STKVN/PRICES/DAY/';  File_Name  = paste0('TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE_', gsub('-','', Sys.Date()), '.rds')
  # File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds"
  
  DBL_RELOAD_INSREF()
  File_Name = paste0(File_Pattern,'_', gsub('-','', pDate), '.rds')
  FilePath = paste0(pFolder, File_Name)
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  Data_All = data.table()
  File_Codes_RAW = gsub('S:/CCPR/DATA/','', File_Codes)
  if (length(List_Codes)==0 & nchar(File_Codes)>0)
  {
    List_Codes = CCPR_READRDS('S:/CCPR/DATA/', File_Codes_RAW, ToKable = T, ToRestore = T)
    List_Codes = unique(List_Codes[order(-date)], by = 'codesource' )
    List_Codes = as.vector(List_Codes$codesource)
  }
  
  if (nchar(ranking)>0){
    switch (ranking,
            'ASC' = {
              List_Codes = sort(List_Codes, decreasing = F)
            },
            'DESC' = {
              List_Codes = sort(List_Codes, decreasing = T)
            })
  }
  if (nchar(FirstChars)>0){
    char_set <- strsplit(FirstChars, "")[[1]]
    # inChars <- 'ABC'
    # > List_CODES <- c('AAB', 'AAC', 'BCC', 'XXY')
    # Vectorized filtering for efficiency
    Selected_Codes = List_Codes[substr(List_Codes, 1, 1) %in% char_set]
    List_Codes = Selected_Codes 
  }
  print(List_Codes)
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  
  ExtraFolder = ''
  
  if (file.exists(FilePath))
  {
    Data_old = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name, ToKable = T)))
    
    if (nrow(Data_old)>0) 
    {
      Data_done = unique(Data_old[!is.na(codesource)][order(-date)], by = 'codesource')
      Data_List = Data_done[codesource %in% List_Codes & date >= pDate]
      List_Codes_ToDo = setdiff(List_Codes, as.vector(Data_List$codesource))
      length(List_Codes_ToDo)
    } else {
      List_Codes_ToDo = List_Codes
    }
  } else { 
    CATln(paste('FILE NO EXIST :', FilePath))
    Data_old = data.table() 
    List_Codes_ToDo = List_Codes
  }
  print(List_Codes_ToDo)
  
  # ================================================================================================
  
  Data_All = Data_old
  if (length(List_Codes_ToDo)>0)
  {
    if (random){
      List_Codes_ToDo = sample(List_Codes_ToDo)
    }
    Data_All = data.table()
    Data_List = list()
    
    FileDataAll = List_Codes_ToDo
    FileRow  = nrow(List_Codes_ToDo)
    Nb_Total = length(List_Codes_ToDo)
    
    FileToSave = paste0(File_Name)
    Total_Time  = 0
    
    for (i in 1:Nb_Total)
    {
      # i = 1
      Start.Time = Sys.time()
      pCode    = List_Codes_ToDo[i]
      CATln("")
      
      Sys.sleep(1)
      My_Data = data.table()
      if (! pCode %in% Data_All$codesource)
      {
        switch(Action,
               'DOWNLOAD_CAF_STKVN_SNAPSHOT' = {
                 My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_SNAPSHOT_BY_CODE (pCode  = pCode, URL = '', ToAdd = F)))
                 if (nrow(My_Data)>0)
                 {
                   My_Data[, ":="(source='CAF', codesource=pCode, updated = substr(as.character(Sys.time()),1,19))] 
                 }
               })
        # My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) 
        if (all(class(My_Data)!='try-error'))
        {
          Data_old = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name)))
          Data_All = rbind(My_Data, Data_old, fill=T)[!is.na(code)]
          Data_All[, market:=pMarket]
          My.Kable.TB(Data_All)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := pDate]}
          
          CCPR_SAVERDS(Data_All ,  pFolder, File_Name, SaveOneDrive = T)
          CATln_Border(paste ('SAVED: ', paste0(pFolder, File_Name)) )
          
        }
      }
      
      End.Time = Sys.time()
      Total_Time = Format.Number(as.numeric(difftime(End.Time, Start.Time, units = 'secs')), 3) 
      # Avg_Time = Total_Time / i
      # End_Forecast = Avg_Time * (Nb_TODO - i)
      # Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
      # CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      CATln_Border(paste('DURATION :', substr(Total_Time,1,19)))
    }
    
  } else {
    CATln_Border(paste0('DATA FULLY UPDATED = ',FilePath))
    Sys.sleep(2)
  }
  return(Data_All)
}


# ==================================================================================================
# TRAINEE_CCPI_DASHBOARD_SPECIFICATIONS = function (pFolder = 'S:/STKVN/INDEX_2024/', pFile = 'beq_indrtlals_history.rds' ,
#                                                   ToFolder = '' , ToFile  = '',
#                                                   FolderMerge = '', FileMerge = '',
#                                                   ToSave = F, ToMerge  = F, ToUpload = F , pHost = '' ) {
#   # ------------------------------------------------------------------------------------------------
#   # SPECIFICATIONS :
#   
#   IND_HISTORY = CCPR_READRDS(pFolder, pFile, ToKable=T, ToRestore = T)
#   # IND_HISTORY = CCPR_READRDS(paste0('R:/CCPR/DATA/DASHBOARD/'), 'ifrc_ccpr_ind_gics_prices.rds', ToKable=T, ToRestore = T)
#   
#   
#   IND_HISTORY[grepl('^IFRC/BEQ', name),  name:=gsub('IFRC/BEQ', 'IFRC/BEQ ', name)]
#   IND_HISTORY[!grepl('^IFRC/BEQ', name), name:=paste0('IFRC/BEQ ', name)]
#   IND_HISTORY[, name:=gsub('  ', ' ', name)]
#   IND_HISTORY[, source:='IFRC']
#   IND_HISTORY = IND_HISTORY[order(code, date)]
#   IND_HISTORY[, base_value:=close[1], by='code']
#   IND_HISTORY[, base_date:=date[1], by='code']
#   IND_HISTORY[grepl(' TR ', name), prtr:='TR']
#   IND_HISTORY[grepl(' PR ', name), prtr:='PR']
#   IND_HISTORY[grepl(' NR ', name), prtr:='NR']
#   IND_HISTORY[grepl(' EW ', name), wgtg:='EW']
#   IND_HISTORY[grepl(' CW ', name), wgtg:='CW']
#   IND_HISTORY[grepl(' FW ', name), wgtg:='FW']
#   My.Kable(IND_HISTORY)
#   # IND_HISTORY[, short_name:=name]
#   IND_HISTORY[, short_name:=gsub ('IFRC/BEQ HOLDINGS ','',name)]
#   
#   DB_TEMPLATE = setDT(fread(paste0('S:/CCPR/DATA/DASHBOARD/', 'template_specifications.txt')))
#   DB_TEMPLATE_EMPTY = DB_TEMPLATE
#   # DB_TEMPLATE_EMPTY$value=NULL
#   # DB_TEMPLATE_EMPTY$value=as.character('')
#   str(DB_TEMPLATE_EMPTY)
#   
#   IND_STATS    = IND_HISTORY[,.(full_name=name[1], short_name=short_name[1], start=date[1], start_value=close[1]) , by=c('code')]
#   IND_STATS[, cur:=substr(code, nchar(code)-2, nchar(code))]
#   IND_STATS[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
#   IND_STATS[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
#   
#   X_List = list()
#   
#   for (k in 1:nrow(IND_STATS))
#   {
#     # k = 1
#     
#     DB_TEMPLATE_ONE = setDT(copy(DB_TEMPLATE_EMPTY))
#     DB_TEMPLATE_ONE[, index_code:=IND_STATS[k]$code]
#     DB_TEMPLATE_ONE[field=='Full name',   value:=as.character(IND_STATS[k]$full_name)]
#     DB_TEMPLATE_ONE[field=='Short name',  value:=as.character(IND_STATS[k]$short_name)]
#     DB_TEMPLATE_ONE[field=='Composition criteria',  value:='Sector/Industry/Theme']
#     switch(IND_STATS[k]$prtr,
#            'PR' = { label = 'Price (PR)'},
#            'TR' = { label = 'ToTal Return (TR)'},
#            {label = ''}
#     )
#     DB_TEMPLATE_ONE[field=='Weighting',  value:=label]
#     switch(IND_STATS[k]$wgtg,
#            'EW' = { label = 'Equally Weighted (EW)'},
#            'CW' = { label = 'Capitalisation Weighted (CW)'},
#            {label = ''}
#     )
#     DB_TEMPLATE_ONE[field=='Weighting',  value:=label]
#     
#     switch(IND_STATS[k]$prtr,
#            'PR' = { label = 'Price Index'},
#            'TR' = { label = 'Total Return Index'},
#            {label = ''}
#     )
#     DB_TEMPLATE_ONE[field=='Price or Total Return',  value:=label]
#     
#     label = IND_STATS[k]$cur
#     DB_TEMPLATE_ONE[field=='Currency',  value:=label]
#     DB_TEMPLATE_ONE[field=='Internal Code',  value:=IND_STATS[k]$code]
#     DB_TEMPLATE_ONE[field=='Launching date', value:='2023-03-15']
#     My.Kable.All(DB_TEMPLATE_ONE)
#     X_List[[k]] = DB_TEMPLATE_ONE[, -c('dynamic')]
#   }
#   
#   SPECIFICATIONS_ALL = rbindlist(X_List)
#   My.Kable(SPECIFICATIONS_ALL)
#   # saveRDS(SPECIFICATIONS_ALL, paste0('R:/CCPR/DATA/DASHBOARD/', 'INDETF_SPECIFICATIONS_ALL.rds'))
#   # CCPR_SAVERDS(SPECIFICATIONS_ALL, 'R:/CCPR/DATA/DASHBOARD/', 'INDGICS_SPECIFICATIONS_ALL.rds')
#   
#   
#   
#   if (ToSave) {CCPR_SAVERDS (SPECIFICATIONS_ALL, ToFolder , ToFile)}
#   My_Data = SPECIFICATIONS_ALL
#   # ToMerge =T
#   if (ToMerge) { 
#     if (file.exists (paste0( FolderMerge , FileMerge )) ) {
#       Data_Old = CCPR_READRDS( FolderMerge , FileMerge, ToRestore = T)
#     } else {Data_Old = data.table () }
#     # SPECIFICATIONS_ALL
#     My_Data = unique ( rbind (Data_Old, SPECIFICATIONS_ALL, fill =T), fromLast = T, by = c ('field', 'index_code') )
#     # pDate = '2024-01-12'
#     My_Data = UPDATE_UPDATED(My_Data)
#     CCPR_SAVERDS(My_Data, FolderMerge , FileMerge )
#   }
#   
#   if (ToUpload) {
#     try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower( 'ccpi_secondary_specifications'),
#                                      l.filepath= tolower(paste0(FolderMerge , FileMerge)),
#                                      CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
#   }
#   return (My_Data)
# }

# ==================================================================================================
TRAINEE_CCPI_DASHBOARD_SPECIFICATIONS = function (pFolder = 'S:/STKVN/INDEX_2024/', pFile = 'beq_indrtlals_history.rds' ,
                                                  List_Codes = c(),
                                                  ToFolder = '' , ToFile  = '',
                                                  FolderMerge = '', FileMerge = '',
                                                  ToSave = F, ToMerge  = F, ToUpload = F , pHost = '' ) {
  # ------------------------------------------------------------------------------------------------
  # SPECIFICATIONS :
  
  ALL_HISTORY = CCPR_READRDS(pFolder, pFile, ToKable=T, ToRestore = T)
  if (length (List_Codes)>0) {IND_HISTORY = ALL_HISTORY [code %in% List_Codes]} else {
    IND_HISTORY = ALL_HISTORY
  }
  # IND_HISTORY = CCPR_READRDS(paste0('R:/CCPR/DATA/DASHBOARD/'), 'ifrc_ccpr_ind_gics_prices.rds', ToKable=T, ToRestore = T)
  indmother = CCPR_READRDS('S:/CCPR/DATA/DASHBOARD_LIVE/',"dbl_ind_mother.rds")
  IND_HISTORY = merge(IND_HISTORY, indmother[,.(code,new_name = name,new_shortname = short_name,prtr = version,wgtg,cur)], by="code", all.x=T)
  IND_HISTORY[is.na(name) & !is.na(new_name), name:=new_name]
  IND_HISTORY[is.na(short_name) & !is.na(new_shortname), short_name:=new_shortname]
  
  IND_HISTORY[, source:='IFRC']
  IND_HISTORY = IND_HISTORY[order(code, date)]
  IND_HISTORY[, base_value:=close[1], by='code']
  IND_HISTORY[, base_date:=date[1], by='code']
  # IND_HISTORY[, short_name:=name]
  
  DB_TEMPLATE = setDT(fread(paste0('S:/CCPR/DATA/DASHBOARD/', 'template_specifications.txt')))
  DB_TEMPLATE_EMPTY = DB_TEMPLATE
  # DB_TEMPLATE_EMPTY$value=NULL
  # DB_TEMPLATE_EMPTY$value=as.character('')
  str(DB_TEMPLATE_EMPTY)
  
  IND_STATS    = IND_HISTORY[,.(full_name=name[1], short_name=short_name[1], start=date[1], start_value=close[1]) , by=c('code')]
  IND_STATS[, cur:=substr(code, nchar(code)-2, nchar(code))]
  IND_STATS[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
  IND_STATS[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
  
  X_List = list()
  
  for (k in 1:nrow(IND_STATS))
  {
    # k = 1
    
    DB_TEMPLATE_ONE = setDT(copy(DB_TEMPLATE_EMPTY))
    DB_TEMPLATE_ONE[, index_code:=IND_STATS[k]$code]
    DB_TEMPLATE_ONE[field=='Full name',   value:=as.character(IND_STATS[k]$full_name)]
    DB_TEMPLATE_ONE[field=='Short name',  value:=as.character(IND_STATS[k]$short_name)]
    DB_TEMPLATE_ONE[field=='Composition criteria',  value:='Sector/Industry/Theme']
    switch(IND_STATS[k]$prtr,
           'PR' = { label = 'Price (PR)'},
           'TR' = { label = 'ToTal Return (TR)'},
           {label = ''}
    )
    DB_TEMPLATE_ONE[field=='Weighting',  value:=label]
    switch(IND_STATS[k]$wgtg,
           'EW' = { label = 'Equally Weighted (EW)'},
           'CW' = { label = 'Capitalisation Weighted (CW)'},
           {label = ''}
    )
    DB_TEMPLATE_ONE[field=='Weighting',  value:=label]
    
    switch(IND_STATS[k]$prtr,
           'PR' = { label = 'Price Index'},
           'TR' = { label = 'Total Return Index'},
           {label = ''}
    )
    DB_TEMPLATE_ONE[field=='Price or Total Return',  value:=label]
    
    label = IND_STATS[k]$cur
    DB_TEMPLATE_ONE[field=='Currency',  value:=label]
    DB_TEMPLATE_ONE[field=='Internal Code',  value:=IND_STATS[k]$code]
    DB_TEMPLATE_ONE[field=='Base Date',  value:=IND_STATS[k]$start]
    DB_TEMPLATE_ONE[field=='Base Value',  value:=IND_STATS[k]$start_value]
    DB_TEMPLATE_ONE[field=='History since',  value:=IND_STATS[k]$start]
    if (grepl("IFRC/BEQ",IND_STATS[k]$full_name))
    {
      DB_TEMPLATE_ONE[field=='Launching date', value:='2023-03-15']
    }else{
      DB_TEMPLATE_ONE[field=='Launching date', value:='']
    }
    My.Kable.All(DB_TEMPLATE_ONE)
    X_List[[k]] = DB_TEMPLATE_ONE[, -c('dynamic')]
  }
  
  SPECIFICATIONS_ALL = rbindlist(X_List)
  My.Kable(SPECIFICATIONS_ALL)
  # saveRDS(SPECIFICATIONS_ALL, paste0('R:/CCPR/DATA/DASHBOARD/', 'INDETF_SPECIFICATIONS_ALL.rds'))
  # CCPR_SAVERDS(SPECIFICATIONS_ALL, 'R:/CCPR/DATA/DASHBOARD/', 'INDGICS_SPECIFICATIONS_ALL.rds')
  
  
  
  if (ToSave) {CCPR_SAVERDS (SPECIFICATIONS_ALL, ToFolder , ToFile)}
  My_Data = SPECIFICATIONS_ALL
  # ToMerge =T
  if (ToMerge) { 
    if (file.exists (paste0( FolderMerge , FileMerge )) ) {
      Data_Old = CCPR_READRDS( FolderMerge , FileMerge, ToRestore = T)
    } else {Data_Old = data.table () }
    # SPECIFICATIONS_ALL
    My_Data = unique ( rbind (Data_Old, SPECIFICATIONS_ALL, fill =T), fromLast = T, by = c ('field', 'index_code') )
    # pDate = '2024-01-12'
    My_Data = UPDATE_UPDATED(My_Data)
    CCPR_SAVERDS(My_Data, FolderMerge , FileMerge )
  }
  
  if (ToUpload) {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower( 'ccpi_secondary_specifications'),
                                     l.filepath= tolower(paste0(FolderMerge , FileMerge)),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
  return (My_Data)
}
# ==================================================================================================
TRAINEE_CCPI_DASHBOARD_FIGURES = function ( pFolder = paste0('S:/SHINY/INDEX/WOMENCEO/FRA/'), pFile = 'IFRC_CCPR_INDWCEOFRA_HISTORY.rds', 
                                            ToFolder = '' , ToFile  = '', 
                                            FolderMerge = '', FileMerge = '',
                                            ToSave = T,
                                            ToIntergration = F, ToUpload = F , pDate = '2024-03-29', pHost = '')  {
  # ------------------------------------------------------------------------------------------------
  # FIGURES ........................................................................................
  IND_HISTORY = CCPR_READRDS(pFolder,pFile , ToKable=T, ToRestore = T)
  IND_2023    = IND_HISTORY[year(date)==2023]
  
  IND_VNI     = CCPR_READRDS(paste0('S:/CCPR/DATA/DASHBOARD/'), 'CCPR_INDVNI_HISTORY.rds', ToKable=T) 
  # CCPR_SAVERDS(IND_VNI,('S:/CCPR/DATA/DASHBOARD/'), 'CCPR_INDVNI_HISTORY.rds' )
  IND_VNI     = IND_VNI[order(date)]
  IND_VNI[, lnrt:=log(close/shift(close)), by='code']
  
  IND_2023[, rt:=close/shift(close)-1, by='code']
  IND_2023[, lnrt:=log(close/shift(close)), by='code']
  
  IND_VNI[, rt:=close/shift(close)-1, by='code']
  IND_VNI[, lnrt:=log(close/shift(close)), by='code']
  
  IND_2023    = merge(IND_2023[, -c('benchmark')], IND_VNI[, .(date, benchmark=lnrt)], all.x=T, by='date')
  My.Kable(IND_2023)
  IND_2023[, dlnrt:=lnrt-benchmark]
  
  
  # IND_HISTORY = CCPR_READRDS(paste0('R:/CCPR/DATA/DASHBOARD/'), 'ccpi_dashboard_indvn_history.rds', ToKable=T)
  DB_TEMPLATE = setDT(fread(paste0('S:/CCPR/DATA/DASHBOARD/', 'template_figures.txt')))
  DB_TEMPLATE_EMPTY = DB_TEMPLATE
  DB_TEMPLATE_EMPTY$value=NULL
  DB_TEMPLATE_EMPTY$value=as.character('')
  str(DB_TEMPLATE_EMPTY)
  # 
  # IND_HISTORY = IND_HISTORY[order(code, date)][grepl('^IND', code)]
  # IND_2023    = IND_HISTORY[, lnrt:=log(close/shift(close)), by='code'][year(date)==2023]
  # IND_2023    = merge(IND_2023[, -c('benchmark')], IND_VNI[, .(date, benchmark=lnrt)], all.x=T, by='date')
  # My.Kable(IND_2023)
  # IND_2023[, dlnrt:=lnrt-benchmark]
  IND_2023_STATS = IND_2023[, .(
    volatility=sqrt(250)*100*sqrt(var(lnrt, na.rm=T)),
    tracking_error=100*sqrt(var(dlnrt, na.rm=T))
  ), by='code']
  IND_2023_STATS = IND_2023_STATS[!is.na(volatility)]
  My.Kable(IND_2023_STATS)
  
  IND_List     = unique(IND_HISTORY[date<=pDate][grepl('^IND', code)]$code)
  IND_HISTORY_STATS = IND_HISTORY[date<=pDate][,.(
    min_close=round(min(close, na.rm=T),2), 
    avg_close=round(mean(close, na.rm=T),2), 
    max_close=round(max(close, na.rm=T),2)
  ) , by=c('code')]
  IND_HISTORY_STATS = merge(IND_HISTORY_STATS[, -c('volatility', 'tracking_error')], IND_2023_STATS, all.x=T, by='code')
  
  FIGURES_List = list()
  for (k in 1:length(IND_List))
  {
    # k = 12
    pData = IND_2023[code==IND_List[[k]]][!is.na(lnrt) & !is.na(benchmark)]
    # pData = IND_2023[code=='INDGI2BBA05CWPRVND'][!is.na(lnrt) & !is.na(benchmark)]
    if ( nrow (pData) > 1) {
      fit <- lm(lnrt ~ benchmark, data=pData)
      
      beta  = fit$coefficients[2] # This prints out the beta
      alpha = fit$coefficients[1] # This prints out the beta
      
      
      DB_TEMPLATE_ONE = setDT(copy(DB_TEMPLATE_EMPTY))
      DB_TEMPLATE_ONE[, figure:=trimws(as.character(figure))]
      DB_TEMPLATE_ONE[, index_code:=IND_List[[k]]]
      DB_TEMPLATE_ONE[figure=='Lowest level',   value:=as.character(IND_HISTORY_STATS[k]$min_close)]
      DB_TEMPLATE_ONE[figure=='Highest level',  value:=as.character(IND_HISTORY_STATS[k]$max_close)]
      DB_TEMPLATE_ONE[figure=='Volatility',     value:=paste(as.character(round(IND_HISTORY_STATS[k]$volatility,2)), '%')]
      DB_TEMPLATE_ONE[figure=='Tracking error', value:=paste(as.character(round(IND_HISTORY_STATS[k]$tracking_error,2)), '%')]
      DB_TEMPLATE_ONE[figure=='Alpha',          value:=as.character(round(alpha,6))]
      DB_TEMPLATE_ONE[figure=='Beta',           value:=as.character(round(beta,6))]
      My.Kable.All(DB_TEMPLATE_ONE)
      FIGURES_List[[k]] = DB_TEMPLATE_ONE } else {  FIGURES_List[[k]] = data.table ()}
  }
  FIGURES_ALL = rbindlist(FIGURES_List)
  My.Kable(FIGURES_ALL)
  
  
  if (ToSave ) { CCPR_SAVERDS (FIGURES_ALL, ToFolder , ToFile) }
  # saveRDS(FIGURES_ALL, paste0('R:/CCPR/DATA/DASHBOARD/', 'FIGURES_ALL.rds'))
  My_Data = FIGURES_ALL
  if (ToIntergration) { 
    if (file.exists (paste0(FolderMerge , FileMerge)) ) {
      Data_Old = CCPR_READRDS( FolderMerge , FileMerge, ToRestore = T)
    } else {Data_Old = data.table () }
    # SPECIFICATIONS_ALL
    My_Data = unique ( rbind (Data_Old, FIGURES_ALL, fill =T), fromLast = T, by = c ('figure', 'index_code') )
    # pDate = '2024-01-12'
    My_Data = UPDATE_UPDATED(My_Data)
    CCPR_SAVERDS(My_Data, FolderMerge , FileMerge )
  }
  
  if (ToUpload) {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = pHost, l.tablename= tolower( 'ccpi_secondary_figures'),
                                     l.filepath= tolower(paste0(FolderMerge , FileMerge)),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
  
  return (My_Data)
}

# ==================================================================================================
TRAINEE_CONVERT_RDS_TO_FST = function(file_date = "S:/SHINY/REPORTS/FILE_DATES.rds") {
  # ------------------------------------------------------------------------------------------------
  # file_date = "S:/SHINY/REPORTS/FILE_.DATES.rds"
  # if (!file.exists(file_date)) 
  # {
  data <- setDT(read_excel("S:/SHINY/REPORTS/SHINY_REPORT_MANAGEMENT.xlsx"))
  data = data[tolower(FILE_TYPE) == "rds"]
  data$checkdate = as.character(NA)
  My.Kable(data)
  
  for (k in 1:nrow(data)) 
  {
    #k = 1
    file_name = paste0("S:/SHINY/", data[k]$page, "/", data[k]$Tab_label, "/", data[k]$FILE_NAME, ".", data[k]$FILE_TYPE)
    if (file.exists(file_name))
    {
      mf = file.info(file_name)
      mf$mtime
      data[k]$checkdate = as.character(mf$mtime)
      
    }
  }
  dataid = data[, id:=seq.int(1, .N)]
  My.Kable.All(dataid[,. (id, page, Tab_label, FILE_NAME, checkdate)])
  My.Kable.All(data[,. (page, Tab_label, FILE_NAME, checkdate)])
  saveRDS(data, file_date)
  # }
  
  # ------------------------------------------------------------------------------------------------
  #file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"
  if (file.exists(file_date)) 
  {
    dates = setDT(readRDS(file_date))
    data <- setDT(read_excel("S:/SHINY/REPORTS/SHINY_REPORT_MANAGEMENT.xlsx"))
    data = data[tolower(FILE_TYPE) == "rds"]
    data$checkdate = as.character(NA)
    dataid = data[, id:=seq.int(1, .N)]
    My.Kable.All(dataid[,. (id, page, Tab_label, FILE_NAME, checkdate)])
    
    
    for (k in 1:nrow(data)) 
    {
      # k = 1
      # k = 56
      # k = 65
      x = "download_ifrc_indetf_history"
      file_name = paste0("S:/SHINY/", data[k]$page, "/", data[k]$Tab_label, "/", data[k]$FILE_NAME, ".", data[k]$FILE_TYPE)
      CATln(''); CATln(paste(k, file_name))
      if (file.exists(file_name))
      {
        df = dates[page == data[k]$page & Tab_label == data[k]$Tab_label & FILE_NAME == data[k]$FILE_NAME]
        if (nrow(df) == 1)
        {
          mf       = file.info(file_name)
          mf$mtime = as.character(mf$mtime)
          if (is.na(df$checkdate) || (df$checkdate != mf$mtime))x
          {
            x <- try(readRDS(file_name), silent = TRUE) 
            if (all(class(x)!='try-error'))
            {
              fst_file <- fst::write_fst(x, gsub(".rds", ".fst", file_name, ignore.case = T))
              dates[page == data[k]$page & Tab_label == data[k]$Tab_label & FILE_NAME == data[k]$FILE_NAME, checkdate := mf$mtime]
              CATln_Border(file_name)
            }
          }
        }
        
      }
    }
    My.Kable(dates[,. (page, Tab_label, FILE_NAME, checkdate)])
    dates[, last_updated := substr (as.character (Sys.time()),1,19)]
    saveRDS(dates, file_date)
    return(dates)
  }
}

# ==================================================================================================
OLD_TRAINEE_CONVERT_RDS_TO_FST = function(file_date = "S:/SHINY/REPORTS/FILE_DATES.rds") {
  # ------------------------------------------------------------------------------------------------
  # file_date = "S:/SHINY/REPORTS/FILE_.DATES.rds"
  if (!file.exists(file_date)) 
  {
    data <- setDT(read_excel("S:/SHINY/REPORTS/SHINY_REPORT_MANAGEMENT.xlsx"))
    data = data[tolower(FILE_TYPE) == "rds"]
    data$checkdate = as.character(NA)
    My.Kable(data)
    
    for (k in 1:nrow(data)) 
    {
      #k = 1
      file_name = paste0("S:/SHINY/", data[k]$page, "/", data[k]$Tab_label, "/", data[k]$FILE_NAME, ".", data[k]$FILE_TYPE)
      if (file.exists(file_name))
      {
        mf = file.info(file_name)
        mf$mtime
        data[k]$checkdate = as.character(mf$mtime)
        
      }
    }
    My.Kable(data[,. (page, Tab_label, FILE_NAME, checkdate)])
    saveRDS(data, file_date)
  }
  
  # ------------------------------------------------------------------------------------------------
  #file_date = "S:/SHINY/REPORTS/FILE_DATES.rds"
  if (file.exists(file_date)) 
  {
    dates = setDT(readRDS(file_date))
    data <- setDT(read_excel("S:/SHINY/REPORTS/SHINY_REPORT_MANAGEMENT.xlsx"))
    data = data[tolower(FILE_TYPE) == "rds"]
    data$checkdate = as.character(NA)
    My.Kable(data)
    
    for (k in 1:nrow(data)) 
    {
      #k = 1
      CAT
      file_name = paste0("S:/SHINY/", data[k]$page, "/", data[k]$Tab_label, "/", data[k]$FILE_NAME, ".", data[k]$FILE_TYPE)
      if (file.exists(file_name))
      {
        df = dates[page == data[k]$page & Tab_label == data[k]$Tab_label & FILE_NAME == data[k]$FILE_NAME]
        if (nrow(df) == 1)
        {
          mf = file.info(file_name)
          mf$mtime = as.character(mf$mtime)
          if (df$checkdate != mf$mtime)
          {
            
            x <- try(readRDS(file_name), silent = TRUE) 
            
            fst_file <- fst::write_fst(x, gsub(".rds", ".fst", file_name, ignore.case = T))
            dates[page == data[k]$page & Tab_label == data[k]$Tab_label & FILE_NAME == data[k]$FILE_NAME, checkdate := mf$mtime]
            CATln_Border(file_name)
          }
        }
        
      }
    }
    My.Kable(dates[,. (page, Tab_label, FILE_NAME, checkdate)])
    dates[, last_updated := substr (as.character (Sys.time()),1,19)]
    saveRDS(dates, file_date)
    return(dates)
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_HSX_STKVN_REF = function(pFolder=SData, pFile = '' ) {
  # ------------------------------------------------------------------------------------------------
  # x = IFRC_DOWNLOAD_HSX_STKVN_REF(pFolder=SData, ToIntegrateHistory=T)
  
  # install.package("vietnameseConverter")
  # library(vietnameseConverter)
  # x_ref = DOWNLOAD_HSX_STKVN_REF()
  # SaveFolder="U:/EFRC/DATA/STKVN/DAY/REF/"
  #  SaveFolder="U:/EFRC/DATA/STKVN/DAY/REF/"; ToIntegrateHistory=F
  # IFRC_RELEASE_MEMORY("",F)
  # time_start = Sys.time(); function_name=match.call()[[1]]
  # MHM_FUNCTION_HEADER(p.cat=T, p.option="START", function_name) 
  # LOAD_INSREF_INDREF(l_option="DAY")
  # ................................................................................................
  nr_page   = 0
  ToContinu = T
  data_group = data.table()
  
  while (ToContinu)
  {
    nr_page = nr_page+1
    # nr_page = 5
    DATACENTER_LINE_BORDER(nr_page)
    LcURL = paste0("https://www.hsx.vn/Modules/Listed/Web/SymbolList?pageFieldName1=Code&pageFieldValue1=&pageFieldOperator1=eq&pageFieldName2=Sectors&pageFieldValue2=&pageFieldOperator2=&pageFieldName3=Sector&pageFieldValue3=00000000-0000-0000-0000-000000000000&pageFieldOperator3=&pageFieldName4=StartWith&pageFieldValue4=&pageFieldOperator4=&pageCriteriaLength=4&_search=false&nd=1559705825560&rows=100&page=", nr_page, "&sidx=id&sord=desc")
    print(LcURL)
    rm(web.data)
    web.data = try(jsonlite::fromJSON(LcURL)$row)
    
    hsx.ref = setDT(web.data)
    if (nrow(hsx.ref)>0)
    {
      hsx.ref = hsx.ref[,2]
      # Convert list to table
      
      dt.out =data.table::rbindlist(list(hsx.ref$cell))
      dt.out = as.data.table(dt.out)
      
      str(dt.out)
      dt.out.tr = data.table::transpose(dt.out, fill=NA)
      str(dt.out.tr)
      
      
      # x = "41.000.000,00"
      #   gsub("\\,", "\\.", gsub("\\.","", x))
      # x = "25/12/2009"
      # as.Date(x, format="%d/%m/%Y")
      
      colnames(dt.out.tr) = c("cid", "ticker", "isin", "figi", "source_name_vn", "shlis", "shout", "ipo")
      dt.out.tr[, ":="(shlis=as.numeric(gsub("\\,", "\\.", gsub("\\.","", shlis))), 
                       shout=as.numeric(gsub("\\,", "\\.", gsub("\\.","", shout))))]
      dt.out.tr[, ":="(ipo=as.Date(ipo, format="%d/%m/%Y"))]
      My.Kable(dt.out.tr[, -c("source_name_vn")])
    } else { dt.out.tr = data.table()}
    
    if (nrow(dt.out.tr)>0) {
      data_group = rbind(data_group, dt.out.tr)
    } else {ToContinu=F}
  }
  
  if (nrow(data_group)>0) 
  {
    data_group = unique(data_group,by=c("ticker"))[nchar(ticker)==3]
    data_group[, lastupdate:=Sys.Date()]
    data_group[, source_name:=vietnameseConverter::decodeVN(source_name_vn, from='Unicode', to='Unicode', diacritics=F)]
    # str(data_group)
    My.Kable(data_group[, -c('')])
    Last_Trading =  CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
    data_group[, ":="(market="HSX", source="HSX", codesource=ticker, code=paste0("STKVN", ticker), 
                      date=Last_Trading)]
    data_group[, ":="(shareslis=shlis, sharesout=shout)]
    My.Kable(data_group[, -c('name_vn', 'source', 'codesource', 'shlis', 'shout')])
    
    if (nrow (data_group > 0))
    {   CCPR_SAVERDS(data_group, pFolder, pFile, ToSummary=T, SaveOneDrive = T) }
    
    return (data_group)
    
  }
  # ............................................................................
  return(data_group)
}

# ==================================================================================================
DOWNLOAD_SOURCE_STKVN_SHARES = function(pSource= 'VST', pCode = 'VNM')  {
  # ------------------------------------------------------------------------------------------------
  Final_Data = data.table()
  switch ( pSource, 
           'VST' = {
             pURL = paste0('https://finance.vietstock.vn/', toupper(pCode), '/profile.htm?languageid=2')
             # pURL = paste0('https://finance.vietstock.vn/', toupper(pCode), '/ho-so-doanh-nghiep.htm')
             CATln_Border(pURL)
             content    = try(rvest::read_html(pURL))
             
             if (all(class(content)!='try-error'))
             {
               tables     = content %>% html_table(fill = TRUE)
               if (length(tables)>0)
               {
                 xData      = SELECT_TABLE_WITH_FIELD(tables, pField='x1', pContent="Shares outstanding", like=F)
                 if (all(class(xData)!='try-error') & any(grepl('Shares outstanding',xData$x1)))
                 {
                   xData$field   = decodeVN(xData$x1, from='Unicode', to='Unicode', diacritics=F)
                   SharesOut  = as.numeric(gsub(',','', xData[field=='Shares outstanding']$x2))
                   SharesLis  = as.numeric(gsub(',','', xData[field=='Listed shares']$x2))
                   SharesFirst  = as.numeric(gsub(',','', xData[field=='First listed volume']$x2))
                   DateFirst    = as.Date(xData[field=='First trading date']$x2,'%m/%d/%Y')
                   
                   Final_Data = data.table(source='VST', codesource=pCode, ticker=pCode, date=SYSDATETIME(9), code=paste0('STKVN', pCode), 
                                           sharesout=SharesOut, shareslis=SharesLis, shares1st=SharesFirst, date1st=DateFirst, updated=substr(as.character(Sys.time()),1,19)) 
                   My.Kable.All(Final_Data)
                 }
               }
             } else {
               Final_Data = data.table(source='VST', codesource=pCode, ticker=pCode, date=SYSDATETIME(9), code=paste0('STKVN', pCode))
             }
             
           },
           'C68'  = {
             pURL = paste0('https://www.cophieu68.vn/quote/profile.php?id=', tolower(pCode))
             CATln_Border(pURL)
             content    = try(rvest::read_html(pURL))
             if (all(class(content)!='try-error'))
             {
               tables     = content %>% html_table(fill = TRUE)
               if (length(tables)>0)
               {
                 # xData      = as.data.table(tables[[1]])
                 xData      = SELECT_TABLE_WITH_FIELD(tables, pField='x1', pContent="KL lưu hành", like=F)
                 # xData$field = decodeVN(xData$X1, from='Unicode', to='Unicode', diacritics=F)
                 xData$field   = decodeVN(xData$x1, from='Unicode', to='Unicode', diacritics=F)
                 SharesOut  = as.numeric(gsub(',','', xData[field=='KL luu hanh']$x2))
                 SharesLis  = as.numeric(gsub(',','', xData[field=='KL niem yet']$x2))
                 LastTrading = CCPR_LAST_TRADING_DAY_VN(max(9, hour(Sys.time())), ToPrompt = T)
                 # LastTrading = '2023-09-27'
                 Final_Data = data.table(source='C68', codesource=pCode, ticker=pCode, date=LastTrading, code=paste0('STKVN', pCode),
                                         sharesout=SharesOut, shareslis=SharesLis, updated=substr(as.character(Sys.time()),1,19)) 
                 My.Kable.All(Final_Data)
               }
             }
           })
  
  return (Final_Data)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_EXC_PRICESBOARD = function (Source = 'EXC', Market = 'HSX') {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:21
  # x = try(TRAINEE_DOWNLOAD_EXC_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket', Source = 'EXC', Market = 'HNX'))
  # x = try(TRAINEE_DOWNLOAD_EXC_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket', Source = 'EXC', Market = 'UPC'))
  # x = try(TRAINEE_DOWNLOAD_EXC_PRICESBOARD (pURL = 'https://www.hsx.vn/Modules/Rsde/RealtimeTable/LiveSecurity', Source = 'EXC', Market = 'HSX'))
  # Market = 'HNX'
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  tabs = c("ABC", "DEF", "GHI", "JKL", "MNO", "PQR", "STUV", "WXYZ")
  Final_Data = data.table()
  pData = list ()
  
  switch(Market,
         'UPC' = {
           pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket'
           for (k in 1:length(tabs)) {
             my.param  = list (
               pKeyAreas= tabs[[k]],
               pFloorCode='UPC'
             )
             
             rm(res)
             res    = try(POST(pURL, body = my.param, encode = "form"))
             
             if (all(class(res)!="try-eror"))
             {
               rm(x.out)
               x.out   = content(res, type="text", encoding = "UTF-8")
               x.data  = as.data.table(jsonlite::fromJSON(x.out))
               str(x.data)
               FileTmp = FILE_TEMP_WITH_PREFIX(Prefix = 'TEMP_', Ext = '.TXT')
               fwrite(x.data[, .(obj)], paste0('c:/temp/', FileTmp))
               dt      = fread(paste0('c:/temp/', FileTmp), sep = "|", header = F)
               Data = dt[, .(source=Source, ticker=V2, market=Market, reference=word(V7,2,2,'[*]'), last=word(V17,2,2,'[*]'),change=word(V16,2,2,'[*]'), volume=word(V19,2,2,'[*]'),
                             close=word(V34,2,2,'[*]'))]
               pData[[k]] = Data
             }
             
           }
           Final_Data = rbindlist(pData, fill=T)
           str (Final_Data)
           Final_Data[, code:=paste0('STKVN', ticker)]
           Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub (',','',reference)))]
           Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub (',','',last)))]
           Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub (',','',change)))]
           Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 1000*as.numeric(gsub(',', '',volume)))]
           Final_Data[, close := as.numeric(NA)]
           Final_Data[, date := LastTrading]
           Final_Data[, updated := substr(as.character(Sys.time()), 1, 19) ]
         }
         ,
         'HNX' = {
           pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket'
           for (k in 1:length(tabs)) {
             # k =  1
             my.param  = list (
               pKeyAreas = tabs[[k]],
               pFloorCode ='LIS'
             )
             
             rm(res)
             res    = try(POST(pURL, body = my.param, encode = "form"))
             
             if (all(class(res)!="try-eror"))
             {
               # typeof(res)
               rm(x.out)
               x.out   = content(res, type="text", encoding = "UTF-8")
               x.data  = as.data.table(jsonlite::fromJSON(x.out))
               str(x.data)
               FileTmp = FILE_TEMP_WITH_PREFIX(Prefix = 'TEMP_', Ext = '.TXT')
               fwrite(x.data[, .(obj)], paste0('c:/temp/', FileTmp))
               dt      = fread(paste0('c:/temp/', FileTmp), sep = "|", header = F)
               Data = dt[, .(source=Source, ticker=V2, market=Market, reference=word(V7,2,2,'[*]'), last=word(V17,2,2,'[*]'),change=word(V16,2,2,'[*]'), volume=word(V19,2,2,'[*]'),
                             close=word(V34,2,2,'[*]'))]
               pData[[k]] = Data
             }
           }
           Final_Data = rbindlist(pData, fill=T)
           str (Final_Data)
           Final_Data[, code:=paste0('STKVN', ticker)]
           Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub (',','',reference)))]
           Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub (',','',last)))]
           Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub (',','',change)))]
           Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 1000*as.numeric(gsub(',', '',volume)))]
           Final_Data[, close := as.numeric(NA)]
           Final_Data[, date := LastTrading]
           Final_Data[, updated := substr(as.character(Sys.time()), 1, 19) ]
         }
         ,
         'HSX'=  {
           pURL = 'https://www.hsx.vn/Modules/Rsde/RealtimeTable/LiveSecurity'
           table <- data.table()
           while (nrow(table) < 5){
             CATrp('Loading HTML')
             xweb       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T, pSleep = 10)
             CATrp('Reading HTML')
             html       = read_html(xweb)
             CATrp('Parsing HTML')
             tables     = html_nodes(html, xpath = '//*[@id="table-deal-stock"]') %>% html_table(fill = TRUE)  # Assuming first table element
             table      = as.data.table(tables[[1]])
             Sys.sleep(5)
           }
           
           
           CATrp('Cleaning Data')
           # LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
           # class(tables[[1]])
           # data_table = setDT(html_table(tables[[1]]))
           # Source = 'EXC'
           # Market = 'HSX'
           data_table = as.data.table(tables[[1]])
           
           Final_Data = data_table[, .(source=Source, market=Market, ticker=`Mã CK`, reference=`ĐCGN`, last = data_table[,11], change = data_table[,13], volume = data_table[, 24])]
           Final_Data <- Final_Data[-c(1), ]
           # Final_Data <- Final_Data[-nrow(Final_Data), ]
           names(Final_Data)[5] <- "last"
           names(Final_Data)[6] <- "change"
           
           names(Final_Data)[7] <- "volume"
           str (Final_Data)
           # Final_Data[, code:=paste0('STKVN', ticker)]
           # Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub (',','',reference)))]
           # Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub (',','',last)))]
           # Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub (',','',change)))]
           # Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 1000*as.numeric(gsub(',', '',volume)))]
           # Final_Data[, close := as.numeric(NA)]
           # Final_Data[, date := LastTrading]
           # Final_Data[, updated := substr(as.character(Sys.time()), 1, 19) ]
           Final_Data[, code:=paste0('STKVN', ticker)]
           Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub (',','.',reference)))]
           Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub (',','.',last)))]
           Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub (',','.',change)))]
           Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 100*as.numeric(gsub(',', '.',volume)))]
           Final_Data[, close := as.numeric(NA)]
           Final_Data[, date := LastTrading]
           Final_Data[, updated := substr(as.character(Sys.time()), 1, 19) ]
           # My.Kable.All(Final_Data[ticker == 'NBB'])
         })
  
  
  
  pHour  = as.POSIXct(substr(as.character(Sys.time()), 1, 19))
  hour   = unique(format(pHour, "%H"))
  minute = unique(format(pHour, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := as.numeric(last )]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  My.Kable.TB(Final_Data[order(ticker)])
  
  if (nrow(Final_Data)>0)
  {
    CCPR_SAVERDS(Final_Data, 'S:/STKVN/PRICES/DAY/', paste0('DOWNLOAD_', Market, '_PRICESBOARD_DAY.rds'))
    CCPR_SAVERDS(Final_Data, 'S:/STKVN/PRICES/DAY/', paste0('DOWNLOAD_', Market, '_PRICESBOARD_', gsub('-','', LastTrading),'.rds'))
  }
  return (Final_Data)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_EXC_PRICESBOARD_OLD = function (SaveFolder = '', SaveFile = 'DOWNLOAD_EXC_PRICESBOARD_DAY.rds',ToSave = F, ToIntegrate = F)  {
  # ------------------------------------------------------------------------------------------------
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  switch (pSource, 
          'HSX' = {
            HSX = TRAINEE_DOWNLOAD_HSX_PRICESBOARD (pURL = 'https://www.hsx.vn/Modules/Rsde/RealtimeTable/LiveSecurity',
                                                    Source = 'EXC',
                                                    Market = 'HSX')
          },
          'HNX' = {
            HNX =  TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
                                                     Source = 'EXC',
                                                     Market = 'UPC') 
          },
          'UPC' = {
            UPC =  TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
                                                     Source = 'EXC',
                                                     Market = 'UPC')
          }
  )
  
  Data_final = rbind(HSX, HNX, UPC, fill = T)
  My.Kable(Data_final)
  
  Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                               "close", "date", "updated", "name"), with = FALSE]
  
  if (ToSave)
  {
    Save_File_Day = paste0('DOWNLOAD_EXC_PRICESBOARD_DAY_',gsub('-','', LastTrading),'.rds')
    Save_File     = SaveFile
    CCPR_SAVERDS(Data_final,SaveFolder, Save_File_Day, ToSummary = T)
    CCPR_SAVERDS(Data_final,SaveFolder, SaveFile, ToSummary = T)
  }
  
  if (ToIntegrate)
  {
    File_History = paste0('DOWNLOAD_EXC_PRICESBOARD_HISTORY.rds')
    if (file.exists (paste0 (SaveFolder, File_History))) {
      DATA_OLD = CCPR_READRDS (SaveFolder, File_History, ToKable = T)
    } else { DATA_OLD = data.table ()}
    
    DATA_NEW = unique ( rbind (DATA_OLD, Data_final, fill =T), fromLast = T, by = c('code','date') )
    CCPR_SAVERDS(DATA_NEW , SaveFolder, File_History, ToSummary = T)
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_SOURCES_STKVN_PRICESBOARD = function()  {
  # ------------------------------------------------------------------------------------------------
  
  LastTrading  = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  # List_SOURCES = sample(list('VND','CAF',  'TVSI', 'VST', 'VPS', 'MBS', 'BSC', 'EXC', 'C68')) #
  List_SOURCES = sample(LIST_SOURCES_PRICESBOARD) #
  
  for (k in 1:length(List_SOURCES))
  {
    # k = 1
    pSOURCE      = List_SOURCES[[k]]
    # pSOURCE      = 'C68'
    CATln_Border(pSOURCE)
    PRICES_BOARD = CHECK_CLASS(try(TRAINEE_DOWNLOAD_SOURCE_PRICESBOARD_OPEN_CLOSE_DAY (pSource       = pSOURCE, 
                                                                                       Save_Folder = 'S:/STKVN/PRICES/DAY/',
                                                                                       Save_File   = T)))
    
    My.Kable.TB(PRICES_BOARD)
    if (nrow(PRICES_BOARD)>0)
    {
      Save_File = paste0('DOWNLOAD_', pSOURCE, '_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
      Save_Day  = paste0('DOWNLOAD_', pSOURCE, '_PRICESBOARD_DAY.rds')
      Hst_File  = paste0('DOWNLOAD_', pSOURCE, '_PRICESBOARD_', gsub('-', '', LastTrading), '_INTRADAY.rds')
      Hst_File  = paste0('DOWNLOAD_', pSOURCE, '_PRICESBOARD_', gsub('-', '', LastTrading), '_INTRADAY.rds')
      
      HISTORY   = CHECK_CLASS(try(CCPR_READRDS('S:/STKVN/PRICES/DAY/', Hst_File)))
      HISTORY   = unique(rbind(HISTORY, PRICES_BOARD, fill=T), by=c('code', 'updated'))
      My.Kable.TB(HISTORY)
      if (nrow(HISTORY)>0) { try(CCPR_SAVERDS(HISTORY, 'S:/STKVN/PRICES/DAY/', Hst_File, ToSummary = T)) }
    }
    IFRC_SLEEP(10)
  }
}

# ==================================================================================================
# ==================================================================================================
TRAINEE_DOWNLOAD_SOURCES_STKVN_INFO = function()  {
  # ------------------------------------------------------------------------------------------------
  LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13)), ToPrompt = T))
  
  #HSX - SHARES
  x = TRAINEE_DOWNLOAD_HSX_STKVN_SHARES_BY_PAGE (pFolder='S:/STKVN/PRICES/DAY/', ToIntegrateHistory=T) 
  
  #UPC - HNX - SHARES_LastTrading
  OPTION_LIST = sample(list('RANDOM', 'RANKING_ASC', 'RANKING_DESC'))
  
  for (OPTION in OPTION_LIST)
  {
    # try(TRAINEE_DOWNLOAD_SOURCES_STKVN_INFO())
    # OPTION = 'RANDOM'
    CATln_Border(paste('HNX', OPTION))
    switch(OPTION,
           'RANDOM' = {
             z =              try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = '', random = T,
                                                                    pMarket    = 'HNX', 
                                                                    pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                                    File_Pattern  = paste0('DOWNLOAD_', 'HNX', '_STKVN_SHARES'),
                                                                    pDate      = LastTrading,
                                                                    List_Codes = list(),
                                                                    File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                                    Action     = 'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE'))
           },
           'RANKING_ASC' = {
             z =              try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'ASC', FirstChars = '', random = T,
                                                                    pMarket    = 'HNX', 
                                                                    pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                                    File_Pattern  = paste0('DOWNLOAD_', 'HNX', '_STKVN_SHARES'),
                                                                    pDate      = LastTrading,
                                                                    List_Codes = list(),
                                                                    File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                                    Action     = 'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE'))
           },
           'RANKING_DESC' = {
             z =             try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'DESC', FirstChars = '', random = T,
                                                                   pMarket    = 'HNX', 
                                                                   pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                                   File_Pattern  = paste0('DOWNLOAD_', 'HNX', '_STKVN_SHARES'),
                                                                   pDate      = LastTrading,
                                                                   List_Codes = list(),
                                                                   File_Codes = "S:/CCPR/DATA/download_hnx_stkvn_ref_history.rds",
                                                                   Action     = 'TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE'))
           }
    )
  }
  COPY_PRICESBOARD_SNAPSHOT_YYYYMMDD_TO_DAY (Prefix='SHARES', pSource='HNX', STKVN=T, ToForce = F)
  
  # UPCOM ----------------------------------------------------------------------------------------
  for (OPTION in OPTION_LIST)
  {
    CATln_Border(paste('UPC', OPTION))
    switch(OPTION,
           'RANDOM' = {
             z = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = '', FirstChars = '', random = T,
                                                       pMarket    = 'UPC', 
                                                       pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                       File_Pattern  = paste0('DOWNLOAD_', 'UPC', '_STKVN_SHARES'),
                                                       pDate      = LastTrading,
                                                       List_Codes = list(),
                                                       File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                       Action     = 'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE'))
             
           },
           'RANKING_ASC' = {
             z = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'ASC', FirstChars = '', random = T,
                                                       pMarket    = 'UPC', 
                                                       pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                       File_Pattern  = paste0('DOWNLOAD_', 'UPC', '_STKVN_SHARES'),
                                                       pDate      = LastTrading,
                                                       List_Codes = list(),
                                                       File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                       Action     = 'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE'))
             
           },
           'RANKING_DESC' = {
             z = try(NEW_LOOP_DOWNLOAD_CUSTOM_BY_CODE( ranking    = 'DESC', FirstChars = '', random = T,
                                                       pMarket    = 'UPC', 
                                                       pFolder    = 'S:/STKVN/PRICES/DAY/',
                                                       File_Pattern  = paste0('DOWNLOAD_', 'UPC', '_STKVN_SHARES'),
                                                       pDate      = LastTrading,
                                                       List_Codes = list(),
                                                       File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds",
                                                       Action     = 'TRAINEE_DOWNLAD_UPC_STKVN_REF_INFO_BY_CODE'))
             
             
             
           }
    )
  }
  
  COPY_PRICESBOARD_SNAPSHOT_YYYYMMDD_TO_DAY (Prefix='SHARES', pSource='UPC', STKVN=T, ToForce = F)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_HSX_PRICESBOARD = function (pURL = 'https://www.hsx.vn/Modules/Rsde/RealtimeTable/LiveSecurity',
                                             Source = 'EXC',
                                             Market = 'HSX'){
  # ------------------------------------------------------------------------------------------------
  tables <- NA
  DBL_RELOAD_INSREF()
  while (is.na(tables)){
    CATrp('Loading HTML')
    xweb       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T, pSleep = 5)
    CATrp('Reading HTML')
    html       = read_html(xweb)
    CATrp('Parsing HTML')
    tables     = html_nodes(html, xpath = '//*[@id="table-deal-stock"]') %>% html_table(fill = TRUE)  # Assuming first table element
    Sys.sleep(1)
  }
  
  CATrp('Cleaning Data')
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  # class(tables[[1]])
  # data_table = setDT(html_table(tables[[1]]))
  data_table = as.data.table(tables[[1]])
  
  Final_Data = data_table[, .(source=Source, market=Market, ticker=`Mã CK`, reference=`ĐCGN`, last = data_table[,11], volume = data_table[, 24])]
  Final_Data <- Final_Data[-c(1), ]
  # Final_Data <- Final_Data[-nrow(Final_Data), ]
  names(Final_Data)[5] <- "last"
  names(Final_Data)[6] <- "volume"
  
  Final_Data[, code:=paste0('STKVN', ticker)]
  
  Final_Data[, reference:=gsub(',','.',reference)]
  Final_Data[, last:=gsub(',','.',last)]
  Final_Data[, volume:=gsub('\\.','',volume)]
  
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
  Final_Data[, close := as.numeric(NA)]
  
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 100*as.numeric(volume))]
  
  Final_Data[, date := LastTrading]
  Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
  
  hour   = unique(format(Final_Data$updated, "%H"))
  minute = unique(format(Final_Data$updated, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  UPDATE_UPDATED (Final_Data)
  # if ('updated' %in% names(Final_Data)) { Final_Data[, updated:=substr(as.character(updated),1,19)]}
  My.Kable(Final_Data)
  
  if (nrow(Final_Data)>0)
  {
    CCPR_SAVERDS(Final_Data, 'S:/STKVN/PRICES/DAY/', paste0('DOWNLOAD_', Market, '_PRICESBOARD_DAY.rds'))
    CCPR_SAVERDS(Final_Data, 'S:/STKVN/PRICES/DAY/', paste0('DOWNLOAD_', Market, '_PRICESBOARD_', gsub('-','', LastTrading),'.rds'))
  }
  
  return (Final_Data)
}

# ==================================================================================================
CHECK_FILES = function(pFolder = 'S:/CCPR/DATA/DAY/',List_Files = list('CCPR_DOWNLOAD_C68_STKVN_SHARES_DAY.rds', 'CCPR_DOWNLOAD_CAF_STKVN_SHARES_DAY.rds'), 
                       List_Fields=list('code', 'date', 'sharesout', 'updated','country', 'iso2') )   {
  # ------------------------------------------------------------------------------------------------
  List_NotOK = data.table()
  # x = as.data.table(openxlsx::read.xlsx('S:/CCPR/DATA/LIST_FILE_RDS_TO_SYNCHRONISE.xlsx'))
  # List_Files = x [active == 1]
  # My.Kable(List_Files)
  
  for (k in 1:length(List_Files))
  {
    # k = 1
    pFile = paste0(pFolder,List_Files [[k]])
    if (file.exists(pFile)) {
      DATA = readRDS(pFile)
      if (!all(List_Fields %in% names (DATA))) {
        data = data.table ( file = List_Files [[k]], fields =        paste( unlist(List_Fields[!List_Fields %in% names (DATA)]), collapse=',') )
        List_NotOK = rbind(List_NotOK, data, fill=T)
        CATln(paste(k, '=', pFile))
      } else {
        CATln_Border('LIST FILES NOT OK = MISSING')
      }
    }
    
    CATln_Border('LIST FILES NOT OK ')
    My.Kable.All(List_NotOK)
  }
  
}
# ==================================================================================================
TRAINEE_GET_MYPC = function(ToPrint=F) {
  # ------------------------------------------------------------------------------------------------
  MYPC = ""
  if (file.exists('c:/r/my_pc.txt'))
  {
    MYPC = as.character(readLines('c:/r/my_pc.txt'))
  }
  if (ToPrint) { print(MYPC)}
  return(MYPC)
}

# ==================================================================================================
SYNCHRONISE_LIST_FILES = function()   {
  # ------------------------------------------------------------------------------------------------
  # SYNCHRONISE_LIST_FILES()
  List_NotOK = data.table()
  List_Files = as.data.table(openxlsx::read.xlsx('S:/CCPR/DATA/LIST_FILE_RDS_TO_SYNCHRONISE.xlsx'))
  My.Kable(List_Files)
  
  for (k in 1:nrow(List_Files))
  {
    # k = 11
    Full_name = paste0(trimws(List_Files[k]$folder_fr), trimws(List_Files[k]$file_fr))
    CATln(paste(k, '=', Full_name))
    if (!file.exists(Full_name))
    {
      List_NotOK = rbind(List_NotOK, List_Files[k], fill=T)
    }
  }
  CATln_Border('LIST FILES NOT OK = MISSING')
  My.Kable.All(List_NotOK)
  
  
  CATln_Border('LIST FILES ACTIVE, SYNCHRONISING ...')
  List_Files_active = List_Files[active==1]
  My.Kable(List_Files_active)
  
  List_NotOK = data.table()
  for (k in 1:nrow(List_Files_active))
  {
    # k = 11
    Full_name = paste0(trimws(List_Files_active[k]$folder_fr), trimws(List_Files_active[k]$file_fr))
    CATln(paste(k, '=', Full_name))
    if (!file.exists(Full_name))
    {
      List_NotOK = rbind(List_NotOK, List_Files_active[k], fill=T)
    } else (
      TRAINEE_SYNCHRONISE_FILE_FROM_TO(From_Folder = List_Files_active[k]$folder_fr,     From_File = List_Files_active[k]$file_fr,
                                       To_Folder   = List_Files_active[k]$folder_to,     To_File   = List_Files_active[k]$file_to,
                                       Method      = 'OVERWRITE', ToForce=F, CheckCode=F)
    )
  }
  
  CATln_Border('LIST FILES ACTIVE & NOT OK = MISSING')
  My.Kable.All(List_NotOK)
  
}

# ==================================================================================================
TRAINEE_CCPR_INTEGRATION_SHARES_DAY = function (pOption = 'SHARES', File_Folder = paste0(SData, 'DAY/'),
                                                To_Folder = '',
                                                LIST_SOURCES = list('HSX','HNX', 'UPC', 'SSI','DCL', 'VST', 'CAF', 'C68', 'STB' , 'VND', 'MSB', 'VPS','TVSI','BVSC', 'EXC'),
                                                ToIntegrate=F)  {
  # ------------------------------------------------------------------------------------------------
  switch (pOption,
          'CLOSE' = {
            LastTrading = CCPR_LAST_TRADING_DAY_VN(15, ToPrompt = T)
            DATA_ALL = data.table()
            for (k in 1:length(LIST_SOURCES))
            {
              # k = 5
              pSource     = LIST_SOURCES[[k]]
              File_Name   = paste0('CCPR_DOWNLOAD_', pSource, '_STKVN_CLOSE_DAY.rds')
              CATln_Border(File_Name)
              File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
              # if ( !'code' %in% colnames (File_Data) ) { File_Data [, code := paste0('STKVN', codesource)]}
              if ( nrow (File_Data) > 0) 
              {
                if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'close', 'source') %in% names(File_Data) ) )
                {
                  xData = File_Data[, .(code, date, source, value=as.numeric(close))] [ date == LastTrading]
                  My.Kable(xData)
                  DATA_ALL = rbind(DATA_ALL, xData, fill=T)
                  DATA_ALL [, source := as.character (source)]
                }
              }
              
            }
            My.Kable(DATA_ALL[order(-date, code)])
            # x = DATA_ALL
            # DATA_ALL [source == 'HSX']
            # DATA_ALL = setDT (DATA_ALL)
            str(DATA_ALL)
            DATA_ALL = unique(DATA_ALL, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
            unique(DATA_ALL, by = 'source')
            MaxDate   = max(DATA_ALL$date)
            DATA_ALL  = DATA_ALL[date==MaxDate]
            DATA_ALL[, value_str:=as.character(round(value,0))]
            My.Kable(DATA_ALL)
            xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
            My.Kable(xCOUNT[order(-n)], Nb=15)
            
            # xCOMPARE = setDT(tidyr::gather(xSELECT, key="source", value="value",3:ncol(xSELECT)))[order(-date, code, source)]
            
            DATA_SPD = setDT(tidyr::spread(DATA_ALL[, -c('value_str')], key="source", value="value"))[!is.na(code)]
            My.Kable.TB(DATA_SPD[order(date, code)])
            xCOUNT_N2 = xCOUNT[n>=2]
            xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
            DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
            
            
            if ('UPC' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (UPC), final := UPC] }
            if ('HSX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HSX), final := HSX] }
            if ('HNX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HNX), final := HNX] }
            if ('CAF' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (CAF), final := CAF] }
            if ('VST' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VST), final := VST] }
            if ('VND' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VND), final := VND] }
            if ('STB' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (STB), final := STB] }
            if ('C68' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (C68), final := C68] }
            if ('VPS' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VPS), final := VPS] }
            
            DATA_SPD [, ':='(close=final, dataset='CLOSE')]
            DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_close_day_', gsub ('-','', Sys.Date()),'.rds') , ToSummary = T)
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_close_day.rds') , ToSummary = T)
            if (ToIntegrate)
            {
              File_Old = 'ccpr_download_all_stkvn_close_history.rds'
              Data_Old = CCPR_READRDS(To_Folder, File_Old, ToKable = T)
              Data_Old = rbind(Data_Old, DATA_SPD, fill=T)
              if (nrow(Data_Old)>0)
              {
                Data_Old = unique(Data_Old, by=c('code', 'date'), fromLast = T)[!is.na(code)]
                Data_Old$reference = NULL
                My.Kable.Min(Data_Old)
                CCPR_SAVERDS(Data_Old, To_Folder, File_Old, ToSummary=T, SaveOneDrive = T)
              }
            }
          },
          
          'SHARES' = {
            LastTrading = CCPR_LAST_TRADING_DAY_VN(8, ToPrompt = T)
            DATA_ALL = data.table()
            for (k in 1:length(LIST_SOURCES))
            {
              # k = 9
              pSource     = LIST_SOURCES[[k]]
              File_Name   = paste0('CCPR_DOWNLOAD_', pSource, '_STKVN_SHARES_DAY.rds')
              CATln_Border(File_Name)
              File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
              # if ( !'code' %in% colnames (File_Data) ) { File_Data [, code := paste0('STKVN', codesource)]}
              if ( nrow (File_Data) > 0) 
              {
                if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'sharesout', 'source') %in% names(File_Data) ) )
                {
                  xData = File_Data[, .(code, date, source, value=as.numeric(sharesout))] [ date == LastTrading]
                  My.Kable(xData)
                  DATA_ALL = rbind(DATA_ALL, xData, fill=T)
                  DATA_ALL [, source := as.character (source)]
                }
              }
            }
            My.Kable(DATA_ALL[order(-date, code)])
            # DATA_ALL [source == 'HSX']
            
            DATA_ALL = unique(DATA_ALL, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
            unique(DATA_ALL, by = 'source')
            MaxDate   = max(DATA_ALL$date)
            DATA_ALL  = DATA_ALL[date==MaxDate]
            DATA_ALL[, value_str:=as.character(round(value,0))]
            My.Kable(DATA_ALL)
            xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
            My.Kable(xCOUNT[order(-n)], Nb=15)
            
            # xCOMPARE = setDT(tidyr::gather(xSELECT, key="source", value="value",3:ncol(xSELECT)))[order(-date, code, source)]
            
            DATA_SPD = setDT(tidyr::spread(DATA_ALL[, -c('value_str')], key="source", value="value"))[!is.na(code)]
            My.Kable.TB(DATA_SPD[order(date, code)])
            xCOUNT_N2 = xCOUNT[n>=2]
            xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
            DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
            
            if ('UPC' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (UPC), final := UPC] }
            if ('HSX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HSX), final := HSX] }
            if ('HNX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HNX), final := HNX] }
            if ('CAF' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (CAF), final := CAF] }
            if ('VST' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VST), final := VST] }
            if ('VND' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VND), final := VND] }
            if ('STB' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (STB), final := STB] }
            if ('C68' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (C68), final := C68] }
            if ('VPS' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VPS), final := VPS] }
            
            DATA_SPD [, ':='(close=final, dataset='SHARESOUT')]
            DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_shares_day_', gsub ('-','', Sys.Date()),'.rds') , ToSummary = T)
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_shares_day.rds') , ToSummary = T)
            if (ToIntegrate)
            {
              File_Old = 'ccpr_download_all_stkvn_shares_history.rds'
              Data_Old = CCPR_READRDS('S:/CCPR/DATA/DAY/', File_Old, ToKable = T)
              Data_Old = rbind(Data_Old, DATA_SPD, fill=T)
              if (nrow(Data_Old)>0)
              {
                Data_Old = unique(Data_Old, by=c('code', 'date'), fromLast = T)[!is.na(code)]
                Data_Old$reference = NULL
                My.Kable.Min(Data_Old)
                CCPR_SAVERDS(Data_Old, To_Folder, File_Old, ToSummary=T, SaveOneDrive = T)
              }
            }
            
            
            # CCPR_SAVERDS(DATA_SPD, 'R:/CCPR/DATA/DAY/', 'ccpr_download_all_stkvn_shares_history.rds')
          },
          
          'REFERENCE' = {
            LastTrading = CCPR_LAST_TRADING_DAY_VN(8, ToPrompt = T)
            DATA_ALL = data.table()
            for (k in 1:length(LIST_SOURCES))
            {
              # k = 4
              pSource     = LIST_SOURCES[[k]]
              File_Name   = paste0('CCPR_DOWNLOAD_', pSource, '_STKVN_REFERENCE_DAY.rds')
              CATln_Border(File_Name)
              File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
              # if ( !'code' %in% colnames (File_Data) ) { File_Data [, code := paste0('STKVN', codesource)]}
              if ( nrow (File_Data) > 0) {
                if ('pref' %in% File_Data) {File_Data [, reference := pref] }
                if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'reference', 'source') %in% names(File_Data) ) )
                {
                  xData = File_Data[, .(code, date, source, value=as.numeric(reference))] [ date == LastTrading]
                  My.Kable(xData)
                  DATA_ALL = rbind(DATA_ALL, xData, fill=T)
                  DATA_ALL [, source := as.character (source)]
                }
              }
              
            }
            My.Kable(DATA_ALL[order(-date, code)])
            # x = DATA_ALL
            # DATA_ALL [source == 'HSX']
            # DATA_ALL = setDT (DATA_ALL)
            str(DATA_ALL)
            DATA_ALL = unique(DATA_ALL, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
            # unique(DATA_ALL, by = 'source')
            MaxDate   = max(DATA_ALL$date)
            DATA_ALL  = DATA_ALL[date==MaxDate]
            DATA_ALL[, value_str:=as.character(round(value,0))]
            My.Kable(DATA_ALL)
            xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
            My.Kable(xCOUNT[order(-n)], Nb=15)
            
            # xCOMPARE = setDT(tidyr::gather(xSELECT, key="source", value="value",3:ncol(xSELECT)))[order(-date, code, source)]
            
            DATA_SPD = setDT(tidyr::spread(DATA_ALL[, -c('value_str')], key="source", value="value"))[!is.na(code)]
            My.Kable.TB(DATA_SPD[order(date, code)])
            xCOUNT_N2 = xCOUNT[n>=2]
            xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
            DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
            
            if ('UPC' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (UPC), final := UPC] }
            if ('HSX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HSX), final := HSX] }
            if ('HNX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HNX), final := HNX] }
            if ('CAF' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (CAF), final := CAF] }
            if ('VST' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VST), final := VST] }
            if ('VND' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VND), final := VND] }
            if ('STB' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (STB), final := STB] }
            if ('C68' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (C68), final := C68] }
            if ('VPS' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VPS), final := VPS] }
            # if ('C68' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (C68), final := C68] }
            
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            DATA_SPD [, ':='(reference=final, close=final, dataset='REFERENCE')]
            DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_reference_day_', gsub ('-','', Sys.Date()),'.rds'), ToSummary = T )
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_reference_day.rds'), ToSummary = T )
            if (ToIntegrate)
            {
              File_Old = 'ccpr_download_all_stkvn_reference_history.rds'
              Data_Old = CCPR_READRDS(To_Folder, File_Old, ToKable = T)
              Data_Old = rbind(Data_Old, DATA_SPD, fill=T)
              if (nrow(Data_Old)>0)
              {
                Data_Old = unique(Data_Old, by=c('code', 'date'), fromLast = T)[!is.na(code)]
                My.Kable.Min(Data_Old)
                CCPR_SAVERDS(Data_Old,To_Folder, File_Old, ToSummary=T, SaveOneDrive = T)
              }
            }
            
            # CCPR_SAVERDS(DATA_SPD, 'R:/CCPR/DATA/DAY/', 'ccpr_download_all_stkvn_reference.rds')
          },
          
          'MARKET' = {
            LastTrading = CCPR_LAST_TRADING_DAY_VN(8, ToPrompt = T)
            DATA_ALL = data.table()
            for (k in 1:length(LIST_SOURCES))
            {
              # k = 1
              pSource     = LIST_SOURCES[[k]]
              File_Name   = paste0('CCPR_DOWNLOAD_', pSource, '_STKVN_MARKET_DAY.rds')
              CATln_Border(File_Name)
              File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
              # if ( !'code' %in% colnames (File_Data) ) { File_Data [, code := paste0('STKVN', codesource)]}
              if ( nrow (File_Data) > 0) {
                if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'market', 'source') %in% names(File_Data) ) )
                {
                  xData = File_Data[, .(code, date, source, value=as.character(market))] [ date == LastTrading]
                  My.Kable(xData)
                  DATA_ALL = rbind(DATA_ALL, xData, fill=T)
                  DATA_ALL [, source := as.character (source)]
                }
              }
              
            }
            My.Kable(DATA_ALL[order(-date, code)])
            # x = DATA_ALL
            # DATA_ALL [source == 'HSX']
            # DATA_ALL = setDT (DATA_ALL)
            str(DATA_ALL)
            DATA_ALL = unique(DATA_ALL, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
            unique(DATA_ALL, by = 'source')
            MaxDate   = max(DATA_ALL$date)
            DATA_ALL  = DATA_ALL[date==MaxDate]
            DATA_ALL[, value_str:= value]
            My.Kable(DATA_ALL)
            xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
            My.Kable(xCOUNT[order(-n)], Nb=15)
            
            # xCOMPARE = setDT(tidyr::gather(xSELECT, key="source", value="value",3:ncol(xSELECT)))[order(-date, code, source)]
            
            DATA_SPD = setDT(tidyr::spread(DATA_ALL[, -c('value_str')], key="source", value="value"))[!is.na(code)]
            My.Kable.TB(DATA_SPD[order(date, code)])
            xCOUNT_N2 = xCOUNT[n>=2]
            xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
            
            
            
            DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
            
            if ('UPC' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (UPC), final := UPC] }
            if ('HSX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HSX), final := HSX] }
            if ('HNX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HNX), final := HNX] }
            if ('CAF' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (CAF), final := CAF] }
            if ('VST' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VST), final := VST] }
            if ('VND' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VND), final := VND] }
            if ('STB' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (STB), final := STB] }
            if ('C68' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (C68), final := C68] }
            if ('VPS' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VPS), final := VPS] }
            
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            DATA_SPD [, ':='( dataset='MARKET')]
            DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_market_day_', gsub ('-','', Sys.Date()),'.rds'), ToSummary = T )
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_market_day.rds'), ToSummary = T )
            if (ToIntegrate)
            {
              File_Old = 'ccpr_download_all_stkvn_market_history.rds'
              Data_Old = CCPR_READRDS(To_Folder, File_Old, ToKable = T)
              Data_Old = rbind(Data_Old, DATA_SPD, fill=T) [nchar(code) == 8]
              if (nrow(Data_Old)>0)
              {
                Data_Old = unique(Data_Old, by=c('code', 'date'), fromLast = T)[!is.na(code)]
                My.Kable.Min(Data_Old)
                CCPR_SAVERDS(Data_Old, To_Folder, File_Old, ToSummary=T, SaveOneDrive = T)
              }
            }
          },
          
          'VOLUME' = {
            LastTrading = CCPR_LAST_TRADING_DAY_VN(8, ToPrompt = T)
            DATA_ALL = data.table()
            for (k in 1:length(LIST_SOURCES))
            {
              # k = 1
              pSource     = LIST_SOURCES[[k]]
              File_Name   = paste0('CCPR_DOWNLOAD_', pSource, '_STKVN_VOLUME_DAY.rds')
              CATln_Border(File_Name)
              File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
              # if ( !'code' %in% colnames (File_Data) ) { File_Data [, code := paste0('STKVN', codesource)]}
              if ( nrow (File_Data) > 0) {
                if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'volume', 'source') %in% names(File_Data) ) )
                {
                  xData = File_Data[, .(code, date, source, value=as.character(volume))] [ date == LastTrading]
                  My.Kable(xData)
                  DATA_ALL = rbind(DATA_ALL, xData, fill=T)
                  DATA_ALL [, source := as.character (source)]
                }
              }
              
            }
            My.Kable(DATA_ALL[order(-date, code)])
            # x = DATA_ALL
            # DATA_ALL [source == 'HSX']
            # DATA_ALL = setDT (DATA_ALL)
            str(DATA_ALL)
            DATA_ALL = unique(DATA_ALL, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
            unique(DATA_ALL, by = 'source')
            MaxDate   = max(DATA_ALL$date)
            DATA_ALL  = DATA_ALL[date==MaxDate]
            DATA_ALL[, value_str:= value]
            My.Kable(DATA_ALL)
            xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
            My.Kable(xCOUNT[order(-n)], Nb=15)
            
            # xCOMPARE = setDT(tidyr::gather(xSELECT, key="source", value="value",3:ncol(xSELECT)))[order(-date, code, source)]
            
            DATA_SPD = setDT(tidyr::spread(DATA_ALL[, -c('value_str')], key="source", value="value"))[!is.na(code)]
            My.Kable.TB(DATA_SPD[order(date, code)])
            xCOUNT_N2 = xCOUNT[n>=2]
            xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
            DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
            
            if ('UPC' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (UPC), final := UPC] }
            if ('HSX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HSX), final := HSX] }
            if ('HNX' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (HNX), final := HNX] }
            if ('CAF' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (CAF), final := CAF] }
            if ('VST' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VST), final := VST] }
            if ('VND' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VND), final := VND] }
            if ('STB' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (STB), final := STB] }
            if ('C68' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (C68), final := C68] }
            if ('VPS' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (VPS), final := VPS] }
            if ('TVSI' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (TVSI), final := TVSI] }
            if ('BVSC' %in% names(DATA_SPD)) { DATA_SPD [is.na(final) & !is.na (BVSC), final := BVSC] }
            
            
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            DATA_SPD [, ':='( dataset='VOLUME')]
            DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
            DATA_SPD [,final := as.numeric(final)]
            My.Kable.TB(DATA_SPD[order(date, code)])
            My.Kable.TB(DATA_SPD[order(date, code)][is.na(final)])
            
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_volume_day_', gsub ('-','', Sys.Date()),'.rds'), ToSummary = T )
            CCPR_SAVERDS(DATA_SPD, To_Folder, paste0('ccpr_download_all_stkvn_volume_day.rds'), ToSummary = T )
            if (ToIntegrate)
            {
              File_Old = 'ccpr_download_all_stkvn_volume_history.rds'
              Data_Old = CCPR_READRDS(To_Folder, File_Old, ToKable = T)
              Data_Old = rbind(Data_Old, DATA_SPD, fill=T)
              if (nrow(Data_Old)>0)
              {
                Data_Old = unique(Data_Old, by=c('code', 'date'), fromLast = T)[!is.na(code)]
                My.Kable.Min(Data_Old)
                CCPR_SAVERDS(Data_Old, To_Folder, File_Old, ToSummary=T, SaveOneDrive = T)
              }
            }
          }
  )
  
}

# ==================================================================================================
TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER = function(pURL, File_Temp, pSleep=0, ToDeleteTemp=T) {
  # ------------------------------------------------------------------------------------------------
  # pURL                = 'https://www.vietnamworks.com/viec-lam?q=ai-engineer&l=29&page=1'
  # File_Temp = 'vw_01.txt'
  # pSleep=1; ToDeleteTemp = F 
  
  MyPC = toupper(TRAINEE_GET_MYPC())
  if (MyPC %in% list('BEQ-RD4','BEQ-INDEX')) { MyExecution_Pattern = 'python c:/python/savepage_nobrowser.py "URL" "FILE"' } else {
    MyExecution_Pattern = 'py c:/python/savepage_nobrowser.py "URL" "FILE"'
  }
  
  MyExecution         = gsub('URL',  pURL, MyExecution_Pattern)
  MyExecution         = gsub('FILE', File_Temp, MyExecution)
  CATln_Border(MyExecution)
  
  shell(MyExecution); Sys.sleep(pSleep)
  
  xweb = readr::read_file(File_Temp)
  if (grepl('pre-wrap;\">', xweb)) { xweb = str.extract(xweb, 'pre-wrap;\">', '</pre>') }
  if (ToDeleteTemp) { file.remove(paste0(File_Temp)) }
  # print(xweb)
  
  return(xweb)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VPS_PRICESBOARD = function (Source = 'VPS',
                                             Market = 'UPC',
                                             pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/') {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:23
  
  rm(x.List)
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  switch (Market,
          'HNX' = {
            market = 'hnx'
          },
          'HSX' = {
            market = 'hose'
          },
          'UPC' = {
            market = 'upcom'
          }
  )
  pList   = paste0('https://bgapidatafeed.vps.com.vn/getlistckindex/', market)
  x.List  = as.data.table(jsonlite::fromJSON(pList))
  x.List[,nc:=nchar(V1)]
  My.Kable(x.List)
  # print(str.List, quote=F)
  codes <- x.List[nc == 3]$V1
  sliced_strings <- list()
  chunk_size <- 50
  
  for (i in seq(1, length(codes), by = chunk_size)) {
    sliced_string <- paste(codes[i:min(i + chunk_size - 1, length(codes))], collapse = ",")
    sliced_strings[[length(sliced_strings) + 1]] <- sliced_string
  }
  my_data <- list()
  for (i in seq_along(sliced_strings)){
    #  i = 1
    rm(x)
    URL = pURL
    URL = paste0(URL, sliced_strings[[i]])
    CATln_Border(URL)
    x = jsonlite::fromJSON(URL)
    x = as.data.table(x)
    LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
    
    Final_Data <- x[, .(source = Source, market=Market, ticker=sym, reference = r, last = f, change = changePc ,volume = lastVolume)]
    Final_Data[, code:=paste0('STKVN', ticker)]
    Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
    Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
    Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(change))]
    
    Final_Data[, close := as.numeric(NA)]
    
    Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), as.numeric(volume))]
    
    Final_Data[, date := LastTrading]
    Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
    
    hour   = unique(format(Final_Data$updated, "%H"))
    minute = unique(format(Final_Data$updated, "%M"))
    is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
    
    if (any(is_after_1545) | Sys.Date() > LastTrading) {
      Final_Data[, close := last]
      Final_Data[is.na(volume) & close == reference][, volume := 0]
      
    }
    
    Final_Data = Final_Data[nchar(ticker)==3]
    Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
    
    my_data[[i]] = Final_Data
  }
  Final_Data = rbindlist(my_data, fill = T)
  UPDATE_UPDATED (Final_Data)
  # if ('updated' %in% names(Final_Data)) { Final_Data[, updated:=substr(as.character(updated),1,19)]}
  My.Kable.TB(Final_Data)
  return(Final_Data)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_VND_PRICESBOARD = function (Source='VND', Market='HSX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hose') {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:21
  
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  
  
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER( pURL, paste0('C:/Temp/', 'BANG_GIA.txt'), ToDeleteTemp = T)
  html <- read_html(xweb)
  tables <- html_nodes(html, "table")  
  data_table <- html_table(tables[[3]])
  data = as.data.table(data_table)
  Final_Data = data[,. (source = Source, market = Market, ticker = X1, reference = X2, last = X12, change = X14, volume = X5)]
  Final_Data[, volume := str_extract(volume, ".*?(?=\\n)")]
  Final_Data[, change := str_extract(change, ".*?(?=\\n)")]
  Final_Data[, code:=paste0('STKVN', ticker)]
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
  Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(change))]
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 10*as.numeric(gsub(',', '',volume)))]
  Final_Data[, close := as.numeric(NA)]
  Final_Data[, date := LastTrading]
  Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
  
  hour   = unique(format(Final_Data$updated, "%H"))
  minute = unique(format(Final_Data$updated, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  UPDATE_UPDATED (Final_Data)
  # if ('updated' %in% names(Final_Data)) { Final_Data[, updated:=substr(as.character(updated),1,19)]}
  return (Final_Data)
  
}

# ==================================================================================================
FILE_TEMP_WITH_PREFIX = function(Prefix = 'TEMP_', Ext = '.TXT')  {
  # ------------------------------------------------------------------------------------------------
  
  Suffix   = as.character(Sys.time())
  Suffix   = gsub(' ', '_', Suffix)
  Suffix   = gsub('-| |[:]|[.]', '', Suffix)
  FileName = paste0(Prefix, Suffix, Ext)
  CATln(FileName)
  return(FileName)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_HNX_PRICESBOARD = function (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
                                             Source = 'EXC',
                                             Market = 'UPC') {
  # ------------------------------------------------------------------------------------------------
  # x = try(TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket', Source = 'EXC', Market = 'HNX'))
  # x = try(TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket', Source = 'EXC', Market = 'UPC'))
  # Market = 'HNX'
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  DBL_RELOAD_INSREF()
  tabs = c("ABC", "DEF", "GHI", "JKL", "MNO", "PQR", "STUV", "WXYZ")
  Final_Data = data.table()
  pData = list ()
  
  switch(Market,
         'UPC' = {
           for (k in 1:length(tabs)) {
             my.param  = list (
               pKeyAreas= tabs[[k]],
               pFloorCode='UPC'
             )
             
             rm(res)
             res    = try(POST(pURL, body = my.param, encode = "form"))
             
             if (all(class(res)!="try-eror"))
             {
               rm(x.out)
               x.out   = content(res, type="text", encoding = "UTF-8")
               x.data  = as.data.table(jsonlite::fromJSON(x.out))
               str(x.data)
               FileTmp = FILE_TEMP_WITH_PREFIX(Prefix = 'TEMP_', Ext = '.TXT')
               fwrite(x.data[, .(obj)], paste0('c:/temp/', FileTmp))
               dt      = fread(paste0('c:/temp/', FileTmp), sep = "|", header = F)
               Data = dt[, .(source=Source, ticker=V2, market=Market, reference=word(V7,2,2,'[*]'), last=word(V17,2,2,'[*]'), volume=word(V19,2,2,'[*]'),
                             close=word(V34,2,2,'[*]'))]
               pData[[k]] = Data
             }
             
           }
           Final_Data = rbindlist(pData, fill=T)
         }
         ,
         'HNX' = {
           for (k in 1:length(tabs)) {
             # k =  1
             my.param  = list (
               pKeyAreas = tabs[[k]],
               pFloorCode ='LIS'
             )
             
             rm(res)
             res    = try(POST(pURL, body = my.param, encode = "form"))
             
             if (all(class(res)!="try-eror"))
             {
               # typeof(res)
               rm(x.out)
               x.out   = content(res, type="text", encoding = "UTF-8")
               x.data  = as.data.table(jsonlite::fromJSON(x.out))
               str(x.data)
               FileTmp = FILE_TEMP_WITH_PREFIX(Prefix = 'TEMP_', Ext = '.TXT')
               fwrite(x.data[, .(obj)], paste0('c:/temp/', FileTmp))
               dt      = fread(paste0('c:/temp/', FileTmp), sep = "|", header = F)
               Data = dt[, .(source=Source, ticker=V2, market=Market, reference=word(V7,2,2,'[*]'), last=word(V17,2,2,'[*]'), volume=word(V19,2,2,'[*]'),
                             close=word(V34,2,2,'[*]'))]
               pData[[k]] = Data
             }
           }
           Final_Data = rbindlist(pData, fill=T)
         })
  
  Final_Data[, code:=paste0('STKVN', ticker)]
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 1000*as.numeric(gsub(',', '',volume)))]
  Final_Data[, close := as.numeric(NA)]
  Final_Data[, date := LastTrading]
  Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
  
  hour   = unique(format(Final_Data$updated, "%H"))
  minute = unique(format(Final_Data$updated, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  My.Kable.TB(Final_Data[order(ticker)])
  UPDATE_UPDATED (Final_Data)
  # if ('updated' %in% names(Final_Data)) { Final_Data[, updated:=substr(as.character(updated),1,19)]}
  
  if (nrow(Final_Data)>0)
  {
    CCPR_SAVERDS(Final_Data, 'S:/STKVN/PRICES/DAY/', paste0('DOWNLOAD_', Market, '_PRICESBOARD_DAY.rds'))
    CCPR_SAVERDS(Final_Data, 'S:/STKVN/PRICES/DAY/', paste0('DOWNLOAD_', Market, '_PRICESBOARD_', gsub('-','', LastTrading),'.rds'))
  }
  return (Final_Data)
}


# ==================================================================================================

TRAINEE_DOWNLOAD_PRICE_TVSI = function (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                        Source = 'TVSI',
                                        Market = 'HSX')  {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:25
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  my.param  = list (
    type = Market,
    typeTab='M',
    sort = 'SortName-up',
    stockStr = ''
  )
  rm(res)
  res    = try(POST(pURL, body = my.param, encode = "form"))
  
  if (all(class(res)!="try-eror"))
  {
    
    rm(x.out)
    x.out = content(res, type="text", encoding = "UTF-8")
    x.data  = as.data.table(jsonlite::fromJSON(x.out))
    str(x.data)
    fwrite(x.data[, .(arrDetailStock)], 'c:/temp/tab.txt')
    dt <- fread('c:/temp/tab.txt', sep = "|", header = F)
    dt$V1 <- gsub('"', '', dt$V1)
    Final_Data = dt[, .(source=Source, ticker=V1, market=Market, reference=word(V7,2,2,'[*]'), last=word(V18,2,2,'[*]'), volume=word(V20,2,2,'[*]'),  change=word(V16,2,2,'[*]'))]
    Final_Data[ticker == 'NBB']
    Final_Data[, code:=paste0('STKVN', ticker)]
    Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric( gsub(',', '',reference)) )]
    Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub(',', '',last)))]
    Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub(',', '',change)))]
    Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 10*as.numeric(gsub(',', '',volume)))]
    Final_Data[, close := as.numeric(NA)]
    Final_Data[, date := LastTrading]
    Final_Data[, updated := substr(as.character(Sys.time()), 1, 19)]
    
    pHour  = as.POSIXct(substr(as.character(Sys.time()), 1, 19)) 
    hour   = unique(format(pHour, "%H"))
    minute = unique(format(pHour, "%M"))
    is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
    
    if (any(is_after_1545) | Sys.Date() > LastTrading) {
      Final_Data[, close := last]
      Final_Data[is.na(volume) & close == reference][, volume := 0]
      
    }
    
    #Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), as.numeric(volume))]
    Final_Data = Final_Data[nchar(ticker)==3]
    Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
    My.Kable.TB(Final_Data[order(ticker)])
    return(Final_Data)
    
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_BSC_PRICESBOARD = function (Source = 'BSC',
                                             Market = 'UPCOM') {
  # ------------------------------------------------------------------------------------------------                                              
  pURL = paste0('http://priceboard.bsc.com.vn/chi-so/',tolower(Market))
  tables_length = 0
  while (tables_length < 4) {
    
    xweb       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T, pSleep = 10)
    html       = read_html(xweb)
    tables     = html_nodes(html, "table")  # Assuming first table element
    
    tables_length <- length(tables)
    Sys.sleep(5)
  }
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  DBL_RELOAD_INSREF()
  
  data_table = setDT(html_table(tables[[4]]))
  
  Final_Data = data_table[, .(source=Source, market=Market, ticker=`Mã CK`, reference=`TC`, last = data_table[,11], change = data_table[,13], volume = data_table[, 21])]
  Final_Data <- Final_Data[-c(1:5), ]
  Final_Data <- Final_Data[-nrow(Final_Data), ]
  names(Final_Data)[5] <- "last"
  names(Final_Data)[6] <- "change"
  
  names(Final_Data)[7] <- "volume"
  
  Final_Data[, code:=paste0('STKVN', ticker)]
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
  Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(change))]
  
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 10*as.numeric(gsub(',', '',volume)))]
  Final_Data[, close := as.numeric(NA)]
  Final_Data[, date := LastTrading]
  Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
  
  hour   = unique(format(Final_Data$updated, "%H"))
  minute = unique(format(Final_Data$updated, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  My.Kable.TB(Final_Data)
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_BSC_PRICESBOARD_OLD = function (Source = 'BSC',
                                                 Market = 'UPCOM') {
  pURL = paste0('http://priceboard.bsc.com.vn/chi-so/',tolower(Market))
  tables_length <- 0
  while (tables_length < 4) {
    
    xweb       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T, pSleep = 10)
    html       = read_html(xweb)
    tables     = html_nodes(html, "table")  # Assuming first table element
    
    tables_length <- length(tables)
    Sys.sleep(5)
  }
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  DBL_RELOAD_INSREF()
  
  data_table = setDT(html_table(tables[[4]]))
  
  Final_Data = data_table[, .(source=Source, market=Market, ticker=`Mã CK`, reference=`TC`, last = data_table[,11], volume = data_table[, 21])]
  Final_Data <- Final_Data[-c(1:5), ]
  Final_Data <- Final_Data[-nrow(Final_Data), ]
  names(Final_Data)[5] <- "last"
  names(Final_Data)[6] <- "volume"
  
  Final_Data[, code:=paste0('STKVN', ticker)]
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 10*as.numeric(gsub(',', '',volume)))]
  Final_Data[, close := as.numeric(NA)]
  Final_Data[, date := LastTrading]
  Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
  
  hour   = unique(format(Final_Data$updated, "%H"))
  minute = unique(format(Final_Data$updated, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  My.Kable.TB(Final_Data)
  return(Final_Data)
}



# ==================================================================================================
TRAINEE_DOWNLOAD_C68_PRICESBOARD = function (pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
                                             Source = 'C68',
                                             Market = 'HSX') {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:23
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T)
  html <- read_html(xweb)
  tables <- html_nodes(html, "table")  # Assuming first table element
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  DBL_RELOAD_INSREF()
  
  # data_table <- setDT(html_table(tables[[1]]))
  data_table <- setDT(html_table(tables[[2]]))
  
  data_table = data_table[-c(1:2)]
  My.Kable(data_table[X1=='AAA'])
  # str(data_table)
  Final_Data = data_table[, .(source=Source, market=Market, ticker=gsub('[*]', '', X1), reference=gsub(',','', X4),
                              last=gsub(',','', X11),change = gsub(',','', X13)  ,volume = gsub(',','', word(X20,1,1,' ')))]
  My.Kable(Final_Data[ticker=='AAA'])
  
  Final_Data[, code:=paste0('STKVN', ticker)]
  Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub(',','',reference)))]
  Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub(',','',last)))]
  Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub(',','',change)))]
  
  Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), as.numeric(gsub(',','',volume)))]
  Final_Data[, close := as.numeric(NA)]
  Final_Data[, date := LastTrading]
  Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
  
  hour   = unique(format(Final_Data$updated, "%H"))
  minute = unique(format(Final_Data$updated, "%M"))
  is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
  
  if (any(is_after_1545) | Sys.Date() > LastTrading) {
    Final_Data[, close := last]
    Final_Data[is.na(volume) & close == reference][, volume := 0]
    
  }
  Final_Data = Final_Data[nchar(ticker)==3]
  Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
  
  My.Kable.TB(Final_Data[order(ticker)])
  return(Final_Data)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_PRICE_MBS = function (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                       Source = 'MBS',
                                       Market = 'UPC',
                                       code = '091') {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:22
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  my.param  = list (
    "rid" = "32423542",
    "token" = "",
    "type" = "SEC",
    "code" = code
  )
  rm(res)
  request_body <- toJSON(my.param)
  res    = try(POST(pURL, body = request_body, add_headers("Content-Type" = "application/x-www-form-urlencoded; charset=UTF-8")))
  
  if (all(class(res)!="try-eror"))
  {
    rm(x.out)
    x.out = content(res, type="text", encoding = "UTF-8")
    x.data  = as.data.table(jsonlite::fromJSON(x.out))
    str(x.data)
    dt = x.data
    Final_Data = dt[, .(source=Source, ticker=dt$data.sym, market=Market, reference=word(dt$data.rp), last=word(dt$data.mp), change = word(dt$data.mchv), volume=word(dt$data.tstraded))]
    #close=word(dt$data.closedP)
    Final_Data[, code:=paste0('STKVN', ticker)]
    Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(reference))]
    Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(last))]
    Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(change))]
    Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 1000*as.numeric(gsub(',', '',volume)))]
    Final_Data[, close := as.numeric(NA)]
    Final_Data[, date := LastTrading]
    Final_Data[, updated := as.POSIXct(substr(as.character(Sys.time()), 1, 19))]
    
    hour   = unique(format(Final_Data$updated, "%H"))
    minute = unique(format(Final_Data$updated, "%M"))
    is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
    
    if (any(is_after_1545) | Sys.Date() > LastTrading) {
      Final_Data[, close := last]
      Final_Data[is.na(volume) & close == reference][, volume := 0]
      
    }
    Final_Data = Final_Data[nchar(ticker)==3]
    Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
    My.Kable.TB(Final_Data[order(ticker)])
    return(Final_Data)
    
  }
}



# ==================================================================================================

OLD_TRAINEE_DOWNLOAD_SOURCE_PRICESBOARD_OPEN_CLOSE_DAY = function (pSource = 'TVSI', 
                                                                   Save_Folder = 'S:/STKVN/PRICES/DAY/',
                                                                   Save_File = '') {
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  Data_final  = data.table()
  
  switch (pSource,
          'TVSI' = {
            hsx = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_PRICE_TVSI (pURL = 'https://prs.tvsi.com.vn/get-detail-stock-by',
                                               Source = 'TVSI',
                                               Market = 'UPCOM')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_TVSI_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_TVSI_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'VST' = {
            hsx = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='HSX', pURL = 'https://banggia.vietstock.vn/bang-gia/hose')
            hnx = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='HNX', pURL = 'https://banggia.vietstock.vn/bang-gia/hnx')
            upc = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET (Source='VST', Market='UPC', pURL = 'https://banggia.vietstock.vn/bang-gia/upcom')
            Data_final = rbind(hsx, hnx, upc)
            Data_final[, close := as.numeric(NA)]
            Data_final[, date := LastTrading]
            Data_final[, updated :=substr(as.character(Sys.time()), 1, 19)]
            
            # pHour =  as.POSIXct(substr(as.character(Sys.time()), 1, 19))
            # hour   = unique(format(pHour, "%H"))
            # minute = unique(format(pHour, "%M"))
            # is_after_1545 = hour > 15 | (hour == 15 & minute >= 45)
            
            
            
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VST_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VST_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'EXC' = {
            hnx = TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
                                                    Source = 'EXC',
                                                    Market = 'HNX')
            upc = TRAINEE_DOWNLOAD_HNX_PRICESBOARD (pURL = 'https://banggia.hnx.vn/Home/GetStockInBasket',
                                                    Source = 'EXC',
                                                    Market = 'UPC')
            
            Data_final = rbind(hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_EXC_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_EXC_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
            
          },
          'VND' = {
            hsx = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='HSX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hose')
            hnx = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='HNX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hnx')
            upc = TRAINEE_DOWNLOAD_VND_PRICESBOARD (Source='VND', Market='UPC', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/upcom')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VND_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VND_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'MBS' = {
            upc = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'UPC',
                                              code = '091')
            
            hnx = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'HNX',
                                              code = '011')
            
            hsx = TRAINEE_DOWNLOAD_PRICE_MBS (pURL = 'https://mktapi1.mbs.com.vn/pbResfulMarkets/category/securities/list',
                                              Source = 'MBS',
                                              Market = 'HSX',
                                              code = '012')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_MBS_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_MBS_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }, 
          'BSC' = {
            upc = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'UPCOM')
            hsx = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'HOSE')
            hnx = TRAINEE_DOWNLOAD_BSC_PRICESBOARD(Source = 'BSC', Market = 'HNX')
            
            Data_final <- rbind(upc, hsx, hnx)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_BSC_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_BSC_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'VPS' = {
            upc = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'UPC',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            hsx = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'HSX',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            hnx = TRAINEE_DOWNLOAD_VPS_PRICESBOARD (Source = 'VPS',
                                                    Market = 'HNX',
                                                    pURL = 'https://bgapidatafeed.vps.com.vn/getliststockdata/')
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_VPS_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_VPS_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }, 
          'C68' = {
            
            hsx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'HSX')
            
            hnx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=2&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'HNX')
            
            upc = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL   = 'https://www.cophieu68.vn/stockonline.php?stcid=3&nd=2000',
                                                   Source = 'C68',
                                                   Market = 'UPC')
            # 
            # hsx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'HSX')
            # 
            # hnx = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'HNX')
            # 
            # upc = TRAINEE_DOWNLOAD_C68_PRICESBOARD(pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000',
            #                                        Source = 'C68',
            #                                        Market = 'UPC')
            
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume",
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_C68_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_C68_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          },
          'CAF' = {
            
            
            
            upc =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'UPC',
                                                                 pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            hsx =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'HSX',
                                                                 pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            hnx =             TRAINEE_DOWNLOAD_PRICESBOARD_CAF  (Source = 'CAF',
                                                                 Market = 'HNX',
                                                                 pURL = 'https://s.cafef.vn/ajax/ajaxliveboard.ashx?floorcode=') 
            Data_final = rbind(hsx, hnx, upc)
            My.Kable(Data_final)
            
            Data_final <- Data_final[, c("code", "source", "market", "ticker", "reference", "last", "volume", 
                                         "close", "date", "updated", "name"), with = FALSE]
            UPDATE_UPDATED (Data_final)
            # if ('updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
            if ( gsub('[:]','', substr(as.character(Sys.time()),12,16))> 1545) {
              Data_final[, close := last]
              Data_final[is.na(volume) & close == reference][, volume := 0]
              
            }
            
            if (substr(as.character(Sys.time()),12,13)< 12) {
              Data_final[, reference_open := reference]
            } else { Data_final[, reference_close := reference] }
            if (nchar(Save_File) > 0)
            {
              Save_File_Day = paste0('DOWNLOAD_CAF_PRICESBOARD_DAY.rds')
              Save_File = paste0('DOWNLOAD_CAF_PRICESBOARD_', gsub('-', '', LastTrading), '.rds')
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File_Day, ToSummary = T)
              CCPR_SAVERDS(Data_final,Save_Folder, Save_File, ToSummary = T)
            }
          }
  )
  UPDATE_UPDATED (Data_final)
  
  # if (!'updated' %in% names(Data_final)) { Data_final[, updated:=substr(as.character(Sys.time()),1,19)]}
  return (Data_final)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_SOURCE_STKVN_PRICESINTRADAY_BY_CODE = function(pSource = 'VND', pCode   = 'VIC', NbDaysBack = 1) {
  # ------------------------------------------------------------------------------------------------
  try(DBL_RELOAD_INSREF())
  Final_Data = data.table()
  Start.RUN = Sys.time()
  switch( pSource,
          'VND' = {
            minute=1; 
            
            StartTime <- paste(Sys.Date()-NbDaysBack, "09:00:00")
            datetime  <- strptime(StartTime, "%Y-%m-%d %H:%M:%S")
            posix_start <- as.numeric(as.POSIXlt(datetime))
            
            EndTime <- Sys.time()
            datetime  <- strptime(EndTime, "%Y-%m-%d %H:%M:%S")
            posix_end <- as.numeric(as.POSIXlt(datetime))
            
            pURL    = paste0('https://dchart-api.vndirect.com.vn/dchart/history?resolution=', minute, '&symbol=', pCode, '&from=', posix_start, '&to=', posix_end)
            xData = as.data.table(jsonlite::fromJSON(pURL))
            # xData
            # str(xData)
            xData[!is.na(t), timestamp:=as.character(as.POSIXlt(as.numeric(t)))]
            # My.Kable(xData[order(t)])
            Final_Data = xData[s=='ok', .(source=pSource, ticker=pCode, codesource=pCode, code=paste0('STKVN', pCode), timestamp=timestamp, 
                                          date=as.Date(substr(timestamp,1,10)), open=1000*o, high=1000*h, low=1000*l, last=1000*c, volume=v)]
            My.Kable.TB(Final_Data)
            
          },
          'CAF' = {
            pDate=format.Date(as.Date(LastTrading), '%d/%m/%Y'); CreateBlank=T
            pURL     = paste0('https://s.cafef.vn/ajax/khoplenh.aspx?order=time&dir=up&symbol=', pCode, '&date=',pDate)
            CATln_Border(pURL)
            content  = rvest::read_html(pURL)
            tables   = content %>% html_table(fill = TRUE)
            xData    = as.data.table(tables[[1]])
            if (ncol(xData)==5 && nrow(xData)>0)
            {
              xData    = CLEAN_COLNAMES(xData)
              Final_Data = xData[, .( source='CAF', ticker = pCode, codesource=pCode, code=paste0('STKVN', pCode),
                                      date=as.Date(pDate, '%d/%m/%Y'), time=x1, volume=x3, volume_total=as.numeric(gsub(',','', x4)),
                                      last=1000*as.numeric(gsub(',','', word(x2, 1, 1))), 
                                      change=1000*as.numeric(gsub(',','', word(x2, 2, 2))), 
                                      varpc=as.numeric(gsub(',','', gsub('\\(|)|%','', word(x, 3, 3)))) )]
              My.Kable.TB(Final_Data)
            } else { 
              if (CreateBlank) {
                Final_Data = data.table[, .(codesource=pCode, code=paste0('STKVN', pCode), source='CAF', 
                                            date=as.Date(pDate, '%d/%m/%Y'))]
                My.Kable.TB(Final_Data)
              }
            }
          },
          'C68' = {
            
            pURL       = paste0('https://www.cophieu68.vn/quote/summary.php?id=', tolower(pCode))
            CATln(''); CATln_Border(pURL)
            content    = try(rvest::read_html(pURL))
            
            if (all(class(content)!='try-error'))
            {
              tables     = content %>% html_table(fill = TRUE)
              if (length(tables)>=4)
              {
                LastTrading = CCPR_LAST_TRADING_DAY_VN(max(9,hour(Sys.time())), ToPrompt = T)
                xData       = as.data.table(tables[[4]])
                # My.Kable(xData)
                Final_Data = xData[, .(source='C68', ticker =pCode, codesource=pCode, code=paste0('STKVN', pCode),
                                       timestamp=paste0(X1,':00'), date         = LastTrading,
                                       last         = 1000*as.numeric(gsub(',','', X2)),
                                       change       = 1000*as.numeric(gsub(',','', X3)),
                                       last_volume  = 1000*as.numeric(gsub(',','', X4)),
                                       cumul_volume = 1000*as.numeric(gsub(',','', X5))
                )][!is.na(last)]
                My.Kable.TB(Final_Data)
              }
            }
          },
          {})
  
  End.RUN = Sys.time()
  CATln_Border(paste('DURATION = ', Format.Number(difftime(End.RUN, Start.RUN, units='secs'),3))) 
  return(Final_Data)
}

# ==================================================================================================
LOOP_TRAINEE_DOWNLOAD_HNXUPC_STKVN_REF_INFO_BY_CODE = function( ranking    = 'ASC', FirstChars = 'ABC', random = F,
                                                                pMarket    = '', 
                                                                pFolder    = 'S:/R/DATA/BOARD/RAW/',
                                                                File_Name  = paste0('TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE_20240415.rds'),
                                                                pDate      = '2024-04-15',
                                                                List_Codes = list(),
                                                                File_Codes = "S:/CCPR/DATA/download_upc_stkvn_ref_history.rds") {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  
  FilePath = paste0(pFolder, File_Name)
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  Data_All = data.table()
  if (length(List_Codes)==0 & nchar(File_Codes)>0)
  {
    List_Codes = readRDS(File_Codes)
    List_Codes = unique(List_Codes[order(-date)], by = 'codesource' )
    List_Codes = as.vector(List_Codes$codesource)
  }
  if (nchar(ranking)>0){
    switch (ranking,
            'ASC' = {
              List_Codes = sort(List_Codes, decreasing = F)
            },
            'DESC' = {
              List_Codes = sort(List_Codes, decreasing = T)
            })
  }
  if (nchar(FirstChars)>0){
    char_set <- strsplit(FirstChars, "")[[1]]
    # inChars <- 'ABC'
    # > List_CODES <- c('AAB', 'AAC', 'BCC', 'XXY')
    # Vectorized filtering for efficiency
    Selected_Codes = List_Codes[substr(List_Codes, 1, 1) %in% char_set]
    List_Codes = Selected_Codes 
  }
  print(List_Codes)
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  ExtraFolder = ''
  if (file.exists(FilePath))
  {
    Data_old = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name, ToKable = T)))
    
    if (nrow(Data_old)>0) {
      Data_done = unique(Data_old[!is.na(codesource)][order(-date)], by = 'codesource')
      Data_List = Data_done[codesource %in% List_Codes & date >= pDate]
      List_Codes_ToDo = setdiff(List_Codes, as.vector(Data_List$codesource))
    } else {
      List_Codes_ToDo = List_Codes
    }
  } else { 
    CATln(paste('FILE NO EXIST :', FilePath))
    Data_old = data.table() 
    List_Codes_ToDo = List_Codes
  }
  print(List_Codes_ToDo)
  
  Data_All = Data_old
  if (length(List_Codes_ToDo)>0)
  {
    if (random){
      List_Codes_ToDo = sample(List_Codes_ToDo)
    }
    Data_All = data.table()
    Data_List = list()
    
    FileDataAll = List_Codes_ToDo
    FileRow  = nrow(List_Codes_ToDo)
    Nb_Total = length(List_Codes_ToDo)
    
    FileToSave = paste0(File_Name)
    Total_Time  = 0
    
    for (i in 1:Nb_Total)
    {
      # i = 1
      Start.Time = Sys.time()
      pCode    = List_Codes_ToDo[i]
      CATln("")
      
      Sys.sleep(1)
      My_Data = data.table()
      if (! pCode %in% Data_All$codesource)
      {
        My_Data = CHECK_CLASS(try(TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE (pCodesource = pCode, Starttime = 8))) 
        if (all(class(My_Data)!='try-error'))
        {
          Data_old = CHECK_CLASS(try ( CCPR_READRDS(pFolder, File_Name)))
          Data_All = rbind(My_Data, Data_old, fill=T)
          Data_All[, market:=pMarket]
          My.Kable.TB(Data_All)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := pDate]}
          UPDATE_UPDATED (Data_All)
          # if (! 'updated' %in% names (Data_All)) { Data_All [, updated := substr (as.character (Sys.time()),1,19)]}
          # if ('updated' %in% names(Data_All)) { Data_All[, updated:=substr(as.character(updated),1,19)]}
          CCPR_SAVERDS(Data_All ,  pFolder, File_Name, SaveOneDrive = T)
          CATln_Border(paste ('SAVED: ', paste0(pFolder, File_Name)) )
          
        }
      }
      
      End.Time = Sys.time()
      Total_Time = as.numeric(difftime(End.Time, Start.Time, units = 'secs')) + Total_Time
      # Avg_Time = Total_Time / i
      # End_Forecast = Avg_Time * (Nb_TODO - i)
      # Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
      # CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      CATln_Border(paste('TIME TO END :', substr(Total_Time,1,19)))
    }
    
  } else {
    CATln_Border('DATA FULLY UPDATED')
    Sys.sleep(2)
  }
  return(Data_All)
}


# ==================================================================================================
TRAINEE_DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE = function(pCodesource = 'AAV', Starttime=8)  {
  # ------------------------------------------------------------------------------------------------
  # x = DOWNLAD_HNX_STKVN_REF_INFO_BY_CODE(pCodesource = 'AAV')
  pURL        = paste0('https://hnx.vn/en-gb/cophieu-etfs/chi-tiet-chung-khoan-ny-', pCodesource, '.html?_des_tab=1')
  pWeb        = GET_CURL_FETCH(pURL)
  pWeb        = gsub('\r\n', '', pWeb)
  # writeLines(pWeb, "c:/temp/xweb1.r")
  xRows = unlist(strsplit(pWeb, '<div class="dktimkiem_row row_inline">'))
  nRow  = length(xRows)
  # xRows[[2]]
  # xRows[[16]]
  xRows = xRows[2:(length(xRows))]
  xData = as.data.table(xRows)
  # str(xData)
  xData[, ':='(date=SYSDATETIME(Starttime), codesource=pCodesource, source='HNX', datatype='REF')]
  xData[, dataset:=trimws(str.extract(xRows,'<label>', '</label>'))]
  xData[, datavalue:=str.extract(xRows,'<div class="dktimkiem_cell_content">', '</div>')]
  xData[dataset=='Prospectus', datavalue:=str.extract(datavalue, '<a href="', ' ')]
  # My.Kable.All(xData[, -c('xRows')])
  
  sharesout    = as.numeric(gsub(',','', xData[dataset=='Outstanding volume (Share)']$datavalue))
  shareslis    = as.numeric(gsub(',','', xData[dataset=='Listed volume (Share)' | dataset=='Traded volume registered (Share)']$datavalue))
  date_1strade = as.Date(gsub(',','', xData[dataset=='First trading date']$datavalue), '%d/%m/%Y')
  if (nrow(xData[dataset=='Business lines'])>0)
  {
    sector_code  = sub(paste0(' - ',".*"), "", xData[dataset=='Business lines']$datavalue)
    sector_name  = sub(paste0(".*", ' - '), "", xData[dataset=='Business lines']$datavalue)
  } else { sector_name = as.character(NA) ; sector_code = as.character(NA)}
  # pLeft   = sub(paste0(pRef,".*"), "", pString)
  # pRight  = sub(paste0(".*", pRef), "", pString)
  xREF = data.table(date=SYSDATETIME(Starttime), source='HNX', code=paste0("STKVN", pCodesource), 
                    codesource=pCodesource, date_1strade, sharesout, shareslis, sector_code, sector_name)
  My.Kable.All(xREF)
  return(xREF)
}

# ==================================================================================================
DOWNLOAD_SOURCE_PRICESBOARD_OPEN_CLOSE_DAY  = function (OPTION = 'VST', SESSION = 'OPEN')  {
  # ------------------------------------------------------------------------------------------------
  
  # OPEN
  switch( SESSION,
          'OPEN'   =  {
            switch (OPTION , 
                    'VST' = {
                      Dt = list()
                      Dt[[1]] = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET(Source='VST', Market='HSX', pURL = 'https://banggia.vietstock.vn/bang-gia/hose')
                      Dt[[2]] = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET(Source='VST', Market='HNX', pURL = 'https://banggia.vietstock.vn/bang-gia/hnx')
                      Dt[[3]] = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET(Source='VST', Market='UPC', pURL = 'https://banggia.vietstock.vn/bang-gia/upcom')
                      Dt_ALL  = rbindlist(Dt, fill=T)
                      My.Kable(Dt_ALL)
                    },
                    'VND' = {
                      Dt = list()
                      Dt[[1]] = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET(Source='VND', Market='HSX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hose')
                      Dt[[2]] = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET(Source='VND', Market='HNX', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/hnx')
                      Dt[[3]] = DOWNLOAD_BANGGIA_SOURCE_BY_MARKET(Source='VND', Market='UPC', pURL = 'https://banggia.vndirect.com.vn/chung-khoan/upcom')
                      Dt_ALL  = rbindlist(Dt, fill=T)
                    })
            
            LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
            Dt_ALL[, timestamp:=Sys.time()]
            Dt_ALL[, date:=LastTrading]
            My.Kable(Dt_ALL)
            
            
          },
          'CLOSE'  =  {
            # CLOSE --------------------------------------------------------------------------------------------
            Dt_ALL[, close:=reference]
            Dt_ALL[!is.na(last), close:=last]
            
            Dt_ALL[is.na(volume), volume:=0]
            # Dt_ALL[!is.na(volume), volume:=0]
            My.Kable.TB(Dt_ALL)
          } )
  
  
  
  
}

# ==================================================================================================
DOWNLOAD_BANGGIA_SOURCE_BY_MARKET = function(Source='VST', Market='HSX', pURL = 'https://banggia.vietstock.vn/bang-gia/hose')  {
  # ------------------------------------------------------------------------------------------------
  # last updated = 2024-05-23 15:25
  DBL_RELOAD_INSREF()
  switch(Source,
         'VST' = {
           xweb       = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T)
           html       = read_html(xweb)
           tables     = html_nodes(html, "table")  # Assuming first table element
           data_table = setDT(html_table(tables[[2]]))
           # My.Kable(data_table[X1=='VTP'])
           # print(data_table[X1=='VTP']$X21)
           Final_Data = data_table[, .(X1, source=Source, market=Market, ticker=gsub('[*]', '', X1), reference=gsub(',','', X2), 
                                       last=gsub(',','', X7), volume = gsub(',','', word(X21,1,1,'\n')), change = X13)]
           # My.Kable(Final_Data[ticker=='VTP'])
           # Final_Data[, ':='(reference=ifelse1000*as.numeric(reference), last=gsub(',','', X7), volume = gsub(',','', word(X21,1,1,' ')))]
           
           Final_Data[, code:=paste0('STKVN', ticker)]
           Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub(',','',reference)) )]
           Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub(',','',last)))]
           Final_Data[, change:=ifelse(is.na(change), as.numeric(NA), 1000*as.numeric(gsub(',','',change)))]
           Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), as.numeric(gsub(',','',volume)))]
           Final_Data = Final_Data[nchar(ticker)==3]
           Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
           My.Kable.TB(Final_Data)
         },
         'VND' = {
           xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T)
           html <- read_html(xweb)
           tables <- html_nodes(html, "table")
           data_table <- setDT(html_table(tables[[3]]))
           data_table[, X5:=gsub('\t|\n', ' ', X5)]
           # replace recursive
           data_table[, data_table := str_replace_all(X5, "\\s+", " ")]  
           while (any(grepl("  ", data_table$X5))) {
             data_table[, X5 := gsub("  ", " ", X5)]
           }
           
           My.Kable(data_table[X1=='AAA'])
           # str(data_table)
           Final_Data = data_table[, .(X1, source=Source, market=Market, ticker=gsub('[*]', '', X1), reference=gsub(',','', X2),
                                       last=gsub(',','', X12), volume = gsub(',','', word(X5,1,1,' ')))]
           # My.Kable(Final_Data[ticker=='VTP'])
           # Final_Data[, ':='(reference=ifelse1000*as.numeric(reference), last=gsub(',','', X7), volume = gsub(',','', word(X21,1,1,' ')))]
           Final_Data[, code:=paste0('STKVN', ticker)]
           Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub(',','',reference)))]
           Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub(',','',last)))]
           Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), 10*as.numeric(gsub(',','',volume)))]
           Final_Data = Final_Data[nchar(ticker)==3]
           Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
           My.Kable.TB(Final_Data[order(ticker)])
           
         },
         'C68' = {
           # ==================================================================================================
           pURL = 'https://www.cophieu68.vn/stockonline.php?stcid=1&nd=2000'
           # ==================================================================================================
           Source = 'C68'
           Market = 'HSX'
           xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', paste0('BANG_GIA_', format(Sys.time(), "%H%M%S"), '.txt')), ToDeleteTemp = T)
           html <- read_html(xweb)
           tables <- html_nodes(html, "table")  # Assuming first table element
           
           data_table <- setDT(html_table(tables[[1]]))
           data_table = data_table[-c(1:2)]
           My.Kable(data_table[X1=='AAA'])
           # str(data_table)
           Final_Data = data_table[, .(X1, source=Source, market=Market, ticker=gsub('[*]', '', X1), reference=gsub(',','', X4),
                                       last=gsub(',','', X11), volume = gsub(',','', word(X20,1,1,' ')))]
           My.Kable(Final_Data[ticker=='AAA'])
           # Final_Data[, ':='(reference=ifelse1000*as.numeric(reference), last=gsub(',','', X7), volume = gsub(',','', word(X21,1,1,' ')))]
           
           Final_Data[, code:=paste0('STKVN', ticker)]
           Final_Data[, reference:=ifelse(is.na(reference), as.numeric(NA), 1000*as.numeric(gsub(',','',reference)))]
           Final_Data[, last:=ifelse(is.na(last), as.numeric(NA), 1000*as.numeric(gsub(',','',last)))]
           Final_Data[, volume:=ifelse(is.na(volume), as.numeric(NA), as.numeric(gsub(',','',volume)))]
           Final_Data = Final_Data[nchar(ticker)==3]
           Final_Data = merge(Final_Data, ins_ref[, .(code, name=short_name)], all.x=T, by='code')[order(name)]
           My.Kable.TB(Final_Data[order(ticker)])
           
         }
         
  )
  Final_Data [, updated := substr ( as.character (Sys.time()),1,19)]
  return(Final_Data)
}



# ==================================================================================================
# RELOAD_INSREF = function ( silent=T, ToForce=F) {
#   # ------------------------------------------------------------------------------------------------
#   # 2023-09-14
#   # if (file.exists("U:/EFRC/DATA/")) { UData = "U:/EFRC/DATA/" } else { UData = 'S:/CCPR/DATA/' }
#   
#   
#   if (ToForce)
#   {
#     if (file.exists(UData)) 
#     { 
#       CATln('Loading ..')
#       ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T) 
#     }   else {
#       CATln('Loading ..')
#       ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T) 
#     }
#     
#     assign("ins_ref", ins_ref, envir = .GlobalEnv)
#   } else {
#     if (exists("ins_ref")) 
#     { 
#       if (!silent) 
#       { CATln("INS_REF ALREADY LOADED") }
#     } else { 
#       # UData = SData
#       CATln('Loading ..')
#       if (file.exists(UData)) 
#       { 
#         ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
#       } else {
#         ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
#       }
#       assign("ins_ref", ins_ref, envir = .GlobalEnv)
#     }
#   }
# }


# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_SNAPSHOT_BY_CODE = function(pCode  = 'AAH', URL = '', ToAdd = F) {
  
  LastTrading = CCPR_LAST_TRADING_DAY_VN(max(8, as.numeric(substr(Sys.time(),12,13))), ToPrompt = T)
  # ----------------------------------------------------------------------------
  # pCode  = 'AAH'; URL = 'https://s.cafef.vn/upcom/aah-cong-ty-co-phan-hop-nhat.chn':  ToAdd = T
  temp_dir = tempdir()
  Final_Data = data.table()
  # DBL_RELOAD_INSREF()
  CAF_LINK = as.character(NA)
  
  if (nchar(URL) == 0)
  {
    CAF_LINKS = CCPR_READRDS('S:/CCPR/DATA/', 'download_caf_stkvn_list_links.rds', ToRestore = T)
    CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
    # CAF_LINKS = CAF_LINKS[ticker!='AAH']
    CAF_ONE   = CAF_LINKS[code==paste0('STKVN', pCode)]
    CAF_LINK  = paste0('https://s.cafef.vn/', CAF_LINKS[ticker==pCode][, .(link)]$link)
  } else {
    CAF_LINK  = URL
    
  }
  CATln_Border(CAF_LINK)
  
  if (!is.na(CAF_LINK))
  {
    pWeb       = GET_CURL_FETCH(pURL = CAF_LINK)
    xNAMEVN    = as.character(NA)
    xMARKET    = as.character(NA)
    xVALUE     = as.numeric(NA)
    library(stringi)
    
    # if (<div class="dltlu-point down">5.1</div>)
    #   <span id="ltrCurentPrice"><div class="dltlu-point down">5.1</div></span>
    
    
    
    # <div id="namebox" class="dlt-ten">
    #   <h1>&nbsp;Công ty cổ phần Hợp Nhất (UpCOM)
    # </h1></div>
    
    if (grepl('<div id="namebox" class="dlt-ten">', pWeb))
    {
      xVALUE = trimws(gsub('\r\n', '', str.extract(pWeb, '<div id="namebox" class="dlt-ten">', '</div>')))
      
      if (grepl('[(]', xVALUE)) { 
        xNAMEVN = trimws(str.extract(xVALUE, '<h1>&nbsp;', '('))
        xMARKET = trimws(str.extract(xVALUE, '(', ')'))
      } else {
        xNAMEVN = trimws(gsub('<h1>&nbsp;', '', xVALUE))
        xMARKET = as.character(NA)
      }
      
    } 
    
    if (grepl('Giá tham chiếu', pWeb))
    {
      xVALUE = trimws(gsub('\r\n', '', str.extract(pWeb, '<div class="l">Giá tham chiếu</div>', '</div>')))
      xVALUE = 1000*as.numeric(gsub(',','', TRAINEE_LAST_WORD(xVALUE,  '\\>')))
      xREFERENCE  = xVALUE
    } else { xREFERENCE = as.numeric(NA)}
    
    if (grepl('ltrCurentPrice', pWeb))
    {
      xVALUE = trimws(gsub('\r\n', '', str.extract(pWeb, '<span id="ltrCurentPrice">', '</div>')))
      xVALUE = 1000*as.numeric(gsub(',','', TRAINEE_LAST_WORD(xVALUE,  '\\>')))
      xLAST  = xVALUE
    } else { xLAST = as.numeric(NA)}
    
    if (grepl('Khối lượng', pWeb))
    {
      xVALUE   = trimws(gsub('\r\n', '', str.extract(pWeb, '<div class="v1">Khối lượng</div>', '</div>')))
      xVALUE   = as.numeric(gsub(',','', TRAINEE_LAST_WORD(xVALUE,  '\\>')))
      xVOLUME  = xVALUE
    } else { xVOLUME = as.numeric(NA)}
    
    Final_Data = data.table(ticker=pCode, code=paste0('STKVN', pCode), name=xNAMEVN, market=xMARKET, 
                            date=LastTrading, reference=xREFERENCE, close=xLAST, volume=xVOLUME, updated = substr(as.character (Sys.time()),1,19))
    My.Kable.All(Final_Data)
  }
  return(Final_Data)
}

# x = CCPR_DOWNLOAD_CAF_STKVN_SNAPSHOT_BY_CODE(pCode  = 'AAH', URL = '', ToAdd = F)

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_SHARES_BY_CODE = function(pCode  = 'VNM', URL = '', ToAdd = F)  {
  # ----------------------------------------------------------------------------
  # pCode  = 'AAH'; URL = 'https://s.cafef.vn/upcom/aah-cong-ty-co-phan-hop-nhat.chn':  ToAdd = T
  temp_dir = tempdir()
  Final_Data = data.table()
  # DBL_RELOAD_INSREF()
  CAF_LINK = as.character(NA)
  
  if (nchar(URL) == 0)
  {
    CAF_LINKS = CCPR_READRDS('S:/CCPR/DATA/', 'download_caf_stkvn_list_links.rds', ToRestore = T)
    CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
    # CAF_LINKS = CAF_LINKS[ticker!='AAH']
    CAF_ONE   = CAF_LINKS[code==paste0('STKVN', pCode)]
    CAF_LINK  = paste0('https://s.cafef.vn/', CAF_LINKS[ticker==pCode][, .(link)]$link)
  } else {
    CAF_LINK  = URL
    
  }
  CATln_Border(CAF_LINK)
  
  if (!is.na(CAF_LINK))
  {
    # pURL = 'https://s.cafef.vn/hose/vic-tap-doan-vingroup-cong-ty-co-phan.chn'
    # pURL      = paste0('https://s.cafef.vn/', CAF_ONE[1]$link)
    pURL = CAF_LINK
    CATln_Border(pURL)
    
    # x    = WEB_SAVE_AS(pURL = pURL, SaveFolder = 'c:/python/downloads/')
    # grepl('KLCP đang niêm yết', x)
    # SharesLis = as.numeric(gsub(',','', trimws(word(trimws(gsub('\n','', str.extract(x, '<div class="l"><b>KLCP đang niêm yết:</b></div>', '</div>'))),2,2, '>'))))
    # SharesOut = as.numeric(gsub(',','', trimws(word(trimws(gsub('\n','', str.extract(x, '<div class="l"><b>KLCP đang lưu hành:</b></div>', '</div>'))),2,2, '>'))))
    LastTrading = CCPR_LAST_TRADING_DAY_VN(max(9, hour(Sys.time())), ToPrompt = T)
    
    CATln_Border(pURL)
    # content    = try(readr::read_file(pURL))
    File_Temp  = paste0('CAF_', gsub('-|[:]| ', '' ,substr(as.character(Sys.time()),1,19)),'.txt')
    content    = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
    x.SHARESLIS = trimws(gsub('\r\n', '', str.extract(content, '<div class="l"><b>KLCP đang niêm yết:</b></div>', '</div')))
    v.SHARESLIS = as.numeric(gsub(',','', trimws(word(x.SHARESLIS,2,2,">")))); CATln(v.SHARESLIS)
    x.SHARESOUT = trimws(gsub('\r\n', '', str.extract(content, '<div class="l"><b>KLCP đang lưu hành:</b></div>', '</div')))
    v.SHARESOUT = as.numeric(gsub(',','', trimws(word(x.SHARESOUT,2,2,">")))); CATln(v.SHARESOUT)
    Final_Data = data.table(sharesout=v.SHARESOUT, shareslis=v.SHARESLIS)
    
    SharesLis = v.SHARESLIS
    SharesOut = v.SHARESOUT
    
    Final_Data = data.table(ticker = pCode, codesource=pCode, source='CAF', code=paste0('STKVN', pCode), date=LastTrading, sharesout=SharesOut, shareslis=SharesLis,updated = substr( as.character (Sys.time()),1,19) )
    Final_Data = merge(Final_Data[, -c('name')], ins_ref[, .(code, name=short_name, market)], all.x=T, by='code')
    My.Kable.All(Final_Data)
    
    if (all (nrow(Final_Data)>0 & ToAdd)  )
    {
      CAF_LINKS = CCPR_READRDS(SData, 'download_caf_stkvn_list_links.rds', ToRestore = T)
      CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
      
      s.Code   = paste0('STKVN', pCode)
      if (!s.Code %in% CAF_LINKS$code)
      {
        s.URL  = URL
        s.link = gsub('https://s.cafef.vn/', '', URL)
        s.exc  = word(s.link,1,1,'/')
        ADD_ONE = data.table(ticker=pCode, code=paste0('STKVN', pCode), link=s.link, URL=s.URL, updated=substr(as.character(Sys.time()),1,19))
        My.Kable.All(ADD_ONE)
        # str(CAF_LINKS)
        CAF_LINKS = rbind(CAF_LINKS, ADD_ONE, fill=T)
        CAF_LINKS = unique(CAF_LINKS, by=c('code', 'URL'), fromLast = T)
        My.Kable.TB(CAF_LINKS[,.(ticker, code, link, URL)])
        saveRDS(CAF_LINKS, paste0(SData, 'download_caf_stkvn_list_links.rds'))
      }
    }
  }
  return(Final_Data)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_VND_FREEFLOATPC = function(pCode='VIC') {
  # ------------------------------------------------------------------------------------------------
  pURL = paste0('https://dstock.vndirect.com.vn/tong-quan/',pCode)
  CATln_Border(pURL)
  xweb      = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', 'VNDIRECT.txt'), ToDeleteTemp = T)
  # Free float</div><div class="row-col__text font--second">25%</div>
  xValue    = str.extract(xweb, 'Free float</div>', '%</div>')
  My_Value  = as.numeric(TRAINEE_LAST_WORD(xValue,  '\\>'))
  CATln_Border(paste('DOWNLOAD_VND_FREEFLOATPC : ', pCode, '=', My_Value))
  return (My_Value)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_24HMONEY_FREEFLOATPC = function(pCode)  {
  # ------------------------------------------------------------------------------------------------
  pURL <-paste0('https://24hmoney.vn/stock/', pCode)
  response <- GET(pURL, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  xweb       = content(response, as="text")
  content    = try(rvest::read_html(xweb))
  
  free_float <- content %>%
    html_nodes(xpath = '//*[@id="__layout"]/div/div[2]/div[1]/div[6]/div[1]/div/table/tbody/tr[10]/td[1]/div/span[2]') %>%
    html_text() %>%
    rbind(
      content %>%
        html_nodes(xpath = '//*[@id="__layout"]/div/div[2]/div[1]/div[10]/div[1]/div/table/tbody/tr[10]/td[1]/div/span[2]') %>%
        html_text()
    )
  free_float = free_float[1,1]
  free_float <- as.numeric(gsub("\\D", "", free_float))
  CATln_Border(paste('DOWNLOAD_24HMONEY_FREEFLOATPC : ', pCode, '=', free_float))
  
  return(free_float)
}

# ==================================================================================================
TRAINEE_CLEAN_ALL_BOARD = function(Folder = 'S:/R/DATA/BOARD/', File = 'download_all_board.rds' ) {
  # ------------------------------------------------------------------------------------------------
  library(gender)
  BOARD_DATA = CCPR_READRDS(Folder, File)
  My.Kable(BOARD_DATA[, .(codesource, name, first_name, last_name, ceo, cob, title)])
  
  BOARD_DATA = BOARD_DATA[!is.na(name)]
  BOARD_DATA[grepl('[.]', name), tg:=word(name,1,1,'[.]')]
  BOARD_DATA[grepl('[.]', codesource), ext:=word(codesource ,2,2,'[.]')]
  print(sort(unique(BOARD_DATA[nchar(tg)<5]$tg)))
  
  x = BOARD_DATA[1]$name
  trimws(word(x,2,2,'Dr.'))
  x = BOARD_DATA[1]$codesource
  trimws(word(x,2,2,'[.]'))
  
  BOARD_DATA[grepl('Mr.', name), fullname:=trimws(word(name,2,2,'Mr.'))]
  BOARD_DATA[grepl('Ms.', name), fullname:=trimws(word(name,2,2,'Ms.'))]
  BOARD_DATA[grepl('Mrs.', name), fullname:=trimws(word(name,2,2,'Mrs.'))]
  BOARD_DATA[grepl('Dr.', name), fullname:=trimws(word(name,2,2,'Dr.'))]
  BOARD_DATA[grepl('Prof.', name), fullname:=trimws(word(name,2,2,'Prof.'))]
  
  x = BOARD_DATA[1]$fullname
  trimws(word(x,2,2,'Dr.'))
  
  BOARD_DATA[grepl('B.Sc', name), fullname:=trimws(word(fullname,1,1,'B.Sc'))]
  BOARD_DATA[grepl('B.Tech', name), fullname:=trimws(word(fullname,1,1,'B.Tech'))]
  BOARD_DATA[grepl('B.Com', name), fullname:=trimws(word(fullname,1,1,'B.Com'))]
  BOARD_DATA[grepl('B.Bus', name), fullname:=trimws(word(fullname,1,1,'B.Bus'))]
  BOARD_DATA[grepl('B.Pharm', name), fullname:=trimws(word(fullname,1,1,'B.Pharm'))]
  BOARD_DATA[grepl('B.B.A', name), fullname:=trimws(word(fullname,1,1,'B.B.A'))]
  BOARD_DATA[grepl('FAusI', name), fullname:=trimws(word(fullname,1,1,'FAusI'))]
  BOARD_DATA[grepl('BEc', name), fullname:=trimws(word(fullname,1,1,'BEc'))]
  BOARD_DATA[grepl('B.A.', name), fullname:=trimws(word(fullname,1,1,'B.A.'))]
  BOARD_DATA[grepl('M.A.I.C.D', name), fullname:=trimws(word(fullname,1,1,'M.A.I.C.D'))]
  BOARD_DATA[grepl('A.C.I.S.', name), fullname:=trimws(word(fullname,1,1,'A.C.I.S.'))]
  BOARD_DATA[grepl('A.C.I.S.', name), fullname:=trimws(word(fullname,1,1,'A.C.I.S.'))]
  BOARD_DATA[grepl('A.M.', name), fullname:=trimws(word(fullname,1,1,'A.M.'))]
  BOARD_DATA[grepl('ACIS', name), fullname:=trimws(word(fullname,1,1,'ACIS'))]
  BOARD_DATA[grepl('AGIA', name), fullname:=trimws(word(fullname,1,1,'AGIA'))]
  BOARD_DATA[grepl('B.S.', name), fullname:=trimws(word(fullname,1,1,'B.S.'))]
  BOARD_DATA[grepl('[(]', name), fullname:=trimws(word(fullname,1,1,'\\('))]
  
  LETTERS
  for (l in LETTERS)
  {
    xL = paste0('B',l)
    BOARD_DATA[grepl(xL, name), fullname:=trimws(word(fullname,1,1,xL))]
  }
  
  BOARD_DATA[, c("first_name", "last_name") := NULL]
  
  
  BOARD_DATA[, c("first_name", "last_name") := {
    names <- strsplit(fullname, " ") 
    last_name <- sapply(names, function(x) tail(x, 1))
    first_name <- sapply(names, function(x) paste(x[-length(x)], collapse = " "))
    list(first_name, last_name)
  }]
  
  
  BOARD_DATA$n_gender = as.character(NA)
  
  BOARD_DATA[grepl('Mr.', name), n_gender:='MALE']
  BOARD_DATA[grepl('Mrs.', name), n_gender:='FEMALE']
  BOARD_DATA[grepl('Ms.', name), n_gender:='FEMALE']
  
  if (any(is.na(BOARD_DATA$n_gender))) {
    not_clean <- BOARD_DATA[is.na(BOARD_DATA$n_gender), ]
  }
  
  
  board_na_gender <- is.na(BOARD_DATA$n_gender)
  board_first_name <- nchar(trimws(BOARD_DATA$first_name)) > 0
  
  xname <- trimws(as.character(BOARD_DATA$first_name))
  FName <- gender(xname)
  valid_first_names <- !is.na(xname) & nchar(xname) > 0 & !is.null(FName) & nrow(FName) > 0
  
  valid_gender_values <- FName$proportion_male > 0.95 | FName$proportion_female > 0.95
  
  BOARD_DATA$n_gender <- ifelse(board_na_gender & board_first_name & valid_first_names & valid_gender_values,
                                toupper(FName$gender),
                                BOARD_DATA$n_gender)
  
  BOARD_DATA[is.na(gender) & !is.na(n_gender), gender := n_gender]
  names(BOARD_DATA)
  
  My.Kable.TB(BOARD_DATA[, .(ceo, cob, ext, codesource, name, tg, nbw, fullname, gender, n_gender, first_name, last_name)], Nb=10)
  My.Kable.TB(BOARD_DATA[ceo==1][, .(ceo, cob, ext, codesource, name, gender, n_gender, first_name, last_name)], Nb=5)
  My.Kable.TB(BOARD_DATA[cob==1][, .(ceo, cob, ext, codesource, name, gender, n_gender, first_name, last_name)], Nb=5)
  
  return(BOARD_DATA)
  
}

# ==================================================================================================
TRAINEE_REPORT_GLOBAL_WCEO = function() {
  # ------------------------------------------------------------------------------------------------
  BOARD_DATA = TRAINEE_CLEAN_ALL_BOARD(Folder = 'S:/R/DATA/BOARD/', File = 'download_all_board.rds')
  stat = BOARD_DATA[, .(
    nb_records = .N,                    
    start = min(date),                  
    end = max(date),                    
    nb_company = n_distinct(codesource),
    nb_people = sum(!is.na(gender)),    
    nb_ceo = sum(ceo, na.rm = TRUE),    
    nb_cob = sum(cob, na.rm = TRUE),    
    nb_wceo = sum(ifelse(ceo == 1 & gender == "FEMALE", 1, 0), na.rm = TRUE), 
    nb_mceo = sum(ifelse(ceo == 1 & gender == "MALE", 1, 0), na.rm = TRUE), 
    nb_wcob = sum(ifelse(cob == 1 & gender == "FEMALE", 1, 0), na.rm = TRUE),
    nb_mcob = sum(ifelse(cob == 1 & gender == "MALE", 1, 0), na.rm = TRUE),
    updated = substr(Sys.time(), 1, 19) 
  ), by = market]
  
  stat[, percentage_wceo := as.numeric(round(100 * nb_wceo / (nb_wceo + nb_mceo), 2), nsmall = 2)]
  stat[, percentage_wcob := as.numeric(round(100 * nb_wcob / (nb_wceo + nb_mcob), 2), nsmall = 2)]
  
  country = read.xlsx("S:/R/DATA/BOARD/stat_board.xlsx")
  stat = merge(stat, country, by = "market", all.x = TRUE)
  
  if ("CHN" %in% stat$market) {
    stat = subset(stat, !(market %in% c("SSE", "SZSE")))
  } else {
    china = subset(stat, iso3 == "CHN")
    numeric_cols = names(china)[sapply(china, is.numeric)]
    totals_china = lapply(china[, ..numeric_cols], sum)
    total_row = as.data.table(totals_china)[, market = "CHN"]
    total_row[,  percentage_wceo = as.numeric(round(100 * nb_wceo / (nb_wceo + nb_mceo), 2), nsmall = 2)]
    total_row[,  percentage_wcob = as.numeric(round(100 * nb_wcob / (nb_wceo + nb_mcob), 2), nsmall = 2)]
    stat = rbind(subset(stat, iso3 != "CHN"), total_row[, ":="(iso3 = "CHN")], fill = TRUE)
  }
  
  efrc_country_ref = readRDS("S:/R/DATA/efrc_country_ref.rds")
  match_data = merge(stat, efrc_country_ref[, .(country = name, continent, developed_level,iso3)], by = "iso3", all.x = TRUE)
  match_data = match_data[order(continent, developed_level, country), ]
  
  numeric_cols = names(match_data)[sapply(match_data, is.numeric)]
  totals       = lapply(match_data[,..numeric_cols], sum)
  total_row    = as.data.table(totals)[, iso3 := "Total"]
  match_data   = rbind(match_data, total_row, fill = TRUE)
  
  match_data = match_data[order(continent, developed_level, country), ]
  
  report_ceo = subset(match_data, select = -c(nb_cob, nb_wcob, nb_mcob, percentage_wcob))
  report_cob = subset(match_data, select = -c(nb_ceo, nb_wceo, nb_mceo, percentage_wceo))
  
  saveRDS(match_data,"S:/R/DATA/BOARD/report_board.rds" )
  saveRDS(report_ceo,"S:/SHINY/BOARD/GLOBAL WCEO/report_ceo.rds")
  saveRDS(report_cob,"S:/SHINY/BOARD/GLOBAL WCEO/report_cob.rds")
  
}

# ==================================================================================================
TRAINEE_PERFORMANCE_INDEX = function (Country = "AUS") {
  # ------------------------------------------------------------------------------------------------
  
  library(echarts4r)
  File_Folder = paste0("S:/WCEO_INDEXES/", Country, "/")
  File_Name   = paste0("ifrc_ccpr_indwceo",tolower(Country),"_history.rds")
  File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
  cur_loc = unique(File_Data[cur != "USD"], by = "cur")$cur
  
  if (nrow(File_Data) > 0) {
    
    ind_spd_loc = spread(File_Data[cur == cur_loc][,. (date, code, close)], key = "code", value = "close")
    ind_spd_usd = spread(File_Data[cur == 'USD'][,. (date, code, close)], key = "code", value = "close")
    
    
    CHART_LOC = ind_spd_loc %>% 
      e_charts(date) %>% 
      e_title(paste0("Performance of Women CEO Index (", Country, ")"), paste0("Currency: ", cur_loc), textStyle = list(fontSize = 20), left = 'center') %>%
      e_line(INDWCEAUSCWPRLOC, smooth = FALSE, name = "CW", showSymbol = FALSE, color = "red") %>%  
      e_line(INDWCEAUSEWPRLOC, smooth = FALSE, name = "EW", showSymbol = FALSE, color = "yellow") %>% 
      e_line(INDWCEAUSFWPRLOC, smooth = FALSE, name = "FW", showSymbol = FALSE, color = "blue") %>% 
      e_theme("dark") %>%
      e_legend(bottom = 0)
    
    CHART_USD = ind_spd_usd %>% 
      e_charts(date) %>% 
      e_line(INDWCEAUSCWPRUSD , smooth = F, name="CW", showSymbol = F, color="red") %>%  
      e_line(INDWCEAUSEWPRUSD , smooth = F, name="EW", showSymbol = F, color="yellow") %>% 
      e_line(INDWCEAUSFWPRUSD , smooth = F, name="FW", showSymbol = F, color= "blue") %>% 
      e_theme("dark") %>% 
      e_title("Performance of Women CEO Index (USD)", "Currency: USD")%>%
      e_legend(bottom = 0)
  }else {
    CATln('')
    CATln_Border(paste(Country, ':', "Data not found."))
  }
  
}


# ==================================================================================================

TRAINEE_MERGE_IND_WCEO = function (Folder = "S:/WCEO_INDEXES/", ToFolder = '', ToFile = '', ToSave = F) {
  # ------------------------------------------------------------------------------------------------
  
  subfolders            = list.dirs(Folder, recursive = FALSE)
  subfolder_names       = basename(subfolders)
  subfolder_names_list  = as.list(subfolder_names)
  
  merged_data_list = list() 
  
  for (Country in subfolder_names_list) {
    # Country = 'AUS'
    File_Folder = paste0("S:/WCEO_INDEXES/", Country, "/")
    File_Name   = paste0("ifrc_ccpr_indwceo",tolower(Country),"_history.rds")
    CATln_Border( paste0(File_Folder, File_Name))
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    if (nrow(File_Data) > 0)
    {
      File_Data$country     = Country
      merged_data_list[[Country]] = File_Data 
    }
    
  }
  merged_data = rbindlist(merged_data_list, fill = TRUE)  
  rm(merged_data_list, data)
  gc()
  if (ToSave) {
    CCPR_SAVERDS(merged_data, ToFolder, ToFile, ToSummary = T, SaveOneDrive = T)
  }
}

# ==================================================================================================
TRAINEE_DOWNLOAD_DNSE_FREEFLOATPC = function(pCode='VIC') {
  # ------------------------------------------------------------------------------------------------
  pURL = paste0('https://www.dnse.com.vn/senses/co-phieu-',pCode)
  CATln_Border(pURL)
  xweb      = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', 'DNSE.txt'), ToDeleteTemp = T)
  xValue    = str.extract(xweb, 'Tỷ lệ Free float</p>', '%</p>')
  My_Value  = as.numeric(TRAINEE_LAST_WORD(xValue,  '\\>'))
  CATln_Border(paste('DOWNLOAD_DNSE_FREEFLOATPC : ', pCode, '=', My_Value))
  return(My_Value)
}

# ==================================================================================================
TRAINEE_LAST_WORD = function(Str, SubStr)  {
  # ------------------------------------------------------------------------------------------------
  return(stri_reverse(word(stri_reverse(Str),1,1,SubStr)))
}

# ==================================================================================================
TRAINEE_DASHBOARD_WOMENCEO_INTERNATIONAL_STATS = function(File_Folder = 'S:/WCEO_INDEXES/',
                                                          File_Indexes = 'ifrc_ccpr_indwceoall_history.rds',
                                                          End_date = '2024-02-28') {
  # ------------------------------------------------------------------------------------------------
  x = CCPR_READRDS(File_Folder, File_Indexes)
  x[, name:=gsub('HONG KONG', 'HONG-KONG', name)]
  colnames(x)
  # cleanse raw data
  x = unique(x, by = c('code', 'date'))
  
  # STEP 2: RE-CALCULATE DATA
  Ind_History = x  [date <= End_date]  
  Ind_History[, close_adj:=close]
  str(Ind_History)
  
  Ind_History = Ind_History[order(code, date)] 
  Ind_History[, ':='(change=close_adj-shift(close_adj), varpc=100*(close_adj/shift(close_adj)-1)), by='code']
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_adj/shift(close_adj))-1, by='code']
  
  # Ind_Quarter = unique(Ind_History[order(code, -date)][, yyyymm:=100*year(date)+month(date)], by=c('code', 'yyyymm'))[order(code, date)]
  # Ind_Quarter[, rtm:=(close/shift(close))-1, by='code']
  
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code'))[, .(code, name, date, last=close_adj, change, varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  My.Kable(Ind_Overview)
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  library(stringi)
  Ind_All[, cur:=word(word(name,2,2,'\\('),1,1,'\\)')]
  Ind_All[, version:=stri_reverse(word(stri_reverse(trimws(word(name,1,1,'\\('))),1,1,' '))]
  Ind_All[, wgtg:=stri_reverse(word(stri_reverse(trimws(word(name,1,1,'\\('))),2,2,' '))]
  Ind_All[, country:=stri_reverse(word(stri_reverse(trimws(word(name,1,1,'\\('))),3,3,' '))]
  # Ind_All[, rev_tmp:=stringi::stri_reverse(cur)]
  # Ind_All[, wgtg:=strsplit(rev(tmp), pattern = "\\s+")[1]]
  
  My.Kable.All(Ind_All[, .(country, name, cur, version, wgtg, date, last, Y1, Y2, Y3, Y4, Y5, Y6)])
  My.Kable.All(Ind_All[, .(country, name, cur, version, wgtg, date, last, M1, M2, M3, M4, M5, M6)])
  My.Kable.All(Ind_All[, .(country, name, cur, version, wgtg, date, last, Q1, Q2, Q3, Q4, Q5, Q6)])
  
  End.time = Sys.time()
  return(Ind_All)
}

# ==================================================================================================
CCPR_STKVN_EXPORT_BOARD_DAY = function ( FileFull = "S:/STKVN/BOARD/DAY/TRAINEE_CAF_BOARD_FULL_DAY_20240329.rds",
                                         FileRef = paste0("S:/STKVN/BOARD/DAY/ifrc_ccpr_all_stkvn_final_day_",gsub('-','',pDate),".rds"),
                                         ToFolder = '' , ToFile = '',
                                         pDate = '2024-03-29' , 
                                         ToSave = T)  {
  # ------------------------------------------------------------------------------------------------
  
  BOARD_VN = readRDS(FileFull)
  str(BOARD_VN)
  My.Kable(BOARD_VN[, .(code, category, gender, ceo, rank, rawname=source_pname, position=source_position)])
  My.Kable(BOARD_VN[ceo==1][, .(code, category, gender, ceo, rank, rawname=source_pname, people_name, position=source_position)])
  
  My.Kable(BOARD_VN[ceo==1 & gender %in% list("MALE", "FEMALE")][, .(code, category, gender, ceo, rank, rawname=source_pname, people_name, position=source_position)])
  My.Kable(BOARD_VN[ceo==1 & gender %in% list("FEMALE")][, .(code, category, gender, ceo, rank, rawname=source_pname, people_name, position=source_position)])
  
  
  FULL_STKVN = readRDS( FileRef )
  My.Kable(FULL_STKVN)
  BOARD_VN = merge(BOARD_VN, FULL_STKVN[, .(code, market, company_name=name, sharesout,close, reference,volume, capivnd)], all.x = T, by='code')
  
  My.Kable(BOARD_VN[ceo==1][, .(market, company_name, code, category, gender, ceo, rank, rawname=source_pname, people_name, position=source_position)])
  My.Kable(BOARD_VN[ceo==1 & market %in% list("HNX", "HSX")][, .(date, market, company_name, code, category, gender, ceo, rank, rawname=source_pname, people_name, position=source_position)])
  My.Kable.TB(BOARD_VN[ceo==1 & gender=='FEMALE' & market %in% list("HNX", "HSX")][, .(date, market, company_name, code, category, gender, ceo, rank, rawname=source_pname, people_name, position=source_position)])
  
  
  if (ToSave) { CCPR_SAVERDS(BOARD_VN, ToFolder, ToFile)}
  return (BOARD_VN)
}

# ==================================================================================================
CCPR_DASHBOARD_CALCULATE_STATS = function (pOption = '', pData = data.table() , pFolder = 'S:/CCPR/DATA/DASHBOARD/',
                                           pFile = 'ccpi_dashboard_ind_all_history.rds', EndDate  = '2023-12-31' )  {
  # ------------------------------------------------------------------------------------------------
  # pFolder = 'R:/CCPR/DATA/DASHBOARD/'; pFile = 'download_ifrc_indetf_history.rds'
  if (nrow(pData ) > 1 ) { 
    x = pData
    if ( !'close_adj' %in% colnames(pData) ) { x [, close_adj := close]}
    if ( !'code' %in% colnames(pData) ) { x [, code := codesource]}
  } else {
    if (pFile == 'ifrc_ccpr_investment_history.rds') {
      investment = CCPR_READRDS(pFolder, pFile) [order (-date)]
      investment [, rt:=((close/shift(close))-1)*100, by='code']
      investment [, ':=' (cur = NA, close_adj = close)]
      x = investment
    } else { 
      x = CCPR_READRDS(pFolder,pFile)
      if ( !'close_adj' %in% colnames(x) ) { x [, close_adj := close]}
      if ( !'code' %in% colnames(x) ) { x [, code := codesource]}
    }
  }
  # STEP 1: READ FILE PRICES HISTORY
  
  colnames(x)
  # cleanse raw data
  x = unique(x, by = c('code', 'date'))
  
  # STEP 2: RE-CALCULATE DATA
  Ind_History = x  [date <= EndDate]  
  
  str(Ind_History)
  
  Ind_History = Ind_History[order(code, date)] 
  Ind_History[, ':='(change=close_adj-shift(close_adj), varpc=100*(close_adj/shift(close_adj)-1)), by='code']
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_adj/shift(close_adj))-1, by='code']
  
  # Ind_Quarter = unique(Ind_History[order(code, -date)][, yyyymm:=100*year(date)+month(date)], by=c('code', 'yyyymm'))[order(code, date)]
  # Ind_Quarter[, rtm:=(close/shift(close))-1, by='code']
  
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code'))[, .(code, name, date, last=close_adj, change, varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  My.Kable(Ind_Overview)
  
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  End.time = Sys.time()
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  
  
  my_add  =  unique(Ind_History, by = 'code' )
  Ind_Data = Ind_All
  switch ( pOption,
           'WORLD_EQUITIES_INDEX' = {
             Ind_Data = merge (Ind_All, my_add [,.(code, iso2, country, continent)], all.x = T, by = 'code')   [date >= max(date) - 5]
           },
           'CCPI_INTERNATIONAL_INDEXES' = {
             Ind_Data = merge (Ind_All, my_add [,.(code, iso2, country, continent)], all.x = T, by = 'code')  [date >= max(date) - 5]
           }
  )
  
  
  return (Ind_Data)
}

# ==================================================================================================
CCPR_DASHBOARD_CALCULATE_STATS_BLOCK = function (Fr_Data = data.table(),  Fr_Folder = 'S:/CCPR/DATA/DASHBOARD/', 
                                                 Fr_File = 'ifrc_ccpr_investment_history.rds',
                                                 To_Folder = 'S:/CCPR/DATA/DASHBOARD/', To_File = 'ccpi_dashboard_wti.rds', DateLimit = '2023-12-31' ,
                                                 ToSave = T, ToUpload = T)  {
  # ------------------------------------------------------------------------------------------------
  if (nrow(as.data.table(Fr_Data) ) > 1 ) { 
    My_Data = CCPR_DASHBOARD_CALCULATE_STATS  (pData = Fr_Data, pFolder = Fr_Folder, pFile = Fr_File, EndDate  = DateLimit )
  } else {
    My_Data = CCPR_DASHBOARD_CALCULATE_STATS  (pOption = pOption, pData = data.table(), pFolder = Fr_Folder, pFile = Fr_File, EndDate  = DateLimit ) }
  
  
  My_Data [, ':=' (cur = substr(code, nchar(code)-2, nchar(code)), version = substr(code, nchar(code)-4, nchar(code)-3),
                   wgtg = substr(code, nchar(code)-6, nchar(code)-5), short_name= gsub('IFRC/BEQ HOLDINGS ','',name))]
  # My_Data [grepl('TOP ', name), category:='TRADABLE']
  # My_Data [!grepl('TOP ', name), category:='BENCHMARK']
  My_Data [, excess := 0]
  
  
  
  # My_Data = My_Data [ date >= max (date) - 5]
  if (ToSave) {   CCPR_SAVERDS(My_Data,To_Folder, To_File ) }
  if (ToUpload) {
    try(TRAINEE.IFRC.UPLOAD.RDS.2023(l.host = "ccpi_dashboard", l.tablename= tolower(gsub('.rds','', To_File)),
                                     l.filepath= tolower(paste0('S:/CCPR/DATA/DASHBOARD/',  To_File)),
                                     CheckField=T, ToPrint = T, ToForceUpload=T, ToForceStructure=T))
  }
  return (My_Data)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_STKVN_BOARD_LONG_BY_SOURCE = function(pSource='CAF', pFolder =  'S:/STKVN/BOARD/DAY/', 
                                                       pDate = '2024-03-29' ,
                                                       Nb_Min = 50,   Nb_Group = 20) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_MONITOR_EXECUTION_SUMMARY (pOption='CCPR_DOWNLOAD_SOURCE_STKVN_BOARD_BY_MARKET', pAction="SAVE", NbSeconds=3600, ToPrint=F)
  DBL_RELOAD_INSREF()
  FileName = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_LONG_', gsub('-','',pDate), '.rds')
  List_Codes = CCPR_READRDS (pFolder , paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_', gsub('-','',pDate), '.rds') )
  
  FilePath = paste0(pFolder, FileName, '.rds')
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  ExtraFolder = ''
  
  if (nrow(List_Codes)>0)
  {
    if (file.exists(FilePath))
    {
      # Data_old = CCPR_READRDS(pFolder, paste0(FileName, '.rds')) 
      Data_old = try ( readRDS(paste0(pFolder, FileName, '.rds'))  )
      if (nrow(Data_old)>0) {
        Data_old = Data_old[!is.na(people_url)]
        List_Codes_ToDo = List_Codes[!people_url %in% Data_old$people_url ]
        My.Kable.TB(Data_old)
      } else {
        List_Codes_ToDo = List_Codes
      }
    } else { 
      CATln(paste('FILE NO EXIST :', FilePath))
      Data_old = data.table() 
      List_Codes_ToDo = List_Codes
    }
    
    if (nrow(List_Codes_ToDo)>0)
    {
      List_Codes_ToDo = List_Codes_ToDo[order(codesource)]
      My.Kable(List_Codes_ToDo)
      Data_All = data.table()
      Data_List = list()
      
      FileData = List_Codes_ToDo
      FileRow  = nrow(List_Codes_ToDo)
      
      Nb_TODO  = min(Nb_Min, FileRow)
      Nb_Total = FileRow
      
      FileToSave = paste0(FileName, '.rds')
      Total_Time  = 0
      
      for (i in 1:Nb_TODO)
      {
        # i =1
        Start.Time = Sys.time()
        pCode    = FileData[i]$people_url
        CATln("")
        # CATln_Border(paste(i, '/', Nb_TODO, ' = ', pCode))
        CATln_Border(paste('DOWNLOAD_STKVN_BOARD_LONG_BY_SOURCE : ', pSource,  '=', i, paste0('(', Nb_Group,')'), '/', Nb_TODO, '/', Nb_Total, ' = ', pCode))
        Sys.sleep(1)
        My_Data = data.table()
        
        My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_PEOPLE_INFO (pURL = pCode))) 
        
        
        if (all(class(My_Data)!='try-error'))
        {
          Data_List[[i]] = My_Data
        }
        Sys.sleep(2)
        
        if (i %% Nb_Group ==0 | i == Nb_TODO)
        {
          # DATE
          Data_All = rbindlist(Data_List, fill=T)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := pDate]}
          if (! 'code' %in% names (Data_All)) { Data_All [, code :=  FileData[i]$code]}
          Data_final = rbind(Data_old, Data_All, fill=T)
          
          # CCPR_SAVERDS(Data_final,pFolder, FileToSave, ToSummary = T, SaveOneDrive = T)
          saveRDS( Data_final ,  paste0(pFolder, FileToSave))
          CATln_Border(paste ('SAVED: ', paste0(pFolder, FileToSave)) )
          
          # DAY :
          FileAll = paste0(gsub(paste0('_',gsub('-','', pDate) ),'',FileName ),'_DAY', '.rds')
          
          if ( file.exists(paste0(pFolder, '', FileAll))) {
            # data_old1 = CCPR_READRDS(FileFolder = paste0(pFolder, ''), FileName = FileAll, ToKable = F, ToPrompt = F, ToRestore = T)
            data_old1 = try( readRDS(paste0(pFolder, FileAll )) )
          } else { data_old1 = data.table()}
          data_all_final = unique(rbind( Data_final,data_old1, fill = T), by = c('code', 'date'))
          # CCPR_SAVERDS(data_all_final,pFolder,FileAll , ToSummary = T, SaveOneDrive = T)
          saveRDS (data_all_final, paste0(pFolder,FileAll))
          CATln_Border(paste ('SAVED: ', paste0(pFolder, FileAll)) )
          # HISTORY:
          FileNameHistory = paste0(gsub('DAY','HISTORY' , FileAll) )
          if ( file.exists(paste0(pFolder,FileNameHistory))) {
            # data_old1 = CCPR_READRDS(FileFolder = pFolder, FileName = FileNameHistory, ToKable = F, ToPrompt = F, ToRestore = T)
            data_old1 = try( readRDS(paste0(pFolder, FileNameHistory )) )
          } else { data_old1 = data.table()}
          data_all_final_history = unique(rbind( Data_final,data_old1, fill = T), by = c('code', 'date'))
          
          # CCPR_SAVERDS(data_all_final_history,pFolder,FileNameHistory , ToSummary = T, SaveOneDrive = T)
          saveRDS (data_all_final, paste0(pFolder,FileNameHistory))
          CATln(paste('SAVED : ',pFolder, FileNameHistory, '-', Format.Number(nrow(Data_final),0),'records'))
          Sys.sleep(2)
        }
        
        End.Time = Sys.time()
        Total_Time = as.numeric(difftime(End.Time, Start.Time, units = 'secs')) + Total_Time
        Avg_Time = Total_Time / i
        End_Forecast = Avg_Time * (Nb_TODO - i)
        Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
        CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      }
      
      return(Data_final)
    } else {
      CATln_Border('DATA FULLY UPDATED')
      Sys.sleep(2)
    }
  }
  
  
} 



# ==================================================================================================
TRAINEE_SYNCHRONISE_FILE_FROM_TO = function(From_Folder=UData, From_File='efrc_ins_ref.rds',
                                            To_Folder=SData, To_File='efrc_ins_ref.rds',
                                            Method='OVERWRITE', ToForce=F, CheckCode=F)  {
  # ------------------------------------------------------------------------------------------------
  # paste()
  CATln_Border(paste('SYNCHRONISE_FILE_FROM_TO : ', From_Folder, From_File))
  From_Fullname = paste0(From_Folder, From_File)
  To_Fullname = paste0(To_Folder, To_File)
  if (file.exists(From_Fullname))
  {
    file.info(From_Fullname)
    From_time = file.info(From_Fullname)$mtime
    if (file.exists(To_Fullname))
    {
      To_time = file.info(To_Fullname)$mtime
      if (ToForce || From_time > To_time)
      {
        CATrp('Loading file ...')
        MyFile = readRDS(From_Fullname)
        CATln('Loaded.')
        
        CATln_Border(paste(From_Fullname, '>', To_Fullname))
        CATrp('Saving file ...')
        saveRDS(MyFile, To_Fullname)
        CATln('Saved')
        if (CheckCode) { xs = WRITE_SUMMARY_FULLPATH(To_Fullname) }
        
        CATln_Border(paste("FILE UPDATED = ", To_Fullname))
        
      } else {
        CATln_Border(paste("FILE ALREADY UPDATED = ", To_Fullname))
      }
    } else {
      CATln_Border(paste("NO FILE = ", To_Fullname))
      CATrp('Loading file ...')
      MyFile = readRDS(From_Fullname)
      CATln('Loaded.')
      
      CATln_Border(paste(From_Fullname, '>', To_Fullname))
      CATrp('Saving file ...')
      CCPR_SAVERDS(MyFile, To_Folder, To_File, ToSummary = T, SaveOneDrive = T)
      CATln('Saved')
      # if (CheckCode) { xs = WRITE_SUMMARY_FULLPATH(To_Fullname) }
      CATln_Border(paste("FILE UPDATED = ", To_Fullname))
    }
  }
}


# ==================================================================================================
TRAINEE_MERGE_IND_WCEO = function (Folder = "S:/WCEO_INDEXES/", ToFolder = '', ToFile = '', ToSave = F) {
  # ------------------------------------------------------------------------------------------------
  
  subfolders            = list.dirs(Folder, recursive = FALSE)
  subfolder_names       = basename(subfolders)
  subfolder_names_list  = as.list(subfolder_names)
  
  merged_data_list = list() 
  
  for (Country in subfolder_names_list) {
    # Country = 'AUS'
    File_Folder = paste0("S:/WCEO_INDEXES/", Country, "/")
    File_Name   = paste0("ifrc_ccpr_indwceo",tolower(Country),"_history.rds")
    CATln_Border( paste0(File_Folder, File_Name))
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    if (nrow(File_Data) > 0)
    {
      File_Data$country     = Country
      merged_data_list[[Country]] = File_Data 
    }
    
  }
  merged_data = rbindlist(merged_data_list, fill = TRUE)  
  rm(merged_data_list, data)
  gc()
  if (ToSave) {
    CCPR_SAVERDS(merged_data, ToFolder, ToFile, ToSummary = T, SaveOneDrive = T)
  }
  
  
}

# ==================================================================================================
DASHBOARD_WOMENCEO_INTERNATIONAL_STATS = function(File_Folder = 'S:/WCEO_INDEXES/', File_Indexes = 'ifrc_ccpr_indwceoall_history.rds',
                                                  MaxDate = '2024-02-28',
                                                  ToFolder = 'S:/WCEO_INDEXES/', ToFile = '', ToSave = F, ToUpload = F)  {
  # ------------------------------------------------------------------------------------------------
  x = CCPR_READRDS(File_Folder, File_Indexes)
  x[, name:=gsub('HONG KONG', 'HONG-KONG', name)]
  colnames(x)
  # cleanse raw data
  x = unique(x, by = c('code', 'date'))
  
  # STEP 2: RE-CALCULATE DATA
  Ind_History = x  [date <= MaxDate]  
  Ind_History[, close_adj:=close]
  str(Ind_History)
  
  Ind_History = Ind_History[order(code, date)] 
  Ind_History[, ':='(change=close_adj-shift(close_adj), varpc=100*(close_adj/shift(close_adj)-1)), by='code']
  Ind_History[,":="(yyyy=year(date),yyyymm=year(date)*100+month(date),yyyyqn=year(date)*100+floor((month(date)-1)/3)+1),]
  Ind_Month = unique(Ind_History[order(code, -date)], by=c('code', 'yyyymm'))[order(code, date)]
  Ind_Month[, rtm:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Year  = unique(Ind_History[order(code, -date)], by=c('code', 'yyyy'))[order(code, date)]
  Ind_Year[, rty:=(close_adj/shift(close_adj))-1, by='code']
  
  Ind_Quarter = unique(Ind_History[order(code, -date)], by=c('code', 'yyyyqn'))[order(code, date)]
  Ind_Quarter[, rtq:=(close_adj/shift(close_adj))-1, by='code']
  
  # Ind_Quarter = unique(Ind_History[order(code, -date)][, yyyymm:=100*year(date)+month(date)], by=c('code', 'yyyymm'))[order(code, date)]
  # Ind_Quarter[, rtm:=(close/shift(close))-1, by='code']
  
  Ind_Overview = unique(Ind_History[order(code, -date)], by=c('code'))[, .(code, name, date, last=close_adj, change, varpc)]
  Ind_Overview = merge(Ind_Overview, Ind_Month[, .(code, date, mtd=round(100*rtm,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Year[, .(code, date, ytd=round(100*rty,12))], all.x = T, by=c('code', 'date'))
  Ind_Overview = merge(Ind_Overview, Ind_Quarter[, .(code, date, qtd=round(100*rtq,12))], all.x = T, by=c('code', 'date'))
  My.Kable(Ind_Overview)
  
  Ind_Month6M = Ind_Month[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtm, nr)]
  My.Kable(setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)])
  Res_Month = setDT(spread(Ind_Month6M[, .(code, nr = paste0('M',nr), rtm=round(100*rtm,12))], key='nr', value='rtm'))[order(-M1)]
  
  Ind_Year6Y = Ind_Year[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rty, nr)]
  Res_Year   = setDT(spread(Ind_Year6Y[, .(code, nr = paste0('Y',nr), rty=round(100*rty,12))], key='nr', value='rty'))[order(-Y1)]
  My.Kable(Res_Year)
  
  Ind_Quarter6Y = Ind_Quarter[order(code, -date)][, nr:=seq.int(1, .N), by='code'][nr<=6][, .(code, date, rtq, nr)]
  Res_Quarter   = setDT(spread(Ind_Quarter6Y[, .(code, nr = paste0('Q',nr), rtq=round(100*rtq,12))], key='nr', value='rtq'))[order(-Q1)]
  My.Kable(Res_Quarter)
  
  
  Ind_All = merge(Ind_Overview,Res_Month, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Year, all.x = T, by = 'code' )
  Ind_All = merge(Ind_All,Res_Quarter, all.x = T, by = 'code' )
  library(stringi)
  Ind_All[, cur:=word(word(name,2,2,'\\('),1,1,'\\)')]
  Ind_All[, version:=stri_reverse(word(stri_reverse(trimws(word(name,1,1,'\\('))),1,1,' '))]
  Ind_All[, wgtg:=stri_reverse(word(stri_reverse(trimws(word(name,1,1,'\\('))),2,2,' '))]
  Ind_All[, country:=stri_reverse(word(stri_reverse(trimws(word(name,1,1,'\\('))),3,3,' '))]
  # Ind_All[, rev_tmp:=stringi::stri_reverse(cur)]
  # Ind_All[, wgtg:=strsplit(rev(tmp), pattern = "\\s+")[1]]
  
  My.Kable.All(Ind_All[, .(country, name, cur, version, wgtg, date, last, Y1, Y2, Y3, Y4, Y5, Y6)])
  My.Kable.All(Ind_All[, .(country, name, cur, version, wgtg, date, last, M1, M2, M3, M4, M5, M6)])
  My.Kable.All(Ind_All[, .(country, name, cur, version, wgtg, date, last, Q1, Q2, Q3, Q4, Q5, Q6)])
  End.time = Sys.time()
  return (Ind_All)
  
}

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_PEOPLE_INFO = function(pURL = 'https://s.cafef.vn/ceo/CEO_55604/tran-thi-binh.chn?cs=A32') {
  # ------------------------------------------------------------------------------------------------
  # pURL = 'https://s.cafef.vn/ceo/CEO_875579/le-van-hoa.chn?cs=AAT'
  CATln_Border(pURL)
  File_Temp  = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '', Sys.time())), '.txt')
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('C:/temp/',File_Temp), ToDeleteTemp = T)
  
  birth_date = as.Date(NA)
  birth_year = as.numeric(NA)
  birth_info = as.character(NA)
  
  if (grepl('Sinh năm <span>:</span>', xweb))
  {
    x.Birth = trimws(str.extract(trimws(gsub('\n','', str.extract(xweb, 'Sinh năm <span>:</span>', '</td>'))), '<span>', '</span>'))
    birth_info = x.Birth
    if (nchar(x.Birth)==10) {
      birth_date = as.Date(x.Birth,'%d/%m/%Y')
      birth_year = as.numeric(year(birth_date))
    } else {
      birth_year = as.numeric(x.Birth)
      birth_date = as.Date(NA)
    }
  }
  
  x.Education = as.character(NA)
  if (grepl('Trình độ <span>:</span>', xweb))
  {
    x.Education = trimws(gsub('<br>','', str.extract(trimws(gsub('\n','', str.extract(xweb, 'Trình độ <span>:</span>', '</td>'))), '<span>', '</span>')))
  }
  
  birth_location = as.character(NA)
  if (grepl('Nơi sinh <span>:</span>', xweb))
  {
    birth_location = trimws(gsub('<br>','', str.extract(trimws(gsub('\n','', str.extract(xweb, 'Nơi sinh <span>:</span>', '</td>'))), '<span>', '</span>')))
  }
  
  position_title   = as.character(NA)
  position_company = as.character(NA)
  position_date    = as.character(NA)
  Sys.sleep(2)
  
  if (grepl('class="ceo_title2">CHỨC VỤ HIỆN TẠI</h2>', xweb))
  {
    x.Position = trimws(gsub('\n','', str.extract(xweb, 'class="ceo_title2">CHỨC VỤ HIỆN TẠI</h2>', '</tbody></table>')))
    xRows      = unlist(strsplit(x.Position, '<tr>'))
    
    if (length(xRows)==2)
    {
      xRow  = xRows[[2]]
      xBlk  = unlist(strsplit(xRow, '<tr'))
      Found = F; iFound = 0
      for (ib in 1:length(xBlk))
      {
        # ib = 1
        if (grepl('Tổng Giám đốc', xBlk[[ib]], ignore.case = T))
        {
          Found  = T
          iFound = ib
        }
      }
      
      if (!Found)
      {
        for (ib in 1:length(xBlk))
        {
          if (grepl('Giám đốc Điều hành', xBlk[[ib]], ignore.case = T))
          {
            Found  = T
            iFound = ib
          }
        }
        ceo = NA
      }
      
      if (Found)
      {
        xRow_Found = xBlk[[iFound]]
        xCols = unlist(strsplit(xRow_Found, '<td>'))
        if (length(xCols)==4)
        {
          position_title   = trimws(gsub('</td>','', xCols[[2]]))
          position_company = word(gsub('"','', trimws(str.extract( xCols[[3]], 'title=','</a>'))),2,2,'>')
          position_date    = trimws(gsub('</tr>|</td>','', xCols[[4]]))
          ceo = 1
        }
      }
    }
  }
  
  
  Final_Data = data.table(people_url=pURL, source='CAF', birth_date=birth_date, birth_year=birth_year, birth_location=birth_location, 
                          education=x.Education, position_title = position_title, position_date = position_date, birth_info = birth_info,
                          position_company = position_company,ceo, updated=substr(Sys.time(),1,19))
  My.Kable.All(Final_Data[, -c('position_company', 'updated')])
  
  return(Final_Data)
}

# ==================================================================================================
TRAINEE_MERGE_STKVN_BOARD_DAY_old = function (  Fr_Folder =  paste0('S:/STKVN/BOARD/DAY/') ,
                                                pFolder =  paste0(SData, 'IFRC_CCPR/'),
                                                LIST_SOURCES = list( 'VND', 'CAF', 'VST'),
                                                pPrefix = 'ccpr',  
                                                CheckDate = '2024-03-29' ,
                                                ToIntegrateHistory = F) {
  # ------------------------------------------------------------------------------------------------
  
  # MERGE CEO 
  LastTrading = CCPR_LAST_TRADING_DAY_VN(09, ToPrompt = T)
  # LIST_SOURCES = list( 'VND', 'CAF', 'VST')
  DATA_MERGE = data.table()
  pData = list ()
  for (k in 1:length(LIST_SOURCES))
  {
    # k =3
    pSource     = LIST_SOURCES[[k]]
    File_Folder = Fr_Folder
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_',gsub('-','',CheckDate),'.rds')
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    
    if ( nrow (File_Data) > 0) 
    {
      if ( (nrow(File_Data [!is.na(code)])>0) &  all (c ('code', 'ceo', 'source') %in% names(File_Data) ) )
      {
        switch (pSource,
                'VND' = {
                  xData = File_Data[, .(code, date, source,gender, value=as.character(people_name))] 
                } ,
                'CAF' = {
                  xData = File_Data[, .(code, date, source,gender, value=as.character(people_name))] 
                },
                'VST' = {
                  xData = File_Data[, .(code, date, source,gender, value=as.character(fullname_lc))] 
                }
        )
        
        pData [[k]] = xData
        My.Kable( pData [[k]] )
        Sys.sleep(2)
      }
    }
    
  }
  DATA_MERGE = rbindlist(pData, fill=T)
  DATA_MERGE [, source := as.character (source)]
  
  My.Kable(DATA_MERGE[order(-date, code)])
  
  
  DATA_ALL = unique(DATA_MERGE, by=c('date', 'source', 'code'))[,  .(date, code, source, value)][!is.na(code) & !is.na(value)]
  unique(DATA_ALL, by = 'source')
  MaxDate   = max(DATA_ALL [!is.na(date)]$date)
  DATA_ALL  = DATA_ALL[date==MaxDate]
  xCOUNT = DATA_ALL[!is.na(value)][, .(n=.N), by=c('code', 'date', "value")][!is.na(value)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_ALL = unique (DATA_ALL, by = c('code','source','value'))
  DATA_SPD = setDT(tidyr::spread(DATA_ALL, key="source", value="value"))[!is.na(code)]
  My.Kable.TB(DATA_SPD[order(date, code)])
  xCOUNT_N2 = xCOUNT[n>=2]
  xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
  DATA_SPD = merge(DATA_SPD[, -c('final')], xCOUNT_N2[, .(code, date, final=value)], all.x=T, by=c('code', 'date'))
  
  DATA_SPD [, ':='(people_name = final, dataset='CEO')]
  
  
  # MERGE GENDER --------------------------------------------
  
  CEO_LIST = DATA_SPD [,.(code, people_name = final)]
  CEO_LIST [, name_clean := decodeVN(people_name, from='Unicode', to='Unicode', diacritics=F)]
  DATA_MERGE = CEO_LIST
  File_Data = setDT (read.xlsx('S:/R/DATA/BOARD/LIST/name_with_gender.xlsx'))
  xData = File_Data [,. (name_clean = pname, gender )]
  DATA_MERGE = unique ( merge (DATA_MERGE,xData , all.x = T, by = 'name_clean'), by = 'name_clean' ) [, source := 'EXCEL']
  
  LIST_SOURCES = list( 'VND', 'CAF', 'VST')
  Data = list()
  for (i in 1:length(LIST_SOURCES))
  {
    # i = 1
    pSource     = LIST_SOURCES[[i]]
    File_Folder = Fr_Folder
    
    File_Name = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_DAY.rds')
    CATln_Border(File_Name)
    File_Data   = CHECK_CLASS(try(CCPR_READRDS(File_Folder, File_Name, ToKable = T)))
    File_Data [, gender := trimws(gender)]
    File_Data [gender == 'FEMALE', gender := 'F']
    File_Data [gender == 'MALE', gender := 'M']
    File_Data = File_Data [nchar (code) == 8]
    
    if ( nrow (File_Data) > 0) 
    {
      switch (pSource,
              'VND' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name] [,.( code,source, people_name,  gender)] 
              } ,
              'CAF' = {
                xData = File_Data [people_name %in% CEO_LIST$people_name] [,.(code, source, people_name,  gender)] 
              },
              'VST' = {
                xData = File_Data [fullname_lc %in% CEO_LIST$people_name] [,.(code,source, people_name = fullname_lc,  gender)] 
              }
      )
      Data [[i]] = xData
    }
    
  }
  
  DATA_ALL = rbindlist (Data, fill = T)
  DATA_MERGE = rbind (DATA_MERGE[!is.na(people_name)] [,.(people_name, code, gender, source)], DATA_ALL, fill =T)
  DATA_MERGE = DATA_MERGE[!is.na(people_name)]
  xCOUNT = DATA_MERGE[!is.na(people_name)][, .(n=.N), by=c('code', 'gender')][!is.na(gender)]
  My.Kable(xCOUNT[order(-n)], Nb=15)
  DATA_MERGE = unique( DATA_MERGE[!is.na(gender)] , by = c('code', 'source' , 'people_name') )
  DATA_SPDg = setDT(tidyr::spread(DATA_MERGE, key="source", value="gender"))[!is.na(code)]
  My.Kable.TB(DATA_SPDg[order(people_name, code)])
  xCOUNT_N2 = xCOUNT[n>=2]
  xCOUNT_N2 = unique(xCOUNT_N2 [order(-n)], by = 'code')
  DATA_GDR = merge(DATA_SPDg, xCOUNT_N2[, .(code, final = gender)], all.x=T, by=c('code'))
  # -----------------------------------
  
  DATA_SPD = merge (DATA_SPD [,.(code,date,people_name, dataset)], DATA_GDR [,. (people_name, gender = final)], all.x = T, by = 'people_name')
  DATA_SPD [!is.na(people_name)]
  
  market   = readRDS ('S:/STKVN/BOARD/DAY/ccpr_download_all_stkvn_market_day.rds')
  DATA_SPD = merge (DATA_SPD, market [,.(code, market = final)], all.x = T, by ='code')
  DATA_SPD = unique (DATA_SPD , by = c ('code', 'people_name'))
  DATA_SPD = MERGE_DATASTD_BYCODE(DATA_SPD, pOption='FINAL')
  
  My.Kable.TB ( DATA_SPD[order(date, code)])
  My.Kable.TB ( DATA_SPD[order(date, code)][is.na(people_name)])
  
  FileBoard = paste0 (  pPrefix, "_stkvn_board_", gsub('-','',CheckDate),".rds")
  FileWCEO  = paste0 (  pPrefix, "_stkvn_wceo_", gsub('-','',CheckDate),".rds")
  
  saveRDS  (DATA_SPD, paste0 (  pFolder,FileBoard  ) )
  CATln_Border( paste ('SAVED: ',paste0 (  pFolder,FileBoard  ) ) )
  
  DATA_WCEO = DATA_SPD [gender == 'F' & market != 'UPC'] 
  if (nrow (DATA_WCEO >0))
  {
    My.Kable (DATA_WCEO)
    saveRDS  (DATA_WCEO ,paste0 (  pFolder, FileWCEO ) )
    CATln_Border( paste ('SAVED: ',paste0 (  pFolder, FileWCEO )  ) )
  }
  
  if (ToIntegrateHistory) 
  {
    if (nrow (DATA_SPD) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileBoard, ToKable = T, ToRestore = T)
      Data_All = unique(rbind(Data_Old, DATA_SPD, fill=T), by=c('code', 'date'))
      Data_All = MERGE_DATASTD_BYCODE(Data_All, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_All[order(date, code)][, .( code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_All, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileBoard),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
    if (nrow (DATA_WCEO) >0)
    {
      Data_Old = CCPR_READRDS(pFolder, FileWCEO, ToKable = T, ToRestore = T)
      Data_WCEO = unique(rbind(Data_Old, DATA_WCEO, fill=T), by=c('code', 'date'))
      Data_WCEO = MERGE_DATASTD_BYCODE(Data_WCEO, pOption = 'FINAL')[!is.na(people_name) & !is.na(gender)]
      My.Kable(Data_WCEO[order(date, code)][, .( code, date, name, market, people_name, gender)])
      CCPR_SAVERDS(Data_WCEO, pFolder, paste0( gsub ( paste0( '_',gsub('-','', LastTrading),'.rds'),'', FileWCEO),'_history.rds'), ToSummary = T, SaveOneDrive = T)
    }
  }
  return (DATA_SPD)
}

# ==================================================================================================
TRAINEE_MERGE_FILE <- function(type = 'BOARD') {
  # ------------------------------------------------------------------------------------------------
  
  #type = 'DIVIDEND'
  
  type             = tolower(type)
  
  file_name        = paste0(paste0("download_all_", type), ".rds")
  output_file_path = paste0("S:/R/DATA/BOARD/", file_name)
  My_Files         = as.data.table(list.files('S:/R/DATA/BOARD/RAW/', '*.rds$'))
  My_Files         = My_Files[V1 != file_name]
  My_Files[, V1 := tolower(V1)]
  
  My_Files = My_Files[grepl(type, V1)]
  My_Files[, country := toupper(sub(paste0(paste0("download_(.*?)_yah_", type), "_raw.rds"), "\\1", V1))]
  
  merged_data_list = list()  
  Save_Folder = 'S:/R/DATA/BOARD/RAW/'
  
  for (k in 1:nrow(My_Files)) 
  {
    #k = 1
    file_path = My_Files[k]$V1
    data      = CHECK_CLASS(try(CCPR_READRDS(Save_Folder, file_path, ToKable = T)))
    if (nrow(data) > 0)
    {
      data$market           = rep(My_Files[k]$country, nrow(data))
      merged_data_list[[k]] = data  
    }
    
  }
  
  merged_data = rbindlist(merged_data_list, fill = TRUE)  
  rm(merged_data_list, data)
  gc()
  saveRDS(merged_data, output_file_path)
}


# ==================================================================================================
TRAINEE_CLEAN_ALL_BOARD = function (){
  # ------------------------------------------------------------------------------------------------
  
  BOARD_DATA = CCPR_READRDS('S:/R/DATA/BOARD/', 'download_all_board.rds')
  My.Kable(BOARD_DATA[, .(codesource, name, first_name, last_name, ceo, cob, title)])
  
  BOARD_DATA = BOARD_DATA[!is.na(name)]
  BOARD_DATA[grepl('[.]', name), tg:=word(name,1,1,'[.]')]
  BOARD_DATA[grepl('[.]', codesource), ext:=word(codesource ,2,2,'[.]')]
  #print(sort(unique(BOARD_DATA[nchar(tg)<5]$tg)))
  
  x = BOARD_DATA[1]$name
  trimws(word(x,2,2,'Dr.'))
  x = BOARD_DATA[1]$codesource
  trimws(word(x,2,2,'[.]'))
  
  BOARD_DATA[grepl('Mr.', name), fullname:=trimws(word(name,2,2,'Mr.'))]
  BOARD_DATA[grepl('Ms.', name), fullname:=trimws(word(name,2,2,'Ms.'))]
  BOARD_DATA[grepl('Mrs.', name), fullname:=trimws(word(name,2,2,'Mrs.'))]
  BOARD_DATA[grepl('Dr.', name), fullname:=trimws(word(name,2,2,'Dr.'))]
  BOARD_DATA[grepl('Prof.', name), fullname:=trimws(word(name,2,2,'Prof.'))]
  
  x = BOARD_DATA[1]$fullname
  trimws(word(x,2,2,'Dr.'))
  
  BOARD_DATA[grepl('B.Sc', name), fullname:=trimws(word(fullname,1,1,'B.Sc'))]
  BOARD_DATA[grepl('B.Tech', name), fullname:=trimws(word(fullname,1,1,'B.Tech'))]
  BOARD_DATA[grepl('B.Com', name), fullname:=trimws(word(fullname,1,1,'B.Com'))]
  BOARD_DATA[grepl('B.Bus', name), fullname:=trimws(word(fullname,1,1,'B.Bus'))]
  BOARD_DATA[grepl('B.Pharm', name), fullname:=trimws(word(fullname,1,1,'B.Pharm'))]
  BOARD_DATA[grepl('B.B.A', name), fullname:=trimws(word(fullname,1,1,'B.B.A'))]
  BOARD_DATA[grepl('FAusI', name), fullname:=trimws(word(fullname,1,1,'FAusI'))]
  BOARD_DATA[grepl('BEc', name), fullname:=trimws(word(fullname,1,1,'BEc'))]
  BOARD_DATA[grepl('B.A.', name), fullname:=trimws(word(fullname,1,1,'B.A.'))]
  BOARD_DATA[grepl('M.A.I.C.D', name), fullname:=trimws(word(fullname,1,1,'M.A.I.C.D'))]
  BOARD_DATA[grepl('[(]', name), fullname:=trimws(word(fullname,1,1,'\\('))]
  
  LETTERS
  for (l in LETTERS)
  {
    xL = paste0('B',l)
    BOARD_DATA[grepl(xL, name), fullname:=trimws(word(fullname,1,1,xL))]
  }
  
  BOARD_DATA$nbw <- str_split(BOARD_DATA$fullname, "\\s+") %>% lapply(length)
  BOARD_DATA[, nbw:=as.integer(nbw)]
  BOARD_DATA <- BOARD_DATA %>% mutate(firstw = str_extract(fullname, "^[A-z]+(?= )"))
  BOARD_DATA <- BOARD_DATA %>% mutate(secw = str_sub(fullname, str_locate(fullname, "\\s") + 1))
  BOARD_DATA[, lastw := word(fullname, nbw, nbw, ' ')]
  
  
  # BOARD_DATA$lastw <- str_split_fixed(data$fullname, " ", n = 1)[, 2]
  
  BOARD_DATA$first_name = as.character(NA)
  BOARD_DATA$last_name = as.character(NA)
  BOARD_DATA[!is.na(last_name), last_name:=toupper(last_name)]
  
  BOARD_DATA$n_gender = as.character(NA)
  
  BOARD_DATA[grepl('Mr.', name), n_gender:='MALE']
  BOARD_DATA[grepl('Ms.', name), n_gender:='FEMALE']
  return(BOARD_DATA)
}

# ==================================================================================================
TRAINEE_REPORT_GLOBAL_WCEO = function (){
  # ------------------------------------------------------------------------------------------------
  
  BOARD_DATA = CLEAN_ALL_BOARD()
  stat = BOARD_DATA[,.(
    nb_records = .N,                    
    start = min(date),                  
    end = max(date),                    
    nb_company = n_distinct(codesource),
    nb_people = sum(!is.na(gender)),    
    nb_ceo = sum(ceo, na.rm = TRUE),    
    nb_cob = sum(cob, na.rm = TRUE),    
    nb_wceo = sum(ifelse(ceo == 1 & gender == "FEMALE", 1, 0), na.rm = TRUE), 
    nb_mceo = sum(ifelse(ceo == 1 & gender == "MALE", 1, 0), na.rm = TRUE), 
    nb_wcob = sum(ifelse(cob == 1 & gender == "FEMALE", 1, 0), na.rm = TRUE),
    nb_mcob = sum(ifelse(cob == 1 & gender == "MALE", 1, 0), na.rm = TRUE),
    updated = substr(Sys.time(), 1, 19) 
  ), by = market]
  
  stat[, percentage_wceo := as.numeric(round(100 * nb_wceo / (nb_wceo + nb_mceo), 2), nsmall = 2)]
  stat[, percentage_wcob := as.numeric(round(100 * nb_wcob / (nb_wceo + nb_mcob), 2), nsmall = 2)]
  stat = stat[order(-percentage_wceo)]
  
  numeric_cols = names(stat)[sapply(stat, is.numeric)]
  totals       = lapply(stat[,..numeric_cols], sum)
  total_row    = as.data.table(totals)[, market := "Total"]
  stat         = rbind(stat, total_row, fill = T)
  
  country = read.xlsx("S:/R/DATA/BOARD/stat_board.xlsx")
  stat = merge(stat, country, by = "market", all.x = T)
  efrc_country_ref = readRDS("S:/R/DATA/efrc_country_ref.rds")
  match_data = merge(stat, efrc_country_ref[,. (country = name.ifrc, continent, developed_level,iso3)], by = "iso3", all.x = T)
  
  china = match_data[country == "CHINA"]
  numeric_cols <- names(china)[sapply(china, is.numeric)]
  totals_china <- lapply(china[,..numeric_cols], sum)
  total_row <- as.data.table(totals_china)[, market := "CHINA"]
  total_row[,  percentage_wceo := as.numeric(round(100 * nb_wceo / (nb_wceo + nb_mceo), 2), nsmall = 2)]
  total_row[,  percentage_wcob := as.numeric(round(100 * nb_wcob / (nb_wceo + nb_mcob), 2), nsmall = 2)]
  
  unique_stat = rbind(match_data[country != "CHINA"], total_row[, ":="(country = "CHINA", iso3 = "CHN", continent = "ASIA")], fill = T)
  
  My.Kable.All(match_data[continent == "ASIA"][order(percentage_wceo)][, -c("start", "end", "updated")])
  
  
  
}

# ==================================================================================================
TRAINEE_INTEGRATION_FILE = function (Folder_Fr = paste0(SData, 'DAY/'), File_Fr =  tolower ('ifrc_ccpr_all_stkvn_final_open_day.rds' ), 
                                     Folder_To = 'S:/SHINY/REPORTS/',      File_To =  'stkvn_open_market.rds') {
  # ------------------------------------------------------------------------------------------------
  
  data = try ( readRDS (paste0(Folder_Fr,File_Fr)) )
  if (nrow (data) >0) {
    My.Kable.TB(data)
    saveRDS (data, paste0(Folder_To, File_To))
  } 
}

# ==================================================================================================
TRAINEE_MST_DOWNLOAD_SHORT = function(code_sector = '4659', ToDownload=T)   {
  # ------------------------------------------------------------------------------------------------
  # code_sector = '50221'
  # code_sector = ''
  MST_LIST = readRDS(paste0('S:/MST/', 'mst_list_sectors.rds'))
  # str(MST_LIST)
  MST_LIST[, code:=as.character(code)]
  MST_LIST[, date:=as.Date(Sys.Date())]
  # str(MST_LIST)
  
  CCPR_SAVERDS(MST_LIST, 'S:/MST/', 'mst_list_sectors.rds', SaveOneDrive = T)
  
  MST_LIST = CCPR_READRDS('S:/MST/', 'mst_list_sectors.rds', ToKable = T)
  
  File_Name = 'mst_list_sectors_updated.rds'
  File_full = paste0('S:/MST/', File_Name)
  
  if (!file.exists(File_full))
  {
    MST_LIST[, updated:=as.character(NA)]
  } else {
    MST_LIST = CCPR_READRDS('S:/MST/', File_Name, ToKable = T)
  }
  CCPR_SAVERDS(MST_LIST, 'S:/MST/', File_Name, SaveOneDrive = T)
  
  MST_LIST[, random:=runif(.N,0,1)]
  MST_LIST = MST_LIST[order(random)]
  My.Kable(MST_LIST)
  
  TODO_LIST = MST_LIST[is.na(updated)][order(random)]
  My.Kable(TODO_LIST)
  
  if (ToDownload)
  {
    # My_Choice = '3220'
    if (nchar(code_sector)==0)
    {
      code_sector = TODO_LIST[1]$code
    }
    My_Choice = code_sector
    CATln_Border(My_Choice)
    
    TODO_CODE = TODO_LIST[code==My_Choice]
    My.Kable.All(TODO_CODE)
    
    if (nrow(TODO_CODE)==1)
    {
      link = TODO_CODE$link
      xRES <- data.table() 
      ok = TRUE
      k = 0
      xList = list()
      
      while (ok) 
      {
        k = 1 + k
        #k = 1
        File_Temp = paste0(code_sector,'_', format(Sys.time(), "%Y%m%d_%H%M%S"), '.txt')
        #pURL      = paste0('https://masothue.com/tra-cuu-ma-so-thue-theo-nganh-nghe/', search, '?page=', k)
        pURL      = paste0(link, '?page=', k)
        
        xweb      = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/', File_Temp), ToDeleteTemp = T)
        
        xROWS     = unlist(strsplit(xweb, '<div data-prefetch='))
        length(xROWS)
        
        if (length(xROWS) > 1)
        {
          #xRES <- data.table()  
          
          for (i in 2:length(xROWS)) {
            # i = 3
            xROW <- xROWS[[i]]
            
            if (grepl('\\<i class="fa fa-hashtag"></i> Mã số thuế: <a href="', xROW)) {
              xCode = word(str.extract(xROW, '<i class="fa fa-hashtag"></i> Mã số thuế: <a href="', '</a><br>'),2,2,'>')
            } else {
              xCode = as.character(NA)
            }
            #CATln(xCode)
            
            if (grepl('\\<address>', xROW)) {
              xAddress = word(str.extract(xROW, '<address>', '</address>'),2,2,'/i>')
            } else {
              xAddress = as.character(NA)
            }
            #CATln(xAddress)
            
            if (grepl('\\<em><a href="', xROW)) {
              xDelegate = word(str.extract(xROW, '<em><a href="', '</a>'),2,2,'>')
            } else {
              xDelegate = as.character(NA)
            }
            #CATln(xDelegate)
            
            if (grepl('\\<h3><a href=', xROW)) {
              xCompany = word(str.extract(xROW, '<h3><a href=', '</a></h3>'),2,2,'">')
            } else {
              xCompany = as.character(NA)
            }
            #CATln(xCompany)
            
            xRES <- rbind(xRES, data.table(code = xCode, company = xCompany, delegate = xDelegate, address = xAddress,
                                           updated = Sys.Date() ), fill = TRUE)
          }
          if (nrow(xRES) > 0 & k < 10){
            # My.Kable(xRES)
            xList[[k]]= xRES
            CATln(paste(nrow(xRES), 'RECORDS'))
          } else{
            ok = F
          }
          #My.Kable.All(xRES)
          #xList[[k]]= xRES 
        } else{
          ok = F
        }
      }
      
      xALL = rbindlist(xList, fill=T)
      if (nrow(xALL)>0)
      {
        
        xALL[, code_sector:=code_sector]
        CATln('')
        CATln_Border('FINALLY')
        My.Kable(xALL)
        Save_Folder = 'S:/MST/SECTORS/'
        Save_File   = paste0('MST_', code_sector, ".rds")
        CATln_Border(paste(Save_Folder, Save_File))
        
        CCPR_SAVERDS(xALL, Save_Folder, Save_File, SaveOneDrive = F)
        
        Save_Folder = 'S:/MST/SECTORS/DAY/'
        Save_File   = paste0('MST_', code_sector, "_", gsub('-','', Sys.Date()), ".rds")
        CATln_Border(paste(Save_Folder, Save_File))
        
        CCPR_SAVERDS(xALL, Save_Folder, Save_File, SaveOneDrive = F)
        
        MST_LIST[code == code_sector, updated:=as.character(Sys.Date())]
        CCPR_SAVERDS(MST_LIST, 'S:/MST/', File_Name, SaveOneDrive = F)
        
      }
    }
  }
}

# ==================================================================================================
SYSDATETIME = function(l.hour, WeekDateTime=T) {
  # ------------------------------------------------------------------------------------------------
  # print(SYSDATETIME(15))
  # l.hour = 16
  if (hour(Sys.time())>=l.hour) {l.res=Sys.Date()} else {l.res = Sys.Date()-1}
  if (WeekDateTime)
  {
    while ( weekdays(l.res) %in% c("Saturday", "Sunday")) {
      l.res = l.res - 1
    }
  }
  return(l.res)
}


# ==================================================================================================
TRAINEE_DOWNLOAD_STKVN_BOARD_BY_SOURCE_OLD = function(pSource='CAF', pFolder =  paste0(SData, 'IFRC_CCPR/'), Nb_Min = 10,
                                                      Nb_Group = 10) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_MONITOR_EXECUTION_SUMMARY (pOption='CCPR_DOWNLOAD_SOURCE_STKVN_BOARD_BY_MARKET', pAction="SAVE", NbSeconds=3600, ToPrint=F)
  DBL_RELOAD_INSREF()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  File_List      = tolower(paste0( 'S:/STKVN/BOARD/DAY/ccpr_download_all_stkvn_market_day.rds'))
  CATln_Border(File_List)
  List_Companies = readRDS ('S:/STKVN/BOARD/DAY/ccpr_download_all_stkvn_market_day.rds')
  List_Companies [, codesource := substr(code, 6,8)]
  List_Companies = unique(List_Companies[order(codesource, -date)], by='codesource')[nchar(codesource)==3]
  List_Companies = merge(List_Companies[, -c('name')], ins_ref[type=='STK', .(code, name=short_name)], all.x=T, by='code')
  My.Kable.TB(List_Companies[, .(name, codesource)])
  CATln('Loaded REF... ')
  List_Codes     = unique(List_Companies[,.(codesource, name, market = final)], by ='codesource') 
  
  
  File_Folder = pFolder
  
  FileName = paste0('CCPR_DOWNLOAD_',pSource,'_STKVN_BOARD_', gsub('-','',LastTrading))
  
  
  
  FilePath       = paste0(pFolder,   FileName, '.rds')
  CATln_Border(paste("SAVE TO FILEPATH : ", FilePath))
  
  # ................................................................................................
  # DOWNLOAD
  # ................................................................................................
  ExtraFolder = ''
  
  if (nrow(List_Codes)>0)
  {
    if (file.exists(FilePath))
    {
      # Data_old = CCPR_READRDS(pFolder, paste0(FileName, '.rds')) 
      Data_old = try ( readRDS(paste0(pFolder, FileName, '.rds'))  )
      if (nrow(Data_old)>0) {
        Data_old = Data_old[!is.na(codesource)]
        List_Codes_ToDo = List_Codes[!codesource %in% Data_old$codesource ]
        My.Kable.TB(Data_old)
      } else {
        List_Codes_ToDo = List_Codes
      }
    } else { 
      CATln(paste('FILE NO EXIST :', FilePath))
      Data_old = data.table() 
      List_Codes_ToDo = List_Codes
    }
    
    if (nrow(List_Codes_ToDo)>0)
    {
      List_Codes_ToDo = List_Codes_ToDo[order(codesource)]
      My.Kable(List_Codes_ToDo)
      Data_All = data.table()
      Data_List = list()
      
      FileData = List_Codes_ToDo
      FileRow  = nrow(List_Codes_ToDo)
      
      Nb_TODO  = min(Nb_Min, FileRow)
      Nb_Total = FileRow
      
      FileToSave = paste0(FileName, '.rds')
      Total_Time  = 0
      
      for (i in 1:Nb_TODO)
      {
        # i =1
        Start.Time = Sys.time()
        pCode    = FileData[i]$codesource
        CATln("")
        # CATln_Border(paste(i, '/', Nb_TODO, ' = ', pCode))
        CATln_Border(paste('DOWNLOAD_STKVN_BOARD_BY_SOURCE : ', pSource,  '=', i, paste0('(', Nb_Group,')'), '/', Nb_TODO, '/', Nb_Total, ' = ', pCode))
        Sys.sleep(1)
        My_Data = data.table()
        
        switch (pSource, 
                # pCode = 'AAM'                                                        
                'CAF' = {       My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_CAF_STKVN_BOARD_BY_CODE(pCode=pCode)))
                },
                'VST' = {       My_Data = CHECK_CLASS(try(TRAINEE_GET_VST_BOARD_MEMBER_BY_CODE(pCode=pCode))) 
                },
                'VND' = {       My_Data = CHECK_CLASS(try(TRAINEE_DOWNLOAD_VND_STKVN_BOARD_BY_CODE (pCode=pCode))) 
                }              
        )
        
        
        if (all(class(My_Data)!='try-error'))
        {
          Data_List[[i]] = My_Data
        }
        Sys.sleep(2)
        
        if (i %% Nb_Group ==0 | i == Nb_TODO)
        {
          # DATE
          Data_All = rbindlist(Data_List, fill=T)
          if (! 'date' %in% names (Data_All)) { Data_All [, date := LastTrading]}
          if (! 'code' %in% names (Data_All)) { Data_All [, code := paste0('STKVN',codesource)]}
          Data_final = rbind(Data_old, Data_All, fill=T)
          
          # CCPR_SAVERDS(Data_final,pFolder, FileToSave, ToSummary = T, SaveOneDrive = T)
          saveRDS( Data_final ,  paste0(pFolder, FileToSave))
          CATln_Border(paste ('SAVED: ', paste0(pFolder, FileToSave)) )
          
          # DAY :
          FileAll = paste0(gsub(paste0('_',gsub('-','', LastTrading) ),'',FileName ),'_DAY', '.rds')
          
          if ( file.exists(paste0(pFolder, '', FileAll))) {
            # data_old1 = CCPR_READRDS(FileFolder = paste0(pFolder, ''), FileName = FileAll, ToKable = F, ToPrompt = F, ToRestore = T)
            data_old1 = try( readRDS(paste0(pFolder, FileAll )) )
          } else { data_old1 = data.table()}
          data_all_final = unique(rbind( Data_final,data_old1, fill = T), by = c('code', 'date'))
          # CCPR_SAVERDS(data_all_final,pFolder,FileAll , ToSummary = T, SaveOneDrive = T)
          saveRDS (data_all_final, paste0(pFolder,FileAll))
          CATln_Border(paste ('SAVED: ', paste0(pFolder, FileAll)) )
          # HISTORY:
          FileNameHistory = paste0(gsub('DAY','HISTORY' , FileAll) )
          if ( file.exists(paste0(pFolder,FileNameHistory))) {
            # data_old1 = CCPR_READRDS(FileFolder = pFolder, FileName = FileNameHistory, ToKable = F, ToPrompt = F, ToRestore = T)
            data_old1 = try( readRDS(paste0(pFolder, FileNameHistory )) )
          } else { data_old1 = data.table()}
          data_all_final_history = unique(rbind( Data_final,data_old1, fill = T), by = c('code', 'date'))
          
          # CCPR_SAVERDS(data_all_final_history,pFolder,FileNameHistory , ToSummary = T, SaveOneDrive = T)
          saveRDS (data_all_final, paste0(pFolder,FileNameHistory))
          CATln(paste('SAVED : ',pFolder, FileNameHistory, '-', Format.Number(nrow(Data_final),0),'records'))
          Sys.sleep(2)
        }
        
        End.Time = Sys.time()
        Total_Time = as.numeric(difftime(End.Time, Start.Time, units = 'secs')) + Total_Time
        Avg_Time = Total_Time / i
        End_Forecast = Avg_Time * (Nb_TODO - i)
        Time_To_End = as.difftime(End_Forecast, units = "secs") + Sys.time()
        CATln_Border(paste('TIME TO END :', substr(Time_To_End,1,19), '( after',format(End_Forecast, nsmall = 0),'secs )'))
      }
      
      return(Data_final)
    } else {
      CATln_Border('DATA FULLY UPDATED')
      Sys.sleep(2)
    }
  }
  
  
} 

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_BOARD_BY_CODE = function(pCode = 'MHL') {
  # ------------------------------------------------------------------------------------------------
  # z = TRAINEE_DOWNLOAD_CAF_STKVN_CEO_BY_CODE_RANK (pCode = 'MHL')
  # pCode = 'HDG'
  # format(Sys.time(), "%Y-%m-%d %X")
  Start.time = Sys.time()
  GC_SILENT()
  Final_Data = data.table()
  pFound      = F
  # format(Sys.time(), "%Y-%m-%d %H:%m:%S")
  pURL       = paste0('https://s.cafef.vn/Ajax/CongTy/BanLanhDao.aspx?sym=', pCode)
  File_Temp  = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '',   format(Sys.time(), "%Y-%m-%d %H:%m:%S"))), '.txt')
  rm(x)
  x          = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp = paste0('c:/temp/',File_Temp) , ToDeleteTemp = T)
  content  = rvest::read_html(x)
  tables   = content %>% html_table(fill = TRUE)
  # Found = SELECT_TABLE_WITH_FIELD(tables,pField = 'x1', pContent = 'Kế toán trưởng', like = F)
  Found1 = setDT(tables[[6]][-1,])[, category:= 'EXECUTIVES'][, rank:= seq(.N)]
  Found2 =  setDT(tables[[5]][-1,])[, category:= 'BOARD'][, rank:= seq(.N)]
  Found = rbind( Found1, Found2)
  Data_Final = data.table()
  if (nrow(Found) >0) {
    names(Found) = c('positions','source_name','x3','age','detail', 'category', 'rank')
    # Found = Found[-1,]
    Found[, rank:= seq(.N)]
    xFirst = paste( str.extract(x, 'BAN GIÁM ĐỐC', '</tbody></table>'))
    xLast = paste( str.extract(x, 'HỘI ĐỒNG QUẢN TRỊ', '</tbody></table>'))
    pData  = list()
    for (i in 1:nrow(Found))
    {
      # i = 8
      if (grepl(Found$source_name [i], xFirst)|grepl(Found$source_name [i], xLast))
      {
        if (grepl(Found$source_name [i], xFirst) ) {
          xBody   = str.extract(xFirst, Found$positions [i], '</tr')
        } else {
          xBody   = str.extract(xLast, Found$source_name [i], '</tr')
        }
        
        pFound   = T
      } 
      
      if (pFound)
      {
        x.url   = str.extract(xBody, '<a href="', '"'); CATln(x.url)
        x.pname = Found$source_name [i]; CATln(x.pname)
        Final_Data = data.table(code=paste0('STKVN', pCode), codesource=pCode, source='CAF', dataset='BOARD', source_pname=x.pname, 
                                source_position = Found$positions [i], people_url = paste0('https://s.cafef.vn', x.url),
                                category = Found$category [i] , rank = Found$rank [i] )      
        Final_Data[grepl('^Ông', source_pname), gender:='MALE']
        Final_Data[grepl('^Ông', source_pname), people_name:=trimws(substr(source_pname, nchar('^Ông')+1, nchar(source_pname)))]
        Final_Data[grepl('^Bà', source_pname), gender:='FEMALE']
        Final_Data[grepl('^Bà', source_pname), people_name:=trimws(substr(source_pname, nchar('^Bà')+1, nchar(source_pname)))]
        Final_Data[category =='EXECUTIVES' & rank == 1, ceo:=1]
        Final_Data[, updated:=substr(Sys.time(),1,19)]
        My.Kable.All(Final_Data)
        pData [[i]] = Final_Data
      }
    }
    Data_Final = rbindlist(pData, fill =T)
  }
  End.time = Sys.time()
  CATln(paste('Duration = ', Format.Number(difftime(End.time, Start.time, units='sec'),2)))
  return(Data_Final)
} 

# ==================================================================================================
TRAINEE_DOWNLOAD_VND_STKVN_BOARD_BY_CODE = function(pCode      = 'VCB')  {
  # ------------------------------------------------------------------------------------------------
  
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  
  # pURL       = 'https://finfo-api.vndirect.com.vn/v4/personnel?q=code:VCB~locale:VN&size=999&sort=displayOrder:ASC'
  pURL       = paste0('https://finfo-api.vndirect.com.vn/v4/personnel?q=code:', pCode, '~locale:VN&size=999&sort=displayOrder:ASC')
  x = jsonlite::fromJSON(pURL)
  xData      = as.data.table(x$data)
  xData      = CLEAN_COLNAMES(xData)
  
  xData[, rank:=seq.int(1,.N), by='group']
  xData[salution=='Ông', gender:='MALE']
  xData[salution=='Bà',  gender:='FEMALE']
  # CEO ...............................
  xData$ceo = as.numeric(NA)
  xData[position=='Tổng Giám đốc', ceo:=1]
  if (nrow(xData[!is.na(ceo)])==0)
  {
    xData[rank==1 & group=='Ban điều hành', ceo:=1]
  }
  
  # COB ...............................
  xData$cob = as.numeric(NA)
  xData[position=='Chủ tịch HĐQT', cob:=1]
  if (nrow(xData[!is.na(cob)])==0)
  {
    xData[rank==1 & group=='Hội đồng quản trị', ceo:=1]
  }
  xData[, ':='(codesource=code, source='VND', dataset='BOARD', date=LastTrading)]
  xData[, ':='(code=paste0('STKVN', codesource), updated = substr(Sys.time(),1,16), people_name=name)]
  xData$name = NULL
  My.Kable(xData[, .(date, source, codesource, code, personid, gender, people_name, group, ceo, cob,effectivedate,yearofbirth, updated)][order(ceo, cob)])
  return(xData)
}

# ==================================================================================================
TRAINEE_GET_VST_BOARD_MEMBER_BY_CODE_OLD = function(pCode = 'VND')  {
  # ------------------------------------------------------------------------------------------------
  Start.time = Sys.time()
  LastTrading = CCPR_LAST_TRADING_DAY_VN(substr(Sys.time(),12,13), ToPrompt = T)
  Data_Final = data.table()
  pURL  = paste0('https://finance.vietstock.vn/', pCode, '/board-of-management.htm?languageid=2')
  CATln_Border(pURL)
  content  = rvest::read_html(pURL)
  tables   = content %>% html_table(fill = TRUE)
  # length(tables)
  if (length(tables)>1)
  {
    Data_List = list()
    for (k in 2:length(tables))
    {
      Data_List[[k]] = as.data.table(tables[[k]])
    }
    Data_All = rbindlist(Data_List, fill=T)
    Data_All = CLEAN_COLNAMES(Data_All)
    # colnames(Data_All)[1]='date'
    Data_All[, date:=as.Date(LastTrading)]
    Data_All$gender = as.character(NA)
    Data_All[grepl('^Ông ', fullname), gender:='M']
    Data_All[grepl('^Bà ', fullname), gender:='F']
    Data_All[, fullname:=gsub('^Bà ','', fullname)] 
    Data_All[, fullname:=gsub('^Ông ','', fullname)] 
    # My.Kable(Data_All)
    # str(Data_All)
    Data_All[, positions:=trimws(positions)]
    Data_All[nchar(trimws(education))==0, education:=as.character(NA)]
    Data_All[grepl('N/a|NA', education), education:=as.character(NA)]
    Data_All[grepl('NA|-', yearofbirth), yearofbirth:=as.character(NA)]
    
    Data_All[grepl('N/A', time), time:=as.character(NA)]
    Data_All$independence=as.numeric(NA)
    Data_All[grepl('Independence', time), independence:=1]
    Data_All[grepl('Independence', time), time:=gsub('Independence', "", time)]
    Data_All[nchar(shares)>0, shares:=gsub(',','',shares)]
    Data_All[nchar(shares)==0, shares:=as.character(NA)]
    Data_All[, shares:=as.numeric(shares)]
    #My.Kable(Data_All)
    
    Data_Final = Data_All[, .(date, codesource=pCode, ticker=pCode, source='VST', gender, fullname_lc=fullname, positions, since=time, 
                              birthyear=as.numeric(as.character(yearofbirth)), education=as.character(education), independence)]
    Data_Final[, fullname:=trimws(decodeVN(fullname_lc, from='Unicode', to='Unicode', diacritics=F))] 
    Data_Final[, lastname:=toupper(stringr::word(fullname, 1))]
    Data_Final[, firstname:=substr(fullname, nchar(lastname)+1, nchar(fullname))]
    Data_Final[grepl('^CEO|^Chief Executive', positions), ceo:=1]
    Data_Final[, updated:=substr(Sys.time(),1,19)]
    # Data_Final[, date := Sys.Date()]
    
    My.Kable.TB(Data_Final[, -c('fullname', 'independence')])
    End.time = Sys.time()
    CATln(paste('Duration = ', Format.Number(difftime(End.time, Start.time, units='sec'),2)))
  }
  
  return(Data_Final)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_CAF_STKVN_CEO_BY_CODE_RANK = function(pCode = 'MHL') {
  # ------------------------------------------------------------------------------------------------
  # z = IFRC_CCPR_DOWNLOAD_CAF_STKVN_CEO_BY_CODE_RANK (pCode = 'MHL')
  # pCode = 'HDG'
  # format(Sys.time(), "%Y-%m-%d %X")
  Start.time = Sys.time()
  GC_SILENT()
  Final_Data = data.table()
  Found      = F
  # format(Sys.time(), "%Y-%m-%d %H:%m:%S")
  pURL       = paste0('https://s.cafef.vn/Ajax/CongTy/BanLanhDao.aspx?sym=', pCode)
  File_Temp  = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '',   format(Sys.time(), "%Y-%m-%d %H:%m:%S"))), '.txt')
  rm(x)
  x          = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL=pURL, File_Temp = paste0('c:/temp/',File_Temp) , ToDeleteTemp = T)
  content  = rvest::read_html(x)
  tables   = content %>% html_table(fill = TRUE)
  # Found = SELECT_TABLE_WITH_FIELD(tables,pField = 'x1', pContent = 'Kế toán trưởng', like = F)
  Found = setDT(tables[[6]])
  if (nrow(Found) >0) {
    names(Found) = c('positions','source_name','x3','age','detail')
    Found = Found[-1,]
    Found[, rank:= seq(.N)]
    xFirst = str.extract(x, 'BAN GIÁM ĐỐC', '</tbody></table>')
    if (grepl(Found[rank ==1]$source_name, xFirst))
    {
      xBody   = str.extract(xFirst, Found[rank ==1]$positions, '</tr')
      Found   = T
    } 
    if (Found)
    {
      x.url   = str.extract(xBody, '<a href="', '"'); CATln(x.url)
      x.pname = word(str.extract(xBody, 'title="', '</a'),2,2,'>'); CATln(x.pname)
      Final_Data = data.table(code=paste0('STKVN', pCode), codesource=pCode, source='CAF', dataset='CEO', source_pname=x.pname, people_url = paste0('https://s.cafef.vn', x.url))
      Final_Data[grepl('^Ông', source_pname), gender:='MALE']
      Final_Data[grepl('^Ông', source_pname), people_name:=trimws(substr(source_pname, nchar('^Ông')+1, nchar(source_pname)))]
      Final_Data[grepl('^Bà', source_pname), gender:='FEMALE']
      Final_Data[grepl('^Bà', source_pname), people_name:=trimws(substr(source_pname, nchar('^Bà')+1, nchar(source_pname)))]
      Final_Data[, updated:=substr(Sys.time(),1,19)]
      My.Kable.All(Final_Data)
    }
  }
  End.time = Sys.time()
  CATln(paste('Duration = ', Format.Number(difftime(End.time, Start.time, units='sec'),2)))
  return(Final_Data)
} 

# ==================================================================================================
MASOTHUE_INFO_FROM_URL = function(cURL = 'https://masothue.com/0102044528-001-chi-nhanh-cong-ty-trach-nhiem-huu-han-duc-thien-tai-vinh-phuc')
{
  rm(content, tables)
  CATln_Border(cURL)
  content    = try(rvest::read_html(cURL))
  
  if (all(class(content)!='try-error'))
  {
    tables     = content %>% html_table(fill = TRUE)
    length(tables)
    xData      = as.data.table(tables[[1]])
    if (length(tables)==2)
    {
      xSector    = as.data.table(tables[[2]])
      Code_Sector  = as.character(xSector[1,1])
      Name_Sector  = as.character(xSector[1,2])
    } else {
      xSector      = data.table()
      Code_Sector  = as.character(NA)
      Name_Sector  = as.character(NA)
    }
    # My.Kable(xData)
    # str(xData)
    Company = names(xData)[1]
    
    colnames(xData) = c('dataset', 'value')
    
    Final_Data = xData[nchar(dataset)>0]
    Final_Data[grepl('^Cập nhật mã số thuế ', dataset), ':='(dataset='Last Update', value=word(word(value,2,2,'vào'),1,1,'[.]'))]
    Final_Data[dataset=='Last Update', dataset:=gsub('Bạn muốn cập nhật thông tin mới nhất? Cập nhật','', dataset)]
    Final_Data[, ':='(company=Company, code_sector=as.character(Code_Sector))]
    
    Final_Data = rbind(Final_Data, data.table(dataset='Sector', value=as.character(Name_Sector), company = Company, code_sector=as.character(Code_Sector)))
    My.Kable.All(Final_Data)
  } else { 
    CATln('NO DATA')
    Final_Data = data.table()
  }
  return(Final_Data)
}

# ==================================================================================================
CATrp = function(l.Str) {
  # ------------------------------------------------------------------------------------------------
  cat("\r", paste(l.Str, strrep(" ",max(0,120-nchar(l.Str)))), "")
}

# ==================================================================================================
TRAINEE_LOOP_DIV_YAH = function(Codes_From = 'IDX', Save_Folder='S:/R/DATA/DIVIDEND/', Save_File='DOWNLOAD_IDX_DIVIDEND_RAW.rds', 
                                NB_GROUP    = 20, NB_MIN = 100, NbDays = 10000,  ToPrompt=F, FillEmpty = T, 
                                LastUpdate = '2024-02-28',    LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = T, pSleep = 15) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  # MyPC = toupper(TRAINEE_GET_MYPC())
  
  switch(Codes_From,
         'IDX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_IDX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'ASX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_ASX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SET' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SET.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'TWSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_TWSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SGX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SGX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'HKE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_HKE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'KRX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_KRX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'JPX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_JPX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SZSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SZSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         {
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_', Codes_From, '.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         }
  )
  
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = T)
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>LastUpdate]$codesource]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL 
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 5
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = 'VNM.VN'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL),
                         '/', nrow(LIST_CODES), '=', pCode))
      xDay  = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_DIVIDEND  ( pCode = pCode,  Nbdays = NbDays,
                                                               silent = T, ToKable = T)))
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        if (!'date' %in% names(xDay)){
          xDay[, date := Sys.Date()]
        }
        xList[[k]] = xDay
        # str(xDay)
        
      }
      
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          #Data_Old = unique(Data_Old, by=c('codesource', 'date'))
          My.Kable(Data_Old)
          CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
        }
      }
      Sys.sleep(pSleep)
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    
    CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}
# ==================================================================================================
TRAINEE_GET_FLOAT <- function(stock="XFAB.PA"){
  library(xml2)
  #  stock = "SLB.PA"
  tryCatch({
    # ----------------------------------------------------------------------------------------------
    url <- paste0("https://finance.yahoo.com/quote/", stock, "/key-statistics")
    # tables <- read_html(url) %>%
    #   html_nodes("table") %>%
    #   html_table()
    page <- read_html(url)
    float_value <- html_nodes(page, 
                              xpath = "//*[@id='Col1-0-KeyStatistics-Proxy']/section/div[2]/div[2]/div/div[2]/div/div/table/tbody/tr[5]/td[2]")
    value <- xml_text(float_value)
    float <- TRAINEE_CONVERT_NUMBER(as.vector(value))
    
    # float <- TRAINEE_CONVERT_NUMBER(as.vector(tables[[3]][5,2]))
    return(float)
  }, error = function(e) {
    # If an error occurs, return NA
    return(NA)
  })
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_SHARES <- function(pCode){
  # Initialize df as NULL
  df <- NULL
  # Attempt to execute the main code
  # ----------------------------------------------------------------------------------------------
  #  pCode = "APF.VN"
  library(quantmod)
  # library(plyr)
  
  what_metrics <- yahooQF(c("Shares Outstanding", 
                            "Market Capitalization"))
  
  metrics <- tryCatch({
    getQuote(paste(pCode, sep="", collapse=";"), what=what_metrics)
  }, error = function(e) {
    return(NULL)
  })
  
  if (!is.null(metrics) && nrow(metrics) > 0){
    
    trade_time <- as.Date(metrics$`Trade Time`)
    
    # Subtract one day to get the previous day
    trade_time_previous_day <- trade_time - 1
    
    # Format the date as desired
    formatted_trade_time <- format(trade_time_previous_day, "%Y-%m-%d")
    
    df <- data.table(date              = formatted_trade_time,
                     source            = "YAH",
                     codesource        = pCode,
                     market_cap        = metrics$`Market Capitalization`, 
                     share_outstanding = metrics$`Shares Outstanding`, 
                     float             = TRAINEE_GET_FLOAT(stock = pCode),
                     updated           = substr(as.character(Sys.time()), 1, 19))
    class(df$market_cap) <- "numeric"
    class(df$share_outstanding) <- "integer"
    class(df$float) <- "numeric"
  } else {
    df <- data.table(date              = as.character(Sys.Date()),
                     source            = "YAH",
                     codesource        = pCode,
                     market_cap        = as.numeric(NA),
                     share_outstanding = as.integer(NA),
                     float             = NA_real_,
                     updated           = substr(as.character(Sys.time()), 1, 19))
    class(df$market_cap) <- "numeric"
    class(df$share_outstanding) <- "integer"
    class(df$float) <- "numeric"
    
  }
  
  Sys.sleep(10)
  
  return(df)
}

# ==================================================================================================
LOOP_DOWNLOAD_YAH_SHARES_RAW = function(Codes_From  = 'ASX', Save_Folder ='S:/R/DATA/BOARD/RAW/', 
                                        NB_GROUP     = 20,         NB_MIN = 100, NbDays = 10000, 
                                        pSleep       = 1, 
                                        ToPrompt     = F, 
                                        FillEmpty    = T, 
                                        LastUpdate   = '2024-02-28',
                                        LookAt       = 'UPDATED', 
                                        ToSummary    = F, 
                                        SaveOneDrive = T) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  # MyPC = toupper(TRAINEE_GET_MYPC())
  
  LIST_CODES = setDT(openxlsx::read.xlsx(paste0('S:/', paste0('R/DATA/BOARD/LIST/LIST_CODES_',Codes_From,'.xlsx')), sheet='LIST'))
  LIST_CODES = LIST_CODES[order(code_exchange)]
  My.Kable(LIST_CODES)
  List_Codesource = LIST_CODES[, codesource:=code_yah]
  Save_File = paste0("DOWNLOAD_", Codes_From , "_YAH_SHARES_RAW.rds")
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    # Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = F)
    Data_Old  = readRDS(paste0(Save_Folder, Save_File))
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) 
  { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old$codesource]},
           # 'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old$codesource | (codesource %in% Data_Old$codesource & (is.na(Data_Old$market_cap) | is.na(Data_Old$share_outstanding) | is.na(Data_Old$float))), "codesource"]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL
    
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 1
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = '14D.AX'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL), '/', nrow(LIST_CODES), '=', pCode))
      # pCode = "1305.T"
      xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_SHARES(pCode)))
      # xDay = try(TRAINEE_DOWNLOAD_YAH_SHARES(pCode))
      Sys.sleep(pSleep)
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        xList[[k]] = xDay
        My.Kable.All(xDay)
        # str(xDay)
        
      }
      # if (FillEmpty & nrow(xDay)==0){
      #   xList[[k]] = data.table(source=pSource, codesource=pCode, date=Sys.Date(), close=as.numeric(NA), updated=as.character(Sys.Date()))
      # }
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          Data_Old = unique(Data_Old, by=c('codesource', 'date'))
          My.Kable(Data_Old)
          # CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
          saveRDS(Data_Old,paste0( Save_Folder, Save_File))
        }
      }
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    # CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    saveRDS(Data_Old,paste0( Save_Folder, Save_File))
    CATln_Border(paste0( Save_Folder, Save_File))
    Sys.sleep(pSleep)
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}
# ==================================================================================================
TRAINEE_DOWNLOAD_WSJ_STK_PEOPLE = function(WSJ_CODE = 'ID/ABDA' )  {
  # ------------------------------------------------------------------------------------------------
  pURL      = paste0('https://www.wsj.com/market-data/quotes/', WSJ_CODE, '/company-people/')
  File_Temp = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '', format(Sys.time(), "%Y-%m-%d %H:%m:%S"))), '.txt')
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/',File_Temp), ToDeleteTemp = T)
  PEOPLE_ALL = data.table()
  if (grepl('Key People', xweb, ignore.case = T))
  {
    
    xBody = str.extract(xweb, '<div class="cr_profile_people module">', '</div> </div> </div>')
    xCompanyName = str.extract(xBody, '<span class=\"hdr_co_name\">', '</span>')
    xParts = unlist(strsplit(xBody, '<h4>'))
    iFound = 0
    PEOPLE_ALL = data.table()
    
    for (ik in 1:length(xParts))
    {
      if (grepl('^Board of Directors', xParts[[ik]], ignore.case = T)){ iFound = ik}
    }
    if (iFound>0)
    {
      iPart = xParts[[iFound]]
      xPeople =  unlist(strsplit(iPart, '<span class=\"data_data\">'))
      xList   = list()
      if (length(xPeople)>=2)
      {
        for (ip in 2:length(xPeople))
        {
          # ip = 2
          p.url  = trimws(gsub('<a href=','', gsub('"','', word(xPeople[[ip]],1,1, '>'))))        ; CATln(p.url)
          p.name = trimws(str.extract(gsub('"','', word(xPeople[[ip]],1,1, '</span>')),'>','<'))  ; CATln(p.name)
          p.position = trimws(word(gsub('"','', word(xPeople[[ip]],2,2, '</span>')),2,2,'>'))     ; CATln(p.position)
          xList[[ip]] = data.table(member='BOARD', people_name=p.name, position=p.position, people_url=p.url)
        }
        
        xALL = rbindlist(xList)
        if (nrow(xALL)>0) { 
          xALL[, rank:=seq.int(1,.N)]
          My.Kable.All(xALL)
          PEOPLE_ALL = rbind(PEOPLE_ALL, xALL, fill=T)}
      }
    }
    
    iFound = 0
    for (ik in 1:length(xParts))
    {
      if (grepl('^Executive', xParts[[ik]], ignore.case = T)){ iFound = ik}
    }
    
    if (iFound>0)
    {
      iPart = xParts[[iFound]]
      xPeople =  unlist(strsplit(iPart, '<span class=\"data_data\">'))
      xList   = list()
      if (length(xPeople)>=2)
      {
        for (ip in 2:length(xPeople))
        {
          # ip = 2
          p.url  = trimws(gsub('<a href=','', gsub('"','', word(xPeople[[ip]],1,1, '>'))))        ; CATln(p.url)
          p.name = trimws(str.extract(gsub('"','', word(xPeople[[ip]],1,1, '</span>')),'>','<'))  ; CATln(p.name)
          p.position = trimws(word(gsub('"','', word(xPeople[[ip]],2,2, '</span>')),2,2,'>'))     ; CATln(p.position)
          xList[[ip]] = data.table(member='EXECUTIVES', people_name=p.name, position=p.position, people_url=p.url)
        }
        xALL = rbindlist(xList)
        if (nrow(xALL)>0) { 
          xALL[, rank:=seq.int(1,.N)]
          My.Kable.All(xALL)
          PEOPLE_ALL = rbind(PEOPLE_ALL, xALL, fill=T)}
      }
    }
    if (nrow(PEOPLE_ALL)>0)
    {
      PEOPLE_ALL[, name:=toupper(xCompanyName)]
      PEOPLE_ALL[, source:='WSJ']
      PEOPLE_ALL[, codesource:=WSJ_CODE]
      PEOPLE_ALL[, date:=Sys.Date()]
      PEOPLE_ALL[,position:=gsub('&amp;','&', position)]
      My.Kable.All(PEOPLE_ALL[, -c('people_url')])
    }
  }
  return(PEOPLE_ALL)
}

# ==================================================================================================
TRAINEE_CCPR_WEB_SAVE_AS = function(pURL, File_Temp, pSleep=5, ToDeleteTemp=T) {
  # ------------------------------------------------------------------------------------------------
  # pURL                = 'https://www.vietnamworks.com/viec-lam?q=ai-engineer&l=29&page=1'
  # File_Temp = 'vw_01.txt'
  # pSleep=1; ToDeleteTemp=T
  MyExecution_Pattern = 'py c:/python/savepage.py "URL" "FILE"'
  MyExecution         = gsub('URL',  pURL, MyExecution_Pattern)
  MyExecution         = gsub('FILE', File_Temp, MyExecution)
  CATln_Border(MyExecution)
  
  shell(MyExecution); Sys.sleep(pSleep)
  
  xweb = readr::read_file(File_Temp)
  if (grepl('pre-wrap;\">', xweb)) { xweb = str.extract(xweb, 'pre-wrap;\">', '</pre>') }
  if (ToDeleteTemp) { file.remove(paste0(File_Temp)) }
  # print(xweb)
  
  return(xweb)
}

# ==================================================================================================
str.remove = function(x,strt,stre) 
{ # FUNCTION: REMOVE SUB-STRING FROM A STRING
  # ----------------------------------------------------------------------------
  pos1 <- regexpr(strt, x, fixed = T)
  num1 <- nchar(strt)
  pos2 <- nchar(stre)
  y <- substr(x, num1 + pos1, pos2)
  return(y)
}

# ==================================================================================================
str.extract = function(x,strt,stre) 
{ # FUNCTION: EXTRACT SUB-STRING FROM A STRING
  # ----------------------------------------------------------------------------
  num1 <- nchar(strt)
  num2 <- nchar(stre)
  pos1 <- regexpr(strt, x, fixed = T)
  z <- str.remove(x,strt,x)
  pos2 <- regexpr(stre, z, fixed = T) + pos1 + num1
  y <- substr(x, pos1 + num1, pos2 - 2)
  return(y)
}

# ==============================================================================
TRAINEE_LOOP_BOARD_YAH = function(Codes_From = 'IDX', Save_Folder='S:/R/DATA/BOARD/RAW/', Save_File='DOWNLOAD_IDX_YAH_BOARD_RAW.rds', 
                                  NB_GROUP    = 5, NB_MIN = 10, ToPrompt=F, FillEmpty = T, 
                                  LastUpdate  = '2024-02-28', LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = T, pSleep = 5) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  # MyPC = toupper(TRAINEE_GET_MYPC())
  
  switch(Codes_From,
         'IDX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_IDX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'ASX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_ASX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SET' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SET.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'TWSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_TWSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SGX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SGX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'HKE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_HKE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SZSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SZSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'KRX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_KRX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'JPX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_JPX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'MYS' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_MYS.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'VNM' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_VNM.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         {
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_', Codes_From, '.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         }
         
         
  )
  
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = T)
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>LastUpdate]$codesource]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL 
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 5
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = 'VNM.VN'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL), '/', nrow(LIST_CODES), '=', pCode))
      
      xDay  = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_BOARD_EXECUTIVES_GENDER(pCode = pCode)))
      
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        if (!'date' %in% names(xDay)){
          xDay[, date := Sys.Date()]
        }
        xList[[k]] = xDay
        # str(xDay)
        
      }
      # if (FillEmpty & nrow(xDay)==0){
      #   xList[[k]] = data.table(source=pSource, codesource=pCode, date=Sys.Date(), close=as.numeric(NA), updated=as.character(Sys.Date()))
      # }
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          Data_Old = unique(Data_Old, by=c('codesource', 'date', 'name', 'title'))
          My.Kable(Data_Old)
          CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
        }
      }
      Sys.sleep(pSleep)
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}

# ==================================================================================================
TRAINEE_RELOAD_INSREF = function ( silent=T, ToForce=F) {
  # ------------------------------------------------------------------------------------------------
  # 2023-09-14
  UData = "S:/R/DATA/"
  
  if (ToForce)
  {
    if (file.exists(UData)) { 
      CATln('Loading ..')
      ins_ref = readRDS(paste0(UData, 'EFRC_INS_REF.rds'))
      # ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
    }
    else {
      if (file.exists(SData)) { 
        CATln('Loading ..')
        # ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
        ins_ref = readRDS(paste0(SData , 'EFRC_INS_REF.rds'))}
    }
    assign("ins_ref", ins_ref, envir = .GlobalEnv)
  } else {
    if (exists("ins_ref")) { if (!silent) { CATln("INS_REF ALREADY LOADED") } } else { 
      # UData = SData
      if (file.exists(UData)) { pFolder = UData} else {pFolder = SData}
      # ins_ref = CCPR_READRDS(pFolder, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
      ins_ref = readRDS(paste0(pFolder, 'EFRC_INS_REF.rds' ))
      assign("ins_ref", ins_ref, envir = .GlobalEnv)
    }
  }
}

# ==================================================================================================
IFRC_CCPR_WEB_SAVE_AS = function(pURL, File_Temp, pSleep=5, ToDeleteTemp=T) {
  # ------------------------------------------------------------------------------------------------
  MyExecution_Pattern = 'python c:/python/savehtml.py "URL" "FILE"'
  MyExecution         = gsub('URL',  pURL, MyExecution_Pattern)
  MyExecution         = gsub('FILE', File_Temp, MyExecution)
  # MyExecution = gsub('<URL>', pURL, gsub('<FOLDER>', SaveFolder, gsub('<FILE>', FileTempHTML, 'python r:/python/savehtml_edit.py "<URL>" "<FOLDER><FILE>"')))
  CATln_Border(MyExecution)
  
  shell(MyExecution); Sys.sleep(pSleep)
  
  xweb = readr::read_file(File_Temp)
  if (grepl('pre-wrap;\">', xweb)) { xweb = str.extract(xweb, 'pre-wrap;\">', '</pre>') }
  if (ToDeleteTemp) { file.remove(paste0(File_Temp)) }
  return(xweb)
}

# ==================================================================================================
IFRC_CCPR_WEB_SAVE_AS_V2 = function(Execution='py', pURL, File_Temp, pSleep=5, ToDeleteTemp=T) {
  # ------------------------------------------------------------------------------------------------
  MyExecution_Pattern = paste(Execution, 'c:/python/savehtml.py "URL" "FILE"')
  MyExecution         = gsub('URL',  pURL, MyExecution_Pattern)
  MyExecution         = gsub('FILE', File_Temp, MyExecution)
  # MyExecution = gsub('<URL>', pURL, gsub('<FOLDER>', SaveFolder, gsub('<FILE>', FileTempHTML, 'python r:/python/savehtml_edit.py "<URL>" "<FOLDER><FILE>"')))
  CATln_Border(MyExecution)
  
  shell(MyExecution); Sys.sleep(pSleep)
  
  xweb = readr::read_file(File_Temp)
  if (grepl('pre-wrap;\">', xweb)) { xweb = str.extract(xweb, 'pre-wrap;\">', '</pre>') }
  if (ToDeleteTemp) { file.remove(paste0(File_Temp)) }
  return(xweb)
}

# ==================================================================================================
IFRC_CCPR_DOWNLOAD_WSJ_STK_PEOPLE = function(WSJ_CODE = 'ID/ABDA' )  {
  # ------------------------------------------------------------------------------------------------
  pURL      = paste0('https://www.wsj.com/market-data/quotes/', WSJ_CODE, '/company-people/')
  File_Temp = paste0('TEMP_', gsub(' ','_', gsub('[-]|[:]|[.]', '', format(Sys.time(), "%Y-%m-%d %H:%m:%S"))), '.txt')
  xweb = TRAINEE_CCPR_WEB_SAVE_AS_NOBROWSER(pURL, paste0('c:/temp/',File_Temp), ToDeleteTemp = T)
  PEOPLE_ALL = data.table()
  if (grepl('Key People', xweb, ignore.case = T))
  {
    
    xBody = str.extract(xweb, '<div class="cr_profile_people module">', '</div> </div> </div>')
    xCompanyName = str.extract(xBody, '<span class=\"hdr_co_name\">', '</span>')
    xParts = unlist(strsplit(xBody, '<h4>'))
    iFound = 0
    PEOPLE_ALL = data.table()
    
    for (ik in 1:length(xParts))
    {
      if (grepl('^Board of Directors', xParts[[ik]], ignore.case = T)){ iFound = ik}
    }
    if (iFound>0)
    {
      iPart = xParts[[iFound]]
      xPeople =  unlist(strsplit(iPart, '<span class=\"data_data\">'))
      xList   = list()
      if (length(xPeople)>=2)
      {
        for (ip in 2:length(xPeople))
        {
          # ip = 2
          p.url  = trimws(gsub('<a href=','', gsub('"','', word(xPeople[[ip]],1,1, '>'))))        ; CATln(p.url)
          p.name = trimws(str.extract(gsub('"','', word(xPeople[[ip]],1,1, '</span>')),'>','<'))  ; CATln(p.name)
          p.position = trimws(word(gsub('"','', word(xPeople[[ip]],2,2, '</span>')),2,2,'>'))     ; CATln(p.position)
          xList[[ip]] = data.table(member='BOARD', people_name=p.name, position=p.position, people_url=p.url)
        }
        
        xALL = rbindlist(xList)
        if (nrow(xALL)>0) { 
          xALL[, rank:=seq.int(1,.N)]
          My.Kable.All(xALL)
          PEOPLE_ALL = rbind(PEOPLE_ALL, xALL, fill=T)}
      }
    }
    
    iFound = 0
    for (ik in 1:length(xParts))
    {
      if (grepl('^Executive', xParts[[ik]], ignore.case = T)){ iFound = ik}
    }
    
    if (iFound>0)
    {
      iPart = xParts[[iFound]]
      xPeople =  unlist(strsplit(iPart, '<span class=\"data_data\">'))
      xList   = list()
      if (length(xPeople)>=2)
      {
        for (ip in 2:length(xPeople))
        {
          # ip = 2
          p.url  = trimws(gsub('<a href=','', gsub('"','', word(xPeople[[ip]],1,1, '>'))))        ; CATln(p.url)
          p.name = trimws(str.extract(gsub('"','', word(xPeople[[ip]],1,1, '</span>')),'>','<'))  ; CATln(p.name)
          p.position = trimws(word(gsub('"','', word(xPeople[[ip]],2,2, '</span>')),2,2,'>'))     ; CATln(p.position)
          xList[[ip]] = data.table(member='EXECUTIVES', people_name=p.name, position=p.position, people_url=p.url)
        }
        xALL = rbindlist(xList)
        if (nrow(xALL)>0) { 
          xALL[, rank:=seq.int(1,.N)]
          My.Kable.All(xALL)
          PEOPLE_ALL = rbind(PEOPLE_ALL, xALL, fill=T)}
      }
    }
    if (nrow(PEOPLE_ALL)>0)
    {
      PEOPLE_ALL[, name:=toupper(xCompanyName)]
      PEOPLE_ALL[, source:='WSJ']
      PEOPLE_ALL[, codesource:=WSJ_CODE]
      PEOPLE_ALL[, date:=Sys.Date()]
      PEOPLE_ALL[,position:=gsub('&amp;','&', position)]
      My.Kable.All(PEOPLE_ALL[, -c('people_url')])
    }
  }
  return(PEOPLE_ALL)
}

# ==================================================================================================
UPDATE_FIELD_HOME = function(pData)  {
  # ------------------------------------------------------------------------------------------------
  # if ('stkhome' %in% names(pData) & 'indhome' %in% names(pData))
  # {
  #   pData[!is.na(stkhome), home:=stkhome]
  #   pData[!is.na(indhome), home:=indhome]
  #   if ('curhome' %in% names(pData))  { pData[!is.na(curhome), home:=curhome]}
  #   pData = pData[, -c('indhome', 'stkhome', 'curhome')]
  # }
  if ('stksample' %in% names(pData)) { pData[!is.na(stksample), sample:=stksample] }
  if ('indsample' %in% names(pData)) { pData[!is.na(indsample), sample:=indsample] }
  
  if ('curhome'   %in% names(pData)) { pData[!is.na(curhome),   home:=curhome] }
  if ('stkhome'   %in% names(pData)) { pData[!is.na(stkhome),   home:=stkhome] }
  if ('indhome'   %in% names(pData)) { pData[!is.na(indhome),   home:=indhome] }
  
  pData = pData[, -c('indhome', 'stkhome', 'curhome', 'stksample', 'indsample')]
  return(pData)
}

# ==================================================================================================
MERGE_DATASTD_BYCODE = function(pData, pOption='STD', ToKable=F) {
  # ------------------------------------------------------------------------------------------------
  # CATln("Merging STD ...")
  DBL_RELOAD_INSREF()
  switch(pOption,
         "SHORT" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat)], all.x=T, by='code', ignore.case=T)
         },
         "STD" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'indhome', 'stkhome', 'indsample', 'stksample', 'capiusd')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, indhome=as.numeric(indhome), 
                                     stkhome, indsample, stksample, capiusd)], all.x=T, by='code', ignore.case=T)
         },
         "FINAL" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'scat', 'home', 'sample', 'isin')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, scat, home=as.numeric(home), sample=as.numeric(sample), isin)], 
                         all.x=T, by='code', ignore.case=T)
         },
         "CAPIUSD" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'indhome', 'stkhome', 'indsample', 'stksample', 'capiusd')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, indhome=as.numeric(indhome), 
                                     stkhome, indsample, stksample, capiusd)], all.x=T, by='code', ignore.case=T)
         },
         "ADVANCED" = {
           pData = merge(pData[, -c('iso2', 'country', 'continent', 'name', 'type', 'fcat', 'indhome', 'stkhome', "isin", 'symbol', 'provider', 'cur', 'capiusd', 
                                    'indsample', 'stksample')], 
                         ins_ref[, .(code, iso2, country, continent, name=short_name, type, fcat, indhome=as.numeric(indhome), 
                                     stkhome, indsample, stksample, isin, symbol, provider, cur, capiusd)], all.x=T, by='code', ignore.case=T)
         }
  )
  # str(pData)
  pData[, name:=trimws(toupper(name))]
  pData = UPDATE_FIELD_HOME(pData)
  # library(data.table)
  # pData = as.data.table(pData)
  pData = pData %>% dplyr::select('iso2', 'country', 'continent', 'type', 'name', 'code', 'date', everything())
  if (ToKable) {  My.Kable.MaxCols(pData) }
  return(pData)
}

# ==================================================================================================
CLEAN_COLNAMES = function(dt) {
  # ------------------------------------------------------------------------------------------------
  xt = dt
  colnames(xt) =  trimws(gsub("\\.","_", gsub("[*]", "", gsub('%','percent_', gsub(' ','',gsub('-','_',tolower(colnames(xt))))))))
  return(xt)
}

# ==================================================================================================
CCPR_SETNAMES = function(pData, OldName, NewName){
  # ------------------------------------------------------------------------------------------------
  # pData = my_data
  if (OldName %in% names(pData)) { setnames(pData, OldName, NewName)}
  return(pData)
}

# ==================================================================================================
MERGE_DATASRC_CODE_BYCODESOURCE = function(pSource='BLG', pData) {
  # ------------------------------------------------------------------------------------------------
  xData = pData
  
  ParseFilter = paste0('!is.na(', tolower(pSource),')')
  ParseFields = paste0('.(codesource=', tolower(pSource), ',code)') 
  # dt_extract = dt_raw[eval(parse(text=pCondition))]
  xRef = ins_ref[eval(parse(text=ParseFilter)), eval(parse(text=ParseFields))]
  xData = merge(xData[, -('code')], xRef, all.x=T, by='codesource')
  return(xData)
}

# ==================================================================================================
DOWNLOAD_YAH_INS_PRICES_UNADJ = function(p_nbdays_back, tickers, freq.data, p_saveto="", NbTry=10) {
  # ------------------------------------------------------------------------------------------------
  DBL_RELOAD_INSREF()
  # p_nbdays_back=100; tickers = ('^TYX'); freq.data="daily"; p_saveto=paste0(UData, "download_yah_bnd_prices.rds")
  # p_nbdays_back=10000; tickers = ('IBM'); freq.data="daily"; p_saveto=paste0(UData, "download_yah_stkin_prices.rds")
  # p_nbdays_back=10000; tickers = ('^N225'); freq.data="daily"; p_saveto=paste0(UData, "download_yah_indin_prices.rds")
  # p_nbdays_back=100; tickers = ('JPY=X'); freq.data="daily"; p_saveto=paste0(UData, "download_yah_cur_prices.rds")
  # p_nbdays_back=100; tickers = ('BTC-USD'); freq.data="daily"; p_saveto=paste0(UData, "download_yah_curcry_prices.rds")
  # dt = DOWNLOAD_YAH_INS_PRICES(p_nbdays_back=100, tickers=('^TYX'), freq.data="daily", p_saveto=paste0(SData, "download_yah_bnd_prices.rds"))
  # p_nbdays_back=100; tickers = ('2317.TW'); freq.data="daily"; p_saveto='"; NbTry=10
  gc()
  # NbTry=1
  # p_nbdays_back=100000; tickers = ('RXRX'); freq.data="daily"; p_saveto=''
  Divider = 2
  
  NrTry       = 0
  NbDays_ToDo = p_nbdays_back*Divider
  ToContinu   = T
  CATln('') ; CATln_Border(tickers)
  CATln('')
  while (ToContinu & NrTry<=NbTry)
  {
    NrTry       = NrTry+1
    NbDays_ToDo = floor(NbDays_ToDo/(Divider))
    print(paste('try ', NrTry, '=', NbDays_ToDo))
    
    first.date <- Sys.Date() - NbDays_ToDo
    last.date <- Sys.Date()
    file_dir = list.files(path=file.path(tempdir(), 'BGS_Cache'), "*.rds$", full.names = T)
    file.remove(file_dir)
    l.out = try(yfR::yf_get(tickers = tickers, 
                            first_date = first.date,
                            last_date  = last.date, 
                            freq_data  = 'daily',
                            be_quiet = T,
                            cache_folder = file.path(tempdir(), 'BGS_Cache') )) # cache in tempdir
    if (all(class(l.out)!='try-error'))
    {
      nrow(l.out)
      if (length(l.out)>0 && nrow(l.out)>0) { ToContinu = F }
    } else { ToContinu = F }
  }
  
  if (all(class(l.out)!="try-error"))
  {
    my_data = setDT(l.out)
    
    # My.Kable(my_data)
    # str(my_data)
    if (nrow(my_data)>0)
    {
      my_data = CLEAN_COLNAMES(my_data)
      colnames(my_data) = gsub("price_","", colnames(my_data))
      my_data = CCPR_SETNAMES(my_data, "ref_date", "date")
      my_data[, ":="(source="YAH", codesource=ticker, code=as.character(NA))]
      
      my_data = CCPR_SETNAMES(my_data, "ret_closing_prices", "ret_closing")
      my_data = CCPR_SETNAMES(my_data, "ret_adjusted_prices", "ret_adjusted")
      my_data = CCPR_SETNAMES(my_data, "cumret_adjusted_prices", "cumret_adjusted")
      my_data = CCPR_SETNAMES(my_data, "adjusted", "closeadj")
      my_data = unique(my_data, by=c('codesource', 'date'))[!is.na(codesource) & !is.na(date)]
      my_data = MERGE_DATASRC_CODE_BYCODESOURCE("YAH", my_data)
      
      if ('closeadj' %in% names(my_data))
      {
        my_data[, close_adj:=closeadj]
        my_data[!is.na(close_adj), ':='(
          change = (close_adj-shift(close_adj)),
          rt     = (close_adj/shift(close_adj))-1, 
          lnrt   = log((close_adj/shift(close_adj)))
        ) , by='codesource']
        my_data[, ':='(var=rt, varpc=100*rt)]
      }
      my_data = MERGE_DATASTD_BYCODE(my_data, pOption = 'FINAL')
      list_first = c( "date", "close", "source", "codesource", "code")
      setcolorder(my_data, c(list_first, setdiff(colnames(my_data), list_first)))
      
      My.Kable.TB(my_data)
      # str(my_data)
    } else { my_data=data.table()}
  } else { my_data=data.table()}
  # str(my_data)
  return(my_data)
}

# ==================================================================================================
LOOP_YAH_PRICES_AIO  = function(Codes_From = 'ASX', Save_Folder='S:/R/DATA/PRICES/', Save_File='DOWNLOAD_ASX_PRICES_RAW.rds', 
                                NB_GROUP    = 20, NB_MIN = 100, NbDays = 10000, pSleep = 1, 
                                ToPrompt=F, FillEmpty = T, 
                                LastUpdate = '2024-02-28',    LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = T) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  # MyPC = toupper(TRAINEE_GET_MYPC())
  
  
  switch(Codes_From,
         'ASX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0('S:/', 'R/DATA/BOARD/LIST/LIST_CODES_ASX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SGX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0('S:/', 'R/DATA/BOARD/LIST/LIST_CODES_SGX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SET' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SET.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'IDX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_IDX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'HKE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_HKE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'TWSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_TWSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'JPX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_JPX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'KRX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_KRX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SZSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SZSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'PSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_PSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'MYS' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_MYS.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'VNM' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_VNM.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         {
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_', Codes_From, '.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         }
  )
  
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    # Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = T)
    Data_Old  = readRDS(paste0(Save_Folder, Save_File))
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>LastUpdate]$codesource]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL 
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 20
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = '14D.AX'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL), '/', nrow(LIST_CODES), '=', pCode))
      # pCode = '8CO.AX'
      xDay = CHECK_CLASS(try(DOWNLOAD_YAH_INS_PRICES_UNADJ(p_nbdays_back=NbDays,
                                                           tickers=pCode, freq.data='daily', p_saveto="", NbTry=15)))
      
      Sys.sleep(pSleep)
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        xList[[k]] = xDay
        # str(xDay)
        
      }
      # if (FillEmpty & nrow(xDay)==0){
      #   xList[[k]] = data.table(source=pSource, codesource=pCode, date=Sys.Date(), close=as.numeric(NA), updated=as.character(Sys.Date()))
      # }
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          Data_Old = unique(Data_Old, by=c('codesource', 'date'))
          My.Kable(Data_Old)
          # CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
          saveRDS(Data_Old,paste0( Save_Folder, Save_File))
        }
      }
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    # CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    saveRDS(Data_Old,paste0( Save_Folder, Save_File))
    CATln_Border(paste0( Save_Folder, Save_File))
    Sys.sleep(5)
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}

# ==================================================================================================
catrep = function(l.char, n.times)  {
  # ------------------------------------------------------------------------------------------------
  cat("\r", strrep(l.char, n.times), "\n")
}


# ==================================================================================================
CCPR_SAVERDS = function(pData=ins_ref, FileFolder=SData, FileName='download_ssi_stkvn_ref_history.rds' , 
                        SaveOneDrive=T, ToKable=F, ToSummary=F, ToPrompt=T)
{
  # ------------------------------------------------------------------------------------------------
  # ODDrive = 'D:/OneDrive/'
  CATln('CCPR_SAVERDS in CCPR')
  if (ToKable) { My.Kable.Min(pData) }
  ODDrive_Data = paste0(ODDrive, substr(FileFolder,1,1), word(FileFolder,2,2,":"))
  if (!file.exists(ODDrive_Data))
  {
    try(dir.create(ODDrive_Data, recursive=T))
  }
  FullPath_Local   = paste0(FileFolder, FileName)
  FullPath_ODDrive = paste0(ODDrive_Data, FileName)
  if (ToPrompt) { CATln_Border(paste('SAVE LOCAL = ', FullPath_Local, '-', substr(Sys.time(),1,19))) }
  if (ToPrompt) { CATrp('Saving ...') }
  saveRDS(pData, tolower(FullPath_Local))
  # x = readRDS(tolower(FullPath_Local)); My.Kable.Min(x)
  if (ToSummary) { try(CCPR_WRITE_SUMMARY_CURRENT(pData=pData, pFileName=FullPath_Local, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
  if (ToSummary) { try(CCPR_WRITE_SUMMARY_UPDATED(pData=pData, pFileName=FullPath_Local, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
  if (ToPrompt) { CATln('Done.') }
  
  if (SaveOneDrive)
  {
    if (ToPrompt) { CATln_Border(paste('SAVE ONEDRIVE = ', FullPath_ODDrive, '-', substr(Sys.time(),1,19))) }
    if (ToPrompt) { CATrp('Saving ...') }
    saveRDS(pData, FullPath_ODDrive)
    if (ToSummary) { try(CCPR_WRITE_SUMMARY_CURRENT(pData=pData, pFileName=FullPath_ODDrive, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
    # if (ToSummary) { try(CCPR_WRITE_SUMMARY_UPDATED(pData=pData, pFileName=FullPath_ODDrive, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T)) }
    if (ToPrompt) { CATln('Done.') }
  }
}


# ==================================================================================================
TRAINEE_LOOP_DOWNLOAD_YAH_PRICES_VOLUME = function () {
  # TRAINEE_LOOP_DOWNLOAD_YAH_PRICES_VOLUME()
  # ------------------------------------------------------------------------------------------------
  LOOP_YAH_PRICES_VOLUME_AIO  (Codes_From = 'ASX', Save_Folder='S:/R/DATA/PRICES/', Save_File='DOWNLOAD_ASX_PRICES_RAW.rds', 
                               NB_GROUP    = 20, NB_MIN = 10, NbDays = 500,  ToPrompt=F, FillEmpty = T, 
                               LastUpdate = '2024-02-28',    LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = F) 
  Sys.sleep(5)
  LOOP_YAH_PRICES_VOLUME_AIO(Codes_From = 'SGX', Save_Folder='S:/R/DATA/PRICES/', Save_File='DOWNLOAD_SGX_PRICES_RAW.rds', 
                             NB_GROUP    = 20, NB_MIN = 10, NbDays = 10000,  ToPrompt=F, FillEmpty = T, 
                             LastUpdate = '2024-02-28',    LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = F) 
}

# ==================================================================================================
RELOAD_INSREF = function ( silent=T, ToForce=F, DBL = T) {
  # ------------------------------------------------------------------------------------------------
  # 2023-09-14
  # if (file.exists("U:/EFRC/DATA/")) { UData = "U:/EFRC/DATA/" } else { UData = 'S:/CCPR/DATA/' }
  # silent=T; ToForce=F; DBL = T
  
  if (ToForce)
  {
    if (file.exists(UData)) 
    { 
      CATln('Loading ..')
      ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T) 
    }   else {
      CATln('Loading ..')
      ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T) 
    }
    
    assign("ins_ref", ins_ref, envir = .GlobalEnv)
  } else {
    if (exists("ins_ref")) 
    { 
      if (!silent) 
      { CATln("INS_REF ALREADY LOADED") }
    } else { 
      # UData = SData
      CATln('Loading ..')
      if (file.exists(UData)) 
      { 
        ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
      } else {
        ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
      }
      
      assign("ins_ref", ins_ref, envir = .GlobalEnv)
    }
  }
  
  if (DBL)
  {
    # ins_ref = CCPR_READRDS(SData, 'DBL_INS_REF.rds', ToKable = T, ToRestore = T)
    
    if (exists("ins_ref")) 
    { 
      if (!silent) 
      { CATln("INS_REF ALREADY LOADED") }
    } else { ins_ref = CCPR_READRDS(SData, 'DBL_INS_REF.rds', ToKable = T, ToRestore = T)}
    assign("ins_ref", ins_ref, envir = .GlobalEnv)
  }
}

# ==================================================================================================
TRAINEE_RELOAD_INSREF = function ( silent=T, ToForce=F) {
  # ------------------------------------------------------------------------------------------------
  # 2023-09-14
  # if (file.exists("U:/EFRC/DATA/")) { UData = "U:/EFRC/DATA/" } else { UData = 'S:/CCPR/DATA/' }
  
  
  if (ToForce)
  {
    if (file.exists(UData)) 
    { 
      CATln('Loading ..')
      ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T) 
    }   else {
      CATln('Loading ..')
      ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T) 
    }
    
    assign("ins_ref", ins_ref, envir = .GlobalEnv)
  } else {
    if (exists("ins_ref")) 
    { 
      if (!silent) 
      { CATln("INS_REF ALREADY LOADED") }
    } else { 
      # UData = SData
      CATln('Loading ..')
      if (file.exists(UData)) 
      { 
        ins_ref = CCPR_READRDS(UData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
      } else {
        ins_ref = CCPR_READRDS(SData, 'EFRC_INS_REF.rds', ToKable = T, ToRestore = T)
      }
      assign("ins_ref", ins_ref, envir = .GlobalEnv)
    }
  }
}

# ==================================================================================================
LOOP_YAH_DIVIDEND_AIO  = function(Codes_From = 'ASX', Save_Folder='S:/R/DATA/DIVIDEND/', Save_File='DOWNLOAD_ASX_DIVIDEND_RAW.rds', 
                                  NB_GROUP    = 20, NB_MIN = 100, NbDays = 10000,  ToPrompt=F, FillEmpty = T, 
                                  LastUpdate = '2024-02-28',    LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = T) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  MyPC = toupper(TRAINEE_GET_MYPC())
  
  switch(Codes_From,
         'ASX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_ASX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SGX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SGX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SET' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SET.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'IDX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_IDX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'HKE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_HKE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'TWSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_TWSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         }
  )
  
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = T)
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>LastUpdate]$codesource]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL 
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 20
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = '14D.AX'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL), '/', nrow(LIST_CODES), '=', pCode))
      switch(Codes_From,
             'ASX' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_DIVIDEND  ( pCode = pCode,  Nbdays = NbDays, silent = T, ToKable = T)))
               # TRAINEE_DOWNLOAD_YAH_DIVIDEND = function(pCode = 'AMZN', Nbdays = 10000, ToKable = T, silent = T)
             }
      )
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        xList[[k]] = xDay
        # str(xDay)
        
      }
      # if (FillEmpty & nrow(xDay)==0){
      #   xList[[k]] = data.table(source=pSource, codesource=pCode, date=Sys.Date(), close=as.numeric(NA), updated=as.character(Sys.Date()))
      # }
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          Data_Old = unique(Data_Old, by=c('codesource', 'date'))
          My.Kable(Data_Old)
          CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
          Sys.sleep(3)
        }
      }
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}

# ==================================================================================================
LOOP_YAH_PRICES_VOLUME_AIO  = function(Codes_From = 'ASX', Save_Folder='S:/R/DATA/PRICES/', Save_File='DOWNLOAD_ASX_PRICES_RAW.rds', 
                                       NB_GROUP    = 20, NB_MIN = 100, NbDays = 10000,  ToPrompt=F, FillEmpty = T, 
                                       LastUpdate = '2024-02-28',    LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = T) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  # MyPC = toupper(TRAINEE_GET_MYPC())
  
  switch(Codes_From,
         'ASX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0('S:/', 'R/DATA/BOARD/LIST/LIST_CODES_ASX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SGX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0('S:/', 'R/DATA/BOARD/LIST/LIST_CODES_SGX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'SET' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_SET.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'IDX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_IDX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'HKE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_HKE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         },
         'TWSE' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_TWSE.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_yah]
         }
  )
  
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    # Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = T)
    Data_Old  = readRDS(paste0(Save_Folder, Save_File))
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>LastUpdate]$codesource]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL 
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 20
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = '14D.AX'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL), '/', nrow(LIST_CODES), '=', pCode))
      switch(Codes_From,
             'ASX' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME  ( pCode = pCode, Frequency = 'daily', Nbdays = NbDays, Silent = T, ToKable = T)))
             },
             'SGX' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME  ( pCode = pCode, Frequency = 'daily', Nbdays = NbDays, Silent = T, ToKable = T)))
             },
             'SET' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME  ( pCode = pCode, Frequency = 'daily', Nbdays = NbDays, Silent = T, ToKable = T)))
             },
             'IDX' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME  ( pCode = pCode, Frequency = 'daily', Nbdays = NbDays, Silent = T, ToKable = T)))
             },
             'HKE' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME  ( pCode = pCode, Frequency = 'daily', Nbdays = NbDays, Silent = T, ToKable = T)))
             },
             'TWSE' = {
               # pCode = '8CO.AX'
               xDay = CHECK_CLASS(try(TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME  ( pCode = pCode, Frequency = 'daily', Nbdays = NbDays, Silent = T, ToKable = T)))
             }
      )
      
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        xList[[k]] = xDay
        # str(xDay)
        
      }
      # if (FillEmpty & nrow(xDay)==0){
      #   xList[[k]] = data.table(source=pSource, codesource=pCode, date=Sys.Date(), close=as.numeric(NA), updated=as.character(Sys.Date()))
      # }
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          Data_Old = unique(Data_Old, by=c('codesource', 'date'))
          My.Kable(Data_Old)
          saveRDS(Data_Old, paste0(Save_Folder, Save_File))
          # CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
        }
      }
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    # CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    saveRDS(Data_Old, paste0(Save_Folder, Save_File))
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}

# ==================================================================================================
Format.Number = function(NumberStr, l.decimal)  {
  # ------------------------------------------------------------------------------------------------
  return(format(NumberStr, digits = 2, nsmall = l.decimal, big.mark = ","))
}
# ==================================================================================================
My.Kable = function(l.Table, Nb=3, l.Text="", HeadOnly=F, ClearScreen=F) {
  # ------------------------------------------------------------------------------------------------
  # l.Table = x.ins
  if (ClearScreen) { cat("\014")}
  cat("\r\r")
  if (nrow(l.Table)>0)
  {
    if (nchar(l.Text)>0) { cat(l.Text) }
    print(kable(format.args = list(decimal.mark = ".", big.mark = ","),
                head(l.Table, min(Nb,nrow(l.Table))), format="markdown"))
    # cat("")
    if (! HeadOnly)
    {
      print(kable(format.args = list(decimal.mark = ".", big.mark = ","),
                  tail(l.Table, min(Nb,nrow(l.Table))), format="markdown"))
    }
    # print("", quote=F)
    print(paste(Format.Number(nrow(l.Table),0), "records"), quote = F)
  } else
  { print("No data ...", quote=F)}
}

# ==================================================================================================
TRAINEE_DOWNLOAD_ASX_BOARD_GENDER_BY_CODE = function(pCode = "29m", yah_ext = '.AX', ToKable = T, Silent = T) {
  # ------------------------------------------------------------------------------------------------
  #pCode = "29m"; yah_ext = '.AX'; ToKable = T; Silent = T
  pURL = paste0("https://asx.api.markitdigital.com/asx-research/1.0/companies/", pCode, "/about")
  GC_SILENT(Silent)
  company = try(fromJSON(pURL), silent = TRUE)
  my_data = data.table(
    codesource = pCode,
    updated    = substr(as.character(Sys.time()), 1,19)
  )
  
  if (all(class(company) != "try-error")) 
  {
    com_name        = company$data$displayName
    current_time    = Sys.time()
    formatted_time  = format(current_time, "%Y-%m-%d")
    # formatted_time <- paste("Last Update:", formatted_time)
    
    if ("directors" %in% names(company$data)) 
    {
      names_df = TRAINEE_EXTRACT_NAMES(company$data$directors$name)
      my_data  = as.data.table(company$data$directors)
      my_data  = cbind(my_data, names_df)
      com_name = company$data$displayName
      
      my_data = my_data[, ':='(
        source       = 'ASX',
        yah_code     = paste0(pCode, yah_ext),
        codesource   = pCode,
        company_name = com_name,
        date         = formatted_time,
        updated      = substr(as.character(Sys.time()),1,19),
        id           = seq.int(1, .N)
      )]
      my_data[, ':='(ceo = as.numeric(NA), cob = as.numeric(NA), gender = as.character(NA))]
      my_data[grepl('^Mr.|^Dr.', name), gender := 'MALE'] 
      my_data[grepl('^Ms.|^Mrs.', name), gender := 'FEMALE']
      
      for (i in 1:nrow(my_data)) 
      {
        if (is.na(my_data[i, "gender"])) 
        {
          xname = trimws(as.character(my_data[i, "first_name"]))
          if (!is.na(xname) && nchar(xname) > 0) 
          {  # Check if xname is not NA and not empty
            FName = gender(xname)
            if (!is.null(FName) && nrow(FName) > 0) 
            {
              if (FName$proportion_male > 0.95 || FName$proportion_female > 0.95) 
              {
                GName = FName$gender
                my_data[i, "gender"] = toupper(GName)
              }
            }
          }
        }
      }
      
      ceo_rows = is.na(my_data$ceo) & grepl('CEO|General Manager|Chief Executive Officer$', my_data$title, ignore.case = TRUE)
      cob_rows = is.na(my_data$cob) & grepl('Chair|Chairman|Chairwoman', my_data$title, ignore.case = TRUE)
      
      my_data$ceo = ifelse(ceo_rows, 1, my_data$ceo)
      my_data$cob = ifelse(cob_rows, 1, my_data$cob)
      
      my_data = my_data[, c("id", "source", "yah_code", "codesource", "company_name", "name", "title", "gender", "first_name", 
                            "last_name", "ceo", "cob","date", "updated"), with = TRUE]
    } 
    if (nrow(my_data) > 0 & nrow(my_data[cob == 1]) == 0 & nrow(my_data[cob == 1]) && nrow(my_data[id == 1 & grepl("Chair", title)]) )
    {
      my_data[id == 1, cob := 1]
    }
    
  } 
  
  if (ToKable)  { My.Kable.All(my_data) }
  return(my_data)
}


# ==================================================================================================
My.Kable.All = function(pData, l.Text='') {
  # ------------------------------------------------------------------------------------------------
  My.Kable(pData, HeadOnly = T, Nb=nrow(pData), l.Text=l.Text)
}

# ==================================================================================================
CCPR_READRDS = function(FileFolder=UData, FileName='download_hsx_stkvn_prices.rds', ToKable=F, ToPrompt=F, ToRestore=T) {
  # ------------------------------------------------------------------------------------------------
  # 
  CATln(paste(' Loading : ', paste0(FileFolder, FileName), '...'))
  Data_Local       = data.table()
  ODDrive_Data     = paste0(ODDrive, substr(FileFolder,1,1), word(FileFolder,2,2,":"))
  FullPath_Local   = paste0(FileFolder, FileName)
  FullPath_ODDrive = paste0(ODDrive_Data, FileName)
  if (ToPrompt)
  {
    ToPrompt = T
    CATln(FullPath_Local)
    CATln(FullPath_ODDrive)
  }
  if (file.exists(FullPath_Local))
  {
    Success = F
    NbTry   = 1
    while (!Success & NbTry <= 3)
    {
      Data_Local = try(readRDS(tolower(FullPath_Local)))
      if (all(class(Data_Local)!='try-error'))
      {
        if (! 'updated' %in% names (Data_Local)) { Data_Local [, updated:= as.character (NA)]}
        Success = T
        if (ToKable)
        {
          ToKable = T
          My.Kable.Min(Data_Local[order(date)])
        }
      }
      NbTry = NbTry+1
    }
    
    if (!Success)
    {
      if (file.exists(FullPath_ODDrive))
      {
        Success = F
        NbTry   = 1
        while (!Success & NbTry <= 3)
        {
          Data_ODDrive = try(readRDS(FullPath_ODDrive))
          if (! 'updated' %in% names (Data_ODDrive)) { Data_ODDrive [, updated:= as.character (NA)]}
          if (all(class(Data_ODDrive)!='try-error'))
          {
            Success = T
            if (ToKable)
            {
              ToKable = T
              My.Kable.MaxCols(Data_ODDrive)
            }
          }
          NbTry = NbTry+1
        }
        if (Success)
        {
          Data_Local = copy(Data_ODDrive)
          if (ToRestore)
          {
            CATln(paste('Restoring ... ', FullPath_Local))
            try(saveRDS(Data_Local, FullPath_Local))
            CATln('Done.')
          }
        }
      }
    }
  }
  if (nrow(Data_Local)>0 & "x" %in% names(Data_Local)) { Data_Local$x = NULL}
  return(Data_Local)
}

# ==================================================================================================
My.Kable.Min = function(pData, MinFields = c('provider', 'type', 'fcat', 'scat', 'country', 'iso2', 'source', 'codesource', 
                                             'symbol', 'home', 'sample', 'market', 'code', 'name', 'date', 'datetime', 'timestamp', 'shares',
                                             'reference', 'dataset', 'datatype', 'close', 'close_adj', 'volume', 'rt'), Nb=5) {
  # ------------------------------------------------------------------------------------------------
  # pData = CCPR_READRDS(UData, 'download_ifrc_indvli_history.rds')
  # pData = CCPR_READRDS(UData, 'download_rts_stkhome_history.rds')
  CommonFields = intersect(MinFields,names(pData))
  My.Kable.TB(pData[, ..CommonFields], Nb=Nb)
}

# ==================================================================================================
My.Kable.TB = function(l.Table, HeadOnly=F, Nb=3, l.Text="")  {
  # ------------------------------------------------------------------------------------------------
  # l.Table =
  # library(knitr)
  # l.Text=""; Nb=3
  # l.Table = readRDS("u:/efrc/data/efrc_indipo_history.rds")
  cat("\r\r")
  if (nrow(l.Table)>0)
  {
    if (!HeadOnly) {l.Table.TB = rbind( head(l.Table, min(Nb,nrow(l.Table))), tail(l.Table, min(Nb,nrow(l.Table))), fill=T)} else {
      l.Table.TB = head(l.Table, min(Nb,nrow(l.Table))) }
    if (nchar(l.Text)>0) { cat(l.Text,"\n") }
    print(knitr::kable(format.args = list(decimal.mark = ".", big.mark = ","), l.Table.TB, format="markdown"))
    print(paste(Format.Number(nrow(l.Table),0), "records"), quote = F)
  } else
  { print("No data ...", quote=F)}
}


# ==================================================================================================
TRAINEE_LOOP_BOARD_EXCHANGE = function(Codes_From = 'ASX', Save_Folder='S:/R/DATA/BOARD/', Save_File='DOWNLOAD_ASX_BOARD_RAW.rds', 
                                       NB_GROUP    = 20, NB_MIN = 100, ToPrompt=F, FillEmpty = T, 
                                       LastUpdate  = '2024-02-28', LookAt = 'UPDATED', ToSummary = F, SaveOneDrive = T) {
  # ------------------------------------------------------------------------------------------------
  # CCPR_DOWNLOAD_STB_STKVN_PRICES_BY_CODE
  
  MyPC = toupper(TRAINEE_GET_MYPC())
  
  switch(Codes_From,
         'ASX' = { 
           LIST_CODES = setDT(openxlsx::read.xlsx(paste0(SDrive, 'R/DATA/BOARD/LIST/LIST_CODES_ASX.xlsx'), sheet='LIST'))
           LIST_CODES = LIST_CODES[order(code_exchange)]
           My.Kable(LIST_CODES)
           List_Codesource = LIST_CODES[, codesource:=code_exchange]
         }
  )
  
  if (file.exists(paste0(Save_Folder, Save_File))) 
  {
    Data_Old  = CCPR_READRDS(Save_Folder, Save_File, ToKable = T, ToRestore = T)
    UPDATE_UPDATED (Data_Old)
    # if ('updated' %in% names(Data_Old)) { Data_Old[, updated:=substr(as.character(updated),1,19)]}
    My.Kable(Data_Old)
  } else {Data_Old = data.table() }
  
  
  if (nrow(Data_Old)>0) { 
    switch(LookAt,
           'UPDATED' = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>LastUpdate]$codesource]},
           'DATE'    = { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]},
           { LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[date>=LastUpdate]$codesource]}
    )
    # LIST_TOTAL = List_Codesource[!codesource %in% Data_Old[updated>LastUpdate]$codesource]
    LIST_TODO = LIST_TOTAL 
  } else { 
    LIST_TOTAL = List_Codesource
    LIST_TODO = List_Codesource 
  }
  
  My.Kable(LIST_TODO)
  
  if (nrow(LIST_TODO)>0)
  {
    xList     = list()
    NB_TODO   = min(nrow(LIST_TODO), NB_MIN)
    CATln(NB_TODO)
    
    for (k in 1:NB_TODO)
    {
      # k = 1
      xDay = data.table()
      pCode = LIST_TODO[k]$codesource
      # pCode = 'VNM.VN'
      CATln('')
      CATln_Border(paste(Codes_From,':', k, '/', NB_TODO, '/', nrow(LIST_TOTAL), '/', nrow(LIST_CODES), '=', pCode))
      switch(Codes_From,
             'ASX' = {
               xDay  = CHECK_CLASS(try(TRAINEE_DOWNLOAD_ASX_BOARD_GENDER_BY_CODE(pCode = pCode, yah_ext = '.AX', ToKable = T, Silent = T)))
             }
      )
      
      if (nrow(xDay)>0)
      {
        xDay[, updated:=substr(as.character(Sys.time()),1,19)]
        xList[[k]] = xDay
        # str(xDay)
        
      }
      # if (FillEmpty & nrow(xDay)==0){
      #   xList[[k]] = data.table(source=pSource, codesource=pCode, date=Sys.Date(), close=as.numeric(NA), updated=as.character(Sys.Date()))
      # }
      
      # xList[[1013]]
      if (k %% NB_GROUP == 0 | k == nrow(LIST_TODO))
      {
        xALL = rbindlist(xList, fill=T)
        if (nrow(xALL)>0)
        {
          Data_Old = rbind(Data_Old, xALL, fill = T)
          Data_Old = unique(Data_Old, by=c('codesource', 'date', 'name', 'title'))
          My.Kable(Data_Old)
          CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
        }
      }
    }
    # Data_Old[, rt:=100*rt]
    # str(xALL)
    CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = F, SaveOneDrive = F)
    
  }
  # x = try(IFRC_CCPR_MONITOR_EXECUTION_SUMMARY(pOption=paste0(Action), pAction="SAVE", NbSeconds=3600, ToPrint = T))
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_DIVIDEND = function(pCode = 'IBM', Nbdays = 10000, ToKable = T, silent = T) {
  # ------------------------------------------------------------------------------------------------
  l.out = try(yfR::yf_get_dividends(ticker = pCode,
                                    first_date = Sys.Date() - Nbdays,
                                    last_date = Sys.Date()), silent = silent)
  if (all(class(l.out)!="try-error"))
  {
    my_data = setDT(l.out)
    if (nrow(my_data)>0){
      TRAINEE_RENAME_FIELD(my_data)
      my_data[, ":="(source="YAH", codesource=ticker, code=as.character(NA))]
    } 
  } else { my_data=data.table()}
  if (ToKable)  { My.Kable(my_data) }
  return(my_data)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_PRICES_VOLUME = function ( pCode = 'AMZX', Frequency = 'daily', Nbdays = 10000, Silent = T, ToKable = T) {
  # ------------------------------------------------------------------------------------------------
  l.out = try(yfR::yf_get(tickers    = pCode, 
                          first_date = Sys.Date() - Nbdays,
                          last_date  = Sys.Date(), 
                          freq_data  = Frequency,
                          be_quiet   = T,
                          cache_folder = file.path(tempdir(), 'BGS_Cache') ), silent = T) # cache in tempdir()
  
  if (all(class(l.out)!="try-error"))
  {
    my_data = setDT(l.out)
    # My.Kable(my_data)
    # str(my_data)
    if (nrow(my_data)>0)
    {
      TRAINEE_RENAME_FIELD(my_data)
      my_data[, ":="(source="YAH", codesource=ticker, code=as.character(NA))]
    }
  } else { 
    my_data <- data.table(source = 'YAH', codesource = pCode)
    set(my_data, j = names(my_data)[!names(my_data) %in% c("source", "codesource")], value = NA)
  }
  if (ToKable)  {My.Kable(my_data) }
  
  return(my_data)
}

# ==================================================================================================
TRAINEE_YAH_FUN_PARSE = function(page, selector) {
  # ------------------------------------------------------------------------------------------------
  data_values = html_nodes(page, xpath = selector)
  extracted_values = html_text(data_values)
  return(extracted_values)
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_ESG = function(pCode = 'AAPL', ToKable = T ) {
  # ------------------------------------------------------------------------------------------------
  
  url  = paste0("https://finance.yahoo.com/quote/", pCode, "/sustainability")
  page = suppressWarnings(read_html(url))
  #TIME
  time_str = html_text(html_node(page, "div#quote-market-notice"))
  if (grepl("At close: [A-Za-z]+ \\d+ \\d+:\\d+\\w+ EST", time_str)) 
  { time = strptime(sub("At close: ", "", time_str), "%B %d %I:%M%p")
  }   else    {  time = strptime(sub("At close: ", "", time_str), "%I:%M%p")    }
  
  date = format(time, "%Y-%m-%d")
  
  time_str       = TRAINEE_YAH_FUN_PARSE(page,'//*[@id="Col1-0-Sustainability-Proxy"]/section/div[3]/span[2]')
  date_parts     = strsplit(sub("Last updated on ", "", time_str), "/")[[1]]  
  formatted_time = paste0(date_parts[2], "-", date_parts[1])
  dat_funds      = data.table(
    source       = "YAH",
    codesource   = stock,
    date         = date,
    time_update  = formatted_time,
    esgRating    = TRAINEE_YAH_FUN_PARSE(page,'//*[@id="Col1-0-Sustainability-Proxy"]/section/div[1]/div/div[1]/div/div[3]/div/span'),
    esgScore.tot = TRAINEE_YAH_FUN_PARSE(page,'//*[@id="Col1-0-Sustainability-Proxy"]/section/div[1]/div/div[1]/div/div[2]/div[1]'),
    esgScore.env = TRAINEE_YAH_FUN_PARSE(page,'//*[@id="Col1-0-Sustainability-Proxy"]/section/div[1]/div/div[2]/div/div[2]/div[1]'),
    esgScore.soc = TRAINEE_YAH_FUN_PARSE(page,'//*[@id="Col1-0-Sustainability-Proxy"]/section/div[1]/div/div[3]/div/div[2]/div[1]'),
    esgScore.gov = TRAINEE_YAH_FUN_PARSE(page,'//*[@id="Col1-0-Sustainability-Proxy"]/section/div[1]/div/div[4]/div/div[2]/div[1]')
  )
  dat_funds = TRAINEE_CLEAN_COLNAMES(dat_funds)
  TRAINEE_RENAME_FIELD ( pData = dat_funds ) 
  if (ToKable)  {  My.Kable(dat_funds) }
  
  return(dat_funds)
}

# ==================================================================================================
TRAINEE_RENAME_FIELD = function( pData = data.table() ) {
  # ------------------------------------------------------------------------------------------------
  for (i in 1:length(names(pData)))
  {
    # i = 8
    
    old_field = names(pData) [i]
    FIELD_STANDARD = setDT(read_xlsx('S:/LIST/YAH_STANDARD_FIELDS.xlsx'))
    FIELD_STANDARD [, yah := trimws(yah) ]
    if (old_field %in% FIELD_STANDARD$yah) {
      new_field = FIELD_STANDARD[yah == old_field] $standard } else { new_field = old_field}
    
    setnames(pData, old_field, new_field)
  }
  return(pData)
}

# ==================================================================================================
TRAINEE_SEARCH_STRING_IN_LIST = function(pList = list(), pString = '') {
  # ------------------------------------------------------------------------------------------------
  Found        = F
  Found_String = as.character(NA)
  for (k in 1:length(pList))
  {
    if (!Found)
    {
      if (grepl(pString, pList[[k]]))
      {
        Found = T
        Found_String = pList[[k]]
      }
    }
  }
  return(Found_String)
} 

# ==================================================================================================
GC_SILENT = function(silent = T) {
  # ------------------------------------------------------------------------------------------------
  if(silent) invisible(gc(reset = T)) else gc(reset = T)
}

# ==================================================================================================
CCPR_LAST_TRADING_DAY_VN = function(pHH=9, ToPrompt=F, Option = 'TODAY') {
  # ------------------------------------------------------------------------------------------------
  # print(LAST_TRADING_DAY_VN())
  # x = CCPR_LAST_TRADING_DAY_VN (pHH=9, ToPrompt=F, Option = 'prev_date')
  RELOAD_CALENDAR_VN()
  xCalendar = idx_calendar.vn
  switch (Option,
          'TODAY' = { TradingDate = max(xCalendar[date<=SYSDATETIME(pHH)]$date)},
          { TradingDate = max(xCalendar[date<=SYSDATETIME(pHH)]$prv_date, na.rm = T)}
          
  )
  
  if (ToPrompt) { CATln(paste('CCPR_LAST_TRADING_DAY_VN,',pHH, '=', TradingDate)) }
  return(TradingDate)
}

# ==================================================================================================
RELOAD_CALENDAR_VN = function(ToReload = F) {
  # ------------------------------------------------------------------------------------------------
  # DEV_RELOAD_CALENDAR_VN()
  if (ToReload)
  {
    if ( file.exists(paste0(UData, 'idx_calendar.vn.rds')))
    {
      idx_calendar.vn = readRDS(paste0(UData, 'idx_calendar.vn.rds'))
    }else{
      idx_calendar.vn = readRDS(paste0('S:/R/', 'idx_calendar.vn.rds'))
    }
    assign("idx_calendar.vn", idx_calendar.vn, envir = .GlobalEnv)
  }else{
    if (file.exists(paste0(UData, 'idx_calendar.vn.rds')))
    { 
      idx_calendar.vn = readRDS(paste0(UData, 'idx_calendar.vn.rds'))
    } else {
      # UData = SData
      idx_calendar.vn = readRDS(paste0('S:/R/', 'idx_calendar.vn.rds'))
    }
    assign("idx_calendar.vn", idx_calendar.vn, envir = .GlobalEnv)
  }
  
}
# ==================================================================================================
TRAINEE_KABLE = function(l.Table, Nb=3, l.Text="", HeadOnly=F, ClearScreen=F) {
  # ------------------------------------------------------------------------------------------------
  # l.Table = x.ins
  if (ClearScreen) { cat("\014")}
  cat("\r\r")
  if (nrow(l.Table)>0)
  {
    if (nchar(l.Text)>0) { cat(l.Text) }
    print(kable(format.args = list(decimal.mark = ".", big.mark = ","),
                head(l.Table, min(Nb,nrow(l.Table))), format="markdown"))
    # cat("")
    if (! HeadOnly)
    {
      print(kable(format.args = list(decimal.mark = ".", big.mark = ","),
                  tail(l.Table, min(Nb,nrow(l.Table))), format="markdown"))
    }
    # print("", quote=F)
    print(paste(Format.Number(nrow(l.Table),0), "records"), quote = F)
  } else
  { print("No data ...", quote=F)}
}

# ==================================================================================================
TRAINEE_KABLE_TB = function(l.Table, HeadOnly=F, Nb=3, l.Text="")  {
  # ------------------------------------------------------------------------------------------------
  # l.Table =
  # library(knitr)
  # l.Text=""; Nb=3
  # l.Table = readRDS("u:/efrc/data/efrc_indipo_history.rds")
  cat("\r\r")
  if (nrow(l.Table)>0)
  {
    if (!HeadOnly) {l.Table.TB = rbind( head(l.Table, min(Nb,nrow(l.Table))), tail(l.Table, min(Nb,nrow(l.Table))), fill=T)} else {
      l.Table.TB = head(l.Table, min(Nb,nrow(l.Table))) }
    if (nchar(l.Text)>0) { cat(l.Text,"\n") }
    print(kable(format.args = list(decimal.mark = ".", big.mark = ","), l.Table.TB, format="markdown"))
    print(paste(Format.Number(nrow(l.Table),0), "records"), quote = F)
  } else
  { print("No data ...", quote=F)}
}

# ==================================================================================================
printrep = function(strchar,nchar) {
  # ------------------------------------------------------------------------------------------------
  print(paste(replicate(nchar,strchar), collapse = ""),quote = F)
}

# ==================================================================================================
TRAINEE_KABLE_ALL = function(pData, l.Text='') {
  # ------------------------------------------------------------------------------------------------
  My.Kable(pData, HeadOnly = T, Nb=nrow(pData), l.Text=l.Text)
}

# ==================================================================================================
TRAINEE_CLEAN_COLNAMES = function(dt) {
  # ------------------------------------------------------------------------------------------------
  xt = dt
  colnames(xt) =  trimws(gsub("\\.","_", gsub("[*]", "", gsub('%','percent_', gsub(' ','',gsub('-','_',tolower(colnames(xt))))))))
  colnames(xt) = vietnameseConverter::decodeVN(colnames(xt), from='Unicode', to='Unicode', diacritics=F)
  return(xt)
}

# ==================================================================================================
CATln = function(l.Str, top_border=F, p_border=F, pNbCar=120, clearscreen=F) {
  # ------------------------------------------------------------------------------------------------
  if (clearscreen) { shell('cls') }
  if (top_border) {catrep('=',pNbCar)}
  cat("\r", paste(l.Str, strrep(" ",max(0,pNbCar - nchar(l.Str)))), "\n")
  if (p_border) {catrep('-',pNbCar)}
}

# ==================================================================================================
CATln_Border = function(pStr) {
  # ------------------------------------------------------------------------------------------------
  CATln(pStr, top_border = T, p_border = T) 
}

# ==================================================================================================
CHECK_CLASS = function(pData) {
  # ------------------------------------------------------------------------------------------------
  rData = data.table()
  if (all(class(pData)!='try-error') && nrow(pData)>0)
  {
    rData = pData
  }
  return(rData)
}

# ==================================================================================================
DATACENTER_LINE_BORDER = function(l.msg="hello", l.justify="centre", clearscreen=F, NbCarLine = 125) {
  # ------------------------------------------------------------------------------------------------
  if (clearscreen) {shell("cls")}
  CATln(strrep("=",NbCarLine))
  CATln(format(l.msg, width=NbCarLine, justify=l.justify))
  CATln(strrep("=",NbCarLine))
}

# ==================================================================================================
DATACENTER_LINE_BORDER_BEGINEND = function(pOption="EFRC_INDVN_INTRADAY", pMethod="BEGIN", AddText='') {
  # ------------------------------------------------------------------------------------------------
  switch (pMethod,
          "BEGIN"     = { DATACENTER_LINE_BORDER(paste(pOption, "- Executing ...", AddText, substr(Sys.time(),1,19)), clearscreen=T) },
          "UPDATED"   = { DATACENTER_LINE_BORDER(paste(pOption, "- Already Updated, ", AddText, substr(Sys.time(),1,19)), clearscreen=F) },
          "END"       = { DATACENTER_LINE_BORDER(paste(pOption, "- Done, ",AddText, substr(Sys.time(),1,19)), clearscreen=F) }
          
  )
  # DATACENTER_LINE_BORDER_BEGINEND (pOption="EFRC_INDVN_INTRADAY", pMethod="BEGIN", AddText='')
}

# ==================================================================================================
TRAINEE_CONVERT_NUMBER <- function(val) {
  last_char <- toupper(substr(val, nchar(val), nchar(val)))  #chuyen thanh in hoa
  num_value <- as.numeric(gsub("[^0-9.]", "", val))
  multiplier <- switch(last_char,
                       "K" = 1000,
                       "M" = 1000000,
                       "%" = 0.01,
                       "B" = 1000000000,
                       "T" = 1000000000000,
                       1)  
  
  converted_value <- num_value * multiplier
  
  return(converted_value)
}

# ==================================================================================================
TRAINEE_CONVERT_STR_TO_NUMBER = function(l.str) {
  # ------------------------------------------------------------------------------------------------
  # l.str = "6,800,000.23"
  l_str = l.str
  l_str = gsub(",","", l_str)
  return(as.numeric(l_str))
}

# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_MAJOR_HOLDERS <- function(pCode = 'AAPL', silent = T, ToKable = T) {
  url <- paste0("https://finance.yahoo.com/quote/", pCode, "/holders")
  GC_SILENT ()
  tables <- read_html(url)
  table_data <- tables %>%
    #html_nodes("table") %>%
    html_nodes(xpath = '//*[@id="Col1-1-Holders-Proxy"]/section/div[2]/div[2]/div/table') %>%
    html_table(fill = TRUE)
  df <- as.data.table(table_data)
  if (!is.null(df)) {
    setnames(df, c('pct','holder'))  
    df[, pct := gsub('%','',pct)]
    df[, pct := TRAINEE_CONVERT_STR_TO_NUMBER(pct)]
    df [, ':=' (pct = as.numeric(pct), holder = as.character(holder))]
  }
  
  if (ToKable) { TRAINEE_KABLE_TB(df)}
  return(df)
}
# TRAINEE_DOWNLOAD_YAH_MAJOR_HOLDERS (pCode = 'AAPL', Silent = T, ToKable = T)

# ==================================================================================================
TRAINEE_EXTRACT_NAMES <- function(names) {
  # ------------------------------------------------------------------------------------------------
  # Split each name by space
  name_parts <- strsplit(names, " ")
  # Extract first and last names
  first_names <- sapply(name_parts, `[`, 2)  # Get the second part as first name
  # Get the remaining parts as last name
  last_names <- sapply(name_parts, function(parts) {
    if (length(parts) > 2) {
      paste(parts[3:length(parts)], collapse = " ")  # Concatenate the remaining parts
    } else {
      ""  # Return empty string if there are no remaining parts
    }
  })  
  # Combine first and last names into a dataframe
  names_df <- data.frame(
    first_name = first_names,
    last_name = last_names,
    stringsAsFactors = FALSE
  )
  
  return(names_df)
}
pCode = "XXZY"
# ==================================================================================================
TRAINEE_DOWNLOAD_YAH_BOARD_EXECUTIVES_GENDER = function(pCode = 'IBM') {
  # ------------------------------------------------------------------------------------------------
  library(gender)
  library(genderdata)
  url_get_ceo = paste0('https://au.finance.yahoo.com/quote/', pCode, '/profile')
  
  response   = GET(url_get_ceo, add_headers(
    `User-Agent`      = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0"
    ,`Accept-Language`= "en-US,en;q=0.5"
  ))
  
  page = read_html(response)
  data_ceo =  as.data.table(page %>% html_nodes("table") %>% html_table(fill = TRUE) )
  if (nrow(data_ceo) > 0){
    data_ceo = TRAINEE_CLEAN_COLNAMES(data_ceo)
    
    names_df = TRAINEE_EXTRACT_NAMES(data_ceo$name)
    
    my_data = cbind(data_ceo, names_df)
    my_data[, ':='(source='YAH', codesource=pCode, updated=substr(as.character(Sys.time()), 1,19), id=seq.int(1,.N))]
    my_data[, ceo:=as.numeric(NA)]
    my_data[, cob:=as.numeric(NA)]
    my_data[id==1 & grepl('CEO|General Manager|Chief Executive Officer$', title), ceo:=1]
    my_data[id==1 & grepl('Chairman|Chairwoman', title), cob:=1]
    
    my_data$gender = as.character (NA)
    my_data[grepl('^Mr.', name), gender:='MALE'] #
    my_data[grepl('^Ms.|^Mrs.', name), gender:='FEMALE']
    
    
    for (i in 1:nrow(my_data))
    {
      # i = 9
      # xData[k]$first1
      if (is.na(my_data[i]$gender) ) {
        xname = decodeVN(my_data[i]$first_name, from='Unicode', to='Unicode', diacritics=F)
        FName = try(setDT(gender(xname)))
        if (nrow(FName)>0)
        {
          print(paste(my_data, FName))
          GName = FName$gender
          my_data[i]$gender = GName
        }
      }
    }
    my_data[grepl('female', gender), gender:='FEMALE']
    my_data[grepl('male', gender), gender:='MALE']
    My.Kable.All(my_data)
  }else{
    my_data <- data.table(source = 'YAH', codesource = pCode)
    set(my_data, j = names(my_data)[!names(my_data) %in% c("source", "codesource")], value = NA)
  }
  return(my_data)
}

# ==================================================================================================
FormatNS = function(l.Num, l.Dec, l.Wid, l.Sep = "|") {
  # ------------------------------------------------------------------------------------------------
  l.res = paste(format(Format.Number(l.Num, l.Dec), width = l.Wid, justify = "right"), l.Sep)
  return(l.res)
}

# ==============================================================================
CCPR_WRITE_SUMMARY_CURRENT = function(pData=data.table(), pFileName, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T) {
  # ----------------------------------------------------------------------------
  # xs = WRITE_SUMMARY(UData, "efrc_indexp_history.rds")
  # ToPrompt=T
  # pData = ins_ref
  if (nrow(pData)>0)
  {
    x.rds = pData
  } else {
    x.rds     = try(readRDS(pFileName))
  }
  
  if (all(class(x.rds)!='try-error') && nrow(x.rds)>0)
  {
    if (ToPrompt) {My.Kable.Min(x.rds)}
    if (ToPrompt) {str(x.rds)}
    if (!"codesource" %in% colnames(x.rds) & "ticker" %in% colnames(x.rds)) { 
      x.rds[, codesource:=as.character(ticker)]} 
    if (!"codesource" %in% colnames(x.rds)) { x.rds[, codesource:=NA]} else{ x.rds[, codesource:=as.character(codesource)]}
    if (!"source" %in% colnames(x.rds)) { x.rds[, source:=NA]} else{ x.rds[, source:=as.character(source)]}
    if (!"close" %in% colnames(x.rds)) { x.rds[, close:=as.numeric(NA)]}
    if ("code" %in% colnames(x.rds) & "codesource" %in% colnames(x.rds) & nrow(x.rds[!is.na(code)])==0) { 
      x.rds[, code:=as.character(codesource)]} 
    if (!"updated" %in% colnames(x.rds)) { 
      x.rds[, updated:=SYS.TIME()]} else {
        if (nrow (x.rds [!is.na (updated)]) ==0 ){x.rds [, updated := SYS.TIME()]} else {
          x.rds [is.na(updated), updated := SYS.TIME()]
        }
      }
    # My.Kable (x.rds [!is.na(updated),.(code, date, name, updated)])
    # My.Kable (x.rds [is.na(updated),.(code, date, name, updated)])
    
    setkey(x.rds, code, date)
    
    # my.data[,":="(nbdays=append(NA,diff(date))),by=list(code)]
    if (ToExclude)
    {  
      my.summary = x.rds[date<=Sys.Date(),.(start=date[1], date=date[.N], nb=.N, datelast=date[.N], last=close[.N], 
                                            nbdays=as.numeric(NA), source=source[.N], name="", type="", 
                                            codesource=codesource[.N], updated = updated[.N]), by='code']
    } else {
      my.summary = my.data[,.( 
        start=date[1], date=date[.N], nb=.N, datelast=date[.N], 
        last=close[.N], nbdays=as.numeric(NA), source=source[.N],
        name="", type="", codesource=codesource[.N],updated = updated[.N]), by='code']
    }
    DBL_RELOAD_INSREF()
    my.summary = merge(my.summary[, -c('type', 'name', 'fcat')], ins_ref[, .(code, type, name=short_name, fcat)], all.x=T, by='code')
    my.summary = my.summary[order(-date, code)]
    if (ToPrompt) {My.Kable.TB(my.summary)}
    
    my.FileTXT  = gsub(".rds", "_summary.txt", pFileName, ignore.case=T)
    CATln(my.FileTXT)
    my.summary = my.summary[order(-date)]
    # my.summary = merge(my.summary[, -c("name", "type", "fcat")], ins_ref[, .(code, name=short_name, type, fcat)], by='code', all.x=T)
    # my.summary = transform(my.summary, type=ins_ref$type[match(code, ins_ref$code)])
    
    # if (AddName) { 
    #   my.summary = transform(my.summary, name=ins_ref$short_name[match(code, ins_ref$code)])
    #   }
    if (ToPrompt) {My.Kable.TB(my.summary)}
    if (ToRemoveCodeNA) { my.summary= my.summary[!is.na(code)] }
    fwrite(my.summary, my.FileTXT, col.names = T, sep="\t", quote = F)
    
    DATACENTER_LINE_BORDER(paste(my.FileTXT, ":", 
                                 min(my.summary[!is.na(start)]$start), 'to', max(my.summary[!is.na(date)]$date),
                                 ">>>", trimws(FormatNS(nrow(my.summary),0,12,"")), "/", 
                                 trimws(FormatNS(sum(my.summary$nb),0,16,"")), " = at", substr(as.character(Sys.time()),12,16)))
    return(my.summary)
  }
} 

# ==================================================================================================
DIRECTORY_ADJUST_FIRST_LAST_NAME = function (MyData, option = 'FL'){
  # ------------------------------------------------------------------------------------------------
  switch(option,
         'FL'= {
           # MyData2 = MyData [iso2 == 'FR']
           # MyData2 [,. (firstname, lastname, fullname)]
           MyData[, firstname:=trimws(str_to_title(word(fullname,1)))]
           MyData[, lastname:= toupper(substr(fullname, nchar(firstname)+1, nchar(fullname)))]
         },
         'LF' = {
           # MyData2 = MyData [iso2 == 'FR']
           # MyData = data.table(fullname = 'Ngô Thị Vân Hạnh')
           MyData[, lastname:=trimws(toupper(word(fullname,1)))]
           MyData[, firstname:= str_to_title(substr(fullname, nchar(lastname)+1, nchar(fullname)))]
           
         })
  return (MyData)
}

# ==================================================================================================
My.Kable.MaxCols = function(pData=dt_to, pMax=15, Nb=3, HeadOnly=F) {
  # ------------------------------------------------------------------------------------------------
  if (nrow(pData)>0)
  {
    if (ncol(pData)>pMax) { My.Kable(pData[, 1:pMax], Nb=Nb, HeadOnly = HeadOnly)} else {
      My.Kable(pData, Nb=Nb, HeadOnly = HeadOnly)
    } 
  }
}

# ==================================================================================================
TRAINEE.IFRC.UPLOAD.RDS.2023 = function(l.host = "ifrc.vn", l.tablename, l.filepath, CheckField=T, ToPrint = F,
                                        ToForceUpload=F, ToForceStructure=F, AutoUpload = T)  {
  # ------------------------------------------------------------------------------------------------
  # l.host = "strategy.vnefrc.com"; l.tablename = "efrc_str_ifrclab_last"; l.filepath = paste0(UData,"strategy/efrc_str_ifrclab_last.rds")
  # l.host = "ccpr.vn"; l.tablename = "ccpr_indals_history"; l.filepath = paste0(UData,"ccpr_indals_history.rds")
  # l.host = "ccpr.vn"; l.tablename = "ccpr_indcur_history"; l.filepath = paste0('S:/CCPR/DATA/DASHBOARD_LIVE/', 'ifrc_ccpr_investment_history.rds')
  
  # CheckField=T; ToPrint = T;  ToForceUpload=T; ToForceStructure=T
  # ToPrint = T
  if (AutoUpload){
    source(paste0(SDLibrary, "TRAINEE_INTRO.R"), echo=F)
    
    if (l.host %in% list('dashboard_live_dev','dashboard_live','dashboard_live_bat' ))
    {
      switch( DBL_Upload, 
              'DEV' = {Final_host = 'dashboard_live_dev' } ,
              'PRD' = {
                if (l.host == 'dashboard_live_bat')
                {  Final_host = 'dashboard_live_bat'} else {Final_host = 'dashboard_live'} 
              },
              {    Final_host = l.host  })
      
    } else {  Final_host = l.host}
    
  } else {  Final_host = l.host}
  CATln_Border(Final_host)
  # DBL_Upload
  
  DATACENTER_LINE_BORDER(paste('IFRC.UPLOAD.RDS = ', Final_host, ' >>>', l.tablename))
  if (ToForceUpload) { ToUploadAll=T } else { source("T:/R/CONFIG/UPLOAD_ALL.R", echo = F) }
  if (ToUploadAll)
  {
    ToUploadAll = T
    t1 = Sys.time()
    CATrp("Connecting...")
    conn = try(TRAINEE.IFRC.CONNEXTION.2023(Final_host),silent = T)
    # print(conn)
    if (all(class(conn)!="try-error"))
    {
      l.data = readRDS(l.filepath)
      if (!'updated' %in% names (l.data)) { l.data [, updated := SYS.TIME()]}
      l.data = DBL_IND_EXCLUDE(l.data)
      check_table_exist = setDT(dbGetQuery(conn,statement = paste0('SHOW TABLES LIKE "',l.tablename, '"')))
      dbDisconnect(conn)
      
      if (nrow(check_table_exist)>0)
      {
        colnames(check_table_exist) = c("tablename")
        check_table_exist = check_table_exist[tablename == l.tablename]
      }
      nb = nrow(check_table_exist)
      CATln(paste('nb = ', nb))
      
      # try(dbDisconnect(conn),silent = T)
      if (nb == 1) 
      {
        if (ToForceStructure) { UPLOAD_STRUCTURE_RDS_TO_SQL.2023(FileRDS="", DataRDS=l.data, TableSQL=l.tablename, host=Final_host, ToForce=T) }
        if (CheckField)
        {
          conn = try(TRAINEE.IFRC.CONNEXTION.2023(Final_host),silent = T)
          CATrp("Read Table...")
          host_dt = dbReadTable(conn,l.tablename)
          host_dt = setDT(host_dt)
          ncols0  = colnames(host_dt)
          ncols   = setdiff(ncols0, "id")
          ncols   = (l.data[,colnames(l.data)[which(gsub(" ","\\.",colnames(l.data)) %in% ncols)]])
          l.data  = l.data[, ..ncols]
          try(dbDisconnect(conn),silent = T)
          CATln("Close connexion.")
          # My.Kable(l.data)
        }
        
        # if (nrow(l.data [!is.na(timestamp)])>0)
        # {
        #   l.data = l.data [!is.na(timestamp)]
        # }
        My.Kable.MaxCols(l.data)
        str(l.data)
        UPDATE_UPDATED (l.data)
        # if ('updated' %in% names(l.data)) { l.data[, updated:=as.character(updated)] }
        # if ('ord' %in% names(l.data)) { l.data[, ord:=as.numeric(ord)] }
        # # My_Data
        # LIST_NAME =  CCPR_LOAD_SQL_HOST (lhost = 'dashboard_live', pTableSQL = 'dbl_ind_mother', ToDisconnect=T, ToKable=T)
        # 
        # if ( 'name' %in% names (l.data))  {
        #   na.name   = l.data [is.na(name)] [order (code)] $code 
        #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
        # {l.data [is.na(name)] [order (code)] $name = LIST_NAME [code %in% na.name] [order (code)] $name }
        # }
        # 
        # if ( 'short_name' %in% names (l.data))  {
        #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
        #   {l.data [is.na(short_name)] [order (code)] $short_name = LIST_NAME [code %in% na.name] [order (code)] $short_name}
        #     
        # }
        
        x = IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023(Final_host, l.tablename, l.data)
        
      } else if (nb == 0) {
        conn = try(TRAINEE.IFRC.CONNEXTION.2023(Final_host),silent = T)
        LIST_NAME =  CCPR_LOAD_SQL_HOST (lhost = 'dashboard_live', pTableSQL = 'dbl_ind_mother', ToDisconnect=T, ToKable=T)
        # na.name   = l.data [is.na(name)] [order (code)] $code 
        # l.data [is.na(name)] [order (code)] $name = LIST_NAME [code %in% na.name] [order (code)] $name
        # if ( 'short_name' %in% names (l.data))  {
        #   if ( nrow (LIST_NAME [code %in% na.name] [order (code)]) > 0)
        #   {l.data [is.na(short_name)] [order (code)] $short_name = LIST_NAME [code %in% na.name] [order (code)] $short_name} 
        # }
        try(UPLOAD_STRUCTURE_RDS_TO_SQL.2023(FileRDS="", DataRDS=l.data, TableSQL=l.tablename, host=Final_host, ToForce=T)     )   
        x = IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023(Final_host, l.tablename, l.data)
        try(dbDisconnect(conn),silent = T)
        CATln("Close connexion.")
        
      }
      print(paste("IFRC.UPLOAD.RDS >>> path :", l.filepath, "| OK"))
    } else {
      # print(paste("IFRC.UPLOAD.RDS >>> path :", l.filepath, "| NOT OK"))
      CATln(paste0("CONNEXION NOT AVAILABLE"))
      try(dbDisconnect(conn),silent = T) 
    }
    printrep('.',100)
    if(ToPrint) {
      efrc.print.time("Elapsed time = ", t1)
    }
    try(dbDisconnect(conn),silent = T) 
  }
  try(dbDisconnect(conn),silent = T) 
  # try( dbDisconnect(dbListConnections(MySQL()) [[1]]) )
  x = dbListConnections(MySQL())
  if (length (x) > 1) { try( dbDisconnect(dbListConnections(MySQL()) [[1]]) )}
  
}

# ==================================================================================================
UPLOAD_STRUCTURE_RDS_TO_SQL.2023 = function(FolderStructure=RData, FileRDS, DataRDS, TableSQL, host='ifrc.vn', ToForce=F) {
  # ------------------------------------------------------------------------------------------------
  # FileRDS=paste0(UData,"efrc_cmd_history.rds"); DataRDS=""; TableSQL="efrc_cmd_history"; host="ifrc.vn"
  if (file.exists('S:/DATA/')) {RData = 'S:/DATA/'} else { RData = 'S:/R/DATA/'}
  DATACENTER_LINE_BORDER(paste('UPLOAD_STRUCTURE_RDS_TO_SQL = ', host, ' >>>', TableSQL))
  
  if (nchar(FileRDS)>0) { x = DATACENTER_LOADDTRDS(FileRDS) }else{ x = DataRDS }
  # xSTR  = as.data.table(str(x))
  # My.Kable(xSTR)
  # as.list(str(x))
  # typeof(str(x))
  # 
  # typeof(x$iso2)
  # xNAMES = names(x)
  # xNAMES
  xs = sapply(x,class)
  # colnames(x) = tolower(colnames(x))
  str_std = DATACENTER_LOAD_TEXTFILE(paste0(FolderStructure),"sql_structure_standard.txt")
  
  StrField = paste0('CREATE TABLE ',TableSQL,' ( id int NOT NULL AUTO_INCREMENT, ')
  for (k in 1:length(xs))
  {
    # k = 12
    xName = names(xs[k])
    xType = xs[[k]][1]
    switch(xType,
           
           "character" = {
             x1 = x[, ..xName]
             setnames(x1, xName, 'field')
             if (nrow(x1[!is.na(field)])==0) { nLen=1 } else { nLen = ifelse(nrow(str_std[field==xName])==1,
                                                                             max(str_std[field==xName]$len,nchar(x1[!is.na(field)]$field)),
                                                                             max(nchar(x1[!is.na(field)]$field))) }
             # nLen = floor(1.25*nLen)
             xEnd = ifelse(k < length(xs), ", ", ", PRIMARY KEY (id))")
             Str_One = paste0('`',xName,'`', ' varchar', '(', nLen, ') ', xEnd )
             StrField = paste0(StrField, Str_One)
             # Buu lam tiep duoc khong?
           },
           
           "Date" = {
             x1 = x[, ..xName]
             setnames(x1, xName, 'field')
             xEnd = ifelse(k < length(xs), ", ", ", PRIMARY KEY (id))")
             Str_One = paste0('`',xName,'`', ' date', xEnd )
             StrField = paste0(StrField, Str_One)
             # Buu lam tiep duoc khong?
           },
           
           "numeric" = {
             x1 = x[, ..xName]
             setnames(x1, xName, 'field')
             xEnd = ifelse(k < length(xs), ", ", ", PRIMARY KEY (id))")
             Str_One = paste0('`',xName,'`', ' float', xEnd )
             StrField = paste0(StrField, Str_One)
             # Buu lam tiep duoc khong?
           },
           {
             x1 = x[, ..xName]
             setnames(x1, xName, 'field')
             if (nrow(x1[!is.na(field)])==0) { nLen=1 } else { nLen = ifelse(nrow(str_std[field==xName])==1,
                                                                             max(str_std[field==xName]$len,nchar(x1[!is.na(field)]$field)),
                                                                             max(nchar(x1[!is.na(field)]$field))) }
             # nLen = floor(1.25*nLen)
             xEnd = ifelse(k < length(xs), ", ", ", PRIMARY KEY (id))")
             Str_One = paste0('`',xName,'`', ' varchar', '(', nLen, ') ', xEnd )
             StrField = paste0(StrField, Str_One)
           }
    )
  }
  
  CATln(StrField)
  
  conn = try(TRAINEE.IFRC.CONNEXTION.2023(host),silent = T)
  if (ToForce) { stm1 = paste0("drop table if exists ", TableSQL); try(dbGetQuery(conn,statement = stm1)) }
  try(dbGetQuery(conn,statement = StrField))
  
}

# ==================================================================================================
IFRC.DROP.CREATE.TABLE.LIKE.ONE.2023 = function(l.host = "commo.ifrc.vn", l.tablename, l.data, ToPrint = T) {
  # ------------------------------------------------------------------------------------------------
  my_time = as.character(as.numeric(Sys.time())*100000)
  stm1 = paste0("drop table if exists tempx_", l.tablename, "_", my_time)
  stm2 = paste0("create table tempx_", l.tablename, "_", my_time, " like ", l.tablename)
  stm3 = paste0("insert into tempx_", l.tablename, "_", my_time)
  stm4 = paste0("drop table if exists ", l.tablename)
  stm5 = paste0("rename table tempx_", l.tablename, "_", my_time, " to ", l.tablename)
  conn = TRAINEE.IFRC.CONNEXTION.2023(l.host)
  if (ToPrint) {print(stm1, quote = F)};dbGetQuery(conn, statement = stm1)
  if (ToPrint) {print(stm2, quote = F)};dbGetQuery(conn, statement = stm2)
  if (ToPrint) {print(stm3, quote = F)};dbWriteTable(conn, paste0("tempx_", l.tablename, "_", my_time), l.data, field.types = NULL, row.names = F, append = TRUE)
  
  if (ToPrint) {print(stm4, quote = F)};dbGetQuery(conn, statement = stm4)
  if (ToPrint) {print(stm5, quote = F)};dbGetQuery(conn, statement = stm5)
  dbDisconnect(conn)
  print(paste("DROP > CREATE LIKE > NAME >", l.tablename, "HOST: ",l.host, "...DONE..."))
}

# ==================================================================================================
IFRC_RELEASE_MEMORY = function(MyText, ToPrint=T) {
  # ------------------------------------------------------------------------------------------------
  Mem.Init  = memory.size()
  if (!is.infinite(Mem.Init))
  {
    Mem.GC    = gc()
    Mem.Final = memory.size()
    Mem.Msg   = paste(MyText, Mem.Init, " >> ", Mem.Final)
    if (ToPrint)  {print(Mem.Msg, quote = F)}
  }
}

# ==================================================================================================
TRAINEE.IFRC.CONNEXTION.2023 = function(lhost)  {
  # ------------------------------------------------------------------------------------------------
  OK = T
  switch(lhost,
         "ccpr.vn"             = {lmy.connexion = try(dbConnect(MySQL(), user = "ccpr_user",       password = "Ifrc@2023_ccpr",    host = '27.71.235.40', dbname = "ifrc_ccpr"))},
         "ifrc.vn"             = {lmy.connexion = try(dbConnect(MySQL(), user = "dbifrc",          password = "@ifrcDB2022",       host = '27.71.235.71', dbname = "db_ifrcvn"))},
         "datacenter.ifrc.vn"  = {lmy.connexion = try(dbConnect(MySQL(), user = "datacenter_user", password = "@ifrcDB2022",       host = '27.71.235.71', dbname = "wp_datacenter"))},
         "board.womenceoworld" = {lmy.connexion = try(dbConnect(MySQL(), user = "womenworld_user", password = "admin@beqholdings", host = '27.71.235.71', dbname = "db_womenceoworld"))},
         "ccpi_dashboard"      = {lmy.connexion = try(dbConnect(MySQL(), user = "dashboard_user", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard"))},
         "db_ccpe"             = {lmy.connexion = try(dbConnect(MySQL(), user = "ccpevn_user", password = "admin@beqholdings", host = '27.71.235.40', dbname = "db_ccpe"))},
         "dashboard_live_dev"  = {lmy.connexion = try(dbConnect(MySQL(), user = "dashboard_user_login_data", password = "admin@beqholdings", host = '27.71.235.71', dbname = "dashboard_user_login_dev"))},
         'dashboard_live'      = {lmy.connexion = try(dbConnect(MySQL(), user = "dashboard_user_login", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard_login"))},
         'dashboard_live_bat'  = {lmy.connexion = try(dbConnect(MySQL(), user = "dashboard_user_login_yen", password = "yen@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboard_login"))},
         'dashboard_lite'      = {lmy.connexion = try(dbConnect(MySQL(), user = "ccpi_dashboardlite_user", password = "admin@beqholdings", host = '27.71.235.71', dbname = "ccpi_dashboardlite"))},
         
         {
           OK = F
         }
  )
  if (OK) 
  {
    
    
    # database_name: db_womenceoworld
    # database_user: womenworld_user
    # database_pasword: admin@beqholdings
    # host: 27.71.235.71
    
    # DB_DATABASE=ccpi_dashboard_login
    # DB_USERNAME=dashboard_user_login
    # DB_PASSWORD=admin@beqholdings
  } else {
    lmy.connexion = 'ERROR'
  }
  return(lmy.connexion)
}

# ==================================================================================================
CCPR_LOAD_SQL_HOST = function(lhost = 'board.womenceoworld', pTableSQL = 'wcw_directory', ToDisconnect=T, ToKable=T){
  # ------------------------------------------------------------------------------------------------
  # ifrc_ccpr = 'ccpr.vn'
  host_dt      = data.table()
  my.connexion = TRAINEE.IFRC.CONNEXTION.2023 (lhost )
  # try(dbConnect(MySQL(), user = "ccpr_user",       password = "Ifrc@2023_ccpr", host = '27.71.235.40', dbname = "ifrc_ccpr"))
  print(my.connexion)
  
  if (all(class(my.connexion)!='try-error'))
  {
    CATrp("Read Table...")
    host_dt = try(dbReadTable(my.connexion,pTableSQL))
    
    if (all(class(host_dt)!='try-error'))
    {
      OutDt = setDT(host_dt)
      My.Kable(host_dt)
      str(host_dt)
    } 
  } else {
    CATln(paste(pHost, ": NO CONNEXION."))
  }
  
  CATln(paste('CCPR_LOAD_SQL_HOST : ', pTableSQL, ' - DONE, ', Sys.time()))
  if (ToKable) { My.Kable.MaxCols(host_dt) }
  if (ToDisconnect) { try(dbDisconnect(my.connexion),silent = T) }
  return(host_dt)
}

# ==================================================================================================
DATACENTER_LOAD_TEXTFILE = function(p_folder, p_filename, p_active=T, EchoOn=F) {
  # ------------------------------------------------------------------------------------------------
  # p_folder = "u:/efrc/data/"; p_filename="list_demo_yah.txt"; p_active=T
  l_fullname = paste0(p_folder, p_filename)
  if (EchoOn) { CATrp(paste('Loading : ', l_fullname)) }
  if (file.exists(l_fullname))
  {
    l_data = setDT(fread(l_fullname, sep="\t"))
    if (EchoOn) { CATln(paste(paste(l_fullname), '=', nrow(l_data), "rows")) } else { CATln('')}
    # colnames(l_data) = tolower(colnames(l_data))
    if ("active" %in% colnames(l_data) & p_active) { l_data = l_data[active==1]}
    if (EchoOn) { My.Kable.TB(l_data) }
  } else {
    DATACENTER_LINE_BORDER(paste("DATACENTER_LOAD_TEXTFILE :", l_fullname, " - FILE DOES NOT EXIST"))
    l_data=data.table()
  }
  CATrp('')
  return(l_data)
}

# ==================================================================================================
efrc.print.time = function(MyText, ttime){
  # ------------------------------------------------------------------------------------------------
  print(paste(MyText, format(Sys.time() - ttime, digits = 2, nsmall = 2, big.mark = ",")), quote = F)
}



# ==================================================================================================
WRITE_SUMMARY_FULLPATH = function(pFileName, ToExclude=T, ToPrompt=F, ToRemoveCodeNA=T) {
  # ------------------------------------------------------------------------------------------------
  # xs = WRITE_SUMMARY(UData, "efrc_indexp_history.rds")
  
  x.rds     = try(readRDS(pFileName))
  if (all(class(x.rds)!='try-error') && nrow(x.rds)>0)
  {
    if (ToPrompt) {My.Kable.MaxCols(x.rds)}
    if (ToPrompt) {str(x.rds)}
    if (!"codesource" %in% colnames(x.rds) & "ticker" %in% colnames(x.rds)) { 
      x.rds[, codesource:=as.character(ticker)]} 
    if (!"codesource" %in% colnames(x.rds)) { x.rds[, codesource:=NA]} else{ x.rds[, codesource:=as.character(codesource)]}
    if (!"source" %in% colnames(x.rds)) { x.rds[, source:=NA]} else{ x.rds[, source:=as.character(source)]}
    if (!"close" %in% colnames(x.rds)) { x.rds[, close:=as.numeric(NA)]}
    if ("code" %in% colnames(x.rds) & "codesource" %in% colnames(x.rds) & nrow(x.rds[!is.na(code)])==0) { 
      x.rds[, code:=as.character(codesource)]} 
    
    setkey(x.rds, code, date)
    
    # my.data[,":="(nbdays=append(NA,diff(date))),by=list(code)]
    if (ToExclude)
    {  my.summary = x.rds[date<=Sys.Date(),.(start=date[1], date=date[.N], nb=.N, datelast=date[.N], last=close[.N], 
                                             nbdays=as.numeric(NA), source=source[.N], name="", type="", 
                                             codesource=codesource[.N]), by=code]} else {
                                               my.summary = my.data[,.( 
                                                 start=date[1], date=date[.N], nb=.N, datelast=date[.N], 
                                                 last=close[.N], nbdays=as.numeric(NA), source=source[.N],
                                                 name="", type="", codesource=codesource[.N]), by=code]}
    my.summary = my.summary[order(-date, code)]
    if (ToPrompt) {My.Kable.TB(my.summary)}
    
    my.FileTXT  = gsub(".rds", "_summary.txt", pFileName)
    my.FileTXT
    my.summary = my.summary[order(-date)]
    my.summary = merge(my.summary[, -c("name", "type", "fcat")], ins_ref[, .(code, name=short_name, type, fcat)], by='code', all.x=T)
    # my.summary = transform(my.summary, type=ins_ref$type[match(code, ins_ref$code)])
    
    # if (AddName) { 
    #   my.summary = transform(my.summary, name=ins_ref$short_name[match(code, ins_ref$code)])
    #   }
    if (ToPrompt) {My.Kable.TB(my.summary)}
    if (ToRemoveCodeNA) { my.summary= my.summary[!is.na(code)] }
    fwrite(my.summary, my.FileTXT, col.names = T, sep="\t", quote = F)
    
    DATACENTER_LINE_BORDER(paste(my.FileTXT, ":", 
                                 min(my.summary[!is.na(start)]$start), 'to', max(my.summary[!is.na(date)]$date),
                                 ">>>", trimws(FormatNS(nrow(my.summary),0,12,"")), "/", 
                                 trimws(FormatNS(sum(my.summary$nb),0,16,"")), " = at", substr(as.character(Sys.time()),12,16)))
    return(my.summary)
  }
} 

# ==================================================================================================
GET_CURL_FETCH = function(pURL = "https://www.theice.com/products") {
  # ------------------------------------------------------------------------------------------------
  req <- curl::curl_fetch_memory(pURL)
  x = rawToChar(req$content); x
  writeLines(x, "c:/temp/GET_CURL_FETCH.r")
  return(x)
}

# ==================================================================================================
TRAINEE_GET_VALUE_IN_TABLE_x1x2 = function(pTable=xData, pDataset='Shares Outstanding 5') {
  # ------------------------------------------------------------------------------------------------
  xres = pTable[x1==pDataset]
  if (nrow(xres)==1) { 
    xvalue = xres[1]$x2 } else { xvalue = as.character(NA) }
  return(xvalue)
}

# ==================================================================================================
TRAINEE_CONVERT_IN_VALUE_KMBT = function(x = '10.23K', ToPrompt=F) {
  # ------------------------------------------------------------------------------------------------
  # x = '10.2365B'
  X1 = substr(x, nchar(x), nchar(x))
  x2 = substr(x, 1 , nchar(x)-1)
  switch (X1, 
          'K' = {m = 1000},
          'M' = {m = 1000000},
          'B' = {m = 1000000000},
          'T' = {m = 1000000000000},
          { m = 1 
          x2 = x
          }
  )
  value = m*as.numeric(gsub(',','', x2))
  if (ToPrompt) {print(value)}
  return(value)
}

# ==================================================================================================
TRAINEE_SELECT_TABLE_WITH_FIELD = function(tables, pField='x1', pContent="EPS", like=F) {
  # ------------------------------------------------------------------------------------------------
  x.res = data.table()
  # pField='shareholder'; pContent=""
  # pField='x1'; pContent="First trading date"
  length(tables)
  if (nchar(pContent)==0)
  {
    nr = 0
    for (itab in 1:length(tables))
    {
      # itab = 50
      x.info = as.data.table(tables[[itab]])
      x.info = CLEAN_COLNAMES(x.info)
      if (nrow(x.info) > 0) (         colnames(x.info) = vietnameseConverter::decodeVN(colnames(x.info), from='Unicode', to='Unicode', diacritics=F))
      if (pField %in% colnames(x.info))
      {
        nr = itab
        # str(x.info)  
        # CATln_Border(paste("FOUND :", pField, nr))
        x.res = x.info
      }
    }
  } else {
    nr = 0
    for (itab in 1:length(tables))
    {
      # itab = 4
      # like = T
      x.info = as.data.table(tables[[itab]])
      x.info = CLEAN_COLNAMES(x.info)
      
      if (nrow(x.info) > 0) (
        colnames(x.info) = vietnameseConverter::decodeVN(colnames(x.info), from='Unicode', to='Unicode', diacritics=F))
      
      if (pField %in% colnames(x.info))
      {
        setnames(x.info, pField, 'myfield')
        if (like)
        {
          # pContent = 'First Trading'
          nlike = (nrow(x.info[grepl(trimws(pContent), myfield, ignore.case = T)])==1)
        } else {
          nlike = (nrow(x.info[myfield==pContent])==1)
        }
        
        if (nlike)
        {
          nr = itab
          # str(x.info)  
          # CATln_Border(paste("FOUND :", pField, pContent, nr))
          setnames(x.info, 'myfield', pField)
          x.res = x.info
        }
      }
    }
  }
  return(x.res)
}


# ==================================================================================================
DBL_INDEXES_CONVERT_CURRENCIES_FROM_USD = function(IND_FOLDER    = UData, IND_FILENAME = 'DOWNLOAD_IFRC_INDETF_HISTORY.rds',IND_PREFIX_NAME = '',
                                                   Save_Folder   = paste0('S:/STKVN/INDEX_2024/'), Save_File     = 'ifrc_ccpr_INDETF_history.rds',
                                                   CUR_FOLDER = UData,
                                                   CUR_FILENAME = 'BEQ_CUR_4INDEX.rds',
                                                   IND_CURS_LIST = list('GBP', 'EUR', 'JPY', 'SGD', 'VND', 'AUD', 'CAD', 'KRW', 'HKD', 'CNY')){
  # ------------------------------------------------------------------------------------------------
  
  # IND_FOLDER   = UData ; IND_FILENAME = 'DOWNLOAD_IFRC_INDPOR_HISTORY.rds'
  # IND_FOLDER   = UData ; IND_FILENAME = 'DOWNLOAD_IFRC_INDPRV_HISTORY.rds'
  # x = CCPR_READRDS(UData, 'DOWNLOAD_IFRC_INDETF_HISTORY.rds', ToKable = T, ToRestore = T)
  # IND_FOLDER   = UData; IND_FILENAME  = 'DOWNLOAD_IFRC_INDETF_HISTORY.rds'
  # IND_FOLDER   = paste0(CCPRData, 'DASHBOARD/')
  # IND_FILENAME = 'DOWNLOAD_IFRC_INDETF_HISTORY.rds'
  # IND_HISTORY  = CCPR_READRDS(UData, IND_FILENAME, ToKable = T, ToRestore = T)
  # IND_FILENAME = 'ifrc_ccpr_ind_gics_history.rds'
  # CUR_FROM = 'USD'; ISO2 = ""
  Data_Old = data.table()
  CUR_FROM = 'USD'; ISO2 = "US"
  
  IND_CURS_TODO = setdiff(IND_CURS_LIST, CUR_FROM)
  
  IND_HISTORY   = CCPR_READRDS(IND_FOLDER, IND_FILENAME, ToKable = T, ToRestore = T)
  
  IND_HISTORY = IND_HISTORY[substr(code, nchar(code)-2, nchar(code))=='USD']
  # IND_HISTORY  = CCPR_READRDS(paste0(CCPRData, 'DASHBOARD/'), IND_FILENAME, ToKable = T, ToRestore = T)
  IND_HISTORY   = unique(IND_HISTORY[order(code, date)], by=c('code', 'date'))
  # IND_HISTORY  = MERGE_DATASTD_BYCODE(IND_HISTORY)
  My.Kable(IND_HISTORY)
  # CUR_YAH      = DATACENTER_LOADDTRDS_UDATA('DOWNLOAD_YAH_CUR_HISTORY.rds')
  # My.Kable(CUR_YAH[code=='CURUSDVND'][order(date)][, .(code, date, close)])
  
  CUR_HISTORY  = CCPR_READRDS(CUR_FOLDER, CUR_FILENAME, ToKable = T, ToRestore = T)
  
  
  My.Kable(CUR_HISTORY[code=='CURUSDGBP'][order(date)])
  My.Kable(CUR_HISTORY[code=='CURUSDEUR'][order(date)])
  My.Kable(CUR_HISTORY[code=='CURUSDVND'][order(date)])
  My.Kable(CUR_HISTORY[code=='CURUSDJPY'][order(date)])
  
  # CUR_FROM = 'VND'; ISO2 = "VN"
  
  FINAL_INDEXES = data.table()
  
  for (PRTR in list('PR', 'TR'))
  {
    for (pCUR in IND_CURS_TODO)
    {
      # PRTR = 'PR'; pCUR = 'GBP'
      # PRTR = 'PR'; pCUR = 'EUR'
      # PRTR = 'PR'; pCUR = 'JPY'
      # PRTR = 'PR'; pCUR = 'SGD'
      # PRTR = 'PR'; pCUR = 'VND'
      # pCUR = 'USD'
      # CUR_TO   = 'USD'
      CATln_Border(paste('PRTR = ', PRTR, '/ CUR_TO = ', pCUR))
      CUR_TO   = pCUR
      IND_CUR_MOTHER = IND_HISTORY[grepl(paste0(PRTR, CUR_FROM,'$'), code)]
      IND_CUR_MOTHER[, name_mother:=name]
      IND_CUR_MOTHER[, cur:=CUR_FROM]
      My.Kable.TB(unique(IND_CUR_MOTHER[order(code, -date)], by='code')[, .(code, name, date, close, cur, name_mother)])
      
      CUR_CONVERT = paste0('CUR', CUR_TO, CUR_FROM)
      CUR_CONVERT_INV = paste0('CUR', CUR_FROM,CUR_TO)
      CUR_TOMERGE = CUR_HISTORY[code==CUR_CONVERT][, .(code, date, close)]
      CUR_INVERSE = CUR_HISTORY[code==CUR_CONVERT_INV][, .(code, date, close)]
      
      CUR_TOMERGE_FINAL = merge(CUR_TOMERGE, CUR_INVERSE[, .(date, inverse=close)], all=T, by='date')
      My.Kable(CUR_TOMERGE_FINAL)
      CUR_TOMERGE_FINAL[, code:=CUR_CONVERT]
      CUR_TOMERGE_FINAL[is.na(close) & !is.na(inverse), ':='(close=1/inverse, r=1)]
      My.Kable(CUR_TOMERGE_FINAL)
      
      IND_CUR_MOTHER_DATES = unique(IND_CUR_MOTHER, by='date')[, .(date)]
      IND_CUR_MOTHER_DATES = merge(IND_CUR_MOTHER_DATES[, -c('cur_tofrom')], CUR_TOMERGE_FINAL[, .(date, cur_tofrom=close)], all.x=T, by='date')
      
      MinDate  = min(IND_CUR_MOTHER_DATES$date)
      MinValue = (CUR_TOMERGE_FINAL[!is.na(close)][1]$close)
      MaxDate  = max(CUR_TOMERGE_FINAL[date<=MinDate]$date)
      if (!is.infinite(MaxDate)) {
        MaxValue = CUR_TOMERGE_FINAL[date==MaxDate]$close
      } else {
        MaxValue = MinValue
      }
      CATln(paste(MinDate, MaxDate, MaxValue))
      IND_CUR_MOTHER_DATES[date==MinDate, close:=MaxValue]
      IND_CUR_MOTHER_DATES[date==MinDate, cur_tofrom    :=MaxValue]
      
      IND_CUR_MOTHER_DATES[, cur_tofrom:=na.locf(cur_tofrom)]
      IND_CUR_MOTHER_DATES[, rt_cur:=(cur_tofrom/shift(cur_tofrom))-1]
      My.Kable(IND_CUR_MOTHER_DATES)
      
      IND_CUR_MOTHER = IND_CUR_MOTHER[order(code, date)][, .(code, date, close, cur, cur_to=CUR_TO, cur_to_from=paste0(CUR_TO, CUR_FROM), name_mother)]
      IND_CUR_MOTHER[, rt:=(close/shift(close))-1, by='code']
      IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('rt_cur', 'cur_tofrom')], IND_CUR_MOTHER_DATES[, .(date, rt_cur, cur_tofrom)], all.x=T, by='date')
      IND_CUR_MOTHER = IND_CUR_MOTHER[order(code, date)]
      IND_CUR_MOTHER[!is.na(rt), rt_ratio := (1+rt)/(1+rt_cur), by='code']
      IND_CUR_MOTHER[is.na(rt), rt_ratio := 1]
      IND_CUR_MOTHER[, cum_rt_ratio := cumprod(rt_ratio), by='code']
      IND_CUR_MOTHER_START = unique(IND_CUR_MOTHER[order(code, date)], by='code')
      
      IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('close_curto')], IND_CUR_MOTHER_START[, .(code, close_curto=close)], all.x=T, by='code')
      IND_CUR_MOTHER[, close_curto:=close_curto*cum_rt_ratio]
      IND_CUR_MOTHER[, rt_curto:=(close_curto/shift(close_curto))-1, by='code']
      IND_CUR_MOTHER[, check:=(1+rt_curto)-rt_ratio]
      # IND_CUR_MOTHER = merge(IND_CUR_MOTHER[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')
      IND_CUR_MOTHER = MERGE_DATASTD_BYCODE(IND_CUR_MOTHER)[order(code, date)]
      # My.Kable(IND_CUR_MOTHER[order(code, date)][code==paste0('INDVNXASPR', CUR_FROM)][, .(provider, monitor, country, code, name, date, close, cur, rt)])
      
      
      
      IND_CUR_MOTHER_FINAL = IND_CUR_MOTHER
      IND_CUR_MOTHER_FINAL[, code_mother:=code]
      IND_CUR_MOTHER_FINAL[, close:=close_curto]
      IND_CUR_MOTHER_FINAL[, code:=gsub(CUR_FROM, CUR_TO, code_mother)]
      IND_CUR_MOTHER_FINAL[, cur:=CUR_TO]
      # IND_CUR_MOTHER_FINAL = MERGE_DATASTD_BYCODE(IND_CUR_MOTHER_FINAL)[order(code, date)]
      IND_CUR_MOTHER_FINAL[, rt:=(close/shift(close))-1, by='code']
      IND_CUR_MOTHER_FINAL[, change:=(close-shift(close)), by='code']
      IND_CUR_MOTHER_FINAL[, varpc:=100*rt, by='code']
      # str(IND_CUR_MOTHER_FINAL)
      
      IND_CUR_MOTHER_FINAL[, name:=gsub(paste0(CUR_FROM,')$'), paste0(CUR_TO,')'), name_mother )]
      IND_CUR_MOTHER_FINAL = IND_CUR_MOTHER_FINAL[, -c('rt_curto', 'rt_cur', 'cum_rt_ratio', 'cur_to_from', 'capiusd', 
                                                       'close_curto', 'check', 'cur_tofrom', 'cur_to', 'rt_ratio', 'capiusd')]
      # IND_CUR_MOTHER_FINAL = merge(IND_CUR_MOTHER_FINAL[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')
      # str(IND_CUR_MOTHER_FINAL)
      
      My.Kable.Min(IND_CUR_MOTHER_FINAL[order(code, date)][, .(code, name, date, close)])
      FINAL_INDEXES = rbind(FINAL_INDEXES, IND_CUR_MOTHER_FINAL, fill=T)
      GC_SILENT()
    }
  }
  
  FINAL_INDEXES = rbind(IND_HISTORY, FINAL_INDEXES, fill=T)
  FINAL_INDEXES = merge(FINAL_INDEXES[, -c('provider', 'monitor')], ins_ref[, .(code, provider, monitor)], all.x=T, by='code')[, -c('sample', 'home')]
  FINAL_INDEXES = unique(FINAL_INDEXES[order(code, date)], by=c('code', 'date'))
  My.Kable(FINAL_INDEXES[, -c('continent', 'type')])
  My.Kable(unique(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd", "n", "base_value", 
                                     "base_date", "code_mother", "source")][order(code, -date)], by='code'), Nb=10)
  CATln_Border('REMOVE CLOSE == 0')
  FINAL_INDEXES = FINAL_INDEXES[!is.na(close)]
  FINAL_INDEXES[, ':='(codesource=code)]
  # FINAL_INDEXES[grepl('VND$', code), cur:='VND']
  FINAL_INDEXES[grepl('PRVND$|TRVND$', code), code_mother:=code]
  FINAL_INDEXES[, close_adj:=close]
  FINAL_INDEXES[, varpc:=100*rt]
  FINAL_INDEXES[, ':='(source='IFRC/BEQ')]
  # FINAL_INDEXES[, ':='(continent='ASIA')]
  # FINAL_INDEXES[, ':='(country='VIETNAM')]
  # FINAL_INDEXES[, ':='(iso2='VN')]
  # FINAL_INDEXES[, ':='(iso3='VNM')]
  FINAL_INDEXES[, ':='(type='IND')]
  FINAL_INDEXES[, ':='(provider='IFRC')]
  FINAL_INDEXES = UPDATE_UPDATED(FINAL_INDEXES)
  My.Kable.Min(unique(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd")][order(code, -date)], by='code'))
  My.Kable.Min(FINAL_INDEXES[, -c('continent', 'type', 'updated', 'var', "capiusd")][order(code, -date)])
  
  # name
  if (nchar(IND_PREFIX_NAME)>0)
  {
    # IND_PREFIX_NAME = 'IFRC/BEQ HOLDINGS VNX LOGISTICS'
    str(FINAL_INDEXES)
    FINAL_INDEXES[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
    FINAL_INDEXES[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
    FINAL_INDEXES[, cur:=substr(code, nchar(code)-2, nchar(code))]
    # My.Kable(FINAL_INDEXES[, .(code, name)][order(code, -date)][code=='IFRCINDETFBLKCHNEWPRUSD'])
    FINAL_INDEXES[wgtg=='VW', wgtg:='CW']
    
    FINAL_INDEXES[, new_name:=paste(IND_PREFIX_NAME, wgtg, prtr, paste0('(',cur,')'))]
    FINAL_INDEXES[!grepl('[(]', name), new_cur:=cur]
    My.Kable(FINAL_INDEXES[, .(code, name, new_name, prtr, wgtg, cur)])
    # FINAL_INDEXES[, name:=new_name]
    
    
    # FINAL_INDEXES[grepl('[(]', name), new_name:=name]
    # FINAL_INDEXES[!grepl('[(]', name), new_name:=paste(name, prtr, paste0('(',cur,')'))]
    # FINAL_INDEXES[grepl(' VW ', new_name), new_name:=gsub(' VW ', ' CW ', new_name)]
    # # FINAL_INDEXES[!grepl(' CW', new_name), new_name:=paste(new_name, ' CW')]
    # 
    # FINAL_INDEXES[grepl(' TR CW ', new_name), new_name:=gsub(' TR CW ', ' CW TR ', new_name)]
    # FINAL_INDEXES[grepl(' PR CW ', new_name), new_name:=gsub(' PR CW ', ' CW PR ', new_name)]
    # FINAL_INDEXES[grepl(' TR EW ', new_name), new_name:=gsub(' TR EW ', ' EW TR ', new_name)]
    # FINAL_INDEXES[grepl(' PR EW ', new_name), new_name:=gsub(' PR EW ', ' EW PR ', new_name)]
    # FINAL_INDEXES[grepl(' TR TR ', new_name), new_name:=gsub(' TR TR ', ' TR ', new_name)]
    # FINAL_INDEXES[grepl(' EW ', new_name), wgtg:='EW']
    # FINAL_INDEXES[grepl(' CW ', new_name), wgtg:='CW']
    # 
    # FINAL_INDEXES[grepl(' PR PR ', new_name), new_name:=gsub(' PR PR ', ' PR ', new_name)]
    # 
    # FINAL_INDEXES[!grepl(' EW| CW', new_name) & prtr=='PR', ':='(new_name=gsub(' PR ', ' CW PR ', new_name), wgtg='CW')]
    # FINAL_INDEXES[!grepl('(VND)', new_name), ':='(cur='VND')]
    # FINAL_INDEXES[grepl('NA)$', new_name), ':='(new_name=gsub('NA)', 'VND)', new_name))]
    # FINAL_INDEXES[grepl(')$', new_name), ':='(new_cur=substr(word(new_name,2,2,'[(]'),1,3))]
    
    # FINAL_INDEXES[cur !=new_cur, cur:=new_cur]
  } else {
    ONE_INDEX = unique(FINAL_INDEXES[!is.na(name)], by='code')
    str(FINAL_INDEXES)
    FINAL_INDEXES[, prtr:=substr(code, nchar(code)-4, nchar(code)-3)]
    FINAL_INDEXES[, wgtg:=substr(code, nchar(code)-6, nchar(code)-5)]
    FINAL_INDEXES[, cur:=substr(code, nchar(code)-2, nchar(code))]
    # My.Kable(FINAL_INDEXES[, .(code, name)][order(code, -date)][code=='IFRCINDETFBLKCHNEWPRUSD'])
    FINAL_INDEXES[wgtg=='VW', wgtg:='CW']
    
    FINAL_INDEXES = merge(FINAL_INDEXES[, -c('name')], ONE_INDEX[, .(code, name)], all.x=T, by='code')
    FINAL_INDEXES[grepl(' EW$', name), ':='(name=paste(name, prtr, paste0('(',cur,')')))]
    FINAL_INDEXES[grepl(' VW$', name), ':='(name=paste(name, prtr, paste0('(',cur,')')))]
    FINAL_INDEXES[grepl(' VW ', name), name:=gsub(' VW ', ' CW ', name)]
    #My.Kable(FINAL_INDEXES[, .(iso2, iso3, country, continent, code, name, prtr, wgtg, cur, date, close, rt)])
    
  }
  
  FINAL_INDEXES = TRAINEE_MERGE_COL_FROM_REF (pData        = FINAL_INDEXES, 
                                              Folder_Fr    =  '',       File_Fr = '' , 
                                              ToSave       = F ,   Folder_To = '' ,       File_To = '' ,
                                              List_Fields  = c('name','cur','wgtg','prtr', 'category', 'coverage', 'short_name'))
  
  try(My.Kable(FINAL_INDEXES[, .(code, date, name, cur,prtr, wgtg, coverage, category)][order(date, code)]))
  
  # if ('new_name' %in% names(FINAL_INDEXES)) { FINAL_INDEXES[, name:=new_name] }
  # FINAL_INDEXES$new_name = NULL
  # FINAL_INDEXES$new_cur = NULL
  
  # FINAL_INDEXES[grepl(' TR CW ', name), name:=gsub(' TR CW ', ' CW TR ', name)]
  # 
  # FINAL_INDEXES[grepl(' PR CW ', name), name:=gsub(' PR CW ', ' CW PR ', name)]
  # FINAL_INDEXES[grepl(' TR EW ', name), name:=gsub(' TR EW ', ' EW TR ', name)]
  # FINAL_INDEXES[grepl(' PR EW ', name), name:=gsub(' PR EW ', ' EW PR ', name)]
  # FINAL_INDEXES[grepl(' TR TR ', name), name:=gsub(' TR TR ', ' TR ', name)]
  # FINAL_INDEXES[grepl(' EW ', new_name), wgtg:='EW']
  # FINAL_INDEXES[grepl(' CW ', new_name), wgtg:='CW']
  # 
  # FINAL_INDEXES[grepl(' PR PR ', new_name), new_name:=gsub(' PR PR ', ' PR ', new_name)]
  # 
  # FINAL_INDEXES[!grepl(' EW| CW', new_name) & prtr=='PR', ':='(new_name=gsub(' PR ', ' CW PR ', new_name), wgtg='CW')]
  
  #My.Kable(FINAL_INDEXES[, .(code, name, cur, prtr, wgtg, date, close, category, coverage, rt, change, varpc)][order(date, code)])
  FINAL_INDEXES[grepl('ETF INDEX', name), ':=' (category = 'TRADABLE', coverage = 'INTERNATIONAL')]
  
  
  
  Data_Old = CHECK_CLASS(try(CCPR_READRDS(UData, IND_FILENAME, ToKable = T, ToRestore = T)))
  if (nrow(Data_Old)>0)
  {
    Data_Old = unique(rbind(Data_Old[!code %in% FINAL_INDEXES$code], FINAL_INDEXES, fill=T), by=c('code', 'date'))[!is.na(code) & !is.na(date)]
  } else {
    Data_Old = unique(FINAL_INDEXES, by=c('code', 'date'))[!is.na(code) & !is.na(date)]
  }
  
  My.Kable(Data_Old[, .(code, name, cur, prtr, wgtg, date, close, category, coverage, rt, change, varpc)][order(date, code)])
  
  # setkey(Data_Old, )
  if ((nchar(Save_Folder) > 0 & nchar(Save_File) >0) && file.exists(Save_Folder)){
    try(CCPR_SAVERDS(Data_Old, Save_Folder, Save_File, ToSummary = T, SaveOneDrive = T))
  }
  return (Data_Old)
}